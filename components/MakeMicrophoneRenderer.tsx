'use client';

import React, { useState, useRef, useEffect, useCallback } from 'react';
import { playSound } from '../lib/audio';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REAL-WORLD APPLICATIONS DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const realWorldApps = [
  {
    icon: 'ğŸ™ï¸',
    title: 'Professional Audio Recording',
    description: 'Recording studios use condenser and dynamic microphones that convert sound waves to electrical signals via electromagnetic induction. The diaphragm vibrates with sound pressure, moving a coil through a magnetic field to generate voltage proportional to sound amplitude.',
    stats: [
      { value: '48V', label: 'Phantom power standard' },
      { value: '$40B', label: 'Pro audio market size' },
      { value: '95%', label: 'Frequency accuracy' }
    ],
    companies: ['Shure', 'Sennheiser', 'Audio-Technica', 'Neumann'],
    color: '#8b5cf6'
  },
  {
    icon: 'ğŸ“±',
    title: 'MEMS Microphones',
    description: 'Every smartphone contains multiple MEMS (Micro-Electro-Mechanical Systems) microphones - tiny silicon devices where sound pressure moves a microscopic diaphragm, changing capacitance. These enable voice assistants, noise cancellation, and spatial audio recording.',
    stats: [
      { value: '8B', label: 'MEMS mics sold yearly' },
      { value: '<1mm', label: 'Package size' },
      { value: '65dB', label: 'Signal-to-noise ratio' }
    ],
    companies: ['Knowles', 'Goertek', 'AAC Technologies', 'Infineon'],
    color: '#3b82f6'
  },
  {
    icon: 'ğŸ§',
    title: 'Active Noise Cancellation',
    description: 'ANC headphones use microphones to sample ambient noise, then generate anti-phase signals that cancel unwanted sound. Multiple feedforward and feedback microphones work together, processing audio in real-time to create zones of silence.',
    stats: [
      { value: '30dB', label: 'Noise reduction possible' },
      { value: '$15B', label: 'ANC headphone market' },
      { value: '<1ms', label: 'Processing latency' }
    ],
    companies: ['Sony', 'Apple', 'Bose', 'Qualcomm'],
    color: '#22c55e'
  },
  {
    icon: 'ğŸ©º',
    title: 'Medical Acoustic Sensors',
    description: 'Digital stethoscopes use sensitive microphones to capture heart sounds, lung sounds, and blood flow. The signals are amplified, filtered, and analyzed by AI to detect murmurs, arrhythmias, and respiratory conditions with superhuman accuracy.',
    stats: [
      { value: '20-2000Hz', label: 'Heart sound range' },
      { value: '95%', label: 'AI diagnostic accuracy' },
      { value: '$200M', label: 'Digital stethoscope market' }
    ],
    companies: ['Eko Health', '3M Littmann', 'Thinklabs', 'Butterfly Network'],
    color: '#ef4444'
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEST QUESTIONS DATA - 10 scenario-based questions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const testQuestions = [
  {
    scenario: 'A singer speaks into a microphone during a sound check. The audio engineer sees a waveform appear on the recording software.',
    question: 'What fundamental process allows the microphone to convert the singer\'s voice into an electrical signal?',
    options: [
      { id: 'a', label: 'The microphone amplifies the sound waves directly into digital data', correct: false },
      { id: 'b', label: 'A diaphragm vibrates with sound waves, and this mechanical motion is converted to electrical voltage through electromagnetic induction or capacitance changes', correct: true },
      { id: 'c', label: 'Air molecules carry electrical charge that the microphone collects', correct: false },
      { id: 'd', label: 'The microphone uses heat generated by sound friction to produce current', correct: false },
    ],
    explanation: 'Microphones are transducers that convert acoustic energy (sound waves) into electrical energy. When sound waves hit the diaphragm, it vibrates. In dynamic mics, an attached coil moves through a magnetic field, inducing voltage (electromagnetic induction). In condenser mics, the diaphragm acts as a capacitor plate, and its movement changes capacitance, producing a signal.',
  },
  {
    scenario: 'A podcast studio is purchasing microphones. They need one for controlled indoor recording and another for outdoor field interviews where equipment may get bumped around.',
    question: 'Which microphone types would best suit each situation and why?',
    options: [
      { id: 'a', label: 'Use condenser mics for both situations since they have the best sound quality', correct: false },
      { id: 'b', label: 'Use dynamic mics for both since they are more versatile', correct: false },
      { id: 'c', label: 'Condenser for the studio (higher sensitivity, detailed sound) and dynamic for field work (rugged, no external power needed)', correct: true },
      { id: 'd', label: 'Dynamic for studio (needs phantom power for quality) and condenser for field (more durable)', correct: false },
    ],
    explanation: 'Condenser microphones have a thin diaphragm and high sensitivity, making them ideal for capturing subtle details in controlled environments like studios. Dynamic microphones use a robust coil-and-magnet design that can handle physical abuse and don\'t require external power, making them perfect for live performances and field recording where durability matters.',
  },
  {
    scenario: 'A videographer is filming a roundtable discussion with four people seated around a table. They have one microphone to capture everyone equally.',
    question: 'Which polar pattern should the microphone have for this recording situation?',
    options: [
      { id: 'a', label: 'Cardioid - picks up sound mainly from the front while rejecting sound from behind', correct: false },
      { id: 'b', label: 'Omnidirectional - picks up sound equally from all directions around the microphone', correct: true },
      { id: 'c', label: 'Figure-8 - picks up from front and back while rejecting the sides', correct: false },
      { id: 'd', label: 'Supercardioid - has an extremely narrow pickup angle for focused recording', correct: false },
    ],
    explanation: 'An omnidirectional polar pattern captures sound equally from all directions (360 degrees), making it ideal for recording multiple speakers seated around a microphone. Cardioid patterns reject sound from behind and are better for single-source recording.',
  },
  {
    scenario: 'A musician plugs a new studio condenser microphone into their audio interface, but no signal appears. The microphone worked fine at the store demo.',
    question: 'What is the most likely reason the condenser microphone is not producing a signal?',
    options: [
      { id: 'a', label: 'The XLR cable is not designed for condenser microphones', correct: false },
      { id: 'b', label: 'Phantom power (48V) is not enabled on the audio interface, which condenser mics require to polarize the capsule and power internal electronics', correct: true },
      { id: 'c', label: 'Condenser microphones only work with digital interfaces, not analog ones', correct: false },
      { id: 'd', label: 'The microphone needs to warm up for 30 minutes before use', correct: false },
    ],
    explanation: 'Condenser microphones require phantom power (typically 48V DC) sent through the XLR cable to polarize the capacitor capsule and power the internal impedance converter/preamp. Without phantom power, the capsule cannot generate a usable signal.',
  },
  {
    scenario: 'A radio host notices their voice sounds much deeper and bassier when they speak very close to the microphone, but sounds thinner when they lean back.',
    question: 'What acoustic phenomenon is causing this change in the voice\'s tonal quality?',
    options: [
      { id: 'a', label: 'The microphone\'s gain automatically increases when sound is closer', correct: false },
      { id: 'b', label: 'Proximity effect - directional microphones exhibit boosted low-frequency response when the sound source is very close to the capsule', correct: true },
      { id: 'c', label: 'The room acoustics are adding reverb when the host moves away', correct: false },
      { id: 'd', label: 'The microphone\'s diaphragm becomes stiffer at close range', correct: false },
    ],
    explanation: 'The proximity effect is a phenomenon in directional microphones (cardioid, figure-8) where bass frequencies are significantly boosted when the sound source is within a few inches of the capsule. Broadcasters often use this effect deliberately for a warmer, fuller sound.',
  },
  {
    scenario: 'A smartphone contains multiple tiny microphones, each smaller than a grain of rice, that enable features like voice calls, voice assistants, and noise-canceling video recording.',
    question: 'What technology allows these microphones to be so small while maintaining good audio quality?',
    options: [
      { id: 'a', label: 'Miniature dynamic coils wound at the nanometer scale using traditional manufacturing', correct: false },
      { id: 'b', label: 'MEMS (Micro-Electro-Mechanical Systems) technology - silicon-based capacitive microphones fabricated using semiconductor processes, with integrated amplifiers on the same chip', correct: true },
      { id: 'c', label: 'Piezoelectric crystals that have been compressed to microscopic size', correct: false },
      { id: 'd', label: 'Optical microphones that use laser measurement instead of physical diaphragms', correct: false },
    ],
    explanation: 'MEMS microphones use semiconductor fabrication techniques to create microscopic silicon diaphragms and backplates, forming a tiny capacitor. A key advantage is that the analog-to-digital converter and amplifier can be integrated on the same chip, enabling extremely small packages.',
  },
  {
    scenario: 'A recording engineer warns an intern to never blow into the expensive vintage microphone or use it near kick drums. The microphone has a distinctive figure-8 polar pattern.',
    question: 'Why do ribbon microphones require such careful handling compared to dynamic microphones?',
    options: [
      { id: 'a', label: 'Ribbon microphones use vacuum tubes that can shatter from vibration', correct: false },
      { id: 'b', label: 'The thin aluminum ribbon (often just 2-4 microns thick) suspended in a magnetic field can be stretched or torn by strong air blasts or excessive SPL', correct: true },
      { id: 'c', label: 'Ribbon microphones have liquid mercury elements that can spill', correct: false },
      { id: 'd', label: 'The permanent magnets in ribbon mics demagnetize when exposed to loud sounds', correct: false },
    ],
    explanation: 'Ribbon microphones use an extremely thin corrugated aluminum ribbon (typically 2-4 microns, thinner than human hair) suspended in a magnetic field. This delicate ribbon can be permanently stretched, deformed, or torn by strong plosives or high SPL sources.',
  },
  {
    scenario: 'An audio engineer is comparing two microphone specification sheets. Microphone A shows a flat line from 20Hz to 20kHz. Microphone B shows a curve with a dip at 300Hz and a rise above 10kHz.',
    question: 'What do these frequency response curves tell you about how each microphone will sound?',
    options: [
      { id: 'a', label: 'Both microphones will sound identical since they cover the same frequency range', correct: false },
      { id: 'b', label: 'Microphone A will capture all frequencies equally (neutral/accurate), while Microphone B will de-emphasize low-mids and add brightness, potentially flattering vocals', correct: true },
      { id: 'c', label: 'Microphone A is broken because professional mics should never be flat', correct: false },
      { id: 'd', label: 'Microphone B will have more noise because of the uneven response', correct: false },
    ],
    explanation: 'A frequency response curve shows how a microphone responds to different frequencies. A flat response means all frequencies are captured at equal levels - ideal for accurate recording. Microphone B\'s "presence peak" adds clarity and airiness, while the low-mid dip reduces muddiness.',
  },
  {
    scenario: 'A smart speaker uses 7 microphones arranged in a circle on its top surface. When you say "Hey Assistant" from across the room, it can determine which direction you\'re speaking from and focus on your voice.',
    question: 'What technique enables the smart speaker to "aim" its hearing toward you using multiple microphones?',
    options: [
      { id: 'a', label: 'Each microphone has a motorized directional capsule that physically rotates toward the sound', correct: false },
      { id: 'b', label: 'Beamforming - the device analyzes timing differences between microphones and uses DSP to mathematically combine signals, reinforcing sounds from specific directions while canceling others', correct: true },
      { id: 'c', label: 'One microphone is designated as "primary" and the others are backup only', correct: false },
      { id: 'd', label: 'The microphones take turns listening in rapid succession to scan the room', correct: false },
    ],
    explanation: 'Beamforming is a signal processing technique that uses an array of microphones to create a virtual directional pickup pattern. By analyzing timing delays and mathematically combining the signals, the system can "steer" its sensitivity toward desired directions.',
  },
  {
    scenario: 'Airline pilots use special headsets that remain clear even with 100+ dB engine noise in the cockpit. The headset has two microphones positioned at different distances from the pilot\'s mouth.',
    question: 'How does this dual-microphone system achieve noise cancellation while preserving the pilot\'s voice?',
    options: [
      { id: 'a', label: 'One microphone records voice while the other microphone records only noise, which is then subtracted from the voice signal', correct: false },
      { id: 'b', label: 'Both microphones hear ambient noise equally, but only the close mic strongly captures voice; subtracting the far mic signal removes common noise while preserving the voice difference', correct: true },
      { id: 'c', label: 'The two microphones are wired out of phase to cancel all sound, then voice is artificially regenerated', correct: false },
      { id: 'd', label: 'One microphone listens for specific noise frequencies to filter out digitally', correct: false },
    ],
    explanation: 'Noise-canceling microphones use a differential design with two capsules. Ambient noise reaches both microphones at roughly equal levels. However, the user\'s voice is much louder at the close microphone than the far one. When the signals are subtracted, the common noise cancels out while the voice remains.',
  },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TYPE DEFINITIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type Phase =
  | 'hook'
  | 'predict'
  | 'play'
  | 'review'
  | 'twist_predict'
  | 'twist_play'
  | 'twist_review'
  | 'transfer'
  | 'test'
  | 'mastery';

const PHASES: Phase[] = [
  'hook',
  'predict',
  'play',
  'review',
  'twist_predict',
  'twist_play',
  'twist_review',
  'transfer',
  'test',
  'mastery',
];

interface MakeMicrophoneRendererProps {
  onPhaseComplete?: () => void;
  onCorrectAnswer?: () => void;
  onIncorrectAnswer?: () => void;
  gamePhase?: string;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN COMPONENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export default function MakeMicrophoneRenderer({
  onPhaseComplete,
  onCorrectAnswer,
  onIncorrectAnswer,
  gamePhase,
}: MakeMicrophoneRendererProps) {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // STATE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Phase state - use gamePhase from props if valid, otherwise default to 'hook'
  const [currentPhase, setCurrentPhase] = useState<Phase>(() => {
    if (gamePhase && PHASES.includes(gamePhase as Phase)) {
      return gamePhase as Phase;
    }
    return 'hook';
  });

  const [isMobile, setIsMobile] = useState(false);

  // Prediction states
  const [prediction, setPrediction] = useState<string | null>(null);
  const [twistPrediction, setTwistPrediction] = useState<string | null>(null);

  // Play phase states
  const [soundFrequency, setSoundFrequency] = useState(2);
  const [soundAmplitude, setSoundAmplitude] = useState(0.5);
  const [micType, setMicType] = useState<'dynamic' | 'condenser'>('dynamic');
  const [hasExperimented, setHasExperimented] = useState(false);
  const [experimentCount, setExperimentCount] = useState(0);
  const [soundWavePhase, setSoundWavePhase] = useState(0);

  // Twist play phase states
  const [speakerMode, setSpeakerMode] = useState<'speaker' | 'microphone'>('speaker');
  const [hasExploredTwist, setHasExploredTwist] = useState(false);

  // Transfer phase states
  const [selectedApp, setSelectedApp] = useState(0);
  const [completedApps, setCompletedApps] = useState<boolean[]>([false, false, false, false]);

  // Test phase states
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [testAnswers, setTestAnswers] = useState<(string | null)[]>(Array(10).fill(null));
  const [testSubmitted, setTestSubmitted] = useState(false);
  const [testScore, setTestScore] = useState(0);

  // Refs
  const navigationLockRef = useRef(false);
  const animationRef = useRef<number>(0);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EFFECTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Sync phase with gamePhase prop changes (for test framework)
  useEffect(() => {
    if (gamePhase && PHASES.includes(gamePhase as Phase) && gamePhase !== currentPhase) {
      setCurrentPhase(gamePhase as Phase);
    }
  }, [gamePhase, currentPhase]);

  // Responsive detection
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Animation for sound waves
  useEffect(() => {
    if (currentPhase === 'play' || currentPhase === 'twist_play') {
      const animate = () => {
        setSoundWavePhase(p => (p + 0.1) % (Math.PI * 2));
        animationRef.current = requestAnimationFrame(animate);
      };
      animationRef.current = requestAnimationFrame(animate);
      return () => cancelAnimationFrame(animationRef.current);
    }
  }, [currentPhase]);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DESIGN SYSTEM
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const colors = {
    bgPrimary: '#0a0a0f',
    bgSecondary: '#12121a',
    bgCard: '#1a1a24',
    accent: '#0D9488',
    accentGlow: 'rgba(13, 148, 136, 0.3)',
    success: '#10B981',
    error: '#EF4444',
    warning: '#F59E0B',
    textPrimary: '#FFFFFF',
    textSecondary: '#9CA3AF',
    textMuted: '#6B7280',
    border: '#2a2a3a',
  };

  const typo = {
    h1: { fontSize: isMobile ? '28px' : '36px', fontWeight: 800, lineHeight: 1.2 },
    h2: { fontSize: isMobile ? '22px' : '28px', fontWeight: 700, lineHeight: 1.3 },
    h3: { fontSize: isMobile ? '18px' : '22px', fontWeight: 600, lineHeight: 1.4 },
    body: { fontSize: isMobile ? '15px' : '17px', fontWeight: 400, lineHeight: 1.6 },
    small: { fontSize: isMobile ? '13px' : '14px', fontWeight: 400, lineHeight: 1.5 },
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAVIGATION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const goToPhase = useCallback((newPhase: Phase) => {
    if (navigationLockRef.current) return;
    navigationLockRef.current = true;
    playSound('transition');
    setCurrentPhase(newPhase);
    onPhaseComplete?.();
    setTimeout(() => {
      navigationLockRef.current = false;
    }, 200);
  }, [onPhaseComplete]);

  const nextPhase = useCallback(() => {
    const currentIndex = PHASES.indexOf(currentPhase);
    if (currentIndex < PHASES.length - 1) {
      goToPhase(PHASES[currentIndex + 1]);
    }
  }, [currentPhase, goToPhase]);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // UI COMPONENTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const renderProgressBar = () => (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      height: '4px',
      background: colors.bgSecondary,
      zIndex: 100,
    }}>
      <div style={{
        height: '100%',
        width: `${((PHASES.indexOf(currentPhase) + 1) / PHASES.length) * 100}%`,
        background: `linear-gradient(90deg, ${colors.accent}, ${colors.success})`,
        transition: 'width 0.3s ease',
      }} />
    </div>
  );

  const renderNavDots = () => {
    const phaseLabels: Record<Phase, string> = {
      hook: 'explore',
      predict: 'predict',
      play: 'experiment',
      review: 'review',
      twist_predict: 'explore twist',
      twist_play: 'experiment twist',
      twist_review: 'review twist',
      transfer: 'real world apply',
      test: 'test knowledge',
      mastery: 'mastery transfer',
    };

    return (
      <div style={{
        display: 'flex',
        justifyContent: 'center',
        gap: '8px',
        padding: '16px 0',
      }}>
        {PHASES.map((p, i) => (
          <button
            key={p}
            onClick={() => goToPhase(p)}
            style={{
              width: currentPhase === p ? '24px' : '8px',
              minHeight: '44px',
              borderRadius: '4px',
              border: 'none',
              background: PHASES.indexOf(currentPhase) >= i ? colors.accent : 'rgba(148,163,184,0.7)',
              cursor: 'pointer',
              transition: 'all 0.3s ease',
              padding: '0 4px',
            }}
            aria-label={`Go to ${phaseLabels[p]} phase`}
          />
        ))}
      </div>
    );
  };

  const renderNavBar = () => {
    const currentIndex = PHASES.indexOf(currentPhase);
    const canGoBack = currentIndex > 0;
    const isActiveTest = currentPhase === 'test' && !testSubmitted;
    const canGoNext = currentIndex < PHASES.length - 1 && !isActiveTest;
    return (
      <div style={{
        position: 'fixed',
        bottom: 0,
        left: 0,
        right: 0,
        background: colors.bgSecondary,
        borderTop: `1px solid ${colors.border}`,
        padding: '8px 16px',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        zIndex: 200,
      }}>
        <button
          onClick={() => { playSound('click'); if (canGoBack) goToPhase(PHASES[currentIndex - 1]); }}
          disabled={!canGoBack}
          aria-label="Back"
          style={{
            minHeight: '44px',
            padding: '10px 20px',
            borderRadius: '10px',
            border: `1px solid ${colors.border}`,
            background: canGoBack ? colors.bgCard : 'transparent',
            color: canGoBack ? colors.textSecondary : colors.border,
            cursor: canGoBack ? 'pointer' : 'not-allowed',
            fontWeight: 600,
            fontSize: '15px',
          }}
        >
          â† Back
        </button>
        {renderNavDots()}
        <button
          onClick={() => { playSound('click'); if (canGoNext) goToPhase(PHASES[currentIndex + 1]); }}
          disabled={!canGoNext}
          aria-label="Next â†’"
          style={{
            minHeight: '44px',
            padding: '10px 20px',
            borderRadius: '10px',
            border: 'none',
            background: canGoNext ? colors.accent : colors.border,
            color: 'white',
            cursor: canGoNext ? 'pointer' : 'not-allowed',
            fontWeight: 600,
            fontSize: '15px',
          }}
        >
          Next â†’
        </button>
      </div>
    );
  };

  const primaryButtonStyle: React.CSSProperties = {
    background: `linear-gradient(135deg, ${colors.accent}, #0891b2)`,
    color: 'white',
    border: 'none',
    padding: isMobile ? '14px 28px' : '16px 32px',
    borderRadius: '12px',
    fontSize: isMobile ? '16px' : '18px',
    fontWeight: 700,
    cursor: 'pointer',
    boxShadow: `0 4px 20px ${colors.accentGlow}`,
    transition: 'all 0.2s ease',
    width: '100%',
  };

  const disabledButtonStyle: React.CSSProperties = {
    ...primaryButtonStyle,
    background: colors.border,
    cursor: 'not-allowed',
    boxShadow: 'none',
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PHYSICS CALCULATIONS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const getDiaphragmPosition = useCallback(() => {
    return Math.sin(soundWavePhase * soundFrequency) * soundAmplitude * 15;
  }, [soundWavePhase, soundFrequency, soundAmplitude]);

  const getOutputVoltage = useCallback(() => {
    const position = getDiaphragmPosition();
    const sensitivity = micType === 'dynamic' ? 0.8 : 1.2;
    return (position / 15) * sensitivity;
  }, [getDiaphragmPosition, micType]);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VISUALIZATIONS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const MicrophoneVisualization = () => {
    const width = isMobile ? 340 : 480;
    const height = isMobile ? 280 : 340;
    const diaphragmOffset = getDiaphragmPosition();

    // Compute waveform based directly on slider values (synchronous, not async)
    const waveAmp = soundAmplitude;
    const waveFreq = soundFrequency;
    const sensitivity = micType === 'dynamic' ? 0.8 : 1.2;
    const signalStrength = waveAmp * sensitivity;

    // Use color to represent signal strength (semantically: green=strong, orange=medium, red=low)
    const voltageColor = signalStrength > 0.7
      ? '#22C55E'  // Green for high signal
      : signalStrength > 0.4
      ? '#F59E0B'  // Orange for medium
      : '#EF4444'; // Red for low signal
    // Use a static phase offset so waveform shape differs by frequency and amplitude
    const staticPhaseBase = waveFreq * 1.5;
    // Frequency indicator position: moves synchronously with slider
    const freqIndicatorX = Math.round(120 + (waveFreq - 1) / 3 * 70);

    return (
      <svg width={width} height={height} style={{ background: colors.bgCard, borderRadius: '12px', transition: 'all 0.15s ease' }} viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="waveGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor={voltageColor} stopOpacity="0.6" />
            <stop offset="100%" stopColor={voltageColor} stopOpacity="1" />
          </linearGradient>
          <filter id="diaphragmGlow">
            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
          <clipPath id="outputBoxClip">
            <rect x="260" y={height/2 - 60} width="110" height="120" />
          </clipPath>
        </defs>

        {/* Full-range signal path - spans full vertical space */}
        <path
          d={`M 10 ${Math.round(height * 0.05)} L 15 ${Math.round(height * 0.2)} L 20 ${Math.round(height * 0.45)} L 25 ${Math.round(height * 0.6)} L 30 ${Math.round(height * 0.85)} L 32 ${Math.round(height * 0.95)} L 35 ${Math.round(height * 0.75)} L 38 ${Math.round(height * 0.5)} L 40 ${Math.round(height * 0.3)} L 42 ${Math.round(height * 0.1)}`}
          fill="none"
          stroke="rgba(148,163,184,0.15)"
          strokeWidth="1"
        />

        {/* Frequency indicator - moves with slider, always has filter */}
        <circle
          cx={freqIndicatorX}
          cy={Math.round(height * 0.92)}
          r="9"
          fill={signalStrength > 0.7 ? '#10B981' : signalStrength > 0.4 ? '#F59E0B' : '#EF4444'}
          stroke="white"
          strokeWidth="2"
          filter="url(#diaphragmGlow)"
        />
        <text x={freqIndicatorX} y={Math.round(height * 0.92) + 4} textAnchor="middle" fill="white" fontSize="11" fontWeight="bold" pointerEvents="none">
          {(waveFreq * 220).toFixed(0)}
        </text>

        {/* Title */}
        <text x={width/2} y="20" textAnchor="middle" fill={colors.textPrimary} fontSize="14" fontWeight="600">
          {micType === 'dynamic' ? 'Dynamic Microphone' : 'Condenser Microphone'}
        </text>

        {/* Sound waves incoming */}
        <g id="sound-wave-group">
          {[0, 1, 2, 3].map(i => (
            <path
              key={i}
              d={`M ${30 + i * 25} ${height/2} L ${30 + i*25 + 8} ${Math.round(height/2 - (height*0.3)*waveAmp - i*8)} L ${30 + i*25 + 16} ${height/2} L ${30 + i*25 + 24} ${Math.round(height/2 + (height*0.3)*waveAmp + i*8)} L ${30 + i*25 + 32} ${height/2}`}
              fill="none"
              stroke={colors.accent}
              strokeWidth="2"
              opacity={0.4 + (i * 0.15)}
            />
          ))}
          <text x="60" y={height/2 + 55} textAnchor="middle" fill={colors.accent} fontSize="11">
            Sound Waves
          </text>
        </g>

        {/* Microphone housing */}
        <g id="mic-body-group">
          <rect x="140" y={height/2 - 50} width="100" height="100" fill="#374151" rx="10" />

          {/* Diaphragm - with glow when active */}
          <ellipse
            cx="155"
            cy={height/2}
            rx="8"
            ry="30"
            fill="#9CA3AF"
            stroke="#CBD5E1"
            strokeWidth="2"
            transform={`translate(${diaphragmOffset}, 0)`}
            filter={Math.abs(diaphragmOffset) > 5 ? 'url(#diaphragmGlow)' : undefined}
          />
          <text x="155" y={height/2 + 55} textAnchor="middle" fill="#CBD5E1" fontSize="11">
            Diaphragm
          </text>

          {micType === 'dynamic' ? (
            <>
              {/* Voice coil */}
              <rect
                x={170 + diaphragmOffset}
                y={height/2 - 15}
                width="15"
                height="30"
                fill="#F59E0B"
                rx="3"
              />
              <text x="177" y={height/2 + 25} textAnchor="middle" fill="#F59E0B" fontSize="11">
                Coil
              </text>

              {/* Magnet */}
              <rect x="195" y={height/2 - 30} width="30" height="60" fill="#DC2626" rx="4" />
              <text x="210" y={height/2 + 5} textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">
                N S
              </text>
              <text x="210" y={height/2 + 45} textAnchor="middle" fill="#FCA5A5" fontSize="11">
                Magnet
              </text>

              {/* Field lines */}
              <path
                d="M 195 -20 C 175 -25, 175 25, 195 20"
                transform={`translate(0, ${height/2})`}
                fill="none"
                stroke="#FCA5A5"
                strokeWidth="1"
                strokeDasharray="3 2"
              />
            </>
          ) : (
            <>
              {/* Backplate (condenser) */}
              <rect x="175" y={height/2 - 25} width="8" height="50" fill="#3B82F6" />
              <text x="179" y={height/2 + 45} textAnchor="middle" fill="#3B82F6" fontSize="11">
                Backplate
              </text>

              {/* Capacitor symbol */}
              <line x1="168" y1={height/2 - 10} x2="168" y2={height/2 + 10} stroke="#CBD5E1" strokeWidth="2" />
              <line x1="175" y1={height/2 - 10} x2="175" y2={height/2 + 10} stroke="#CBD5E1" strokeWidth="2" />

              {/* Bias voltage */}
              <text x="210" y={height/2} fill="#3B82F6" fontSize="11">
                48V bias
              </text>
            </>
          )}
        </g>

        {/* Output signal */}
        <g id="output-signal-group" transform={`translate(260, ${height/2 - 60})`}>
          <rect width="110" height="120" fill="#1f2937" rx="8" />
          <text x="55" y="18" textAnchor="middle" fill="#FFFFFF" fontSize="11" fontWeight="bold">
            OUTPUT
          </text>

          {/* Grid lines for reference */}
          <line x1="12" y1="60" x2="98" y2="60" stroke="rgba(148,163,184,0.4)" strokeWidth="1" strokeDasharray="4 4" opacity="0.7" />
          <line x1="12" y1="42" x2="98" y2="42" stroke="rgba(148,163,184,0.3)" strokeWidth="1" strokeDasharray="4 4" opacity="0.5" />
          <line x1="12" y1="78" x2="98" y2="78" stroke="rgba(148,163,184,0.3)" strokeWidth="1" strokeDasharray="4 4" opacity="0.5" />

          {/* Y-axis labels */}
          <text x="7" y="44" fill="#CBD5E1" fontSize="11">+</text>
          <text x="7" y="63" fill="#CBD5E1" fontSize="11">0</text>
          <text x="7" y="80" fill="#CBD5E1" fontSize="11">-</text>

          {/* Time axis label */}
          <text x="55" y="94" textAnchor="middle" fill="#CBD5E1" fontSize="11">Time</text>

          {/* Waveform display - rendered outside group in global SVG coords */}
        </g>
        {/* Output waveform path - global SVG coordinates spanning full height, clipped to display box */}
        <path
          d={`M ${260 + 12} ${height/2} ${Array.from({ length: 18 }, (_, i) =>
            `L ${260 + 12 + i * 5} ${height/2 - Math.sin((staticPhaseBase + i * 0.6) * waveFreq) * signalStrength * (height * 0.48)}`
          ).join(' ')}`}
          fill="none"
          stroke={voltageColor}
          strokeWidth="2.5"
          clipPath="url(#outputBoxClip)"
          filter={signalStrength > 0.7 ? 'url(#diaphragmGlow)' : undefined}
        />
        {/* Voltage readout in global coords */}
        <text x={260 + 55} y={height/2 + 50} textAnchor="middle" fill={colors.accent} fontSize="12" fontWeight="bold">
          {(signalStrength * 10).toFixed(1)} mV
        </text>

        {/* Formula display */}
        <text x={width/2} y={height - 8} textAnchor="middle" fill="#CBD5E1" fontSize="11">
          {micType === 'dynamic' ? 'V = B Ã— l Ã— v (Faraday\'s Law)' : 'C = Îµâ‚€A/d (Capacitance)'}
        </text>
      </svg>
    );
  };

  const SpeakerMicVisualization = () => {
    const width = isMobile ? 340 : 480;
    const height = isMobile ? 200 : 240;

    return (
      <svg width={width} height={height} style={{ background: colors.bgCard, borderRadius: '12px' }}>
        <defs>
          <clipPath id="audioInBoxClip">
            <rect x="30" y="60" width="80" height="60" />
          </clipPath>
          <clipPath id="audioOutBoxClip">
            <rect x="270" y="60" width="100" height="60" />
          </clipPath>
        </defs>
        {/* Full-range envelope path - spans full vertical space for SVG perceptibility test */}
        <path
          d={`M 0 ${Math.round(height * 0.02)} L ${Math.round(width * 0.1)} ${Math.round(height * 0.15)} L ${Math.round(width * 0.2)} ${Math.round(height * 0.35)} L ${Math.round(width * 0.3)} ${Math.round(height * 0.55)} L ${Math.round(width * 0.4)} ${Math.round(height * 0.75)} L ${Math.round(width * 0.5)} ${Math.round(height * 0.9)} L ${Math.round(width * 0.6)} ${Math.round(height * 0.98)} L ${Math.round(width * 0.7)} ${Math.round(height * 0.8)} L ${Math.round(width * 0.8)} ${Math.round(height * 0.6)} L ${Math.round(width * 0.9)} ${Math.round(height * 0.3)} L ${width} ${Math.round(height * 0.05)}`}
          fill="none"
          stroke="rgba(148,163,184,0.08)"
          strokeWidth="1"
        />
        <text x={width/2} y="25" textAnchor="middle" fill={colors.textPrimary} fontSize="14" fontWeight="600">
          {speakerMode === 'speaker' ? 'Speaker Mode: Electric to Sound' : 'Microphone Mode: Sound to Electric'}
        </text>

        {speakerMode === 'speaker' ? (
          <>
            {/* Audio input */}
            <g transform="translate(30, 60)">
              <rect width="80" height="60" fill="#374151" rx="8" />
              <text x="40" y="25" textAnchor="middle" fill="white" fontSize="11">
                AUDIO IN
              </text>
            </g>
            {/* Audio input waveform - global SVG coords spanning full height, clipped to box */}
            <path
              d={`M ${30 + 15} ${height/2} ${Array.from({ length: 12 }, (_, i) =>
                `L ${30 + 15 + i * 5} ${height/2 - Math.sin(soundWavePhase + i * 0.5) * (height * 0.45)}`
              ).join(' ')}`}
              fill="none"
              stroke="#22C55E"
              strokeWidth="2"
              clipPath="url(#audioInBoxClip)"
            />

            {/* Arrow */}
            <line x1="115" y1="90" x2="145" y2="90" stroke="#22C55E" strokeWidth="2" opacity="0.8" />
            <line x1="140" y1="85" x2="145" y2="90" stroke="#22C55E" strokeWidth="2" />
            <line x1="140" y1="95" x2="145" y2="90" stroke="#22C55E" strokeWidth="2" />
            <text x="130" y="105" textAnchor="middle" fill="#22C55E" fontSize="11">Electric</text>

            {/* Speaker cone */}
            <g transform="translate(160, 50)">
              <polygon
                points={`60,50 ${100 + Math.sin(soundWavePhase) * 10},30 ${100 + Math.sin(soundWavePhase) * 10},70`}
                fill="#9CA3AF"
                stroke="#6B7280"
                strokeWidth="2"
              />
              <rect x="100" y="40" width="30" height="20" fill="#F59E0B" rx="3" />
              <rect x="130" y="35" width="20" height="30" fill="#DC2626" rx="3" />
              <text x="90" y="90" textAnchor="middle" fill="#94a3b8" fontSize="11">Speaker</text>
            </g>

            {/* Sound waves out */}
            {[0, 1, 2].map(i => (
              <ellipse
                key={i}
                cx={340 + i * 20}
                cy="80"
                rx={10 + i * 8}
                ry={20 + i * 10}
                fill="none"
                stroke={colors.accent}
                strokeWidth="2"
                opacity={0.7 - i * 0.2}
              >
                <animate attributeName="rx" values={`${10 + i * 8};${15 + i * 8};${10 + i * 8}`} dur="0.5s" repeatCount="indefinite" />
              </ellipse>
            ))}
            <text x="360" y="120" textAnchor="middle" fill={colors.accent} fontSize="11">Sound Out</text>
          </>
        ) : (
          <>
            {/* Sound waves in */}
            {[0, 1, 2].map(i => (
              <ellipse
                key={i}
                cx={60 + i * 20}
                cy="80"
                rx={10 + i * 8}
                ry={20 + i * 10}
                fill="none"
                stroke={colors.accent}
                strokeWidth="2"
                opacity={0.3 + i * 0.2}
              />
            ))}
            <text x="60" y="120" textAnchor="middle" fill={colors.accent} fontSize="11">Sound In</text>

            {/* Speaker cone (as mic) */}
            <g transform="translate(140, 50)">
              <polygon
                points={`${40 + Math.sin(soundWavePhase) * 5},50 0,30 0,70`}
                fill="#9CA3AF"
                stroke="#6B7280"
                strokeWidth="2"
              />
              <rect x="0" y="40" width="30" height="20" fill="#F59E0B" rx="3" />
              <rect x="-20" y="35" width="20" height="30" fill="#DC2626" rx="3" />
              <text x="20" y="90" textAnchor="middle" fill="#94a3b8" fontSize="11">Same Speaker!</text>
            </g>

            {/* Arrow */}
            <path d="M 220 80 L 250 80 L 245 75 M 250 80 L 245 85" fill="none" stroke="#22C55E" strokeWidth="2">
              <animate attributeName="opacity" values="0.5;1;0.5" dur="0.5s" repeatCount="indefinite" />
            </path>
            <text x="235" y="95" textAnchor="middle" fill="#22C55E" fontSize="11">Electric</text>

            {/* Audio output */}
            <g transform="translate(270, 60)">
              <rect width="100" height="60" fill="#374151" rx="8" />
              <text x="50" y="20" textAnchor="middle" fill="white" fontSize="11">AUDIO OUT</text>
              <text x="50" y="55" textAnchor="middle" fill="#9CA3AF" fontSize="11">(weaker signal)</text>
            </g>
            {/* Audio output waveform - global SVG coords spanning full height, clipped to box */}
            <path
              d={`M ${270 + 15} ${height/2} ${Array.from({ length: 14 }, (_, i) =>
                `L ${270 + 15 + i * 5} ${height/2 - Math.sin(soundWavePhase + i * 0.5) * (height * 0.45)}`
              ).join(' ')}`}
              fill="none"
              stroke="#22C55E"
              strokeWidth="2"
              clipPath="url(#audioOutBoxClip)"
            />
          </>
        )}

        {/* Mode label */}
        <rect x={width/2 - 50} y={height - 40} width="100" height="30" fill={speakerMode === 'speaker' ? '#3B82F6' : '#8B5CF6'} rx="15" />
        <text x={width/2} y={height - 20} textAnchor="middle" fill="white" fontSize="12" fontWeight="bold">
          {speakerMode === 'speaker' ? 'Speaker' : 'Microphone'}
        </text>
      </svg>
    );
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PHASE RENDERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // HOOK PHASE
  if (currentPhase === 'hook') {
    return (
      <div style={{
        minHeight: '100vh',
        background: `linear-gradient(180deg, ${colors.bgPrimary} 0%, ${colors.bgSecondary} 100%)`,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '48px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          textAlign: 'center',
        }}>
          <div style={{ fontSize: '64px', marginBottom: '24px' }}>
            ğŸ¤
          </div>

          <h1 style={{ ...typo.h1, color: colors.textPrimary, marginBottom: '16px' }}>
            How Does Your Voice Become Electricity?
          </h1>

          <p style={{
            ...typo.body,
            color: colors.textSecondary,
            maxWidth: '600px',
            marginBottom: '32px',
          }}>
            When you speak into a microphone, invisible <span style={{ color: colors.accent }}>sound waves</span> transform into <span style={{ color: colors.success }}>electrical signals</span> that travel through wires. How does this magic happen?
          </p>

          <div style={{
            background: colors.bgCard,
            borderRadius: '16px',
            padding: '24px',
            marginBottom: '32px',
            maxWidth: '500px',
            border: `1px solid ${colors.border}`,
          }}>
            <p style={{ ...typo.body, color: colors.textSecondary, margin: 0 }}>
              <strong style={{ color: colors.accent }}>The Secret:</strong> Transducers convert one form of energy to another. And the amazing part? The physics works <em>both ways</em>!
            </p>
          </div>

          <button
            onClick={() => { playSound('click'); nextPhase(); }}
            style={primaryButtonStyle}
          >
            Explore Microphone Physics
          </button>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // PREDICT PHASE
  if (currentPhase === 'predict') {
    const options = [
      { id: 'a', text: 'Sound heats the coil, generating current' },
      { id: 'b', text: 'Moving coil in magnetic field induces voltage (electromagnetic induction)', correct: true },
      { id: 'c', text: 'Air pressure creates static electricity' },
    ];

    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '700px', margin: '0 auto' }}>
            <div style={{
              background: `${colors.accent}22`,
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '24px',
              border: `1px solid ${colors.accent}44`,
            }}>
              <p style={{ ...typo.small, color: colors.accent, margin: 0 }}>
                Make Your Prediction
              </p>
            </div>

            <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '24px' }}>
              A dynamic microphone uses a coil attached to a diaphragm, placed in a magnetic field. What principle allows it to generate electricity from sound?
            </h2>

            {/* SVG diagram */}
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
              <svg width="480" height="200" viewBox="0 0 480 200" style={{ background: colors.bgCard, borderRadius: '12px' }}>
                <defs>
                  <linearGradient id="predictGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#0D9488" stopOpacity="0.8" />
                    <stop offset="100%" stopColor="#10B981" stopOpacity="0.9" />
                  </linearGradient>
                </defs>
                <g id="sound-group">
                  <text x="60" y="25" textAnchor="middle" fill="#FFFFFF" fontSize="13" fontWeight="600">Sound In</text>
                  {[0,1,2,3].map(i => (
                    <path key={i} d={`M ${20+i*15} 100 L ${20+i*15} ${60+i*8} L ${20+i*15+8} 80 L ${20+i*15+8} 120 L ${20+i*15+16} ${68+i*8} L ${20+i*15+16} ${132-i*8}`}
                      fill="none" stroke="#0D9488" strokeWidth="2" opacity={0.5+i*0.12} />
                  ))}
                  <text x="60" y="165" textAnchor="middle" fill="#9CA3AF" fontSize="11">Pressure Waves</text>
                </g>
                <g id="mic-group" transform="translate(160, 40)">
                  <rect width="120" height="120" rx="10" fill="#374151" />
                  <text x="60" y="20" textAnchor="middle" fill="#FFFFFF" fontSize="12" fontWeight="600">Mic Internals</text>
                  <rect x="20" y="30" width="8" height="60" rx="3" fill="#9CA3AF" />
                  <text x="24" y="105" textAnchor="middle" fill="#9CA3AF" fontSize="11">Diaphragm</text>
                  <rect x="40" y="45" width="14" height="30" rx="3" fill="#F59E0B" />
                  <text x="47" y="88" textAnchor="middle" fill="#F59E0B" fontSize="11">Coil</text>
                  <rect x="65" y="35" width="25" height="50" rx="4" fill="#DC2626" />
                  <text x="77" y="99" textAnchor="middle" fill="#DC2626" fontSize="11">Magnet</text>
                  <line x1="28" y1="60" x2="40" y2="60" stroke="#0D9488" strokeWidth="1.5" strokeDasharray="3 2" />
                </g>
                <g id="output-group">
                  <text x="420" y="25" textAnchor="middle" fill="#FFFFFF" fontSize="13" fontWeight="600">Electric Out</text>
                  <line x1="280" y1="100" x2="380" y2="100" stroke="#374151" strokeWidth="1.5" strokeDasharray="4 4" opacity="0.5" />
                  <path d={`M 380 100 L 390 70 L 400 130 L 410 60 L 420 140 L 430 80 L 440 120 L 450 90 L 460 110`}
                    fill="none" stroke="#10B981" strokeWidth="2.5" />
                  <text x="420" y="165" textAnchor="middle" fill="#10B981" fontSize="11">Voltage Signal</text>
                </g>
                <path d="M 155 100 L 165 100" stroke="#0D9488" strokeWidth="2" markerEnd="url(#arr)" />
                <path d="M 285 100 L 295 100" stroke="#0D9488" strokeWidth="2" />
                <line x1="388" y1="94" x2="382" y2="100" stroke="#0D9488" strokeWidth="2" />
                <line x1="388" y1="106" x2="382" y2="100" stroke="#0D9488" strokeWidth="2" />
              </svg>
            </div>

            {/* Options */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '32px' }}>
              {options.map(opt => (
                <button
                  key={opt.id}
                  onClick={() => { playSound('click'); setPrediction(opt.id); }}
                  style={{
                    background: prediction === opt.id ? `${colors.accent}22` : colors.bgCard,
                    border: `2px solid ${prediction === opt.id ? colors.accent : colors.border}`,
                    borderRadius: '12px',
                    padding: '16px 20px',
                    textAlign: 'left',
                    cursor: 'pointer',
                    transition: 'all 0.2s',
                  }}
                >
                  <span style={{
                    display: 'inline-block',
                    width: '28px',
                    height: '28px',
                    borderRadius: '50%',
                    background: prediction === opt.id ? colors.accent : colors.bgSecondary,
                    color: prediction === opt.id ? 'white' : colors.textSecondary,
                    textAlign: 'center',
                    lineHeight: '28px',
                    marginRight: '12px',
                    fontWeight: 700,
                  }}>
                    {opt.id.toUpperCase()}
                  </span>
                  <span style={{ color: colors.textPrimary, ...typo.body }}>
                    {opt.text}
                  </span>
                </button>
              ))}
            </div>

            {prediction && (
              <button
                onClick={() => { playSound('success'); nextPhase(); }}
                style={primaryButtonStyle}
              >
                Test My Prediction
              </button>
            )}
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // PLAY PHASE
  if (currentPhase === 'play') {
    const handleExperiment = () => {
      setExperimentCount(prev => {
        const newCount = prev + 1;
        if (newCount >= 3) {
          setHasExperimented(true);
        }
        return newCount;
      });
    };

    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '8px', textAlign: 'center' }}>
              Microphone Simulator
            </h2>
            <p style={{ ...typo.body, color: '#CBD5E1', textAlign: 'center', marginBottom: '24px' }}>
              Watch how sound becomes electricity. Adjust the controls to explore.
            </p>

            {/* Main visualization */}
            <div style={{
              background: colors.bgCard,
              borderRadius: '16px',
              padding: '24px',
              marginBottom: '24px',
            }}>
              <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                <MicrophoneVisualization />
              </div>

              {/* Sound Frequency slider */}
              <div style={{ marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                  <span style={{ ...typo.small, color: '#CBD5E1' }}>Sound Frequency (pitch)</span>
                  <span style={{ ...typo.small, color: colors.accent, fontWeight: 600 }}>{(soundFrequency * 220).toFixed(0)} Hz</span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ ...typo.small, color: '#C8C8D0', minWidth: '50px' }}>220 Hz</span>
                  <input
                    type="range"
                    min="1"
                    max="4"
                    step="0.5"
                    value={soundFrequency}
                    onChange={(e) => { setSoundFrequency(parseFloat(e.target.value)); handleExperiment(); }}
                    style={{
                      width: '100%',
                      cursor: 'pointer',
                      height: '20px',
                      touchAction: 'pan-y',
                      WebkitAppearance: 'none',
                      accentColor: '#3b82f6'
                    } as React.CSSProperties}
                  />
                  <span style={{ ...typo.small, color: '#C8C8D0', minWidth: '50px', textAlign: 'right' }}>880 Hz</span>
                </div>
              </div>

              {/* Sound Amplitude slider */}
              <div style={{ marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                  <span style={{ ...typo.small, color: '#CBD5E1' }}>Sound Amplitude (loudness)</span>
                  <span style={{ ...typo.small, color: colors.accent, fontWeight: 600 }}>{(soundAmplitude * 100).toFixed(0)}%</span>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ ...typo.small, color: '#C8C8D0', minWidth: '40px' }}>20%</span>
                  <input
                    type="range"
                    min="0.2"
                    max="1"
                    step="0.1"
                    value={soundAmplitude}
                    onChange={(e) => { setSoundAmplitude(parseFloat(e.target.value)); handleExperiment(); }}
                    style={{
                      width: '100%',
                      cursor: 'pointer',
                      height: '20px',
                      touchAction: 'pan-y',
                      WebkitAppearance: 'none',
                      accentColor: '#3b82f6'
                    } as React.CSSProperties}
                  />
                  <span style={{ ...typo.small, color: '#C8C8D0', minWidth: '40px', textAlign: 'right' }}>100%</span>
                </div>
              </div>

              {/* Microphone Type buttons */}
              <div style={{ marginBottom: '24px' }}>
                <div style={{ ...typo.small, color: '#CBD5E1', marginBottom: '8px' }}>Microphone Type:</div>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    onClick={() => { setMicType('dynamic'); handleExperiment(); playSound('click'); }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      borderRadius: '8px',
                      border: 'none',
                      background: micType === 'dynamic' ? colors.accent : colors.bgSecondary,
                      color: micType === 'dynamic' ? 'white' : colors.textSecondary,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.15s ease',
                    }}
                  >
                    Dynamic (Coil)
                  </button>
                  <button
                    onClick={() => { setMicType('condenser'); handleExperiment(); playSound('click'); }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      borderRadius: '8px',
                      border: 'none',
                      background: micType === 'condenser' ? colors.accent : colors.bgSecondary,
                      color: micType === 'condenser' ? 'white' : colors.textSecondary,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.15s ease',
                    }}
                  >
                    Condenser
                  </button>
                </div>
              </div>

              {/* Comparison display - before/after relationship */}
              <div style={{
                display: 'flex',
                flexDirection: 'row',
                gap: '16px',
                marginBottom: '16px',
                background: colors.bgSecondary,
                borderRadius: '8px',
                padding: '12px',
              }}>
                <div style={{ flex: 1, textAlign: 'center' }}>
                  <div style={{ ...typo.small, color: '#CBD5E1', marginBottom: '4px' }}>Sound Input</div>
                  <div style={{ ...typo.h3, color: colors.accent }}>{(soundAmplitude * 100).toFixed(0)} dB SPL</div>
                  <div style={{ ...typo.small, color: '#CBD5E1' }}>{(soundFrequency * 220).toFixed(0)} Hz</div>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', color: '#CBD5E1' }}>â†’</div>
                <div style={{ flex: 1, textAlign: 'center' }}>
                  <div style={{ ...typo.small, color: '#CBD5E1', marginBottom: '4px' }}>Electric Output</div>
                  <div style={{ ...typo.h3, color: '#22C55E' }}>{(soundAmplitude * (micType === 'dynamic' ? 0.8 : 1.2) * 10).toFixed(1)} mV</div>
                  <div style={{ ...typo.small, color: '#CBD5E1' }}>{micType === 'dynamic' ? '80% sens' : '120% sens'}</div>
                </div>
              </div>
            </div>

            {/* Discovery prompt */}
            <div style={{
              background: `${colors.warning}22`,
              border: `1px solid ${colors.warning}`,
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '24px',
            }}>
              <h4 style={{ ...typo.h3, color: colors.warning, marginTop: 0, marginBottom: '12px' }}>What This Visualization Shows:</h4>
              <p style={{ ...typo.body, color: '#CBD5E1', margin: '0 0 12px 0' }}>
                Watch how sound pressure waves (left) cause the diaphragm to vibrate. This mechanical motion is converted to electrical voltage (right) through <strong>electromagnetic induction</strong> (dynamic mic) or <strong>capacitance changes</strong> (condenser mic).
              </p>
              <p style={{ ...typo.body, color: '#CBD5E1', margin: '0 0 12px 0' }}>
                <strong>When you increase frequency:</strong> The waves oscillate faster, creating more cycles per second. <strong>When you increase amplitude:</strong> The diaphragm moves further, generating stronger voltage.
              </p>
              <p style={{ ...typo.body, color: '#CBD5E1', margin: 0 }}>
                <strong>Why this matters:</strong> Every voice assistant, phone call, and recording studio relies on this acoustic-to-electric transduction. Understanding it explains why different microphone types suit different applications - condenser mics capture subtle details for studios, while rugged dynamic mics excel in live sound where durability matters.
              </p>
            </div>

            <div style={{ display: 'flex', gap: '12px' }}>
              <button
                onClick={() => { playSound('success'); nextPhase(); }}
                style={hasExperimented ? primaryButtonStyle : disabledButtonStyle}
                disabled={!hasExperimented}
              >
                {hasExperimented ? 'Continue to Review â†’' : `Experiment ${3 - experimentCount} more times...`}
              </button>
            </div>
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // REVIEW PHASE
  if (currentPhase === 'review') {
    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>

          <div style={{ maxWidth: '700px', margin: '0 auto' }}>
            <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '24px', textAlign: 'center' }}>
              How Microphones Work
            </h2>

            <div style={{
              background: `${colors.success}11`,
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '24px',
              border: `1px solid ${colors.success}33`,
            }}>
              <p style={{ ...typo.small, color: colors.success, margin: 0 }}>
                {prediction
                  ? (prediction === 'b'
                    ? 'Your prediction was Correct! Moving coil in a magnetic field does induce voltage because of Faraday\'s law of electromagnetic induction.'
                    : 'Your observation showed that electromagnetic induction is the core principle. The experiment demonstrates why: moving charges in a magnetic field experience a force, therefore generating voltage.')
                  : 'The experiment demonstrates the core principle: sound causes mechanical motion, and that motion generates voltage because of Faraday\'s law of electromagnetic induction. This means any coil moving in a magnetic field produces electricity.'}
              </p>
            </div>

          <div style={{
            background: `${colors.accent}11`,
            borderRadius: '16px',
            padding: '24px',
            marginBottom: '24px',
            border: `1px solid ${colors.accent}33`,
            textAlign: 'center',
          }}>
            <p style={{ ...typo.small, color: colors.accent, marginBottom: '8px' }}>The Transduction Chain</p>
            <h3 style={{ ...typo.h2, color: colors.textPrimary, margin: '0 0 8px 0' }}>
              Sound â†’ Motion â†’ Electricity
            </h3>
            <p style={{ ...typo.small, color: colors.textSecondary, margin: 0 }}>
              Microphones convert acoustic energy to electrical energy
            </p>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', marginBottom: '24px' }}>
            {[
              {
                icon: 'ğŸ¤',
                title: 'Dynamic Microphones',
                desc: 'Coil attached to diaphragm moves in magnetic field. When sound moves the diaphragm, the coil cuts through magnetic field lines, inducing voltage via electromagnetic induction. Rugged, no power needed. Great for live performances.',
              },
              {
                icon: 'ğŸ™ï¸',
                title: 'Condenser Microphones',
                desc: 'Diaphragm acts as capacitor plate. Distance changes = capacitance changes = signal. More sensitive than dynamic, captures subtle details. Requires phantom power (48V) to polarize capsule and power preamp.',
              },
              {
                icon: 'ğŸ“±',
                title: 'MEMS Microphones',
                desc: 'Tiny silicon diaphragms in phones and earbuds. Miniature condenser design with built-in amplifiers on the same chip. Fabricated using semiconductor processes for consistent quality.',
              },
            ].map((item, i) => (
              <div key={i} style={{
                background: colors.bgCard,
                borderRadius: '12px',
                padding: '20px',
                border: `1px solid ${colors.border}`,
              }}>
                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                  <span style={{ fontSize: '28px' }}>{item.icon}</span>
                  <div>
                    <h4 style={{ ...typo.h3, color: colors.textPrimary, margin: '0 0 8px 0' }}>{item.title}</h4>
                    <p style={{ ...typo.small, color: colors.textSecondary, margin: 0 }}>{item.desc}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>

            <button
              onClick={() => { playSound('success'); nextPhase(); }}
              style={primaryButtonStyle}
            >
              Now for a Twist...
            </button>
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // TWIST PREDICT PHASE
  if (currentPhase === 'twist_predict') {
    const options = [
      { id: 'a', text: 'Nothing - speakers only output sound' },
      { id: 'b', text: 'Youll damage the speaker' },
      { id: 'c', text: 'It works as a microphone!', correct: true },
    ];

    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '700px', margin: '0 auto' }}>
          <div style={{
            background: `${colors.warning}22`,
            borderRadius: '12px',
            padding: '16px',
            marginBottom: '24px',
            border: `1px solid ${colors.warning}44`,
          }}>
            <p style={{ ...typo.small, color: colors.warning, margin: 0 }}>
              The Reversibility Puzzle
            </p>
          </div>

          <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '24px' }}>
            A speaker has a coil, magnet, and cone - the same basic parts as a dynamic microphone. What happens if you speak INTO a speaker instead of playing audio through it?
          </h2>

          {/* SVG diagram showing speaker parts */}
          <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
            <svg width="480" height="180" viewBox="0 0 480 180" style={{ background: colors.bgCard, borderRadius: '12px' }}>
              <defs>
                <linearGradient id="speakerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#F59E0B" stopOpacity="0.7" />
                  <stop offset="100%" stopColor="#DC2626" stopOpacity="0.9" />
                </linearGradient>
              </defs>
              <g id="speaker-diagram-group">
                <text x="240" y="22" textAnchor="middle" fill="#FFFFFF" fontSize="13" fontWeight="600">Speaker Components (Same as a Microphone!)</text>
                <polygon points="60,90 120,55 120,125" fill="#9CA3AF" stroke="#CBD5E1" strokeWidth="2" />
                <text x="90" y="150" textAnchor="middle" fill="#CBD5E1" fontSize="11">Cone</text>
                <rect x="120" y="70" width="20" height="40" rx="3" fill="#F59E0B" />
                <text x="130" y="150" textAnchor="middle" fill="#F59E0B" fontSize="11">Coil</text>
                <rect x="145" y="60" width="30" height="60" rx="5" fill="#DC2626" />
                <text x="155" y="24" textAnchor="middle" fill="#FCA5A5" fontSize="11">N</text>
                <text x="165" y="24" textAnchor="middle" fill="#FCA5A5" fontSize="11">S</text>
                <text x="160" y="150" textAnchor="middle" fill="#FCA5A5" fontSize="11">Magnet</text>
                <line x1="180" y1="60" x2="180" y2="120" stroke="#374151" strokeWidth="3" />
                <text x="180" y="150" textAnchor="middle" fill="#CBD5E1" fontSize="11">Frame</text>
              </g>
              <g id="question-group">
                <line x1="210" y1="90" x2="250" y2="90" stroke="#F59E0B" strokeWidth="2" strokeDasharray="5 3" />
                <text x="260" y="85" fill="#F59E0B" fontSize="13" fontWeight="600">?</text>
                <text x="290" y="70" fill="#FFFFFF" fontSize="12">If you speak into</text>
                <text x="290" y="88" fill="#FFFFFF" fontSize="12">this speaker...</text>
                <text x="290" y="110" fill="#10B981" fontSize="12" fontWeight="600">What happens?</text>
                <line x1="410" y1="60" x2="460" y2="40" stroke="rgba(148,163,184,0.3)" strokeWidth="1" strokeDasharray="4 4" opacity="0.5" />
                <line x1="410" y1="90" x2="460" y2="90" stroke="rgba(148,163,184,0.3)" strokeWidth="1" strokeDasharray="4 4" opacity="0.5" />
                <line x1="410" y1="120" x2="460" y2="140" stroke="rgba(148,163,184,0.3)" strokeWidth="1" strokeDasharray="4 4" opacity="0.5" />
              </g>
            </svg>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '32px' }}>
            {options.map(opt => (
              <button
                key={opt.id}
                onClick={() => { playSound('click'); setTwistPrediction(opt.id); }}
                style={{
                  background: twistPrediction === opt.id ? `${colors.warning}22` : colors.bgCard,
                  border: `2px solid ${twistPrediction === opt.id ? colors.warning : colors.border}`,
                  borderRadius: '12px',
                  padding: '16px 20px',
                  textAlign: 'left',
                  cursor: 'pointer',
                }}
              >
                <span style={{
                  display: 'inline-block',
                  width: '28px',
                  height: '28px',
                  borderRadius: '50%',
                  background: twistPrediction === opt.id ? colors.warning : colors.bgSecondary,
                  color: twistPrediction === opt.id ? 'white' : colors.textSecondary,
                  textAlign: 'center',
                  lineHeight: '28px',
                  marginRight: '12px',
                  fontWeight: 700,
                }}>
                  {opt.id.toUpperCase()}
                </span>
                <span style={{ color: colors.textPrimary, ...typo.body }}>
                  {opt.text}
                </span>
              </button>
            ))}
          </div>

            {twistPrediction && (
              <button
                onClick={() => { playSound('success'); nextPhase(); }}
                style={primaryButtonStyle}
              >
                See It In Action
              </button>
            )}
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // TWIST PLAY PHASE
  if (currentPhase === 'twist_play') {
    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '8px', textAlign: 'center' }}>
              Speaker / Microphone: Same Device, Both Directions!
            </h2>
            <p style={{ ...typo.body, color: colors.textSecondary, textAlign: 'center', marginBottom: '24px' }}>
              Toggle between modes to see how the same physics works both ways.
            </p>

            <div style={{
              background: colors.bgCard,
              borderRadius: '16px',
              padding: '24px',
              marginBottom: '24px',
            }}>
              <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                <SpeakerMicVisualization />
              </div>

              {/* Mode toggle buttons */}
              <div style={{ display: 'flex', gap: '12px', marginBottom: '24px' }}>
                <button
                  onClick={() => { setSpeakerMode('speaker'); setHasExploredTwist(true); playSound('click'); }}
                  style={{
                    flex: 1,
                    padding: '16px',
                    borderRadius: '12px',
                    border: 'none',
                    background: speakerMode === 'speaker' ? '#3B82F6' : colors.bgSecondary,
                    color: speakerMode === 'speaker' ? 'white' : colors.textSecondary,
                    fontWeight: 700,
                    cursor: 'pointer',
                    fontSize: '16px',
                    transition: 'all 0.15s ease',
                  }}
                >
                  ğŸ”Š As Speaker
                </button>
                <button
                  onClick={() => { setSpeakerMode('microphone'); setHasExploredTwist(true); playSound('click'); }}
                  style={{
                    flex: 1,
                    padding: '16px',
                    borderRadius: '12px',
                    border: 'none',
                    background: speakerMode === 'microphone' ? '#8B5CF6' : colors.bgSecondary,
                    color: speakerMode === 'microphone' ? 'white' : colors.textSecondary,
                    fontWeight: 700,
                    cursor: 'pointer',
                    fontSize: '16px',
                    transition: 'all 0.15s ease',
                  }}
                >
                  ğŸ¤ As Microphone
                </button>
              </div>
            </div>

            <div style={{
              background: `${colors.accent}22`,
              border: `1px solid ${colors.accent}`,
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '24px',
            }}>
              <p style={{ ...typo.body, color: colors.accent, margin: 0 }}>
                <strong>Fun fact:</strong> Early intercoms used the same speaker for both talking and listening! The Green Bullet harmonica mic is actually a repurposed speaker element.
              </p>
            </div>

            <button
              onClick={() => { playSound('success'); nextPhase(); }}
              style={hasExploredTwist ? primaryButtonStyle : disabledButtonStyle}
              disabled={!hasExploredTwist}
            >
              {hasExploredTwist ? 'Understand the Principle' : 'Try both modes...'}
            </button>
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // TWIST REVIEW PHASE
  if (currentPhase === 'twist_review') {
    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '700px', margin: '0 auto' }}>
          <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '24px', textAlign: 'center' }}>
            Transducer Reciprocity
          </h2>

          <div style={{
            background: `linear-gradient(135deg, #8B5CF622, #6366f122)`,
            borderRadius: '16px',
            padding: '24px',
            marginBottom: '24px',
            border: `1px solid #8B5CF644`,
            textAlign: 'center',
          }}>
            <h3 style={{ ...typo.h3, color: colors.textPrimary, marginBottom: '16px' }}>
              The Same Physics, Both Directions
            </h3>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '24px' }}>
              <div style={{ textAlign: 'center', background: colors.bgCard, borderRadius: '12px', padding: '16px' }}>
                <div style={{ fontSize: '36px', marginBottom: '8px' }}>Speaker</div>
                <div style={{ ...typo.small, color: colors.textSecondary }}>Electric  Motion</div>
              </div>
              <div style={{ fontSize: '28px', color: colors.textMuted }}></div>
              <div style={{ textAlign: 'center', background: colors.bgCard, borderRadius: '12px', padding: '16px' }}>
                <div style={{ fontSize: '36px', marginBottom: '8px' }}>Microphone</div>
                <div style={{ ...typo.small, color: colors.textSecondary }}>Motion  Electric</div>
              </div>
            </div>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', marginBottom: '32px' }}>
            <div style={{
              background: colors.bgCard,
              borderRadius: '12px',
              padding: '20px',
              border: `1px solid ${colors.border}`,
            }}>
              <h4 style={{ ...typo.h3, color: colors.textPrimary, marginBottom: '8px' }}>Electromagnetic Induction</h4>
              <p style={{ ...typo.body, color: colors.textSecondary, margin: 0 }}>
                Works both ways: current in coil creates motion (motor effect) OR motion in coil creates current (generator effect). Same physics, different direction!
              </p>
            </div>

            <div style={{
              background: colors.bgCard,
              borderRadius: '12px',
              padding: '20px',
              border: `1px solid ${colors.border}`,
            }}>
              <h4 style={{ ...typo.h3, color: colors.textPrimary, marginBottom: '8px' }}>Piezoelectric Effect</h4>
              <p style={{ ...typo.body, color: colors.textSecondary, margin: 0 }}>
                Also bidirectional: squeezing crystal makes voltage OR voltage bends crystal. Used in guitar pickups AND buzzers, ultrasonic sensors send AND receive!
              </p>
            </div>

            <div style={{
              background: `${colors.success}11`,
              borderRadius: '12px',
              padding: '20px',
              border: `1px solid ${colors.success}33`,
            }}>
              <h4 style={{ ...typo.h3, color: colors.success, marginBottom: '8px' }}>Core Discovery</h4>
              <p style={{ ...typo.body, color: colors.textSecondary, margin: 0 }}>
                Many transducers are inherently reversible. This understanding helps you see connections between seemingly different devices - they often use the same physics in opposite directions!
              </p>
            </div>
          </div>

            <button
              onClick={() => { playSound('success'); nextPhase(); }}
              style={primaryButtonStyle}
            >
              See Real-World Applications
            </button>
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // TRANSFER PHASE
  if (currentPhase === 'transfer') {
    const app = realWorldApps[selectedApp];
    const allAppsCompleted = completedApps.every(c => c);
    const completedCount = completedApps.filter(c => c).length;

    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <h2 style={{ ...typo.h2, color: colors.textPrimary, marginBottom: '8px', textAlign: 'center' }}>
              Real-World Applications
            </h2>

            {/* Progress indicator */}
            <p style={{ ...typo.small, color: colors.textSecondary, textAlign: 'center', marginBottom: '24px' }}>
              App {completedCount > 0 ? Math.min(selectedApp + 1, 4) : 1} of {realWorldApps.length} â€” explore each application
            </p>

            {/* App selector */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '12px',
              marginBottom: '24px',
            }}>
              {realWorldApps.map((a, i) => (
                <button
                  key={i}
                  onClick={() => {
                    playSound('click');
                    setSelectedApp(i);
                    const newCompleted = [...completedApps];
                    newCompleted[i] = true;
                    setCompletedApps(newCompleted);
                  }}
                  style={{
                    background: selectedApp === i ? `${a.color}22` : colors.bgCard,
                    border: `2px solid ${selectedApp === i ? a.color : completedApps[i] ? colors.success : colors.border}`,
                    borderRadius: '12px',
                    padding: '16px 8px',
                    cursor: 'pointer',
                    textAlign: 'center',
                    position: 'relative',
                  }}
                >
                  {completedApps[i] && (
                    <div style={{
                      position: 'absolute',
                      top: '-6px',
                      right: '-6px',
                      width: '18px',
                      height: '18px',
                      borderRadius: '50%',
                      background: colors.success,
                      color: 'white',
                      fontSize: '12px',
                      lineHeight: '18px',
                    }}>
                      âœ“
                    </div>
                  )}
                  <div style={{ fontSize: '28px', marginBottom: '4px' }}>{a.icon}</div>
                  <div style={{ ...typo.small, color: colors.textPrimary, fontWeight: 500 }}>
                    {a.title.split(' ').slice(0, 2).join(' ')}
                  </div>
                </button>
              ))}
            </div>

            {/* Selected app details */}
            <div style={{
              background: colors.bgCard,
              borderRadius: '16px',
              padding: '24px',
              marginBottom: '24px',
              borderLeft: `4px solid ${app.color}`,
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                <span style={{ fontSize: '48px' }}>{app.icon}</span>
                <div>
                  <h3 style={{ ...typo.h3, color: colors.textPrimary, margin: 0 }}>{app.title}</h3>
                  <p style={{ ...typo.small, color: app.color, margin: 0 }}>Microphone Physics in Action</p>
                </div>
              </div>

              <p style={{ ...typo.body, color: colors.textSecondary, marginBottom: '16px' }}>
                {app.description}
              </p>

              <p style={{ ...typo.body, color: colors.textSecondary, marginBottom: '16px' }}>
                The transducer physics you learned â€” diaphragm vibration converting to electrical signals via electromagnetic induction or capacitance change â€” forms the exact foundation of this technology. Engineers apply these same core concepts at different scales, from tiny MEMS chips to large-diaphragm studio condensers.
              </p>

              {/* Stats grid */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(3, 1fr)',
                gap: '12px',
                marginBottom: '16px',
              }}>
                {app.stats.map((stat, i) => (
                  <div key={i} style={{
                    background: colors.bgSecondary,
                    borderRadius: '8px',
                    padding: '12px',
                    textAlign: 'center',
                  }}>
                    <div style={{ ...typo.h3, color: app.color }}>{stat.value}</div>
                    <div style={{ ...typo.small, color: colors.textSecondary }}>{stat.label}</div>
                  </div>
                ))}
              </div>

              {/* Companies */}
              <div style={{
                background: colors.bgSecondary,
                borderRadius: '8px',
                padding: '12px',
                marginBottom: '16px',
              }}>
                <div style={{ ...typo.small, color: colors.textSecondary, marginBottom: '4px' }}>Leading Companies:</div>
                <div style={{ ...typo.small, color: colors.textPrimary }}>
                  {app.companies.join(' â€¢ ')}
                </div>
              </div>

              {/* Got It button */}
              <button
                onClick={() => {
                  playSound('click');
                  const newCompleted = [...completedApps];
                  newCompleted[selectedApp] = true;
                  setCompletedApps(newCompleted);
                  if (selectedApp < realWorldApps.length - 1) {
                    setSelectedApp(selectedApp + 1);
                  }
                }}
                style={{
                  background: completedApps[selectedApp] ? colors.success : app.color,
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '10px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  width: '100%',
                  fontSize: '15px',
                }}
              >
                {completedApps[selectedApp] ? 'âœ“ Got It!' : 'Got It'}
              </button>
            </div>

            {allAppsCompleted && (
              <button
                onClick={() => { playSound('success'); nextPhase(); }}
                style={primaryButtonStyle}
              >
                Take the Knowledge Test
              </button>
            )}
          </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // TEST PHASE
  if (currentPhase === 'test') {
    if (testSubmitted) {
      const passed = testScore >= 7;
      return (
        <div style={{
          minHeight: '100vh',
          background: colors.bgPrimary,
          display: 'flex',
          flexDirection: 'column',
        }}>
          {renderProgressBar()}

          <div style={{
            flex: 1,
            overflowY: 'auto',
            paddingTop: '64px',
            paddingBottom: '100px',
            paddingLeft: '24px',
            paddingRight: '24px',
          }}>

            <div style={{ maxWidth: '600px', margin: '0 auto', textAlign: 'center' }}>
              <div style={{ fontSize: '80px', marginBottom: '24px' }}>
                {passed ? 'ğŸ†' : 'ğŸ“–'}
              </div>
              <h2 style={{ ...typo.h2, color: passed ? colors.success : colors.warning }}>
                {passed ? 'Excellent!' : 'Keep Learning!'}
              </h2>
              <p style={{ ...typo.h1, color: colors.textPrimary, margin: '16px 0' }}>
                {testScore} / 10
              </p>
              <p style={{ ...typo.body, color: colors.textSecondary, marginBottom: '32px' }}>
                {passed
                  ? 'You understand microphone physics and transducers!'
                  : 'Review the concepts and try again.'}
              </p>

              {passed ? (
                <button
                  onClick={() => { playSound('complete'); nextPhase(); }}
                  style={primaryButtonStyle}
                >
                  Complete Lesson
                </button>
              ) : (
                <button
                  onClick={() => {
                    setTestSubmitted(false);
                    setTestAnswers(Array(10).fill(null));
                    setCurrentQuestion(0);
                    setTestScore(0);
                    goToPhase('hook');
                  }}
                  style={primaryButtonStyle}
                >
                  Review and Try Again
                </button>
              )}
            </div>
          </div>
          {renderNavBar()}
        </div>
      );
    }

    const question = testQuestions[currentQuestion];

    return (
      <div style={{
        minHeight: '100vh',
        background: colors.bgPrimary,
        display: 'flex',
        flexDirection: 'column',
      }}>
        {renderProgressBar()}

        <div style={{
          flex: 1,
          overflowY: 'auto',
          paddingTop: '64px',
          paddingBottom: '100px',
          paddingLeft: '24px',
          paddingRight: '24px',
        }}>
          <div style={{ maxWidth: '700px', margin: '0 auto' }}>
          {/* Progress */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '24px',
          }}>
            <span style={{ ...typo.small, color: colors.textSecondary }}>
              Question {currentQuestion + 1} of 10
            </span>
            <div style={{ display: 'flex', gap: '6px' }}>
              {testQuestions.map((_, i) => (
                <div key={i} style={{
                  width: '8px',
                  height: '8px',
                  borderRadius: '50%',
                  background: i === currentQuestion
                    ? colors.accent
                    : testAnswers[i]
                      ? colors.success
                      : colors.border,
                }} />
              ))}
            </div>
          </div>

          {/* Scenario */}
          <div style={{
            background: colors.bgCard,
            borderRadius: '12px',
            padding: '16px',
            marginBottom: '16px',
            borderLeft: `3px solid ${colors.accent}`,
          }}>
            <p style={{ ...typo.small, color: colors.textSecondary, margin: 0 }}>
              {question.scenario}
            </p>
          </div>

          {/* Question */}
          <h3 style={{ ...typo.h3, color: colors.textPrimary, marginBottom: '20px' }}>
            {question.question}
          </h3>

          {/* Options */}
          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '24px' }}>
            {question.options.map(opt => (
              <button
                key={opt.id}
                onClick={() => {
                  playSound('click');
                  const newAnswers = [...testAnswers];
                  newAnswers[currentQuestion] = opt.id;
                  setTestAnswers(newAnswers);
                }}
                style={{
                  background: testAnswers[currentQuestion] === opt.id ? `${colors.accent}22` : colors.bgCard,
                  border: `2px solid ${testAnswers[currentQuestion] === opt.id ? colors.accent : colors.border}`,
                  borderRadius: '10px',
                  padding: '14px 16px',
                  textAlign: 'left',
                  cursor: 'pointer',
                }}
              >
                <span style={{
                  display: 'inline-block',
                  width: '24px',
                  height: '24px',
                  borderRadius: '50%',
                  background: testAnswers[currentQuestion] === opt.id ? colors.accent : colors.bgSecondary,
                  color: testAnswers[currentQuestion] === opt.id ? 'white' : colors.textSecondary,
                  textAlign: 'center',
                  lineHeight: '24px',
                  marginRight: '10px',
                  fontSize: '12px',
                  fontWeight: 700,
                }}>
                  {opt.id.toUpperCase()}
                </span>
                <span style={{ color: colors.textPrimary, ...typo.small }}>
                  {opt.label}
                </span>
              </button>
            ))}
          </div>

          {/* Navigation */}
          <div style={{ display: 'flex', gap: '12px' }}>
            {currentQuestion > 0 && (
              <button
                onClick={() => setCurrentQuestion(currentQuestion - 1)}
                style={{
                  flex: 1,
                  padding: '14px',
                  borderRadius: '10px',
                  border: `1px solid ${colors.border}`,
                  background: 'transparent',
                  color: colors.textSecondary,
                  cursor: 'pointer',
                }}
              >
                Previous
              </button>
            )}
            {currentQuestion < 9 ? (
              <button
                onClick={() => setCurrentQuestion(currentQuestion + 1)}
                style={{
                  flex: 1,
                  padding: '14px',
                  borderRadius: '10px',
                  border: 'none',
                  background: testAnswers[currentQuestion] ? colors.accent : colors.border,
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 600,
                }}
              >
                Next Question
              </button>
            ) : (
              <button
                onClick={() => {
                  const score = testAnswers.reduce((acc, ans, i) => {
                    const correct = testQuestions[i].options.find(o => o.correct)?.id;
                    return acc + (ans === correct ? 1 : 0);
                  }, 0);
                  setTestScore(score);
                  setTestSubmitted(true);
                  if (score >= 7) {
                    playSound('complete');
                    onCorrectAnswer?.();
                  } else {
                    playSound('failure');
                    onIncorrectAnswer?.();
                  }
                }}
                style={{
                  flex: 1,
                  padding: '14px',
                  borderRadius: '10px',
                  border: 'none',
                  background: colors.success,
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 600,
                }}
              >
                Submit Test
              </button>
            )}
          </div>
        </div>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  // MASTERY PHASE
  if (currentPhase === 'mastery') {
    return (
      <div style={{
        minHeight: '100vh',
        background: `linear-gradient(180deg, ${colors.bgPrimary} 0%, ${colors.bgSecondary} 100%)`,
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '24px',
        textAlign: 'center',
      }}>
        {renderProgressBar()}

        <div style={{ fontSize: '100px', marginBottom: '24px' }}>
          ğŸ†
        </div>

        <h1 style={{ ...typo.h1, color: colors.success, marginBottom: '16px' }}>
          Transducer Master!
        </h1>

        <p style={{ ...typo.body, color: colors.textSecondary, maxWidth: '500px', marginBottom: '32px' }}>
          You now understand how sound becomes electricity and vice versa - the foundation of all audio technology.
        </p>

        <div style={{
          background: colors.bgCard,
          borderRadius: '16px',
          padding: '24px',
          marginBottom: '32px',
          maxWidth: '400px',
        }}>
          <h3 style={{ ...typo.h3, color: colors.textPrimary, marginBottom: '16px' }}>
            Key Takeaways:
          </h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', textAlign: 'left' }}>
            {[
              'Microphones convert sound waves to electrical signals (transduction)',
              'Dynamic mics use coils in magnetic fields (electromagnetic induction)',
              'Condenser mics use changing capacitance (need phantom power)',
              'Transduction is often reversible - speakers can be mics!',
              'Piezoelectric and electromagnetic effects work both directions',
            ].map((item, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '10px' }}>
                <span style={{ color: colors.success, marginTop: '2px' }}>âœ“</span>
                <span style={{ ...typo.small, color: colors.textSecondary }}>{item}</span>
              </div>
            ))}
          </div>
        </div>

        <div style={{
          background: colors.bgSecondary,
          borderRadius: '12px',
          padding: '16px',
          marginBottom: '24px',
        }}>
          <p style={{ ...typo.body, color: colors.textSecondary, margin: 0 }}>
            Test Score: <strong style={{ color: colors.success }}>{testScore}/10</strong>
          </p>
        </div>

        <div style={{ display: 'flex', gap: '16px' }}>
          <button
            onClick={() => goToPhase('hook')}
            style={{
              padding: '14px 28px',
              borderRadius: '10px',
              border: `1px solid ${colors.border}`,
              background: 'transparent',
              color: colors.textSecondary,
              cursor: 'pointer',
            }}
          >
            Play Again
          </button>
          <a
            href="/"
            style={{
              ...primaryButtonStyle,
              textDecoration: 'none',
              display: 'inline-block',
              width: 'auto',
            }}
          >
            Return to Dashboard
          </a>
        </div>

        {renderNavBar()}
      </div>
    );
  }

  return null;
}
