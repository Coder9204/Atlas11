
import React, { useMemo, useState, useEffect, useRef } from 'react';
import { evaluate } from 'mathjs';

// Safe formula evaluator that prevents code injection
const createSafeEvaluator = () => {
   // Whitelist of allowed identifiers
   const ALLOWED_FUNCTIONS = new Set([
      'sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'atan2',
      'sqrt', 'pow', 'abs', 'log', 'log10', 'exp',
      'floor', 'ceil', 'round', 'min', 'max',
      'PI', 'E', 'pi', 'e'
   ]);

   // Dangerous patterns to block
   const DANGEROUS_PATTERNS = [
      /\beval\b/i, /\bfunction\b/i, /=>/,
      /\bconstructor\b/i, /\bprototype\b/i, /\b__proto__\b/,
      /\bwindow\b/i, /\bdocument\b/i, /\bfetch\b/i,
      /\bimport\b/i, /\brequire\b/i, /\bprocess\b/i,
      /\bglobal\b/i, /\bthis\b/i, /\bnew\b/i
   ];

   return (formula: string, variables: Record<string, number>, calculations: Record<string, number> = {}): number => {
      if (typeof formula !== 'string') return Number(formula) || 0;

      // Check for dangerous patterns
      for (const pattern of DANGEROUS_PATTERNS) {
         if (pattern.test(formula)) {
            console.warn('Blocked dangerous formula pattern:', formula);
            return 0;
         }
      }

      try {
         // Transform formula to mathjs format
         let safeFormula = formula
            // Replace Math.X with just X (mathjs uses lowercase)
            .replace(/Math\.(sin|cos|tan|asin|acos|atan|atan2|sqrt|pow|abs|log|log10|exp|floor|ceil|round|min|max|PI|E)/gi,
               (_, fn) => fn.toLowerCase())
            // Replace variables.X and calculations.X with actual values
            .replace(/variables\.(\w+)/g, (_, name) => String(variables[name] ?? 0))
            .replace(/calculations\.(\w+)/g, (_, name) => String(calculations[name] ?? 0));

         // Evaluate using mathjs (sandboxed)
         const result = evaluate(safeFormula);
         return typeof result === 'number' ? result : (result === true ? 1 : (result === false ? 0 : Number(result) || 0));
      } catch (error) {
         // Silent fail - return 0 for invalid formulas
         return 0;
      }
   };
};

const safeEvaluate = createSafeEvaluator();

interface DiagramProps {
   type: string;
   data: string | any;
   title: string;
}

// --- DYNAMIC BLUEPRINT ENGINE TYPES ---
interface BlueprintVariable {
   label: string;
   min: number;
   max: number;
   value: number;
   step?: number;
   unit?: string;
}

interface BlueprintElement {
   type: 'rect' | 'circle' | 'line' | 'text' | 'emoji' | 'path';
   id: string;
   attributes: Record<string, string | number>; // Values can be formulas e.g., "variables.x * 2"
   content?: string;
}

interface BlueprintChallenge {
   goal: string; // Formula evaluating to boolean, e.g. "variables.x > 10 && variables.x < 20"
   constraints?: { label: string, condition: string }[]; // Conditions that must be met
   feedback: { success: string, failure: string };
}

interface BlueprintData {
   scenario: string;
   variables: Record<string, BlueprintVariable>;
   calculations?: Record<string, string>;
   elements: BlueprintElement[];
   challenge?: BlueprintChallenge;
   insight: string;
}

const GeneratedDiagram: React.FC<DiagramProps> = ({ type, data, title }) => {
   const parsedData = useMemo(() => {
      console.log("[GeneratedDiagram] Received:", { type, data: typeof data, title });

      if (!data) {
         console.warn("[GeneratedDiagram] No data provided");
         return null;
      }

      try {
         // If data is already an object (not a string), use it directly
         if (typeof data === 'object') {
            console.log("[GeneratedDiagram] Data is already an object:", data);
            return data;
         }

         // Clean up common JSON issues before parsing
         let cleanedData = data
            // Remove trailing commas before } or ]
            .replace(/,\s*([}\]])/g, '$1')
            // Fix unescaped newlines in strings
            .replace(/\n/g, '\\n')
            // Remove any BOM or invisible characters
            .replace(/^\uFEFF/, '')
            .trim();

         // Try to parse JSON string
         const parsed = JSON.parse(cleanedData);
         console.log("[GeneratedDiagram] Parsed data:", parsed);
         return parsed;
      } catch (e) {
         console.error("[GeneratedDiagram] JSON parse error:", e, "Raw data:", data);

         // Try one more time with aggressive cleanup
         try {
            let aggressiveClean = data
               .replace(/,\s*}/g, '}')
               .replace(/,\s*]/g, ']')
               .replace(/[\x00-\x1F\x7F]/g, '') // Remove control characters
               .trim();
            const parsed = JSON.parse(aggressiveClean);
            console.log("[GeneratedDiagram] Parsed with aggressive cleanup:", parsed);
            return parsed;
         } catch (e2) {
            console.error("[GeneratedDiagram] Aggressive parse also failed:", e2);
            return null;
         }
      }
   }, [data]);

   // --- DYNAMIC BLUEPRINT RENDERER ---
   const DynamicBlueprintRenderer = () => {
      const blueprint = parsedData as BlueprintData;

      // Validation: Ensure blueprint has required fields
      if (!blueprint || !blueprint.variables || !blueprint.elements) {
         return (
            <div className="h-full flex flex-col items-center justify-center p-8 bg-amber-50">
               <div className="max-w-md text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-100 flex items-center justify-center">
                     <i className="fa-solid fa-triangle-exclamation text-2xl text-amber-600"></i>
                  </div>
                  <h3 className="text-lg font-bold text-slate-800 mb-2">Blueprint Data Issue</h3>
                  <p className="text-sm text-slate-600 mb-4">The interactive graphic couldn't be rendered due to missing or invalid data.</p>
                  <div className="text-left bg-white p-4 rounded-lg border border-amber-200 text-xs font-mono overflow-auto max-h-48">
                     <p className="text-amber-700 mb-2">Expected: variables, elements, scenario</p>
                     <p className="text-slate-500">Received: {JSON.stringify(blueprint, null, 2).slice(0, 300)}...</p>
                  </div>
               </div>
            </div>
         );
      }

      // Initialize state from blueprint defaults
      const [variables, setVariables] = useState<Record<string, number>>(() => {
         const init: Record<string, number> = {};
         Object.entries(blueprint.variables || {}).forEach(([key, conf]) => {
            init[key] = conf.value;
         });
         return init;
      });

      const [challengeState, setChallengeState] = useState<'idle' | 'success' | 'failure'>('idle');
      const [feedbackMsg, setFeedbackMsg] = useState<string>("");

      // Helper: Safe evaluation of formulas (uses mathjs instead of new Function to prevent code injection)
      const evaluateFormula = (formula: string | number): any => {
         if (typeof formula === 'number') return formula;
         if (!formula || (!formula.includes('variables') && !formula.includes('Math') && !formula.includes('calculations'))) return formula;

         // Calculate derived values first
         const calculatedValues: Record<string, number> = {};
         if (blueprint.calculations) {
            Object.entries(blueprint.calculations).forEach(([key, calcFormula]) => {
               calculatedValues[key] = safeEvaluate(calcFormula as string, variables, {});
            });
         }

         // Evaluate the main formula using the safe evaluator
         return safeEvaluate(formula, variables, calculatedValues);
      };

      // Check Challenge Status
      useEffect(() => {
         if (!blueprint.challenge) return;

         const isGoalMet = evaluateFormula(blueprint.challenge.goal);
         const constraintsMet = blueprint.challenge.constraints ? blueprint.challenge.constraints.every(c => evaluateFormula(c.condition)) : true;

         if (isGoalMet && constraintsMet) {
            setChallengeState('success');
            setFeedbackMsg(blueprint.challenge.feedback.success);
         } else if (!constraintsMet) {
            // Find which constraint failed
            const failed = blueprint.challenge.constraints?.find(c => !evaluateFormula(c.condition));
            setChallengeState('failure');
            setFeedbackMsg(failed ? `Constraint Violated: ${failed.label}` : blueprint.challenge.feedback.failure);
         } else {
            setChallengeState('idle');
            setFeedbackMsg("");
         }
      }, [variables, blueprint.challenge]);

      // Derived calculations for display
      const currentCalculations = useMemo(() => {
         const calc: Record<string, number> = {};
         if (blueprint.calculations) {
            Object.entries(blueprint.calculations).forEach(([key, formula]) => {
               calc[key] = Number(evaluateFormula(formula)); // Re-use eval logic
            });
         }
         return calc;
      }, [variables, blueprint.calculations]);


      return (
         <div className="w-full h-full bg-slate-50 flex flex-col md:flex-row overflow-hidden relative">
            {/* VISUALIZATION CANVAS */}
            <div className="flex-1 relative flex items-center justify-center p-8 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
               <div className="relative z-10 w-full max-w-2xl aspect-[4/3] bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                  <svg viewBox="0 0 800 600" className="w-full h-full">
                     <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                           <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f1f5f9" strokeWidth="1" />
                        </pattern>
                     </defs>
                     <rect width="100%" height="100%" fill="url(#grid)" />

                     {/* Render Dynamic Elements */}
                     {blueprint.elements?.map((el, i) => {
                        // Evaluate all dynamic attributes
                        const attrs: any = {};
                        Object.entries(el.attributes || {}).forEach(([attrKey, attrVal]) => {
                           attrs[attrKey] = evaluateFormula(attrVal);
                        });

                        // React key
                        const key = el.id || i;

                        switch (el.type) {
                           case 'rect':
                              return <rect key={key} {...attrs} />;
                           case 'circle':
                              return <circle key={key} {...attrs} />;
                           case 'line':
                              return <line key={key} {...attrs} strokeLinecap="round" />;
                           case 'text':
                              // Support template syntax: "Thrust: {{calculations.thrust}} N"
                              let textContent = el.content || attrs.text || '';
                              if (typeof textContent === 'string' && textContent.includes('{{')) {
                                 textContent = textContent.replace(/\{\{([^}]+)\}\}/g, (_, expr) => {
                                    const val = evaluateFormula(expr.trim());
                                    return typeof val === 'number' ? val.toFixed(1) : val;
                                 });
                              } else if (typeof textContent === 'string' && (textContent.includes('calculations.') || textContent.includes('variables.'))) {
                                 // If it's just a formula without template
                                 const val = evaluateFormula(textContent);
                                 textContent = typeof val === 'number' ? val.toFixed(1) : val;
                              }
                              return <text key={key} {...attrs} textAnchor="middle" alignmentBaseline="middle">{textContent}</text>;
                           case 'emoji':
                              return (
                                 <text key={key} x={attrs.x} y={attrs.y} fontSize={attrs.fontSize || 40} textAnchor="middle" alignmentBaseline="middle">
                                    {el.content}
                                 </text>
                              );
                           default: return null;
                        }
                     })}
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full md:w-80 bg-white border-l border-slate-100 p-6 flex flex-col gap-6 shadow-[-10px_0_40px_rgba(0,0,0,0.02)] z-20 overflow-y-auto">
               <div className="mb-2">
                  <h3 className="text-xs font-black text-indigo-500 uppercase tracking-widest mb-1">Interactive Lab</h3>
                  <p className="text-lg font-serif font-bold text-slate-800 leading-tight">{blueprint.scenario}</p>
               </div>

               {/* Variable Controls */}
               <div className="space-y-6">
                  {Object.entries(blueprint.variables || {}).map(([key, conf]) => (
                     <div key={key}>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-500 uppercase">{conf.label}</label>
                           <span className="text-xs font-mono font-bold text-indigo-600">
                              {variables[key]} <span className="text-slate-400">{conf.unit}</span>
                           </span>
                        </div>
                        <input
                           type="range"
                           min={conf.min} max={conf.max} step={conf.step || 1}
                           value={variables[key]}
                           onChange={(e) => setVariables(prev => ({ ...prev, [key]: Number(e.target.value) }))}
                           className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                        />
                     </div>
                  ))}
               </div>

               {/* Live Calculations */}
               {Object.keys(currentCalculations).length > 0 && (
                  <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 space-y-2">
                     <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Real-time Metrics</div>
                     {Object.entries(currentCalculations).map(([key, val]) => (
                        <div key={key} className="flex justify-between items-center">
                           <span className="text-xs font-medium text-slate-600 capitalize">{key.replace(/_/g, ' ')}</span>
                           <span className="text-sm font-mono font-bold text-slate-900">{typeof val === 'number' ? val.toFixed(1) : val}</span>
                        </div>
                     ))}
                  </div>
               )}

               <div className="mt-auto pt-6 border-t border-slate-100">
                  {/* Challenge Feedback */}
                  {blueprint.challenge && (
                     <div className={`mb-4 p-3 rounded-xl border ${challengeState === 'success' ? 'bg-green-50 border-green-200 text-green-800' : challengeState === 'failure' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                        <div className="flex items-center gap-2 mb-1">
                           <i className={`fa-solid ${challengeState === 'success' ? 'fa-check-circle' : challengeState === 'failure' ? 'fa-triangle-exclamation' : 'fa-circle-question'}`}></i>
                           <span className="text-xs font-black uppercase tracking-widest">{challengeState === 'success' ? 'Success' : challengeState === 'failure' ? 'Warning' : 'Challenge Active'}</span>
                        </div>
                        <p className="text-xs font-bold leading-tight">{feedbackMsg || "Adjust variables to meet the goal."}</p>
                     </div>
                  )}

                  <div className="flex gap-3">
                     <div className="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0">
                        <i className="fa-solid fa-lightbulb"></i>
                     </div>
                     <p className="text-xs text-slate-600 italic leading-relaxed">
                        {blueprint.insight}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MULTI-STEP EQUATIONS RENDERER ---
   const MultiStepEquationsRenderer = () => {
      const config = parsedData || {
         initialEquation: { left: "2x + 5", right: "13" },
         steps: [
            { type: 'subtract', value: 5, target: '2x + 5', result: '2x' },
            { type: 'divide', value: 2, target: '2x', result: 'x' }
         ],
         goal: "x"
      };

      const [current, setCurrent] = useState(config.initialEquation);
      const [history, setHistory] = useState([{ ...config.initialEquation, op: "Start" }]);
      const [isSolved, setIsSolved] = useState(false);

      const handleStep = (step: any) => {
         if (isSolved) return;

         const newVal = step.type === 'subtract'
            ? (parseInt(current.right) - step.value).toString()
            : (parseInt(current.right) / step.value).toString();

         const nextState = { left: step.result, right: newVal };
         setHistory([...history, { ...nextState, op: `${step.type === 'subtract' ? '-' : '√∑'} ${step.value}` }]);
         setCurrent(nextState);
         if (step.result === config.goal) setIsSolved(true);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl p-8 border border-slate-200">
               <div className="text-center mb-8">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Escape Room: Unlock the Variable</h3>
                  <p className="text-slate-500 italic">Apply operations to both sides to isolate {config.goal}!</p>
               </div>

               <div className="flex items-center justify-center gap-8 mb-12">
                  <div className="p-6 bg-indigo-50 rounded-2xl border-2 border-indigo-200 min-w-[120px] text-center shadow-inner">
                     <span className="text-3xl font-mono font-bold text-indigo-600">{current.left}</span>
                  </div>
                  <div className="text-4xl font-bold text-slate-300">=</div>
                  <div className="p-6 bg-indigo-50 rounded-2xl border-2 border-indigo-200 min-w-[120px] text-center shadow-inner">
                     <span className="text-3xl font-mono font-bold text-indigo-600">{current.right}</span>
                  </div>
               </div>

               <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                  {config.steps.map((s: any, i: number) => (
                     <button
                        key={i}
                        onClick={() => handleStep(s)}
                        disabled={current.left !== s.target || isSolved}
                        className="p-4 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg active:scale-95"
                     >
                        {s.type === 'subtract' ? 'Subtract' : 'Divide'} {s.value} from both sides
                     </button>
                  ))}
               </div>

               <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                  <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Operation History</h4>
                  <div className="space-y-3">
                     {history.map((h, i) => (
                        <div key={i} className="flex justify-between items-center text-sm">
                           <div className="flex items-center gap-3">
                              <span className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold">{i}</span>
                              <span className="text-slate-500 font-medium">{h.op}</span>
                           </div>
                           <span className="font-mono font-bold text-slate-700">{h.left} = {h.right}</span>
                        </div>
                     ))}
                  </div>
               </div>

               {isSolved && (
                  <div className="mt-8 p-6 bg-green-50 border-2 border-green-200 rounded-2xl text-green-800 text-center animate-in fade-in zoom-in duration-500">
                     <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i className="fa-solid fa-unlock text-2xl text-green-600"></i>
                     </div>
                     <h4 className="text-xl font-bold mb-1">Variable Unlocked!</h4>
                     <p className="text-sm opacity-80">{config.goal} = {current.right}</p>
                  </div>
               )}
            </div>
         </div>
      );
   };

   // --- VARIABLES ON BOTH SIDES RENDERER ---
   const VariablesBothSidesRenderer = () => {
      const config = parsedData || {
         initial: { left: ["3x", "5"], right: ["x", "13"] },
         goal: "2x = 8"
      };

      const [state, setState] = useState(config.initial);
      const [isSolved, setIsSolved] = useState(false);

      const moveTerm = (term: string, from: 'left' | 'right') => {
         if (isSolved) return;

         const newState = {
            left: [...state.left],
            right: [...state.right]
         };

         if (term === 'x' && from === 'right') {
            newState.right = state.right.filter(t => t !== 'x');
            newState.left = ["2x", "5"];
            setState(newState);
            if (newState.left.join(" ") === "2x 5" && newState.right.join(" ") === "13") {
               setIsSolved(true);
            }
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200 relative overflow-hidden">
               <div className="absolute top-0 left-0 w-full h-2 bg-indigo-500"></div>

               <div className="text-center mb-12">
                  <h3 className="text-3xl font-serif font-bold text-slate-800 mb-2">Equation Tug-of-War</h3>
                  <p className="text-slate-500 italic">Gather your variables on one side and numbers on the other!</p>
               </div>

               <div className="relative h-48 flex items-center justify-between mb-12 px-12">
                  <div className="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2"></div>

                  <div className="relative z-10 flex gap-3">
                     {state.left.map((t: string, i: number) => (
                        <div key={i} className={`px-6 py-4 rounded-xl shadow-lg border-2 font-mono font-bold text-xl transition-all hover:-translate-y-1 cursor-pointer ${t.includes('x') ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-amber-500 border-amber-300 text-white'}`}>
                           {t}
                        </div>
                     ))}
                  </div>

                  <div className="relative z-20 w-16 h-16 bg-white rounded-full border-4 border-slate-200 flex items-center justify-center shadow-xl">
                     <span className="text-2xl font-black text-slate-300">=</span>
                  </div>

                  <div className="relative z-10 flex gap-3">
                     {state.right.map((t: string, i: number) => (
                        <div key={i} className={`px-6 py-4 rounded-xl shadow-lg border-2 font-mono font-bold text-xl transition-all hover:-translate-y-1 cursor-pointer ${t.includes('x') ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-amber-500 border-amber-300 text-white'}`}>
                           {t}
                        </div>
                     ))}
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-6">
                  <div className="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Strategy: Variables</h4>
                     <button
                        onClick={() => moveTerm('x', 'right')}
                        disabled={!state.right.includes('x')}
                        className="w-full p-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-md active:scale-95 disabled:opacity-30"
                     >
                        Subtract 'x' from both sides
                     </button>
                  </div>
                  <div className="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Strategy: Constants</h4>
                     <button
                        disabled
                        className="w-full p-4 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 transition-all shadow-md active:scale-95 opacity-30"
                     >
                        Subtract '5' from both sides
                     </button>
                  </div>
               </div>

               {isSolved && (
                  <div className="mt-8 p-4 bg-green-50 border border-green-200 rounded-xl text-green-800 text-center animate-bounce">
                     <span className="font-bold">Great job! You gathered the variables. Now solve for x!</span>
                  </div>
               )}
            </div>
         </div>
      );
   };

   // --- LINEAR INEQUALITIES RENDERER ---
   const LinearInequalitiesRenderer = () => {
      const config = parsedData || {
         inequality: "v ‚â§ 65",
         limit: 65,
         variable: "v",
         unit: "mph",
         label: "Speed"
      };

      const [value, setValue] = useState(45);
      const isLegal = value <= config.limit;

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col items-center justify-center p-8 overflow-hidden">
            <div className="max-w-4xl w-full relative h-[400px] bg-slate-800 rounded-3xl border-4 border-slate-700 shadow-2xl overflow-hidden mb-8">
               <div className="absolute bottom-0 w-full h-32 bg-slate-700">
                  <div className="absolute top-1/2 w-full h-2 border-t-4 border-dashed border-slate-500"></div>
               </div>

               <div className="absolute top-12 right-12 w-24 h-32 bg-white rounded-lg border-4 border-slate-900 flex flex-col items-center p-2 shadow-xl">
                  <span className="text-[10px] font-black text-slate-900 uppercase">Speed Limit</span>
                  <span className="text-4xl font-black text-slate-900 mt-2">{config.limit}</span>
               </div>

               <div
                  className="absolute bottom-12 transition-all duration-500 ease-out"
                  style={{ left: `${(value / 120) * 80}%` }}
               >
                  <div className="relative">
                     <span className="text-6xl">üöó</span>
                     <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-full shadow-lg border-2 border-slate-200">
                        <span className="text-sm font-bold text-slate-800">{value} {config.unit}</span>
                     </div>
                  </div>
               </div>

               <div className={`absolute top-12 left-12 px-6 py-3 rounded-2xl border-4 font-black text-2xl uppercase tracking-widest transition-all ${isLegal ? 'bg-green-500/20 border-green-500 text-green-500' : 'bg-red-500/20 border-red-500 text-red-500'}`}>
                  {isLegal ? 'Legal' : 'Illegal'}
               </div>
            </div>

            <div className="max-w-2xl w-full bg-white rounded-2xl p-8 shadow-xl">
               <div className="flex justify-between items-center mb-6">
                  <div>
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Inequality</h4>
                     <span className="text-3xl font-mono font-bold text-indigo-600">{config.inequality}</span>
                  </div>
                  <div className="text-right">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Current {config.label}</h4>
                     <span className={`text-3xl font-mono font-bold ${isLegal ? 'text-green-600' : 'text-red-600'}`}>{value} {config.unit}</span>
                  </div>
               </div>

               <input
                  type="range"
                  min="0" max="120"
                  value={value}
                  onChange={(e) => setValue(parseInt(e.target.value))}
                  className="w-full h-4 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500 mb-4"
               />

               <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                  <span>0 {config.unit}</span>
                  <span>60 {config.unit}</span>
                  <span>120 {config.unit}</span>
               </div>
            </div>
         </div>
      );
   };

   // --- INEQUALITIES NUMBER LINE RENDERER ---
   const InequalitiesNumberLineRenderer = () => {
      const [value, setValue] = useState(0);
      const [isClosed, setIsClosed] = useState(true);
      const [direction, setDirection] = useState<'left' | 'right'>('right');

      const inequality = `x ${direction === 'right' ? (isClosed ? '‚â•' : '>') : (isClosed ? '‚â§' : '<')} ${value}`;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200">
               <div className="text-center mb-12">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Inequality Grapher</h3>
                  <div className="inline-block px-6 py-3 bg-indigo-600 text-white rounded-2xl text-4xl font-mono font-bold shadow-lg">
                     {inequality}
                  </div>
               </div>

               <div className="relative h-32 mb-12">
                  <svg viewBox="0 0 800 100" className="w-full h-full overflow-visible">
                     <line x1="50" y1="50" x2="750" y2="50" stroke="#cbd5e1" strokeWidth="2" />
                     {[-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5].map(num => {
                        const x = 400 + num * 60;
                        return (
                           <g key={num}>
                              <line x1={x} y1="45" x2={x} y2="55" stroke="#94a3b8" strokeWidth="2" />
                              <text x={x} y="75" textAnchor="middle" fontSize="12" fill="#64748b" fontWeight="bold">{num}</text>
                           </g>
                        );
                     })}
                     <line
                        x1={400 + value * 60}
                        y1="50"
                        x2={direction === 'right' ? 750 : 50}
                        y2="50"
                        stroke="#6366f1"
                        strokeWidth="8"
                        strokeOpacity="0.3"
                     />
                     <circle
                        cx={400 + value * 60}
                        cy="50"
                        r="8"
                        fill={isClosed ? "#6366f1" : "white"}
                        stroke="#6366f1"
                        strokeWidth="3"
                     />
                  </svg>
               </div>

               <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">1. Set Value</h4>
                     <input
                        type="range"
                        min="-5" max="5" step="1"
                        value={value}
                        onChange={(e) => setValue(parseInt(e.target.value))}
                        className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                     />
                     <div className="text-center font-bold text-slate-600">{value}</div>
                  </div>
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">2. Circle Type</h4>
                     <div className="flex gap-2">
                        <button
                           onClick={() => setIsClosed(false)}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${!isClosed ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Open
                        </button>
                        <button
                           onClick={() => setIsClosed(true)}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${isClosed ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Closed
                        </button>
                     </div>
                  </div>
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">3. Direction</h4>
                     <div className="flex gap-2">
                        <button
                           onClick={() => setDirection('left')}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${direction === 'left' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Left
                        </button>
                        <button
                           onClick={() => setDirection('right')}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${direction === 'right' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Right
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- INDEPENDENT/DEPENDENT VARIABLES RENDERER ---
   const IndependentDependentVariablesRenderer = () => {
      const [input, setInput] = useState(5);
      const [isProcessing, setIsProcessing] = useState(false);
      const [output, setOutput] = useState(10);

      const process = (val: number) => {
         setIsProcessing(true);
         setInput(val);
         setTimeout(() => {
            setOutput(val * 2);
            setIsProcessing(false);
         }, 800);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200">
               <div className="text-center mb-12">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Cause & Effect Laboratory</h3>
                  <p className="text-slate-500 italic">The Independent variable CAUSES the Dependent variable to change.</p>
               </div>

               <div className="flex items-center justify-between gap-8 mb-12">
                  <div className="flex-1 flex flex-col items-center">
                     <div className="mb-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-xs font-black uppercase tracking-widest">Independent Variable</div>
                     <div className="w-32 h-32 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg relative">
                        <span className="text-4xl font-bold text-white">{input}</span>
                        <div className="absolute -bottom-4 w-8 h-8 bg-indigo-600 rotate-45"></div>
                     </div>
                     <div className="mt-8 w-full">
                        <input
                           type="range"
                           min="1" max="10"
                           value={input}
                           onChange={(e) => process(parseInt(e.target.value))}
                           className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                        />
                     </div>
                  </div>

                  <div className="w-48 h-48 bg-slate-800 rounded-3xl flex flex-col items-center justify-center relative shadow-2xl border-4 border-slate-700">
                     <div className="text-xs font-black text-slate-500 uppercase mb-2">The Rule</div>
                     <div className="text-2xl font-mono font-bold text-white">x √ó 2</div>
                     {isProcessing && (
                        <div className="absolute inset-0 bg-indigo-500/20 animate-pulse rounded-2xl flex items-center justify-center">
                           <i className="fa-solid fa-gear text-4xl text-white animate-spin"></i>
                        </div>
                     )}
                  </div>

                  <div className="flex-1 flex flex-col items-center">
                     <div className="mb-4 px-4 py-2 bg-amber-100 text-amber-700 rounded-full text-xs font-black uppercase tracking-widest">Dependent Variable</div>
                     <div className={`w-32 h-32 bg-amber-500 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-500 ${isProcessing ? 'scale-90 opacity-50' : 'scale-100 opacity-100'}`}>
                        <span className="text-4xl font-bold text-white">{output}</span>
                     </div>
                     <div className="mt-8 text-center text-slate-400 font-medium italic">
                        "I depend on the input!"
                     </div>
                  </div>
               </div>

               <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 flex gap-6 items-center">
                  <div className="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                     <i className="fa-solid fa-flask-vial text-xl"></i>
                  </div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800 mb-1">Laboratory Insight</h4>
                     <p className="text-xs text-slate-600 leading-relaxed">
                        In this experiment, you control the <strong>Input</strong> (Independent). The <strong>Output</strong> (Dependent) changes automatically based on the rule. You can't change the output without changing the input first!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CONCEPT 101: ANGLE TYPES RENDERER ---
   function AngleTypesRenderer() {
      const [angle, setAngle] = useState(45);
      const [showProtractor, setShowProtractor] = useState(true);
      const [showRealWorld, setShowRealWorld] = useState(false);

      const getAngleType = (deg: number) => {
         if (deg === 0) return { label: "ZERO", color: "text-slate-400", desc: "No opening between rays." };
         if (deg < 90) return { label: "ACUTE", color: "text-emerald-500", desc: "Less than 90¬∞, forms a sharp corner." };
         if (deg === 90) return { label: "RIGHT", color: "text-blue-500", desc: "Exactly 90¬∞, forms a perfect 'L' shape." };
         if (deg < 180) return { label: "OBTUSE", color: "text-orange-500", desc: "Greater than 90¬∞ but less than 180¬∞." };
         if (deg === 180) return { label: "STRAIGHT", color: "text-red-500", desc: "Exactly 180¬∞, forms a straight line." };
         return { label: "REFLEX", color: "text-purple-500", desc: "Greater than 180¬∞." };
      };

      const typeInfo = getAngleType(angle);

      const realWorldExamples: Record<string, { img: string, label: string }> = {
         ACUTE: { img: "üçï", label: "Pizza Slice" },
         RIGHT: { img: "üìÑ", label: "Paper Corner" },
         OBTUSE: { img: "ü™ë", label: "Reclining Chair" },
         STRAIGHT: { img: "üìè", label: "Straight Ruler" }
      };

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Angle Architect Studio</h2>
                  <p className="text-slate-500">Designing with Degrees</p>
               </div>
               <div className={`px-4 py-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center min-w-[120px]`}>
                  <span className={`text-2xl font-black ${typeInfo.color}`}>{angle}¬∞</span>
                  <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">{typeInfo.label}</span>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-8 items-center justify-center">
               {/* ANGLE VISUALIZER */}
               <div className="relative w-64 h-64 flex items-center justify-center bg-slate-50 rounded-full border border-slate-100 shadow-inner">
                  {/* Protractor Background */}
                  {showProtractor && (
                     <svg className="absolute inset-0 w-full h-full opacity-20" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="currentColor" strokeWidth="1" strokeDasharray="2 2" />
                        {[...Array(13)].map((_, i) => {
                           const deg = i * 15;
                           const rad = (deg * Math.PI) / 180;
                           const x1 = 100 + Math.cos(rad) * 85;
                           const y1 = 100 - Math.sin(rad) * 85;
                           const x2 = 100 + Math.cos(rad) * 90;
                           const y2 = 100 - Math.sin(rad) * 90;
                           return <line key={deg} x1={x1} y1={y1} x2={x2} y2={y2} stroke="currentColor" strokeWidth="1" />;
                        })}
                     </svg>
                  )}

                  {/* The Angle */}
                  <svg className="w-full h-full overflow-visible" viewBox="0 0 200 200">
                     {/* Base Ray */}
                     <line x1="100" y1="100" x2="190" y2="100" stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />

                     {/* Rotating Ray */}
                     <line
                        x1="100" y1="100"
                        x2={100 + Math.cos((-angle * Math.PI) / 180) * 90}
                        y2={100 + Math.sin((-angle * Math.PI) / 180) * 90}
                        stroke="currentColor"
                        className={typeInfo.color}
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Angle Arc */}
                     <path
                        d={`M 130 100 A 30 30 0 ${angle > 180 ? 1 : 0} 0 ${100 + Math.cos((-angle * Math.PI) / 180) * 30} ${100 + Math.sin((-angle * Math.PI) / 180) * 30}`}
                        fill="none"
                        stroke="currentColor"
                        className={typeInfo.color}
                        strokeWidth="2"
                        opacity="0.3"
                     />

                     {/* Right Angle Square */}
                     {angle === 90 && (
                        <rect x="100" y="70" width="30" height="30" fill="none" stroke="currentColor" className={typeInfo.color} strokeWidth="2" />
                     )}

                     {/* Vertex */}
                     <circle cx="100" cy="100" r="6" fill="#1e293b" />
                  </svg>

                  {/* Drag Handle (Invisible but large) */}
                  <div
                     className="absolute inset-0 cursor-pointer"
                     onMouseDown={(e) => {
                        const rect = e.currentTarget.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const handleMove = (moveEvent: MouseEvent) => {
                           const dx = moveEvent.clientX - centerX;
                           const dy = moveEvent.clientY - centerY;
                           let deg = Math.atan2(-dy, dx) * (180 / Math.PI);
                           if (deg < 0) deg += 360;
                           setAngle(Math.round(deg));
                        };

                        const handleUp = () => {
                           window.removeEventListener('mousemove', handleMove);
                           window.removeEventListener('mouseup', handleUp);
                        };

                        window.addEventListener('mousemove', handleMove);
                        window.addEventListener('mouseup', handleUp);
                     }}
                  ></div>
               </div>

               {/* INFO & CONTROLS */}
               <div className="flex-1 max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                     <h3 className={`text-lg font-bold mb-1 ${typeInfo.color}`}>{typeInfo.label} ANGLE</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">{typeInfo.desc}</p>
                  </div>

                  {showRealWorld && realWorldExamples[typeInfo.label] && (
                     <div className="flex items-center gap-4 p-4 rounded-2xl bg-indigo-50 border border-indigo-100 animate-in fade-in slide-in-from-bottom-2">
                        <div className="text-4xl">{realWorldExamples[typeInfo.label].img}</div>
                        <div>
                           <p className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Real World Example</p>
                           <p className="text-sm font-bold text-indigo-900">{realWorldExamples[typeInfo.label].label}</p>
                        </div>
                     </div>
                  )}

                  <div className="space-y-4">
                     <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Quick Snaps</label>
                        <div className="flex flex-wrap gap-2">
                           {[30, 45, 60, 90, 120, 150, 180].map(val => (
                              <button
                                 key={val}
                                 onClick={() => setAngle(val)}
                                 className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${angle === val ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:border-slate-300'}`}
                              >
                                 {val}¬∞
                              </button>
                           ))}
                        </div>
                     </div>

                     <div className="flex gap-4">
                        <button
                           onClick={() => setShowProtractor(!showProtractor)}
                           className={`flex-1 py-2 rounded-xl text-xs font-bold border transition-all ${showProtractor ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600'}`}
                        >
                           <i className={`fa-solid fa-compass mr-2`}></i>
                           Protractor
                        </button>
                        <button
                           onClick={() => setShowRealWorld(!showRealWorld)}
                           className={`flex-1 py-2 rounded-xl text-xs font-bold border transition-all ${showRealWorld ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600'}`}
                        >
                           <i className={`fa-solid fa-eye mr-2`}></i>
                           Examples
                        </button>
                     </div>
                  </div>
               </div>
            </div>

            <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
               <div className="p-4 rounded-xl bg-emerald-50 border border-emerald-100">
                  <h4 className="text-xs font-bold text-emerald-700 mb-1">Acute</h4>
                  <p className="text-[10px] text-emerald-600">Sharp, less than 90¬∞. Think "a-cute" little angle!</p>
               </div>
               <div className="p-4 rounded-xl bg-blue-50 border border-blue-100">
                  <h4 className="text-xs font-bold text-blue-700 mb-1">Right</h4>
                  <p className="text-[10px] text-blue-600">Exactly 90¬∞. The corner of a paper or a room.</p>
               </div>
               <div className="p-4 rounded-xl bg-orange-50 border border-orange-100">
                  <h4 className="text-xs font-bold text-orange-700 mb-1">Obtuse</h4>
                  <p className="text-[10px] text-orange-600">Wide, between 90¬∞ and 180¬∞. Like a reclining chair.</p>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 102: ANGLE PARTNERS RENDERER ---
   function AnglePartnersRenderer() {
      const [mode, setMode] = useState<'complementary' | 'supplementary'>('complementary');
      const [angleA, setAngleA] = useState(mode === 'complementary' ? 50 : 120);

      const target = mode === 'complementary' ? 90 : 180;
      const angleB = target - angleA;

      const handleModeChange = (newMode: 'complementary' | 'supplementary') => {
         setMode(newMode);
         if (newMode === 'complementary' && angleA >= 90) setAngleA(45);
         if (newMode === 'supplementary' && angleA < 90) setAngleA(120);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Angle Partners</h2>
                  <p className="text-slate-500 italic font-serif">Finding the Perfect Match</p>
               </div>
               <div className="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                  <button
                     onClick={() => handleModeChange('complementary')}
                     className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'complementary' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                     Complementary (90¬∞)
                  </button>
                  <button
                     onClick={() => handleModeChange('supplementary')}
                     className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'supplementary' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                     Supplementary (180¬∞)
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZATION */}
               <div className="relative w-80 h-80 bg-white rounded-3xl border border-slate-200 shadow-xl flex items-center justify-center overflow-hidden">
                  <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: 'radial-gradient(#4f46e5 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>

                  <svg viewBox="0 0 200 200" className="w-64 h-64 overflow-visible">
                     {/* Target Frame */}
                     <path
                        d={mode === 'complementary' ? "M 100 100 L 190 100 A 90 90 0 0 0 100 10" : "M 10 100 L 190 100 A 90 90 0 0 0 10 100"}
                        fill="none"
                        stroke="#e2e8f0"
                        strokeWidth="2"
                        strokeDasharray="4 4"
                     />

                     {/* Angle A */}
                     <path
                        d={`M 100 100 L 190 100 A 90 90 0 0 0 ${100 + Math.cos((-angleA * Math.PI) / 180) * 90} ${100 + Math.sin((-angleA * Math.PI) / 180) * 90} Z`}
                        fill="#4f46e5"
                        fillOpacity="0.1"
                        stroke="#4f46e5"
                        strokeWidth="3"
                        strokeLinejoin="round"
                     />

                     {/* Angle B */}
                     <path
                        d={`M 100 100 L ${100 + Math.cos((-angleA * Math.PI) / 180) * 90} ${100 + Math.sin((-angleA * Math.PI) / 180) * 90} A 90 90 0 0 0 ${100 + Math.cos((-target * Math.PI) / 180) * 90} ${100 + Math.sin((-target * Math.PI) / 180) * 90} Z`}
                        fill="#ec4899"
                        fillOpacity="0.1"
                        stroke="#ec4899"
                        strokeWidth="3"
                        strokeLinejoin="round"
                     />

                     {/* Labels */}
                     <text
                        x={100 + Math.cos((-angleA / 2 * Math.PI) / 180) * 60}
                        y={100 + Math.sin((-angleA / 2 * Math.PI) / 180) * 60}
                        textAnchor="middle"
                        className="fill-indigo-700 font-bold text-[12px]"
                     >
                        {angleA}¬∞
                     </text>
                     <text
                        x={100 + Math.cos((-(angleA + angleB / 2) * Math.PI) / 180) * 60}
                        y={100 + Math.sin((-(angleA + angleB / 2) * Math.PI) / 180) * 60}
                        textAnchor="middle"
                        className="fill-pink-700 font-bold text-[12px]"
                     >
                        {angleB}¬∞
                     </text>

                     {/* Right Angle Symbol for Complementary */}
                     {mode === 'complementary' && (
                        <path d="M 100 80 L 120 80 L 120 100" fill="none" stroke="#94a3b8" strokeWidth="1" />
                     )}
                  </svg>

                  {/* Partnership Meter */}
                  <div className="absolute bottom-6 left-6 right-6 h-2 bg-slate-100 rounded-full overflow-hidden flex">
                     <div style={{ width: `${(angleA / target) * 100}%` }} className="h-full bg-indigo-500 transition-all duration-300"></div>
                     <div style={{ width: `${(angleB / target) * 100}%` }} className="h-full bg-pink-500 transition-all duration-300"></div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-xs space-y-8">
                  <div className="space-y-4">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Adjust Angle A</label>
                        <span className="text-xl font-black text-indigo-600">{angleA}¬∞</span>
                     </div>
                     <input
                        type="range"
                        min="1"
                        max={target - 1}
                        value={angleA}
                        onChange={(e) => setAngleA(parseInt(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                     />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                     <div className="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Angle A</p>
                        <p className="text-2xl font-black text-indigo-600">{angleA}¬∞</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Angle B</p>
                        <p className="text-2xl font-black text-pink-600">{angleB}¬∞</p>
                     </div>
                  </div>

                  <div className="p-5 rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200">
                     <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-bold uppercase tracking-widest opacity-80">Combined Total</span>
                        <span className="text-2xl font-black">{angleA + angleB}¬∞</span>
                     </div>
                     <p className="text-xs opacity-90 leading-relaxed">
                        {mode === 'complementary'
                           ? "These angles are COMPLEMENTARY because they sum to 90¬∞ (a right angle)."
                           : "These angles are SUPPLEMENTARY because they sum to 180¬∞ (a straight line)."}
                     </p>
                  </div>
               </div>
            </div>

            {/* EDUCATIONAL FOOTER */}
            <div className="mt-12 flex flex-col md:flex-row gap-6">
               <div className="flex-1 flex gap-4 items-start p-4 rounded-2xl bg-white border border-slate-100">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 font-bold">C</div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800">Complementary (90¬∞)</h4>
                     <p className="text-xs text-slate-500">Think "C" for "Corner". Two angles that fit perfectly into a 90¬∞ corner.</p>
                  </div>
               </div>
               <div className="flex-1 flex gap-4 items-start p-4 rounded-2xl bg-white border border-slate-100">
                  <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 font-bold">S</div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800">Supplementary (180¬∞)</h4>
                     <p className="text-xs text-slate-500">Think "S" for "Straight". Two angles that form a straight line together.</p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 103: INTERSECTION INVESTIGATION RENDERER ---
   function IntersectionInvestigationRenderer() {
      const [rotation, setRotation] = useState(70);
      const [highlightType, setHighlightType] = useState<'none' | 'vertical' | 'adjacent'>('none');

      const angle1 = rotation;
      const angle2 = 180 - rotation;
      const angle3 = rotation;
      const angle4 = 180 - rotation;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Intersection Investigation</h2>
                  <p className="text-slate-500 italic font-serif">Where Lines Cross</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setHighlightType(highlightType === 'vertical' ? 'none' : 'vertical')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${highlightType === 'vertical' ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     Vertical Pairs
                  </button>
                  <button
                     onClick={() => setHighlightType(highlightType === 'adjacent' ? 'none' : 'adjacent')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${highlightType === 'adjacent' ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     Adjacent Pairs
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZATION */}
               <div className="relative w-80 h-80 bg-slate-50 rounded-full border border-slate-100 shadow-inner flex items-center justify-center">
                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                     {/* Line 1 (Static Horizontal) */}
                     <line x1="10" y1="100" x2="190" y2="100" stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />

                     {/* Line 2 (Rotating) */}
                     <line
                        x1={100 + Math.cos((rotation * Math.PI) / 180) * 90}
                        y1={100 + Math.sin((rotation * Math.PI) / 180) * 90}
                        x2={100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 90}
                        y2={100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 90}
                        stroke="#475569"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Angle Arcs & Labels */}
                     {/* Angle 1 (Top Right) */}
                     <path
                        d={`M 130 100 A 30 30 0 0 0 ${100 + Math.cos((rotation * Math.PI) / 180) * 30} ${100 + Math.sin((rotation * Math.PI) / 180) * 30}`}
                        fill="none" stroke={highlightType === 'vertical' ? '#4f46e5' : (highlightType === 'adjacent' ? '#ec4899' : '#94a3b8')} strokeWidth="3"
                     />
                     <text x="140" y="85" className="text-[12px] font-bold fill-slate-800">{angle1}¬∞</text>

                     {/* Angle 2 (Top Left) */}
                     <path
                        d={`M ${100 + Math.cos((rotation * Math.PI) / 180) * 30} ${100 + Math.sin((rotation * Math.PI) / 180) * 30} A 30 30 0 0 0 70 100`}
                        fill="none" stroke={highlightType === 'adjacent' ? '#ec4899' : '#94a3b8'} strokeWidth="3"
                     />
                     <text x="50" y="85" className="text-[12px] font-bold fill-slate-800">{angle2}¬∞</text>

                     {/* Angle 3 (Bottom Left) */}
                     <path
                        d={`M 70 100 A 30 30 0 0 0 ${100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 30} ${100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 30}`}
                        fill="none" stroke={highlightType === 'vertical' ? '#4f46e5' : (highlightType === 'adjacent' ? '#ec4899' : '#94a3b8')} strokeWidth="3"
                     />
                     <text x="50" y="125" className="text-[12px] font-bold fill-slate-800">{angle3}¬∞</text>

                     {/* Angle 4 (Bottom Right) */}
                     <path
                        d={`M ${100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 30} ${100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 30} A 30 30 0 0 0 130 100`}
                        fill="none" stroke={highlightType === 'adjacent' ? '#ec4899' : '#94a3b8'} strokeWidth="3"
                     />
                     <text x="140" y="125" className="text-[12px] font-bold fill-slate-800">{angle4}¬∞</text>

                     {/* Vertex */}
                     <circle cx="100" cy="100" r="5" fill="#1e293b" />
                  </svg>

                  {/* Rotation Handle */}
                  <div
                     className="absolute inset-0 cursor-pointer"
                     onMouseDown={(e) => {
                        const rect = e.currentTarget.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const handleMove = (moveEvent: MouseEvent) => {
                           const dx = moveEvent.clientX - centerX;
                           const dy = moveEvent.clientY - centerY;
                           let deg = Math.atan2(dy, dx) * (180 / Math.PI);
                           if (deg < 0) deg += 360;
                           // Keep it in a reasonable range to avoid flipping labels too much
                           setRotation(Math.round(deg % 180));
                        };

                        const handleUp = () => {
                           window.removeEventListener('mousemove', handleMove);
                           window.removeEventListener('mouseup', handleUp);
                        };

                        window.addEventListener('mousemove', handleMove);
                        window.addEventListener('mouseup', handleUp);
                     }}
                  ></div>
               </div>

               {/* INSIGHTS PANEL */}
               <div className="w-full max-w-sm space-y-6">
                  {highlightType === 'vertical' ? (
                     <div className="p-5 rounded-2xl bg-indigo-50 border border-indigo-100 animate-in fade-in zoom-in-95">
                        <h3 className="text-lg font-bold text-indigo-900 mb-2">Vertical Angles</h3>
                        <p className="text-sm text-indigo-700 leading-relaxed">
                           Angles opposite each other at an intersection are <strong>Vertical</strong>. They are always <strong>equal</strong>!
                        </p>
                        <div className="mt-4 flex gap-4">
                           <div className="flex-1 bg-white p-3 rounded-xl border border-indigo-200 text-center">
                              <span className="text-xs font-bold text-slate-400 block mb-1">Pair 1</span>
                              <span className="text-lg font-black text-indigo-600">{angle1}¬∞ = {angle3}¬∞</span>
                           </div>
                           <div className="flex-1 bg-white p-3 rounded-xl border border-indigo-200 text-center">
                              <span className="text-xs font-bold text-slate-400 block mb-1">Pair 2</span>
                              <span className="text-lg font-black text-indigo-600">{angle2}¬∞ = {angle4}¬∞</span>
                           </div>
                        </div>
                     </div>
                  ) : highlightType === 'adjacent' ? (
                     <div className="p-5 rounded-2xl bg-pink-50 border border-pink-100 animate-in fade-in zoom-in-95">
                        <h3 className="text-lg font-bold text-pink-900 mb-2">Adjacent Angles</h3>
                        <p className="text-sm text-pink-700 leading-relaxed">
                           Angles next to each other are <strong>Adjacent</strong>. At an intersection, they are <strong>supplementary</strong> (sum to 180¬∞).
                        </p>
                        <div className="mt-4 p-3 bg-white rounded-xl border border-pink-200 text-center">
                           <span className="text-lg font-black text-pink-600">{angle1}¬∞ + {angle2}¬∞ = 180¬∞</span>
                        </div>
                     </div>
                  ) : (
                     <div className="p-5 rounded-2xl bg-slate-50 border border-slate-100">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">Intersection Rules</h3>
                        <p className="text-sm text-slate-600 leading-relaxed">
                           Drag the lines to see how all four angles change together. If you know just <strong>one</strong> angle, you can find all the others!
                        </p>
                     </div>
                  )}

                  <div className="grid grid-cols-2 gap-4">
                     {[1, 2, 3, 4].map(num => (
                        <div key={num} className="p-3 rounded-xl bg-white border border-slate-200 flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400">‚à†{num}</span>
                           <span className="text-sm font-black text-slate-700">{num % 2 === 1 ? angle1 : angle2}¬∞</span>
                        </div>
                     ))}
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 104: AREA SURVEYOR RENDERER ---
   function AreaSurveyorRenderer() {
      const [shape, setShape] = useState<'rectangle' | 'parallelogram' | 'triangle' | 'trapezoid'>('rectangle');
      const [base, setBase] = useState(6);
      const [height, setHeight] = useState(4);
      const [base2, setBase2] = useState(4); // For trapezoid
      const [showDecomposition, setShowDecomposition] = useState(false);

      const calculateArea = () => {
         switch (shape) {
            case 'rectangle': return base * height;
            case 'parallelogram': return base * height;
            case 'triangle': return 0.5 * base * height;
            case 'trapezoid': return 0.5 * (base + base2) * height;
         }
      };

      const area = calculateArea();

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Land Surveyor Studio</h2>
                  <p className="text-slate-500 italic font-serif">Measuring Property & Area</p>
               </div>
               <div className="flex flex-wrap gap-2 max-w-[300px] justify-end">
                  {['rectangle', 'parallelogram', 'triangle', 'trapezoid'].map(s => (
                     <button
                        key={s}
                        onClick={() => { setShape(s as any); setShowDecomposition(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider border transition-all ${shape === s ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* GRID VISUALIZER */}
               <div className="relative w-full max-w-md aspect-square bg-slate-50 rounded-2xl border border-slate-100 shadow-inner flex items-center justify-center p-8">
                  {/* Grid Lines */}
                  <div className="absolute inset-0 opacity-[0.05] pointer-events-none" style={{ backgroundImage: 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>

                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible drop-shadow-lg">
                     {/* The Shape */}
                     {shape === 'rectangle' && (
                        <rect x="40" y={160 - height * 20} width={base * 20} height={height * 20} fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3" />
                     )}
                     {shape === 'parallelogram' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L ${60 + base * 20} ${160 - height * 20} L 60 ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}
                     {shape === 'triangle' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L 40 ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}
                     {shape === 'trapezoid' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L ${40 + (base + base2) / 2 * 20 + base2 / 2 * 20} ${160 - height * 20} L ${40 + (base + base2) / 2 * 20 - base2 / 2 * 20} ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}

                     {/* Dimension Labels */}
                     <text x={40 + base * 10} y="175" textAnchor="middle" className="text-[10px] font-bold fill-slate-500">base: {base}</text>
                     <line x1="30" y1={160} x2="30" y2={160 - height * 20} stroke="#94a3b8" strokeWidth="1" strokeDasharray="2 2" />
                     <text x="25" y={160 - height * 10} textAnchor="middle" transform={`rotate(-90, 25, ${160 - height * 10})`} className="text-[10px] font-bold fill-slate-500">height: {height}</text>

                     {shape === 'trapezoid' && (
                        <text x={40 + base * 10} y={150 - height * 20} textAnchor="middle" className="text-[10px] font-bold fill-slate-500">base2: {base2}</text>
                     )}
                  </svg>

                  {/* Decomposition Overlay */}
                  {showDecomposition && shape === 'parallelogram' && (
                     <div className="absolute inset-0 flex items-center justify-center p-8 pointer-events-none">
                        <div className="w-full h-full relative">
                           <div className="absolute bg-amber-400 opacity-30 animate-pulse" style={{ left: '40px', bottom: '40px', width: '20px', height: `${height * 20}px`, clipPath: 'polygon(0% 100%, 100% 100%, 100% 0%)' }}></div>
                        </div>
                     </div>
                  )}
               </div>

               {/* CONTROLS & FORMULA */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-5 rounded-2xl bg-indigo-600 text-white shadow-xl shadow-indigo-100">
                     <p className="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1">Current Formula</p>
                     <h3 className="text-xl font-black mb-4">
                        {shape === 'rectangle' && "Area = base √ó height"}
                        {shape === 'parallelogram' && "Area = base √ó height"}
                        {shape === 'triangle' && "Area = ¬Ω √ó base √ó height"}
                        {shape === 'trapezoid' && "Area = ¬Ω √ó (b1 + b2) √ó h"}
                     </h3>
                     <div className="flex justify-between items-center pt-4 border-t border-white/20">
                        <span className="text-xs font-bold opacity-80">Total Area</span>
                        <span className="text-3xl font-black">{area} sq units</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Base</label>
                           <span className="text-xs font-bold text-slate-700">{base}</span>
                        </div>
                        <input type="range" min="2" max="8" value={base} onChange={(e) => setBase(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Height</label>
                           <span className="text-xs font-bold text-slate-700">{height}</span>
                        </div>
                        <input type="range" min="2" max="6" value={height} onChange={(e) => setHeight(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                     </div>
                     {shape === 'trapezoid' && (
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Base 2</label>
                              <span className="text-xs font-bold text-slate-700">{base2}</span>
                           </div>
                           <input type="range" min="2" max="8" value={base2} onChange={(e) => setBase2(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                        </div>
                     )}
                  </div>

                  <button
                     onClick={() => setShowDecomposition(!showDecomposition)}
                     className={`w-full py-3 rounded-xl text-xs font-bold border transition-all ${showDecomposition ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     <i className="fa-solid fa-wand-magic-sparkles mr-2"></i>
                     {showDecomposition ? "Hide Derivation" : "Show How Formula Works"}
                  </button>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 105: CIRCLE LAB RENDERER ---
   function CircleLabRenderer() {
      const [radius, setRadius] = useState(5);
      const [isUnwrapped, setIsUnwrapped] = useState(false);
      const [showArea, setShowArea] = useState(false);

      const diameter = radius * 2;
      const circumference = 2 * Math.PI * radius;
      const area = Math.PI * radius * radius;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Circle Lab</h2>
                  <p className="text-slate-500 italic font-serif">Discovering the Magic of Pi (œÄ)</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-slate-800 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Pi (œÄ)</span>
                     <span className="text-xl font-black">‚âà 3.14159</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* CIRCLE VISUALIZER */}
               <div className="relative w-80 h-80 flex items-center justify-center bg-slate-50 rounded-3xl border border-slate-100 shadow-inner">
                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                     {/* The Circle */}
                     <circle
                        cx="100" cy="100" r={radius * 15}
                        fill={showArea ? "#4f46e5" : "none"}
                        fillOpacity="0.1"
                        stroke="#4f46e5"
                        strokeWidth="3"
                        className="transition-all duration-500"
                     />

                     {/* Radius Line */}
                     <line x1="100" y1="100" x2={100 + radius * 15} y2="100" stroke="#1e293b" strokeWidth="2" strokeLinecap="round" />
                     <text x={100 + radius * 7.5} y="90" textAnchor="middle" className="text-[10px] font-bold fill-slate-800">r = {radius}</text>

                     {/* Diameter Line (Dashed) */}
                     <line x1={100 - radius * 15} y1="100" x2="100" y2="100" stroke="#94a3b8" strokeWidth="1" strokeDasharray="2 2" />
                     <text x={100 - radius * 7.5} y="115" textAnchor="middle" className="text-[8px] font-bold fill-slate-400">d = {diameter}</text>

                     {/* Unwrapped Circumference */}
                     {isUnwrapped && (
                        <line
                           x1="10" y1="180"
                           x2={10 + (circumference * 15 / (2 * Math.PI * 5)) * 31.4}
                           y2="180"
                           stroke="#ec4899"
                           strokeWidth="4"
                           strokeLinecap="round"
                           className="animate-in slide-in-from-left duration-1000"
                        />
                     )}
                  </svg>

                  {/* Center Point */}
                  <div className="absolute w-2 h-2 bg-slate-800 rounded-full"></div>
               </div>

               {/* STATS & CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-1 gap-4">
                     <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Circumference (C = 2œÄr)</span>
                           <span className="text-lg font-black text-indigo-900">{circumference.toFixed(2)}</span>
                        </div>
                        <p className="text-[10px] text-indigo-600">The distance all the way around the circle.</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-pink-50 border border-pink-100">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-[10px] font-bold text-pink-400 uppercase tracking-widest">Area (A = œÄr¬≤)</span>
                           <span className="text-lg font-black text-pink-900">{area.toFixed(2)}</span>
                        </div>
                        <p className="text-[10px] text-pink-600">The total space inside the circle.</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Adjust Radius</label>
                           <span className="text-xs font-bold text-slate-700">{radius} units</span>
                        </div>
                        <input type="range" min="1" max="6" step="0.5" value={radius} onChange={(e) => setRadius(parseFloat(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800" />
                     </div>

                     <div className="flex gap-4">
                        <button
                           onClick={() => setIsUnwrapped(!isUnwrapped)}
                           className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${isUnwrapped ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                        >
                           <i className="fa-solid fa-ruler-horizontal mr-2"></i>
                           Unwrap C
                        </button>
                        <button
                           onClick={() => setShowArea(!showArea)}
                           className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${showArea ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                        >
                           <i className="fa-solid fa-fill-drip mr-2"></i>
                           Fill Area
                        </button>
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-slate-800 text-white">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2">
                        <i className="fa-solid fa-lightbulb text-amber-400"></i>
                        Did you know?
                     </h4>
                     <p className="text-[10px] leading-relaxed opacity-80">
                        If you divide any circle's <strong>Circumference</strong> by its <strong>Diameter</strong>, you ALWAYS get <strong>œÄ (3.14...)</strong>. It's a universal constant!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 151: Z-SCORE RENDERER ---
   function ZScoreRenderer() {
      const [mean, setMean] = useState(100);
      const [sd, setSd] = useState(15);
      const [rawValue, setRawValue] = useState(115);

      const zScore = (rawValue - mean) / sd;

      // Normal distribution probability density function
      const pdf = (x: number, m: number, s: number) => {
         return (1 / (s * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - m) / s, 2));
      };

      // Cumulative distribution function approximation (Percentile)
      const getPercentile = (z: number) => {
         const t = 1 / (1 + 0.2316419 * Math.abs(z));
         const d = 0.3989423 * Math.exp(-z * z / 2);
         const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
         return z > 0 ? 1 - p : p;
      };

      const percentile = getPercentile(zScore) * 100;

      // Generate curve points
      const points = [];
      const startX = mean - 4 * sd;
      const endX = mean + 4 * sd;
      const step = (endX - startX) / 100;

      for (let x = startX; x <= endX; x += step) {
         points.push({ x, y: pdf(x, mean, sd) });
      }

      // Scaling for SVG
      const svgWidth = 400;
      const svgHeight = 200;
      const margin = 40;
      const chartWidth = svgWidth - 2 * margin;
      const chartHeight = svgHeight - 2 * margin;

      const scaleX = (val: number) => margin + ((val - startX) / (endX - startX)) * chartWidth;
      const scaleY = (val: number) => (svgHeight - margin) - (val / pdf(mean, mean, sd)) * chartHeight;

      const pathData = `M ${points.map(p => `${scaleX(p.x)},${scaleY(p.y)}`).join(' L ')}`;

      // Shaded area path
      const shadedPoints = points.filter(p => p.x <= rawValue);
      const shadedPath = shadedPoints.length > 0
         ? `M ${scaleX(startX)},${svgHeight - margin} L ${shadedPoints.map(p => `${scaleX(p.x)},${scaleY(p.y)}`).join(' L ')} L ${scaleX(rawValue)},${svgHeight - margin} Z`
         : "";

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Z-Score Explorer</h2>
                  <p className="text-slate-500 italic font-serif">Standard Position Finder</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-indigo-600 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Z-Score</span>
                     <span className="text-xl font-black">{zScore.toFixed(2)}</span>
                  </div>
                  <div className="px-4 py-2 rounded-xl bg-emerald-600 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Percentile</span>
                     <span className="text-xl font-black">{percentile.toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* BELL CURVE VISUALIZER */}
               <div className="relative w-full max-w-lg aspect-video bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-4">
                  <svg viewBox={`0 0 ${svgWidth} ${svgHeight}`} className="w-full h-full overflow-visible">
                     {/* Shaded Area */}
                     <path d={shadedPath} fill="#4f46e5" fillOpacity="0.2" className="transition-all duration-300" />

                     {/* The Curve */}
                     <path d={pathData} fill="none" stroke="#4f46e5" strokeWidth="3" strokeLinecap="round" />

                     {/* X-Axis */}
                     <line x1={margin} y1={svgHeight - margin} x2={svgWidth - margin} y2={svgHeight - margin} stroke="#94a3b8" strokeWidth="1" />

                     {/* Mean Line */}
                     <line
                        x1={scaleX(mean)} y1={scaleY(0)}
                        x2={scaleX(mean)} y2={scaleY(pdf(mean, mean, sd))}
                        stroke="#94a3b8" strokeWidth="1" strokeDasharray="4 4"
                     />
                     <text x={scaleX(mean)} y={svgHeight - margin + 15} textAnchor="middle" className="text-[10px] fill-slate-400 font-bold">Mean (Œº)</text>

                     {/* Raw Value Marker */}
                     <g className="transition-all duration-300">
                        <line
                           x1={scaleX(rawValue)} y1={svgHeight - margin}
                           x2={scaleX(rawValue)} y2={scaleY(pdf(rawValue, mean, sd))}
                           stroke="#1e293b" strokeWidth="2"
                        />
                        <circle cx={scaleX(rawValue)} cy={scaleY(pdf(rawValue, mean, sd))} r="5" fill="#1e293b" />
                        <text x={scaleX(rawValue)} y={scaleY(pdf(rawValue, mean, sd)) - 10} textAnchor="middle" className="text-[10px] font-bold fill-slate-800">x = {rawValue}</text>
                     </g>

                     {/* SD Markers */}
                     {[1, 2, 3].map(i => (
                        <g key={i}>
                           <line x1={scaleX(mean + i * sd)} y1={svgHeight - margin - 5} x2={scaleX(mean + i * sd)} y2={svgHeight - margin + 5} stroke="#cbd5e1" strokeWidth="1" />
                           <line x1={scaleX(mean - i * sd)} y1={svgHeight - margin - 5} x2={scaleX(mean - i * sd)} y2={svgHeight - margin + 5} stroke="#cbd5e1" strokeWidth="1" />
                        </g>
                     ))}
                  </svg>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-2">
                     <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Z-Score Formula</h4>
                     <div className="text-xl font-serif italic text-center py-2">
                        z = (x - Œº) / œÉ
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed">
                        The z-score tells you how many standard deviations a value is from the mean.
                     </p>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Raw Score (x)</label>
                           <span className="text-xs font-bold text-slate-700">{rawValue}</span>
                        </div>
                        <input
                           type="range" min={mean - 4 * sd} max={mean + 4 * sd} step="1"
                           value={rawValue} onChange={(e) => setRawValue(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>

                     <div className="grid grid-cols-2 gap-4">
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mean (Œº)</label>
                              <span className="text-xs font-bold text-slate-700">{mean}</span>
                           </div>
                           <input
                              type="range" min="50" max="150" step="1"
                              value={mean} onChange={(e) => {
                                 const newMean = parseInt(e.target.value);
                                 setMean(newMean);
                                 setRawValue(newMean + (rawValue - mean));
                              }}
                              className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                           />
                        </div>
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Std Dev (œÉ)</label>
                              <span className="text-xs font-bold text-slate-700">{sd}</span>
                           </div>
                           <input
                              type="range" min="5" max="30" step="1"
                              value={sd} onChange={(e) => setSd(parseInt(e.target.value))}
                              className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-lightbulb text-amber-500"></i>
                        Interpretation
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        {zScore === 0 ? (
                           "Your score is exactly at the mean."
                        ) : zScore > 0 ? (
                           `Your score is ${zScore.toFixed(2)} standard deviations ABOVE the mean. You performed better than ${percentile.toFixed(1)}% of the population.`
                        ) : (
                           `Your score is ${Math.abs(zScore).toFixed(2)} standard deviations BELOW the mean. ${percentile.toFixed(1)}% of the population scored lower than you.`
                        )}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 152: CORRELATION COEFFICIENT RENDERER ---
   function CorrelationCoefficientRenderer() {
      const [points, setPoints] = useState([
         { x: 10, y: 20 }, { x: 20, y: 35 }, { x: 30, y: 45 }, { x: 40, y: 60 },
         { x: 50, y: 70 }, { x: 60, y: 85 }, { x: 70, y: 90 }, { x: 80, y: 110 }
      ]);
      const [showLine, setShowLine] = useState(true);

      // Calculate Pearson Correlation Coefficient (r)
      const calculateR = () => {
         const n = points.length;
         if (n < 2) return 0;

         let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
         points.forEach(p => {
            sumX += p.x;
            sumY += p.y;
            sumXY += p.x * p.y;
            sumX2 += p.x * p.x;
            sumY2 += p.y * p.y;
         });

         const numerator = n * sumXY - sumX * sumY;
         const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
         return denominator === 0 ? 0 : numerator / denominator;
      };

      const r = calculateR();

      // Calculate Line of Best Fit (y = mx + b)
      const calculateLine = () => {
         const n = points.length;
         let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
         points.forEach(p => {
            sumX += p.x;
            sumY += p.y;
            sumXY += p.x * p.y;
            sumX2 += p.x * p.x;
         });

         const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
         const b = (sumY - m * sumX) / n;
         return { m, b };
      };

      const { m, b } = calculateLine();

      const presets = {
         perfect_positive: [{ x: 10, y: 10 }, { x: 20, y: 20 }, { x: 30, y: 30 }, { x: 40, y: 40 }, { x: 50, y: 50 }, { x: 60, y: 60 }, { x: 70, y: 70 }, { x: 80, y: 80 }],
         perfect_negative: [{ x: 10, y: 90 }, { x: 20, y: 80 }, { x: 30, y: 70 }, { x: 40, y: 60 }, { x: 50, y: 50 }, { x: 60, y: 40 }, { x: 70, y: 30 }, { x: 80, y: 20 }],
         no_correlation: [{ x: 10, y: 50 }, { x: 20, y: 20 }, { x: 30, y: 80 }, { x: 40, y: 40 }, { x: 50, y: 70 }, { x: 60, y: 10 }, { x: 70, y: 90 }, { x: 80, y: 30 }],
         strong_positive: [{ x: 10, y: 15 }, { x: 20, y: 30 }, { x: 30, y: 25 }, { x: 40, y: 55 }, { x: 50, y: 65 }, { x: 60, y: 60 }, { x: 70, y: 85 }, { x: 80, y: 95 }]
      };

      const handlePointDrag = (index: number, newX: number, newY: number) => {
         const newPoints = [...points];
         newPoints[index] = {
            x: Math.max(0, Math.min(100, newX)),
            y: Math.max(0, Math.min(100, newY))
         };
         setPoints(newPoints);
      };

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Correlation Lab</h2>
                  <p className="text-slate-500 italic font-serif">Relationship Strength Analyzer</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Correlation (r)</span>
                     <div className="flex items-center gap-2">
                        <div className="w-32 h-2 bg-slate-100 rounded-full overflow-hidden relative">
                           <div
                              className={`absolute h-full transition-all duration-500 ${r >= 0 ? 'bg-indigo-500' : 'bg-rose-500'}`}
                              style={{
                                 left: '50%',
                                 width: `${Math.abs(r) * 50}%`,
                                 transform: r < 0 ? 'translateX(-100%)' : 'none'
                              }}
                           />
                           <div className="absolute left-1/2 top-0 w-0.5 h-full bg-slate-300" />
                        </div>
                        <span className={`text-xl font-black min-w-[60px] text-right ${Math.abs(r) > 0.7 ? 'text-indigo-600' : 'text-slate-600'}`}>
                           {r.toFixed(2)}
                        </span>
                     </div>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-8 items-center justify-center">
               {/* SCATTER PLOT */}
               <div className="relative w-full max-w-lg aspect-square bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8">
                  <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                     {/* Grid Lines */}
                     {[0, 25, 50, 75, 100].map(val => (
                        <g key={val}>
                           <line x1={val} y1="0" x2={val} y2="100" stroke="#e2e8f0" strokeWidth="0.5" strokeDasharray="2 2" />
                           <line x1="0" y1={val} x2="100" y2={val} stroke="#e2e8f0" strokeWidth="0.5" strokeDasharray="2 2" />
                        </g>
                     ))}

                     {/* Best Fit Line */}
                     {showLine && (
                        <line
                           x1="0" y1={100 - b}
                           x2="100" y2={100 - (m * 100 + b)}
                           stroke="#4f46e5" strokeWidth="1" strokeDasharray="4 2"
                           className="transition-all duration-300"
                        />
                     )}

                     {/* Data Points */}
                     {points.map((p, i) => (
                        <g key={i} className="cursor-move group">
                           <circle
                              cx={p.x} cy={100 - p.y} r="2.5"
                              fill={Math.abs(r) > 0.7 ? "#4f46e5" : "#64748b"}
                              className="transition-colors duration-300 group-hover:fill-indigo-400"
                           />
                           {/* Invisible larger hit area for dragging */}
                           <circle
                              cx={p.x} cy={100 - p.y} r="6"
                              fill="transparent"
                              onMouseDown={(e) => {
                                 const svg = e.currentTarget.ownerSVGElement!;
                                 const startX = e.clientX;
                                 const startY = e.clientY;
                                 const initialX = p.x;
                                 const initialY = p.y;

                                 const onMouseMove = (moveEvent: MouseEvent) => {
                                    const rect = svg.getBoundingClientRect();
                                    const scale = 100 / rect.width;
                                    const dx = (moveEvent.clientX - startX) * scale;
                                    const dy = (moveEvent.clientY - startY) * scale;
                                    handlePointDrag(i, initialX + dx, initialY - dy);
                                 };

                                 const onMouseUp = () => {
                                    window.removeEventListener('mousemove', onMouseMove);
                                    window.removeEventListener('mouseup', onMouseUp);
                                 };

                                 window.addEventListener('mousemove', onMouseMove);
                                 window.addEventListener('mouseup', onMouseUp);
                              }}
                           />
                        </g>
                     ))}
                  </svg>
                  <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Variable X</div>
                  <div className="absolute left-2 top-1/2 -translate-y-1/2 -rotate-90 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Variable Y</div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-2 gap-3">
                     {Object.entries(presets).map(([key, data]) => (
                        <button
                           key={key}
                           onClick={() => setPoints(data)}
                           className="px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-[10px] font-bold text-slate-600 hover:bg-white hover:border-indigo-300 hover:text-indigo-600 transition-all capitalize"
                        >
                           {key.replace('_', ' ')}
                        </button>
                     ))}
                  </div>

                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-3">
                     <div className="flex justify-between items-center">
                        <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Interpretation</h4>
                        <button
                           onClick={() => setShowLine(!showLine)}
                           className={`px-2 py-1 rounded-lg text-[8px] font-bold uppercase tracking-widest transition-all ${showLine ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-400'}`}
                        >
                           Best Fit Line
                        </button>
                     </div>
                     <p className="text-sm font-bold">
                        {Math.abs(r) < 0.3 ? "Weak" : Math.abs(r) < 0.7 ? "Moderate" : "Strong"} {r >= 0 ? "Positive" : "Negative"} Relationship
                     </p>
                     <p className="text-[10px] opacity-80 leading-relaxed">
                        {Math.abs(r) > 0.9 ? "The points follow a near-perfect line." :
                           Math.abs(r) > 0.5 ? "There is a clear trend, but with some scatter." :
                              "The points are widely scattered with little linear pattern."}
                     </p>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-triangle-exclamation text-amber-500"></i>
                        Critical Insight
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        <strong>Correlation is NOT causation!</strong> Even if r = 1.00, it doesn't mean X <em>causes</em> Y. There could be a third variable at play.
                     </p>
                  </div>

                  <div className="flex flex-col gap-2">
                     <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <span>r¬≤ (Coefficient of Determination)</span>
                        <span className="text-slate-700">{(r * r * 100).toFixed(1)}%</span>
                     </div>
                     <div className="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div
                           className="h-full bg-indigo-400 transition-all duration-500"
                           style={{ width: `${r * r * 100}%` }}
                        />
                     </div>
                     <p className="text-[9px] text-slate-500 italic">
                        {(r * r * 100).toFixed(1)}% of the variation in Y can be explained by X.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 153: COMBINATIONS AND PERMUTATIONS RENDERER ---
   function CombinationsPermutationsRenderer() {
      const [n, setN] = useState(5);
      const [r, setR] = useState(3);
      const [mode, setMode] = useState<'permutation' | 'combination'>('permutation');

      const colors = ["#4f46e5", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899", "#06b6d4"];
      const items = Array.from({ length: n }, (_, i) => ({ id: i, color: colors[i % colors.length] }));

      const factorial = (num: number): number => {
         if (num <= 1) return 1;
         return num * factorial(num - 1);
      };

      const calculateCount = () => {
         if (r > n) return 0;
         const nFact = factorial(n);
         const nMinusRFact = factorial(n - r);

         if (mode === 'permutation') {
            return nFact / nMinusRFact;
         } else {
            return nFact / (factorial(r) * nMinusRFact);
         }
      };

      const count = calculateCount();

      // Generate a few example arrangements/selections
      const generateExamples = () => {
         const examples: number[][] = [];
         const indices = Array.from({ length: n }, (_, i) => i);

         if (mode === 'permutation') {
            // Simple shuffle-based examples for permutations
            for (let i = 0; i < Math.min(count, 6); i++) {
               const shuffled = [...indices].sort(() => Math.random() - 0.5);
               examples.push(shuffled.slice(0, r));
            }
         } else {
            // Simple selection-based examples for combinations
            for (let i = 0; i < Math.min(count, 6); i++) {
               const selection = [...indices].sort(() => Math.random() - 0.5).slice(0, r).sort((a, b) => a - b);
               // Ensure uniqueness for combinations in examples
               if (!examples.some(ex => ex.every((val, idx) => val === selection[idx]))) {
                  examples.push(selection);
               } else {
                  i--; // Try again
               }
            }
         }
         return examples;
      };

      const examples = generateExamples();

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Arrangement Academy</h2>
                  <p className="text-slate-500 italic font-serif">Order Matters?</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setMode('permutation')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'permutation' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Permutation
                  </button>
                  <button
                     onClick={() => setMode('combination')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'combination' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Combination
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-md space-y-8">
                  <div className="p-6 rounded-3xl bg-slate-50 border border-slate-100 shadow-inner">
                     <div className="flex flex-wrap gap-4 justify-center mb-8">
                        {items.map(item => (
                           <div
                              key={item.id}
                              className="w-10 h-10 rounded-full shadow-md flex items-center justify-center text-white font-bold text-xs"
                              style={{ backgroundColor: item.color }}
                           >
                              {String.fromCharCode(65 + item.id)}
                           </div>
                        ))}
                     </div>

                     <div className="text-center space-y-2">
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                           {mode === 'permutation' ? 'Possible Arrangements' : 'Possible Selections'}
                        </p>
                        <p className="text-4xl font-black text-slate-800">{count.toLocaleString()}</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Example {mode === 'permutation' ? 'Orderings' : 'Sets'}</p>
                     <div className="grid grid-cols-2 gap-4">
                        {examples.map((ex, i) => (
                           <div key={i} className="flex gap-2 justify-center p-2 rounded-xl bg-white border border-slate-100 shadow-sm">
                              {ex.map(idx => (
                                 <div
                                    key={idx}
                                    className="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold text-white"
                                    style={{ backgroundColor: items[idx].color }}
                                 >
                                    {String.fromCharCode(65 + idx)}
                                 </div>
                              ))}
                           </div>
                        ))}
                     </div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-4">
                     <div className="flex justify-between items-center">
                        <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Formula</h4>
                        <span className="text-[10px] font-mono opacity-40">n = {n}, r = {r}</span>
                     </div>
                     <div className="text-2xl font-serif italic text-center py-2">
                        {mode === 'permutation' ? (
                           <>P(n,r) = n! / (n-r)!</>
                        ) : (
                           <>C(n,r) = n! / (r! ¬∑ (n-r)!)</>
                        )}
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed text-center">
                        {mode === 'permutation' ? (
                           "Order matters. ABC is different from CBA."
                        ) : (
                           "Order doesn't matter. {A,B,C} is the same as {C,B,A}."
                        )}
                     </p>
                  </div>

                  <div className="space-y-6">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Objects (n)</label>
                           <span className="text-xs font-bold text-slate-700">{n}</span>
                        </div>
                        <input
                           type="range" min="1" max="7" step="1"
                           value={n} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setN(val);
                              if (r > val) setR(val);
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Number to Select (r)</label>
                           <span className="text-xs font-bold text-slate-700">{r}</span>
                        </div>
                        <input
                           type="range" min="1" max={n} step="1"
                           value={r} onChange={(e) => setR(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-briefcase text-indigo-500"></i>
                        Real World Context
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        {mode === 'permutation' ? (
                           "Use Permutations for PIN codes, race results, or passwords where the sequence is critical."
                        ) : (
                           "Use Combinations for lottery numbers, committee members, or pizza toppings where the group is what matters."
                        )}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 154: CONDITIONAL PROBABILITY RENDERER ---
   function ConditionalProbabilityRenderer() {
      const [sizeA, setSizeA] = useState(60);
      const [sizeB, setSizeB] = useState(40);
      const [overlap, setOverlap] = useState(25);
      const [view, setView] = useState<'venn' | 'tree'>('venn');

      const total = 100;
      const pA = sizeA / total;
      const pB = sizeB / total;
      const pAandB = overlap / total;

      const pAgivenB = pB === 0 ? 0 : pAandB / pB;
      const pBgivenA = pA === 0 ? 0 : pAandB / pA;

      const isIndependent = Math.abs(pAgivenB - pA) < 0.01;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Probability Lab</h2>
                  <p className="text-slate-500 italic font-serif">Given That... "The Reduced Sample Space"</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setView('venn')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${view === 'venn' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Venn Diagram
                  </button>
                  <button
                     onClick={() => setView('tree')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${view === 'tree' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Tree Diagram
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-md aspect-square bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8 flex items-center justify-center relative">
                  {view === 'venn' ? (
                     <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                        {/* Sample Space */}
                        <rect x="0" y="0" width="200" height="200" fill="none" stroke="#cbd5e1" strokeWidth="1" strokeDasharray="4 4" />
                        <text x="5" y="15" className="text-[10px] fill-slate-400 font-bold">Sample Space (S)</text>

                        {/* Circle A */}
                        <circle
                           cx={100 - (sizeA / 4)} cy="100" r={sizeA * 0.8}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="2"
                           className="transition-all duration-500"
                        />

                        {/* Circle B */}
                        <circle
                           cx={100 + (sizeB / 4) - (overlap / 2)} cy="100" r={sizeB * 0.8}
                           fill="#ec4899" fillOpacity="0.1" stroke="#ec4899" strokeWidth="2"
                           className="transition-all duration-500"
                        />

                        {/* Labels */}
                        <text x={100 - (sizeA / 2)} y="100" textAnchor="middle" className="text-xs font-bold fill-indigo-600">A</text>
                        <text x={100 + (sizeB / 2)} y="100" textAnchor="middle" className="text-xs font-bold fill-pink-600">B</text>
                        {overlap > 10 && (
                           <text x={100 - (overlap / 4)} y="100" textAnchor="middle" className="text-[10px] font-bold fill-slate-800">A‚à©B</text>
                        )}
                     </svg>
                  ) : (
                     <div className="w-full h-full flex flex-col justify-center gap-8 py-4">
                        {/* Root */}
                        <div className="flex items-center gap-12">
                           <div className="w-2 h-2 bg-slate-400 rounded-full" />
                           <div className="flex flex-col gap-16">
                              {/* Branch B */}
                              <div className="relative">
                                 <div className="absolute -left-12 top-1/2 w-12 h-0.5 bg-slate-200 -rotate-12 origin-left" />
                                 <div className="flex items-center gap-8">
                                    <div className="px-3 py-1 rounded-lg bg-pink-100 text-pink-700 text-[10px] font-bold">Event B (P={pB.toFixed(2)})</div>
                                    <div className="flex flex-col gap-4">
                                       <div className="flex items-center gap-4">
                                          <div className="w-8 h-0.5 bg-slate-200" />
                                          <div className="px-2 py-1 rounded-md bg-indigo-100 text-indigo-700 text-[8px] font-bold">A | B (P={pAgivenB.toFixed(2)})</div>
                                       </div>
                                       <div className="flex items-center gap-4">
                                          <div className="w-8 h-0.5 bg-slate-200" />
                                          <div className="px-2 py-1 rounded-md bg-slate-100 text-slate-500 text-[8px] font-bold">Not A | B (P={(1 - pAgivenB).toFixed(2)})</div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                              {/* Branch Not B */}
                              <div className="relative">
                                 <div className="absolute -left-12 top-1/2 w-12 h-0.5 bg-slate-200 rotate-12 origin-left" />
                                 <div className="px-3 py-1 rounded-lg bg-slate-100 text-slate-500 text-[10px] font-bold">Not B (P={(1 - pB).toFixed(2)})</div>
                              </div>
                           </div>
                        </div>
                     </div>
                  )}
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                     <div className="p-4 rounded-2xl bg-indigo-600 text-white text-center">
                        <span className="text-[10px] font-bold opacity-60 uppercase tracking-widest">P(A | B)</span>
                        <p className="text-2xl font-black">{pAgivenB.toFixed(3)}</p>
                        <p className="text-[8px] opacity-80 mt-1">Prob of A, GIVEN B</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-pink-600 text-white text-center">
                        <span className="text-[10px] font-bold opacity-60 uppercase tracking-widest">P(B | A)</span>
                        <p className="text-2xl font-black">{pBgivenA.toFixed(3)}</p>
                        <p className="text-[8px] opacity-80 mt-1">Prob of B, GIVEN A</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Size of Event A</label>
                           <span className="text-xs font-bold text-slate-700">{sizeA}%</span>
                        </div>
                        <input
                           type="range" min="10" max="80" step="1"
                           value={sizeA} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setSizeA(val);
                              if (overlap > Math.min(val, sizeB)) setOverlap(Math.min(val, sizeB));
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                        />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Size of Event B</label>
                           <span className="text-xs font-bold text-slate-700">{sizeB}%</span>
                        </div>
                        <input
                           type="range" min="10" max="80" step="1"
                           value={sizeB} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setSizeB(val);
                              if (overlap > Math.min(sizeA, val)) setOverlap(Math.min(sizeA, val));
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600"
                        />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Overlap (A ‚à© B)</label>
                           <span className="text-xs font-bold text-slate-700">{overlap}%</span>
                        </div>
                        <input
                           type="range" min="0" max={Math.min(sizeA, sizeB)} step="1"
                           value={overlap} onChange={(e) => setOverlap(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className={`p-4 rounded-2xl border transition-all ${isIndependent ? 'bg-emerald-50 border-emerald-100 text-emerald-800' : 'bg-amber-50 border-amber-100 text-amber-800'}`}>
                     <h4 className="text-xs font-bold mb-1 flex items-center gap-2">
                        <i className={`fa-solid ${isIndependent ? 'fa-check-circle' : 'fa-circle-nodes'}`}></i>
                        {isIndependent ? 'Independent Events' : 'Dependent Events'}
                     </h4>
                     <p className="text-[10px] leading-relaxed opacity-90">
                        {isIndependent
                           ? "Knowing B occurred does NOT change the probability of A. P(A|B) = P(A)."
                           : `Knowing B occurred changes the probability of A from ${pA.toFixed(2)} to ${pAgivenB.toFixed(2)}.`}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 155: MARGIN OF ERROR RENDERER ---
   function MarginOfErrorRenderer() {
      const [n, setN] = useState(1000);
      const [confidence, setConfidence] = useState(0.95);
      const [p, setP] = useState(0.52); // Point estimate (e.g., 52% support)

      const zScores: Record<number, number> = { 0.90: 1.645, 0.95: 1.96, 0.99: 2.576 };
      const z = zScores[confidence];

      const moe = z * Math.sqrt((p * (1 - p)) / n);
      const lowerBound = p - moe;
      const upperBound = p + moe;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Poll Predictor</h2>
                  <p className="text-slate-500 italic font-serif">Understanding the "Plus or Minus"</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-slate-800 text-white flex flex-col items-center min-w-[120px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Margin of Error</span>
                     <span className="text-xl font-black">¬±{(moe * 100).toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-lg space-y-12">
                  <div className="relative h-40 bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8 flex items-center">
                     <svg viewBox="0 0 400 100" className="w-full overflow-visible">
                        {/* Scale */}
                        <line x1="0" y1="80" x2="400" y2="80" stroke="#cbd5e1" strokeWidth="1" />
                        {[0, 0.25, 0.5, 0.75, 1].map(val => (
                           <g key={val}>
                              <line x1={val * 400} y1="75" x2={val * 400} y2="85" stroke="#cbd5e1" strokeWidth="1" />
                              <text x={val * 400} y="95" textAnchor="middle" className="text-[10px] fill-slate-400 font-bold">{val * 100}%</text>
                           </g>
                        ))}

                        {/* Error Bar */}
                        <line
                           x1={lowerBound * 400} y1="40"
                           x2={upperBound * 400} y2="40"
                           stroke="#4f46e5" strokeWidth="4" strokeLinecap="round"
                           className="transition-all duration-500"
                        />
                        <line x1={lowerBound * 400} y1="30" x2={lowerBound * 400} y2="50" stroke="#4f46e5" strokeWidth="2" className="transition-all duration-500" />
                        <line x1={upperBound * 400} y1="30" x2={upperBound * 400} y2="50" stroke="#4f46e5" strokeWidth="2" className="transition-all duration-500" />

                        {/* Point Estimate */}
                        <circle
                           cx={p * 400} cy="40" r="6"
                           fill="#1e293b"
                           className="transition-all duration-500"
                        />
                        <text x={p * 400} y="25" textAnchor="middle" className="text-xs font-bold fill-slate-800">{(p * 100).toFixed(1)}%</text>
                     </svg>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                     <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100 text-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Lower Bound</span>
                        <p className="text-lg font-black text-slate-700">{(lowerBound * 100).toFixed(1)}%</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100 text-center">
                        <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Confidence</span>
                        <p className="text-lg font-black text-indigo-700">{(confidence * 100).toFixed(0)}%</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100 text-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Upper Bound</span>
                        <p className="text-lg font-black text-slate-700">{(upperBound * 100).toFixed(1)}%</p>
                     </div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-4">
                     <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">The Math</h4>
                     <div className="text-lg font-serif italic text-center py-2">
                        MoE = z * ‚àö[p(1-p) / n]
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed text-center">
                        The Margin of Error tells you how much the poll results might differ from the real world.
                     </p>
                  </div>

                  <div className="space-y-6">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sample Size (n)</label>
                           <span className="text-xs font-bold text-slate-700">{n.toLocaleString()} people</span>
                        </div>
                        <input
                           type="range" min="100" max="5000" step="100"
                           value={n} onChange={(e) => setN(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                        <p className="text-[9px] text-slate-400 mt-1 italic">Larger sample = smaller error.</p>
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Confidence Level</label>
                        </div>
                        <div className="flex gap-2">
                           {[0.90, 0.95, 0.99].map(level => (
                              <button
                                 key={level}
                                 onClick={() => setConfidence(level)}
                                 className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${confidence === level ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                              >
                                 {level * 100}%
                              </button>
                           ))}
                        </div>
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Poll Result (p)</label>
                           <span className="text-xs font-bold text-slate-700">{(p * 100).toFixed(0)}%</span>
                        </div>
                        <input
                           type="range" min="0.1" max="0.9" step="0.01"
                           value={p} onChange={(e) => setP(parseFloat(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-amber-50 border border-amber-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-amber-900">
                        <i className="fa-solid fa-circle-info text-amber-500"></i>
                        Statistical Significance
                     </h4>
                     <p className="text-[10px] leading-relaxed text-amber-800">
                        If two candidates are within each other's Margin of Error, the race is considered a <strong>"Statistical Dead Heat"</strong> or "Too Close to Call."
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- ENHANCED ROCKET ENGINE RENDERER ---
   const RocketEngineRenderer = () => {
      const [throttle, setThrottle] = useState(60);
      const [mixtureRatio, setMixtureRatio] = useState(2.5); // O/F Ratio
      const [isFiring, setIsFiring] = useState(false);
      const [burnTime, setBurnTime] = useState(0);
      const [challengeComplete, setChallengeComplete] = useState(false);

      // Physics Calculations
      const idealRatio = 2.56; // Optimal O/F for LOX/RP-1
      const ratioEfficiency = Math.max(0, 1 - Math.abs(mixtureRatio - idealRatio) * 0.4);
      const thrust = Math.floor(throttle * 9.5 * ratioEfficiency);
      const chamberTemp = Math.floor(2800 + (throttle * 6) - (Math.abs(mixtureRatio - idealRatio) * 600));
      const chamberPressure = Math.floor(throttle * 2.8);
      const exhaustVelocity = Math.floor(2800 + ratioEfficiency * 500);
      const specificImpulse = Math.floor(exhaustVelocity / 9.8);
      const fuelFlow = (throttle / 100) * 55;
      const oxidizerFlow = fuelFlow * mixtureRatio;
      const totalMassFlow = fuelFlow + oxidizerFlow;

      // Status indicators
      const isRich = mixtureRatio < idealRatio - 0.4;
      const isLean = mixtureRatio > idealRatio + 0.4;
      const isOverheat = chamberTemp > 3400;
      const isUnderPressure = chamberPressure < 100 && isFiring;
      const efficiencyPercent = Math.round(ratioEfficiency * 100);

      // Challenge: Achieve 800+ kN thrust with stable temp
      const goalMet = thrust >= 800 && !isOverheat && isFiring;

      // Burn timer
      React.useEffect(() => {
         let interval: NodeJS.Timeout;
         if (isFiring) {
            interval = setInterval(() => {
               setBurnTime(prev => prev + 0.1);
               if (goalMet && !challengeComplete) {
                  setChallengeComplete(true);
               }
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isFiring, goalMet, challengeComplete]);

      // Flame animation height
      const flameHeight = isFiring ? Math.min(150, thrust / 5) : 0;
      const flameOpacity = isFiring ? Math.min(1, throttle / 80) : 0;

      return (
         <div className="w-full h-full bg-slate-900 text-slate-100 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 relative flex items-center justify-center p-4 overflow-hidden">
               {/* Grid background */}
               <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:30px_30px]"></div>

               {/* Engine Schematic */}
               <div className="relative z-10 w-full max-w-md">
                  <svg viewBox="0 0 400 650" className="w-full h-auto">
                     <defs>
                        <linearGradient id="loxGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#3b82f6" />
                           <stop offset="100%" stopColor="#1e40af" />
                        </linearGradient>
                        <linearGradient id="rp1Gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#f97316" />
                           <stop offset="100%" stopColor="#c2410c" />
                        </linearGradient>
                        <linearGradient id="chamberGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#334155" />
                           <stop offset="100%" stopColor="#1e293b" />
                        </linearGradient>
                        <linearGradient id="flameGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#fbbf24" />
                           <stop offset="30%" stopColor="#f97316" />
                           <stop offset="100%" stopColor="#ef4444" />
                        </linearGradient>
                        <filter id="glow">
                           <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                           <feMerge>
                              <feMergeNode in="coloredBlur" />
                              <feMergeNode in="SourceGraphic" />
                           </feMerge>
                        </filter>
                     </defs>

                     {/* LOX Tank */}
                     <g>
                        <rect x="80" y="30" width="100" height="120" rx="10" fill="url(#loxGradient)" stroke="#60a5fa" strokeWidth="2" />
                        <text x="130" y="75" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">LIQUID</text>
                        <text x="130" y="90" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">OXYGEN</text>
                        <text x="130" y="115" textAnchor="middle" fill="#93c5fd" fontSize="10">-183¬∞C</text>
                        <text x="130" y="135" textAnchor="middle" fill="#93c5fd" fontSize="9">{oxidizerFlow.toFixed(1)} kg/s</text>
                     </g>

                     {/* RP-1 Tank */}
                     <g>
                        <rect x="220" y="30" width="100" height="120" rx="10" fill="url(#rp1Gradient)" stroke="#fb923c" strokeWidth="2" />
                        <text x="270" y="75" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">RP-1</text>
                        <text x="270" y="90" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">KEROSENE</text>
                        <text x="270" y="115" textAnchor="middle" fill="#fed7aa" fontSize="10">20¬∞C</text>
                        <text x="270" y="135" textAnchor="middle" fill="#fed7aa" fontSize="9">{fuelFlow.toFixed(1)} kg/s</text>
                     </g>

                     {/* Fuel Lines */}
                     <path d="M130 150 L130 200 L175 230" fill="none" stroke="#60a5fa" strokeWidth="6" strokeLinecap="round" />
                     <path d="M270 150 L270 200 L225 230" fill="none" stroke="#fb923c" strokeWidth="6" strokeLinecap="round" />

                     {/* Flow indicators when firing */}
                     {isFiring && (
                        <>
                           <circle r="4" fill="#93c5fd">
                              <animateMotion dur="0.5s" repeatCount="indefinite" path="M130 150 L130 200 L175 230" />
                           </circle>
                           <circle r="4" fill="#fdba74">
                              <animateMotion dur="0.5s" repeatCount="indefinite" path="M270 150 L270 200 L225 230" />
                           </circle>
                        </>
                     )}

                     {/* Turbopump */}
                     <g>
                        <circle cx="200" cy="250" r="35" fill="#475569" stroke="#94a3b8" strokeWidth="3" />
                        <text x="200" y="245" textAnchor="middle" fill="white" fontSize="8" fontWeight="bold">TURBO</text>
                        <text x="200" y="258" textAnchor="middle" fill="white" fontSize="8" fontWeight="bold">PUMP</text>
                        {isFiring && (
                           <g transform="translate(200, 250)">
                              <path d="M-12,-12 L12,12 M-12,12 L12,-12 M0,-15 L0,15 M-15,0 L15,0" stroke="#94a3b8" strokeWidth="2">
                                 <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="0.3s" repeatCount="indefinite" />
                              </path>
                           </g>
                        )}
                     </g>

                     {/* Injector Plate */}
                     <rect x="160" y="295" width="80" height="15" rx="3" fill="#64748b" stroke="#94a3b8" strokeWidth="2" />
                     <text x="200" y="290" textAnchor="middle" fill="#94a3b8" fontSize="8">INJECTOR</text>

                     {/* Combustion Chamber */}
                     <g>
                        <path d="M160 310 Q140 370 160 410 L240 410 Q260 370 240 310 Z"
                           fill="url(#chamberGradient)"
                           stroke={isOverheat ? "#ef4444" : "#94a3b8"}
                           strokeWidth="3" />
                        {isFiring && (
                           <ellipse cx="200" cy="360" rx="30" ry="20" fill="#fbbf24" opacity="0.6">
                              <animate attributeName="opacity" values="0.4;0.8;0.4" dur="0.2s" repeatCount="indefinite" />
                           </ellipse>
                        )}
                     </g>

                     {/* Chamber Labels */}
                     <g>
                        <text x="290" y="330" fill="#94a3b8" fontSize="9">Chamber</text>
                        <text x="290" y="345" fill={chamberTemp > 3200 ? "#f87171" : "#22c55e"} fontSize="11" fontWeight="bold">{isFiring ? chamberTemp : 20}¬∞C</text>
                        <text x="290" y="365" fill="#94a3b8" fontSize="9">Pressure</text>
                        <text x="290" y="380" fill="#22c55e" fontSize="11" fontWeight="bold">{isFiring ? chamberPressure : 0} bar</text>
                     </g>

                     {/* Nozzle */}
                     <path d="M160 410 L120 530 L280 530 L240 410" fill="#1e293b" stroke="#94a3b8" strokeWidth="3" />
                     <text x="200" y="480" textAnchor="middle" fill="#64748b" fontSize="10">NOZZLE</text>

                     {/* Exhaust Plume */}
                     {isFiring && (
                        <g filter="url(#glow)">
                           <path
                              d={`M130 530 Q${200 + Math.sin(burnTime * 10) * 20} ${530 + flameHeight / 2} ${200} ${530 + flameHeight} Q${200 - Math.sin(burnTime * 10) * 20} ${530 + flameHeight / 2} 270 530 Z`}
                              fill="url(#flameGradient)"
                              opacity={flameOpacity}
                           >
                              <animate attributeName="d"
                                 values={`M130 530 Q180 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q220 ${530 + flameHeight / 2} 270 530 Z;M130 530 Q220 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q180 ${530 + flameHeight / 2} 270 530 Z;M130 530 Q180 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q220 ${530 + flameHeight / 2} 270 530 Z`}
                                 dur="0.15s"
                                 repeatCount="indefinite" />
                           </path>
                           <ellipse cx="200" cy="535" rx="50" ry="10" fill="#fef3c7" opacity="0.7" />
                        </g>
                     )}

                     {/* Thrust Vector */}
                     {isFiring && (
                        <g>
                           <text x="200" y={545 + flameHeight + 20} textAnchor="middle" fill="#fbbf24" fontSize="14" fontWeight="bold">
                              {thrust} kN
                           </text>
                        </g>
                     )}
                  </svg>

                  {/* Warning Overlays */}
                  {isOverheat && isFiring && (
                     <div className="absolute top-1/3 left-1/2 -translate-x-1/2 bg-red-600/95 text-white px-6 py-3 rounded-xl font-bold animate-pulse shadow-2xl border-2 border-red-400 z-20">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">üî•</span>
                           <div>
                              <div className="text-sm font-black uppercase">OVERHEAT WARNING</div>
                              <div className="text-xs opacity-80">Reduce throttle or adjust O/F ratio</div>
                           </div>
                        </div>
                     </div>
                  )}

                  {challengeComplete && (
                     <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-green-600/95 text-white px-6 py-3 rounded-xl font-bold shadow-2xl border-2 border-green-400 z-20">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">üéâ</span>
                           <div>
                              <div className="text-sm font-black uppercase">CHALLENGE COMPLETE!</div>
                              <div className="text-xs opacity-80">Achieved 800+ kN stable thrust</div>
                           </div>
                        </div>
                     </div>
                  )}
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-slate-800 p-6 border-l border-slate-700 flex flex-col gap-5 overflow-y-auto">
               {/* Header */}
               <div className="flex items-center justify-between border-b border-slate-700 pb-4">
                  <div className="flex items-center gap-3">
                     <div className={`w-3 h-3 rounded-full ${isFiring ? 'bg-green-500 animate-pulse shadow-lg shadow-green-500/50' : 'bg-slate-500'}`}></div>
                     <h2 className="text-sm font-black uppercase tracking-widest text-slate-300">Engine Control</h2>
                  </div>
                  {isFiring && (
                     <div className="text-xs font-mono text-slate-400">
                        T+{burnTime.toFixed(1)}s
                     </div>
                  )}
               </div>

               {/* Challenge Goal */}
               <div className={`p-3 rounded-xl border ${goalMet ? 'bg-green-900/30 border-green-600' : 'bg-slate-700/30 border-slate-600'}`}>
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-1">üéØ Challenge</div>
                  <div className="text-sm font-bold text-white">Achieve 800+ kN thrust without overheating</div>
                  <div className={`text-xs mt-1 ${goalMet ? 'text-green-400' : 'text-slate-400'}`}>
                     {goalMet ? '‚úì Goal achieved!' : `Current: ${thrust} kN`}
                  </div>
               </div>

               {/* Throttle Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-blue-300 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-gauge-high"></i> Throttle
                     </label>
                     <span className="text-sm font-mono font-bold text-white">{throttle}%</span>
                  </div>
                  <input
                     type="range" min="0" max="110" value={throttle}
                     onChange={(e) => setThrottle(Number(e.target.value))}
                     className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[9px] text-slate-500 mt-1">
                     <span>IDLE</span>
                     <span>MAX</span>
                     <span className="text-amber-400">OVERDRIVE</span>
                  </div>
               </div>

               {/* Mixture Ratio Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-orange-300 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-droplet"></i> O/F Ratio
                     </label>
                     <span className={`text-sm font-mono font-bold ${isRich ? 'text-blue-400' : isLean ? 'text-orange-400' : 'text-green-400'}`}>
                        {mixtureRatio.toFixed(2)} {isRich ? '(Rich)' : isLean ? '(Lean)' : '(Optimal)'}
                     </span>
                  </div>
                  <input
                     type="range" min="1.5" max="3.5" step="0.05" value={mixtureRatio}
                     onChange={(e) => setMixtureRatio(Number(e.target.value))}
                     className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-orange-500"
                  />
                  <div className="flex justify-between text-[9px] mt-1">
                     <span className="text-blue-400">Fuel Rich</span>
                     <span className="text-green-400">‚Üì Optimal: 2.56</span>
                     <span className="text-orange-400">Oxidizer Rich</span>
                  </div>
               </div>

               {/* Metrics Grid */}
               <div className="grid grid-cols-2 gap-3">
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Thrust</div>
                     <div className="text-2xl font-mono font-bold text-white">{isFiring ? thrust : 0} <span className="text-sm">kN</span></div>
                  </div>
                  <div className={`p-3 rounded-xl border ${isOverheat ? 'bg-red-900/30 border-red-600' : 'bg-slate-700/50 border-slate-600'}`}>
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Chamber Temp</div>
                     <div className={`text-2xl font-mono font-bold ${isOverheat ? 'text-red-400' : 'text-white'}`}>
                        {isFiring ? chamberTemp : 20} <span className="text-sm">¬∞C</span>
                     </div>
                  </div>
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Specific Impulse</div>
                     <div className="text-xl font-mono font-bold text-white">{isFiring ? specificImpulse : 0} <span className="text-sm">s</span></div>
                  </div>
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Efficiency</div>
                     <div className={`text-xl font-mono font-bold ${efficiencyPercent > 90 ? 'text-green-400' : efficiencyPercent > 70 ? 'text-amber-400' : 'text-red-400'}`}>
                        {efficiencyPercent}%
                     </div>
                  </div>
               </div>

               {/* Mass Flow Display */}
               <div className="bg-slate-700/30 p-3 rounded-xl border border-slate-600">
                  <div className="text-[9px] font-black uppercase text-slate-400 mb-2">Mass Flow Rate</div>
                  <div className="flex justify-between items-center text-sm">
                     <span className="text-blue-300">LOX: {oxidizerFlow.toFixed(1)} kg/s</span>
                     <span className="text-slate-400">|</span>
                     <span className="text-orange-300">RP-1: {fuelFlow.toFixed(1)} kg/s</span>
                  </div>
                  <div className="mt-1 text-xs text-slate-400">
                     Total: {totalMassFlow.toFixed(1)} kg/s
                  </div>
               </div>

               {/* Ignition Button */}
               <button
                  onClick={() => {
                     setIsFiring(!isFiring);
                     if (!isFiring) setBurnTime(0);
                  }}
                  className={`w-full py-4 rounded-xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all ${isFiring
                     ? 'bg-gradient-to-r from-red-600 to-red-700 text-white hover:from-red-700 hover:to-red-800'
                     : 'bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800'
                     }`}
               >
                  {isFiring ? 'üõë ENGINE CUTOFF' : 'üî• IGNITE ENGINE'}
               </button>

               {/* Educational Insight */}
               <div className="flex gap-3 p-3 bg-slate-700/30 rounded-xl border border-slate-600">
                  <div className="w-8 h-8 rounded-full bg-amber-500/20 text-amber-400 flex items-center justify-center shrink-0">
                     <i className="fa-solid fa-lightbulb"></i>
                  </div>
                  <p className="text-xs text-slate-300 leading-relaxed">
                     <strong>Insight:</strong> The O/F ratio controls the balance between efficiency and cooling.
                     Too lean (high O/F) burns hotter but more efficiently. Too rich provides cooling but wastes fuel.
                     Real Merlin engines use O/F ‚âà 2.56 for optimal performance.
                  </p>
               </div>
            </div>
         </div>
      );
   };

   // --- COMPOUND INTEREST RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Time > Amount due to exponential growth
   // Stage 2: Primary = starting age, Secondary = contribution, rate
   // Stage 3: Growth curve with contribution band, milestone markers
   // Stage 4: FV = PMT √ó (((1 + r)^t - 1) / r), curve reshapes at 60fps
   // Stage 5: State ‚Üí Derived ‚Üí Visual flow
   // Stage 6: Challenge = "Reach $1M"
   const CompoundInterestRenderer = () => {
      const [startAge, setStartAge] = useState(30);
      const [monthlyContribution, setMonthlyContribution] = useState(500);
      const [annualReturn, setAnnualReturn] = useState(0.07);
      const [showComparison, setShowComparison] = useState(false);
      const [comparisonAge, setComparisonAge] = useState(40);
      const [challengeMode, setChallengeMode] = useState(false);
      const retirementAge = 65;

      // Derived calculations
      const yearsInvesting = retirementAge - startAge;
      const monthsInvesting = yearsInvesting * 12;
      const monthlyRate = annualReturn / 12;

      // Future Value with regular contributions: FV = PMT √ó (((1 + r)^n - 1) / r)
      const calculateFV = (months: number, contribution: number, rate: number) => {
         if (rate === 0) return contribution * months;
         return contribution * ((Math.pow(1 + rate, months) - 1) / rate);
      };

      const finalBalance = calculateFV(monthsInvesting, monthlyContribution, monthlyRate);
      const totalContributed = monthlyContribution * monthsInvesting;
      const interestEarned = finalBalance - totalContributed;
      const interestPercentage = finalBalance > 0 ? (interestEarned / finalBalance) * 100 : 0;

      // Comparison calculations
      const compYears = retirementAge - comparisonAge;
      const compMonths = compYears * 12;
      const compBalance = calculateFV(compMonths, monthlyContribution, monthlyRate);

      // Challenge: $1M goal
      const goalAmount = 1000000;
      const goalReached = finalBalance >= goalAmount;

      // Generate curve points for visualization
      const generateCurvePoints = (startAge: number, contribution: number): { x: number, y: number }[] => {
         const points: { x: number, y: number }[] = [];
         const years = retirementAge - startAge;
         for (let year = 0; year <= years; year++) {
            const months = year * 12;
            const balance = calculateFV(months, contribution, monthlyRate);
            points.push({ x: startAge + year, y: balance });
         }
         return points;
      };

      const curvePoints = generateCurvePoints(startAge, monthlyContribution);
      const comparisonPoints = showComparison ? generateCurvePoints(comparisonAge, monthlyContribution) : [];

      // SVG dimensions and scaling
      const chartWidth = 700;
      const chartHeight = 350;
      const padding = { top: 40, right: 40, bottom: 50, left: 80 };
      const innerWidth = chartWidth - padding.left - padding.right;
      const innerHeight = chartHeight - padding.top - padding.bottom;

      // Find max Y for scaling
      const maxY = Math.max(finalBalance, showComparison ? compBalance : 0, goalAmount) * 1.1;

      // Scale functions
      const scaleX = (age: number) => padding.left + ((age - 20) / (retirementAge - 20)) * innerWidth;
      const scaleY = (value: number) => padding.top + innerHeight - (value / maxY) * innerHeight;

      // Generate path string
      const generatePath = (points: { x: number, y: number }[]) => {
         if (points.length === 0) return '';
         return points.map((p, i) =>
            `${i === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`
         ).join(' ');
      };

      // Generate filled area path (for contributions)
      const generateAreaPath = () => {
         const contributionPoints: { x: number, y: number }[] = [];
         const years = yearsInvesting;
         for (let year = 0; year <= years; year++) {
            const months = year * 12;
            const contributed = monthlyContribution * months;
            contributionPoints.push({ x: startAge + year, y: contributed });
         }

         const forward = contributionPoints.map((p, i) =>
            `${i === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`
         ).join(' ');

         const backward = [...contributionPoints].reverse().map(p =>
            `L ${scaleX(p.x)} ${scaleY(0)}`
         ).join(' ');

         return forward + ' ' + backward + ' Z';
      };

      // Format currency
      const formatCurrency = (value: number) => {
         if (value >= 1000000) return `$${(value / 1000000).toFixed(2)}M`;
         if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
         return `$${value.toFixed(0)}`;
      };

      return (
         <div className="w-full h-full bg-gradient-to-br from-slate-50 to-blue-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-4 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Compound Interest Calculator</h2>
                     <p className="text-sm text-slate-500">Discover why time is your most powerful asset</p>
                  </div>
                  <div className="flex items-center gap-3">
                     <button
                        onClick={() => setShowComparison(!showComparison)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${showComparison
                           ? 'bg-purple-500 text-white'
                           : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                           }`}
                     >
                        {showComparison ? 'üìä Comparison ON' : 'üìä Compare'}
                     </button>
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode
                           ? 'bg-amber-500 text-white'
                           : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-4 p-3 rounded-xl border-2 ${goalReached
                     ? 'bg-green-50 border-green-300 text-green-800'
                     : 'bg-amber-50 border-amber-300 text-amber-800'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">{goalReached ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold">
                                 {goalReached ? 'MILLIONAIRE ACHIEVED!' : 'The Millionaire Race'}
                              </div>
                              <div className="text-xs opacity-80">
                                 {goalReached
                                    ? `You'll have ${formatCurrency(finalBalance)} at retirement!`
                                    : `Adjust controls to reach $1,000,000 by age ${retirementAge}`
                                 }
                              </div>
                           </div>
                        </div>
                        <div className="text-right">
                           <div className="text-lg font-mono font-bold">
                              {formatCurrency(finalBalance)}
                           </div>
                           <div className="text-xs opacity-70">
                              / $1,000,000
                           </div>
                        </div>
                     </div>
                  </div>
               )}

               {/* SVG Chart */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200">
                  <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full h-full">
                     <defs>
                        <linearGradient id="growthGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#22c55e" stopOpacity="0.3" />
                           <stop offset="100%" stopColor="#22c55e" stopOpacity="0.05" />
                        </linearGradient>
                        <linearGradient id="contributionGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.4" />
                           <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.1" />
                        </linearGradient>
                     </defs>

                     {/* Grid lines */}
                     {[0, 0.25, 0.5, 0.75, 1].map(ratio => (
                        <g key={ratio}>
                           <line
                              x1={padding.left}
                              y1={scaleY(maxY * ratio)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(maxY * ratio)}
                              stroke="#e2e8f0"
                              strokeDasharray={ratio === 0 ? "0" : "4 4"}
                           />
                           <text
                              x={padding.left - 10}
                              y={scaleY(maxY * ratio) + 4}
                              textAnchor="end"
                              fill="#94a3b8"
                              fontSize="10"
                           >
                              {formatCurrency(maxY * ratio)}
                           </text>
                        </g>
                     ))}

                     {/* Age axis */}
                     {[20, 30, 40, 50, 60, 65].map(age => (
                        <g key={age}>
                           <line
                              x1={scaleX(age)}
                              y1={padding.top}
                              x2={scaleX(age)}
                              y2={chartHeight - padding.bottom}
                              stroke="#e2e8f0"
                              strokeDasharray="4 4"
                           />
                           <text
                              x={scaleX(age)}
                              y={chartHeight - padding.bottom + 20}
                              textAnchor="middle"
                              fill="#64748b"
                              fontSize="11"
                              fontWeight="bold"
                           >
                              {age}
                           </text>
                        </g>
                     ))}
                     <text
                        x={chartWidth / 2}
                        y={chartHeight - 10}
                        textAnchor="middle"
                        fill="#94a3b8"
                        fontSize="12"
                     >
                        Age
                     </text>

                     {/* $1M Goal line */}
                     {challengeMode && (
                        <g>
                           <line
                              x1={padding.left}
                              y1={scaleY(goalAmount)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(goalAmount)}
                              stroke={goalReached ? "#22c55e" : "#fbbf24"}
                              strokeWidth="2"
                              strokeDasharray="8 4"
                           />
                           <text
                              x={chartWidth - padding.right + 5}
                              y={scaleY(goalAmount) + 4}
                              fill={goalReached ? "#22c55e" : "#fbbf24"}
                              fontSize="10"
                              fontWeight="bold"
                           >
                              $1M GOAL
                           </text>
                        </g>
                     )}

                     {/* Contribution area (what you put in) */}
                     <path
                        d={generateAreaPath()}
                        fill="url(#contributionGradient)"
                     />

                     {/* Comparison curve (ghost) */}
                     {showComparison && comparisonPoints.length > 0 && (
                        <path
                           d={generatePath(comparisonPoints)}
                           fill="none"
                           stroke="#a855f7"
                           strokeWidth="3"
                           strokeDasharray="8 4"
                           opacity="0.7"
                        />
                     )}

                     {/* Main growth curve */}
                     <path
                        d={generatePath(curvePoints)}
                        fill="none"
                        stroke="#22c55e"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Current position marker */}
                     <g>
                        <circle
                           cx={scaleX(startAge)}
                           cy={scaleY(0)}
                           r="8"
                           fill="#3b82f6"
                           stroke="#fff"
                           strokeWidth="3"
                        />
                        <text
                           x={scaleX(startAge)}
                           y={scaleY(0) + 25}
                           textAnchor="middle"
                           fill="#3b82f6"
                           fontSize="10"
                           fontWeight="bold"
                        >
                           START
                        </text>
                     </g>

                     {/* End point marker */}
                     <g>
                        <circle
                           cx={scaleX(retirementAge)}
                           cy={scaleY(finalBalance)}
                           r="10"
                           fill={goalReached ? "#22c55e" : "#f59e0b"}
                           stroke="#fff"
                           strokeWidth="3"
                        >
                           {goalReached && (
                              <animate attributeName="r" values="10;14;10" dur="1s" repeatCount="3" />
                           )}
                        </circle>
                        <text
                           x={scaleX(retirementAge)}
                           y={scaleY(finalBalance) - 18}
                           textAnchor="middle"
                           fill="#1e293b"
                           fontSize="14"
                           fontWeight="bold"
                        >
                           {formatCurrency(finalBalance)}
                        </text>
                     </g>

                     {/* Comparison end point */}
                     {showComparison && (
                        <g>
                           <circle
                              cx={scaleX(retirementAge)}
                              cy={scaleY(compBalance)}
                              r="8"
                              fill="#a855f7"
                              stroke="#fff"
                              strokeWidth="3"
                           />
                           <text
                              x={scaleX(retirementAge) + 25}
                              y={scaleY(compBalance) + 4}
                              fill="#a855f7"
                              fontSize="11"
                              fontWeight="bold"
                           >
                              {formatCurrency(compBalance)}
                           </text>
                        </g>
                     )}

                     {/* Legend */}
                     <g transform={`translate(${padding.left + 10}, ${padding.top + 10})`}>
                        <rect x="0" y="0" width="12" height="12" fill="#22c55e" rx="2" />
                        <text x="18" y="10" fill="#64748b" fontSize="10">Interest Earned</text>
                        <rect x="0" y="18" width="12" height="12" fill="#3b82f6" opacity="0.5" rx="2" />
                        <text x="18" y="28" fill="#64748b" fontSize="10">Your Contributions</text>
                        {showComparison && (
                           <>
                              <rect x="0" y="36" width="12" height="12" fill="#a855f7" rx="2" />
                              <text x="18" y="46" fill="#64748b" fontSize="10">Late Start (Age {comparisonAge})</text>
                           </>
                        )}
                     </g>
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-6 border-l border-slate-200 flex flex-col gap-5 overflow-y-auto shadow-lg">
               {/* Results Summary */}
               <div className="grid grid-cols-2 gap-3">
                  <div className={`p-4 rounded-xl border-2 ${goalReached && challengeMode ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}`}>
                     <div className="text-[10px] font-black uppercase text-slate-400 mb-1">Final Balance</div>
                     <div className={`text-2xl font-mono font-bold ${goalReached && challengeMode ? 'text-green-600' : 'text-slate-800'}`}>
                        {formatCurrency(finalBalance)}
                     </div>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                     <div className="text-[10px] font-black uppercase text-blue-400 mb-1">You Contributed</div>
                     <div className="text-2xl font-mono font-bold text-blue-600">
                        {formatCurrency(totalContributed)}
                     </div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                     <div className="text-[10px] font-black uppercase text-green-400 mb-1">Interest Earned</div>
                     <div className="text-xl font-mono font-bold text-green-600">
                        {formatCurrency(interestEarned)}
                     </div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                     <div className="text-[10px] font-black uppercase text-purple-400 mb-1">Interest %</div>
                     <div className="text-xl font-mono font-bold text-purple-600">
                        {interestPercentage.toFixed(1)}%
                     </div>
                  </div>
               </div>

               {/* Starting Age Control (PRIMARY) */}
               <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-indigo-600 uppercase flex items-center gap-2">
                        <span className="text-lg">‚≠ê</span> Starting Age (KEY!)
                     </label>
                     <span className="text-lg font-mono font-bold text-indigo-700">{startAge}</span>
                  </div>
                  <input
                     type="range" min="20" max="50" value={startAge}
                     onChange={(e) => setStartAge(Number(e.target.value))}
                     className="w-full h-3 bg-indigo-200 rounded-full appearance-none cursor-pointer accent-indigo-500"
                  />
                  <div className="flex justify-between text-[10px] text-indigo-400 mt-1">
                     <span>20 (Early)</span>
                     <span>35</span>
                     <span>50 (Late)</span>
                  </div>
               </div>

               {/* Monthly Contribution Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-piggy-bank text-blue-500"></i> Monthly Contribution
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">${monthlyContribution}</span>
                  </div>
                  <input
                     type="range" min="100" max="2000" step="50" value={monthlyContribution}
                     onChange={(e) => setMonthlyContribution(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>$100</span>
                     <span>$1000</span>
                     <span>$2000</span>
                  </div>
               </div>

               {/* Return Rate Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-chart-line text-green-500"></i> Annual Return
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{(annualReturn * 100).toFixed(1)}%</span>
                  </div>
                  <input
                     type="range" min="0.04" max="0.10" step="0.005" value={annualReturn}
                     onChange={(e) => setAnnualReturn(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-green-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>4% (Conservative)</span>
                     <span>7%</span>
                     <span>10% (Aggressive)</span>
                  </div>
               </div>

               {/* Comparison Age (when enabled) */}
               {showComparison && (
                  <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                     <div className="flex justify-between mb-2">
                        <label className="text-xs font-bold text-purple-600 uppercase">
                           üë§ Compare: Start at Age
                        </label>
                        <span className="text-sm font-mono font-bold text-purple-700">{comparisonAge}</span>
                     </div>
                     <input
                        type="range" min="25" max="55" value={comparisonAge}
                        onChange={(e) => setComparisonAge(Number(e.target.value))}
                        className="w-full h-2 bg-purple-200 rounded-full appearance-none cursor-pointer accent-purple-500"
                     />
                     <div className="mt-2 p-2 bg-white rounded-lg">
                        <div className="text-xs text-purple-600">
                           <strong>Difference:</strong> {formatCurrency(Math.abs(finalBalance - compBalance))}
                           {finalBalance > compBalance
                              ? <span className="text-green-600"> more</span>
                              : <span className="text-red-600"> less</span>
                           } by starting {Math.abs(startAge - comparisonAge)} years {startAge < comparisonAge ? 'earlier' : 'later'}
                        </div>
                     </div>
                  </div>
               )}

               {/* Years Investing */}
               <div className="bg-slate-100 p-3 rounded-xl text-center">
                  <div className="text-sm text-slate-600">
                     <span className="font-bold text-slate-800">{yearsInvesting} years</span> of investing
                     = <span className="font-bold text-green-600">{interestPercentage.toFixed(0)}%</span> from interest
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Notice how the curve gets steeper over time?
                        That's compound interest working. Starting at 25 instead of 35 with the SAME
                        monthly amount can mean <strong>2-3x more</strong> at retirement.
                        You can't make up for lost time by contributing more later.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUPPLY & DEMAND RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Price finds equilibrium where supply meets demand
   // Stage 2: Primary = shift demand/supply curves, Secondary = price controls
   // Stage 3: Classic X-diagram with equilibrium point, surplus/shortage areas
   // Stage 4: Demand: P = a - bQ, Supply: P = c + dQ, Equilibrium: where they intersect
   // Stage 5: State (curve positions) ‚Üí Derived (equilibrium, surplus) ‚Üí Visual
   // Stage 6: Challenges = "Find equilibrium", "Create shortage", "Price ceiling"
   const SupplyDemandRenderer = () => {
      const [demandShift, setDemandShift] = useState(0); // -50 to +50
      const [supplyShift, setSupplyShift] = useState(0); // -50 to +50
      const [priceControl, setPriceControl] = useState<number | null>(null);
      const [showSurplus, setShowSurplus] = useState(true);
      const [scenario, setScenario] = useState<'normal' | 'oil_shock' | 'tech_boom' | 'subsidy'>('normal');
      const [challengeMode, setChallengeMode] = useState(false);
      const [challengeTarget, setChallengeTarget] = useState<'equilibrium' | 'shortage' | 'surplus'>('equilibrium');

      // Base curve parameters (linear for simplicity)
      // Demand: P = 100 - Q (slopes down)
      // Supply: P = 10 + 0.8Q (slopes up)
      const demandIntercept = 100 + demandShift;
      const demandSlope = -1;
      const supplyIntercept = 10 + supplyShift;
      const supplySlope = 0.8;

      // Calculate equilibrium
      // 100 + demandShift - Q = 10 + supplyShift + 0.8Q
      // 90 + demandShift - supplyShift = 1.8Q
      // Q = (90 + demandShift - supplyShift) / 1.8
      const equilibriumQ = Math.max(0, (90 + demandShift - supplyShift) / 1.8);
      const equilibriumP = demandIntercept + demandSlope * equilibriumQ;

      // Price-controlled quantities
      const controlledPrice = priceControl ?? equilibriumP;
      const qDemanded = Math.max(0, (demandIntercept - controlledPrice) / Math.abs(demandSlope));
      const qSupplied = Math.max(0, (controlledPrice - supplyIntercept) / supplySlope);

      const hasShortage = priceControl !== null && priceControl < equilibriumP;
      const hasSurplus = priceControl !== null && priceControl > equilibriumP;
      const shortageAmount = hasShortage ? qDemanded - qSupplied : 0;
      const surplusAmount = hasSurplus ? qSupplied - qDemanded : 0;

      // Challenge evaluation
      const challengeMet = challengeMode && (
         (challengeTarget === 'equilibrium' && priceControl === null && Math.abs(demandShift) < 5 && Math.abs(supplyShift) < 5) ||
         (challengeTarget === 'shortage' && shortageAmount > 20) ||
         (challengeTarget === 'surplus' && surplusAmount > 20)
      );

      // Apply scenario presets
      const applyScenario = (s: typeof scenario) => {
         setScenario(s);
         setPriceControl(null);
         switch (s) {
            case 'normal':
               setDemandShift(0);
               setSupplyShift(0);
               break;
            case 'oil_shock':
               setDemandShift(0);
               setSupplyShift(-30); // Supply decreases
               break;
            case 'tech_boom':
               setDemandShift(25); // Demand increases
               setSupplyShift(0);
               break;
            case 'subsidy':
               setDemandShift(0);
               setSupplyShift(20); // Supply increases
               break;
         }
      };

      // SVG dimensions
      const chartWidth = 600;
      const chartHeight = 400;
      const padding = { top: 40, right: 40, bottom: 60, left: 70 };
      const innerWidth = chartWidth - padding.left - padding.right;
      const innerHeight = chartHeight - padding.top - padding.bottom;

      // Scale functions (Q: 0-100, P: 0-120)
      const maxQ = 100;
      const maxP = 120;
      const scaleX = (q: number) => padding.left + (q / maxQ) * innerWidth;
      const scaleY = (p: number) => padding.top + innerHeight - (p / maxP) * innerHeight;

      // Generate line paths
      const demandPath = `M ${scaleX(0)} ${scaleY(demandIntercept)} L ${scaleX(Math.min(maxQ, demandIntercept / Math.abs(demandSlope)))} ${scaleY(0)}`;
      const supplyPath = `M ${scaleX(0)} ${scaleY(supplyIntercept)} L ${scaleX(maxQ)} ${scaleY(supplyIntercept + supplySlope * maxQ)}`;

      return (
         <div className="w-full h-full bg-gradient-to-br from-emerald-50 to-blue-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-3 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Supply & Demand</h2>
                     <p className="text-sm text-slate-500">Discover how markets find equilibrium</p>
                  </div>
                  <div className="flex items-center gap-2">
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Scenario Buttons */}
               <div className="mb-3 flex gap-2 flex-wrap">
                  {[
                     { id: 'normal', label: '‚öñÔ∏è Normal', desc: 'Base case' },
                     { id: 'oil_shock', label: 'üõ¢Ô∏è Oil Shock', desc: 'Supply drops' },
                     { id: 'tech_boom', label: 'üì± Tech Boom', desc: 'Demand rises' },
                     { id: 'subsidy', label: 'üí∞ Subsidy', desc: 'Supply rises' },
                  ].map(s => (
                     <button
                        key={s.id}
                        onClick={() => applyScenario(s.id as typeof scenario)}
                        className={`px-3 py-2 rounded-lg text-xs font-bold transition-all ${scenario === s.id
                           ? 'bg-indigo-500 text-white shadow-lg'
                           : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'
                           }`}
                     >
                        {s.label}
                     </button>
                  ))}
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-3 p-3 rounded-xl border-2 ${challengeMet ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-xl">{challengeMet ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold text-slate-800">
                                 {challengeTarget === 'equilibrium' && 'Find Market Equilibrium'}
                                 {challengeTarget === 'shortage' && 'Create a Shortage (20+ units)'}
                                 {challengeTarget === 'surplus' && 'Create a Surplus (20+ units)'}
                              </div>
                              <div className="text-xs text-slate-600">
                                 {challengeMet ? 'Challenge Complete!' : 'Adjust curves or set price controls'}
                              </div>
                           </div>
                        </div>
                        <select
                           value={challengeTarget}
                           onChange={(e) => setChallengeTarget(e.target.value as typeof challengeTarget)}
                           className="text-xs p-1 rounded border border-slate-300"
                        >
                           <option value="equilibrium">Equilibrium</option>
                           <option value="shortage">Shortage</option>
                           <option value="surplus">Surplus</option>
                        </select>
                     </div>
                  </div>
               )}

               {/* SVG Chart */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200">
                  <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full h-full">
                     <defs>
                        <linearGradient id="shortageGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#ef4444" stopOpacity="0.3" />
                           <stop offset="100%" stopColor="#ef4444" stopOpacity="0.1" />
                        </linearGradient>
                        <linearGradient id="surplusGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#22c55e" stopOpacity="0.1" />
                           <stop offset="100%" stopColor="#22c55e" stopOpacity="0.3" />
                        </linearGradient>
                     </defs>

                     {/* Grid */}
                     {[0, 25, 50, 75, 100].map(q => (
                        <g key={`q-${q}`}>
                           <line x1={scaleX(q)} y1={padding.top} x2={scaleX(q)} y2={chartHeight - padding.bottom} stroke="#e2e8f0" strokeDasharray="4 4" />
                           <text x={scaleX(q)} y={chartHeight - padding.bottom + 20} textAnchor="middle" fill="#64748b" fontSize="10">{q}</text>
                        </g>
                     ))}
                     {[0, 30, 60, 90, 120].map(p => (
                        <g key={`p-${p}`}>
                           <line x1={padding.left} y1={scaleY(p)} x2={chartWidth - padding.right} y2={scaleY(p)} stroke="#e2e8f0" strokeDasharray="4 4" />
                           <text x={padding.left - 10} y={scaleY(p) + 4} textAnchor="end" fill="#64748b" fontSize="10">${p}</text>
                        </g>
                     ))}

                     {/* Axis labels */}
                     <text x={chartWidth / 2} y={chartHeight - 15} textAnchor="middle" fill="#64748b" fontSize="12" fontWeight="bold">Quantity (Q)</text>
                     <text x={20} y={chartHeight / 2} textAnchor="middle" fill="#64748b" fontSize="12" fontWeight="bold" transform={`rotate(-90, 20, ${chartHeight / 2})`}>Price (P)</text>

                     {/* Shortage/Surplus areas when price control active */}
                     {priceControl !== null && showSurplus && (
                        <g>
                           {hasShortage && (
                              <rect
                                 x={scaleX(qSupplied)}
                                 y={scaleY(controlledPrice) - 15}
                                 width={scaleX(qDemanded) - scaleX(qSupplied)}
                                 height={30}
                                 fill="url(#shortageGradient)"
                                 rx="4"
                              />
                           )}
                           {hasSurplus && (
                              <rect
                                 x={scaleX(qDemanded)}
                                 y={scaleY(controlledPrice) - 15}
                                 width={scaleX(qSupplied) - scaleX(qDemanded)}
                                 height={30}
                                 fill="url(#surplusGradient)"
                                 rx="4"
                              />
                           )}
                        </g>
                     )}

                     {/* Price control line */}
                     {priceControl !== null && (
                        <g>
                           <line
                              x1={padding.left}
                              y1={scaleY(priceControl)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(priceControl)}
                              stroke={hasShortage ? "#ef4444" : hasSurplus ? "#22c55e" : "#6366f1"}
                              strokeWidth="3"
                              strokeDasharray="8 4"
                           />
                           <text
                              x={chartWidth - padding.right + 5}
                              y={scaleY(priceControl) + 4}
                              fill={hasShortage ? "#ef4444" : hasSurplus ? "#22c55e" : "#6366f1"}
                              fontSize="10"
                              fontWeight="bold"
                           >
                              {hasShortage ? 'PRICE CEILING' : hasSurplus ? 'PRICE FLOOR' : 'PRICE CONTROL'}
                           </text>
                        </g>
                     )}

                     {/* Demand curve (blue, slopes down) */}
                     <path d={demandPath} fill="none" stroke="#3b82f6" strokeWidth="4" strokeLinecap="round" />
                     <text x={scaleX(5)} y={scaleY(demandIntercept - 5) - 10} fill="#3b82f6" fontSize="12" fontWeight="bold">Demand (D)</text>

                     {/* Supply curve (orange, slopes up) */}
                     <path d={supplyPath} fill="none" stroke="#f97316" strokeWidth="4" strokeLinecap="round" />
                     <text x={scaleX(85)} y={scaleY(supplyIntercept + supplySlope * 85) - 10} fill="#f97316" fontSize="12" fontWeight="bold">Supply (S)</text>

                     {/* Equilibrium point */}
                     {equilibriumQ > 0 && equilibriumP > 0 && equilibriumP < maxP && (
                        <g>
                           {/* Dashed lines to axes */}
                           <line x1={scaleX(equilibriumQ)} y1={scaleY(equilibriumP)} x2={scaleX(equilibriumQ)} y2={chartHeight - padding.bottom} stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />
                           <line x1={scaleX(equilibriumQ)} y1={scaleY(equilibriumP)} x2={padding.left} y2={scaleY(equilibriumP)} stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />

                           {/* Equilibrium marker */}
                           <circle cx={scaleX(equilibriumQ)} cy={scaleY(equilibriumP)} r="12" fill="#10b981" stroke="#fff" strokeWidth="3">
                              <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" />
                           </circle>
                           <text x={scaleX(equilibriumQ)} y={scaleY(equilibriumP) - 20} textAnchor="middle" fill="#10b981" fontSize="11" fontWeight="bold">
                              Equilibrium
                           </text>
                           <text x={scaleX(equilibriumQ)} y={scaleY(equilibriumP) + 5} textAnchor="middle" fill="#fff" fontSize="10" fontWeight="bold">E</text>
                        </g>
                     )}

                     {/* Shortage/Surplus labels */}
                     {hasShortage && shortageAmount > 5 && (
                        <text
                           x={(scaleX(qSupplied) + scaleX(qDemanded)) / 2}
                           y={scaleY(controlledPrice) + 5}
                           textAnchor="middle"
                           fill="#ef4444"
                           fontSize="11"
                           fontWeight="bold"
                        >
                           SHORTAGE: {shortageAmount.toFixed(0)} units
                        </text>
                     )}
                     {hasSurplus && surplusAmount > 5 && (
                        <text
                           x={(scaleX(qDemanded) + scaleX(qSupplied)) / 2}
                           y={scaleY(controlledPrice) + 5}
                           textAnchor="middle"
                           fill="#22c55e"
                           fontSize="11"
                           fontWeight="bold"
                        >
                           SURPLUS: {surplusAmount.toFixed(0)} units
                        </text>
                     )}
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-5 border-l border-slate-200 flex flex-col gap-4 overflow-y-auto shadow-lg">
               {/* Market Status */}
               <div className={`p-4 rounded-xl border-2 ${hasShortage ? 'bg-red-50 border-red-200' :
                  hasSurplus ? 'bg-green-50 border-green-200' :
                     'bg-emerald-50 border-emerald-200'
                  }`}>
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-1">Market Status</div>
                  <div className={`text-lg font-bold ${hasShortage ? 'text-red-600' : hasSurplus ? 'text-green-600' : 'text-emerald-600'
                     }`}>
                     {hasShortage ? '‚ö†Ô∏è SHORTAGE' : hasSurplus ? 'üì¶ SURPLUS' : '‚úÖ EQUILIBRIUM'}
                  </div>
                  <div className="text-sm text-slate-600 mt-1">
                     P* = ${equilibriumP.toFixed(0)} | Q* = {equilibriumQ.toFixed(0)} units
                  </div>
               </div>

               {/* Demand Shift Control */}
               <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-blue-600 uppercase flex items-center gap-2">
                        üìâ Demand Shift
                     </label>
                     <span className="text-sm font-mono font-bold text-blue-700">
                        {demandShift > 0 ? '+' : ''}{demandShift}
                     </span>
                  </div>
                  <input
                     type="range" min="-50" max="50" value={demandShift}
                     onChange={(e) => setDemandShift(Number(e.target.value))}
                     className="w-full h-3 bg-blue-200 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] text-blue-400 mt-1">
                     <span>‚Üê Less demand</span>
                     <span>More demand ‚Üí</span>
                  </div>
               </div>

               {/* Supply Shift Control */}
               <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-orange-600 uppercase flex items-center gap-2">
                        üìà Supply Shift
                     </label>
                     <span className="text-sm font-mono font-bold text-orange-700">
                        {supplyShift > 0 ? '+' : ''}{supplyShift}
                     </span>
                  </div>
                  <input
                     type="range" min="-50" max="50" value={supplyShift}
                     onChange={(e) => setSupplyShift(Number(e.target.value))}
                     className="w-full h-3 bg-orange-200 rounded-full appearance-none cursor-pointer accent-orange-500"
                  />
                  <div className="flex justify-between text-[10px] text-orange-400 mt-1">
                     <span>‚Üê Less supply</span>
                     <span>More supply ‚Üí</span>
                  </div>
               </div>

               {/* Price Control */}
               <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <div className="flex justify-between items-center mb-2">
                     <label className="text-xs font-bold text-purple-600 uppercase">
                        üèõÔ∏è Price Control
                     </label>
                     <button
                        onClick={() => setPriceControl(priceControl === null ? equilibriumP : null)}
                        className={`px-2 py-1 rounded text-xs font-bold ${priceControl !== null
                           ? 'bg-purple-500 text-white'
                           : 'bg-purple-200 text-purple-600'
                           }`}
                     >
                        {priceControl !== null ? 'ON' : 'OFF'}
                     </button>
                  </div>
                  {priceControl !== null && (
                     <>
                        <input
                           type="range" min="20" max="100" value={priceControl}
                           onChange={(e) => setPriceControl(Number(e.target.value))}
                           className="w-full h-3 bg-purple-200 rounded-full appearance-none cursor-pointer accent-purple-500"
                        />
                        <div className="flex justify-between text-[10px] text-purple-400 mt-1">
                           <span>$20 (Ceiling)</span>
                           <span className="font-bold">${priceControl}</span>
                           <span>$100 (Floor)</span>
                        </div>
                     </>
                  )}
               </div>

               {/* Real-World Examples */}
               <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-2">Real Examples</div>
                  <div className="grid grid-cols-2 gap-2 text-xs">
                     <div className="p-2 bg-white rounded border border-slate-100">
                        <span className="font-bold text-red-500">Shortage:</span> Rent control, PS5 launch
                     </div>
                     <div className="p-2 bg-white rounded border border-slate-100">
                        <span className="font-bold text-green-500">Surplus:</span> Min wage, farm subsidies
                     </div>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Markets naturally find equilibrium where supply meets demand.
                        Price controls (ceilings/floors) create shortages or surpluses because they prevent
                        prices from adjusting. The "invisible hand" works through price signals!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- PENDULUM / SIMPLE HARMONIC MOTION RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Period depends on LENGTH, not mass or amplitude (for small angles)
   // Stage 2: Primary = pendulum length, Secondary = initial amplitude, gravity
   // Stage 3: Animated pendulum bob swinging, period vs length graph
   // Stage 4: T = 2œÄ‚àö(L/g), Œ∏(t) = Œ∏‚ÇÄcos(œât), œâ = ‚àö(g/L)
   // Stage 5: State (length, amplitude) ‚Üí Derived (period, angular freq) ‚Üí Animation
   // Stage 6: Challenge = "Match the period to 2.0s"
   const PendulumRenderer = () => {
      const [length, setLength] = useState(1.0); // meters
      const [amplitude, setAmplitude] = useState(30); // degrees (initial angle)
      const [gravity, setGravity] = useState(9.8); // m/s¬≤
      const [isSwinging, setIsSwinging] = useState(false);
      const [time, setTime] = useState(0);
      const [showPhaseSpace, setShowPhaseSpace] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);
      const targetPeriod = 2.0; // Challenge: match this period

      // Physics calculations
      // Period: T = 2œÄ‚àö(L/g) (for small angles)
      const period = 2 * Math.PI * Math.sqrt(length / gravity);
      const angularFrequency = Math.sqrt(gravity / length); // œâ = ‚àö(g/L)

      // Current angle: Œ∏(t) = Œ∏‚ÇÄ * cos(œât) (simple harmonic motion for small angles)
      const amplitudeRad = amplitude * (Math.PI / 180);
      const currentAngleRad = amplitudeRad * Math.cos(angularFrequency * time);
      const currentAngleDeg = currentAngleRad * (180 / Math.PI);

      // Angular velocity: Œ∏'(t) = -Œ∏‚ÇÄœâ * sin(œât)
      const angularVelocity = -amplitudeRad * angularFrequency * Math.sin(angularFrequency * time);

      // Challenge evaluation
      const periodError = Math.abs(period - targetPeriod);
      const challengeMet = challengeMode && periodError < 0.05;

      // Animation loop
      useEffect(() => {
         if (!isSwinging) return;

         const startTime = performance.now();
         const initialTime = time;

         const animate = (now: number) => {
            const elapsed = (now - startTime) / 1000; // seconds
            setTime(initialTime + elapsed);
            if (isSwinging) {
               requestAnimationFrame(animate);
            }
         };

         const animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isSwinging]);

      // SVG dimensions
      const pivotX = 300;
      const pivotY = 60;
      const pixelsPerMeter = 180; // Scale: 180px = 1m
      const bobRadius = 25;

      // Calculate bob position
      const bobX = pivotX + Math.sin(currentAngleRad) * length * pixelsPerMeter;
      const bobY = pivotY + Math.cos(currentAngleRad) * length * pixelsPerMeter;

      // Generate trail/ghost positions for visualization
      const trailAngles = [];
      for (let i = 0; i <= 10; i++) {
         const trailAngle = amplitudeRad * Math.cos(angularFrequency * (time - i * 0.05));
         trailAngles.push({
            x: pivotX + Math.sin(trailAngle) * length * pixelsPerMeter,
            y: pivotY + Math.cos(trailAngle) * length * pixelsPerMeter,
            opacity: 1 - i * 0.09
         });
      }

      return (
         <div className="w-full h-full bg-gradient-to-br from-violet-50 to-indigo-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-3 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Simple Pendulum</h2>
                     <p className="text-sm text-slate-500">Discover what affects the period</p>
                  </div>
                  <div className="flex items-center gap-2">
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-3 p-3 rounded-xl border-2 ${challengeMet ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-xl">{challengeMet ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold text-slate-800">
                                 Match Period = {targetPeriod.toFixed(1)}s
                              </div>
                              <div className="text-xs text-slate-600">
                                 {challengeMet ? 'Perfect! You found it!' : `Current: ${period.toFixed(2)}s (off by ${periodError.toFixed(2)}s)`}
                              </div>
                           </div>
                        </div>
                        <div className="text-xs text-slate-500">
                           Hint: Adjust the length!
                        </div>
                     </div>
                  </div>
               )}

               {/* SVG Visualization */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200 flex items-center justify-center">
                  <svg viewBox="0 0 600 420" className="w-full h-full max-h-[350px]">
                     <defs>
                        <linearGradient id="stringGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#6366f1" />
                           <stop offset="100%" stopColor="#4f46e5" />
                        </linearGradient>
                        <radialGradient id="bobGradient" cx="30%" cy="30%">
                           <stop offset="0%" stopColor="#818cf8" />
                           <stop offset="100%" stopColor="#4f46e5" />
                        </radialGradient>
                        <filter id="bobShadow" x="-50%" y="-50%" width="200%" height="200%">
                           <feDropShadow dx="3" dy="5" stdDeviation="4" floodOpacity="0.3" />
                        </filter>
                     </defs>

                     {/* Background grid */}
                     <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e2e8f0" strokeWidth="0.5" />
                     </pattern>
                     <rect width="600" height="420" fill="url(#grid)" />

                     {/* Pivot point */}
                     <rect x={pivotX - 60} y={pivotY - 20} width="120" height="25" fill="#374151" rx="4" />
                     <circle cx={pivotX} cy={pivotY} r="8" fill="#1f2937" stroke="#fff" strokeWidth="2" />

                     {/* Amplitude arc (dashed) */}
                     <path
                        d={`M ${pivotX + Math.sin(-amplitudeRad) * length * pixelsPerMeter * 0.3} ${pivotY + Math.cos(-amplitudeRad) * length * pixelsPerMeter * 0.3} 
                            A ${length * pixelsPerMeter * 0.3} ${length * pixelsPerMeter * 0.3} 0 0 1 
                            ${pivotX + Math.sin(amplitudeRad) * length * pixelsPerMeter * 0.3} ${pivotY + Math.cos(amplitudeRad) * length * pixelsPerMeter * 0.3}`}
                        fill="none"
                        stroke="#a78bfa"
                        strokeWidth="2"
                        strokeDasharray="6 4"
                        opacity="0.5"
                     />

                     {/* Trail/ghost positions */}
                     {isSwinging && trailAngles.slice(2).map((pos, i) => (
                        <circle
                           key={i}
                           cx={pos.x}
                           cy={pos.y}
                           r={bobRadius * 0.6}
                           fill="#a78bfa"
                           opacity={pos.opacity * 0.3}
                        />
                     ))}

                     {/* String/rod */}
                     <line
                        x1={pivotX} y1={pivotY}
                        x2={bobX} y2={bobY}
                        stroke="url(#stringGradient)"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Bob */}
                     <circle
                        cx={bobX}
                        cy={bobY}
                        r={bobRadius}
                        fill="url(#bobGradient)"
                        filter="url(#bobShadow)"
                        stroke="#fff"
                        strokeWidth="3"
                     />

                     {/* Angle indicator */}
                     <text x={pivotX + 35} y={pivotY + 50} fill="#6366f1" fontSize="12" fontWeight="bold">
                        Œ∏ = {currentAngleDeg.toFixed(1)}¬∞
                     </text>

                     {/* Length indicator */}
                     <line x1={pivotX + 40} y1={pivotY + 10} x2={pivotX + 40} y2={pivotY + length * pixelsPerMeter - 10} stroke="#94a3b8" strokeWidth="1" markerEnd="url(#arrow)" />
                     <text x={pivotX + 55} y={pivotY + length * pixelsPerMeter / 2} fill="#64748b" fontSize="11">
                        L = {length.toFixed(2)}m
                     </text>

                     {/* Period display */}
                     <rect x="430" y="20" width="150" height="70" fill="#f8fafc" rx="8" stroke="#e2e8f0" />
                     <text x="505" y="45" textAnchor="middle" fill="#64748b" fontSize="10" fontWeight="bold">PERIOD</text>
                     <text x="505" y="72" textAnchor="middle" fill={challengeMet ? "#22c55e" : "#4f46e5"} fontSize="24" fontWeight="bold">
                        T = {period.toFixed(2)}s
                     </text>

                     {/* Formula */}
                     <text x="505" y="115" textAnchor="middle" fill="#94a3b8" fontSize="11">
                        T = 2œÄ‚àö(L/g)
                     </text>
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-5 border-l border-slate-200 flex flex-col gap-4 overflow-y-auto shadow-lg">
               {/* Start/Stop Button */}
               <button
                  onClick={() => {
                     if (!isSwinging) setTime(0);
                     setIsSwinging(!isSwinging);
                  }}
                  className={`w-full py-4 rounded-xl font-bold text-lg transition-all ${isSwinging
                     ? 'bg-red-500 text-white hover:bg-red-600'
                     : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:from-indigo-600 hover:to-purple-600'
                     }`}
               >
                  {isSwinging ? '‚èπÔ∏è STOP' : '‚ñ∂Ô∏è START SWING'}
               </button>

               {/* Physics Metrics */}
               <div className="grid grid-cols-2 gap-3">
                  <div className="p-3 bg-indigo-50 rounded-xl border-2 border-indigo-200 text-center">
                     <div className="text-[10px] font-black uppercase text-indigo-400">Period</div>
                     <div className="text-xl font-mono font-bold text-indigo-600">{period.toFixed(2)}s</div>
                  </div>
                  <div className="p-3 bg-purple-50 rounded-xl border-2 border-purple-200 text-center">
                     <div className="text-[10px] font-black uppercase text-purple-400">Frequency</div>
                     <div className="text-xl font-mono font-bold text-purple-600">{(1 / period).toFixed(2)} Hz</div>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                     <div className="text-[10px] font-black uppercase text-slate-400">Angular œâ</div>
                     <div className="text-lg font-mono font-bold text-slate-600">{angularFrequency.toFixed(2)} rad/s</div>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                     <div className="text-[10px] font-black uppercase text-slate-400">Time</div>
                     <div className="text-lg font-mono font-bold text-slate-600">{time.toFixed(1)}s</div>
                  </div>
               </div>

               {/* Length Control (PRIMARY - affects period) */}
               <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-indigo-600 uppercase flex items-center gap-2">
                        ‚≠ê Length (affects period!)
                     </label>
                     <span className="text-sm font-mono font-bold text-indigo-700">{length.toFixed(2)} m</span>
                  </div>
                  <input
                     type="range" min="0.25" max="2.5" step="0.05" value={length}
                     onChange={(e) => setLength(Number(e.target.value))}
                     className="w-full h-3 bg-indigo-200 rounded-full appearance-none cursor-pointer accent-indigo-500"
                  />
                  <div className="flex justify-between text-[10px] text-indigo-400 mt-1">
                     <span>0.25m (fast)</span>
                     <span>1.0m</span>
                     <span>2.5m (slow)</span>
                  </div>
               </div>

               {/* Amplitude Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase">
                        üìê Initial Amplitude
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{amplitude}¬∞</span>
                  </div>
                  <input
                     type="range" min="5" max="45" step="5" value={amplitude}
                     onChange={(e) => setAmplitude(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-violet-500"
                  />
                  <div className="text-[10px] text-slate-400 mt-1 text-center">
                     (Doesn't affect period for small angles!)
                  </div>
               </div>

               {/* Gravity Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase">
                        üåç Gravity
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{gravity.toFixed(1)} m/s¬≤</span>
                  </div>
                  <input
                     type="range" min="1.6" max="25" step="0.1" value={gravity}
                     onChange={(e) => setGravity(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-emerald-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>üåô Moon (1.6)</span>
                     <span>üåç Earth (9.8)</span>
                     <span>‚ôÉ Jupiter (25)</span>
                  </div>
               </div>

               {/* Key Discovery Box */}
               <div className="bg-emerald-50 p-3 rounded-xl border-2 border-emerald-200">
                  <div className="text-xs text-emerald-800">
                     <strong>üî¨ Key Discovery:</strong> Try changing the amplitude and mass (imagine different bobs).
                     Does the period change? <em>For small angles, only LENGTH and GRAVITY affect the period!</em>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Galileo discovered that a pendulum's period is
                        independent of its amplitude (for small swings). This led to the invention
                        of accurate clocks! The formula T = 2œÄ‚àö(L/g) shows only length and gravity matter.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ADDITION RENDERER (Concrete ‚Üí Pictorial ‚Üí Abstract) ---
   // Stage 1: Core insight = Combining groups.
   // Stage 2: Primary = num1, num2.
   // Stage 3: Concrete (Apples) + Pictorial (Number Line) + Abstract (Equation).
   // Stage 4: a + b = c.
   // Stage 5: State (num1, num2) ‚Üí Derived (total, paths).
   // Stage 6: Challenge = "Make the total 10".
   const AdditionRenderer = () => {
      const [num1, setNum1] = useState(5);
      const [num2, setNum2] = useState(4);
      const [showNumberLine, setShowNumberLine] = useState(true);
      const [isCombining, setIsCombining] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);

      const total = num1 + num2;
      const isChallengeMet = challengeMode && total === 10;

      // Helper to render a group of apples
      const renderApples = (count: number, color: string, isResult: boolean = false) => {
         const apples = [];
         const cols = 5;
         for (let i = 0; i < count; i++) {
            const row = Math.floor(i / cols);
            const col = i % cols;
            apples.push(
               <g key={i} transform={`translate(${col * 25 + 15}, ${row * 25 + 15})`} className="animate-in zoom-in duration-300">
                  <circle r="10" fill={color} />
                  <path d="M-2,-8 Q0,-12 2,-8" stroke="#4ade80" strokeWidth="2" fill="none" />
                  <circle r="2" cx="3" cy="-3" fill="white" opacity="0.4" />
               </g>
            );
         }
         return apples;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Addition</h2>
                     <p className="text-slate-500 text-sm">Combining groups into one total</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the total exactly 10</p>
                           <p className="text-xs opacity-80">Adjust the numbers to find different ways to make 10.</p>
                        </div>
                        {isChallengeMet && (
                           <div className="ml-auto animate-bounce text-green-600 font-black">SUCCESS!</div>
                        )}
                     </div>
                  </div>
               )}

               {/* CONCRETE LAYER: Apples */}
               <div className="flex-1 grid grid-cols-3 gap-4 min-h-0">
                  <div className="bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex flex-col items-center">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Group A</span>
                     <svg className="w-full h-full max-h-[150px]">
                        {renderApples(num1, "#ef4444")}
                     </svg>
                     <div className="mt-2 text-2xl font-black text-red-500">{num1}</div>
                  </div>

                  <div className="flex items-center justify-center text-4xl font-black text-slate-300">+</div>

                  <div className="bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex flex-col items-center">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Group B</span>
                     <svg className="w-full h-full max-h-[150px]">
                        {renderApples(num2, "#3b82f6")}
                     </svg>
                     <div className="mt-2 text-2xl font-black text-blue-500">{num2}</div>
                  </div>
               </div>

               {/* PICTORIAL LAYER: Number Line */}
               {showNumberLine && (
                  <div className="h-24 bg-slate-50 rounded-2xl border border-slate-100 p-4 relative overflow-hidden">
                     <svg viewBox="0 0 600 80" className="w-full h-full">
                        {/* Line */}
                        <line x1="20" y1="50" x2="580" y2="50" stroke="#cbd5e1" strokeWidth="2" />
                        {/* Ticks */}
                        {Array.from({ length: 21 }).map((_, i) => (
                           <g key={i} transform={`translate(${20 + i * 28}, 50)`}>
                              <line y1="-5" y2="5" stroke="#cbd5e1" strokeWidth="2" />
                              <text y="20" textAnchor="middle" fontSize="10" fill="#94a3b8" fontWeight="bold">{i}</text>
                           </g>
                        ))}
                        {/* Jump 1 */}
                        <path
                           d={`M 20,50 Q ${20 + (num1 * 28) / 2},10 ${20 + num1 * 28},50`}
                           fill="none" stroke="#ef4444" strokeWidth="3" strokeDasharray="4 2"
                        />
                        {/* Jump 2 */}
                        <path
                           d={`M ${20 + num1 * 28},50 Q ${20 + num1 * 28 + (num2 * 28) / 2},10 ${20 + (num1 + num2) * 28},50`}
                           fill="none" stroke="#3b82f6" strokeWidth="3"
                        />
                        {/* Marker */}
                        <circle cx={20 + (num1 + num2) * 28} cy="50" r="6" fill="#10b981" className="shadow-lg" />
                     </svg>
                  </div>
               )}

               {/* ABSTRACT LAYER: Equation */}
               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-red-400">{num1}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">First Part</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{num2}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Second Part</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{total}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
               <div className="space-y-6">
                  {/* Num 1 Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üçé Group A Size</label>
                        <span className="text-2xl font-black text-red-500">{num1}</span>
                     </div>
                     <input
                        type="range" min="0" max="10" step="1" value={num1}
                        onChange={(e) => setNum1(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500"
                     />
                  </div>

                  {/* Num 2 Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üîµ Group B Size</label>
                        <span className="text-2xl font-black text-blue-500">{num2}</span>
                     </div>
                     <input
                        type="range" min="0" max="10" step="1" value={num2}
                        onChange={(e) => setNum2(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowNumberLine(!showNumberLine)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${showNumberLine ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showNumberLine ? 'üìè HIDE NUMBER LINE' : 'üìè SHOW NUMBER LINE'}
                  </button>

                  <button
                     onClick={() => {
                        const n1 = Math.floor(Math.random() * 10);
                        const n2 = Math.floor(Math.random() * 10);
                        setNum1(n1);
                        setNum2(n2);
                     }}
                     className="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-sm text-slate-600 hover:bg-slate-50 transition-all"
                  >
                     üé≤ RANDOM PROBLEM
                  </button>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                  <div className="flex gap-3">
                     <div className="text-emerald-600 text-lg">üí°</div>
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Addition is just putting things together.
                        You can see it as <strong>counting objects</strong> (concrete) or as
                        <strong>jumping forward</strong> on a line (pictorial). The equation
                        is just a short way to write what happened!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUBTRACTION RENDERER (Take-Away vs Difference) ---
   // Stage 1: Core insight = Removal or Comparison.
   // Stage 2: Primary = minuend, subtrahend.
   // Stage 3: Mode toggle (Take Away / Difference).
   // Stage 4: a - b = c.
   // Stage 5: State (num1, num2, mode) ‚Üí Derived (result, matched).
   // Stage 6: Challenge = "Find the difference".
   const SubtractionRenderer = () => {
      const [num1, setNum1] = useState(8);
      const [num2, setNum2] = useState(3);
      const [mode, setMode] = useState<'takeaway' | 'difference'>('takeaway');
      const [challengeMode, setChallengeMode] = useState(false);

      const result = num1 - num2;
      const isChallengeMet = challengeMode && result === 5;

      const renderTakeAway = () => {
         const items = [];
         const cols = 5;
         for (let i = 0; i < num1; i++) {
            const row = Math.floor(i / cols);
            const col = i % cols;
            const isRemoved = i >= num1 - num2;
            items.push(
               <g key={i} transform={`translate(${col * 30 + 20}, ${row * 30 + 20})`} className="transition-all duration-500">
                  <circle r="12" fill={isRemoved ? "#cbd5e1" : "#f97316"} opacity={isRemoved ? 0.3 : 1} />
                  {isRemoved && (
                     <path d="M-8,-8 L8,8 M8,-8 L-8,8" stroke="#ef4444" strokeWidth="3" />
                  )}
                  <circle r="3" cx="4" cy="-4" fill="white" opacity="0.4" />
               </g>
            );
         }
         return items;
      };

      const renderDifference = () => {
         const groupA = [];
         const groupB = [];
         const connections = [];

         for (let i = 0; i < num1; i++) {
            groupA.push(
               <circle key={`a-${i}`} cx="20" cy={i * 30 + 20} r="12" fill="#f97316" />
            );
         }
         for (let i = 0; i < num2; i++) {
            groupB.push(
               <circle key={`b-${i}`} cx="180" cy={i * 30 + 20} r="12" fill="#6366f1" />
            );
            connections.push(
               <line key={`c-${i}`} x1="32" y1={i * 30 + 20} x2="168" y2={i * 30 + 20} stroke="#cbd5e1" strokeWidth="2" strokeDasharray="4 2" />
            );
         }

         return (
            <g>
               {connections}
               {groupA}
               {groupB}
               {/* Highlight the difference */}
               {Array.from({ length: num1 - num2 }).map((_, i) => (
                  <rect
                     key={`h-${i}`}
                     x="5" y={(num2 + i) * 30 + 5}
                     width="30" height="30"
                     fill="none" stroke="#ef4444" strokeWidth="2" rx="4"
                     className="animate-pulse"
                  />
               ))}
            </g>
         );
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Subtraction</h2>
                     <p className="text-slate-500 text-sm">Taking away or finding the difference</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setMode('takeaway')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'takeaway' ? 'bg-orange-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        TAKE AWAY
                     </button>
                     <button
                        onClick={() => setMode('difference')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'difference' ? 'bg-indigo-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        DIFFERENCE
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the difference exactly 5</p>
                           <p className="text-xs opacity-80">Adjust the numbers until the result is 5.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8">
                  <svg className="w-full h-full max-w-[400px] max-h-[400px]" viewBox="0 0 200 300">
                     {mode === 'takeaway' ? renderTakeAway() : renderDifference()}
                  </svg>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-orange-400">{num1}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Start</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">‚àí</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{num2}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Remove</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{result}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Left</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Start Amount</label>
                        <span className="text-2xl font-black text-orange-500">{num1}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={num1}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setNum1(val);
                           if (num2 > val) setNum2(val);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Take Away</label>
                        <span className="text-2xl font-black text-indigo-500">{num2}</span>
                     </div>
                     <input
                        type="range" min="0" max={num1} step="1" value={num2}
                        onChange={(e) => setNum2(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>Inverse Relationship:</strong> Notice that if
                        <span className="font-bold"> {num1} - {num2} = {result}</span>, then
                        <span className="font-bold"> {num2} + {result} = {num1}</span>.
                        Subtraction is just addition in reverse!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MULTIPLICATION RENDERER (Area Model & Distributive Property) ---
   // Stage 1: Core insight = Repeated groups / Area.
   // Stage 2: Primary = rows, cols.
   // Stage 3: Resizable Grid + Distributive Split.
   // Stage 4: a √ó b = c.
   // Stage 5: State (rows, cols, splitX) ‚Üí Derived (area, parts).
   // Stage 6: Challenge = "Make Area 24".
   const MultiplicationRenderer = () => {
      const [rows, setRows] = useState(4);
      const [cols, setCols] = useState(6);
      const [splitX, setSplitX] = useState(0); // 0 means no split
      const [challengeMode, setChallengeMode] = useState(false);

      const area = rows * cols;
      const isChallengeMet = challengeMode && area === 24;

      const renderGrid = () => {
         const cells = [];
         const cellSize = 30;
         for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
               const isSplit = splitX > 0 && c >= splitX;
               cells.push(
                  <rect
                     key={`${r}-${c}`}
                     x={c * cellSize + 10}
                     y={r * cellSize + 10}
                     width={cellSize - 2}
                     height={cellSize - 2}
                     fill={isSplit ? "#6366f1" : "#f97316"}
                     className="animate-in zoom-in duration-300"
                     rx="4"
                  />
               );
            }
         }
         return cells;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Multiplication</h2>
                     <p className="text-slate-500 text-sm">Repeated groups as an area model</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the area exactly 24</p>
                           <p className="text-xs opacity-80">Find different dimensions (rows √ó cols) that equal 24.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-hidden">
                  <div className="relative">
                     <svg width={cols * 30 + 20} height={rows * 30 + 20}>
                        {renderGrid()}
                        {/* Labels */}
                        <text x={-5} y={rows * 15 + 10} textAnchor="middle" transform={`rotate(-90, -5, ${rows * 15 + 10})`} className="text-xs font-black fill-slate-400">{rows}</text>
                        <text x={cols * 15 + 10} y={-5} textAnchor="middle" className="text-xs font-black fill-slate-400">{cols}</text>
                     </svg>
                  </div>
               </div>

               {/* Distributive Property View */}
               {splitX > 0 && (
                  <div className="p-4 bg-slate-50 rounded-2xl border border-slate-200 flex items-center justify-center gap-4 text-sm font-bold">
                     <span className="text-orange-500">({rows} √ó {splitX})</span>
                     <span className="text-slate-400">+</span>
                     <span className="text-indigo-500">({rows} √ó {cols - splitX})</span>
                     <span className="text-slate-400">=</span>
                     <span className="text-emerald-500">{area}</span>
                  </div>
               )}

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-orange-400">{rows}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Rows</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√ó</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{cols}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Cols</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{area}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Area</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üï Rows</label>
                        <span className="text-2xl font-black text-orange-500">{rows}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={rows}
                        onChange={(e) => setRows(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üî Columns</label>
                        <span className="text-2xl font-black text-indigo-500">{cols}</span>
                     </div>
                     <input
                        type="range" min="1" max="12" step="1" value={cols}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setCols(val);
                           if (splitX >= val) setSplitX(0);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚úÇ Split (Distributive)</label>
                        <span className="text-2xl font-black text-slate-400">{splitX || 'Off'}</span>
                     </div>
                     <input
                        type="range" min="0" max={cols - 1} step="1" value={splitX}
                        onChange={(e) => setSplitX(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-400"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Multiplication is just area!
                        The <strong>Distributive Property</strong> lets you break a big
                        problem into two smaller ones.
                        <span className="block mt-1 font-bold">4 √ó 6 is the same as (4 √ó 4) + (4 √ó 2).</span>
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- DIVISION RENDERER (Sharing vs Grouping) ---
   // Stage 1: Core insight = Fair sharing or finding sets.
   // Stage 2: Primary = dividend, divisor.
   // Stage 3: Mode toggle (Sharing / Grouping).
   // Stage 4: a √∑ b = c (r d).
   // Stage 5: State (total, divisor, mode) ‚Üí Derived (quotient, remainder).
   // Stage 6: Challenge = "Fair sharing with remainder".
   const DivisionRenderer = () => {
      const [total, setTotal] = useState(12);
      const [divisor, setDivisor] = useState(3);
      const [mode, setMode] = useState<'sharing' | 'grouping'>('sharing');
      const [challengeMode, setChallengeMode] = useState(false);

      const quotient = Math.floor(total / divisor);
      const remainder = total % divisor;
      const isChallengeMet = challengeMode && remainder === 2;

      const renderSharing = () => {
         const groups = [];
         for (let g = 0; g < divisor; g++) {
            const items = [];
            for (let i = 0; i < quotient; i++) {
               items.push(
                  <circle key={i} cx={i * 15 + 10} cy="10" r="6" fill="#10b981" className="animate-in zoom-in duration-300" />
               );
            }
            groups.push(
               <div key={g} className="flex flex-col items-center gap-2 p-3 bg-white rounded-xl border border-slate-200 shadow-sm">
                  <span className="text-[8px] font-bold text-slate-400 uppercase">Friend {g + 1}</span>
                  <svg width={quotient * 15 + 10} height="20">{items}</svg>
                  <span className="text-xs font-black text-emerald-500">{quotient}</span>
               </div>
            );
         }
         return (
            <div className="flex flex-wrap justify-center gap-4">
               {groups}
               {remainder > 0 && (
                  <div className="flex flex-col items-center gap-2 p-3 bg-amber-50 rounded-xl border border-amber-200 shadow-sm">
                     <span className="text-[8px] font-bold text-amber-500 uppercase">Remainder</span>
                     <svg width={remainder * 15 + 10} height="20">
                        {Array.from({ length: remainder }).map((_, i) => (
                           <circle key={i} cx={i * 15 + 10} cy="10" r="6" fill="#f59e0b" />
                        ))}
                     </svg>
                     <span className="text-xs font-black text-amber-600">{remainder}</span>
                  </div>
               )}
            </div>
         );
      };

      const renderGrouping = () => {
         const groups = [];
         for (let g = 0; g < quotient; g++) {
            groups.push(
               <div key={g} className="p-2 bg-indigo-50 rounded-lg border border-indigo-100 flex gap-1">
                  {Array.from({ length: divisor }).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded-full bg-indigo-500" />
                  ))}
               </div>
            );
         }
         return (
            <div className="flex flex-wrap justify-center gap-3">
               {groups}
               {remainder > 0 && (
                  <div className="p-2 bg-amber-50 rounded-lg border border-amber-100 flex gap-1">
                     {Array.from({ length: remainder }).map((_, i) => (
                        <div key={i} className="w-3 h-3 rounded-full bg-amber-500" />
                     ))}
                  </div>
               )}
            </div>
         );
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Division</h2>
                     <p className="text-slate-500 text-sm">Sharing equally or making groups</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setMode('sharing')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'sharing' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        SHARING
                     </button>
                     <button
                        onClick={() => setMode('grouping')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'grouping' ? 'bg-indigo-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        GROUPING
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Find a combination with remainder 2</p>
                           <p className="text-xs opacity-80">Adjust the total and divisor until 2 items are left over.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-y-auto">
                  {mode === 'sharing' ? renderSharing() : renderGrouping()}
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">{total}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√∑</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{divisor}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">{mode === 'sharing' ? 'Friends' : 'Group Size'}</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{quotient}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">{mode === 'sharing' ? 'Each' : 'Groups'}</div>
                  </div>
                  {remainder > 0 && (
                     <>
                        <div className="text-xl font-bold text-slate-600">rem</div>
                        <div className="flex flex-col items-center">
                           <div className="text-4xl font-black text-amber-400">{remainder}</div>
                           <div className="text-[8px] font-bold text-slate-500 uppercase">Left</div>
                        </div>
                     </>
                  )}
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Items</label>
                        <span className="text-2xl font-black text-emerald-500">{total}</span>
                     </div>
                     <input
                        type="range" min="1" max="30" step="1" value={total}
                        onChange={(e) => setTotal(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{mode === 'sharing' ? 'Number of Friends' : 'Items per Group'}</label>
                        <span className="text-2xl font-black text-indigo-500">{divisor}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={divisor}
                        onChange={(e) => setDivisor(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Division is "undoing" multiplication.
                        If <span className="font-bold">{divisor} √ó {quotient} = {divisor * quotient}</span>,
                        then <span className="font-bold">{total} √∑ {divisor} = {quotient}</span>
                        (with {remainder} left over).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FRACTION RENDERER (Part-Whole, Equivalence, Comparison) ---
   // Stage 1: Core insight = Equal parts of a whole.
   // Stage 2: Primary = numerator, denominator.
   // Stage 3: Bar vs Circle models + Equivalence ghosting.
   // Stage 4: n/d.
   // Stage 5: State (n, d, model) ‚Üí Derived (percentage, angle).
   // Stage 6: Challenge = "Find equivalent to 1/2".
   const FractionRenderer = () => {
      const [num, setNum] = useState(1);
      const [den, setDen] = useState(4);
      const [model, setModel] = useState<'bar' | 'circle'>('bar');
      const [showEquivalent, setShowEquivalent] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);

      const percentage = (num / den) * 100;
      const isChallengeMet = challengeMode && num / den === 0.5 && den !== 2;

      const renderBar = (n: number, d: number, color: string, isGhost: boolean = false) => {
         const parts = [];
         const width = 300;
         const height = 40;
         const partWidth = width / d;

         for (let i = 0; i < d; i++) {
            parts.push(
               <rect
                  key={i}
                  x={i * partWidth}
                  y={0}
                  width={partWidth}
                  height={height}
                  fill={i < n ? color : "transparent"}
                  stroke={isGhost ? "#cbd5e1" : "#94a3b8"}
                  strokeWidth={isGhost ? "1" : "2"}
                  opacity={isGhost ? 0.3 : 1}
                  className="transition-all duration-500"
               />
            );
         }
         return <g transform="translate(10, 10)">{parts}</g>;
      };

      const renderCircle = (n: number, d: number, color: string) => {
         const parts = [];
         const radius = 80;
         const cx = 100;
         const cy = 100;

         for (let i = 0; i < d; i++) {
            const startAngle = (i * 360) / d;
            const endAngle = ((i + 1) * 360) / d;
            const x1 = cx + radius * Math.cos((startAngle - 90) * Math.PI / 180);
            const y1 = cy + radius * Math.sin((startAngle - 90) * Math.PI / 180);
            const x2 = cx + radius * Math.cos((endAngle - 90) * Math.PI / 180);
            const y2 = cy + radius * Math.sin((endAngle - 90) * Math.PI / 180);

            const largeArcFlag = 360 / d > 180 ? 1 : 0;
            const dPath = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

            parts.push(
               <path
                  key={i}
                  d={dPath}
                  fill={i < n ? color : "white"}
                  stroke="#94a3b8"
                  strokeWidth="2"
                  className="transition-all duration-500"
               />
            );
         }
         return <g transform="translate(50, 20)">{parts}</g>;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Fractions</h2>
                     <p className="text-slate-500 text-sm">Parts of a whole</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setModel('bar')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${model === 'bar' ? 'bg-blue-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        BAR MODEL
                     </button>
                     <button
                        onClick={() => setModel('circle')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${model === 'circle' ? 'bg-purple-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        CIRCLE MODEL
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Find an equivalent to 1/2 (but not 1/2!)</p>
                           <p className="text-xs opacity-80">Adjust the sliders to find another fraction that covers half the shape.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8">
                  <svg className="w-full max-w-[400px] h-[250px]" viewBox="0 0 320 250">
                     {model === 'bar' ? (
                        <>
                           {renderBar(num, den, model === 'bar' ? "#3b82f6" : "#a855f7")}
                           {showEquivalent && (
                              <g transform="translate(0, 60)">
                                 {renderBar(num * 2, den * 2, "#cbd5e1", true)}
                                 <text x="160" y="60" textAnchor="middle" className="text-[10px] fill-slate-400 font-bold italic">Equivalent: {num * 2}/{den * 2}</text>
                              </g>
                           )}
                        </>
                     ) : (
                        renderCircle(num, den, "#a855f7")
                     )}
                  </svg>

                  <div className="mt-8 flex items-center gap-8">
                     <div className="flex flex-col items-center">
                        <div className="text-5xl font-black text-slate-900 border-b-4 border-slate-900 pb-1 mb-1">{num}</div>
                        <div className="text-5xl font-black text-slate-900">{den}</div>
                     </div>
                     <div className="h-20 w-px bg-slate-200" />
                     <div className="text-center">
                        <div className="text-3xl font-black text-slate-400">{percentage.toFixed(0)}%</div>
                        <div className="text-[10px] font-bold text-slate-400 uppercase">of the whole</div>
                     </div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Numerator (Parts)</label>
                        <span className="text-2xl font-black text-blue-500">{num}</span>
                     </div>
                     <input
                        type="range" min="0" max={den} step="1" value={num}
                        onChange={(e) => setNum(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Denominator (Total)</label>
                        <span className="text-2xl font-black text-slate-900">{den}</span>
                     </div>
                     <input
                        type="range" min="1" max="12" step="1" value={den}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setDen(val);
                           if (num > val) setNum(val);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-900"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowEquivalent(!showEquivalent)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${showEquivalent ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showEquivalent ? 'üîç HIDE EQUIVALENT' : 'üîç SHOW EQUIVALENT'}
                  </button>

                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> The <strong>denominator</strong> tells you how many equal parts make a whole.
                        The <strong>numerator</strong> tells you how many of those parts you have.
                        Different fractions can represent the <strong>same amount</strong> (like 1/2 and 2/4)!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- AREA RENDERER (Grid Discovery & Formula Bridge) ---
   // Stage 1: Core insight = Area is the space inside a boundary.
   // Stage 2: Primary = width, height.
   // Stage 3: Resizable Grid + Counting Mode.
   // Stage 4: A = L √ó W.
   // Stage 5: State (w, h, showGrid) ‚Üí Derived (area).
   // Stage 6: Challenge = "Build Area 12".
   const AreaRenderer = () => {
      const [width, setWidth] = useState(4);
      const [height, setHeight] = useState(3);
      const [showGrid, setShowGrid] = useState(true);
      const [challengeMode, setChallengeMode] = useState(false);

      const area = width * height;
      const isChallengeMet = challengeMode && area === 12;

      const renderGrid = () => {
         const cells = [];
         const cellSize = 40;
         for (let r = 0; r < height; r++) {
            for (let c = 0; c < width; c++) {
               cells.push(
                  <rect
                     key={`${r}-${c}`}
                     x={c * cellSize}
                     y={r * cellSize}
                     width={cellSize - 1}
                     height={cellSize - 1}
                     fill={showGrid ? "#f8fafc" : "#3b82f6"}
                     stroke={showGrid ? "#cbd5e1" : "none"}
                     className="transition-all duration-300"
                  />
               );
               if (showGrid) {
                  cells.push(
                     <text
                        key={`t-${r}-${c}`}
                        x={c * cellSize + cellSize / 2}
                        y={r * cellSize + cellSize / 2 + 4}
                        textAnchor="middle"
                        className="text-[8px] fill-slate-300 font-bold"
                     >
                        {r * width + c + 1}
                     </text>
                  );
               }
            }
         }
         return cells;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Area of Rectangles</h2>
                     <p className="text-slate-500 text-sm">Measuring space with unit squares</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Build a rectangle with Area 12</p>
                           <p className="text-xs opacity-80">Adjust width and height until the total area is exactly 12.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-hidden">
                  <div className="relative">
                     <svg width={width * 40} height={height * 40} className="shadow-xl rounded-sm overflow-visible">
                        {renderGrid()}
                        {/* Dimension Labels */}
                        <g transform={`translate(${width * 20}, -15)`}>
                           <text textAnchor="middle" className="text-sm font-black fill-blue-600">{width} units</text>
                           <path d={`M ${-width * 20},5 L ${width * 20},5`} stroke="#3b82f6" strokeWidth="2" markerStart="url(#arrow)" markerEnd="url(#arrow)" />
                        </g>
                        <g transform={`translate(${-15}, ${height * 20}) rotate(-90)`}>
                           <text textAnchor="middle" className="text-sm font-black fill-blue-600">{height} units</text>
                           <path d={`M ${-height * 20},5 L ${height * 20},5`} stroke="#3b82f6" strokeWidth="2" />
                        </g>
                     </svg>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{width}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Width</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√ó</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{height}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Height</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{area}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Area</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üî Width</label>
                        <span className="text-2xl font-black text-blue-500">{width}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={width}
                        onChange={(e) => setWidth(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üï Height</label>
                        <span className="text-2xl font-black text-blue-500">{height}</span>
                     </div>
                     <input
                        type="range" min="1" max="8" step="1" value={height}
                        onChange={(e) => setHeight(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowGrid(!showGrid)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${showGrid ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showGrid ? 'üî¢ HIDE UNIT SQUARES' : 'üî¢ SHOW UNIT SQUARES'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Area is the number of <strong>unit squares</strong>
                        that fit inside a shape. Instead of counting them all one by one,
                        you can just multiply the <strong>width</strong> by the <strong>height</strong>!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- POSTURE ANALYZER RENDERER ---
   const PostureAnalyzerRenderer = () => {
      const [view, setView] = useState<'side' | 'front'>('side');
      const [headForward, setHeadForward] = useState(20); // 0-100
      const [shoulderRound, setShoulderRound] = useState(30); // 0-100
      const [showCorrections, setShowCorrections] = useState(false);

      const score = Math.max(0, 100 - (headForward * 0.5) - (shoulderRound * 0.5));

      return (
         <div className="w-full h-full bg-white flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Posture Analyzer</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Alignment & Ergonomics</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setView('side')}
                     className={`px-4 py-2 rounded-xl text-[10px] font-bold transition-all ${view === 'side' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-500'}`}
                  >
                     SIDE VIEW
                  </button>
                  <button
                     onClick={() => setView('front')}
                     className={`px-4 py-2 rounded-xl text-[10px] font-bold transition-all ${view === 'front' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-500'}`}
                  >
                     FRONT VIEW
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visual Assessment Area */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12">
                  <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-64 h-[400px] flex items-center justify-center">
                     {/* Human Skeleton Simplified */}
                     <svg className="w-full h-full overflow-visible" viewBox="0 0 100 200">
                        {view === 'side' ? (
                           <g className="transition-all duration-500">
                              {/* Spine */}
                              <path
                                 d={`M 50 180 Q 45 140 50 100 Q ${50 + shoulderRound / 10} 60 ${50 - headForward / 5} 30`}
                                 fill="none" stroke="#cbd5e1" strokeWidth="4" strokeLinecap="round"
                              />
                              {/* Head */}
                              <circle cx={50 - headForward / 5} cy="20" r="10" fill="#1e293b" />
                              {/* Shoulder */}
                              <circle cx={50 + shoulderRound / 10} cy="60" r="4" fill="#3b82f6" />
                              {/* Hip */}
                              <circle cx="50" cy="100" r="5" fill="#1e293b" />
                              {/* Leg */}
                              <line x1="50" y1="100" x2="50" y2="180" stroke="#1e293b" strokeWidth="4" />

                              {/* Correction Guides */}
                              {showCorrections && (
                                 <g className="animate-pulse">
                                    <line x1="50" y1="10" x2="50" y2="190" stroke="#10b981" strokeWidth="1" strokeDasharray="4 2" />
                                    <path d="M 40 30 L 50 30" stroke="#10b981" strokeWidth="2" markerEnd="url(#arrow)" />
                                    <path d="M 60 60 L 50 60" stroke="#10b981" strokeWidth="2" markerEnd="url(#arrow)" />
                                 </g>
                              )}
                           </g>
                        ) : (
                           <g className="transition-all duration-500">
                              {/* Torso */}
                              <rect x="35" y="60" width="30" height="40" rx="5" fill="#f1f5f9" stroke="#cbd5e1" strokeWidth="2" />
                              {/* Head */}
                              <circle cx="50" cy="30" r="12" fill="#1e293b" />
                              {/* Shoulders */}
                              <line x1="30" y1="60" x2="70" y2="60" stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                              {/* Hips */}
                              <line x1="35" y1="100" x2="65" y2="100" stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                              {/* Legs */}
                              <line x1="40" y1="100" x2="40" y2="180" stroke="#1e293b" strokeWidth="4" />
                              <line x1="60" y1="100" x2="60" y2="180" stroke="#1e293b" strokeWidth="4" />
                           </g>
                        )}
                        <defs>
                           <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse">
                              <path d="M 0 0 L 10 5 L 0 10 z" fill="#10b981" />
                           </marker>
                        </defs>
                     </svg>
                  </div>
               </div>

               {/* Controls & Analysis */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Posture Score</p>
                     <div className="text-5xl font-black text-slate-900">{Math.round(score)}<span className="text-lg text-slate-300">/100</span></div>
                     <p className={`text-[10px] font-bold mt-2 uppercase tracking-tight ${score > 80 ? 'text-emerald-500' : score > 60 ? 'text-amber-500' : 'text-red-500'}`}>
                        {score > 80 ? 'Excellent Alignment' : score > 60 ? 'Room for Improvement' : 'Correction Required'}
                     </p>
                  </div>

                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Simulation Controls</p>
                     <div className="space-y-4">
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HEAD FORWARD</span>
                              <span className="text-slate-900">{headForward}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={headForward}
                              onChange={(e) => setHeadForward(parseInt(e.target.value))}
                              className="w-full accent-slate-900"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">SHOULDER ROUNDING</span>
                              <span className="text-slate-900">{shoulderRound}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={shoulderRound}
                              onChange={(e) => setShoulderRound(parseInt(e.target.value))}
                              className="w-full accent-slate-900"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Alignment Check</p>
                     <ul className="space-y-2">
                        {[
                           { label: 'Ears over shoulders', status: headForward < 20 ? '‚úì' : '‚ö†Ô∏è', color: headForward < 20 ? 'text-emerald-500' : 'text-amber-500' },
                           { label: 'Shoulders back', status: shoulderRound < 30 ? '‚úì' : '‚ö†Ô∏è', color: shoulderRound < 30 ? 'text-emerald-500' : 'text-amber-500' },
                           { label: 'Hips level', status: '‚úì', color: 'text-emerald-500' },
                           { label: 'Neutral spine', status: (headForward + shoulderRound) < 50 ? '‚úì' : '‚ö†Ô∏è', color: (headForward + shoulderRound) < 50 ? 'text-emerald-500' : 'text-amber-500' }
                        ].map(item => (
                           <li key={item.label} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 text-[10px] font-bold">
                              <span className="text-slate-600">{item.label}</span>
                              <span className={item.color}>{item.status}</span>
                           </li>
                        ))}
                     </ul>
                  </div>

                  <button
                     onClick={() => setShowCorrections(!showCorrections)}
                     className={`mt-auto p-4 rounded-2xl font-black text-xs transition-all uppercase ${showCorrections ? 'bg-emerald-500 text-white' : 'bg-slate-900 text-white hover:bg-slate-800'
                        }`}
                  >
                     {showCorrections ? 'Hide Corrections' : 'Show Corrections'}
                  </button>
               </div>
            </div>
         </div>
      );
   };
   // --- HEART RATE ZONE RENDERER ---
   const HeartRateZoneRenderer = () => {
      const [age, setAge] = useState(25);
      const [restingHR, setRestingHR] = useState(60);
      const [intensity, setIntensity] = useState(50);

      const maxHR = 220 - age;
      const hrr = maxHR - restingHR;
      const targetHR = Math.round(restingHR + (hrr * intensity) / 100);

      const getZone = (hr: number) => {
         const pct = ((hr - restingHR) / hrr) * 100;
         if (intensity < 50) return { name: 'Warm Up', color: 'bg-slate-400', text: 'text-slate-400', desc: 'Light activity, preparing the body.' };
         if (intensity < 60) return { name: 'Zone 1: Recovery', color: 'bg-emerald-400', text: 'text-emerald-400', desc: 'Very light. Improves overall health and helps recovery.' };
         if (intensity < 70) return { name: 'Zone 2: Aerobic', color: 'bg-emerald-500', text: 'text-emerald-500', desc: 'Light. Build endurance and burns fat efficiently.' };
         if (intensity < 80) return { name: 'Zone 3: Tempo', color: 'bg-amber-500', text: 'text-amber-500', desc: 'Moderate. Improves aerobic capacity and circulation.' };
         if (intensity < 90) return { name: 'Zone 4: Threshold', color: 'bg-orange-500', text: 'text-orange-500', desc: 'Hard. Increases maximum performance capacity.' };
         return { name: 'Zone 5: Anaerobic', color: 'bg-red-500', text: 'text-red-500', desc: 'Maximum. Improves speed and neuromuscular system.' };
      };

      const zone = getZone(targetHR);

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Heart Rate Zone Trainer</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Target Heart Rate & Intensity</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Max HR</p>
                     <p className="text-lg font-black text-slate-900">{maxHR}</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Target</p>
                     <p className={`text-lg font-black ${zone.text}`}>{targetHR} <span className="text-[10px]">BPM</span></p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative flex flex-col items-center gap-12">
                     {/* Pulsing Heart */}
                     <div className="relative">
                        <div
                           className={`text-8xl transition-all duration-300 transform`}
                           style={{
                              animation: `pulse ${60 / targetHR}s infinite cubic-bezier(0.4, 0, 0.6, 1)`,
                              filter: `drop-shadow(0 0 20px ${zone.color.replace('bg-', '')})`
                           }}
                        >
                           ‚ù§Ô∏è
                        </div>
                        <style>{`
                           @keyframes pulse {
                              0%, 100% { transform: scale(1); }
                              50% { transform: scale(1.15); }
                           }
                        `}</style>
                     </div>

                     {/* Zone Gauge */}
                     <div className="w-64 h-8 bg-slate-100 rounded-full overflow-hidden flex border border-slate-200">
                        <div className="h-full bg-emerald-400" style={{ width: '10%' }} />
                        <div className="h-full bg-emerald-500" style={{ width: '10%' }} />
                        <div className="h-full bg-amber-500" style={{ width: '10%' }} />
                        <div className="h-full bg-orange-500" style={{ width: '10%' }} />
                        <div className="h-full bg-red-500" style={{ width: '10%' }} />
                        <div className="flex-1 bg-slate-200" />
                     </div>

                     <div className="text-center max-w-xs">
                        <h3 className={`text-2xl font-black uppercase tracking-tight ${zone.text}`}>{zone.name}</h3>
                        <p className="text-xs font-bold text-slate-500 mt-2 leading-relaxed">{zone.desc}</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">User Profile</p>
                     <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold text-slate-400">AGE</label>
                           <input
                              type="number" value={age}
                              onChange={(e) => setAge(Math.max(1, Math.min(100, parseInt(e.target.value) || 1)))}
                              className="w-full p-3 bg-white border border-slate-200 rounded-xl font-black text-sm focus:ring-2 focus:ring-slate-900 outline-none"
                           />
                        </div>
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold text-slate-400">RESTING HR</label>
                           <input
                              type="number" value={restingHR}
                              onChange={(e) => setRestingHR(Math.max(30, Math.min(120, parseInt(e.target.value) || 30)))}
                              className="w-full p-3 bg-white border border-slate-200 rounded-xl font-black text-sm focus:ring-2 focus:ring-slate-900 outline-none"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Exercise Intensity</p>
                     <div className="space-y-4">
                        <div className="flex justify-between items-end">
                           <span className="text-3xl font-black text-slate-900">{intensity}%</span>
                           <span className="text-[10px] font-bold text-slate-400 uppercase mb-1">of HR Reserve</span>
                        </div>
                        <input
                           type="range" min="0" max="100" value={intensity}
                           onChange={(e) => setIntensity(parseInt(e.target.value))}
                           className="w-full accent-slate-900"
                        />
                        <div className="flex justify-between text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                           <span>Rest</span>
                           <span>Light</span>
                           <span>Moderate</span>
                           <span>Hard</span>
                           <span>Max</span>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Karvonen Formula</p>
                     <p className="text-[10px] leading-relaxed text-slate-300">
                        Target HR = ((Max HR ‚àí Resting HR) √ó %Intensity) + Resting HR
                     </p>
                     <div className="mt-4 pt-4 border-t border-slate-800">
                        <p className="text-[10px] italic text-slate-500">This formula is more accurate than age-only calculations as it accounts for your fitness level (Resting HR).</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BREATHING GUIDE RENDERER ---
   const BreathingGuideRenderer = () => {
      const [pattern, setPattern] = useState<'box' | '478' | 'relax'>('box');
      const [isActive, setIsActive] = useState(false);
      const [phase, setPhase] = useState<'In' | 'Hold' | 'Out' | 'Hold_Out'>('In');
      const [timeLeft, setTimeLeft] = useState(4);

      const patterns = {
         box: { in: 4, hold: 4, out: 4, hold_out: 4, label: 'Box Breathing' },
         '478': { in: 4, hold: 7, out: 8, hold_out: 0, label: '4-7-8 Technique' },
         relax: { in: 4, hold: 0, out: 6, hold_out: 0, label: 'Relaxation (4-6)' }
      };

      useEffect(() => {
         let timer: any;
         if (isActive) {
            timer = setInterval(() => {
               setTimeLeft(prev => {
                  if (prev <= 1) {
                     // Switch phase
                     const current = patterns[pattern];
                     if (phase === 'In') {
                        if (current.hold > 0) { setPhase('Hold'); return current.hold; }
                        else { setPhase('Out'); return current.out; }
                     } else if (phase === 'Hold') {
                        setPhase('Out'); return current.out;
                     } else if (phase === 'Out') {
                        if (current.hold_out > 0) { setPhase('Hold_Out'); return current.hold_out; }
                        else { setPhase('In'); return current.in; }
                     } else {
                        setPhase('In'); return current.in;
                     }
                  }
                  return prev - 1;
               });
            }, 1000);
         } else {
            setPhase('In');
            setTimeLeft(patterns[pattern].in);
         }
         return () => clearInterval(timer);
      }, [isActive, phase, pattern]);

      const getScale = () => {
         if (!isActive) return 1;
         if (phase === 'In') return 1 + (1 - timeLeft / patterns[pattern].in) * 0.5;
         if (phase === 'Hold') return 1.5;
         if (phase === 'Out') return 1 + (timeLeft / patterns[pattern].out) * 0.5;
         return 1;
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Breathing Guide</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Autonomic Regulation</p>
               </div>
               <div className="flex gap-2">
                  {Object.entries(patterns).map(([key, p]) => (
                     <button
                        key={key} onClick={() => { setPattern(key as any); setIsActive(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${pattern === key ? 'bg-white text-slate-950' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}
                     >
                        {p.label}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative flex items-center justify-center p-12 overflow-hidden bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
                  <div className="absolute inset-0 opacity-20 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '50px 50px' }} />

                  <div className="relative flex flex-col items-center">
                     {/* Breathing Circle */}
                     <div
                        className="w-64 h-64 rounded-full border-4 border-emerald-500/30 flex items-center justify-center transition-all duration-1000 ease-linear"
                        style={{ transform: `scale(${getScale()})`, backgroundColor: phase.includes('Hold') ? 'rgba(16, 185, 129, 0.1)' : 'transparent' }}
                     >
                        <div className="w-48 h-48 rounded-full bg-emerald-500/20 blur-2xl animate-pulse" />
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black tracking-tighter text-emerald-400">{phase.replace('_', ' ')}</span>
                           <span className="text-xl font-mono text-emerald-500/50">{timeLeft}s</span>
                        </div>
                     </div>

                     <button
                        onClick={() => setIsActive(!isActive)}
                        className={`mt-16 px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest ${isActive ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-emerald-500 text-slate-950 shadow-[0_0_30px_rgba(16,185,129,0.3)]'}`}
                     >
                        {isActive ? 'Stop Session' : 'Start Breathing'}
                     </button>
                  </div>
               </div>

               {/* Info Panel */}
               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Current Technique</p>
                     <h3 className="text-2xl font-black text-white">{patterns[pattern].label}</h3>
                     <div className="p-4 bg-slate-950 rounded-2xl border border-slate-800 space-y-3">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500">INHALE</span>
                           <span className="text-emerald-400">{patterns[pattern].in}s</span>
                        </div>
                        {patterns[pattern].hold > 0 && (
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HOLD</span>
                              <span className="text-emerald-400">{patterns[pattern].hold}s</span>
                           </div>
                        )}
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500">EXHALE</span>
                           <span className="text-emerald-400">{patterns[pattern].out}s</span>
                        </div>
                        {patterns[pattern].hold_out > 0 && (
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HOLD</span>
                              <span className="text-emerald-400">{patterns[pattern].hold_out}s</span>
                           </div>
                        )}
                     </div>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Science</p>
                        <p className="text-[10px] leading-relaxed text-slate-300">
                           By extending your <strong>exhale</strong> longer than your inhale, you stimulate the <strong>Vagus Nerve</strong>, which signals your brain to switch from "Fight or Flight" to "Rest and Digest" mode.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- PLATE METHOD RENDERER ---
   const PlateMethodRenderer = () => {
      const [portions, setPortions] = useState({ veggies: 50, protein: 25, carbs: 25 });
      const [mealType, setMealType] = useState<'balanced' | 'low_carb' | 'high_protein'>('balanced');

      const setPreset = (type: 'balanced' | 'low_carb' | 'high_protein') => {
         setMealType(type);
         if (type === 'balanced') setPortions({ veggies: 50, protein: 25, carbs: 25 });
         if (type === 'low_carb') setPortions({ veggies: 60, protein: 30, carbs: 10 });
         if (type === 'high_protein') setPortions({ veggies: 40, protein: 40, carbs: 20 });
      };

      const getScore = () => {
         const { veggies, protein, carbs } = portions;
         let score = 100;
         if (veggies < 40) score -= (40 - veggies) * 2;
         if (protein < 20) score -= (20 - protein) * 2;
         if (carbs > 40) score -= (carbs - 40) * 1.5;
         return Math.max(0, Math.round(score));
      };

      const score = getScore();

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">The Plate Method</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Visual Portion Control</p>
               </div>
               <div className="flex gap-2">
                  {(['balanced', 'low_carb', 'high_protein'] as const).map(t => (
                     <button
                        key={t} onClick={() => setPreset(t)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${mealType === t ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {t.replace('_', ' ')}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visual Plate */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative w-80 h-80 bg-white rounded-full shadow-2xl border-[12px] border-slate-100 flex items-center justify-center overflow-hidden">
                     <svg viewBox="0 0 100 100" className="absolute inset-0 w-full h-full -rotate-90">
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#10b981" strokeWidth="80"
                           strokeDasharray={`${portions.veggies} 100`}
                        />
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#f59e0b" strokeWidth="80"
                           strokeDasharray={`${portions.protein} 100`}
                           strokeDashoffset={`-${portions.veggies}`}
                        />
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#3b82f6" strokeWidth="80"
                           strokeDasharray={`${portions.carbs} 100`}
                           strokeDashoffset={`-${portions.veggies + portions.protein}`}
                        />
                     </svg>

                     <div className="absolute inset-0 pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">ü•¶</span>
                           <span className="text-[10px] font-black text-emerald-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">VEGGIES</span>
                        </div>
                        <div className="absolute top-1/4 right-1/4 translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">üçó</span>
                           <span className="text-[10px] font-black text-amber-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">PROTEIN</span>
                        </div>
                        <div className="absolute bottom-1/4 right-1/2 translate-x-1/2 translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">üçö</span>
                           <span className="text-[10px] font-black text-blue-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">CARBS</span>
                        </div>
                     </div>

                     <div className="absolute w-20 h-20 bg-white rounded-full shadow-lg flex flex-col items-center justify-center border-4 border-slate-50">
                        <span className="text-[8px] font-black text-slate-400 uppercase">Score</span>
                        <span className="text-2xl font-black text-slate-900">{score}</span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Adjust Portions (%)</p>
                     <div className="space-y-6">
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-emerald-600">VEGETABLES</span>
                              <span className="text-slate-900">{portions.veggies}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.veggies}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.protein / (portions.protein + portions.carbs || 1);
                                 setPortions({
                                    veggies: val,
                                    protein: Math.round(remaining * ratio),
                                    carbs: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-emerald-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-amber-600">PROTEIN</span>
                              <span className="text-slate-900">{portions.protein}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.protein}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.veggies / (portions.veggies + portions.carbs || 1);
                                 setPortions({
                                    protein: val,
                                    veggies: Math.round(remaining * ratio),
                                    carbs: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-amber-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-blue-600">CARBOHYDRATES</span>
                              <span className="text-slate-900">{portions.carbs}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.carbs}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.veggies / (portions.veggies + portions.protein || 1);
                                 setPortions({
                                    carbs: val,
                                    veggies: Math.round(remaining * ratio),
                                    protein: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-blue-500"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Why this works</p>
                     <ul className="space-y-3">
                        <li className="flex gap-3">
                           <span className="text-emerald-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Veggies (50%):</strong> High fiber and nutrients, low calorie density.</p>
                        </li>
                        <li className="flex gap-3">
                           <span className="text-amber-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Protein (25%):</strong> Essential for muscle repair and satiety.</p>
                        </li>
                        <li className="flex gap-3">
                           <span className="text-blue-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Carbs (25%):</strong> Primary energy source for brain and body.</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GRAVITATIONAL PE RENDERER (PE = mgh) ---
   const GravitationalPERenderer = () => {
      const [height, setHeight] = useState(10); // meters
      const [mass, setMass] = useState(5);     // kg
      const [gravity, setGravity] = useState(9.8); // m/s^2
      const [isDropping, setIsDropping] = useState(false);
      const [currentHeight, setCurrentHeight] = useState(10);
      const [velocity, setVelocity] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);
      const [targetPE, setTargetPE] = useState(500);

      const planets = [
         { name: 'Earth', g: 9.8, color: 'text-blue-400' },
         { name: 'Moon', g: 1.6, color: 'text-slate-400' },
         { name: 'Mars', g: 3.7, color: 'text-orange-400' },
         { name: 'Jupiter', g: 24.8, color: 'text-amber-600' }
      ];

      const pe = mass * gravity * height;
      const currentPE = mass * gravity * currentHeight;
      const ke = 0.5 * mass * velocity * velocity;
      const totalE = pe; // Initial total energy

      useEffect(() => {
         let animationFrame: number;
         if (isDropping && currentHeight > 0) {
            let lastTime = performance.now();
            const animate = (time: number) => {
               const dt = (time - lastTime) / 1000;
               lastTime = time;

               setCurrentHeight(prev => {
                  const newHeight = prev - velocity * dt - 0.5 * gravity * dt * dt;
                  if (newHeight <= 0) {
                     setIsDropping(false);
                     setVelocity(Math.sqrt(2 * gravity * height)); // Final velocity
                     return 0;
                  }
                  return newHeight;
               });
               setVelocity(v => v + gravity * dt);
               animationFrame = requestAnimationFrame(animate);
            };
            animationFrame = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationFrame);
      }, [isDropping, gravity, height]);

      const reset = () => {
         setIsDropping(false);
         setCurrentHeight(height);
         setVelocity(0);
      };

      useEffect(() => {
         reset();
      }, [height, mass, gravity]);

      const isChallengeMet = challengeMode && Math.abs(pe - targetPE) < 10;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Gravitational Potential Energy</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">PE = mgh</p>
               </div>
               <div className="flex items-center gap-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'}`}
                  >
                     {challengeMode ? 'Exit Challenge' : 'Challenge Mode'}
                  </button>
                  <div className="flex gap-1">
                     {planets.map(p => (
                        <button
                           key={p.name}
                           onClick={() => setGravity(p.g)}
                           className={`px-2 py-1 rounded-md text-[10px] font-bold transition-all ${gravity === p.g ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                        >
                           {p.name}
                        </button>
                     ))}
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Area */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  {/* Ground */}
                  <div className="absolute bottom-20 left-10 right-10 h-2 bg-slate-200 rounded-full" />

                  {/* Object */}
                  <div
                     className="absolute w-12 h-12 bg-indigo-600 rounded-2xl shadow-lg flex items-center justify-center transition-transform duration-75"
                     style={{
                        bottom: `${88 + (currentHeight * 20)}px`,
                        transform: `rotate(${velocity * 2}deg)`
                     }}
                  >
                     <span className="text-white font-black text-xs">{mass}kg</span>
                  </div>

                  {/* Height Indicator */}
                  <div
                     className="absolute left-20 border-l-2 border-dashed border-slate-300 flex flex-col justify-between py-2"
                     style={{ bottom: '88px', height: `${height * 20}px` }}
                  >
                     <div className="w-4 h-0.5 bg-slate-300" />
                     <div className="absolute top-1/2 -translate-y-1/2 -left-8 text-[10px] font-bold text-slate-400 rotate-90 whitespace-nowrap">
                        HEIGHT: {height}m
                     </div>
                     <div className="w-4 h-0.5 bg-slate-300" />
                  </div>

                  {/* Energy Bars */}
                  <div className="absolute right-10 bottom-32 flex gap-4 items-end h-48">
                     <div className="flex flex-col items-center gap-2">
                        <div className="w-8 bg-slate-100 rounded-t-lg relative overflow-hidden h-full">
                           <div
                              className="absolute bottom-0 w-full bg-emerald-500 transition-all duration-75"
                              style={{ height: `${(currentPE / (totalE || 1)) * 100}%` }}
                           />
                        </div>
                        <span className="text-[8px] font-black text-slate-400 uppercase">PE</span>
                     </div>
                     <div className="flex flex-col items-center gap-2">
                        <div className="w-8 bg-slate-100 rounded-t-lg relative overflow-hidden h-full">
                           <div
                              className="absolute bottom-0 w-full bg-blue-500 transition-all duration-75"
                              style={{ height: `${(ke / (totalE || 1)) * 100}%` }}
                           />
                        </div>
                        <span className="text-[8px] font-black text-slate-400 uppercase">KE</span>
                     </div>
                  </div>

                  {/* Controls Overlay */}
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsDropping(true)}
                        disabled={isDropping || currentHeight <= 0}
                        className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black text-sm shadow-xl hover:bg-indigo-700 disabled:opacity-50 transition-all"
                     >
                        DROP OBJECT
                     </button>
                     <button
                        onClick={reset}
                        className="px-8 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-sm hover:bg-slate-200 transition-all"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               {/* Right Panel */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  {challengeMode && (
                     <div className={`p-6 rounded-3xl border-2 transition-all ${isChallengeMet ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}`}>
                        <div className="flex items-center gap-3 mb-4">
                           <div className={`w-8 h-8 rounded-full flex items-center justify-center text-lg ${isChallengeMet ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'}`}>
                              {isChallengeMet ? '‚úì' : 'üéØ'}
                           </div>
                           <div>
                              <p className="font-bold text-slate-800 text-sm">Goal: Reach {targetPE}J of PE</p>
                              <p className="text-[10px] text-slate-500">Adjust mass and height to hit the target.</p>
                           </div>
                        </div>
                        {isChallengeMet && <div className="text-emerald-600 font-black text-center animate-bounce">CHALLENGE COMPLETE!</div>}
                     </div>
                  )}

                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">MASS (kg)</span>
                           <span className="text-slate-900">{mass} kg</span>
                        </div>
                        <input
                           type="range" min="1" max="20" value={mass}
                           onChange={(e) => setMass(parseInt(e.target.value))}
                           className="w-full accent-indigo-600"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">HEIGHT (m)</span>
                           <span className="text-slate-900">{height} m</span>
                        </div>
                        <input
                           type="range" min="1" max="20" value={height}
                           onChange={(e) => setHeight(parseInt(e.target.value))}
                           className="w-full accent-indigo-600"
                        />
                     </div>
                  </div>

                  <div className="mt-auto grid grid-cols-2 gap-4">
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Potential Energy</p>
                        <p className="text-xl font-black text-emerald-600">{Math.round(currentPE)}J</p>
                     </div>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Kinetic Energy</p>
                        <p className="text-xl font-black text-blue-600">{Math.round(ke)}J</p>
                     </div>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm col-span-2">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Velocity</p>
                        <p className="text-xl font-black text-slate-900">{velocity.toFixed(1)} m/s</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CHEMICAL PE RENDERER (Bond Energy) ---
   const ChemicalPERenderer = () => {
      const [reaction, setReaction] = useState<'exothermic' | 'endothermic'>('exothermic');
      const [isReacting, setIsReacting] = useState(false);
      const [progress, setProgress] = useState(0);

      const reactions = {
         exothermic: {
            name: 'Combustion (Methane)',
            reactants: 'CH‚ÇÑ + 2O‚ÇÇ',
            products: 'CO‚ÇÇ + 2H‚ÇÇO',
            energyDelta: -890, // kJ/mol
            activationEnergy: 100,
            desc: 'Energy is released as new, stronger bonds form.'
         },
         endothermic: {
            name: 'Photosynthesis (Simplified)',
            reactants: '6CO‚ÇÇ + 6H‚ÇÇO',
            products: 'C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ',
            energyDelta: 2800, // kJ/mol
            activationEnergy: 500,
            desc: 'Energy is absorbed to break strong bonds and form weaker ones.'
         }
      };

      const current = reactions[reaction];

      useEffect(() => {
         let interval: any;
         if (isReacting) {
            interval = setInterval(() => {
               setProgress(p => {
                  if (p >= 100) {
                     setIsReacting(false);
                     return 100;
                  }
                  return p + 2;
               });
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isReacting]);

      const reset = () => {
         setIsReacting(false);
         setProgress(0);
      };

      useEffect(() => {
         reset();
      }, [reaction]);

      const getEnergyY = (x: number) => {
         const startY = 200;
         const peakY = startY - current.activationEnergy * 0.2;
         const endY = startY - current.energyDelta * 0.1;

         if (x < 30) return startY;
         if (x < 50) {
            const t = (x - 30) / 20;
            return startY + (peakY - startY) * (1 - Math.cos(t * Math.PI)) / 2;
         }
         if (x < 70) {
            const t = (x - 50) / 20;
            return peakY + (endY - peakY) * (1 - Math.cos(t * Math.PI)) / 2;
         }
         return endY;
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Chemical Potential Energy</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Bond Energy & Reactions</p>
               </div>
               <div className="flex gap-2">
                  {(['exothermic', 'endothermic'] as const).map(type => (
                     <button
                        key={type}
                        onClick={() => setReaction(type)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${reaction === type ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {type}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex flex-col p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="flex-1 relative">
                     <svg viewBox="0 0 400 300" className="w-full h-full">
                        <line x1="40" y1="260" x2="380" y2="260" stroke="#cbd5e1" strokeWidth="2" markerEnd="url(#arrow)" />
                        <line x1="40" y1="260" x2="40" y2="20" stroke="#cbd5e1" strokeWidth="2" markerEnd="url(#arrow)" />
                        <text x="380" y="275" textAnchor="end" className="text-[8px] font-bold fill-slate-400">REACTION PROGRESS</text>
                        <text x="35" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">POTENTIAL ENERGY</text>

                        <path
                           d={`M 40,200 L 120,200 ${Array.from({ length: 41 }).map((_, i) => {
                              const x = 120 + i * 4;
                              const progressX = (i / 40) * 40 + 30;
                              return `L ${x},${getEnergyY(progressX)}`;
                           }).join(' ')} L 360,${getEnergyY(70)}`}
                           fill="none"
                           stroke="#6366f1"
                           strokeWidth="4"
                           strokeLinecap="round"
                        />

                        {isReacting && (
                           <circle
                              cx={120 + (progress / 100) * 160}
                              cy={getEnergyY(30 + (progress / 100) * 40)}
                              r="6"
                              fill="#ef4444"
                              className="animate-pulse"
                           />
                        )}

                        <text x="80" y="190" textAnchor="middle" className="text-[10px] font-black fill-slate-600">REACTANTS</text>
                        <text x="320" y={getEnergyY(70) - 10} textAnchor="middle" className="text-[10px] font-black fill-slate-600">PRODUCTS</text>

                        <line
                           x1="360" y1="200" x2="360" y2={getEnergyY(70)}
                           stroke={reaction === 'exothermic' ? '#10b981' : '#ef4444'}
                           strokeWidth="2"
                           strokeDasharray="4"
                           markerEnd="url(#arrow)"
                        />
                        <text x="365" y={(200 + getEnergyY(70)) / 2} className="text-[8px] font-bold fill-slate-500">
                           ŒîH = {current.energyDelta} kJ/mol
                        </text>
                     </svg>

                     <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-4">
                        <button
                           onClick={() => setIsReacting(true)}
                           disabled={isReacting}
                           className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black text-sm shadow-xl hover:bg-indigo-700 disabled:opacity-50 transition-all"
                        >
                           START REACTION
                        </button>
                        <button
                           onClick={reset}
                           className="px-8 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-sm hover:bg-slate-200 transition-all"
                        >
                           RESET
                        </button>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Reaction Details</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Equation</span>
                           <span className="text-sm font-mono font-bold text-indigo-600">{current.reactants} ‚Üí {current.products}</span>
                        </div>
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Type</span>
                           <span className={`text-[10px] font-black px-2 py-1 rounded-full ${reaction === 'exothermic' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                              {reaction.toUpperCase()}
                           </span>
                        </div>
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        {current.desc}
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <p className="text-[10px] font-black text-indigo-900 uppercase mb-2">Bond Energy Rule</p>
                        <p className="text-[10px] text-indigo-700 leading-relaxed">
                           Breaking bonds <strong>requires</strong> energy (+).<br />
                           Forming bonds <strong>releases</strong> energy (-).
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENERGY CONSERVATION RENDERER ---
   const EnergyConservationRenderer = () => {
      const [scenario, setScenario] = useState<'pendulum' | 'coaster' | 'ball'>('pendulum');
      const [friction, setFriction] = useState(0); // 0-100
      const [isPlaying, setIsPlaying] = useState(false);
      const [time, setTime] = useState(0);

      const [pe, setPe] = useState(100);
      const [ke, setKe] = useState(0);
      const [thermal, setThermal] = useState(0);

      useEffect(() => {
         let animationId: number;
         if (isPlaying) {
            const animate = () => {
               setTime(t => t + 0.05);
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isPlaying]);

      useEffect(() => {
         const damping = friction * 0.001;
         let newPe = 0;
         let newKe = 0;

         if (scenario === 'pendulum') {
            const amplitude = 100 * Math.exp(-damping * time);
            const angle = amplitude * Math.cos(2 * time);
            newPe = Math.abs(angle);
            newKe = amplitude - newPe;
         } else if (scenario === 'ball') {
            const gravity = 9.8;
            const h0 = 100;
            const period = Math.sqrt(2 * h0 / gravity) * 2;
            const tInPeriod = time % period;
            const halfPeriod = period / 2;

            let h;
            if (tInPeriod < halfPeriod) {
               h = h0 - 0.5 * gravity * tInPeriod * tInPeriod;
            } else {
               const tUp = tInPeriod - halfPeriod;
               const v0 = gravity * halfPeriod;
               h = v0 * tUp - 0.5 * gravity * tUp * tUp;
            }

            const bounceCount = Math.floor(time / period);
            const energyLoss = Math.pow(1 - friction / 200, bounceCount);
            newPe = Math.max(0, h * energyLoss);
            newKe = Math.max(0, (h0 - h) * energyLoss);
         } else if (scenario === 'coaster') {
            const x = (time * 50) % 400;
            const h = 50 + 40 * Math.sin(x / 50);
            const energyLoss = Math.exp(-damping * time);
            newPe = h * energyLoss;
            newKe = (100 - h) * energyLoss;
         }

         setPe(newPe);
         setKe(newKe);
         setThermal(100 - (newPe + newKe));
      }, [time, scenario, friction]);

      const reset = () => {
         setTime(0);
         setThermal(0);
         setIsPlaying(false);
      };

      useEffect(() => {
         reset();
      }, [scenario]);

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Energy Conservation Lab</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Total Energy is Constant</p>
               </div>
               <div className="flex gap-2">
                  {(['pendulum', 'coaster', 'ball'] as const).map(s => (
                     <button
                        key={s}
                        onClick={() => setScenario(s)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${scenario === s ? 'bg-white text-slate-900' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-12 overflow-hidden bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-full h-full flex items-center justify-center">
                     {scenario === 'pendulum' && (
                        <div className="relative h-64 w-64 flex flex-col items-center">
                           <div className="w-32 h-2 bg-slate-700 rounded-full" />
                           <div
                              className="absolute top-0 origin-top transition-transform duration-75"
                              style={{ transform: `rotate(${(pe - 50) * 0.8}deg)`, height: '200px' }}
                           >
                              <div className="w-1 h-full bg-slate-500 mx-auto" />
                              <div className="w-10 h-10 bg-indigo-500 rounded-full shadow-[0_0_20px_rgba(99,102,241,0.5)] -mt-5 mx-auto" />
                           </div>
                        </div>
                     )}

                     {scenario === 'ball' && (
                        <div className="relative h-64 w-64">
                           <div className="absolute bottom-0 w-full h-2 bg-slate-700 rounded-full" />
                           <div
                              className="absolute left-1/2 -translate-x-1/2 w-12 h-12 bg-emerald-500 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.5)] transition-all duration-75"
                              style={{ bottom: `${8 + pe * 2}px` }}
                           />
                        </div>
                     )}

                     {scenario === 'coaster' && (
                        <div className="relative h-64 w-full px-12">
                           <svg viewBox="0 0 400 200" className="w-full h-full">
                              <path
                                 d="M 0,150 Q 100,50 200,150 T 400,150"
                                 fill="none" stroke="#475569" strokeWidth="4" strokeLinecap="round"
                              />
                              <circle
                                 cx={(time * 50) % 400}
                                 cy={150 - (100 - (50 + 40 * Math.sin(((time * 50) % 400) / 50)))}
                                 r="10" fill="#f59e0b"
                              />
                           </svg>
                        </div>
                     )}
                  </div>

                  <div className="absolute top-10 right-10 flex flex-col gap-4 bg-slate-900/80 backdrop-blur-md p-6 rounded-3xl border border-slate-700 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Energy Distribution</p>
                     <div className="flex gap-4 h-32 items-end">
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-blue-500 transition-all duration-75" style={{ height: `${pe}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-blue-400">PE</span>
                        </div>
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-emerald-500 transition-all duration-75" style={{ height: `${ke}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-emerald-400">KE</span>
                        </div>
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-red-500 transition-all duration-75" style={{ height: `${thermal}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-red-400">HEAT</span>
                        </div>
                     </div>
                     <div className="mt-4 pt-4 border-t border-slate-800">
                        <div className="flex justify-between text-[10px] font-black">
                           <span className="text-slate-500">TOTAL ENERGY</span>
                           <span className="text-white">100%</span>
                        </div>
                     </div>
                  </div>

                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`px-10 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-xl ${isPlaying ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-white text-slate-950'}`}
                     >
                        {isPlaying ? 'PAUSE' : 'START SIM'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-10 py-4 bg-slate-800 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-700 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-800 border-l border-slate-700 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-400 uppercase">Friction / Damping</span>
                           <span className="text-white">{friction}%</span>
                        </div>
                        <input
                           type="range" min="0" max="100" value={friction}
                           onChange={(e) => setFriction(parseInt(e.target.value))}
                           className="w-full accent-white"
                        />
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl border border-slate-700">
                     <p className="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">The Law</p>
                     <p className="text-xs leading-relaxed text-slate-300 italic">
                        "Energy cannot be created or destroyed; it can only be changed from one form to another."
                     </p>
                     <p className="text-[10px] mt-4 text-slate-500 leading-relaxed">
                        Notice how the Total Energy (PE + KE + Heat) always sums to 100%. Friction doesn't "destroy" energy; it transforms it into thermal energy (Heat).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MACHINE EFFICIENCY RENDERER (Sankey Diagrams) ---
   const MachineEfficiencyRenderer = () => {
      const [machine, setMachine] = useState<'car' | 'bulb' | 'motor'>('car');

      const machines = {
         car: {
            name: 'Internal Combustion Engine',
            useful: 25,
            waste: 75,
            usefulLabel: 'Kinetic Energy',
            wasteLabel: 'Thermal Energy (Heat)',
            desc: 'Most energy in a car is lost as heat through the exhaust and radiator.'
         },
         bulb: {
            name: 'Incandescent Lightbulb',
            useful: 5,
            waste: 95,
            usefulLabel: 'Light Energy',
            wasteLabel: 'Thermal Energy (Heat)',
            desc: 'Incandescent bulbs are highly inefficient, converting most electricity to heat.'
         },
         motor: {
            name: 'Electric Motor',
            useful: 85,
            waste: 15,
            usefulLabel: 'Kinetic Energy',
            wasteLabel: 'Heat & Sound',
            desc: 'Electric motors are very efficient, with minimal energy lost to friction and heat.'
         }
      };

      const current = machines[machine];
      const usefulWidth = (current.useful / 100) * 200;
      const wasteWidth = (current.waste / 100) * 200;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Machine Efficiency</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Sankey Diagram Visualization</p>
               </div>
               <div className="flex gap-2">
                  {(['car', 'bulb', 'motor'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMachine(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${machine === m ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 500 400" className="w-full h-full max-w-lg">
                     <path
                        d="M 50,150 L 200,150 L 200,250 L 50,250 Z"
                        fill="#94a3b8" opacity="0.3"
                     />
                     <text x="125" y="205" textAnchor="middle" className="text-[10px] font-black fill-slate-500">INPUT ENERGY (100%)</text>

                     <path
                        d={`M 200,150 L 450,150 L 450,${150 + usefulWidth} L 200,${150 + usefulWidth} Z`}
                        fill="#10b981" className="transition-all duration-700"
                     />
                     <text x="325" y={150 + usefulWidth / 2 + 5} textAnchor="middle" className="text-[10px] font-black fill-white">
                        USEFUL: {current.useful}%
                     </text>
                     <text x="455" y={150 + usefulWidth / 2 + 5} className="text-[8px] font-bold fill-emerald-600">{current.usefulLabel}</text>

                     <path
                        d={`M 200,${150 + usefulWidth} Q 200,350 350,350 L 350,${350 + wasteWidth} Q 200,${350 + wasteWidth} 200,250 Z`}
                        fill="#ef4444" className="transition-all duration-700"
                     />
                     <text x="275" y={350 + wasteWidth / 2 + 5} textAnchor="middle" className="text-[10px] font-black fill-white">
                        WASTE: {current.waste}%
                     </text>
                     <text x="355" y={350 + wasteWidth / 2 + 5} className="text-[8px] font-bold fill-red-600">{current.wasteLabel}</text>

                     <g transform="translate(50, 50)">
                        <rect width="180" height="60" rx="12" fill="#f8fafc" stroke="#e2e8f0" strokeWidth="1" />
                        <text x="90" y="25" textAnchor="middle" className="text-[8px] font-black fill-slate-400 uppercase">Efficiency Formula</text>
                        <text x="90" y="45" textAnchor="middle" className="text-xs font-black fill-slate-900">
                           (Useful / Total) √ó 100 = {current.useful}%
                        </text>
                     </g>
                  </svg>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Machine Profile</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">
                        {current.desc}
                     </p>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        In any energy transformation, some energy is always "degraded" into less useful forms, usually <strong>thermal energy</strong> (heat). This is why machines get hot when they run!
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p className="text-[10px] font-black text-emerald-900 uppercase mb-2">Efficiency Tip</p>
                        <p className="text-[10px] text-emerald-700 leading-relaxed">
                           Higher efficiency means less energy is wasted, reducing costs and environmental impact.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CONVECTION RENDERER (Fluid Circulation) ---
   const ConvectionRenderer = () => {
      const [isHeating, setIsHeating] = useState(false);
      const [heatPos, setHeatPos] = useState(50); // % from left
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number, temp: number }[]>([]);

      useEffect(() => {
         const initial = [];
         for (let i = 0; i < 50; i++) {
            initial.push({
               x: Math.random() * 400,
               y: Math.random() * 300,
               vx: (Math.random() - 0.5) * 2,
               vy: (Math.random() - 0.5) * 2,
               temp: 20
            });
         }
         setParticles(initial);
      }, []);

      useEffect(() => {
         let animationId: number;
         const animate = () => {
            setParticles(prev => prev.map(p => {
               let { x, y, vx, vy, temp } = p;
               const distToHeat = Math.abs(x - (heatPos * 4));
               if (isHeating && y > 250 && distToHeat < 50) {
                  temp = Math.min(100, temp + 2);
               } else {
                  temp = Math.max(20, temp - 0.1);
               }
               const buoyancy = (temp - 20) * 0.05;
               vy -= buoyancy;
               vy += 0.1;
               vx *= 0.98;
               vy *= 0.98;
               x += vx;
               y += vy;
               if (x < 0) { x = 0; vx *= -1; }
               if (x > 400) { x = 400; vx *= -1; }
               if (y < 0) { y = 0; vy *= -1; }
               if (y > 300) { y = 300; vy *= -0.5; temp -= 1; }
               const centerX = 200;
               if (temp > 50) vx += (x < centerX ? -0.1 : 0.1);
               return { x, y, vx, vy, temp };
            }));
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isHeating, heatPos]);

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Convection Currents</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Heat Transfer in Fluids</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">HEAT SOURCE POSITION</span>
                  <input
                     type="range" min="10" max="90" value={heatPos}
                     onChange={(e) => setHeatPos(parseInt(e.target.value))}
                     className="w-32 accent-red-500"
                  />
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="relative w-[400px] h-[300px] border-2 border-slate-800 rounded-xl overflow-hidden bg-slate-900/50">
                     {particles.map((p, i) => (
                        <div
                           key={i}
                           className="absolute w-3 h-3 rounded-full blur-[2px] transition-colors duration-300"
                           style={{
                              left: `${p.x}px`,
                              top: `${p.y}px`,
                              backgroundColor: `rgb(${Math.min(255, p.temp * 2.5)}, 100, ${Math.max(100, 255 - p.temp * 2)})`,
                              opacity: 0.6
                           }}
                        />
                     ))}
                     <div
                        className={`absolute bottom-0 h-4 w-20 -translate-x-1/2 rounded-t-xl transition-all duration-500 ${isHeating ? 'bg-red-500 shadow-[0_-10px_30px_rgba(239,68,68,0.5)]' : 'bg-slate-800'}`}
                        style={{ left: `${heatPos}%` }}
                     />
                  </div>
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2">
                     <button
                        onMouseDown={() => setIsHeating(true)}
                        onMouseUp={() => setIsHeating(false)}
                        onMouseLeave={() => setIsHeating(false)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-red-500 text-white scale-95' : 'bg-white text-slate-950'}`}
                     >
                        HOLD TO HEAT
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Mechanism</p>
                     <h3 className="text-2xl font-black text-white">How it Works</h3>
                     <div className="space-y-4">
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 font-black">1</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Heat source warms the fluid at the bottom.
                           </p>
                        </div>
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 font-black">2</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Warm fluid becomes <strong>less dense</strong> and rises.
                           </p>
                        </div>
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-black">3</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Cooler, denser fluid sinks to take its place, creating a <strong>circulation loop</strong>.
                           </p>
                        </div>
                     </div>
                  </div>
                  <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700 mt-auto">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Real World Examples</p>
                     <ul className="text-[10px] text-slate-300 space-y-2">
                        <li>‚Ä¢ Boiling water in a pot</li>
                        <li>‚Ä¢ Atmospheric wind patterns</li>
                        <li>‚Ä¢ Tectonic plate movement (Mantle)</li>
                        <li>‚Ä¢ Ocean currents</li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SPECIFIC HEAT RENDERER (Q = mcŒîT) ---
   const SpecificHeatRenderer = () => {
      const [material, setMaterial] = useState<'water' | 'iron' | 'aluminum'>('water');
      const [mass, setMass] = useState(1); // kg
      const [isHeating, setIsHeating] = useState(false);
      const [temp, setTemp] = useState(20); // Celsius
      const [energyUsed, setEnergyUsed] = useState(0); // Joules

      const materials = {
         water: { name: 'Water', c: 4184, color: 'bg-blue-400', desc: 'High specific heat; takes a lot of energy to warm up.' },
         iron: { name: 'Iron', c: 450, color: 'bg-slate-500', desc: 'Low specific heat; warms up very quickly.' },
         aluminum: { name: 'Aluminum', c: 900, color: 'bg-slate-300', desc: 'Moderate specific heat.' }
      };

      const current = materials[material];

      useEffect(() => {
         let interval: any;
         if (isHeating) {
            interval = setInterval(() => {
               const power = 1000;
               const dt = 0.1;
               const energy = power * dt;
               setEnergyUsed(prev => prev + energy);
               setTemp(prev => {
                  const deltaT = energy / (mass * current.c);
                  return Math.min(100, prev + deltaT);
               });
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isHeating, mass, current.c]);

      const reset = () => {
         setIsHeating(false);
         setTemp(20);
         setEnergyUsed(0);
      };

      useEffect(() => {
         reset();
      }, [material]);

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Specific Heat Lab</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Q = mcŒîT</p>
               </div>
               <div className="flex gap-2">
                  {(['water', 'iron', 'aluminum'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMaterial(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${material === m ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative flex flex-col items-center">
                     <div className="absolute -left-16 bottom-20 w-8 h-48 bg-slate-100 rounded-full border-2 border-slate-200 p-1 flex flex-col justify-end">
                        <div
                           className="w-full bg-red-500 rounded-full transition-all duration-300"
                           style={{ height: `${(temp / 100) * 100}%` }}
                        />
                        <div className="absolute -top-6 left-0 w-full text-center text-[10px] font-black text-red-500">{Math.round(temp)}¬∞C</div>
                     </div>

                     <div className={`w-40 h-40 ${current.color} rounded-2xl shadow-lg border-4 border-white flex items-center justify-center relative overflow-hidden`}>
                        <div className="absolute inset-0 bg-black/10 flex items-center justify-center">
                           <span className="text-white font-black text-xl">{current.name}</span>
                        </div>
                        {material === 'water' && temp > 80 && (
                           <div className="absolute inset-0 pointer-events-none">
                              {Array.from({ length: 5 }).map((_, i) => (
                                 <div
                                    key={i}
                                    className="absolute w-2 h-2 bg-white/40 rounded-full animate-bounce"
                                    style={{ left: `${20 + i * 15}%`, bottom: '10%', animationDelay: `${i * 0.2}s` }}
                                 />
                              ))}
                           </div>
                        )}
                     </div>

                     <div className={`mt-4 w-48 h-8 rounded-xl transition-colors duration-500 ${isHeating ? 'bg-orange-500 shadow-[0_0_30px_rgba(249,115,22,0.4)]' : 'bg-slate-200'}`} />
                     <p className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">1000W Heater</p>
                  </div>

                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onMouseDown={() => setIsHeating(true)}
                        onMouseUp={() => setIsHeating(false)}
                        onMouseLeave={() => setIsHeating(false)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-orange-500 text-white scale-95' : 'bg-white text-slate-950'}`}
                     >
                        HOLD TO HEAT
                     </button>
                     <button
                        onClick={reset}
                        className="px-12 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Material Properties</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Specific Heat (c)</span>
                           <span className="text-sm font-black text-indigo-600">{current.c} J/kg¬∑¬∞C</span>
                        </div>
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Mass (m)</span>
                           <div className="flex items-center gap-2">
                              <input
                                 type="range" min="0.5" max="5" step="0.5" value={mass}
                                 onChange={(e) => setMass(parseFloat(e.target.value))}
                                 className="w-20 accent-indigo-600"
                              />
                              <span className="text-sm font-black text-slate-900">{mass}kg</span>
                           </div>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto grid grid-cols-1 gap-4">
                     <div className="p-6 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">Energy Consumed (Q)</p>
                        <p className="text-3xl font-black text-orange-400">{Math.round(energyUsed).toLocaleString()} J</p>
                        <p className="text-[10px] text-slate-500 mt-4 leading-relaxed">
                           {current.desc}
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LATENT HEAT RENDERER (Phase Changes) ---
   const LatentHeatRenderer = () => {
      const [isHeating, setIsHeating] = useState(false);
      const [energy, setEnergy] = useState(0); // kJ
      const [mass, setMass] = useState(1); // kg

      const cIce = 2.1;
      const Lf = 334;
      const cWater = 4.18;
      const Lv = 2260;
      const cSteam = 2.0;

      const getTemp = (q: number) => {
         let currentQ = q / mass;
         const qToMelt = (0 - (-20)) * cIce;
         if (currentQ <= qToMelt) return -20 + currentQ / cIce;
         currentQ -= qToMelt;
         if (currentQ <= Lf) return 0;
         currentQ -= Lf;
         const qToBoil = (100 - 0) * cWater;
         if (currentQ <= qToBoil) return 0 + currentQ / cWater;
         currentQ -= qToBoil;
         if (currentQ <= Lv) return 100;
         currentQ -= Lv;
         return 100 + currentQ / cSteam;
      };

      const temp = getTemp(energy);
      const phase = temp < 0 ? 'Ice' : temp === 0 && (energy / mass) < (20 * cIce + Lf) ? 'Melting' : temp < 100 ? 'Water' : temp === 100 && (energy / mass) < (20 * cIce + Lf + 100 * cWater + Lv) ? 'Boiling' : 'Steam';

      useEffect(() => {
         let interval: any;
         if (isHeating) {
            interval = setInterval(() => {
               setEnergy(prev => prev + 10);
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isHeating]);

      const reset = () => {
         setIsHeating(false);
         setEnergy(0);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Phase Change & Latent Heat</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Heating Curve of Water</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">MASS: {mass}kg</span>
                  <input
                     type="range" min="0.5" max="2" step="0.1" value={mass}
                     onChange={(e) => setMass(parseFloat(e.target.value))}
                     className="w-24 accent-indigo-600"
                  />
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex flex-col p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="flex-1 relative">
                     <svg viewBox="0 0 500 300" className="w-full h-full">
                        <line x1="50" y1="250" x2="450" y2="250" stroke="#cbd5e1" strokeWidth="2" />
                        <line x1="50" y1="250" x2="50" y2="20" stroke="#cbd5e1" strokeWidth="2" />
                        <text x="450" y="265" textAnchor="end" className="text-[8px] font-bold fill-slate-400">ENERGY ADDED (kJ)</text>
                        <text x="45" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">TEMPERATURE (¬∞C)</text>

                        <line x1="50" y1="150" x2="450" y2="150" stroke="#f1f5f9" strokeWidth="1" strokeDasharray="4" />
                        <text x="45" y="153" textAnchor="end" className="text-[8px] font-bold fill-slate-300">0¬∞C</text>
                        <line x1="50" y1="50" x2="450" y2="50" stroke="#f1f5f9" strokeWidth="1" strokeDasharray="4" />
                        <text x="45" y="53" textAnchor="end" className="text-[8px] font-bold fill-slate-300">100¬∞C</text>

                        <path
                           d={`M 50,${250 - (getTemp(0) + 20)} ${Array.from({ length: 100 }).map((_, i) => {
                              const q = i * 40;
                              const x = 50 + (q / 4000) * 400;
                              const y = 250 - (getTemp(q) + 20);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none" stroke="#e2e8f0" strokeWidth="2"
                        />

                        <path
                           d={`M 50,${250 - (getTemp(0) + 20)} ${Array.from({ length: Math.floor(energy / 40) + 1 }).map((_, i) => {
                              const q = i * 40;
                              const x = 50 + (q / 4000) * 400;
                              const y = 250 - (getTemp(q) + 20);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none" stroke="#6366f1" strokeWidth="4" strokeLinecap="round"
                        />

                        <circle
                           cx={50 + (energy / 4000) * 400}
                           cy={250 - (temp + 20)}
                           r="6" fill="#ef4444" className="animate-pulse"
                        />
                     </svg>

                     <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-4">
                        <button
                           onMouseDown={() => setIsHeating(true)}
                           onMouseUp={() => setIsHeating(false)}
                           onMouseLeave={() => setIsHeating(false)}
                           className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-indigo-600 text-white scale-95' : 'bg-white text-slate-950'}`}
                        >
                           HOLD TO HEAT
                        </button>
                        <button
                           onClick={reset}
                           className="px-12 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all uppercase tracking-widest"
                        >
                           RESET
                        </button>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Current State</p>
                     <div className="p-6 bg-white rounded-3xl border border-slate-200 shadow-sm flex flex-col items-center gap-2">
                        <span className="text-4xl">{phase === 'Ice' ? 'üßä' : phase === 'Melting' ? 'üíßüßä' : phase === 'Water' ? 'üíß' : phase === 'Boiling' ? 'üí®üíß' : 'üí®'}</span>
                        <h3 className="text-2xl font-black text-slate-900 uppercase">{phase}</h3>
                        <p className="text-4xl font-black text-indigo-600">{Math.round(temp)}¬∞C</p>
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        Notice the <strong>plateaus</strong> at 0¬∞C and 100¬∞C. During these times, the energy added is used to <strong>break molecular bonds</strong> (Latent Heat) rather than increasing the temperature.
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <p className="text-[10px] font-black text-indigo-900 uppercase mb-2">Energy Stats</p>
                        <div className="flex justify-between text-[10px]">
                           <span className="text-indigo-700">Total Energy:</span>
                           <span className="font-black text-indigo-900">{energy} kJ</span>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENTROPY RENDERER (Order vs Disorder) ---
   const EntropyRenderer = () => {
      const [isSimulating, setIsSimulating] = useState(false);
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number }[]>([]);
      const [entropy, setEntropy] = useState(0);

      const initParticles = () => {
         const initial = [];
         for (let i = 0; i < 100; i++) {
            initial.push({
               x: 10 + Math.random() * 80,
               y: 10 + Math.random() * 80,
               vx: (Math.random() - 0.5) * 4,
               vy: (Math.random() - 0.5) * 4
            });
         }
         setParticles(initial);
         setEntropy(0);
      };

      useEffect(() => {
         initParticles();
      }, []);

      useEffect(() => {
         let animationId: number;
         if (isSimulating) {
            const animate = () => {
               setParticles(prev => {
                  const next = prev.map(p => {
                     let { x, y, vx, vy } = p;
                     x += vx;
                     y += vy;
                     if (x < 0 || x > 390) vx *= -1;
                     if (y < 0 || y > 290) vy *= -1;
                     return { x, y, vx, vy };
                  });
                  const grid = Array(16).fill(0);
                  next.forEach(p => {
                     const col = Math.floor(p.x / 100);
                     const row = Math.floor(p.y / 75);
                     const idx = Math.min(15, row * 4 + col);
                     grid[idx]++;
                  });
                  let e = 0;
                  grid.forEach(count => {
                     if (count > 0) {
                        const p = count / 100;
                        e -= p * Math.log2(p);
                     }
                  });
                  setEntropy(e / 4);
                  return next;
               });
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isSimulating]);

      const reset = () => {
         setIsSimulating(false);
         initParticles();
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Entropy & Disorder</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">The Second Law of Thermodynamics</p>
               </div>
               <div className="flex items-center gap-4">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-500 uppercase">Entropy Level</span>
                     <span className="text-xl font-black text-emerald-400">{(entropy * 100).toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="relative w-[400px] h-[300px] border-2 border-slate-800 rounded-xl overflow-hidden bg-slate-900/30">
                     <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 opacity-10 pointer-events-none">
                        {Array.from({ length: 16 }).map((_, i) => (
                           <div key={i} className="border border-slate-500" />
                        ))}
                     </div>
                     {particles.map((p, i) => (
                        <div
                           key={i}
                           className="absolute w-2 h-2 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.5)]"
                           style={{ left: `${p.x}px`, top: `${p.y}px` }}
                        />
                     ))}
                  </div>
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsSimulating(!isSimulating)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isSimulating ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-white text-slate-950'}`}
                     >
                        {isSimulating ? 'PAUSE' : 'RELEASE PARTICLES'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-12 py-4 bg-slate-800 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-700 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Insight</p>
                     <h3 className="text-2xl font-black text-white">Arrow of Time</h3>
                     <p className="text-sm text-slate-400 leading-relaxed">
                        Entropy is a measure of <strong>disorder</strong> or the number of ways a system can be arranged.
                     </p>
                     <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700">
                        <p className="text-xs leading-relaxed text-slate-300">
                           When particles are clumped in a corner, there are very few ways to arrange them (Low Entropy). As they spread out, the number of possible arrangements increases (High Entropy).
                        </p>
                     </div>
                  </div>
                  <div className="mt-auto p-4 bg-indigo-500/10 rounded-2xl border border-indigo-500/20">
                     <p className="text-[10px] font-black text-indigo-400 uppercase mb-2">Second Law</p>
                     <p className="text-[10px] text-slate-400 leading-relaxed">
                        In an isolated system, entropy never decreases. Systems naturally move from <strong>order</strong> to <strong>disorder</strong>.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- HEAT ENGINE RENDERER (PV Diagrams) ---
   const HeatEngineRenderer = () => {
      const [isPlaying, setIsPlaying] = useState(false);
      const [progress, setProgress] = useState(0);
      const [tempH, setTempH] = useState(500); // Kelvin
      const [tempL, setTempL] = useState(300); // Kelvin

      useEffect(() => {
         let animationId: number;
         if (isPlaying) {
            const animate = () => {
               setProgress(p => (p + 1) % 100);
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isPlaying]);

      const getPV = (p: number) => {
         const vMin = 100;
         const vMax = 300;
         const gamma = 1.4;
         if (p < 25) {
            const t = p / 25;
            const v = vMin + t * 100;
            return { v, p: (tempH * 10) / v };
         } else if (p < 50) {
            const t = (p - 25) / 25;
            const vStart = 200;
            const v = vStart + t * (vMax - vStart);
            const pStart = (tempH * 10) / vStart;
            return { v, p: pStart * Math.pow(vStart / v, gamma) };
         } else if (p < 75) {
            const t = (p - 50) / 25;
            const vStart = vMax;
            const v = vStart - t * (vStart - 150);
            return { v, p: (tempL * 10) / v };
         } else {
            const t = (p - 75) / 25;
            const vStart = 150;
            const v = vStart - t * (vStart - vMin);
            const pStart = (tempL * 10) / vStart;
            return { v, p: pStart * Math.pow(vStart / v, gamma) };
         }
      };

      const current = getPV(progress);
      const efficiency = (1 - tempL / tempH) * 100;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Heat Engine Cycle</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">PV Diagram & Efficiency</p>
               </div>
               <div className="flex items-center gap-6">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-500 uppercase">Carnot Efficiency</span>
                     <span className="text-xl font-black text-emerald-600">{efficiency.toFixed(1)}%</span>
                  </div>
                  <button
                     onClick={() => setIsPlaying(!isPlaying)}
                     className={`px-8 py-3 rounded-xl font-black text-sm transition-all shadow-lg ${isPlaying ? 'bg-red-500 text-white' : 'bg-indigo-600 text-white'}`}
                  >
                     {isPlaying ? 'STOP ENGINE' : 'START ENGINE'}
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 400 300" className="w-full h-full max-w-md">
                     <line x1="50" y1="250" x2="380" y2="250" stroke="#cbd5e1" strokeWidth="2" />
                     <line x1="50" y1="250" x2="50" y2="20" stroke="#cbd5e1" strokeWidth="2" />
                     <text x="380" y="265" textAnchor="end" className="text-[8px] font-bold fill-slate-400">VOLUME (V)</text>
                     <text x="45" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">PRESSURE (P)</text>

                     <path
                        d={`M ${getPV(0).v},${250 - getPV(0).p} ${Array.from({ length: 101 }).map((_, i) => {
                           const pt = getPV(i);
                           return `L ${pt.v},${250 - pt.p}`;
                        }).join(' ')}`}
                        fill="#6366f1" fillOpacity="0.1" stroke="#6366f1" strokeWidth="2"
                     />
                     <circle cx={current.v} cy={250 - current.p} r="6" fill="#ef4444" className="transition-all duration-75" />
                     <text x="200" y="150" textAnchor="middle" className="text-[10px] font-black fill-indigo-600/40 uppercase">Work Done (W)</text>
                  </svg>

                  <div className="absolute left-10 bottom-10 w-32 h-48 border-2 border-slate-200 rounded-xl bg-slate-50 overflow-hidden">
                     <div className="absolute bottom-0 w-full bg-indigo-500/20 transition-all duration-75" style={{ height: `${(current.v / 300) * 100}%` }} />
                     <div className="absolute w-full h-4 bg-slate-800 transition-all duration-75" style={{ bottom: `${(current.v / 300) * 100}%` }} />
                     <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span className="text-[8px] font-black text-slate-400 uppercase">Cylinder</span>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-red-500 uppercase">Hot Reservoir (TH)</span>
                           <span className="text-slate-900">{tempH} K</span>
                        </div>
                        <input
                           type="range" min="400" max="800" value={tempH}
                           onChange={(e) => setTempH(parseInt(e.target.value))}
                           className="w-full accent-red-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-blue-500 uppercase">Cold Reservoir (TL)</span>
                           <span className="text-slate-900">{tempL} K</span>
                        </div>
                        <input
                           type="range" min="200" max="350" value={tempL}
                           onChange={(e) => setTempL(parseInt(e.target.value))}
                           className="w-full accent-blue-500"
                        />
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        A heat engine works by taking heat from a hot source, converting some of it into <strong>Work</strong>, and exhausting the rest to a cold sink.
                     </p>
                  </div>

                  <div className="mt-auto p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                     <p className="text-[10px] font-black text-emerald-900 uppercase mb-2">Efficiency Rule</p>
                     <p className="text-[10px] text-emerald-700 leading-relaxed">
                        To increase efficiency, you must either increase the temperature of the hot source or decrease the temperature of the cold sink.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LIGHT TRANSMISSION RENDERER ---
   const LightTransmissionRenderer = () => {
      const [material, setMaterial] = useState<'glass' | 'tinted' | 'metal'>('glass');
      const [thickness, setThickness] = useState(1); // 1-10
      const [wavelength, setWavelength] = useState(550); // nm (Visible range)

      const materials = {
         glass: { name: 'Clear Glass', transmission: 0.95, absorption: 0.02, reflection: 0.03, color: 'bg-blue-100/30' },
         tinted: { name: 'Tinted Glass', transmission: 0.4, absorption: 0.5, reflection: 0.1, color: 'bg-slate-800/60' },
         metal: { name: 'Polished Metal', transmission: 0, absorption: 0.1, reflection: 0.9, color: 'bg-slate-300' }
      };

      const current = materials[material];

      // Beer-Lambert Law approximation
      const effectiveTransmission = material === 'metal' ? 0 : Math.pow(current.transmission, thickness);
      const effectiveAbsorption = material === 'metal' ? 0.1 : (1 - effectiveTransmission - current.reflection);
      const effectiveReflection = current.reflection;

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight text-white">Light Transmission</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Transmission vs. Absorption vs. Reflection</p>
               </div>
               <div className="flex gap-2">
                  {(['glass', 'tinted', 'metal'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMaterial(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${material === m ? 'bg-white text-slate-950' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 600 400" className="w-full h-full max-w-2xl">
                     {/* Light Source */}
                     <rect x="20" y="180" width="40" height="40" rx="4" fill="#fbbf24" />
                     <path d="M 60,200 L 250,200" stroke="#fbbf24" strokeWidth="4" strokeDasharray="8 4" className="animate-[dash_2s_linear_infinite]" />

                     {/* Material Sample */}
                     <rect
                        x="250" y={200 - 50}
                        width={thickness * 10} height="100"
                        className={`${current.color} transition-all duration-500`}
                        stroke="rgba(255,255,255,0.2)"
                     />

                     {/* Transmitted Light */}
                     {effectiveTransmission > 0 && (
                        <path
                           d={`M ${250 + thickness * 10},200 L 550,200`}
                           stroke="#fbbf24"
                           strokeWidth={4 * effectiveTransmission}
                           opacity={effectiveTransmission}
                           strokeDasharray="8 4"
                           className="animate-[dash_2s_linear_infinite]"
                        />
                     )}

                     {/* Reflected Light */}
                     {effectiveReflection > 0 && (
                        <path
                           d="M 250,200 L 100,100"
                           stroke="#fbbf24"
                           strokeWidth={4 * effectiveReflection}
                           opacity={effectiveReflection}
                           strokeDasharray="8 4"
                           className="animate-[dash_2s_linear_infinite]"
                        />
                     )}

                     {/* Labels */}
                     <text x="40" y="170" className="text-[10px] font-black fill-amber-400 uppercase">Source</text>
                     <text x="300" y="320" textAnchor="middle" className="text-[10px] font-black fill-slate-500 uppercase">Material Sample</text>
                     <text x="500" y="190" textAnchor="middle" className="text-[10px] font-black fill-amber-400 uppercase">Transmitted</text>
                  </svg>

                  <style>{`
                     @keyframes dash {
                        to { stroke-dashoffset: -12; }
                     }
                  `}</style>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Thickness</span>
                           <span className="text-white">{thickness} units</span>
                        </div>
                        <input
                           type="range" min="1" max="10" step="1" value={thickness}
                           onChange={(e) => setThickness(parseInt(e.target.value))}
                           className="w-full accent-white"
                        />
                     </div>

                     <div className="p-6 bg-black/40 rounded-3xl border border-slate-800 space-y-4">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Energy Distribution</p>
                        <div className="space-y-3">
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Transmission</span>
                                 <span className="text-emerald-400">{Math.round(effectiveTransmission * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-emerald-500 transition-all duration-500" style={{ width: `${effectiveTransmission * 100}%` }} />
                              </div>
                           </div>
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Absorption</span>
                                 <span className="text-red-400">{Math.round(effectiveAbsorption * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-red-500 transition-all duration-500" style={{ width: `${effectiveAbsorption * 100}%` }} />
                              </div>
                           </div>
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Reflection</span>
                                 <span className="text-blue-400">{Math.round(effectiveReflection * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${effectiveReflection * 100}%` }} />
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-800 rounded-3xl">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        {material === 'metal'
                           ? "Metals are opaque because their free electrons reflect most light energy."
                           : "As thickness increases, transmission decreases exponentially as more photons are absorbed or scattered."}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LIGHT ABSORPTION RENDERER ---
   const LightAbsorptionRenderer = () => {
      const [objectColor, setObjectColor] = useState<'red' | 'green' | 'blue' | 'black' | 'white'>('red');
      const [lightColor, setLightColor] = useState<'white' | 'red' | 'green' | 'blue'>('white');
      const [isShining, setIsShining] = useState(false);
      const [temp, setTemp] = useState(20);

      const colors = {
         red: { hex: '#ef4444', absorbs: ['green', 'blue'] },
         green: { hex: '#10b981', absorbs: ['red', 'blue'] },
         blue: { hex: '#3b82f6', absorbs: ['red', 'green'] },
         black: { hex: '#18181b', absorbs: ['red', 'green', 'blue'] },
         white: { hex: '#ffffff', absorbs: [] }
      };

      const lightHex = {
         white: '#ffffff',
         red: '#ef4444',
         green: '#10b981',
         blue: '#3b82f6'
      };

      useEffect(() => {
         let interval: any;
         if (isShining) {
            interval = setInterval(() => {
               setTemp(prev => {
                  let absorptionRate = 0;
                  if (lightColor === 'white') {
                     absorptionRate = colors[objectColor].absorbs.length * 0.1;
                     if (objectColor === 'black') absorptionRate = 0.5;
                  } else {
                     const isAbsorbed = colors[objectColor].absorbs.includes(lightColor);
                     absorptionRate = isAbsorbed ? 0.3 : 0.05;
                  }
                  return Math.min(100, prev + absorptionRate);
               });
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isShining, objectColor, lightColor]);

      const reflectedColor = () => {
         if (!isShining) return 'transparent';
         if (lightColor === 'white') return colors[objectColor].hex;
         const isAbsorbed = colors[objectColor].absorbs.includes(lightColor);
         return isAbsorbed ? '#111' : lightHex[lightColor];
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Light Absorption & Color</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Energy Conversion & Perception</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-400 uppercase">Surface Temp</span>
                     <span className="text-xl font-black text-red-600">{temp.toFixed(1)}¬∞C</span>
                  </div>
                  <button
                     onMouseDown={() => setIsShining(true)}
                     onMouseUp={() => setIsShining(false)}
                     onMouseLeave={() => setIsShining(false)}
                     className={`px-8 py-3 rounded-xl font-black text-sm transition-all shadow-lg ${isShining ? 'bg-amber-500 text-white scale-95' : 'bg-slate-900 text-white'}`}
                  >
                     SHINE LIGHT
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative flex flex-col items-center gap-12">
                     {/* Light Source */}
                     <div className="flex flex-col items-center gap-4">
                        <div className="flex gap-2">
                           {(['white', 'red', 'green', 'blue'] as const).map(c => (
                              <button
                                 key={c}
                                 onClick={() => setLightColor(c)}
                                 className={`w-8 h-8 rounded-full border-2 transition-all ${lightColor === c ? 'border-slate-900 scale-110 shadow-lg' : 'border-transparent opacity-50'}`}
                                 style={{ backgroundColor: lightHex[c] }}
                              />
                           ))}
                        </div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Light Color</p>
                     </div>

                     <div className="relative">
                        {/* Incoming Light Beam */}
                        {isShining && (
                           <div
                              className="absolute -top-32 left-1/2 -translate-x-1/2 w-8 h-32 blur-sm opacity-40 transition-all duration-300"
                              style={{
                                 background: `linear-gradient(to bottom, transparent, ${lightHex[lightColor]})`,
                                 clipPath: 'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)'
                              }}
                           />
                        )}

                        {/* Object */}
                        <div className="flex flex-col items-center gap-4">
                           <div
                              className="w-48 h-48 rounded-3xl shadow-2xl transition-all duration-500 border-4 border-white relative overflow-hidden"
                              style={{ backgroundColor: colors[objectColor].hex }}
                           >
                              {/* Heat Glow */}
                              <div
                                 className="absolute inset-0 bg-red-500 transition-opacity duration-1000"
                                 style={{ opacity: (temp - 20) / 160 }}
                              />
                           </div>
                           <div className="flex gap-2">
                              {(['red', 'green', 'blue', 'black', 'white'] as const).map(c => (
                                 <button
                                    key={c}
                                    onClick={() => { setObjectColor(c); setTemp(20); }}
                                    className={`w-6 h-6 rounded-full border-2 transition-all ${objectColor === c ? 'border-slate-900 scale-110' : 'border-transparent opacity-50'}`}
                                    style={{ backgroundColor: colors[c].hex }}
                                 />
                              ))}
                           </div>
                           <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Object Color</p>
                        </div>

                        {/* Reflected Light */}
                        {isShining && (
                           <div
                              className="absolute -top-24 -right-24 w-6 h-24 blur-md opacity-30 transition-all duration-300"
                              style={{
                                 background: `linear-gradient(to top, transparent, ${reflectedColor()})`,
                                 transform: 'rotate(45deg)'
                              }}
                           />
                        )}
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Mechanism</p>
                     <h3 className="text-2xl font-black text-slate-900">Why is it {objectColor}?</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">
                        {objectColor === 'black'
                           ? "Black objects absorb almost all visible light, converting the energy into heat. This is why black clothes feel hotter in the sun!"
                           : objectColor === 'white'
                              ? "White objects reflect most visible light, absorbing very little energy and staying cooler."
                              : `A ${objectColor} object reflects ${objectColor} light and absorbs other colors like ${colors[objectColor].absorbs.join(' and ')}.`}
                     </p>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Energy Transformation</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        When light is <strong>absorbed</strong>, its electromagnetic energy is converted into <strong>thermal energy</strong> (vibrating molecules), which increases the object's temperature.
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                        <p className="text-[10px] font-black text-amber-900 uppercase mb-2">Key Concept</p>
                        <p className="text-[10px] text-amber-700 leading-relaxed">
                           The color we see is the light that was <strong>NOT</strong> absorbed by the object.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- DIGITAL SIGNAL RENDERER ---
   const DigitalSignalRenderer = () => {
      const [sampleRate, setSampleRate] = useState(10); // 2-40
      const [bitDepth, setBitDepth] = useState(4); // 1-8
      const [freq, setFreq] = useState(1); // Hz
      const [showAnalog, setShowAnalog] = useState(true);
      const [showDigital, setShowDigital] = useState(true);

      const width = 600;
      const height = 300;
      const padding = 40;

      // Generate analog wave points
      const analogPoints = Array.from({ length: 200 }, (_, i) => {
         const x = (i / 199) * (width - 2 * padding) + padding;
         const t = (i / 199) * 2 * Math.PI * freq;
         const y = Math.sin(t) * (height / 2 - padding) + height / 2;
         return { x, y };
      });

      // Generate digital samples
      const numSamples = sampleRate;
      const quantizationLevels = Math.pow(2, bitDepth);
      const digitalPoints = Array.from({ length: numSamples }, (_, i) => {
         const x = (i / (numSamples - 1)) * (width - 2 * padding) + padding;
         const t = (i / (numSamples - 1)) * 2 * Math.PI * freq;
         const rawY = Math.sin(t);

         // Quantize
         const level = Math.round(((rawY + 1) / 2) * (quantizationLevels - 1));
         const quantizedY = (level / (quantizationLevels - 1)) * 2 - 1;
         const y = quantizedY * (height / 2 - padding) + height / 2;

         return { x, y, level };
      });

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight text-white uppercase">Analog to Digital</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Sampling & Quantization</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-2">
                     <input type="checkbox" checked={showAnalog} onChange={() => setShowAnalog(!showAnalog)} className="accent-blue-500" />
                     <span className="text-[10px] font-bold uppercase text-slate-400">Analog</span>
                  </div>
                  <div className="flex items-center gap-2">
                     <input type="checkbox" checked={showDigital} onChange={() => setShowDigital(!showDigital)} className="accent-emerald-500" />
                     <span className="text-[10px] font-bold uppercase text-slate-400">Digital</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full max-w-2xl overflow-visible">
                     {/* Grid Lines for Quantization */}
                     {Array.from({ length: quantizationLevels }).map((_, i) => {
                        const y = (i / (quantizationLevels - 1)) * (height - 2 * padding) + padding;
                        return (
                           <line key={i} x1={padding} y1={y} x2={width - padding} y2={y} stroke="rgba(255,255,255,0.05)" strokeWidth="1" />
                        );
                     })}

                     {/* Analog Wave */}
                     {showAnalog && (
                        <path
                           d={`M ${analogPoints.map(p => `${p.x},${p.y}`).join(' L ')}`}
                           fill="none"
                           stroke="#3b82f6"
                           strokeWidth="2"
                           className="opacity-50"
                        />
                     )}

                     {/* Digital Staircase */}
                     {showDigital && (
                        <path
                           d={`M ${digitalPoints.map((p, i) => {
                              const next = digitalPoints[i + 1];
                              if (!next) return `${p.x},${p.y}`;
                              return `${p.x},${p.y} L ${next.x},${p.y}`;
                           }).join(' L ')}`}
                           fill="none"
                           stroke="#10b981"
                           strokeWidth="3"
                           strokeLinecap="round"
                        />
                     )}

                     {/* Sample Points */}
                     {showDigital && digitalPoints.map((p, i) => (
                        <circle key={i} cx={p.x} cy={p.y} r="4" fill="#10b981" />
                     ))}

                     {/* Axes */}
                     <line x1={padding} y1={height / 2} x2={width - padding} y2={height / 2} stroke="white" strokeWidth="1" opacity="0.2" />
                     <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="white" strokeWidth="1" opacity="0.2" />
                  </svg>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Sample Rate</span>
                           <span className="text-emerald-400">{sampleRate} Hz</span>
                        </div>
                        <input
                           type="range" min="2" max="40" step="1" value={sampleRate}
                           onChange={(e) => setSampleRate(parseInt(e.target.value))}
                           className="w-full accent-emerald-500"
                        />
                        <p className="text-[8px] text-slate-500 italic">How often we take a "snapshot" of the wave.</p>
                     </div>

                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Bit Depth</span>
                           <span className="text-blue-400">{bitDepth} bits ({quantizationLevels} levels)</span>
                        </div>
                        <input
                           type="range" min="1" max="8" step="1" value={bitDepth}
                           onChange={(e) => setBitDepth(parseInt(e.target.value))}
                           className="w-full accent-blue-500"
                        />
                        <p className="text-[8px] text-slate-500 italic">Precision of each snapshot (rounding to nearest level).</p>
                     </div>
                  </div>

                  <div className="p-6 bg-black/40 rounded-3xl border border-slate-800 space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Digital Error (Aliasing)</p>
                     <div className="space-y-2">
                        <p className="text-xs text-slate-400 leading-relaxed">
                           {sampleRate < freq * 4
                              ? "‚ö†Ô∏è Warning: Sample rate is too low! The digital signal is losing the true shape of the wave (Aliasing)."
                              : "The digital signal is a good approximation of the analog wave."}
                        </p>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-800 rounded-3xl">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        Digital signals are <strong>discrete</strong> approximations. Higher sample rates and bit depths create more accurate "high-fidelity" representations but require more data storage.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };
   // --- WAVE EQUATION RENDERER ---
   const WaveEquationRenderer = () => {
      const [freq, setFreq] = useState(2);
      const [wavelength, setWavelength] = useState(100);
      const [locked, setLocked] = useState<'v' | 'f' | 'l' | null>(null);
      const [medium, setMedium] = useState('custom');
      const [time, setTime] = useState(0);

      const speed = freq * wavelength;

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      const mediums = [
         { id: 'custom', name: 'Custom', speed: speed },
         { id: 'air', name: 'Air (Sound)', speed: 343 },
         { id: 'water', name: 'Water (Sound)', speed: 1480 },
         { id: 'steel', name: 'Steel (Sound)', speed: 5960 },
         { id: 'vacuum', name: 'Vacuum (Light)', speed: 300000000 },
      ];

      const handleMediumChange = (m: string) => {
         setMedium(m);
         if (m !== 'custom') {
            const targetSpeed = mediums.find(x => x.id === m)?.speed || 343;
            // Adjust wavelength to keep frequency constant
            setWavelength(targetSpeed / freq);
         }
      };

      const updateFreq = (f: number) => {
         setFreq(f);
         if (locked === 'v') {
            setWavelength(speed / f);
         }
      };

      const updateWavelength = (l: number) => {
         setWavelength(l);
         if (locked === 'v') {
            setFreq(speed / l);
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">WAVE EQUATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">v = f √ó Œª</p>
               </div>
               <div className="flex gap-2">
                  {mediums.map(m => (
                     <button
                        key={m.id}
                        onClick={() => handleMediumChange(m.id)}
                        className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${medium === m.id ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {m.name}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="100%" height="200" className="overflow-visible">
                     <defs>
                        <linearGradient id="waveGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#6366f1" />
                           <stop offset="100%" stopColor="#a855f7" />
                        </linearGradient>
                     </defs>
                     {/* Axis */}
                     <line x1="0" y1="100" x2="100%" y2="100%" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Wave Path */}
                     <path
                        d={Array.from({ length: 100 }, (_, i) => {
                           const x = (i / 100) * 800;
                           const y = 100 + Math.sin((x / (wavelength / 10)) - time * freq * 2) * 40;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="url(#waveGrad)"
                        strokeWidth="4"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                     />

                     {/* Wavelength Marker */}
                     <g transform={`translate(100, 160)`}>
                        <line x1="0" y1="0" x2={wavelength / 2} y2="0" stroke="#fbbf24" strokeWidth="2" />
                        <line x1="0" y1="-5" x2="0" y2="5" stroke="#fbbf24" strokeWidth="2" />
                        <line x1={wavelength / 2} y1="-5" x2={wavelength / 2} y2="5" stroke="#fbbf24" strokeWidth="2" />
                        <text x={wavelength / 4} y="15" textAnchor="middle" fill="#fbbf24" className="text-[10px] font-bold">Œª = {wavelength.toFixed(1)}m</text>
                     </g>
                  </svg>

                  {/* Speed Indicator */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Wave Speed (v)</p>
                     <p className="text-2xl font-black text-white tabular-nums">
                        {speed > 1000000 ? (speed / 1000000).toFixed(1) + 'M' : speed.toFixed(1)} <span className="text-xs text-slate-500">m/s</span>
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  {/* Frequency Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-center">
                        <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Frequency (f)</label>
                        <button
                           onClick={() => setLocked(locked === 'f' ? null : 'f')}
                           className={`p-1 rounded transition-colors ${locked === 'f' ? 'text-indigo-400' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                           <i className={`fa-solid ${locked === 'f' ? 'fa-lock' : 'fa-lock-open'}`}></i>
                        </button>
                     </div>
                     <input
                        type="range"
                        min="0.5"
                        max="10"
                        step="0.1"
                        value={freq}
                        onChange={(e) => updateFreq(parseFloat(e.target.value))}
                        disabled={locked === 'f'}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.5 Hz</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{freq.toFixed(1)} Hz</span>
                        <span>10 Hz</span>
                     </div>
                  </div>

                  {/* Wavelength Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-center">
                        <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Wavelength (Œª)</label>
                        <button
                           onClick={() => setLocked(locked === 'l' ? null : 'l')}
                           className={`p-1 rounded transition-colors ${locked === 'l' ? 'text-amber-400' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                           <i className={`fa-solid ${locked === 'l' ? 'fa-lock' : 'fa-lock-open'}`}></i>
                        </button>
                     </div>
                     <input
                        type="range"
                        min="10"
                        max="500"
                        step="1"
                        value={wavelength}
                        onChange={(e) => updateWavelength(parseFloat(e.target.value))}
                        disabled={locked === 'l'}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10 m</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{wavelength.toFixed(1)} m</span>
                        <span>500 m</span>
                     </div>
                  </div>

                  {/* Lock Speed Toggle */}
                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <div className="flex items-center justify-between mb-2">
                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lock Speed (v)</span>
                        <button
                           onClick={() => setLocked(locked === 'v' ? null : 'v')}
                           className={`w-10 h-5 rounded-full relative transition-colors ${locked === 'v' ? 'bg-indigo-500' : 'bg-slate-700'}`}
                        >
                           <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${locked === 'v' ? 'left-6' : 'left-1'}`} />
                        </button>
                     </div>
                     <p className="text-[10px] text-slate-500 leading-tight">
                        When locked, changing frequency will automatically adjust wavelength to maintain the same wave speed.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Wave speed is a property of the <strong>medium</strong>. If the medium doesn't change, increasing frequency must decrease wavelength.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUPERPOSITION RENDERER ---
   const SuperpositionRenderer = () => {
      const [wave1, setWave1] = useState({ amp: 40, freq: 2, phase: 0 });
      const [wave2, setWave2] = useState({ amp: 40, freq: 2, phase: Math.PI });
      const [showIndividual, setShowIndividual] = useState(true);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      const getWaveY = (x: number, w: { amp: number, freq: number, phase: number }) => {
         return Math.sin((x / 20) - time * w.freq + w.phase) * w.amp;
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">WAVE SUPERPOSITION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Principle of Superposition</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setShowIndividual(!showIndividual)}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${showIndividual ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                  >
                     {showIndividual ? 'Hide Components' : 'Show Components'}
                  </button>
                  <button
                     onClick={() => setWave2({ ...wave2, phase: wave2.phase === 0 ? Math.PI : 0 })}
                     className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95"
                  >
                     Toggle Phase (180¬∞)
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="100%" height="300" className="overflow-visible">
                     {/* Grid Lines */}
                     <line x1="0" y1="150" x2="100%" y2="150%" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {showIndividual && (
                        <>
                           {/* Wave 1 */}
                           <path
                              d={Array.from({ length: 100 }, (_, i) => {
                                 const x = (i / 100) * 800;
                                 const y = 150 + getWaveY(x, wave1);
                                 return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                              }).join(' ')}
                              fill="none"
                              stroke="#6366f1"
                              strokeWidth="2"
                              strokeOpacity="0.4"
                           />
                           {/* Wave 2 */}
                           <path
                              d={Array.from({ length: 100 }, (_, i) => {
                                 const x = (i / 100) * 800;
                                 const y = 150 + getWaveY(x, wave2);
                                 return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                              }).join(' ')}
                              fill="none"
                              stroke="#ec4899"
                              strokeWidth="2"
                              strokeOpacity="0.4"
                           />
                        </>
                     )}

                     {/* Resultant Wave */}
                     <path
                        d={Array.from({ length: 100 }, (_, i) => {
                           const x = (i / 100) * 800;
                           const y = 150 + getWaveY(x, wave1) + getWaveY(x, wave2);
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#22d3ee"
                        strokeWidth="5"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className="drop-shadow-[0_0_8px_rgba(34,211,238,0.5)]"
                     />
                  </svg>

                  {/* Interference Label */}
                  <div className="absolute top-8 left-8">
                     <div className="flex items-center gap-3">
                        <div className={`w-3 h-3 rounded-full ${Math.abs(wave1.phase - wave2.phase) < 0.1 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`} />
                        <span className="text-sm font-black tracking-widest uppercase">
                           {Math.abs(wave1.phase - wave2.phase) < 0.1 ? 'Constructive' : 'Destructive'} Interference
                        </span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  {/* Wave 1 Controls */}
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Wave A (Indigo)</p>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Amplitude</span>
                           <span className="text-white">{wave1.amp}</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max="80"
                           value={wave1.amp}
                           onChange={(e) => setWave1({ ...wave1, amp: parseInt(e.target.value) })}
                           className="w-full accent-indigo-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Frequency</span>
                           <span className="text-white">{wave1.freq.toFixed(1)}</span>
                        </div>
                        <input
                           type="range"
                           min="0.5"
                           max="5"
                           step="0.1"
                           value={wave1.freq}
                           onChange={(e) => setWave1({ ...wave1, freq: parseFloat(e.target.value) })}
                           className="w-full accent-indigo-500"
                        />
                     </div>
                  </div>

                  {/* Wave 2 Controls */}
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-pink-400 uppercase tracking-widest">Wave B (Pink)</p>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Amplitude</span>
                           <span className="text-white">{wave2.amp}</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max="80"
                           value={wave2.amp}
                           onChange={(e) => setWave2({ ...wave2, amp: parseInt(e.target.value) })}
                           className="w-full accent-pink-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Phase Shift</span>
                           <span className="text-white">{(wave2.phase * 180 / Math.PI).toFixed(0)}¬∞</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max={Math.PI * 2}
                           step="0.1"
                           value={wave2.phase}
                           onChange={(e) => setWave2({ ...wave2, phase: parseFloat(e.target.value) })}
                           className="w-full accent-pink-500"
                        />
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Waves don't bounce off each other. They <strong>pass through</strong>, and at every point, the total displacement is simply the sum of the individual waves.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- 2D WAVE INTERFERENCE RENDERER ---
   const WaveInterference2DRenderer = () => {
      const [sourceDist, setSourceDist] = useState(100);
      const [wavelength, setWavelength] = useState(40);
      const [showPathDiff, setShowPathDiff] = useState(false);
      const [probePos, setProbePos] = useState({ x: 400, y: 150 });
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      const s1 = { x: 400 - sourceDist / 2, y: 50 };
      const s2 = { x: 400 + sourceDist / 2, y: 50 };

      const d1 = Math.sqrt(Math.pow(probePos.x - s1.x, 2) + Math.pow(probePos.y - s1.y, 2));
      const d2 = Math.sqrt(Math.pow(probePos.x - s2.x, 2) + Math.pow(probePos.y - s2.y, 2));
      const pathDiff = Math.abs(d1 - d2);
      const phaseDiff = (pathDiff / wavelength) * 2 * Math.PI;

      const interference = Math.cos(phaseDiff / 2); // Amplitude factor

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">2D INTERFERENCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Two-Source Interference Pattern</p>
               </div>
               <button
                  onClick={() => setShowPathDiff(!showPathDiff)}
                  className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${showPathDiff ? 'bg-emerald-500/20 border-emerald-500 text-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
               >
                  {showPathDiff ? 'Hide Analysis' : 'Show Path Difference'}
               </button>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 overflow-hidden border-r border-slate-900 cursor-crosshair"
                  onMouseMove={(e) => {
                     const rect = e.currentTarget.getBoundingClientRect();
                     setProbePos({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                  }}
               >
                  <svg width="100%" height="100%" className="absolute inset-0">
                     <defs>
                        <radialGradient id="ripple1">
                           <stop offset="0%" stopColor="#10b981" stopOpacity="0.6" />
                           <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                        </radialGradient>
                     </defs>

                     {/* Sources */}
                     <circle cx={s1.x} cy={s1.y} r="6" fill="#10b981" className="animate-pulse" />
                     <circle cx={s2.x} cy={s2.y} r="6" fill="#10b981" className="animate-pulse" />

                     {/* Ripple Visualization (Simplified with concentric circles) */}
                     {[1, 2, 3, 4, 5].map(i => (
                        <React.Fragment key={i}>
                           <circle
                              cx={s1.x}
                              cy={s1.y}
                              r={((time * 20 + i * wavelength) % 400)}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="2"
                              strokeOpacity={Math.max(0, 1 - ((time * 20 + i * wavelength) % 400) / 400)}
                           />
                           <circle
                              cx={s2.x}
                              cy={s2.y}
                              r={((time * 20 + i * wavelength) % 400)}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="2"
                              strokeOpacity={Math.max(0, 1 - ((time * 20 + i * wavelength) % 400) / 400)}
                           />
                        </React.Fragment>
                     ))}

                     {/* Probe Lines */}
                     {showPathDiff && (
                        <>
                           <line x1={s1.x} y1={s1.y} x2={probePos.x} y2={probePos.y} stroke="#64748b" strokeWidth="1" strokeDasharray="4 4" />
                           <line x1={s2.x} y1={s2.y} x2={probePos.x} y2={probePos.y} stroke="#64748b" strokeWidth="1" strokeDasharray="4 4" />
                           <circle cx={probePos.x} cy={probePos.y} r="10" fill={Math.abs(interference) > 0.7 ? '#10b981' : '#ef4444'} fillOpacity="0.3" stroke={Math.abs(interference) > 0.7 ? '#10b981' : '#ef4444'} strokeWidth="2" />
                        </>
                     )}
                  </svg>

                  {/* Probe Info Overlay */}
                  <div className="absolute bottom-8 left-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-2">
                     <div className="flex justify-between gap-8">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Path Diff (Œîd)</span>
                        <span className="text-xs font-bold text-white">{pathDiff.toFixed(1)} px</span>
                     </div>
                     <div className="flex justify-between gap-8">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">In Wavelengths</span>
                        <span className="text-xs font-bold text-emerald-400">{(pathDiff / wavelength).toFixed(2)} Œª</span>
                     </div>
                     <div className="pt-2 border-t border-slate-800">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Interference</p>
                        <p className={`text-sm font-black ${(pathDiff / wavelength) % 1 < 0.1 || (pathDiff / wavelength) % 1 > 0.9 ? 'text-emerald-400' : Math.abs((pathDiff / wavelength) % 1 - 0.5) < 0.1 ? 'text-red-400' : 'text-white'}`}>
                           {(pathDiff / wavelength) % 1 < 0.1 || (pathDiff / wavelength) % 1 > 0.9 ? 'CONSTRUCTIVE' : Math.abs((pathDiff / wavelength) % 1 - 0.5) < 0.1 ? 'DESTRUCTIVE' : 'INTERMEDIATE'}
                        </p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Source Separation</label>
                     <input
                        type="range"
                        min="20"
                        max="300"
                        value={sourceDist}
                        onChange={(e) => setSourceDist(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Narrow</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{sourceDist} px</span>
                        <span>Wide</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="10"
                        max="100"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{wavelength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Interference depends on the <strong>Path Difference</strong>. If the difference is a whole number of wavelengths (1Œª, 2Œª...), the waves arrive in phase and add up.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- STANDING WAVE RENDERER ---
   const StandingWaveRenderer = () => {
      const [harmonic, setHarmonic] = useState(1);
      const [type, setType] = useState<'string' | 'openPipe' | 'closedPipe'>('string');
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      const getAmplitude = (x: number) => {
         const L = 600;
         if (type === 'string') {
            // Nodes at both ends: sin(nœÄx/L)
            return Math.sin((harmonic * Math.PI * x) / L);
         } else if (type === 'openPipe') {
            // Antinodes at both ends: cos(nœÄx/L)
            return Math.cos((harmonic * Math.PI * x) / L);
         } else {
            // Node at one end, antinode at other: sin((2n-1)œÄx/2L)
            return Math.sin(((2 * harmonic - 1) * Math.PI * x) / (2 * L));
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">STANDING WAVES</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Resonance & Harmonics</p>
               </div>
               <div className="flex gap-2">
                  {(['string', 'openPipe', 'closedPipe'] as const).map(t => (
                     <button
                        key={t}
                        onClick={() => { setType(t); setHarmonic(1); }}
                        className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${type === t ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {t === 'string' ? 'String' : t === 'openPipe' ? 'Open Pipe' : 'Closed Pipe'}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="200" className="overflow-visible">
                     {/* Boundary Markers */}
                     <line x1="0" y1="0" x2="0" y2="200" stroke={type === 'string' || type === 'closedPipe' ? '#f97316' : '#1e293b'} strokeWidth="4" />
                     <line x1="600" y1="0" x2="600" y2="200" stroke={type === 'string' ? '#f97316' : '#1e293b'} strokeWidth="4" />

                     {/* Wave Path */}
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 + amp * Math.sin(time * 5) * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="3"
                        strokeLinecap="round"
                     />

                     {/* Envelope */}
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 + amp * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="1"
                        strokeDasharray="4 4"
                        strokeOpacity="0.3"
                     />
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 - amp * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="1"
                        strokeDasharray="4 4"
                        strokeOpacity="0.3"
                     />

                     {/* Node/Antinode Labels */}
                     {Array.from({ length: harmonic + 1 }).map((_, i) => {
                        const x = (i / harmonic) * 600;
                        const amp = getAmplitude(x);
                        const isNode = Math.abs(amp) < 0.1;
                        return (
                           <g key={i} transform={`translate(${x}, 100)`}>
                              <circle r="4" fill={isNode ? '#ef4444' : '#3b82f6'} />
                              <text y={isNode ? 20 : -20} textAnchor="middle" className="text-[10px] font-bold fill-slate-500">
                                 {isNode ? 'NODE' : 'ANTINODE'}
                              </text>
                           </g>
                        );
                     })}
                  </svg>

                  {/* Harmonic Info */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Harmonic (n)</p>
                     <p className="text-2xl font-black text-white tabular-nums">
                        {harmonic}
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Harmonic Number</label>
                     <div className="grid grid-cols-4 gap-2">
                        {[1, 2, 3, 4, 5, 6, 7, 8].map(h => (
                           <button
                              key={h}
                              onClick={() => setHarmonic(h)}
                              className={`py-2 rounded-lg text-xs font-bold transition-all ${harmonic === h ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                           >
                              {h}
                           </button>
                        ))}
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Standing waves occur when waves reflect and interfere. <strong>Nodes</strong> are points of zero motion, while <strong>Antinodes</strong> are points of maximum motion.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RESONANCE RENDERER ---
   const ResonanceRenderer = () => {
      const [driveFreq, setDriveFreq] = useState(1.0);
      const [naturalFreq, setNaturalFreq] = useState(2.0);
      const [damping, setDamping] = useState(0.1);
      const [time, setTime] = useState(0);
      const [history, setHistory] = useState<number[]>([]);

      useEffect(() => {
         const interval = setInterval(() => {
            setTime(t => t + 0.1);
         }, 30);
         return () => clearInterval(interval);
      }, []);

      // Simple damped driven oscillator approximation for visualization
      const amplitude = 1 / Math.sqrt(Math.pow(Math.pow(naturalFreq, 2) - Math.pow(driveFreq, 2), 2) + Math.pow(driveFreq * damping, 2));
      const currentPos = Math.sin(time * driveFreq * 2 * Math.PI) * amplitude * 20;

      useEffect(() => {
         setHistory(prev => [...prev.slice(-100), currentPos]);
      }, [time]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-rose-400">RESONANCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Driven Oscillations</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setDriveFreq(naturalFreq)}
                     className="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-rose-500/20 transition-all active:scale-95"
                  >
                     Match Natural Freq
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Oscillator Visual */}
                  <div className="relative h-64 w-full flex items-center justify-center">
                     {/* Spring/Support */}
                     <div className="absolute top-0 w-32 h-2 bg-slate-800 rounded-full" />
                     <svg width="40" height="200" className="absolute top-2">
                        <path
                           d={`M 20,0 ${Array.from({ length: 20 }, (_, i) => {
                              const y = (i + 1) * (100 + currentPos) / 20;
                              const x = 20 + (i % 2 === 0 ? 10 : -10);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none"
                           stroke="#475569"
                           strokeWidth="2"
                        />
                     </svg>
                     {/* Mass */}
                     <div
                        className="absolute w-16 h-16 bg-gradient-to-br from-rose-500 to-rose-700 rounded-2xl shadow-2xl border-2 border-rose-400/50 flex items-center justify-center"
                        style={{ transform: `translateY(${currentPos}px)` }}
                     >
                        <i className="fa-solid fa-weight-hanging text-white/50 text-2xl"></i>
                     </div>
                  </div>

                  {/* Waveform History */}
                  <div className="w-full h-32 mt-8 bg-black/40 rounded-2xl border border-slate-800 overflow-hidden relative">
                     <svg width="100%" height="100%" preserveAspectRatio="none" viewBox="0 0 100 100">
                        <path
                           d={`M 0,50 ${history.map((h, i) => `L ${i},${50 + h}`).join(' ')}`}
                           fill="none"
                           stroke="#fb7185"
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-4 text-[8px] font-black text-slate-600 uppercase tracking-widest">Amplitude Response</div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-rose-400 uppercase tracking-widest">Driving Frequency (Hz)</label>
                     <input
                        type="range"
                        min="0.1"
                        max="5.0"
                        step="0.1"
                        value={driveFreq}
                        onChange={(e) => setDriveFreq(parseFloat(e.target.value))}
                        className="w-full accent-rose-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.1 Hz</span>
                        <span className="text-white bg-rose-500/20 px-2 py-0.5 rounded">{driveFreq.toFixed(1)} Hz</span>
                        <span>5.0 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Natural Frequency (Hz)</label>
                     <input
                        type="range"
                        min="0.5"
                        max="4.0"
                        step="0.1"
                        value={naturalFreq}
                        onChange={(e) => setNaturalFreq(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.5 Hz</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{naturalFreq.toFixed(1)} Hz</span>
                        <span>4.0 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Damping (Friction)</label>
                     <input
                        type="range"
                        min="0.01"
                        max="0.5"
                        step="0.01"
                        value={damping}
                        onChange={(e) => setDamping(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Low</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{damping.toFixed(2)}</span>
                        <span>High</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-rose-500/10 rounded-3xl border border-rose-500/20">
                     <p className="text-[10px] font-bold text-rose-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Resonance happens when the <strong>Driving Frequency</strong> matches the <strong>Natural Frequency</strong>. Energy builds up, leading to massive oscillations.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DOPPLER EFFECT RENDERER ---
   const DopplerEffectRenderer = () => {
      const [sourceVel, setSourceVel] = useState(0);
      const [observerVel, setObserverVel] = useState(0);
      const [freq, setFreq] = useState(2);
      const [time, setTime] = useState(0);
      const [ripples, setRipples] = useState<{ x: number, t: number }[]>([]);

      const speedOfSound = 340;

      useEffect(() => {
         const interval = setInterval(() => {
            setTime(t => t + 0.1);
            setRipples(prev => [...prev.slice(-20), { x: (time * sourceVel) % 800, t: time }]);
         }, 50);
         return () => clearInterval(interval);
      }, [time, sourceVel]);

      const sourcePos = (time * sourceVel) % 800;
      const observerPos = 600;

      // Frequency at observer: f' = f * (v + vo) / (v - vs)
      const observedFreq = freq * (speedOfSound + observerVel) / (speedOfSound - sourceVel);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">DOPPLER EFFECT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Frequency Shift due to Motion</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => { setSourceVel(0); setObserverVel(0); }}
                     className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded-xl text-xs font-bold transition-all"
                  >
                     Reset Motion
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Road/Path */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="8 8" />

                     {/* Ripples */}
                     {ripples.map((r, i) => (
                        <circle
                           key={i}
                           cx={r.x}
                           cy="200"
                           r={(time - r.t) * speedOfSound * 0.5}
                           fill="none"
                           stroke="#3b82f6"
                           strokeWidth="2"
                           strokeOpacity={Math.max(0, 1 - (time - r.t) * 0.5)}
                        />
                     ))}

                     {/* Source (Ambulance/Car) */}
                     <g transform={`translate(${sourcePos}, 200)`}>
                        <rect x="-20" y="-10" width="40" height="20" fill="#ef4444" rx="4" />
                        <circle cx="-10" cy="10" r="4" fill="#000" />
                        <circle cx="10" cy="10" r="4" fill="#000" />
                        <text y="-20" textAnchor="middle" className="text-[10px] font-black fill-red-400">SOURCE</text>
                     </g>

                     {/* Observer */}
                     <g transform={`translate(${observerPos}, 200)`}>
                        <circle r="10" fill="#10b981" />
                        <text y="-20" textAnchor="middle" className="text-[10px] font-black fill-emerald-400">OBSERVER</text>
                     </g>
                  </svg>

                  {/* Frequency Comparison */}
                  <div className="absolute top-8 left-8 flex gap-4">
                     <div className="bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Source Freq</p>
                        <p className="text-xl font-black text-white tabular-nums">{freq.toFixed(1)} <span className="text-xs text-slate-500">Hz</span></p>
                     </div>
                     <div className="bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Observed Freq</p>
                        <p className={`text-xl font-black tabular-nums ${observedFreq > freq ? 'text-blue-400' : observedFreq < freq ? 'text-red-400' : 'text-white'}`}>
                           {observedFreq.toFixed(1)} <span className="text-xs text-slate-500">Hz</span>
                        </p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Source Velocity (vs)</label>
                     <input
                        type="range"
                        min="-200"
                        max="200"
                        value={sourceVel}
                        onChange={(e) => setSourceVel(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Away</span>
                        <span className="text-white bg-blue-500/20 px-2 py-0.5 rounded">{sourceVel} m/s</span>
                        <span>Towards</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Observer Velocity (vo)</label>
                     <input
                        type="range"
                        min="-100"
                        max="100"
                        value={observerVel}
                        onChange={(e) => setObserverVel(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Away</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{observerVel} m/s</span>
                        <span>Towards</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-blue-500/10 rounded-3xl border border-blue-500/20">
                     <p className="text-[10px] font-bold text-blue-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        When the source moves <strong>towards</strong> you, wave crests are bunched together, resulting in a <strong>higher pitch</strong>. As it moves away, they spread out.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- SNELL'S LAW RENDERER ---
   const SnellsLawRenderer = () => {
      const [n1, setN1] = useState(1.0); // Air
      const [n2, setN2] = useState(1.5); // Glass
      const [angle1, setAngle1] = useState(45); // Degrees

      const angle1Rad = (angle1 * Math.PI) / 180;
      // n1 sin Œ∏1 = n2 sin Œ∏2 => sin Œ∏2 = (n1/n2) * sin Œ∏1
      const sinTheta2 = (n1 / n2) * Math.sin(angle1Rad);
      const isTIR = sinTheta2 > 1;
      const angle2Rad = isTIR ? 0 : Math.asin(sinTheta2);
      const angle2 = (angle2Rad * 180) / Math.PI;

      const centerX = 400;
      const centerY = 200;
      const rayLength = 150;

      const x1 = centerX - Math.sin(angle1Rad) * rayLength;
      const y1 = centerY - Math.cos(angle1Rad) * rayLength;

      const x2 = centerX + Math.sin(angle2Rad) * rayLength;
      const y2 = centerY + Math.cos(angle2Rad) * rayLength;

      // Reflection ray for TIR or partial reflection
      const xr = centerX + Math.sin(angle1Rad) * rayLength;
      const yr = centerY - Math.cos(angle1Rad) * rayLength;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">SNELL'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Refraction & Index of Refraction</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => { setN1(1.0); setN2(1.5); }} className="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold">Air ‚Üí Glass</button>
                  <button onClick={() => { setN1(1.5); setN2(1.0); }} className="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold">Glass ‚Üí Air</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Mediums */}
                     <rect x="0" y="200" width="800" height="200" fill="#0ea5e9" fillOpacity="0.1" />
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#38bdf8" strokeWidth="2" />

                     {/* Normal Line */}
                     <line x1="400" y1="50" x2="400" y2="350" stroke="#475569" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Incident Ray */}
                     <line x1={x1} y1={y1} x2={centerX} y2={centerY} stroke="#fbbf24" strokeWidth="3" />
                     <circle cx={x1} cy={y1} r="4" fill="#fbbf24" />

                     {/* Refracted Ray */}
                     {!isTIR && (
                        <line x1={centerX} y1={centerY} x2={x2} y2={y2} stroke="#fbbf24" strokeWidth="3" />
                     )}

                     {/* TIR Ray */}
                     {isTIR && (
                        <line x1={centerX} y1={centerY} x2={xr} y2={yr} stroke="#f87171" strokeWidth="3" strokeDasharray="4 4" />
                     )}

                     {/* Angle Labels */}
                     <text x={centerX - 30} y={centerY - 50} textAnchor="end" className="text-[10px] font-bold fill-amber-400">Œ∏‚ÇÅ = {angle1.toFixed(1)}¬∞</text>
                     {!isTIR && (
                        <text x={centerX + 30} y={centerY + 50} textAnchor="start" className="text-[10px] font-bold fill-amber-400">Œ∏‚ÇÇ = {angle2.toFixed(1)}¬∞</text>
                     )}
                     {isTIR && (
                        <text x={centerX + 40} y={centerY - 40} textAnchor="start" className="text-[10px] font-black fill-red-500">TIR ACTIVE</text>
                     )}

                     {/* Medium Labels */}
                     <text x="20" y="180" className="text-[10px] font-black fill-slate-500 uppercase tracking-widest">Medium 1 (n={n1.toFixed(2)})</text>
                     <text x="20" y="230" className="text-[10px] font-black fill-sky-500 uppercase tracking-widest">Medium 2 (n={n2.toFixed(2)})</text>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Incident Angle (Œ∏‚ÇÅ)</label>
                     <input
                        type="range"
                        min="0"
                        max="90"
                        value={angle1}
                        onChange={(e) => setAngle1(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{angle1}¬∞</span>
                        <span>90¬∞</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Index n‚ÇÅ</label>
                     <input
                        type="range"
                        min="1.0"
                        max="2.5"
                        step="0.01"
                        value={n1}
                        onChange={(e) => setN1(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1.0</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{n1.toFixed(2)}</span>
                        <span>2.5</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-sky-400 uppercase tracking-widest">Index n‚ÇÇ</label>
                     <input
                        type="range"
                        min="1.0"
                        max="2.5"
                        step="0.01"
                        value={n2}
                        onChange={(e) => setN2(parseFloat(e.target.value))}
                        className="w-full accent-sky-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1.0</span>
                        <span className="text-white bg-sky-500/20 px-2 py-0.5 rounded">{n2.toFixed(2)}</span>
                        <span>2.5</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light bends <strong>towards</strong> the normal when entering a denser medium (higher n). If it enters a less dense medium at a steep enough angle, it reflects completely (TIR).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- TIR RENDERER ---
   const TIRRenderer = () => {
      const [n1, setN1] = useState(1.5); // Glass
      const [n2, setN2] = useState(1.0); // Air
      const [angle, setAngle] = useState(30);

      const criticalAngle = (Math.asin(n2 / n1) * 180) / Math.PI;
      const isTIR = angle > criticalAngle;

      const angleRad = (angle * Math.PI) / 180;
      const centerX = 400;
      const centerY = 200;

      // Incident ray
      const x1 = centerX - Math.sin(angleRad) * 150;
      const y1 = centerY + Math.cos(angleRad) * 150;

      // Refracted/Reflected ray
      let x2, y2;
      if (isTIR) {
         x2 = centerX + Math.sin(angleRad) * 150;
         y2 = centerY + Math.cos(angleRad) * 150;
      } else {
         const angle2Rad = Math.asin((n1 / n2) * Math.sin(angleRad));
         x2 = centerX + Math.sin(angle2Rad) * 150;
         y2 = centerY - Math.cos(angle2Rad) * 150;
      }

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">TOTAL INTERNAL REFLECTION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">The Critical Angle</p>
               </div>
               <div className="bg-indigo-500/20 px-4 py-2 rounded-xl border border-indigo-500/30">
                  <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Critical Angle (Œ∏c)</p>
                  <p className="text-sm font-black text-white">{criticalAngle.toFixed(1)}¬∞</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Mediums */}
                     <rect x="0" y="200" width="800" height="200" fill="#6366f1" fillOpacity="0.1" />
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#818cf8" strokeWidth="2" />

                     {/* Normal */}
                     <line x1="400" y1="50" x2="400" y2="350" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Incident Ray */}
                     <line x1={x1} y1={y1} x2={centerX} y2={centerY} stroke="#fcd34d" strokeWidth="4" />

                     {/* Output Ray */}
                     <line x1={centerX} y1={centerY} x2={x2} y2={y2} stroke={isTIR ? '#f87171' : '#fcd34d'} strokeWidth={isTIR ? 4 : 2} strokeDasharray={isTIR ? 'none' : '4 4'} />

                     {/* Labels */}
                     <text x="20" y="230" className="text-[10px] font-black fill-indigo-400 uppercase tracking-widest">Dense Medium (n={n1.toFixed(2)})</text>
                     <text x="20" y="180" className="text-[10px] font-black fill-slate-500 uppercase tracking-widest">Less Dense (n={n2.toFixed(2)})</text>

                     {isTIR && (
                        <g transform={`translate(${centerX + 50}, ${centerY + 50})`}>
                           <text className="text-sm font-black fill-red-500">TRAPPED!</text>
                        </g>
                     )}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Incident Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="90"
                        value={angle}
                        onChange={(e) => setAngle(parseInt(e.target.value))}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{angle}¬∞</span>
                        <span>90¬∞</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Condition for TIR</p>
                     <ul className="text-[10px] text-slate-500 space-y-1">
                        <li className="flex items-center gap-2">
                           <div className={`w-1.5 h-1.5 rounded-full ${n1 > n2 ? 'bg-green-500' : 'bg-red-500'}`} />
                           Dense ‚Üí Less Dense
                        </li>
                        <li className="flex items-center gap-2">
                           <div className={`w-1.5 h-1.5 rounded-full ${angle > criticalAngle ? 'bg-green-500' : 'bg-red-500'}`} />
                           Angle &gt; Critical Angle
                        </li>
                     </ul>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This is how <strong>Fiber Optics</strong> work! Light is reflected back into the glass over and over, allowing it to travel long distances without escaping.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LENS RENDERER ---
   const LensRenderer = () => {
      const [focalLength, setFocalLength] = useState(100); // Positive for converging, negative for diverging
      const [objDist, setObjDist] = useState(200);
      const [objHeight, setObjHeight] = useState(50);

      // 1/f = 1/do + 1/di => 1/di = 1/f - 1/do = (do - f) / (f * do) => di = (f * do) / (do - f)
      const imgDist = (focalLength * objDist) / (objDist - focalLength);
      const magnification = -imgDist / objDist;
      const imgHeight = objHeight * magnification;

      const centerX = 400;
      const centerY = 200;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">LENS LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Ray Tracing & Image Formation</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setFocalLength(100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength > 0 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Converging</button>
                  <button onClick={() => setFocalLength(-100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength < 0 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Diverging</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Lens */}
                     <path
                        d={focalLength > 0
                           ? "M 400,100 Q 430,200 400,300 Q 370,200 400,100"
                           : "M 390,100 Q 410,200 390,300 L 410,300 Q 390,200 410,100 Z"}
                        fill="#0ea5e9"
                        fillOpacity="0.2"
                        stroke="#0ea5e9"
                        strokeWidth="2"
                     />

                     {/* Focal Points */}
                     <circle cx={centerX - focalLength} cy="200" r="3" fill="#ef4444" />
                     <circle cx={centerX + focalLength} cy="200" r="3" fill="#ef4444" />
                     <text x={centerX - focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>
                     <text x={centerX + focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>

                     {/* Object */}
                     <line x1={centerX - objDist} y1="200" x2={centerX - objDist} y2={200 - objHeight} stroke="#fbbf24" strokeWidth="4" />
                     <path d={`M ${centerX - objDist - 5},${200 - objHeight + 10} L ${centerX - objDist},${200 - objHeight} L ${centerX - objDist + 5},${200 - objHeight + 10}`} fill="none" stroke="#fbbf24" strokeWidth="2" />

                     {/* Image */}
                     {Math.abs(objDist - focalLength) > 1 && (
                        <>
                           <line
                              x1={centerX + imgDist}
                              y1="200"
                              x2={centerX + imgDist}
                              y2={200 - imgHeight}
                              stroke="#3b82f6"
                              strokeWidth="4"
                              strokeOpacity="0.6"
                              strokeDasharray={imgDist < 0 ? "4 4" : "none"}
                           />
                           <path
                              d={`M ${centerX + imgDist - 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)} L ${centerX + imgDist},${200 - imgHeight} L ${centerX + imgDist + 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)}`}
                              fill="none"
                              stroke="#3b82f6"
                              strokeWidth="2"
                              strokeOpacity="0.6"
                           />
                        </>
                     )}

                     {/* Rays */}
                     {/* Ray 1: Parallel to axis, then through focal point */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX} y2={200 - objHeight} stroke="#475569" strokeWidth="1" />
                     <line x1={centerX} y1={200 - objHeight} x2={centerX + 400} y2={200 - objHeight + (400 * (objHeight / focalLength))} stroke="#475569" strokeWidth="1" />

                     {/* Ray 2: Through center of lens */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX + 400} y2={200 - objHeight + (400 + objDist) * (objHeight / objDist)} stroke="#475569" strokeWidth="1" />
                  </svg>

                  {/* Stats Overlay */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-3">
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Image Type</p>
                        <p className="text-sm font-black text-white">
                           {imgDist > 0 ? 'REAL' : 'VIRTUAL'} & {Math.abs(magnification) > 1 ? 'MAGNIFIED' : 'REDUCED'}
                        </p>
                     </div>
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Magnification</p>
                        <p className="text-sm font-black text-emerald-400">{magnification.toFixed(2)}x</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Object Distance (do)</label>
                     <input
                        type="range"
                        min="10"
                        max="400"
                        value={objDist}
                        onChange={(e) => setObjDist(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Close</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{objDist} px</span>
                        <span>Far</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Focal Length (f)</label>
                     <input
                        type="range"
                        min={focalLength > 0 ? 20 : -200}
                        max={focalLength > 0 ? 200 : -20}
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Real images</strong> are formed where rays actually meet (can be projected). <strong>Virtual images</strong> are where rays only <em>appear</em> to come from.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- MIRROR RENDERER ---
   const MirrorRenderer = () => {
      const [focalLength, setFocalLength] = useState(100); // Positive for concave, negative for convex
      const [objDist, setObjDist] = useState(200);
      const [objHeight, setObjHeight] = useState(50);

      // 1/f = 1/do + 1/di => 1/di = 1/f - 1/do => di = (f * do) / (do - f)
      const imgDist = (focalLength * objDist) / (objDist - focalLength);
      const magnification = -imgDist / objDist;
      const imgHeight = objHeight * magnification;

      const centerX = 400;
      const centerY = 200;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-400">MIRROR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Reflection & Image Formation</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setFocalLength(100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength > 0 ? 'bg-amber-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Concave</button>
                  <button onClick={() => setFocalLength(-100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength < 0 ? 'bg-amber-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Convex</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Mirror */}
                     <path
                        d={focalLength > 0
                           ? "M 400,100 Q 370,200 400,300"
                           : "M 400,100 Q 430,200 400,300"}
                        fill="none"
                        stroke="#94a3b8"
                        strokeWidth="8"
                        strokeLinecap="round"
                     />

                     {/* Focal Points */}
                     <circle cx={centerX - focalLength} cy="200" r="3" fill="#ef4444" />
                     <text x={centerX - focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>

                     {/* Object */}
                     <line x1={centerX - objDist} y1="200" x2={centerX - objDist} y2={200 - objHeight} stroke="#fbbf24" strokeWidth="4" />
                     <path d={`M ${centerX - objDist - 5},${200 - objHeight + 10} L ${centerX - objDist},${200 - objHeight} L ${centerX - objDist + 5},${200 - objHeight + 10}`} fill="none" stroke="#fbbf24" strokeWidth="2" />

                     {/* Image */}
                     {Math.abs(objDist - focalLength) > 1 && (
                        <>
                           <line
                              x1={centerX - imgDist}
                              y1="200"
                              x2={centerX - imgDist}
                              y2={200 - imgHeight}
                              stroke="#f59e0b"
                              strokeWidth="4"
                              strokeOpacity="0.6"
                              strokeDasharray={imgDist < 0 ? "4 4" : "none"}
                           />
                           <path
                              d={`M ${centerX - imgDist - 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)} L ${centerX - imgDist},${200 - imgHeight} L ${centerX - imgDist + 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)}`}
                              fill="none"
                              stroke="#f59e0b"
                              strokeWidth="2"
                              strokeOpacity="0.6"
                           />
                        </>
                     )}

                     {/* Rays */}
                     {/* Ray 1: Parallel to axis, then through focal point */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX} y2={200 - objHeight} stroke="#475569" strokeWidth="1" />
                     <line x1={centerX} y1={200 - objHeight} x2={centerX - 400} y2={200 - objHeight + (400 * (objHeight / focalLength))} stroke="#475569" strokeWidth="1" />
                  </svg>

                  {/* Stats Overlay */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-3">
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Image Type</p>
                        <p className="text-sm font-black text-white">
                           {imgDist > 0 ? 'REAL' : 'VIRTUAL'} & {Math.abs(magnification) > 1 ? 'MAGNIFIED' : 'REDUCED'}
                        </p>
                     </div>
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Magnification</p>
                        <p className="text-sm font-black text-amber-400">{magnification.toFixed(2)}x</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Object Distance (do)</label>
                     <input
                        type="range"
                        min="10"
                        max="400"
                        value={objDist}
                        onChange={(e) => setObjDist(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Close</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{objDist} px</span>
                        <span>Far</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Focal Length (f)</label>
                     <input
                        type="range"
                        min={focalLength > 0 ? 20 : -200}
                        max={focalLength > 0 ? 200 : -20}
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-amber-500/10 rounded-3xl border border-amber-500/20">
                     <p className="text-[10px] font-bold text-amber-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Concave mirrors</strong> can form real or virtual images depending on object position. <strong>Convex mirrors</strong> always form virtual, reduced, upright images.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- POLARIZATION RENDERER ---
   const PolarizationRenderer = () => {
      const [angle1, setAngle1] = useState(0);
      const [angle2, setAngle2] = useState(90);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // Malus's Law: I = I0 * cos^2(theta)
      const relativeAngle = Math.abs(angle1 - angle2);
      const intensity = Math.pow(Math.cos((relativeAngle * Math.PI) / 180), 2);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">POLARIZATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Malus's Law & Wave Filtering</p>
               </div>
               <div className="bg-purple-500/20 px-4 py-2 rounded-xl border border-purple-500/30">
                  <p className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Light Intensity</p>
                  <p className="text-sm font-black text-white">{(intensity * 100).toFixed(0)}%</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Unpolarized Light */}
                     <g transform="translate(50, 150)">
                        {[0, 45, 90, 135].map(a => (
                           <line key={a} x1="-30" y1="0" x2="30" y2="0" stroke="#fff" strokeWidth="1" strokeOpacity="0.3" transform={`rotate(${a})`} />
                        ))}
                        <text y="50" textAnchor="middle" className="text-[8px] fill-slate-500 font-bold">UNPOLARIZED</text>
                     </g>

                     {/* Polarizer 1 */}
                     <g transform={`translate(200, 150)`}>
                        <rect x="-40" y="-60" width="80" height="120" fill="#1e293b" rx="8" stroke="#475569" />
                        {/* Slits */}
                        {Array.from({ length: 7 }).map((_, i) => (
                           <line key={i} x1="-30" y1={-45 + i * 15} x2="30" y2={-45 + i * 15} stroke="#334155" strokeWidth="2" transform={`rotate(${angle1})`} />
                        ))}
                        <text y="80" textAnchor="middle" className="text-[8px] fill-purple-400 font-bold">POLARIZER A ({angle1}¬∞)</text>
                     </g>

                     {/* Polarized Light (Between) */}
                     <g transform="translate(325, 150)">
                        <line x1="-30" y1="0" x2="30" y2="0" stroke="#a855f7" strokeWidth="3" transform={`rotate(${angle1})`} />
                        <text y="50" textAnchor="middle" className="text-[8px] fill-slate-500 font-bold">POLARIZED</text>
                     </g>

                     {/* Polarizer 2 (Analyzer) */}
                     <g transform={`translate(450, 150)`}>
                        <rect x="-40" y="-60" width="80" height="120" fill="#1e293b" rx="8" stroke="#475569" />
                        {/* Slits */}
                        {Array.from({ length: 7 }).map((_, i) => (
                           <line key={i} x1="-30" y1={-45 + i * 15} x2="30" y2={-45 + i * 15} stroke="#334155" strokeWidth="2" transform={`rotate(${angle2})`} />
                        ))}
                        <text y="80" textAnchor="middle" className="text-[8px] fill-purple-400 font-bold">ANALYZER B ({angle2}¬∞)</text>
                     </g>

                     {/* Final Light */}
                     <g transform="translate(550, 150)">
                        <circle r={20 * intensity} fill="#fff" fillOpacity={0.8} className="blur-sm" />
                        <line x1="-20" y1="0" x2="20" y2="0" stroke="#fff" strokeWidth={3 * intensity} transform={`rotate(${angle2})`} />
                     </g>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Polarizer A Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="180"
                        value={angle1}
                        onChange={(e) => setAngle1(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-purple-500/20 px-2 py-0.5 rounded">{angle1}¬∞</span>
                        <span>180¬∞</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Analyzer B Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="180"
                        value={angle2}
                        onChange={(e) => setAngle2(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-purple-500/20 px-2 py-0.5 rounded">{angle2}¬∞</span>
                        <span>180¬∞</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Malus's Law</p>
                     <p className="text-[10px] font-mono text-purple-400 mb-2">I = I‚ÇÄ cos¬≤(Œ∏)</p>
                     <p className="text-[10px] text-slate-500 leading-tight">
                        When polarizers are <strong>crossed</strong> (90¬∞ apart), no light passes through.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-purple-500/10 rounded-3xl border border-purple-500/20">
                     <p className="text-[10px] font-bold text-purple-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light is a <strong>transverse wave</strong>. Polarizers act like fences that only let waves vibrating in a specific direction pass through.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DIFFRACTION RENDERER ---
   const DiffractionRenderer = () => {
      const [slitWidth, setSlitWidth] = useState(10); // micrometers
      const [wavelength, setWavelength] = useState(500); // nanometers
      const [distance, setDistance] = useState(1.0); // meters

      // Single Slit Diffraction: I(theta) = I0 * [sin(beta)/beta]^2 where beta = (pi * a * sin(theta)) / lambda
      // We'll approximate for a small range of angles
      const points = Array.from({ length: 200 }, (_, i) => {
         const x = (i - 100) / 10; // angle approximation
         const beta = (Math.PI * (slitWidth * 1e-6) * (x * 1e-3)) / (wavelength * 1e-9);
         const intensity = beta === 0 ? 1 : Math.pow(Math.sin(beta) / beta, 2);
         return { x: i, y: 100 - intensity * 80 };
      });

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">SINGLE SLIT DIFFRACTION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Wave Bending & Interference</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-2">
                     <div className="w-3 h-3 rounded-full" style={{ backgroundColor: `hsl(${(700 - wavelength) * 0.8}, 100%, 50%)` }} />
                     <span className="text-xs font-bold text-slate-400">{wavelength} nm</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Intensity Graph */}
                  <div className="w-full h-48 bg-black/40 rounded-2xl border border-slate-800 relative overflow-hidden mb-8">
                     <svg width="100%" height="100%" viewBox="0 0 200 100" preserveAspectRatio="none">
                        <path
                           d={`M ${points.map(p => `${p.x},${p.y}`).join(' L ')}`}
                           fill="none"
                           stroke={`hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`}
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-4 text-[8px] font-black text-slate-600 uppercase tracking-widest">Intensity Pattern</div>
                  </div>

                  {/* Visual Pattern */}
                  <div className="w-full h-12 rounded-lg relative overflow-hidden shadow-2xl shadow-orange-500/10">
                     <div
                        className="absolute inset-0"
                        style={{
                           background: `radial-gradient(circle at center, hsl(${(700 - wavelength) * 0.8}, 100%, 50%) 0%, transparent 70%)`,
                           backgroundSize: `${200 / (slitWidth / 5)}px 100%`,
                           opacity: 0.8
                        }}
                     />
                  </div>
                  <p className="mt-4 text-[8px] font-black text-slate-500 uppercase tracking-widest">Projected Fringe Pattern</p>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Slit Width (a)</label>
                     <input
                        type="range"
                        min="2"
                        max="50"
                        value={slitWidth}
                        onChange={(e) => setSlitWidth(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Narrow</span>
                        <span className="text-white bg-orange-500/20 px-2 py-0.5 rounded">{slitWidth} Œºm</span>
                        <span>Wide</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="380"
                        max="750"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Violet</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>Red</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        The <strong>narrower</strong> the slit, the <strong>wider</strong> the diffraction pattern. This proves light behaves as a wave, spreading out when it passes through small openings.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DISPERSION RENDERER ---
   const DispersionRenderer = () => {
      const [prismAngle, setPrismAngle] = useState(60);
      const [incidentAngle, setIncidentAngle] = useState(45);

      const colors = [
         { name: 'Red', wavelength: 700, n: 1.51 },
         { name: 'Orange', wavelength: 600, n: 1.52 },
         { name: 'Yellow', wavelength: 580, n: 1.53 },
         { name: 'Green', wavelength: 530, n: 1.54 },
         { name: 'Blue', wavelength: 470, n: 1.55 },
         { name: 'Violet', wavelength: 400, n: 1.56 },
      ];

      const centerX = 400;
      const centerY = 200;
      const prismSize = 150;

      // Prism vertices
      const p1 = { x: centerX, y: centerY - prismSize * 0.6 };
      const p2 = { x: centerX - prismSize * 0.5, y: centerY + prismSize * 0.4 };
      const p3 = { x: centerX + prismSize * 0.5, y: centerY + prismSize * 0.4 };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-pink-400">PRISM DISPERSION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Refractive Index & Wavelength</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Prism */}
                     <path d={`M ${p1.x},${p1.y} L ${p2.x},${p2.y} L ${p3.x},${p3.y} Z`} fill="#0ea5e9" fillOpacity="0.1" stroke="#0ea5e9" strokeWidth="2" />

                     {/* Incident White Light */}
                     <line x1="100" y1={centerY} x2={centerX - prismSize * 0.3} y2={centerY} stroke="#fff" strokeWidth="4" strokeOpacity="0.8" />
                     <text x="100" y={centerY - 10} className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">White Light</text>

                     {/* Dispersed Rays (Simplified Visualization) */}
                     {colors.map((c, i) => {
                        const offset = i * 4;
                        const angle = (i - 2.5) * 2;
                        return (
                           <g key={c.name}>
                              {/* Ray inside prism */}
                              <line
                                 x1={centerX - prismSize * 0.3}
                                 y1={centerY}
                                 x2={centerX + prismSize * 0.2}
                                 y2={centerY + offset}
                                 stroke={`hsl(${(700 - c.wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="1"
                                 strokeOpacity="0.5"
                              />
                              {/* Ray exiting prism */}
                              <line
                                 x1={centerX + prismSize * 0.2}
                                 y1={centerY + offset}
                                 x2={centerX + 300}
                                 y2={centerY + offset + 50 + i * 10}
                                 stroke={`hsl(${(700 - c.wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="2"
                              />
                           </g>
                        );
                     })}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-pink-400 uppercase tracking-widest">Prism Material</label>
                     <div className="grid grid-cols-2 gap-2">
                        <button className="px-3 py-2 bg-pink-500 text-white rounded-xl text-[10px] font-bold">Crown Glass</button>
                        <button className="px-3 py-2 bg-slate-800 text-slate-400 rounded-xl text-[10px] font-bold">Flint Glass</button>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Refractive Index (n)</p>
                     <div className="space-y-2">
                        {colors.filter((_, i) => i % 2 === 0).map(c => (
                           <div key={c.name} className="flex justify-between items-center">
                              <span className="text-[10px] font-bold text-slate-500">{c.name}</span>
                              <span className="text-[10px] font-mono text-white">{c.n}</span>
                           </div>
                        ))}
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-pink-500/10 rounded-3xl border border-pink-500/20">
                     <p className="text-[10px] font-bold text-pink-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Different colors of light have different <strong>wavelengths</strong>. Shorter wavelengths (Violet) slow down more and bend more than longer wavelengths (Red).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- THIN FILM RENDERER ---
   const ThinFilmRenderer = () => {
      const [thickness, setThickness] = useState(200); // nanometers
      const [nFilm, setNFilm] = useState(1.33); // Water/Oil
      const [wavelength, setWavelength] = useState(500);

      // Constructive interference: 2nt = (m + 1/2)lambda (if one phase shift)
      // or 2nt = m*lambda (if zero or two phase shifts)
      // For oil on water (n1=1 < n2=1.5 > n3=1.33), one phase shift at top.
      const phaseShift = 0.5;
      const m = Math.floor((2 * nFilm * thickness) / wavelength - phaseShift);
      const isConstructive = Math.abs((2 * nFilm * thickness) / wavelength - (m + phaseShift)) < 0.1;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-teal-400">THIN FILM INTERFERENCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Oil Slicks & Soap Bubbles</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Film Visual */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     {/* Top Layer (Air) */}
                     <div className="absolute top-0 w-full h-20 bg-slate-900/20 border-b border-slate-700 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Air (n=1.0)</span>
                     </div>
                     {/* Film Layer */}
                     <div
                        className="absolute w-full border-y border-teal-500/30 transition-all duration-300"
                        style={{
                           height: `${thickness / 2}px`,
                           backgroundColor: `hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`,
                           opacity: isConstructive ? 0.6 : 0.1,
                           boxShadow: isConstructive ? `0 0 40px hsl(${(700 - wavelength) * 0.8}, 100%, 50%, 0.3)` : 'none'
                        }}
                     >
                        <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent" />
                     </div>
                     {/* Bottom Layer (Substrate) */}
                     <div className="absolute bottom-0 w-full h-20 bg-slate-800/40 border-t border-slate-700 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Substrate (n=1.5)</span>
                     </div>

                     {/* Rays */}
                     <svg className="absolute inset-0 w-full h-full overflow-visible">
                        <path d="M 50,50 L 128,120 L 200,50" fill="none" stroke="#fff" strokeWidth="2" strokeOpacity="0.5" />
                        <path d="M 128,120 L 128,160 L 200,90" fill="none" stroke="#fff" strokeWidth="2" strokeOpacity="0.3" strokeDasharray="4 4" />
                     </svg>
                  </div>

                  <div className="mt-8 text-center">
                     <p className={`text-sm font-black ${isConstructive ? 'text-teal-400' : 'text-slate-600'}`}>
                        {isConstructive ? 'CONSTRUCTIVE INTERFERENCE' : 'DESTRUCTIVE INTERFERENCE'}
                     </p>
                     <p className="text-[10px] text-slate-500 mt-1">at {wavelength} nm</p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-teal-400 uppercase tracking-widest">Film Thickness (t)</label>
                     <input
                        type="range"
                        min="50"
                        max="500"
                        value={thickness}
                        onChange={(e) => setThickness(parseInt(e.target.value))}
                        className="w-full accent-teal-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>50 nm</span>
                        <span className="text-white bg-teal-500/20 px-2 py-0.5 rounded">{thickness} nm</span>
                        <span>500 nm</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="380"
                        max="750"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Violet</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>Red</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-teal-500/10 rounded-3xl border border-teal-500/20">
                     <p className="text-[10px] font-bold text-teal-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light reflects off both the <strong>top</strong> and <strong>bottom</strong> of the film. If these two reflections line up (constructive), that color becomes vivid.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RAY TRACING LAB RENDERER ---
   const RayTracingLabRenderer = () => {
      const [sourcePos, setSourcePos] = useState({ x: 100, y: 200 });
      const [focalLength, setFocalLength] = useState(100);
      const [numRays, setNumRays] = useState(5);

      const centerX = 400;
      const centerY = 200;

      const rays = Array.from({ length: numRays }, (_, i) => {
         const angle = (i - (numRays - 1) / 2) * 10; // degrees
         const angleRad = (angle * Math.PI) / 180;

         // Ray from source to lens plane (x = centerX)
         const dx = centerX - sourcePos.x;
         const dy = dx * Math.tan(angleRad);
         const hitY = sourcePos.y + dy;

         // Ray after lens
         // Using lens maker/ray transfer matrix logic simplified
         // For a thin lens: y2 = y1, theta2 = theta1 - y1/f
         const theta1 = angleRad;
         const y1 = hitY - centerY;
         const theta2 = theta1 - y1 / focalLength;

         const xEnd = centerX + 400;
         const yEnd = centerY + y1 + (400 * Math.tan(theta2));

         return { hitY, xEnd, yEnd };
      });

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">RAY TRACING LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multi-Ray Optics Sandbox</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Lens */}
                     <line x1={centerX} y1="50" x2={centerX} y2="350" stroke="#0ea5e9" strokeWidth="4" strokeOpacity="0.3" />
                     <text x={centerX} y="40" textAnchor="middle" className="text-[8px] font-black fill-sky-500 uppercase tracking-widest">Lens Plane</text>

                     {/* Rays */}
                     {rays.map((r, i) => (
                        <g key={i}>
                           <line x1={sourcePos.x} y1={sourcePos.y} x2={centerX} y2={r.hitY} stroke="#fbbf24" strokeWidth="1" strokeOpacity="0.4" />
                           <line x1={centerX} y1={r.hitY} x2={r.xEnd} y2={r.yEnd} stroke="#fbbf24" strokeWidth="1.5" strokeOpacity="0.8" />
                        </g>
                     ))}

                     {/* Light Source */}
                     <g
                        transform={`translate(${sourcePos.x}, ${sourcePos.y})`}
                        className="cursor-move"
                        onMouseDown={(e) => {
                           const svg = e.currentTarget.ownerSVGElement;
                           const move = (moveEvent: MouseEvent) => {
                              const pt = svg!.createSVGPoint();
                              pt.x = moveEvent.clientX;
                              pt.y = moveEvent.clientY;
                              const transformed = pt.matrixTransform(svg!.getScreenCTM()!.inverse());
                              setSourcePos({ x: Math.max(50, Math.min(centerX - 20, transformed.x)), y: transformed.y });
                           };
                           const up = () => {
                              window.removeEventListener('mousemove', move);
                              window.removeEventListener('mouseup', up);
                           };
                           window.addEventListener('mousemove', move);
                           window.addEventListener('mouseup', up);
                        }}
                     >
                        <circle r="12" fill="#fbbf24" className="animate-pulse" />
                        <circle r="6" fill="#fff" />
                        <text y="-20" textAnchor="middle" className="text-[8px] font-black fill-amber-400 uppercase tracking-widest">Source (Drag Me)</text>
                     </g>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-sky-400 uppercase tracking-widest">Focal Length</label>
                     <input
                        type="range"
                        min="50"
                        max="300"
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-sky-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-sky-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Number of Rays</label>
                     <input
                        type="range"
                        min="1"
                        max="21"
                        step="2"
                        value={numRays}
                        onChange={(e) => setNumRays(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{numRays}</span>
                        <span>21</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-blue-500/10 rounded-3xl border border-blue-500/20">
                     <p className="text-[10px] font-bold text-blue-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Notice how all rays from a single point on the source <strong>converge</strong> to a single point on the other side. This is how a clear image is formed!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- WAVE-PARTICLE DUALITY RENDERER ---
   const WaveParticleDualityRenderer = () => {
      const [mode, setMode] = useState<'wave' | 'particle'>('wave');
      const [intensity, setIntensity] = useState(50);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">WAVE-PARTICLE DUALITY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Quantum Mechanics & The Double Slit</p>
               </div>
               <div className="flex bg-slate-800 p-1 rounded-xl border border-slate-700">
                  <button
                     onClick={() => setMode('wave')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${mode === 'wave' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     WAVE
                  </button>
                  <button
                     onClick={() => setMode('particle')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${mode === 'particle' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     PARTICLE
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Slit Wall */}
                     <rect x="200" y="0" width="10" height="120" fill="#1e293b" />
                     <rect x="200" y="140" width="10" height="20" fill="#1e293b" />
                     <rect x="200" y="180" width="10" height="120" fill="#1e293b" />

                     {/* Source */}
                     <g transform="translate(50, 150)">
                        <circle r="10" fill="#06b6d4" className="animate-pulse" />
                        <text y="30" textAnchor="middle" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Electron Gun</text>
                     </g>

                     {/* Visualization */}
                     {mode === 'wave' ? (
                        <g>
                           {/* Interference Pattern */}
                           {Array.from({ length: 10 }).map((_, i) => (
                              <circle
                                 key={i}
                                 cx="205"
                                 cy="130"
                                 r={(time * 50 + i * 40) % 400}
                                 fill="none"
                                 stroke="#06b6d4"
                                 strokeWidth="1"
                                 strokeOpacity={Math.max(0, 1 - ((time * 50 + i * 40) % 400) / 400)}
                              />
                           ))}
                           {Array.from({ length: 10 }).map((_, i) => (
                              <circle
                                 key={i + 10}
                                 cx="205"
                                 cy="170"
                                 r={(time * 50 + i * 40) % 400}
                                 fill="none"
                                 stroke="#06b6d4"
                                 strokeWidth="1"
                                 strokeOpacity={Math.max(0, 1 - ((time * 50 + i * 40) % 400) / 400)}
                              />
                           ))}
                           {/* Screen Pattern */}
                           <rect x="550" y="0" width="20" height="300" fill="url(#interference-gradient)" />
                        </g>
                     ) : (
                        <g>
                           {/* Particles */}
                           {Array.from({ length: 20 }).map((_, i) => {
                              const t = (time + i * 0.5) % 4;
                              const x = 50 + t * 125;
                              const isTop = (i % 2 === 0);
                              const y = isTop ? 130 : 170;
                              return (
                                 <circle key={i} cx={x} cy={y} r="3" fill="#06b6d4" fillOpacity={x > 200 ? 1 : 0.2} />
                              );
                           })}
                           {/* Screen Pattern */}
                           <rect x="550" y="110" width="20" height="40" fill="#06b6d4" fillOpacity="0.8" />
                           <rect x="550" y="150" width="20" height="40" fill="#06b6d4" fillOpacity="0.8" />
                        </g>
                     )}

                     <defs>
                        <linearGradient id="interference-gradient" x1="0" y1="0" x2="0" y2="1">
                           <stop offset="0%" stopColor="transparent" />
                           <stop offset="20%" stopColor="#06b6d4" />
                           <stop offset="30%" stopColor="transparent" />
                           <stop offset="50%" stopColor="#06b6d4" />
                           <stop offset="70%" stopColor="transparent" />
                           <stop offset="80%" stopColor="#06b6d4" />
                           <stop offset="100%" stopColor="transparent" />
                        </linearGradient>
                     </defs>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-cyan-400 uppercase tracking-widest">Observation Mode</label>
                     <p className="text-[10px] text-slate-500 leading-relaxed">
                        {mode === 'wave'
                           ? "When unobserved, electrons travel as probability waves, interfering with themselves."
                           : "When we 'watch' which slit the electron goes through, the wave function collapses into a particle."}
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This is the heart of <strong>Quantum Mechanics</strong>. Matter is neither just a wave nor just a particle‚Äîit's both, until we measure it!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- PHOTOELECTRIC EFFECT RENDERER ---
   const PhotoelectricEffectRenderer = () => {
      const [wavelength, setWavelength] = useState(400); // nm
      const [intensity, setIntensity] = useState(50);
      const [workFunction, setWorkFunction] = useState(2.3); // eV (Sodium)
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // E = hf = hc/lambda
      const h = 4.1357e-15; // eV*s
      const c = 3e8; // m/s
      const photonEnergy = (h * c) / (wavelength * 1e-9);
      const maxKE = Math.max(0, photonEnergy - workFunction);
      const electronSpeed = Math.sqrt(maxKE) * 20; // scaled for visualization

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-400">PHOTOELECTRIC EFFECT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Photons & Electron Emission</p>
               </div>
               <div className="bg-amber-500/20 px-4 py-2 rounded-xl border border-amber-500/30">
                  <p className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Max Electron KE</p>
                  <p className="text-sm font-black text-white">{maxKE.toFixed(2)} eV</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Metal Plate */}
                     <rect x="400" y="50" width="20" height="200" fill="#475569" rx="4" />
                     <text x="410" y="270" textAnchor="middle" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Metal Plate</text>

                     {/* Photons */}
                     {Array.from({ length: Math.floor(intensity / 10) }).map((_, i) => {
                        const t = (time + i * 0.8) % 3;
                        const x = 50 + t * 115;
                        const y = 100 + i * 20;
                        return (
                           <g key={i} transform={`translate(${x}, ${y})`}>
                              <path
                                 d="M 0,0 Q 5,-5 10,0 Q 15,5 20,0"
                                 fill="none"
                                 stroke={`hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="2"
                              />
                              <circle r="2" fill="#fff" />
                           </g>
                        );
                     })}

                     {/* Electrons */}
                     {maxKE > 0 && Array.from({ length: Math.floor(intensity / 10) }).map((_, i) => {
                        const t = (time + i * 0.8) % 3;
                        if (t < 1.5) return null;
                        const x = 420 + (t - 1.5) * electronSpeed * 10;
                        const y = 100 + i * 20;
                        return (
                           <circle key={`e-${i}`} cx={x} cy={y} r="3" fill="#38bdf8" className="animate-pulse" />
                        );
                     })}
                  </svg>

                  {/* Energy Chart Overlay */}
                  <div className="absolute bottom-8 left-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <div className="flex items-end gap-2 h-24">
                        <div className="w-8 bg-amber-500/40 rounded-t-lg" style={{ height: `${photonEnergy * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-amber-400">PHOTON</p>
                        </div>
                        <div className="w-8 bg-slate-700 rounded-t-lg" style={{ height: `${workFunction * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-slate-400">WORK FN</p>
                        </div>
                        <div className="w-8 bg-sky-500/40 rounded-t-lg" style={{ height: `${maxKE * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-sky-400">KE MAX</p>
                        </div>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Light Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="200"
                        max="800"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>UV</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>IR</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Metal Work Function (Œ¶)</label>
                     <select
                        value={workFunction}
                        onChange={(e) => setWorkFunction(parseFloat(e.target.value))}
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-xs font-bold text-white outline-none focus:ring-2 focus:ring-amber-500/50"
                     >
                        <option value="2.3">Sodium (2.3 eV)</option>
                        <option value="4.3">Zinc (4.3 eV)</option>
                        <option value="4.7">Copper (4.7 eV)</option>
                        <option value="5.1">Platinum (5.1 eV)</option>
                     </select>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-amber-500/10 rounded-3xl border border-amber-500/20">
                     <p className="text-[10px] font-bold text-amber-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Increasing <strong>intensity</strong> (brightness) only ejects <em>more</em> electrons, but increasing <strong>frequency</strong> (shorter Œª) makes them fly <em>faster</em>.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LASER RENDERER ---
   const LaserRenderer = () => {
      const [isPumping, setIsPumping] = useState(false);
      const [atoms, setAtoms] = useState<{ id: number, state: 'ground' | 'excited', x: number, y: number }[]>(
         Array.from({ length: 20 }, (_, i) => ({
            id: i,
            state: 'ground',
            x: 50 + Math.random() * 300,
            y: 50 + Math.random() * 200
         }))
      );
      const [photons, setPhotons] = useState<{ id: number, x: number, y: number, direction: 1 | -1 }[]>([]);

      useEffect(() => {
         const interval = setInterval(() => {
            if (isPumping) {
               setAtoms(prev => prev.map(a => Math.random() > 0.9 ? { ...a, state: 'excited' } : a));
            } else {
               setAtoms(prev => prev.map(a => Math.random() > 0.98 ? { ...a, state: 'ground' } : a));
            }

            // Move photons
            setPhotons(prev => prev.map(p => ({ ...p, x: p.x + p.direction * 10 })).filter(p => p.x > 0 && p.x < 400));

            // Stimulated emission logic
            setAtoms(prev => {
               const nextAtoms = [...prev];
               setPhotons(prevPhotons => {
                  const nextPhotons = [...prevPhotons];
                  prevPhotons.forEach(p => {
                     nextAtoms.forEach((a, idx) => {
                        if (a.state === 'excited' && Math.abs(a.x - p.x) < 20 && Math.abs(a.y - p.y) < 20) {
                           nextAtoms[idx] = { ...a, state: 'ground' };
                           nextPhotons.push({ id: Math.random(), x: a.x, y: a.y, direction: p.direction });
                        }
                     });
                  });
                  return nextPhotons;
               });
               return nextAtoms;
            });
         }, 50);
         return () => clearInterval(interval);
      }, [isPumping]);

      const excitedCount = atoms.filter(a => a.state === 'excited').length;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-rose-400">LASER PHYSICS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Stimulated Emission & Pumping</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onMouseDown={() => setIsPumping(true)}
                     onMouseUp={() => setIsPumping(false)}
                     onMouseLeave={() => setIsPumping(false)}
                     className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isPumping ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/40 scale-95' : 'bg-slate-800 text-slate-400 hover:text-white'}`}
                  >
                     HOLD TO PUMP ENERGY
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative w-[400px] h-[300px] border-x-4 border-slate-700 bg-slate-900/20 rounded-lg">
                     {/* Mirrors */}
                     <div className="absolute -left-1 top-0 bottom-0 w-1 bg-slate-400 opacity-80 shadow-[0_0_15px_rgba(255,255,255,0.3)]" />
                     <div className="absolute -right-1 top-0 bottom-0 w-1 bg-slate-400 opacity-40" />

                     {/* Atoms */}
                     {atoms.map(a => (
                        <div
                           key={a.id}
                           className={`absolute w-4 h-4 rounded-full transition-colors duration-300 ${a.state === 'excited' ? 'bg-rose-500 shadow-[0_0_10px_#f43f5e]' : 'bg-slate-700'}`}
                           style={{ left: a.x, top: a.y }}
                        />
                     ))}

                     {/* Photons */}
                     {photons.map(p => (
                        <div
                           key={p.id}
                           className="absolute w-2 h-0.5 bg-rose-400 shadow-[0_0_8px_#fb7185]"
                           style={{ left: p.x, top: p.y }}
                        />
                     ))}

                     {/* Laser Beam (if many photons) */}
                     {photons.length > 15 && (
                        <div className="absolute right-[-200px] top-0 bottom-0 flex items-center">
                           <div className="h-2 w-[200px] bg-rose-500 shadow-[0_0_20px_#f43f5e] opacity-80" />
                        </div>
                     )}
                  </div>

                  <div className="mt-8 flex gap-8">
                     <div className="text-center">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Excited Atoms</p>
                        <p className="text-xl font-black text-rose-400">{excitedCount} / 20</p>
                     </div>
                     <div className="text-center">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Photon Count</p>
                        <p className="text-xl font-black text-white">{photons.length}</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-rose-400 uppercase tracking-widest">Population Inversion</label>
                     <p className="text-[10px] text-slate-500 leading-relaxed">
                        To create a laser, we need more atoms in the <strong>excited state</strong> than the ground state. This is called population inversion.
                     </p>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Laser Acronym</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        <strong>L</strong>ight <strong>A</strong>mplification by <strong>S</strong>timulated <strong>E</strong>mission of <strong>R</strong>adiation.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-rose-500/10 rounded-3xl border border-rose-500/20">
                     <p className="text-[10px] font-bold text-rose-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        One photon hits an excited atom, causing it to drop to ground state and release a <strong>second identical photon</strong>. This chain reaction creates the beam!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ACOUSTIC LEVITATION RENDERER ---
   const AcousticLevitationRenderer = () => {
      const [freq, setFreq] = useState(40); // kHz
      const [amplitude, setAmplitude] = useState(80);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // Nodes are at intervals of lambda/2
      // lambda = v/f. v = 343 m/s. f = 40kHz => lambda = 8.5mm
      const nodes = [60, 120, 180, 240];

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">ACOUSTIC LEVITATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Standing Waves & Radiation Pressure</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative w-48 h-[300px] flex flex-col items-center">
                     {/* Transducers */}
                     <div className="w-full h-8 bg-slate-800 rounded-t-2xl border-b-4 border-emerald-500/50 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-500">TRANSDUCER TOP</span>
                     </div>

                     <div className="flex-1 w-full relative bg-emerald-500/5 flex items-center justify-center overflow-hidden">
                        {/* Standing Wave Visualization */}
                        <svg className="absolute inset-0 w-full h-full">
                           {Array.from({ length: 40 }).map((_, i) => {
                              const y = i * 7.5;
                              const wave = Math.sin(y * 0.1 + time) * (amplitude / 4);
                              return (
                                 <line
                                    key={i}
                                    x1={24 - wave}
                                    y1={y}
                                    x2={168 + wave}
                                    y2={y}
                                    stroke="#10b981"
                                    strokeWidth="1"
                                    strokeOpacity="0.1"
                                 />
                              );
                           })}
                        </svg>

                        {/* Levitating Particles */}
                        {nodes.map((nodeY, i) => (
                           <div
                              key={i}
                              className="absolute w-4 h-4 bg-white rounded-full shadow-[0_0_15px_rgba(255,255,255,0.8)] blur-[1px]"
                              style={{
                                 top: nodeY + Math.sin(time * 2) * 2,
                                 left: '50%',
                                 transform: 'translateX(-50%)',
                                 opacity: amplitude > 50 ? 1 : 0.2
                              }}
                           />
                        ))}
                     </div>

                     <div className="w-full h-8 bg-slate-800 rounded-b-2xl border-t-4 border-emerald-500/50 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-500">TRANSDUCER BOTTOM</span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Acoustic Amplitude</label>
                     <input
                        type="range"
                        min="0"
                        max="100"
                        value={amplitude}
                        onChange={(e) => setAmplitude(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Off</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{amplitude}%</span>
                        <span>Max</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Physics</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        Sound waves create <strong>pressure</strong>. In a standing wave, particles are pushed toward the <strong>nodes</strong> (points of zero movement) where they stay suspended.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This isn't magic‚Äîit's <strong>Radiation Pressure</strong>! We can use sound to manipulate matter without ever touching it.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- FIBER OPTICS RENDERER ---
   const FiberOpticsRenderer = () => {
      const [incidentAngle, setIncidentAngle] = useState(20);
      const [fiberCurvature, setFiberCurvature] = useState(0);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      // Total Internal Reflection: n1 sin(theta1) = n2 sin(theta2)
      // For glass (n=1.5) to air (n=1.0), critical angle is ~41.8 deg.
      const criticalAngle = 41.8;
      const isLeaking = (90 - incidentAngle) < criticalAngle;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">FIBER OPTICS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total Internal Reflection & Data</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLeaking ? 'bg-red-500/20 border-red-500/30' : 'bg-indigo-500/20 border-indigo-500/30'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-400">Signal Status</p>
                  <p className={`text-sm font-black ${isLeaking ? 'text-red-400' : 'text-indigo-400'}`}>
                     {isLeaking ? 'SIGNAL LEAKING' : 'TOTAL INTERNAL REFLECTION'}
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Fiber Core */}
                     <path
                        d={`M 50,150 Q ${300},${150 + fiberCurvature} 550,150`}
                        fill="none"
                        stroke="#312e81"
                        strokeWidth="40"
                        strokeLinecap="round"
                        strokeOpacity="0.3"
                     />
                     <path
                        d={`M 50,150 Q ${300},${150 + fiberCurvature} 550,150`}
                        fill="none"
                        stroke="#4338ca"
                        strokeWidth="2"
                        strokeDasharray="4 4"
                        strokeOpacity="0.5"
                     />

                     {/* Light Signal */}
                     <path
                        d={`M 50,150 L 100,${150 - incidentAngle} L 200,${150 + incidentAngle} L 300,${150 - incidentAngle} L 400,${150 + incidentAngle} L 500,${150 - incidentAngle} L 550,150`}
                        fill="none"
                        stroke={isLeaking ? '#ef4444' : '#818cf8'}
                        strokeWidth="3"
                        strokeOpacity={isLeaking ? 0.4 : 1}
                        className={isLeaking ? '' : 'animate-pulse'}
                     />

                     {/* Leaking Rays */}
                     {isLeaking && (
                        <g>
                           <line x1="100" y1={150 - incidentAngle} x2="120" y2={150 - incidentAngle - 40} stroke="#ef4444" strokeWidth="1" strokeOpacity="0.6" />
                           <line x1="200" y1={150 + incidentAngle} x2="220" y2={150 + incidentAngle + 40} stroke="#ef4444" strokeWidth="1" strokeOpacity="0.6" />
                        </g>
                     )}

                     <text x="50" y="120" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Input Signal</text>
                     <text x="500" y="120" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest text-right">Output</text>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Incident Angle</label>
                     <input
                        type="range"
                        min="5"
                        max="60"
                        value={incidentAngle}
                        onChange={(e) => setIncidentAngle(parseInt(e.target.value))}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Shallow</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{incidentAngle}¬∞</span>
                        <span>Steep</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fiber Curvature</label>
                     <input
                        type="range"
                        min="-100"
                        max="100"
                        value={fiberCurvature}
                        onChange={(e) => setFiberCurvature(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Straight</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{fiberCurvature}</span>
                        <span>Bent</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Fiber optics work because light is <strong>trapped</strong> inside the glass. As long as the angle is shallow enough, the light reflects 100% and never escapes.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- STATIC BALLOON RENDERER ---
   const StaticBalloonRenderer = () => {
      const [balloonPos, setBalloonPos] = useState({ x: 100, y: 150 });
      const [balloonCharges, setBalloonCharges] = useState(0);
      const [isRubbing, setIsRubbing] = useState(false);

      const sweaterX = 50;
      const wallX = 500;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">STATIC ELECTRICITY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Charge Transfer & Attraction</p>
               </div>
               <div className="bg-yellow-500/20 px-4 py-2 rounded-xl border border-yellow-500/30">
                  <p className="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Balloon Charge</p>
                  <p className="text-sm font-black text-white">{balloonCharges} Electrons</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Sweater */}
               <div className="absolute left-10 top-20 bottom-20 w-32 bg-red-600/20 border-2 border-red-500/30 rounded-3xl flex items-center justify-center">
                  <div className="grid grid-cols-3 gap-4 opacity-40">
                     {Array.from({ length: 12 }).map((_, i) => (
                        <span key={i} className="text-red-400 font-bold text-xs">+</span>
                     ))}
                  </div>
                  <p className="absolute -bottom-8 text-[8px] font-black text-slate-500 uppercase tracking-widest">Wool Sweater</p>
               </div>

               {/* Wall */}
               <div className="absolute right-10 top-20 bottom-20 w-20 bg-slate-800/40 border-l-4 border-slate-700 rounded-r-3xl flex flex-col justify-around p-4">
                  {Array.from({ length: 8 }).map((_, i) => (
                     <div key={i} className="flex justify-between items-center opacity-40">
                        <span className="text-blue-400 text-[8px]">+</span>
                        <span className="text-red-400 text-[8px]">-</span>
                     </div>
                  ))}
                  <p className="absolute -bottom-8 right-0 text-[8px] font-black text-slate-500 uppercase tracking-widest">Neutral Wall</p>
               </div>

               {/* Balloon */}
               <div
                  className="absolute cursor-move select-none"
                  style={{ left: balloonPos.x, top: balloonPos.y }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - balloonPos.x;
                     const startY = e.clientY - balloonPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        const newX = moveEvent.clientX - startX;
                        const newY = moveEvent.clientY - startY;
                        setBalloonPos({ x: newX, y: newY });

                        // Rubbing logic
                        if (newX < 150) {
                           setIsRubbing(true);
                           setBalloonCharges(prev => Math.min(20, prev + 1));
                        } else {
                           setIsRubbing(false);
                        }

                        // Wall sticking logic
                        if (newX > 400 && balloonCharges > 5) {
                           setBalloonPos(prev => ({ ...prev, x: 440 }));
                        }
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                        setIsRubbing(false);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className={`w-24 h-32 bg-yellow-500 rounded-full relative shadow-2xl transition-transform ${isRubbing ? 'scale-105' : ''}`}>
                     <div className="absolute inset-0 flex flex-wrap content-center justify-center p-4">
                        {Array.from({ length: Math.floor(balloonCharges) }).map((_, i) => (
                           <span key={i} className="text-slate-900 font-black text-[10px] m-0.5">-</span>
                        ))}
                     </div>
                     <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-2 h-4 bg-yellow-600 rounded-b-full" />
                  </div>
                  <p className="text-center mt-4 text-[8px] font-black text-slate-500 uppercase tracking-widest">Drag Me!</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-500/10 flex items-center justify-center border border-yellow-500/20 shrink-0">
                     <span className="text-2xl">üí°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Rubbing the balloon on the sweater transfers <strong>electrons</strong>. The negatively charged balloon then repels electrons in the wall, leaving a positive surface that it sticks to!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CIRCUIT BUILDER BASIC RENDERER ---
   const CircuitBuilderBasicRenderer = () => {
      const [isBatteryConnected, setIsBatteryConnected] = useState(false);
      const [isBulbConnected, setIsBulbConnected] = useState(false);
      const [isSwitchClosed, setIsSwitchClosed] = useState(false);

      const isLit = isBatteryConnected && isBulbConnected && isSwitchClosed;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">MY FIRST CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Battery, Bulb & Switch</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLit ? 'bg-yellow-500/20 border-yellow-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Circuit Status</p>
                  <p className={`text-sm font-black ${isLit ? 'text-yellow-400' : 'text-slate-400'}`}>
                     {isLit ? 'LIGHT IS ON!' : 'INCOMPLETE'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Wires */}
                  <path d="M 100,200 L 100,100 L 500,100 L 500,200" fill="none" stroke="#475569" strokeWidth="8" strokeLinecap="round" />
                  <path d="M 100,250 L 100,350 L 500,350 L 500,250" fill="none" stroke="#475569" strokeWidth="8" strokeLinecap="round" />

                  {/* Battery Slot */}
                  <g transform="translate(50, 200)" className="cursor-pointer" onClick={() => setIsBatteryConnected(!isBatteryConnected)}>
                     <rect x="0" y="0" width="100" height="50" fill={isBatteryConnected ? '#f59e0b' : '#1e293b'} rx="8" stroke={isBatteryConnected ? '#fbbf24' : '#334155'} strokeWidth="2" />
                     <rect x="100" y="15" width="10" height="20" fill="#94a3b8" rx="2" />
                     <text x="50" y="30" textAnchor="middle" className="text-[10px] font-black fill-slate-900 uppercase">BATTERY</text>
                     {!isBatteryConnected && <text x="50" y="-10" textAnchor="middle" className="text-[8px] font-bold fill-blue-400 animate-bounce">CLICK TO ADD</text>}
                  </g>

                  {/* Bulb Slot */}
                  <g transform="translate(450, 200)" className="cursor-pointer" onClick={() => setIsBulbConnected(!isBulbConnected)}>
                     <circle cx="50" cy="25" r="30" fill={isLit ? '#fef08a' : isBulbConnected ? '#334155' : '#1e293b'} stroke={isBulbConnected ? '#94a3b8' : '#334155'} strokeWidth="2" className={isLit ? 'shadow-[0_0_50px_#facc15]' : ''} />
                     <path d="M 35,45 L 65,45 L 60,60 L 40,60 Z" fill="#94a3b8" />
                     <text x="50" y="30" textAnchor="middle" className={`text-[10px] font-black uppercase ${isLit ? 'fill-yellow-700' : 'fill-slate-500'}`}>BULB</text>
                     {!isBulbConnected && <text x="50" y="-15" textAnchor="middle" className="text-[8px] font-bold fill-blue-400 animate-bounce">CLICK TO ADD</text>}
                  </g>

                  {/* Switch */}
                  <g transform="translate(250, 80)" className="cursor-pointer" onClick={() => setIsSwitchClosed(!isSwitchClosed)}>
                     <circle cx="0" cy="20" r="6" fill="#475569" />
                     <circle cx="100" cy="20" r="6" fill="#475569" />
                     <line
                        x1="0" y1="20"
                        x2={isSwitchClosed ? 100 : 80} y2={isSwitchClosed ? 20 : -20}
                        stroke="#94a3b8" strokeWidth="6" strokeLinecap="round"
                        className="transition-all duration-300"
                     />
                     <text x="50" y="50" textAnchor="middle" className="text-[10px] font-black fill-slate-500 uppercase">SWITCH</text>
                  </g>

                  {/* Electrons (Flowing) */}
                  {isLit && Array.from({ length: 12 }).map((_, i) => (
                     <circle key={i} r="3" fill="#38bdf8">
                        <animateMotion
                           dur="2s"
                           repeatCount="indefinite"
                           path="M 100,225 L 100,350 L 500,350 L 500,225 M 500,225 L 500,100 L 100,100 L 100,225"
                           begin={`${i * 0.2}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-3 gap-8">
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">Energy Source</p>
                     <p className="text-xs font-bold text-blue-400">Battery</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">The Load</p>
                     <p className="text-xs font-bold text-yellow-400">Light Bulb</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">The Control</p>
                     <p className="text-xs font-bold text-slate-400">Switch</p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNET MAZE RENDERER ---
   const MagnetMazeRenderer = () => {
      const [ballPos, setBallPos] = useState({ x: 100, y: 100 });
      const [magnetPos, setMagnetPos] = useState({ x: 300, y: 300 });

      useEffect(() => {
         const dx = magnetPos.x - ballPos.x;
         const dy = magnetPos.y - ballPos.y;
         const dist = Math.sqrt(dx * dx + dy * dy);

         if (dist < 150 && dist > 10) {
            const force = (150 - dist) / 50;
            setBallPos(prev => ({
               x: prev.x + (dx / dist) * force,
               y: prev.y + (dy / dist) * force
            }));
         }
      }, [magnetPos]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">MAGNET MAZE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Fields & Forces</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Maze Walls (Simplified) */}
               <svg className="absolute inset-0 w-full h-full">
                  <rect x="200" y="0" width="20" height="250" fill="#1e293b" />
                  <rect x="400" y="150" width="20" height="250" fill="#1e293b" />
                  <text x="500" y="350" className="text-[10px] font-black fill-emerald-500 uppercase tracking-widest">Goal</text>
                  <circle cx="520" cy="345" r="30" fill="none" stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />
               </svg>

               {/* Iron Ball */}
               <div
                  className="absolute w-8 h-8 bg-slate-400 rounded-full shadow-lg border-2 border-slate-300 transition-all duration-100"
                  style={{ left: ballPos.x - 16, top: ballPos.y - 16 }}
               >
                  <div className="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-full" />
               </div>

               {/* Magnet (Draggable) */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 20, top: magnetPos.y - 40 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-10 h-20 flex flex-col rounded-md overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
                  <p className="text-center mt-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Magnet</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üß≤</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Magnets exert a <strong>force</strong> on certain metals like iron. This force gets stronger as the magnet gets closer!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTROMAGNET BASIC RENDERER ---
   const ElectromagnetBasicRenderer = () => {
      const [numCoils, setNumCoils] = useState(5);
      const [isPowerOn, setIsPowerOn] = useState(false);
      const [paperclips, setPaperclips] = useState<{ id: number, x: number, y: number, isPickedUp: boolean }[]>(
         Array.from({ length: 8 }, (_, i) => ({
            id: i,
            x: 400 + Math.random() * 150,
            y: 300 + Math.random() * 50,
            isPickedUp: false
         }))
      );

      const magneticStrength = isPowerOn ? numCoils * 10 : 0;

      useEffect(() => {
         if (isPowerOn) {
            setPaperclips(prev => prev.map(p => {
               if (p.x < 350 && Math.abs(p.y - 200) < 100) {
                  return { ...p, x: 250, y: 200 + (p.id - 4) * 10, isPickedUp: true };
               }
               return p;
            }));
         } else {
            setPaperclips(prev => prev.map(p => p.isPickedUp ? { ...p, y: 320, isPickedUp: false } : p));
         }
      }, [isPowerOn, numCoils]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTROMAGNET LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Electricity + Magnetism</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setIsPowerOn(!isPowerOn)}
                     className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isPowerOn ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/40' : 'bg-slate-800 text-slate-400'}`}
                  >
                     {isPowerOn ? 'POWER ON' : 'POWER OFF'}
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="400" className="overflow-visible">
                     {/* Battery */}
                     <rect x="50" y="300" width="80" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                     <rect x="130" y="310" width="8" height="20" fill="#94a3b8" />

                     {/* Wires */}
                     <path d="M 130,320 L 200,320 L 200,200" fill="none" stroke={isPowerOn ? '#fb923c' : '#475569'} strokeWidth="4" />
                     <path d="M 50,320 L 20,320 L 20,100 L 200,100 L 200,200" fill="none" stroke={isPowerOn ? '#fb923c' : '#475569'} strokeWidth="4" />

                     {/* Iron Nail */}
                     <rect x="180" y="150" width="150" height="20" fill="#64748b" rx="2" transform="rotate(90, 255, 200)" />
                     <path d="M 245,100 L 265,100 L 255,80 Z" fill="#475569" />

                     {/* Coils */}
                     {Array.from({ length: numCoils }).map((_, i) => (
                        <path
                           key={i}
                           d={`M 245,${120 + i * 20} Q 280,${130 + i * 20} 245,${140 + i * 20}`}
                           fill="none"
                           stroke={isPowerOn ? '#fb923c' : '#475569'}
                           strokeWidth="3"
                        />
                     ))}

                     {/* Magnetic Field (Visual) */}
                     {isPowerOn && (
                        <g className="animate-pulse">
                           <ellipse cx="255" cy="200" rx="60" ry="120" fill="none" stroke="#fb923c" strokeWidth="1" strokeOpacity="0.2" />
                           <ellipse cx="255" cy="200" rx="40" ry="100" fill="none" stroke="#fb923c" strokeWidth="1" strokeOpacity="0.3" />
                        </g>
                     )}

                     {/* Paperclips */}
                     {paperclips.map(p => (
                        <g key={p.id} transform={`translate(${p.x}, ${p.y}) rotate(${p.isPickedUp ? 90 : 0})`}>
                           <rect width="15" height="4" fill="none" stroke="#94a3b8" strokeWidth="1.5" rx="2" />
                        </g>
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Number of Coils</label>
                     <input
                        type="range"
                        min="1"
                        max="10"
                        value={numCoils}
                        onChange={(e) => setNumCoils(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Weak</span>
                        <span className="text-white bg-orange-500/20 px-2 py-0.5 rounded">{numCoils} Turns</span>
                        <span>Strong</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Secret</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        Electricity flowing through a wire creates a <strong>magnetic field</strong>. Wrapping the wire into coils concentrates that field, making it strong enough to pick up metal!
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Unlike permanent magnets, electromagnets can be <strong>turned on and off</strong>. This makes them incredibly useful in everything from scrap yards to MRI machines.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- CONDUCTIVITY TESTER RENDERER ---
   const ConductivityTesterRenderer = () => {
      const [selectedObject, setSelectedObject] = useState<'none' | 'copper' | 'wood' | 'plastic' | 'water'>('none');

      const objects = {
         none: { name: 'Empty', isConductor: false, color: 'transparent' },
         copper: { name: 'Copper Coin', isConductor: true, color: '#b45309' },
         wood: { name: 'Wooden Stick', isConductor: false, color: '#78350f' },
         plastic: { name: 'Plastic Ruler', isConductor: false, color: '#3b82f6' },
         water: { name: 'Salt Water', isConductor: true, color: '#0ea5e9' }
      };

      const isLit = selectedObject !== 'none' && objects[selectedObject].isConductor;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">CONDUCTIVITY TESTER</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Conductors vs. Insulators</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLit ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Result</p>
                  <p className={`text-sm font-black ${isLit ? 'text-emerald-400' : 'text-slate-400'}`}>
                     {isLit ? 'CONDUCTOR' : 'INSULATOR'}
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Circuit */}
                     <path d="M 100,150 L 50,150 L 50,50 L 350,50 L 350,150 L 300,150" fill="none" stroke="#475569" strokeWidth="6" strokeLinecap="round" />
                     <path d="M 100,200 L 50,200 L 50,250 L 350,250 L 350,200 L 300,200" fill="none" stroke="#475569" strokeWidth="6" strokeLinecap="round" />

                     {/* Battery */}
                     <rect x="170" y="30" width="60" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                     <text x="200" y="55" textAnchor="middle" className="text-[8px] font-black fill-slate-500">BATTERY</text>

                     {/* Bulb */}
                     <circle cx="200" cy="250" r="25" fill={isLit ? '#fef08a' : '#1e293b'} stroke="#334155" strokeWidth="2" className={isLit ? 'shadow-[0_0_40px_#facc15]' : ''} />
                     <text x="200" y="255" textAnchor="middle" className={`text-[8px] font-black ${isLit ? 'fill-yellow-700' : 'fill-slate-500'}`}>BULB</text>

                     {/* Test Probes */}
                     <rect x="100" y="140" width="10" height="70" fill="#94a3b8" rx="2" />
                     <rect x="290" y="140" width="10" height="70" fill="#94a3b8" rx="2" />

                     {/* Test Object */}
                     {selectedObject !== 'none' && (
                        <rect
                           x="110" y="165" width="180" height="20"
                           fill={objects[selectedObject].color}
                           rx="4"
                           className="animate-in fade-in zoom-in duration-300"
                        />
                     )}

                     {/* Electrons */}
                     {isLit && Array.from({ length: 10 }).map((_, i) => (
                        <circle key={i} r="2" fill="#10b981">
                           <animateMotion
                              dur="1.5s"
                              repeatCount="indefinite"
                              path="M 110,175 L 290,175 M 290,175 L 350,175 L 350,250 L 200,250 L 50,250 L 50,175 L 110,175"
                              begin={`${i * 0.15}s`}
                           />
                        </circle>
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-4 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <p className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Select Object to Test</p>
                  <div className="grid grid-cols-1 gap-2">
                     {Object.entries(objects).filter(([k]) => k !== 'none').map(([key, obj]) => (
                        <button
                           key={key}
                           onClick={() => setSelectedObject(key as any)}
                           className={`p-4 rounded-2xl border text-left transition-all ${selectedObject === key ? 'bg-emerald-500/20 border-emerald-500/40' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}
                        >
                           <div className="flex items-center justify-between">
                              <span className="text-xs font-bold">{obj.name}</span>
                              <div className="w-4 h-4 rounded-full" style={{ backgroundColor: obj.color }} />
                           </div>
                        </button>
                     ))}
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Conductors</strong> (like copper) have loose electrons that can flow easily. <strong>Insulators</strong> (like wood) hold onto their electrons tightly, blocking the flow.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- SIMPLE SWITCH RENDERER ---
   const SimpleSwitchRenderer = () => {
      const [isClosed, setIsClosed] = useState(false);
      const [circuitType, setCircuitType] = useState<'series' | 'parallel'>('series');

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">SWITCH LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Controlling the Flow</p>
               </div>
               <div className="flex bg-slate-800 p-1 rounded-xl border border-slate-700">
                  <button
                     onClick={() => setCircuitType('series')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${circuitType === 'series' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     SERIES
                  </button>
                  <button
                     onClick={() => setCircuitType('parallel')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${circuitType === 'parallel' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     PARALLEL
                  </button>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Battery */}
                  <rect x="50" y="180" width="60" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                  <text x="80" y="205" textAnchor="middle" className="text-[8px] font-black fill-slate-500">BATTERY</text>

                  {/* Series Circuit */}
                  {circuitType === 'series' ? (
                     <g>
                        <path d="M 110,200 L 200,200 M 300,200 L 400,200 L 400,100 L 500,100 M 500,300 L 400,300 L 400,200 M 50,200 L 20,200 L 20,350 L 500,350 L 500,300" fill="none" stroke="#475569" strokeWidth="4" />
                        {/* Switch */}
                        <g transform="translate(200, 180)" className="cursor-pointer" onClick={() => setIsClosed(!isClosed)}>
                           <circle cx="0" cy="20" r="4" fill="#94a3b8" />
                           <circle cx="100" cy="20" r="4" fill="#94a3b8" />
                           <line x1="0" y1="20" x2={isClosed ? 100 : 80} y2={isClosed ? 20 : -10} stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />
                        </g>
                        {/* Bulbs */}
                        <circle cx="500" cy="100" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                        <circle cx="500" cy="300" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                     </g>
                  ) : (
                     <g>
                        <path d="M 110,200 L 200,200 M 300,200 L 350,200 L 350,100 L 500,100 M 350,200 L 350,300 L 500,300 M 50,200 L 20,200 L 20,350 L 550,350 L 550,100 L 500,100 M 550,300 L 500,300" fill="none" stroke="#475569" strokeWidth="4" />
                        {/* Switch */}
                        <g transform="translate(200, 180)" className="cursor-pointer" onClick={() => setIsClosed(!isClosed)}>
                           <circle cx="0" cy="20" r="4" fill="#94a3b8" />
                           <circle cx="100" cy="20" r="4" fill="#94a3b8" />
                           <line x1="0" y1="20" x2={isClosed ? 100 : 80} y2={isClosed ? 20 : -10} stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />
                        </g>
                        {/* Bulbs */}
                        <circle cx="500" cy="100" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                        <circle cx="500" cy="300" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                     </g>
                  )}

                  {/* Electrons */}
                  {isClosed && Array.from({ length: 15 }).map((_, i) => (
                     <circle key={i} r="2" fill="#22d3ee">
                        <animateMotion
                           dur="2s"
                           repeatCount="indefinite"
                           path={circuitType === 'series'
                              ? "M 110,200 L 200,200 L 300,200 L 400,200 L 400,100 L 500,100 L 500,300 L 500,350 L 20,350 L 20,200 L 50,200"
                              : "M 110,200 L 200,200 L 300,200 L 350,200 L 350,100 L 500,100 L 550,100 L 550,350 L 20,350 L 20,200 L 50,200"
                           }
                           begin={`${i * 0.15}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">üîå</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A switch works by <strong>breaking the path</strong>. When it's open, electrons can't jump the gap, so the circuit stops. Close it, and the loop is complete!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC POLE RENDERER ---
   const MagneticPoleRenderer = () => {
      const [isBroken, setIsBroken] = useState(false);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">MAGNETIC POLES</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">North, South & Monopoles</p>
               </div>
               <button
                  onClick={() => setIsBroken(!isBroken)}
                  className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isBroken ? 'bg-slate-800 text-slate-400' : 'bg-red-500 text-white shadow-lg shadow-red-500/40'}`}
               >
                  {isBroken ? 'RESET MAGNET' : 'BREAK THE MAGNET'}
               </button>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative flex items-center gap-4">
                  {!isBroken ? (
                     <div className="w-64 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800 animate-in zoom-in duration-500">
                        <div className="flex-1 bg-red-600 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black">N</span>
                           <span className="text-[10px] font-bold opacity-50">NORTH</span>
                        </div>
                        <div className="flex-1 bg-blue-600 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black">S</span>
                           <span className="text-[10px] font-bold opacity-50">SOUTH</span>
                        </div>
                     </div>
                  ) : (
                     <div className="flex gap-16 animate-in slide-in-from-left duration-500">
                        <div className="w-32 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                           <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-2xl">N</div>
                           <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-2xl">S</div>
                        </div>
                        <div className="w-32 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                           <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-2xl">N</div>
                           <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-2xl">S</div>
                        </div>
                     </div>
                  )}

                  {/* Field Lines (Visual) */}
                  <svg className="absolute inset-0 -z-10 w-[800px] h-[400px] -translate-x-1/4 -translate-y-1/4 pointer-events-none">
                     <defs>
                        <linearGradient id="field-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#ef4444" stopOpacity="0.2" />
                           <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.2" />
                        </linearGradient>
                     </defs>
                     {!isBroken && (
                        <g>
                           <path d="M 300,200 Q 400,100 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="2" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,300 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="2" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,50 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="1" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,350 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="1" strokeDasharray="4 4" />
                        </g>
                     )}
                  </svg>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">‚úÇÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Every magnet has two poles. If you break a magnet in half, you don't get a "North" and a "South"‚Äîyou get <strong>two smaller magnets</strong>, each with its own North and South!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ATTRACT & REPEL RENDERER ---
   const AttractRepelRenderer = () => {
      const [leftMagnetType, setLeftMagnetType] = useState<'N' | 'S'>('N');
      const [rightMagnetType, setRightMagnetType] = useState<'N' | 'S'>('S');
      const [distance, setDistance] = useState(200);

      const isAttracting = leftMagnetType !== rightMagnetType;
      const forceStrength = Math.max(0, (300 - distance) / 20);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">ATTRACT OR REPEL?</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Interaction Rules</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isAttracting ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-red-500/20 border-red-500/30'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Interaction</p>
                  <p className={`text-sm font-black ${isAttracting ? 'text-emerald-400' : 'text-red-400'}`}>
                     {isAttracting ? 'ATTRACTING' : 'REPELLING'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               <div className="flex items-center gap-8" style={{ gap: `${distance}px` }}>
                  {/* Left Magnet */}
                  <div
                     className="w-32 h-16 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800 cursor-pointer"
                     onClick={() => setLeftMagnetType(leftMagnetType === 'N' ? 'S' : 'N')}
                  >
                     <div className={`flex-1 flex items-center justify-center font-black ${leftMagnetType === 'N' ? 'bg-red-600' : 'bg-blue-600'}`}>
                        {leftMagnetType}
                     </div>
                     <div className={`flex-1 flex items-center justify-center font-black ${leftMagnetType === 'N' ? 'bg-blue-600' : 'bg-red-600'}`}>
                        {leftMagnetType === 'N' ? 'S' : 'N'}
                     </div>
                  </div>

                  {/* Right Magnet */}
                  <div
                     className="w-32 h-16 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800 cursor-pointer"
                     onClick={() => setRightMagnetType(rightMagnetType === 'N' ? 'S' : 'N')}
                  >
                     <div className={`flex-1 flex items-center justify-center font-black ${rightMagnetType === 'N' ? 'bg-red-600' : 'bg-blue-600'}`}>
                        {rightMagnetType}
                     </div>
                     <div className={`flex-1 flex items-center justify-center font-black ${rightMagnetType === 'N' ? 'bg-blue-600' : 'bg-red-600'}`}>
                        {rightMagnetType === 'N' ? 'S' : 'N'}
                     </div>
                  </div>
               </div>

               {/* Force Arrows */}
               <div className="mt-12 flex items-center gap-4">
                  {isAttracting ? (
                     <div className="flex items-center gap-2 text-emerald-400">
                        <span className="text-2xl animate-bounce">‚Üí</span>
                        <span className="text-[10px] font-black uppercase tracking-widest">Pulling Together</span>
                        <span className="text-2xl animate-bounce">‚Üê</span>
                     </div>
                  ) : (
                     <div className="flex items-center gap-2 text-red-400">
                        <span className="text-2xl animate-bounce">‚Üê</span>
                        <span className="text-[10px] font-black uppercase tracking-widest">Pushing Away</span>
                        <span className="text-2xl animate-bounce">‚Üí</span>
                     </div>
                  )}
               </div>

               {/* Distance Slider */}
               <div className="absolute bottom-12 w-64">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center mb-4">Distance</label>
                  <input
                     type="range"
                     min="50"
                     max="400"
                     value={distance}
                     onChange={(e) => setDistance(parseInt(e.target.value))}
                     className="w-full accent-blue-500"
                  />
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">ü§ù</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     The golden rule of magnetism: <strong>Opposites attract</strong> (N and S), and <strong>likes repel</strong> (N and N, or S and S). The closer they are, the stronger the force!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- COMPASS RENDERER ---
   const CompassRenderer = () => {
      const [magnetPos, setMagnetPos] = useState({ x: 450, y: 150 });
      const [isDragging, setIsDragging] = useState(false);

      const compasses = Array.from({ length: 25 }).map((_, i) => ({
         x: 50 + (i % 5) * 80,
         y: 50 + Math.floor(i / 5) * 60
      }));

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">COMPASS LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Earth's Field & Local Magnets</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Compass Grid */}
               {compasses.map((c, i) => {
                  const dx = magnetPos.x - c.x;
                  const dy = magnetPos.y - c.y;
                  const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                  return (
                     <div
                        key={i}
                        className="absolute w-12 h-12 rounded-full border border-slate-800 bg-slate-900/30 flex items-center justify-center"
                        style={{ left: c.x - 24, top: c.y - 24 }}
                     >
                        <div
                           className="w-8 h-1 bg-gradient-to-r from-red-500 to-blue-500 rounded-full transition-transform duration-200"
                           style={{ transform: `rotate(${angle}deg)` }}
                        />
                        <div className="absolute w-1 h-1 bg-white rounded-full" />
                     </div>
                  );
               })}

               {/* Draggable Magnet */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 40, top: magnetPos.y - 20 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-20 h-10 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
                  <p className="text-center mt-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Drag Me!</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üß≠</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A compass needle is just a <strong>tiny magnet</strong> that's free to spin. It always points toward the strongest magnetic field nearby‚Äîusually the Earth, unless there's a closer magnet!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC MATERIAL RENDERER ---
   const MagneticMaterialRenderer = () => {
      const [selectedMaterial, setSelectedMaterial] = useState<'none' | 'iron' | 'aluminum' | 'wood'>('none');
      const [magnetPos, setMagnetPos] = useState({ x: 100, y: 150 });

      const materials = {
         none: { name: 'Empty', isMagnetic: false, color: 'transparent' },
         iron: { name: 'Iron Bolt', isMagnetic: true, color: '#64748b' },
         aluminum: { name: 'Aluminum Foil', isMagnetic: false, color: '#cbd5e1' },
         wood: { name: 'Wooden Block', isMagnetic: false, color: '#78350f' }
      };

      const isAttracted = selectedMaterial !== 'none' && materials[selectedMaterial].isMagnetic && magnetPos.x > 350;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-slate-400">MAGNETIC MATERIALS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">What sticks to a magnet?</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isAttracted ? 'bg-red-500/20 border-red-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Interaction</p>
                  <p className={`text-sm font-black ${isAttracted ? 'text-red-400' : 'text-slate-400'}`}>
                     {isAttracted ? 'ATTRACTED!' : 'NO INTERACTION'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Test Tray */}
               <div className="absolute right-20 top-1/2 -translate-y-1/2 w-48 h-48 bg-slate-900/50 border-2 border-dashed border-slate-800 rounded-3xl flex items-center justify-center">
                  {selectedMaterial !== 'none' ? (
                     <div
                        className={`w-24 h-24 rounded-2xl shadow-2xl transition-all duration-300 ${isAttracted ? 'translate-x-[-20px]' : ''}`}
                        style={{ backgroundColor: materials[selectedMaterial].color }}
                     >
                        <div className="absolute inset-0 flex items-center justify-center">
                           <span className="text-[10px] font-black uppercase tracking-widest opacity-50">{materials[selectedMaterial].name}</span>
                        </div>
                     </div>
                  ) : (
                     <span className="text-[10px] font-black text-slate-700 uppercase tracking-widest">Place Object Here</span>
                  )}
               </div>

               {/* Draggable Magnet */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 40, top: magnetPos.y - 20 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-20 h-10 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
               </div>

               {/* Material Selector */}
               <div className="absolute left-8 top-1/2 -translate-y-1/2 flex flex-col gap-2">
                  {Object.entries(materials).filter(([k]) => k !== 'none').map(([key, obj]) => (
                     <button
                        key={key}
                        onClick={() => setSelectedMaterial(key as any)}
                        className={`p-4 rounded-2xl border text-left transition-all ${selectedMaterial === key ? 'bg-slate-800 border-slate-600' : 'bg-slate-900/30 border-slate-800 hover:border-slate-700'}`}
                     >
                        <span className="text-xs font-bold">{obj.name}</span>
                     </button>
                  ))}
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-slate-500/10 flex items-center justify-center border border-slate-500/20 shrink-0">
                     <span className="text-2xl">üß±</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Not all metals are magnetic! <strong>Iron, Nickel, and Cobalt</strong> are the big three. Metals like Aluminum and Copper don't stick to magnets at all.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SERIES CIRCUIT RENDERER ---
   const SeriesCircuitRenderer = () => {
      const [voltage, setVoltage] = useState(9);
      const [resistors, setResistors] = useState([10, 10, 10]); // Ohms

      const totalResistance = resistors.reduce((a, b) => a + b, 0);
      const current = voltage / totalResistance;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">SERIES CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Single Path & Voltage Division</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-yellow-500/10 px-4 py-2 rounded-xl border border-yellow-500/20">
                     <p className="text-[8px] font-black text-yellow-400 uppercase tracking-widest">Total Current</p>
                     <p className="text-sm font-black text-white">{current.toFixed(2)} A</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Circuit Path */}
                  <rect x="100" y="100" width="400" height="200" fill="none" stroke="#334155" strokeWidth="4" rx="8" />

                  {/* Battery */}
                  <g transform="translate(80, 175)">
                     <rect x="0" y="0" width="40" height="50" fill="#1e293b" rx="4" stroke="#fbbf24" strokeWidth="2" />
                     <text x="20" y="30" textAnchor="middle" className="text-[8px] font-black fill-yellow-500">9V</text>
                  </g>

                  {/* Resistors */}
                  {resistors.map((r, i) => {
                     const x = 200 + i * 100;
                     return (
                        <g key={i} transform={`translate(${x}, 100)`}>
                           <path d="M -20,0 L -10,0 L -5,-10 L 5,10 L 15,-10 L 25,10 L 30,0 L 40,0" fill="none" stroke="#94a3b8" strokeWidth="2" />
                           <text x="10" y="-20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">{r} Œ©</text>
                           <text x="10" y="20" textAnchor="middle" className="text-[8px] font-bold fill-yellow-400">{(current * r).toFixed(1)}V</text>
                        </g>
                     );
                  })}

                  {/* Electrons */}
                  {Array.from({ length: 12 }).map((_, i) => (
                     <circle key={i} r="3" fill="#fbbf24">
                        <animateMotion
                           dur={`${2 / current}s`}
                           repeatCount="indefinite"
                           path="M 100,200 L 100,100 L 500,100 L 500,300 L 100,300 L 100,200"
                           begin={`${i * 0.2}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-2 gap-8">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Battery Voltage</label>
                     <input
                        type="range"
                        min="1"
                        max="24"
                        value={voltage}
                        onChange={(e) => setVoltage(parseInt(e.target.value))}
                        className="w-full accent-yellow-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1V</span>
                        <span className="text-white">{voltage}V</span>
                        <span>24V</span>
                     </div>
                  </div>
                  <div className="p-4 bg-yellow-500/5 rounded-2xl border border-yellow-500/10">
                     <p className="text-[10px] font-black text-yellow-400 uppercase tracking-widest mb-2">The Rule</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        In a series circuit, the <strong>current is the same</strong> everywhere, but the <strong>voltage splits</strong> between the components.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- PARALLEL CIRCUIT RENDERER ---
   const ParallelCircuitRenderer = () => {
      const [voltage, setVoltage] = useState(12);
      const [resistors, setResistors] = useState([20, 30, 60]); // Ohms

      const currents = resistors.map(r => voltage / r);
      const totalCurrent = currents.reduce((a, b) => a + b, 0);
      const totalResistance = voltage / totalCurrent;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">PARALLEL CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multiple Paths & Constant Voltage</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">Total Current</p>
                  <p className="text-sm font-black text-white">{totalCurrent.toFixed(2)} A</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Main Bus */}
                  <path d="M 100,200 L 150,200 M 150,100 L 150,300 M 450,100 L 450,300 M 450,200 L 500,200" fill="none" stroke="#334155" strokeWidth="4" />

                  {/* Battery */}
                  <g transform="translate(50, 175)">
                     <rect x="0" y="0" width="40" height="50" fill="#1e293b" rx="4" stroke="#3b82f6" strokeWidth="2" />
                     <text x="20" y="30" textAnchor="middle" className="text-[8px] font-black fill-blue-500">{voltage}V</text>
                  </g>

                  {/* Parallel Branches */}
                  {resistors.map((r, i) => {
                     const y = 100 + i * 100;
                     return (
                        <g key={i}>
                           <path d={`M 150,${y} L 250,${y} M 350,${y} L 450,${y}`} fill="none" stroke="#334155" strokeWidth="4" />
                           <g transform={`translate(250, ${y})`}>
                              <path d="M 0,0 L 10,0 L 15,-10 L 25,10 L 35,-10 L 45,10 L 50,0 L 100,0" fill="none" stroke="#94a3b8" strokeWidth="2" />
                              <text x="50" y="-20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">{r} Œ©</text>
                              <text x="50" y="20" textAnchor="middle" className="text-[8px] font-bold fill-blue-400">{currents[i].toFixed(2)}A</text>
                           </g>
                           {/* Branch Electrons */}
                           {Array.from({ length: 6 }).map((_, j) => (
                              <circle key={j} r="2" fill="#3b82f6">
                                 <animateMotion
                                    dur={`${1.5 / currents[i]}s`}
                                    repeatCount="indefinite"
                                    path={`M 150,${y} L 450,${y}`}
                                    begin={`${j * 0.25}s`}
                                 />
                              </circle>
                           ))}
                        </g>
                     );
                  })}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-2 gap-8">
                  <div className="p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                     <p className="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">The Rule</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        In a parallel circuit, the <strong>voltage is the same</strong> across all branches, but the <strong>current splits</strong>. Adding more branches <strong>decreases</strong> total resistance!
                     </p>
                  </div>
                  <div className="flex items-center gap-4">
                     <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                        <span className="text-2xl">üè†</span>
                     </div>
                     <p className="text-xs text-slate-500 leading-relaxed">
                        This is how your house is wired. If one light goes out, the others stay on because they each have their own path to the battery!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- VOLTAGE POTENTIAL RENDERER ---
   const VoltagePotentialRenderer = () => {
      const [height, setHeight] = useState(100);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTRIC POTENTIAL</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">The Water Analogy</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Potential (Voltage)</p>
                  <p className="text-sm font-black text-white">{(height / 10).toFixed(1)} Volts</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative w-full max-w-md h-64 border-b-4 border-slate-800">
                  {/* Water Tank */}
                  <div
                     className="absolute bottom-0 left-1/2 -translate-x-1/2 w-32 bg-blue-500/30 border-2 border-blue-400/50 rounded-t-xl transition-all duration-500"
                     style={{ height: `${height}px` }}
                  >
                     <div className="absolute top-0 left-0 right-0 h-1 bg-blue-300 animate-pulse" />
                     <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest rotate-90">High Pressure</span>
                     </div>
                  </div>

                  {/* Ground */}
                  <div className="absolute bottom-[-20px] left-0 right-0 text-center">
                     <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest">Ground (0V)</span>
                  </div>

                  {/* Electrons (Falling) */}
                  {Array.from({ length: 8 }).map((_, i) => (
                     <div
                        key={i}
                        className="absolute w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                        style={{
                           left: `${30 + i * 10}%`,
                           bottom: `${height + 20}px`,
                           animationDelay: `${i * 0.2}s`,
                           animationDuration: `${1.5 - height / 200}s`
                        }}
                     />
                  ))}
               </div>

               {/* Height Slider */}
               <div className="absolute right-12 top-1/2 -translate-y-1/2 h-48 flex flex-col items-center gap-4">
                  <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Increase Potential</span>
                  <input
                     type="range"
                     min="20"
                     max="200"
                     value={height}
                     onChange={(e) => setHeight(parseInt(e.target.value))}
                     className="h-full appearance-none bg-slate-800 w-2 rounded-full outline-none"
                     style={{ writingMode: 'bt-lr' } as any}
                  />
                  <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Decrease Potential</span>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üåä</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Think of <strong>Voltage</strong> like water pressure. The higher the tank, the more "push" the water has. In a circuit, voltage is the "push" that makes electrons flow!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CURRENT FLOW RENDERER ---
   const CurrentFlowRenderer = () => {
      const [speed, setSpeed] = useState(1);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">ELECTRIC CURRENT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Flow Rate & Amperes</p>
               </div>
               <div className="bg-cyan-500/10 px-4 py-2 rounded-xl border border-cyan-500/20">
                  <p className="text-[8px] font-black text-cyan-400 uppercase tracking-widest">Current (Amps)</p>
                  <p className="text-sm font-black text-white">{speed.toFixed(1)} A</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Wire Section */}
               <div className="relative w-full max-w-2xl h-32 bg-slate-900/50 border-y-4 border-slate-800 flex items-center overflow-hidden">
                  {/* Electrons */}
                  {Array.from({ length: 20 }).map((_, i) => (
                     <div
                        key={i}
                        className="absolute w-6 h-6 bg-cyan-400 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(34,211,238,0.5)]"
                        style={{
                           left: `${(i * 10) % 110}%`,
                           animation: `flow ${2 / speed}s linear infinite`,
                           animationDelay: `${(i * 0.1)}s`
                        }}
                     >
                        <span className="text-[10px] font-black text-slate-900">-</span>
                     </div>
                  ))}
               </div>

               <style>{`
                  @keyframes flow {
                     from { transform: translateX(-100px); }
                     to { transform: translateX(800px); }
                  }
               `}</style>

               {/* Speed Slider */}
               <div className="mt-12 w-64">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center mb-4">Flow Rate</label>
                  <input
                     type="range"
                     min="0.1"
                     max="5"
                     step="0.1"
                     value={speed}
                     onChange={(e) => setSpeed(parseFloat(e.target.value))}
                     className="w-full accent-cyan-500"
                  />
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">‚ö°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Current</strong> is the rate at which charge flows. 1 Ampere means 6.24 quintillion electrons are passing through a point every single second!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- OHM'S LAW RENDERER ---
   const OhmsLawRenderer = () => {
      const [voltage, setVoltage] = useState(10);
      const [resistance, setResistance] = useState(5);

      const current = voltage / resistance;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-white">OHM'S LAW LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">V = I √ó R</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Current (I)</p>
                     <p className="text-sm font-black text-white">{current.toFixed(2)} A</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* The "Ohm's Law" Triangle/Cartoon */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     {/* Voltage (The Pusher) */}
                     <div
                        className="absolute top-0 w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + voltage / 20})` }}
                     >
                        <span className="text-slate-900 font-black text-xl">V</span>
                     </div>

                     {/* Resistance (The Squeezer) */}
                     <div
                        className="absolute right-0 w-24 h-24 bg-red-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + resistance / 20})` }}
                     >
                        <span className="text-white font-black text-xl">R</span>
                     </div>

                     {/* Current (The Flow) */}
                     <div
                        className="absolute bottom-0 w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + current / 5})` }}
                     >
                        <span className="text-white font-black text-xl">I</span>
                     </div>
                  </div>

                  <div className="mt-12 text-center">
                     <p className="text-2xl font-black tracking-tighter">
                        <span className="text-yellow-500">{voltage}V</span> =
                        <span className="text-blue-500"> {current.toFixed(2)}A</span> √ó
                        <span className="text-red-500"> {resistance}Œ©</span>
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-yellow-500 uppercase tracking-widest">Voltage (V)</label>
                     <input
                        type="range"
                        min="1"
                        max="20"
                        value={voltage}
                        onChange={(e) => setVoltage(parseInt(e.target.value))}
                        className="w-full accent-yellow-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Low Push</span>
                        <span>{voltage}V</span>
                        <span>High Push</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-red-500 uppercase tracking-widest">Resistance (R)</label>
                     <input
                        type="range"
                        min="1"
                        max="20"
                        value={resistance}
                        onChange={(e) => setResistance(parseInt(e.target.value))}
                        className="w-full accent-red-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Easy Path</span>
                        <span>{resistance}Œ©</span>
                        <span>Hard Path</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-slate-800/50 rounded-3xl border border-slate-700">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Voltage <strong>pushes</strong> current, while Resistance <strong>opposes</strong> it. If you double the resistance, you cut the current in half!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTROMAGNET RENDERER (ADVANCED) ---
   const ElectromagnetRenderer = () => {
      const [numCoils, setNumCoils] = useState(50);
      const [current, setCurrent] = useState(2);
      const [coreMaterial, setCoreMaterial] = useState<'air' | 'iron'>('air');

      const magneticField = (coreMaterial === 'iron' ? 100 : 1) * numCoils * current;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTROMAGNET LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Solenoids & Permeability</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Field Strength (B)</p>
                  <p className="text-sm font-black text-white">{(magneticField / 1000).toFixed(2)} Tesla (est.)</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Magnetic Field Lines */}
                     {Array.from({ length: 12 }).map((_, i) => (
                        <ellipse
                           key={i}
                           cx="200" cy="150"
                           rx={60 + i * 20}
                           ry={40 + i * 15}
                           fill="none"
                           stroke="#fb923c"
                           strokeWidth="1"
                           strokeOpacity={Math.min(0.5, (magneticField / 5000) * (1 - i / 12))}
                           className="animate-pulse"
                        />
                     ))}

                     {/* Core */}
                     <rect
                        x="100" y="130" width="200" height="40"
                        fill={coreMaterial === 'iron' ? '#475569' : 'transparent'}
                        stroke={coreMaterial === 'iron' ? '#64748b' : '#334155'}
                        strokeWidth="2"
                        rx="4"
                     />
                     {coreMaterial === 'air' && (
                        <text x="200" y="155" textAnchor="middle" className="text-[8px] font-black fill-slate-700">AIR CORE</text>
                     )}

                     {/* Coils */}
                     {Array.from({ length: Math.floor(numCoils / 5) }).map((_, i) => (
                        <path
                           key={i}
                           d={`M ${110 + i * 10},120 Q ${115 + i * 10},110 ${120 + i * 10},120 L ${120 + i * 10},180 Q ${115 + i * 10},190 ${110 + i * 10},180 Z`}
                           fill="none"
                           stroke="#b45309"
                           strokeWidth="2"
                        />
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Number of Turns (N)</label>
                     <input
                        type="range"
                        min="10"
                        max="100"
                        value={numCoils}
                        onChange={(e) => setNumCoils(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10</span>
                        <span>{numCoils} Turns</span>
                        <span>100</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Current (I)</label>
                     <input
                        type="range"
                        min="0"
                        max="5"
                        step="0.1"
                        value={current}
                        onChange={(e) => setCurrent(parseFloat(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0A</span>
                        <span>{current} Amps</span>
                        <span>5A</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Core Material</label>
                     <div className="grid grid-cols-2 gap-2">
                        <button
                           onClick={() => setCoreMaterial('air')}
                           className={`p-2 rounded-xl border text-[10px] font-black transition-all ${coreMaterial === 'air' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
                        >
                           AIR
                        </button>
                        <button
                           onClick={() => setCoreMaterial('iron')}
                           className={`p-2 rounded-xl border text-[10px] font-black transition-all ${coreMaterial === 'iron' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
                        >
                           IRON
                        </button>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-orange-500/5 rounded-2xl border border-orange-500/10">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest">The Secret</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        An iron core concentrates the magnetic field lines because it has high <strong>permeability</strong>. This can make the magnet 100x stronger!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BASIC MOTOR RENDERER ---
   const BasicMotorRenderer = () => {
      const [speed, setSpeed] = useState(0);
      const [rotation, setRotation] = useState(0);

      useEffect(() => {
         if (speed === 0) return;
         const interval = setInterval(() => {
            setRotation(prev => (prev + speed) % 360);
         }, 16);
         return () => clearInterval(interval);
      }, [speed]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">DC MOTOR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Lorentz Force & Commutation</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">RPM (est.)</p>
                  <p className="text-sm font-black text-white">{speed * 60}</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="400" height="300" className="overflow-visible">
                  {/* Stator Magnets */}
                  <rect x="50" y="100" width="40" height="100" fill="#ef4444" rx="4" />
                  <text x="70" y="155" textAnchor="middle" className="text-xl font-black fill-white">N</text>
                  <rect x="310" y="100" width="40" height="100" fill="#3b82f6" rx="4" />
                  <text x="330" y="155" textAnchor="middle" className="text-xl font-black fill-white">S</text>

                  {/* Rotor (Armature) */}
                  <g transform={`rotate(${rotation}, 200, 150)`}>
                     <rect x="150" y="140" width="100" height="20" fill="#b45309" rx="2" stroke="#78350f" />
                     <rect x="195" y="100" width="10" height="100" fill="#b45309" rx="2" stroke="#78350f" />
                     {/* Force Arrows */}
                     {speed > 0 && (
                        <g>
                           <path d="M 150,140 L 150,100" stroke="#10b981" strokeWidth="4" markerEnd="url(#arrowhead)" />
                           <path d="M 250,160 L 250,200" stroke="#10b981" strokeWidth="4" markerEnd="url(#arrowhead)" />
                        </g>
                     )}
                  </g>

                  {/* Commutator & Brushes */}
                  <circle cx="200" cy="150" r="15" fill="#94a3b8" stroke="#475569" />
                  <path d="M 180,150 L 170,150 M 220,150 L 230,150" stroke="#475569" strokeWidth="4" />

                  <defs>
                     <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                     </marker>
                  </defs>
               </svg>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex flex-col gap-4">
                  <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest text-center">Throttle (Current)</label>
                  <input
                     type="range"
                     min="0"
                     max="10"
                     step="1"
                     value={speed}
                     onChange={(e) => setSpeed(parseInt(e.target.value))}
                     className="w-full accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] font-bold text-slate-500">
                     <span>OFF</span>
                     <span>{speed === 0 ? 'STOPPED' : 'RUNNING'}</span>
                     <span>MAX POWER</span>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BASIC GENERATOR RENDERER ---
   const BasicGeneratorRenderer = () => {
      const [rotation, setRotation] = useState(0);
      const [isSpinning, setIsSpinning] = useState(false);

      useEffect(() => {
         if (!isSpinning) return;
         const interval = setInterval(() => {
            setRotation(prev => (prev + 5) % 360);
         }, 16);
         return () => clearInterval(interval);
      }, [isSpinning]);

      const voltage = Math.sin(rotation * (Math.PI / 180)) * 10;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">AC GENERATOR</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Faraday's Law & Induction</p>
               </div>
               <div className="bg-yellow-500/10 px-4 py-2 rounded-xl border border-yellow-500/20">
                  <p className="text-[8px] font-black text-yellow-400 uppercase tracking-widest">Output Voltage</p>
                  <p className="text-sm font-black text-white">{voltage.toFixed(2)} V</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Magnets */}
                     <rect x="50" y="100" width="40" height="100" fill="#ef4444" rx="4" />
                     <rect x="310" y="100" width="40" height="100" fill="#3b82f6" rx="4" />

                     {/* Rotating Coil */}
                     <g transform={`rotate(${rotation}, 200, 150)`}>
                        <rect x="150" y="100" width="100" height="100" fill="none" stroke="#fbbf24" strokeWidth="4" rx="4" />
                        {/* Flux Lines (Visual) */}
                        <line x1="150" y1="150" x2="250" y2="150" stroke="#fbbf24" strokeWidth="1" strokeDasharray="4 4" />
                     </g>

                     {/* Slip Rings */}
                     <circle cx="200" cy="250" r="10" fill="none" stroke="#94a3b8" strokeWidth="2" />
                     <circle cx="200" cy="270" r="10" fill="none" stroke="#94a3b8" strokeWidth="2" />
                  </svg>
               </div>

               {/* Oscilloscope */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-hidden border-t lg:border-t-0 border-slate-800">
                  <div className="flex-1 bg-slate-950 rounded-2xl border border-slate-800 relative overflow-hidden">
                     <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 pointer-events-none">
                        {Array.from({ length: 16 }).map((_, i) => (
                           <div key={i} className="border border-slate-900/50" />
                        ))}
                     </div>
                     {/* Sine Wave */}
                     <svg className="absolute inset-0 w-full h-full">
                        <path
                           d={Array.from({ length: 100 }).map((_, i) => {
                              const x = (i / 100) * 320;
                              const y = 80 + Math.sin((i / 10 + rotation / 10) * Math.PI) * 50;
                              return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                           }).join(' ')}
                           fill="none"
                           stroke="#fbbf24"
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Oscilloscope</div>
                  </div>

                  <button
                     onClick={() => setIsSpinning(!isSpinning)}
                     className={`w-full py-4 rounded-2xl text-xs font-black transition-all ${isSpinning ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/40'}`}
                  >
                     {isSpinning ? 'STOP TURBINE' : 'START TURBINE'}
                  </button>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-500/10 flex items-center justify-center border border-yellow-500/20 shrink-0">
                     <span className="text-2xl">üåÄ</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A generator is just a motor in reverse! Instead of using electricity to make motion, we use <strong>motion to make electricity</strong> by spinning a coil through a magnetic field.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- EARTH FIELD RENDERER ---
   const EarthFieldRenderer = () => {
      const [showField, setShowField] = useState(true);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">GEOMAGNETISM</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Earth's Protective Shield</p>
               </div>
               <button
                  onClick={() => setShowField(!showField)}
                  className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${showField ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/40' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
               >
                  {showField ? 'HIDE FIELD' : 'SHOW FIELD'}
               </button>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative">
                  {/* Earth */}
                  <div className="w-48 h-48 rounded-full bg-gradient-to-br from-blue-600 to-emerald-600 shadow-[0_0_50px_rgba(59,130,246,0.3)] relative overflow-hidden border-2 border-blue-400/20">
                     {/* Continents (Simplified) */}
                     <div className="absolute top-4 left-8 w-12 h-8 bg-emerald-500/40 rounded-full blur-sm" />
                     <div className="absolute top-20 left-20 w-16 h-12 bg-emerald-500/40 rounded-full blur-sm" />
                     <div className="absolute bottom-8 left-12 w-10 h-14 bg-emerald-500/40 rounded-full blur-sm" />

                     {/* Internal Magnet */}
                     <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-32 flex flex-col rounded-full overflow-hidden opacity-80 rotate-[11deg]">
                        <div className="flex-1 bg-blue-600 flex items-center justify-center text-[8px] font-black">S</div>
                        <div className="flex-1 bg-red-600 flex items-center justify-center text-[8px] font-black">N</div>
                     </div>
                  </div>

                  {/* Magnetic Field Lines */}
                  {showField && (
                     <svg className="absolute inset-0 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] pointer-events-none overflow-visible" style={{ left: '50%', top: '50%' }}>
                        <defs>
                           <linearGradient id="earth-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                              <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.2" />
                              <stop offset="50%" stopColor="#3b82f6" stopOpacity="0.05" />
                              <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.2" />
                           </linearGradient>
                        </defs>
                        <g transform="rotate(11, 300, 300)">
                           {Array.from({ length: 8 }).map((_, i) => (
                              <ellipse
                                 key={i}
                                 cx="300" cy="300"
                                 rx={100 + i * 40}
                                 ry={150 + i * 60}
                                 fill="none"
                                 stroke="url(#earth-grad)"
                                 strokeWidth="1.5"
                                 strokeDasharray="5 5"
                                 className="animate-[pulse_4s_infinite]"
                                 style={{ animationDelay: `${i * 0.5}s` }}
                              />
                           ))}
                        </g>
                     </svg>
                  )}

                  {/* Solar Wind (Visual) */}
                  <div className="absolute left-[-300px] top-1/2 -translate-y-1/2 flex flex-col gap-8 opacity-40">
                     {Array.from({ length: 5 }).map((_, i) => (
                        <div
                           key={i}
                           className="w-32 h-1 bg-gradient-to-r from-yellow-400 to-transparent rounded-full animate-[slide_2s_linear_infinite]"
                           style={{ animationDelay: `${i * 0.4}s` }}
                        />
                     ))}
                  </div>
               </div>

               <style>{`
                  @keyframes slide {
                     from { transform: translateX(0); }
                     to { transform: translateX(100px); }
                  }
               `}</style>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">üåç</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Earth is like a giant bar magnet! Its magnetic field (the <strong>magnetosphere</strong>) acts as a shield, deflecting harmful solar radiation and making life possible.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- HOUSEHOLD SAFETY RENDERER ---
   const HouseholdSafetyRenderer = () => {
      const [isOverloaded, setIsOverloaded] = useState(false);
      const [breakerTripped, setBreakerTripped] = useState(false);
      const [appliances, setAppliances] = useState({
         toaster: false,
         microwave: false,
         kettle: false
      });

      const totalCurrent = (appliances.toaster ? 8 : 0) + (appliances.microwave ? 10 : 0) + (appliances.kettle ? 9 : 0);
      const limit = 20;

      useEffect(() => {
         if (totalCurrent > limit && !breakerTripped) {
            setIsOverloaded(true);
            const timer = setTimeout(() => {
               setBreakerTripped(true);
               setIsOverloaded(false);
            }, 1000);
            return () => clearTimeout(timer);
         }
      }, [totalCurrent, breakerTripped]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">ELECTRICAL SAFETY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Breakers & Overloads</p>
               </div>
               <div className="flex gap-4">
                  <div className={`px-4 py-2 rounded-xl border transition-all ${breakerTripped ? 'bg-red-500/20 border-red-500/30' : 'bg-emerald-500/20 border-emerald-500/30'}`}>
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Breaker Status</p>
                     <p className={`text-sm font-black ${breakerTripped ? 'text-red-400' : 'text-emerald-400'}`}>
                        {breakerTripped ? 'TRIPPED' : 'ACTIVE'}
                     </p>
                  </div>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Circuit Board */}
               <div className="w-full max-w-2xl bg-slate-900/50 rounded-3xl border border-slate-800 p-8">
                  <div className="flex justify-between items-end gap-8">
                     {/* Appliances */}
                     {Object.entries(appliances).map(([name, active]) => (
                        <button
                           key={name}
                           onClick={() => !breakerTripped && setAppliances(prev => ({ ...prev, [name]: !active }))}
                           className={`flex-1 p-6 rounded-2xl border transition-all flex flex-col items-center gap-4 ${active ? 'bg-slate-800 border-slate-600' : 'bg-slate-950 border-slate-800'}`}
                        >
                           <span className="text-3xl">{name === 'toaster' ? 'üçû' : name === 'microwave' ? 'üç±' : 'ü´ñ'}</span>
                           <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">{name}</span>
                           <span className={`text-[10px] font-bold ${active ? 'text-emerald-400' : 'text-slate-700'}`}>{active ? 'ON' : 'OFF'}</span>
                        </button>
                     ))}
                  </div>

                  {/* Meter */}
                  <div className="mt-12 p-6 bg-slate-950 rounded-2xl border border-slate-800">
                     <div className="flex justify-between items-center mb-4">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Load</span>
                        <span className={`text-xl font-black ${totalCurrent > limit ? 'text-red-500' : 'text-white'}`}>{breakerTripped ? 0 : totalCurrent} / {limit} Amps</span>
                     </div>
                     <div className="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-800">
                        <div
                           className={`h-full transition-all duration-500 ${totalCurrent > limit ? 'bg-red-500' : 'bg-emerald-500'}`}
                           style={{ width: `${breakerTripped ? 0 : (totalCurrent / limit) * 100}%` }}
                        />
                     </div>
                  </div>
               </div>

               {breakerTripped && (
                  <button
                     onClick={() => {
                        setBreakerTripped(false);
                        setAppliances({ toaster: false, microwave: false, kettle: false });
                     }}
                     className="mt-8 px-8 py-3 bg-red-500 text-white rounded-xl font-black text-xs shadow-lg shadow-red-500/40 animate-bounce"
                  >
                     RESET CIRCUIT BREAKER
                  </button>
               )}
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üõ°Ô∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A <strong>circuit breaker</strong> is a safety switch. If too many appliances are on at once, the wire gets hot and could start a fire. The breaker "trips" to cut the power before that happens!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- COULOMB'S LAW RENDERER ---
   const CoulombsLawRenderer = () => {
      const [q1, setQ1] = useState(5); // microCoulombs
      const [q2, setQ2] = useState(-5);
      const [distance, setDistance] = useState(10); // cm

      const k = 8.987e9;
      const force = (k * Math.abs(q1 * 1e-6 * q2 * 1e-6)) / Math.pow(distance * 1e-2, 2);
      const isAttractive = (q1 > 0 && q2 < 0) || (q1 < 0 && q2 > 0);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">COULOMB'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Electrostatic Force</p>
               </div>
               <div className="bg-purple-500/10 px-4 py-2 rounded-xl border border-purple-500/20">
                  <p className="text-[8px] font-black text-purple-400 uppercase tracking-widest">Force (F)</p>
                  <p className="text-sm font-black text-white">{force.toFixed(2)} Newtons</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative w-full max-w-2xl h-64 flex items-center justify-between px-20">
                  {/* Charge 1 */}
                  <div
                     className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 ${q1 > 0 ? 'bg-red-500 shadow-red-500/50' : 'bg-blue-500 shadow-blue-500/50'}`}
                     style={{ transform: `scale(${0.8 + Math.abs(q1) / 20})` }}
                  >
                     <span className="text-xl font-black">{q1 > 0 ? '+' : '-'}{Math.abs(q1)}</span>
                  </div>

                  {/* Force Arrows */}
                  <div className="flex-1 flex items-center justify-center relative">
                     <div className="w-full h-1 bg-slate-800 absolute top-1/2 -translate-y-1/2" />
                     <div
                        className={`absolute top-1/2 -translate-y-1/2 flex items-center gap-2 transition-all duration-500 ${isAttractive ? 'flex-row' : 'flex-row-reverse'}`}
                        style={{ width: `${100 - distance * 2}%` }}
                     >
                        <div className={`w-8 h-8 border-t-4 border-r-4 border-purple-500 ${isAttractive ? 'rotate-45' : '-rotate-[135deg]'}`} />
                        <div className="flex-1 h-1 bg-purple-500 animate-pulse" />
                        <div className={`w-8 h-8 border-t-4 border-r-4 border-purple-500 ${isAttractive ? '-rotate-[135deg]' : 'rotate-45'}`} />
                     </div>
                  </div>

                  {/* Charge 2 */}
                  <div
                     className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 ${q2 > 0 ? 'bg-red-500 shadow-red-500/50' : 'bg-blue-500 shadow-blue-500/50'}`}
                     style={{ transform: `scale(${0.8 + Math.abs(q2) / 20})` }}
                  >
                     <span className="text-xl font-black">{q2 > 0 ? '+' : '-'}{Math.abs(q2)}</span>
                  </div>
               </div>

               {/* Distance Label */}
               <div className="absolute bottom-20 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                  Distance: {distance} cm
               </div>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-4xl mx-auto grid grid-cols-3 gap-8">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-red-400 uppercase tracking-widest">Charge 1 (ŒºC)</label>
                     <input
                        type="range"
                        min="-10"
                        max="10"
                        value={q1}
                        onChange={(e) => setQ1(parseInt(e.target.value))}
                        className="w-full accent-red-500"
                     />
                  </div>
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Charge 2 (ŒºC)</label>
                     <input
                        type="range"
                        min="-10"
                        max="10"
                        value={q2}
                        onChange={(e) => setQ2(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                  </div>
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Distance (cm)</label>
                     <input
                        type="range"
                        min="5"
                        max="50"
                        value={distance}
                        onChange={(e) => setDistance(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTRIC FIELD RENDERER ---
   const ElectricFieldRenderer = () => {
      const [charges, setCharges] = useState([
         { x: 150, y: 150, q: 1 },
         { x: 350, y: 150, q: -1 }
      ]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">ELECTRIC FIELD MAP</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Vector Fields & Flux</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="500" height="300" className="overflow-visible">
                  {/* Field Vectors (Simplified Grid) */}
                  {Array.from({ length: 10 }).map((_, i) => (
                     Array.from({ length: 6 }).map((_, j) => {
                        const px = 50 + i * 45;
                        const py = 40 + j * 45;

                        // Calculate net field at this point
                        let ex = 0;
                        let ey = 0;
                        charges.forEach(c => {
                           const dx = px - c.x;
                           const dy = py - c.y;
                           const r2 = dx * dx + dy * dy;
                           const r = Math.sqrt(r2);
                           const f = c.q / (r2 * r);
                           ex += f * dx;
                           ey += f * dy;
                        });

                        const angle = Math.atan2(ey, ex) * (180 / Math.PI);
                        const mag = Math.sqrt(ex * ex + ey * ey);
                        const opacity = Math.min(0.6, mag * 100000);

                        return (
                           <g key={`${i}-${j}`} transform={`translate(${px}, ${py}) rotate(${angle})`} opacity={opacity}>
                              <path d="M -5,0 L 5,0 M 2,-3 L 5,0 L 2,3" fill="none" stroke="#22d3ee" strokeWidth="1" />
                           </g>
                        );
                     })
                  ))}

                  {/* Charges */}
                  {charges.map((c, i) => (
                     <circle
                        key={i}
                        cx={c.x} cy={c.y} r="12"
                        fill={c.q > 0 ? '#ef4444' : '#3b82f6'}
                        className="cursor-pointer"
                        onClick={() => {
                           const newCharges = [...charges];
                           newCharges[i].q *= -1;
                           setCharges(newCharges);
                        }}
                     />
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">üìç</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Electric field lines always point <strong>away from positive</strong> charges and <strong>towards negative</strong> charges. The closer the lines, the stronger the field!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CAPACITOR LAB RENDERER ---
   const CapacitorLabRenderer = () => {
      const [area, setArea] = useState(200); // mm^2
      const [separation, setSeparation] = useState(5); // mm
      const [voltage, setVoltage] = useState(5);

      const epsilon0 = 8.854e-12;
      const capacitance = (epsilon0 * area * 1e-6) / (separation * 1e-3);
      const charge = capacitance * voltage;
      const energy = 0.5 * capacitance * voltage * voltage;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">CAPACITOR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Dielectrics & Energy Storage</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-emerald-500/10 px-4 py-2 rounded-xl border border-emerald-500/20 text-right">
                     <p className="text-[8px] font-black text-emerald-400 uppercase tracking-widest">Capacitance</p>
                     <p className="text-sm font-black text-white">{(capacitance * 1e12).toFixed(2)} pF</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative flex flex-col items-center gap-4">
                     {/* Top Plate */}
                     <div
                        className="h-4 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center relative shadow-[0_0_20px_rgba(16,185,129,0.2)]"
                        style={{ width: `${area / 2}px`, transform: `translateY(${-separation * 5}px)` }}
                     >
                        {Array.from({ length: Math.floor(charge * 1e11) }).map((_, i) => (
                           <div key={i} className="w-1 h-1 bg-red-500 rounded-full mx-0.5" />
                        ))}
                        <div className="absolute -top-6 text-[8px] font-black text-red-400">+ CHARGE</div>
                     </div>

                     {/* Bottom Plate */}
                     <div
                        className="h-4 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center relative shadow-[0_0_20px_rgba(16,185,129,0.2)]"
                        style={{ width: `${area / 2}px`, transform: `translateY(${separation * 5}px)` }}
                     >
                        {Array.from({ length: Math.floor(charge * 1e11) }).map((_, i) => (
                           <div key={i} className="w-1 h-1 bg-blue-500 rounded-full mx-0.5" />
                        ))}
                        <div className="absolute -bottom-6 text-[8px] font-black text-blue-400">- CHARGE</div>
                     </div>

                     {/* Field Lines */}
                     <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        {Array.from({ length: 10 }).map((_, i) => (
                           <div
                              key={i}
                              className="w-0.5 bg-emerald-500/20 absolute"
                              style={{
                                 height: `${separation * 10}px`,
                                 left: `${(i * 10) + (50 - (10 * 5))}%`
                              }}
                           />
                        ))}
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Plate Area (A)</label>
                     <input
                        type="range"
                        min="100"
                        max="400"
                        value={area}
                        onChange={(e) => setArea(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>100 mm¬≤</span>
                        <span>{area} mm¬≤</span>
                        <span>400 mm¬≤</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Separation (d)</label>
                     <input
                        type="range"
                        min="2"
                        max="20"
                        value={separation}
                        onChange={(e) => setSeparation(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>2 mm</span>
                        <span>{separation} mm</span>
                        <span>20 mm</span>
                     </div>
                  </div>

                  <div className="p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest">Stored Energy</p>
                     <p className="text-xl font-black text-white">{(energy * 1e9).toFixed(2)} nJ</p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] text-slate-400 leading-tight">
                        Capacitance increases with <strong>Area</strong> and decreases with <strong>Separation</strong>. It's like a bucket for electric charge!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RLC CIRCUIT RENDERER ---
   const RLCCircuitRenderer = () => {
      const [frequency, setFrequency] = useState(60); // Hz
      const [resistance, setResistance] = useState(10); // Ohms
      const [inductance, setInductance] = useState(0.1); // Henrys
      const [capacitance, setCapacitance] = useState(100); // microFarads

      const omega = 2 * Math.PI * frequency;
      const xl = omega * inductance;
      const xc = 1 / (omega * capacitance * 1e-6);
      const impedance = Math.sqrt(Math.pow(resistance, 2) + Math.pow(xl - xc, 2));
      const phase = Math.atan((xl - xc) / resistance) * (180 / Math.PI);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">RLC CIRCUIT LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Impedance & Resonance</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">Impedance (Z)</p>
                  <p className="text-sm font-black text-white">{impedance.toFixed(2)} Œ©</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Phasor Diagram */}
                  <div className="relative w-64 h-64 border-2 border-slate-800 rounded-full">
                     <div className="absolute inset-0 flex items-center justify-center">
                        {/* R Vector */}
                        <div
                           className="h-1 bg-emerald-500 absolute origin-left"
                           style={{ width: `${resistance * 5}px`, transform: 'rotate(0deg)' }}
                        />
                        {/* XL Vector */}
                        <div
                           className="h-1 bg-red-500 absolute origin-left"
                           style={{ width: `${xl * 2}px`, transform: 'rotate(-90deg)' }}
                        />
                        {/* XC Vector */}
                        <div
                           className="h-1 bg-blue-500 absolute origin-left"
                           style={{ width: `${xc * 2}px`, transform: 'rotate(90deg)' }}
                        />
                        {/* Z Vector */}
                        <div
                           className="h-1.5 bg-white absolute origin-left shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                           style={{ width: `${impedance * 5}px`, transform: `rotate(${-phase}deg)` }}
                        />
                     </div>
                     <div className="absolute top-2 left-2 text-[8px] font-black text-slate-500 uppercase">Phasor Diagram</div>
                  </div>

                  <div className="mt-12 grid grid-cols-3 gap-8 text-center">
                     <div>
                        <p className="text-[8px] font-black text-red-400 uppercase tracking-widest">X_L</p>
                        <p className="text-lg font-black">{xl.toFixed(1)}Œ©</p>
                     </div>
                     <div>
                        <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">X_C</p>
                        <p className="text-lg font-black">{xc.toFixed(1)}Œ©</p>
                     </div>
                     <div>
                        <p className="text-[8px] font-black text-white uppercase tracking-widest">Phase</p>
                        <p className="text-lg font-black">{phase.toFixed(1)}¬∞</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Frequency (f)</label>
                     <input
                        type="range"
                        min="10"
                        max="200"
                        value={frequency}
                        onChange={(e) => setFrequency(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10 Hz</span>
                        <span>{frequency} Hz</span>
                        <span>200 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Inductance (L)</label>
                     <input
                        type="range"
                        min="0.01"
                        max="0.5"
                        step="0.01"
                        value={inductance}
                        onChange={(e) => setInductance(parseFloat(e.target.value))}
                        className="w-full accent-red-500"
                     />
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Capacitance (C)</label>
                     <input
                        type="range"
                        min="10"
                        max="500"
                        value={capacitance}
                        onChange={(e) => setCapacitance(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                     <p className="text-[10px] text-slate-400 leading-tight">
                        Resonance occurs when <strong>X_L = X_C</strong>. At this point, the impedance is at its minimum and equal to the resistance!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- FARADAY'S LAW RENDERER ---
   const FaradaysLawRenderer = () => {
      const [magnetPos, setMagnetPos] = useState(0);
      const [isMoving, setIsMoving] = useState(false);
      const [inducedVoltage, setInducedVoltage] = useState(0);

      useEffect(() => {
         if (!isMoving) {
            setInducedVoltage(0);
            return;
         }
         const interval = setInterval(() => {
            setMagnetPos(prev => {
               const next = prev + 5;
               if (next > 400) {
                  setIsMoving(false);
                  return 0;
               }
               // Voltage is proportional to velocity (rate of change of flux)
               setInducedVoltage(Math.sin(next / 20) * 10);
               return next;
            });
         }, 16);
         return () => clearInterval(interval);
      }, [isMoving]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">FARADAY'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Induction</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Induced EMF (Œµ)</p>
                  <p className="text-sm font-black text-white">{inducedVoltage.toFixed(2)} V</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               <svg width="500" height="300" className="overflow-visible">
                  {/* Coil */}
                  <g transform="translate(250, 150)">
                     {Array.from({ length: 5 }).map((_, i) => (
                        <ellipse
                           key={i}
                           cx={-20 + i * 10} cy="0"
                           rx="20" ry="60"
                           fill="none"
                           stroke="#b45309"
                           strokeWidth="3"
                           strokeOpacity={0.8}
                        />
                     ))}
                  </g>

                  {/* Magnet */}
                  <g transform={`translate(${magnetPos}, 150)`}>
                     <rect x="-60" y="-20" width="60" height="40" fill="#ef4444" rx="4" />
                     <rect x="0" y="-20" width="60" height="40" fill="#3b82f6" rx="4" />
                     <text x="-30" y="5" textAnchor="middle" className="text-xs font-black fill-white">N</text>
                     <text x="30" y="5" textAnchor="middle" className="text-xs font-black fill-white">S</text>

                     {/* Magnetic Field Lines (Visual) */}
                     {Array.from({ length: 6 }).map((_, i) => (
                        <path
                           key={i}
                           d={`M 60,${-15 + i * 6} Q 100,${-30 + i * 12} 140,${-15 + i * 6}`}
                           fill="none"
                           stroke="#fb923c"
                           strokeWidth="1"
                           strokeOpacity="0.3"
                        />
                     ))}
                  </g>

                  {/* Galvanometer */}
                  <g transform="translate(250, 250)">
                     <rect x="-50" y="-30" width="100" height="60" fill="#1e293b" rx="8" stroke="#334155" />
                     <path d="M -40,10 Q 0,-40 40,10" fill="none" stroke="#475569" strokeWidth="2" />
                     <line
                        x1="0" y1="10"
                        x2={inducedVoltage * 4} y2="-20"
                        stroke="#ef4444"
                        strokeWidth="3"
                        className="transition-all duration-100"
                     />
                     <text x="0" y="20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">GALVANOMETER</text>
                  </g>
               </svg>

               <button
                  onClick={() => setIsMoving(true)}
                  disabled={isMoving}
                  className={`mt-8 px-8 py-3 rounded-xl font-black text-xs transition-all ${isMoving ? 'bg-slate-800 text-slate-500' : 'bg-orange-500 text-white shadow-lg shadow-orange-500/40'}`}
               >
                  {isMoving ? 'INDUCING CURRENT...' : 'PUSH MAGNET THROUGH COIL'}
               </button>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üß≤</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Lenz's Law</strong>: The induced current creates a magnetic field that <strong>opposes</strong> the change that created it. Nature doesn't like change!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC FLUX RENDERER ---
   const MagneticFluxRenderer = () => {
      const [angle, setAngle] = useState(0);
      const [fieldStrength, setFieldStrength] = useState(0.5);
      const [loopArea, setLoopArea] = useState(0.1);
      const [isAnimating, setIsAnimating] = useState(false);

      const flux = fieldStrength * loopArea * Math.cos(angle * Math.PI / 180);

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => {
            setAngle(prev => (prev + 2) % 360);
         }, 50);
         return () => clearInterval(interval);
      }, [isAnimating]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50">
               <h3 className="text-xl font-black tracking-tight text-cyan-400">MAGNETIC FLUX</h3>
               <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Œ¶ = BA cos Œ∏</p>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="400" height="350" viewBox="0 0 400 350">
                     {/* Magnetic field lines */}
                     {Array.from({ length: 8 }).map((_, i) => (
                        <line key={i} x1="50" y1={70 + i * 30} x2="350" y2={70 + i * 30}
                           stroke="#3b82f6" strokeWidth="2" strokeOpacity={0.3 + fieldStrength * 0.5}
                           markerEnd="url(#arrowB)" />
                     ))}
                     <defs>
                        <marker id="arrowB" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                           <path d="M0,0 L6,3 L0,6 Z" fill="#3b82f6" fillOpacity={0.5 + fieldStrength * 0.5} />
                        </marker>
                     </defs>

                     {/* Loop */}
                     <g transform={`translate(200, 180) rotate(${angle})`}>
                        <ellipse cx="0" cy="0" rx={80 * loopArea * 10} ry="60" fill="none"
                           stroke="#fbbf24" strokeWidth="4" />
                        <line x1="0" y1="-60" x2="0" y2="-100" stroke="#fbbf24" strokeWidth="2" />
                        <polygon points="0,-100 -6,-88 6,-88" fill="#fbbf24" />
                        <text x="15" y="-85" className="text-[10px] font-bold fill-fbbf24">nÃÇ</text>
                     </g>

                     {/* Angle arc */}
                     <path d={`M 200,120 A 60,60 0 0 1 ${200 + 60 * Math.sin(angle * Math.PI / 180)},${120 - 60 * Math.cos(angle * Math.PI / 180)}`}
                        fill="none" stroke="#22c55e" strokeWidth="2" strokeDasharray="4" />
                     <text x="220" y="105" className="text-xs font-bold fill-emerald-400">Œ∏ = {angle}¬∞</text>
                  </svg>
               </div>

               <div className="w-full md:w-80 bg-slate-900/50 border-l border-slate-800 p-6 flex flex-col gap-6">
                  <div className="p-4 bg-gradient-to-br from-cyan-900/30 to-cyan-800/20 rounded-2xl border border-cyan-500/20">
                     <p className="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-2">Magnetic Flux</p>
                     <p className="text-3xl font-black text-white">{(flux * 1000).toFixed(2)} <span className="text-sm text-slate-400">mWb</span></p>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Angle (Œ∏)</label>
                           <span className="text-xs font-mono text-cyan-400">{angle}¬∞</span>
                        </div>
                        <input type="range" min="0" max="360" value={angle} onChange={(e) => setAngle(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Field Strength (B)</label>
                           <span className="text-xs font-mono text-cyan-400">{fieldStrength.toFixed(2)} T</span>
                        </div>
                        <input type="range" min="0.1" max="1" step="0.05" value={fieldStrength}
                           onChange={(e) => setFieldStrength(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Loop Area (A)</label>
                           <span className="text-xs font-mono text-cyan-400">{loopArea.toFixed(2)} m¬≤</span>
                        </div>
                        <input type="range" min="0.05" max="0.2" step="0.01" value={loopArea}
                           onChange={(e) => setLoopArea(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>
                  </div>

                  <button onClick={() => setIsAnimating(!isAnimating)}
                     className={`w-full py-3 rounded-xl font-black text-xs transition-all ${isAnimating
                        ? 'bg-red-500/20 text-red-400 border border-red-500/30'
                        : 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/30'}`}>
                     {isAnimating ? '‚è∏ STOP ROTATION' : '‚ñ∂ ROTATE LOOP'}
                  </button>

                  <div className="mt-auto p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                     <p className="text-xs text-slate-400 leading-relaxed">
                        <strong className="text-cyan-400">KEY INSIGHT:</strong> Flux is maximum when the loop is perpendicular to the field (Œ∏=0¬∞) and zero when parallel (Œ∏=90¬∞).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LENZ'S LAW RENDERER ---
   const LenzsLawRenderer = () => {
      const [magnetPosition, setMagnetPosition] = useState(0);
      const [magnetDirection, setMagnetDirection] = useState<'approaching' | 'receding' | 'stationary'>('stationary');
      const [inducedCurrent, setInducedCurrent] = useState(0);
      const [coilPolarity, setCoilPolarity] = useState<'N' | 'S' | null>(null);

      useEffect(() => {
         if (magnetDirection === 'stationary') {
            setInducedCurrent(0);
            setCoilPolarity(null);
            return;
         }

         const interval = setInterval(() => {
            setMagnetPosition(prev => {
               const delta = magnetDirection === 'approaching' ? 3 : -3;
               const next = prev + delta;

               if (next > 150 || next < -150) {
                  setMagnetDirection('stationary');
                  return 0;
               }

               const currentMagnitude = Math.abs(delta) * 2;
               setInducedCurrent(magnetDirection === 'approaching' ? -currentMagnitude : currentMagnitude);
               setCoilPolarity(magnetDirection === 'approaching' ? 'N' : 'S');
               return next;
            });
         }, 30);

         return () => clearInterval(interval);
      }, [magnetDirection]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">LENZ'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Induced Current Opposes Change</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border ${inducedCurrent !== 0
                  ? 'bg-yellow-500/10 border-yellow-500/30'
                  : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[8px] font-black text-slate-400 uppercase">Induced Current</p>
                  <p className={`text-lg font-black ${inducedCurrent > 0 ? 'text-green-400' : inducedCurrent < 0 ? 'text-red-400' : 'text-slate-500'}`}>
                     {inducedCurrent > 0 ? '‚Üª ' : inducedCurrent < 0 ? '‚Ü∫ ' : ''}{Math.abs(inducedCurrent).toFixed(1)} A
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col items-center justify-center p-8 relative">
               <svg width="500" height="280" viewBox="0 0 500 280">
                  {/* Coil */}
                  <g transform="translate(250, 140)">
                     {Array.from({ length: 8 }).map((_, i) => (
                        <ellipse key={i} cx={-35 + i * 10} cy="0" rx="25" ry="70"
                           fill="none" stroke={inducedCurrent !== 0 ? '#fbbf24' : '#64748b'}
                           strokeWidth="3" strokeOpacity={0.8} />
                     ))}
                     {coilPolarity && (
                        <text x="-70" y="10" className="text-2xl font-black"
                           fill={coilPolarity === 'N' ? '#ef4444' : '#3b82f6'}>{coilPolarity}</text>
                     )}
                  </g>

                  {/* Magnet */}
                  <g transform={`translate(${80 + magnetPosition}, 140)`}>
                     <rect x="-50" y="-25" width="50" height="50" fill="#ef4444" rx="4" />
                     <rect x="0" y="-25" width="50" height="50" fill="#3b82f6" rx="4" />
                     <text x="-25" y="8" textAnchor="middle" className="text-lg font-black fill-white">N</text>
                     <text x="25" y="8" textAnchor="middle" className="text-lg font-black fill-white">S</text>
                     {magnetDirection !== 'stationary' && (
                        <text x={magnetDirection === 'approaching' ? 70 : -70} y="8"
                           className="text-2xl" fill="#22c55e">{magnetDirection === 'approaching' ? '‚Üí' : '‚Üê'}</text>
                     )}
                  </g>

                  {/* Field lines from coil (when current flows) */}
                  {inducedCurrent !== 0 && (
                     <g transform="translate(250, 140)" opacity={0.4}>
                        {Array.from({ length: 5 }).map((_, i) => (
                           <path key={i} d={`M -80,${-30 + i * 15} Q -120,${-50 + i * 25} -80,${-30 + i * 15 + 30}`}
                              fill="none" stroke={coilPolarity === 'N' ? '#ef4444' : '#3b82f6'} strokeWidth="2" />
                        ))}
                     </g>
                  )}
               </svg>

               <div className="flex gap-4 mt-8">
                  <button onClick={() => { setMagnetPosition(-150); setMagnetDirection('approaching'); }}
                     disabled={magnetDirection !== 'stationary'}
                     className={`px-6 py-3 rounded-xl font-black text-xs transition-all ${magnetDirection !== 'stationary'
                        ? 'bg-slate-800 text-slate-600'
                        : 'bg-green-500 text-white shadow-lg shadow-green-500/30 hover:bg-green-400'}`}>
                     PUSH MAGNET IN ‚Üí
                  </button>
                  <button onClick={() => { setMagnetPosition(150); setMagnetDirection('receding'); }}
                     disabled={magnetDirection !== 'stationary'}
                     className={`px-6 py-3 rounded-xl font-black text-xs transition-all ${magnetDirection !== 'stationary'
                        ? 'bg-slate-800 text-slate-600'
                        : 'bg-red-500 text-white shadow-lg shadow-red-500/30 hover:bg-red-400'}`}>
                     ‚Üê PULL MAGNET OUT
                  </button>
               </div>

               <div className="mt-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700 max-w-lg text-center">
                  {magnetDirection === 'approaching' && (
                     <p className="text-sm text-slate-300">
                        <span className="text-purple-400 font-bold">APPROACHING:</span> Flux ‚Üë ‚Üí Coil creates <span className="text-red-400 font-bold">N pole</span> to REPEL incoming magnet
                     </p>
                  )}
                  {magnetDirection === 'receding' && (
                     <p className="text-sm text-slate-300">
                        <span className="text-purple-400 font-bold">RECEDING:</span> Flux ‚Üì ‚Üí Coil creates <span className="text-blue-400 font-bold">S pole</span> to ATTRACT departing magnet
                     </p>
                  )}
                  {magnetDirection === 'stationary' && (
                     <p className="text-sm text-slate-500">Move the magnet to see Lenz's Law in action!</p>
                  )}
               </div>
            </div>

            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <p className="text-xs text-slate-400 text-center">
                  <strong className="text-purple-400">KEY INSIGHT:</strong> The induced current always creates a magnetic field that <strong>opposes</strong> the change in flux. This is nature's way of conserving energy!
               </p>
            </div>
         </div>
      );
   };


   // --- BATTERY CONNECTIONS RENDERER ---
   const BatteryConnectionsRenderer = () => {
      const [mode, setMode] = useState<'series' | 'parallel'>('series');
      const [numBatteries, setNumBatteries] = useState(2);
      const [singleVoltage] = useState(1.5);
      const [singleCapacity] = useState(2000);

      const totalVoltage = mode === 'series' ? singleVoltage * numBatteries : singleVoltage;
      const totalCapacity = mode === 'parallel' ? singleCapacity * numBatteries : singleCapacity;

      return (
         <div className="flex flex-col h-full bg-slate-100 text-slate-900 font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-200 bg-white flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-600">BATTERY CONNECTIONS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Series vs Parallel</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setMode('series')}
                     className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${mode === 'series'
                        ? 'bg-amber-500 text-white shadow-lg'
                        : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                     SERIES
                  </button>
                  <button onClick={() => setMode('parallel')}
                     className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${mode === 'parallel'
                        ? 'bg-blue-500 text-white shadow-lg'
                        : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                     PARALLEL
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 flex items-center justify-center p-8 bg-slate-50">
                  <svg width="400" height="300" viewBox="0 0 400 300">
                     {mode === 'series' ? (
                        <g transform="translate(50, 150)">
                           {Array.from({ length: numBatteries }).map((_, i) => (
                              <g key={i} transform={`translate(${i * 80}, 0)`}>
                                 <rect x="0" y="-30" width="60" height="60" fill="#fef3c7" stroke="#f59e0b" strokeWidth="2" rx="4" />
                                 <line x1="10" y1="-15" x2="10" y2="15" stroke="#ef4444" strokeWidth="4" />
                                 <line x1="50" y1="-8" x2="50" y2="8" stroke="#1f2937" strokeWidth="4" />
                                 <text x="30" y="50" textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{singleVoltage}V</text>
                                 {i < numBatteries - 1 && <line x1="60" y1="0" x2="80" y2="0" stroke="#1f2937" strokeWidth="3" />}
                              </g>
                           ))}
                           <line x1="-20" y1="0" x2="0" y2="0" stroke="#ef4444" strokeWidth="3" />
                           <line x1={numBatteries * 80 - 20} y1="0" x2={numBatteries * 80} y2="0" stroke="#1f2937" strokeWidth="3" />
                           <text x={numBatteries * 40 - 10} y="-60" textAnchor="middle" className="text-lg font-black fill-amber-600">
                              Total: {totalVoltage.toFixed(1)}V
                           </text>
                        </g>
                     ) : (
                        <g transform="translate(100, 50)">
                           {Array.from({ length: numBatteries }).map((_, i) => (
                              <g key={i} transform={`translate(0, ${i * 70})`}>
                                 <rect x="50" y="0" width="60" height="50" fill="#dbeafe" stroke="#3b82f6" strokeWidth="2" rx="4" />
                                 <line x1="60" y1="10" x2="60" y2="40" stroke="#ef4444" strokeWidth="4" />
                                 <line x1="100" y1="15" x2="100" y2="35" stroke="#1f2937" strokeWidth="4" />
                                 <line x1="0" y1="25" x2="50" y2="25" stroke="#ef4444" strokeWidth="2" />
                                 <line x1="110" y1="25" x2="160" y2="25" stroke="#1f2937" strokeWidth="2" />
                              </g>
                           ))}
                           <line x1="0" y1="25" x2="0" y2={numBatteries * 70 - 45} stroke="#ef4444" strokeWidth="3" />
                           <line x1="160" y1="25" x2="160" y2={numBatteries * 70 - 45} stroke="#1f2937" strokeWidth="3" />
                           <text x="80" y={numBatteries * 70 + 20} textAnchor="middle" className="text-lg font-black fill-blue-600">
                              Total: {totalVoltage.toFixed(1)}V, {totalCapacity}mAh
                           </text>
                        </g>
                     )}
                  </svg>
               </div>

               <div className="w-full md:w-72 bg-white border-l border-slate-200 p-6 flex flex-col gap-4">
                  <div>
                     <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Number of Batteries</label>
                     <div className="flex gap-2">
                        {[2, 3, 4].map(n => (
                           <button key={n} onClick={() => setNumBatteries(n)}
                              className={`flex-1 py-2 rounded-lg font-bold text-sm ${numBatteries === n
                                 ? 'bg-slate-800 text-white'
                                 : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>

                  <div className="p-4 bg-amber-50 rounded-xl border border-amber-200">
                     <p className="text-[10px] font-black text-amber-700 uppercase mb-1">Series Connection</p>
                     <p className="text-sm text-amber-900">Voltages ADD: {numBatteries} √ó {singleVoltage}V = <strong>{(numBatteries * singleVoltage).toFixed(1)}V</strong></p>
                     <p className="text-xs text-amber-700 mt-1">Capacity stays the same</p>
                  </div>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-200">
                     <p className="text-[10px] font-black text-blue-700 uppercase mb-1">Parallel Connection</p>
                     <p className="text-sm text-blue-900">Voltage stays: <strong>{singleVoltage}V</strong></p>
                     <p className="text-sm text-blue-900">Capacity ADDS: {numBatteries} √ó {singleCapacity}mAh = <strong>{numBatteries * singleCapacity}mAh</strong></p>
                  </div>

                  <div className="mt-auto p-4 bg-slate-100 rounded-xl">
                     <p className="text-xs text-slate-600">
                        <strong className="text-slate-800">KEY INSIGHT:</strong> Series for more voltage (flashlights), parallel for longer life (power banks).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BULB POWER RENDERER ---
   const BulbPowerRenderer = () => {
      const [voltage, setVoltage] = useState(6);
      const [resistance] = useState(10);

      const current = voltage / resistance;
      const power = voltage * current;
      const brightness = Math.min(power / 10, 1);

      return (
         <div className="flex flex-col h-full bg-slate-900 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">BULB POWER</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">P = V √ó I = V¬≤/R</p>
               </div>
               <div className="text-right">
                  <p className="text-[10px] font-bold text-slate-500">Power Output</p>
                  <p className="text-2xl font-black text-yellow-400">{power.toFixed(1)} W</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 flex items-center justify-center p-8 relative">
                  <div className="relative">
                     {/* Bulb glow effect */}
                     <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-40 h-40 rounded-full blur-3xl transition-all duration-300"
                           style={{
                              backgroundColor: `rgba(253, 224, 71, ${brightness})`,
                              transform: `scale(${0.5 + brightness * 1.5})`
                           }} />
                     </div>

                     {/* Bulb SVG */}
                     <svg width="200" height="280" viewBox="0 0 200 280" className="relative z-10">
                        {/* Glass bulb */}
                        <ellipse cx="100" cy="100" rx="70" ry="80" fill={`rgba(253, 224, 71, ${brightness * 0.8})`}
                           stroke="#fbbf24" strokeWidth="3" />
                        {/* Filament */}
                        <path d="M 70,100 Q 80,80 90,100 Q 100,120 110,100 Q 120,80 130,100"
                           fill="none" stroke={brightness > 0.3 ? '#ffffff' : '#666666'}
                           strokeWidth="3" strokeLinecap="round"
                           style={{ filter: brightness > 0.5 ? 'drop-shadow(0 0 8px #fff)' : 'none' }} />
                        {/* Base */}
                        <rect x="70" y="170" width="60" height="30" fill="#64748b" rx="4" />
                        <rect x="75" y="200" width="50" height="10" fill="#475569" />
                        <rect x="80" y="210" width="40" height="10" fill="#334155" />
                        {/* Contact */}
                        <circle cx="100" cy="230" r="10" fill="#1e293b" stroke="#475569" strokeWidth="2" />
                     </svg>
                  </div>

                  {/* Circuit visualization */}
                  <div className="absolute bottom-8 left-8 right-8">
                     <svg width="100%" height="60" viewBox="0 0 400 60" preserveAspectRatio="xMidYMid meet">
                        <line x1="20" y1="30" x2="120" y2="30" stroke="#ef4444" strokeWidth="3" />
                        <rect x="120" y="15" width="60" height="30" fill="none" stroke="#fbbf24" strokeWidth="2" rx="4" />
                        <text x="150" y="35" textAnchor="middle" className="text-[10px] font-bold fill-yellow-400">BULB</text>
                        <line x1="180" y1="30" x2="280" y2="30" stroke="#3b82f6" strokeWidth="3" />
                        <rect x="280" y="20" width="40" height="20" fill="#1e293b" stroke="#64748b" strokeWidth="2" />
                        <text x="300" y="35" textAnchor="middle" className="text-[8px] font-bold fill-slate-400">{resistance}Œ©</text>
                        <line x1="320" y1="30" x2="380" y2="30" stroke="#3b82f6" strokeWidth="3" />
                     </svg>
                  </div>
               </div>

               <div className="w-full md:w-80 bg-slate-800/50 border-l border-slate-700 p-6 flex flex-col gap-6">
                  <div>
                     <div className="flex justify-between mb-2">
                        <label className="text-xs font-bold text-slate-400">Voltage (V)</label>
                        <span className="text-sm font-mono font-bold text-yellow-400">{voltage} V</span>
                     </div>
                     <input type="range" min="0" max="12" step="0.5" value={voltage}
                        onChange={(e) => setVoltage(Number(e.target.value))}
                        className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-yellow-500" />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                     <div className="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Current (I)</p>
                        <p className="text-lg font-black text-blue-400">{current.toFixed(2)} A</p>
                     </div>
                     <div className="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Resistance (R)</p>
                        <p className="text-lg font-black text-slate-400">{resistance} Œ©</p>
                     </div>
                  </div>

                  <div className="p-4 bg-yellow-500/10 rounded-xl border border-yellow-500/20">
                     <p className="text-[10px] font-black text-yellow-500 uppercase mb-2">Power Calculation</p>
                     <div className="space-y-1 font-mono text-sm text-slate-300">
                        <p>P = V √ó I = {voltage} √ó {current.toFixed(2)}</p>
                        <p>P = V¬≤/R = {voltage}¬≤/{resistance}</p>
                        <p className="text-yellow-400 font-bold">P = {power.toFixed(2)} W</p>
                     </div>
                  </div>

                  <div className="mt-auto p-4 bg-slate-900 rounded-xl border border-slate-700">
                     <p className="text-xs text-slate-400">
                        <strong className="text-yellow-400">KEY INSIGHT:</strong> Power increases with the SQUARE of voltage. Doubling voltage quadruples brightness!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- COUNTING TO 100 RENDERER ---
   const Counting100Renderer = () => {
      const [count, setCount] = useState(1);
      const [character, setCharacter] = useState('üêª'); // Bear, Rabbit, Fox
      const [isJumping, setIsJumping] = useState(false);

      const getStoneColor = (num: number) => {
         if (num <= 10) return 'bg-emerald-500';
         if (num <= 20) return 'bg-yellow-400';
         if (num <= 30) return 'bg-orange-500';
         if (num <= 40) return 'bg-red-500';
         if (num <= 50) return 'bg-purple-500';
         if (num <= 60) return 'bg-blue-600';
         if (num <= 70) return 'bg-slate-400';
         if (num <= 80) return 'bg-amber-400';
         if (num <= 90) return 'bg-pink-400';
         return 'bg-slate-100';
      };

      const handleNext = () => {
         if (count < 100) {
            setIsJumping(true);
            setCount(prev => prev + 1);
            setTimeout(() => setIsJumping(false), 300);
         }
      };

      return (
         <div className="flex flex-col h-full bg-sky-400 text-slate-900 font-sans overflow-hidden relative">
            {/* Sky Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-300 to-sky-500 pointer-events-none" />

            {/* Clouds */}
            <div className="absolute top-10 left-10 animate-pulse opacity-50">‚òÅÔ∏è</div>
            <div className="absolute top-20 right-20 animate-bounce opacity-50">‚òÅÔ∏è</div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center bg-white/20 backdrop-blur-sm border-b border-white/30">
               <div>
                  <h3 className="text-2xl font-black tracking-tight text-white drop-shadow-md">MOUNTAIN CLIMB</h3>
                  <p className="text-[10px] font-bold text-sky-900 uppercase tracking-widest">Counting to 100</p>
               </div>
               <div className="flex gap-2">
                  {['üêª', 'üê∞', 'ü¶ä'].map(c => (
                     <button
                        key={c}
                        onClick={() => setCharacter(c)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center text-xl transition-all ${character === c ? 'bg-white shadow-lg scale-110' : 'bg-white/50 hover:bg-white/80'}`}
                     >
                        {c}
                     </button>
                  ))}
               </div>
            </div>

            {/* Mountain View */}
            <div className="flex-1 relative overflow-hidden flex items-center justify-center p-8">
               {/* The Mountain Path (Simplified) */}
               <div className="relative w-full max-w-md h-full flex flex-col-reverse items-center">
                  {/* Stepping Stones (Visible Window) */}
                  <div className="w-full h-full relative flex flex-col items-center justify-center">
                     {/* Current Stone */}
                     <div className="relative">
                        <div className={`w-32 h-16 rounded-[2rem] shadow-2xl flex items-center justify-center border-4 border-white/50 transition-colors duration-500 ${getStoneColor(count)}`}>
                           <span className="text-4xl font-black text-white drop-shadow-md">{count}</span>
                        </div>

                        {/* Character */}
                        <div
                           className={`absolute -top-16 left-1/2 -translate-x-1/2 text-6xl transition-all duration-300 ${isJumping ? '-translate-y-12 scale-110' : 'translate-y-0 scale-100'}`}
                        >
                           {character}
                        </div>
                     </div>

                     {/* Next Stone Preview */}
                     {count < 100 && (
                        <div className={`w-24 h-12 rounded-[1.5rem] opacity-40 mt-12 flex items-center justify-center border-2 border-white/30 ${getStoneColor(count + 1)}`}>
                           <span className="text-xl font-bold text-white">{count + 1}</span>
                        </div>
                     )}

                     {/* Previous Stone Preview */}
                     {count > 1 && (
                        <div className={`w-24 h-12 rounded-[1.5rem] opacity-40 mb-12 absolute bottom-0 flex items-center justify-center border-2 border-white/30 ${getStoneColor(count - 1)}`}>
                           <span className="text-xl font-bold text-white">{count - 1}</span>
                        </div>
                     )}
                  </div>
               </div>

               {/* Progress Bar (Vertical) */}
               <div className="absolute right-8 top-1/2 -translate-y-1/2 w-4 h-64 bg-white/20 rounded-full overflow-hidden border border-white/30 shadow-inner">
                  <div
                     className="absolute bottom-0 left-0 w-full bg-white transition-all duration-500 shadow-[0_0_10px_rgba(255,255,255,0.8)]"
                     style={{ height: `${count}%` }}
                  />
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/10 backdrop-blur-md border-t border-white/30 flex flex-col items-center gap-6">
               <div className="flex items-center gap-8 w-full max-w-xl">
                  <button
                     onClick={() => setCount(Math.max(1, count - 1))}
                     className="w-16 h-16 rounded-2xl bg-white/20 hover:bg-white/40 flex items-center justify-center text-2xl text-white transition-all active:scale-95 border border-white/30"
                  >
                     ‚¨ÖÔ∏è
                  </button>

                  <button
                     onClick={handleNext}
                     className="flex-1 h-20 rounded-3xl bg-white text-sky-600 font-black text-2xl shadow-xl shadow-sky-900/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-4"
                  >
                     TAP TO CLIMB! üèîÔ∏è
                  </button>

                  <button
                     onClick={() => setCount(Math.min(100, count + 1))}
                     className="w-16 h-16 rounded-2xl bg-white/20 hover:bg-white/40 flex items-center justify-center text-2xl text-white transition-all active:scale-95 border border-white/30"
                  >
                     ‚û°Ô∏è
                  </button>
               </div>

               {/* Slider */}
               <div className="w-full max-w-xl space-y-2">
                  <input
                     type="range"
                     min="1"
                     max="100"
                     value={count}
                     onChange={(e) => setCount(parseInt(e.target.value))}
                     className="w-full h-3 bg-white/20 rounded-full appearance-none cursor-pointer accent-white"
                  />
                  <div className="flex justify-between text-[10px] font-black text-white/70 uppercase tracking-widest">
                     <span>Base (1)</span>
                     <span>Summit (100)</span>
                  </div>
               </div>
            </div>

            {/* Celebration Overlay */}
            {count % 10 === 0 && !isJumping && (
               <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-50 animate-bounce">
                  <div className="bg-white/90 backdrop-blur-md p-8 rounded-[3rem] shadow-2xl border-4 border-yellow-400 text-center">
                     <p className="text-4xl font-black text-yellow-600">WAY TO GO!</p>
                     <p className="text-xl font-bold text-sky-600">You reached {count}!</p>
                     <div className="text-4xl mt-4">‚ú®üéâüéä</div>
                  </div>
               </div>
            )}
         </div>
      );
   };


   // --- ONE-TO-ONE CORRESPONDENCE RENDERER ---
   const OneToOneCorrespondenceRenderer = () => {
      const [guests, setGuests] = useState([
         { id: 1, name: 'Rabbit', icon: 'üê∞', items: { plate: false, cup: false } },
         { id: 2, name: 'Bear', icon: 'üêª', items: { plate: false, cup: false } },
         { id: 3, name: 'Fox', icon: 'ü¶ä', items: { plate: false, cup: false } },
      ]);
      const [draggedItem, setDraggedItem] = useState<string | null>(null);

      const handleDrop = (guestId: number, itemType: 'plate' | 'cup') => {
         setGuests(prev => prev.map(g =>
            g.id === guestId ? { ...g, items: { ...g.items, [itemType]: true } } : g
         ));
         setDraggedItem(null);
      };

      const allServed = guests.every(g => g.items.plate && g.items.cup);

      return (
         <div className="flex flex-col h-full bg-pink-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-pink-100 bg-white flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-pink-500">BIRTHDAY PARTY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">One-to-One Correspondence</p>
               </div>
               {allServed && (
                  <div className="bg-green-500 text-white px-4 py-1 rounded-full text-xs font-black animate-bounce">
                     PARTY READY! üéâ
                  </div>
               )}
            </div>

            <div className="flex-1 p-8 flex flex-col items-center justify-center gap-12">
               {/* Party Table */}
               <div className="flex gap-8">
                  {guests.map(guest => (
                     <div key={guest.id} className="flex flex-col items-center gap-4">
                        <div className="text-6xl mb-2">{guest.icon}</div>
                        <div className="flex gap-4">
                           {/* Plate Slot */}
                           <div
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop(guest.id, 'plate')}
                              className={`w-16 h-16 rounded-full border-4 border-dashed flex items-center justify-center transition-all ${guest.items.plate ? 'border-pink-500 bg-white scale-110' : 'border-slate-200 bg-slate-50'}`}
                           >
                              {guest.items.plate ? <span className="text-3xl">üçΩÔ∏è</span> : <span className="text-xs text-slate-300 font-bold">PLATE</span>}
                           </div>
                           {/* Cup Slot */}
                           <div
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop(guest.id, 'cup')}
                              className={`w-12 h-12 rounded-lg border-4 border-dashed flex items-center justify-center transition-all ${guest.items.cup ? 'border-blue-400 bg-white scale-110' : 'border-slate-200 bg-slate-50'}`}
                           >
                              {guest.items.cup ? <span className="text-2xl">ü•§</span> : <span className="text-[8px] text-slate-300 font-bold">CUP</span>}
                           </div>
                        </div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{guest.name}</p>
                     </div>
                  ))}
               </div>

               {/* Supply Area */}
               <div className="p-6 bg-white rounded-[2rem] shadow-xl border-2 border-pink-100 flex gap-8 items-center">
                  <div className="text-center">
                     <div
                        draggable
                        onDragStart={() => setDraggedItem('plate')}
                        className="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center text-4xl cursor-grab active:cursor-grabbing hover:scale-110 transition-transform shadow-md"
                     >
                        üçΩÔ∏è
                     </div>
                     <p className="text-[8px] font-black text-pink-400 mt-2 uppercase tracking-widest">Plates</p>
                  </div>
                  <div className="text-center">
                     <div
                        draggable
                        onDragStart={() => setDraggedItem('cup')}
                        className="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center text-3xl cursor-grab active:cursor-grabbing hover:scale-110 transition-transform shadow-md"
                     >
                        ü•§
                     </div>
                     <p className="text-[8px] font-black text-blue-400 mt-2 uppercase tracking-widest">Cups</p>
                  </div>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-white border-t border-pink-100">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-pink-500/10 flex items-center justify-center border border-pink-500/20 shrink-0">
                     <span className="text-2xl">üç∞</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>One-to-One Correspondence</strong> means matching one object from one group to exactly one object in another group. Each guest gets exactly one plate and one cup!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SUBITIZING RENDERER ---
   const SubitizingRenderer = () => {
      const [fireflies, setFireflies] = useState<{ x: number, y: number }[]>([]);
      const [isVisible, setIsVisible] = useState(false);
      const [score, setScore] = useState(0);
      const [gameState, setGameState] = useState<'idle' | 'flashing' | 'guessing' | 'result'>('idle');
      const [correctCount, setCorrectCount] = useState(0);
      const [lastGuess, setLastGuess] = useState<number | null>(null);

      const startFlash = () => {
         const count = Math.floor(Math.random() * 6) + 1; // 1-6 for subitizing
         const newFireflies = Array.from({ length: count }, () => ({
            x: 20 + Math.random() * 60,
            y: 20 + Math.random() * 60
         }));
         setFireflies(newFireflies);
         setCorrectCount(count);
         setGameState('flashing');
         setIsVisible(true);

         setTimeout(() => {
            setIsVisible(false);
            setGameState('guessing');
         }, 1000); // 1 second flash
      };

      const handleGuess = (num: number) => {
         setLastGuess(num);
         setGameState('result');
         if (num === correctCount) {
            setScore(prev => prev + 1);
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden relative">
            {/* Night Sky Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#1e1b4b_0%,#020617_100%)]" />

            {/* Stars */}
            <div className="absolute inset-0 opacity-30 pointer-events-none">
               {Array.from({ length: 50 }).map((_, i) => (
                  <div
                     key={i}
                     className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
                     style={{ top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 3}s` }}
                  />
               ))}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/10 bg-black/20 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">FIREFLY CATCH</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Subitizing Practice</p>
               </div>
               <div className="bg-yellow-400/20 px-4 py-1 rounded-full border border-yellow-400/30">
                  <span className="text-xs font-black text-yellow-400">SCORE: {score}</span>
               </div>
            </div>

            {/* Garden View */}
            <div className="flex-1 relative flex items-center justify-center">
               {gameState === 'idle' && (
                  <button
                     onClick={startFlash}
                     className="px-8 py-4 bg-yellow-400 text-slate-950 font-black rounded-2xl shadow-xl shadow-yellow-400/20 hover:scale-105 active:scale-95 transition-all"
                  >
                     READY? FLASH! ‚ú®
                  </button>
               )}

               {isVisible && (
                  <div className="absolute inset-0">
                     {fireflies.map((f, i) => (
                        <div
                           key={i}
                           className="absolute w-6 h-6 bg-yellow-300 rounded-full blur-[2px] shadow-[0_0_20px_#fde047]"
                           style={{ top: `${f.y}%`, left: `${f.x}%` }}
                        >
                           <div className="absolute inset-0 bg-yellow-100 rounded-full animate-ping opacity-50" />
                        </div>
                     ))}
                  </div>
               )}

               {gameState === 'guessing' && (
                  <div className="flex flex-col items-center gap-8">
                     <p className="text-2xl font-black text-white drop-shadow-lg">How many did you see?</p>
                     <div className="grid grid-cols-3 gap-4">
                        {[1, 2, 3, 4, 5, 6].map(num => (
                           <button
                              key={num}
                              onClick={() => handleGuess(num)}
                              className="w-20 h-20 bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl flex items-center justify-center text-3xl font-black transition-all hover:scale-110 active:scale-90"
                           >
                              {num}
                           </button>
                        ))}
                     </div>
                  </div>
               )}

               {gameState === 'result' && (
                  <div className="flex flex-col items-center gap-6 animate-in fade-in zoom-in duration-300">
                     <div className={`text-6xl font-black ${lastGuess === correctCount ? 'text-green-400' : 'text-red-400'}`}>
                        {lastGuess === correctCount ? 'CORRECT! ‚ú®' : 'OOPS! üåô'}
                     </div>
                     <p className="text-xl text-slate-300">There were <span className="text-white font-black">{correctCount}</span> fireflies.</p>
                     <button
                        onClick={startFlash}
                        className="mt-4 px-8 py-3 bg-white text-slate-950 font-black rounded-xl hover:bg-slate-200 transition-colors"
                     >
                        PLAY AGAIN
                     </button>
                  </div>
               )}
            </div>

            {/* Footer Insight */}
            <div className="relative z-10 p-6 bg-black/40 backdrop-blur-md border-t border-white/10">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-400/10 flex items-center justify-center border border-yellow-400/20 shrink-0">
                     <span className="text-2xl">üí°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Subitizing</strong> is the ability to instantly recognize the number of objects in a small group without counting them one by one. It's like "seeing" the number!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- PLACE VALUE TENS AND ONES RENDERER ---
   const PlaceValueTensOnesRenderer = () => {
      const [ones, setOnes] = useState(0);
      const [tens, setTens] = useState(0);
      const [isBundling, setIsBundling] = useState(false);

      const addCandy = () => {
         if (ones < 9) {
            setOnes(prev => prev + 1);
         } else {
            // Auto-bundle or prompt to bundle
            setIsBundling(true);
            setTimeout(() => {
               setOnes(0);
               setTens(prev => prev + 1);
               setIsBundling(false);
            }, 800);
         }
      };

      const reset = () => {
         setOnes(0);
         setTens(0);
      };

      return (
         <div className="flex flex-col h-full bg-slate-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-600">CANDY FACTORY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Place Value: Tens & Ones</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <div className="text-2xl font-black text-indigo-600">{tens}</div>
                     <div className="text-[8px] font-bold text-slate-400 uppercase">Tens</div>
                  </div>
                  <div className="text-center">
                     <div className="text-2xl font-black text-orange-500">{ones}</div>
                     <div className="text-[8px] font-bold text-slate-400 uppercase">Ones</div>
                  </div>
               </div>
            </div>

            <div className="flex-1 p-8 flex gap-8 items-center justify-center">
               {/* Tens Station */}
               <div className="flex-1 h-full bg-indigo-50/50 rounded-[3rem] border-4 border-dashed border-indigo-100 p-8 flex flex-wrap content-start gap-4 relative overflow-hidden">
                  <div className="absolute top-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Tens Station (Boxes)</div>
                  {Array.from({ length: tens }).map((_, i) => (
                     <div key={i} className="w-16 h-24 bg-indigo-500 rounded-xl shadow-lg flex flex-col items-center justify-center gap-1 border-2 border-indigo-400 animate-in zoom-in duration-300">
                        <div className="grid grid-cols-2 gap-1">
                           {Array.from({ length: 10 }).map((_, j) => (
                              <div key={j} className="w-2 h-2 bg-indigo-200 rounded-full" />
                           ))}
                        </div>
                        <span className="text-[8px] font-black text-white">BOX OF 10</span>
                     </div>
                  ))}
                  {isBundling && (
                     <div className="w-16 h-24 bg-indigo-400 rounded-xl animate-bounce flex items-center justify-center border-2 border-indigo-300">
                        <span className="text-2xl">üì¶</span>
                     </div>
                  )}
               </div>

               {/* Ones Bin */}
               <div className="flex-1 h-full bg-orange-50/50 rounded-[3rem] border-4 border-dashed border-orange-100 p-8 flex flex-wrap content-start gap-4 relative">
                  <div className="absolute top-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-orange-300 uppercase tracking-widest">Ones Bin (Candies)</div>
                  {Array.from({ length: ones }).map((_, i) => (
                     <div key={i} className="w-10 h-10 bg-orange-500 rounded-full shadow-md flex items-center justify-center border-2 border-orange-400 animate-in slide-in-from-top duration-300">
                        <span className="text-lg">üç¨</span>
                     </div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="p-8 bg-white border-t border-slate-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={addCandy}
                     disabled={isBundling}
                     className="flex-1 h-16 bg-indigo-600 text-white font-black rounded-2xl shadow-lg shadow-indigo-200 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                  >
                     <span className="text-2xl">üç¨</span>
                     ADD CANDY
                  </button>
                  <button
                     onClick={reset}
                     className="w-16 h-16 bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <div className="text-center">
                  <p className="text-4xl font-black text-slate-800 tracking-tighter">
                     <span className="text-indigo-600">{tens}</span>
                     <span className="text-orange-500">{ones}</span>
                  </p>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                     {tens} Tens + {ones} Ones = {tens * 10 + ones}
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ADDITION AS PUTTING TOGETHER RENDERER ---
   const AdditionPuttingTogetherRenderer = () => {
      const [group1, setGroup1] = useState(3);
      const [group2, setGroup2] = useState(2);
      const [isMerging, setIsMerging] = useState(false);
      const [showResult, setShowResult] = useState(false);

      const handleMerge = () => {
         setIsMerging(true);
         setTimeout(() => {
            setIsMerging(false);
            setShowResult(true);
         }, 1000);
      };

      const reset = () => {
         setShowResult(false);
         setIsMerging(false);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Water Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#ecfdf5_0%,#d1fae5_100%)]" />

            {/* Ripples */}
            <div className="absolute inset-0 opacity-20 pointer-events-none">
               <div className="absolute top-1/4 left-1/4 w-64 h-64 border-4 border-emerald-200 rounded-full animate-ping" />
               <div className="absolute bottom-1/4 right-1/4 w-48 h-48 border-4 border-emerald-200 rounded-full animate-ping [animation-delay:1s]" />
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-600">GARDEN POND</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Addition: Putting Together</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center px-4 py-1 bg-white rounded-full border border-emerald-100 shadow-sm">
                     <span className="text-lg font-black text-emerald-600">{group1} + {group2} = {showResult ? group1 + group2 : '?'}</span>
                  </div>
               </div>
            </div>

            {/* Pond View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               {!showResult ? (
                  <div className="w-full flex justify-between items-center gap-12">
                     {/* Group 1 */}
                     <div className="flex-1 flex flex-wrap justify-center gap-4 p-8 bg-white/30 rounded-[3rem] border-2 border-dashed border-emerald-200 relative">
                        <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Group A</div>
                        {Array.from({ length: group1 }).map((_, i) => (
                           <div key={i} className="w-16 h-16 bg-emerald-400 rounded-full shadow-lg flex items-center justify-center text-3xl animate-bounce" style={{ animationDelay: `${i * 0.1}s` }}>
                              üçÄ
                           </div>
                        ))}
                        <div className="absolute -bottom-12 flex gap-2">
                           <button onClick={() => setGroup1(Math.max(1, group1 - 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">-</button>
                           <button onClick={() => setGroup1(Math.min(10, group1 + 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">+</button>
                        </div>
                     </div>

                     {/* Merge Button */}
                     <button
                        onClick={handleMerge}
                        className={`w-24 h-24 rounded-full bg-emerald-600 text-white flex items-center justify-center text-4xl shadow-xl shadow-emerald-900/20 hover:scale-110 active:scale-90 transition-all z-20 ${isMerging ? 'animate-ping' : ''}`}
                     >
                        ‚ûï
                     </button>

                     {/* Group 2 */}
                     <div className="flex-1 flex flex-wrap justify-center gap-4 p-8 bg-white/30 rounded-[3rem] border-2 border-dashed border-emerald-200 relative">
                        <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Group B</div>
                        {Array.from({ length: group2 }).map((_, i) => (
                           <div key={i} className="w-16 h-16 bg-emerald-400 rounded-full shadow-lg flex items-center justify-center text-3xl animate-bounce" style={{ animationDelay: `${i * 0.1}s` }}>
                              üçÄ
                           </div>
                        ))}
                        <div className="absolute -bottom-12 flex gap-2">
                           <button onClick={() => setGroup2(Math.max(1, group2 - 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">-</button>
                           <button onClick={() => setGroup2(Math.min(10, group2 + 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">+</button>
                        </div>
                     </div>
                  </div>
               ) : (
                  <div className="w-full max-w-2xl p-12 bg-white/40 backdrop-blur-md rounded-[4rem] border-4 border-emerald-400 flex flex-wrap justify-center gap-6 animate-in zoom-in duration-500">
                     <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-8 py-2 rounded-full text-xl font-black uppercase shadow-lg">PUT TOGETHER!</div>
                     {Array.from({ length: group1 + group2 }).map((_, i) => (
                        <div key={i} className="w-20 h-20 bg-emerald-500 rounded-full shadow-xl flex items-center justify-center text-4xl animate-bounce" style={{ animationDelay: `${i * 0.05}s` }}>
                           üçÄ
                        </div>
                     ))}
                  </div>
               )}
            </div>

            {/* Footer Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-emerald-100 flex flex-col items-center gap-4">
               {showResult && (
                  <button
                     onClick={reset}
                     className="px-8 py-3 bg-emerald-600 text-white font-black rounded-xl shadow-lg hover:bg-emerald-700 transition-colors"
                  >
                     TRY ANOTHER PROBLEM
                  </button>
               )}
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üê∏</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>Addition</strong> is the process of putting two or more groups together to find the total. When we combine {group1} and {group2}, we get {group1 + group2}!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SUBTRACTION AS TAKING APART RENDERER ---
   const SubtractionTakingApartRenderer = () => {
      const [apples, setApples] = useState([
         { id: 1, picked: false }, { id: 2, picked: false }, { id: 3, picked: false },
         { id: 4, picked: false }, { id: 5, picked: false }, { id: 6, picked: false },
         { id: 7, picked: false }, { id: 8, picked: false }
      ]);
      const [isPicking, setIsPicking] = useState(false);

      const total = apples.length;
      const pickedCount = apples.filter(a => a.picked).length;
      const remainingCount = total - pickedCount;

      const handlePick = (id: number) => {
         setApples(prev => prev.map(a => a.id === id ? { ...a, picked: !a.picked } : a));
      };

      const reset = () => {
         setApples(apples.map(a => ({ ...a, picked: false })));
      };

      return (
         <div className="flex flex-col h-full bg-sky-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-200 to-emerald-50 pointer-events-none" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-sky-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-500">APPLE ORCHARD</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Subtraction: Taking Apart</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center px-4 py-1 bg-white rounded-full border border-red-100 shadow-sm">
                     <span className="text-lg font-black text-red-500">{total} - {pickedCount} = {remainingCount}</span>
                  </div>
               </div>
            </div>

            {/* Orchard View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               {/* The Tree */}
               <div className="relative w-96 h-96">
                  {/* Trunk */}
                  <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-48 bg-amber-900 rounded-t-xl" />
                  {/* Leaves */}
                  <div className="absolute top-0 left-1/2 -translate-x-1/2 w-80 h-80 bg-emerald-500 rounded-full shadow-2xl border-8 border-emerald-400" />

                  {/* Apples on Tree */}
                  <div className="absolute inset-0 flex items-center justify-center p-12">
                     <div className="grid grid-cols-3 gap-8">
                        {apples.map(apple => (
                           <button
                              key={apple.id}
                              onClick={() => handlePick(apple.id)}
                              className={`w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-3xl transition-all duration-500 hover:scale-110 active:scale-90 ${apple.picked ? 'opacity-0 pointer-events-none translate-y-32' : 'opacity-100'}`}
                           >
                              üçé
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               {/* Basket */}
               <div className="absolute bottom-12 right-12 w-48 h-32 bg-amber-700 rounded-b-[3rem] border-t-8 border-amber-800 shadow-xl flex flex-wrap justify-center content-start p-4 gap-2">
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-800 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Basket</div>
                  {apples.filter(a => a.picked).map(a => (
                     <div key={a.id} className="text-2xl animate-in slide-in-from-top-12 duration-500">üçé</div>
                  ))}
               </div>
            </div>

            {/* Footer Insight */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-sky-100 flex flex-col items-center gap-4">
               <div className="flex gap-4">
                  <button onClick={reset} className="px-6 py-2 bg-red-500 text-white font-black rounded-xl shadow-lg hover:bg-red-600 transition-colors">RESET TREE</button>
               </div>
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üß∫</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>Subtraction</strong> can be thought of as "taking apart" a group. We started with {total} apples, took away {pickedCount}, and now {remainingCount} are left on the tree!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- FACT FAMILIES RENDERER ---
   const FactFamiliesRenderer = () => {
      const [family, setFamily] = useState({ a: 3, b: 5, c: 8 });
      const [equations, setEquations] = useState([
         { id: 1, type: 'add', parts: [null, '+', null, '=', null], correct: [3, 5, 8] },
         { id: 2, type: 'add', parts: [null, '+', null, '=', null], correct: [5, 3, 8] },
         { id: 3, type: 'sub', parts: [null, '-', null, '=', null], correct: [8, 3, 5] },
         { id: 4, type: 'sub', parts: [null, '-', null, '=', null], correct: [8, 5, 3] },
      ]);
      const [selectedSlot, setSelectedSlot] = useState<{ eqId: number, slotIdx: number } | null>(null);

      const handleNumberClick = (num: number) => {
         if (selectedSlot) {
            setEquations(prev => prev.map(eq => {
               if (eq.id === selectedSlot.eqId) {
                  const newParts = [...eq.parts];
                  newParts[selectedSlot.slotIdx] = num;
                  return { ...eq, parts: newParts };
               }
               return eq;
            }));
            setSelectedSlot(null);
         }
      };

      const isCorrect = (eq: any) => {
         const values = eq.parts.filter((p: any) => typeof p === 'number');
         if (values.length < 3) return false;
         if (eq.type === 'add') return values[0] + values[1] === values[2];
         return values[0] - values[1] === values[2];
      };

      return (
         <div className="flex flex-col h-full bg-amber-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 bg-white border-b border-amber-100 flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-600">NUMBER HOUSE</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Fact Families (Addition & Subtraction)</p>
               </div>
               <div className="flex gap-2 bg-amber-100 px-4 py-2 rounded-2xl border border-amber-200">
                  {[family.a, family.b, family.c].map((n, i) => (
                     <div key={i} className="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-xl font-black text-amber-600 shadow-sm">{n}</div>
                  ))}
               </div>
            </div>

            <div className="flex-1 p-8 flex flex-col items-center justify-center gap-8">
               {/* House Visualization */}
               <div className="relative w-full max-w-2xl bg-white rounded-[3rem] shadow-2xl border-4 border-amber-100 p-12 flex flex-col gap-6">
                  <div className="absolute -top-12 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[150px] border-l-transparent border-r-[150px] border-r-transparent border-b-[100px] border-b-amber-500" />

                  {equations.map(eq => (
                     <div key={eq.id} className="flex items-center justify-center gap-4 p-4 bg-slate-50 rounded-2xl border-2 border-slate-100 transition-all">
                        {eq.parts.map((part, idx) => (
                           typeof part === 'string' ? (
                              <span key={idx} className="text-2xl font-black text-slate-400">{part}</span>
                           ) : (
                              <button
                                 key={idx}
                                 onClick={() => setSelectedSlot({ eqId: eq.id, slotIdx: idx })}
                                 className={`w-16 h-16 rounded-xl border-4 flex items-center justify-center text-2xl font-black transition-all ${selectedSlot?.eqId === eq.id && selectedSlot?.slotIdx === idx ? 'border-amber-500 bg-amber-50 scale-110' : part !== null ? (isCorrect(eq) ? 'border-green-400 bg-green-50 text-green-600' : 'border-slate-200 bg-white') : 'border-dashed border-slate-200 bg-slate-100'}`}
                              >
                                 {part}
                              </button>
                           )
                        ))}
                        {isCorrect(eq) && <span className="text-2xl animate-bounce">‚úÖ</span>}
                     </div>
                  ))}
               </div>

               {/* Number Palette */}
               <div className="flex gap-6 p-6 bg-white rounded-[2rem] shadow-xl border-2 border-amber-100">
                  {[family.a, family.b, family.c].map(num => (
                     <button
                        key={num}
                        onClick={() => handleNumberClick(num)}
                        className="w-20 h-20 bg-amber-500 text-white rounded-2xl flex items-center justify-center text-4xl font-black shadow-lg hover:scale-110 active:scale-90 transition-all"
                     >
                        {num}
                     </button>
                  ))}
                  <button
                     onClick={() => setEquations(equations.map(eq => ({ ...eq, parts: eq.parts.map(p => typeof p === 'string' ? p : null) })))}
                     className="w-20 h-20 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center text-2xl hover:bg-slate-200 transition-colors"
                  >
                     üîÑ
                  </button>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-white border-t border-amber-100">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-amber-500/10 flex items-center justify-center border border-amber-500/20 shrink-0">
                     <span className="text-2xl">üè†</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     A <strong>Fact Family</strong> is a group of math facts that use the same three numbers. They show how addition and subtraction are related!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- POSITIVE AND NEGATIVE NUMBERS INTRO RENDERER ---
   const PositiveNegativeIntroRenderer = () => {
      const [floor, setFloor] = useState(0);
      const [isMoving, setIsMoving] = useState(false);

      const handleGoTo = (target: number) => {
         setIsMoving(true);
         setFloor(target);
         setTimeout(() => setIsMoving(false), 800);
      };

      return (
         <div className="flex flex-col h-full bg-slate-900 text-white font-sans overflow-hidden relative">
            {/* Background Layers */}
            <div className="absolute inset-0 flex flex-col">
               <div className="flex-1 bg-sky-400" /> {/* Sky */}
               <div className="h-1 bg-emerald-600" /> {/* Ground Line */}
               <div className="flex-1 bg-slate-800" /> {/* Underground */}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/10">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">MAGIC ELEVATOR</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Intro to Positive & Negative Numbers</p>
               </div>
               <div className="bg-white/10 px-4 py-1 rounded-full border border-white/20">
                  <span className={`text-lg font-black ${floor > 0 ? 'text-sky-300' : floor < 0 ? 'text-orange-400' : 'text-white'}`}>
                     FLOOR: {floor > 0 ? `+${floor}` : floor}
                  </span>
               </div>
            </div>

            {/* Elevator Shaft View */}
            <div className="flex-1 relative flex items-center justify-center">
               {/* Shaft */}
               <div className="w-32 h-full bg-black/20 border-x-4 border-white/10 relative">
                  {/* Floor Markers */}
                  {[-3, -2, -1, 0, 1, 2, 3].map(f => (
                     <div
                        key={f}
                        className="absolute w-full h-px bg-white/10 flex items-center justify-end pr-2"
                        style={{ bottom: `${(f + 3) * 16.6}%` }}
                     >
                        <span className="text-[8px] font-bold text-white/30">{f > 0 ? `+${f}` : f}</span>
                     </div>
                  ))}

                  {/* Elevator Car */}
                  <div
                     className={`absolute left-2 right-2 h-20 bg-yellow-400 rounded-lg shadow-[0_0_30px_rgba(250,204,21,0.4)] flex flex-col items-center justify-center border-2 border-yellow-200 transition-all duration-700 ease-in-out z-20`}
                     style={{ bottom: `calc(${(floor + 3) * 16.6}% - 40px)` }}
                  >
                     <div className="text-2xl">üö†</div>
                     <span className="text-xs font-black text-slate-900">{floor > 0 ? `+${floor}` : floor}</span>
                     {isMoving && <div className="absolute -bottom-8 text-xl animate-bounce">‚ú®</div>}
                  </div>
               </div>

               {/* Environment Decorations */}
               <div className="absolute top-1/4 left-1/4 text-4xl opacity-50">‚òÅÔ∏è</div>
               <div className="absolute bottom-1/4 right-1/4 text-4xl opacity-20">ü™±</div>
               <div className="absolute bottom-1/3 left-1/3 text-4xl opacity-20">üíé</div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-black/60 backdrop-blur-xl border-t border-white/10 flex flex-col items-center gap-6">
               <div className="flex gap-4">
                  <div className="flex flex-col gap-2">
                     <p className="text-[8px] font-black text-sky-400 uppercase tracking-widest text-center">Above Ground (+)</p>
                     <div className="flex gap-2">
                        {[3, 2, 1].map(f => (
                           <button
                              key={f}
                              onClick={() => handleGoTo(f)}
                              className={`w-12 h-12 rounded-xl font-black transition-all ${floor === f ? 'bg-sky-400 text-white scale-110 shadow-lg shadow-sky-400/20' : 'bg-white/10 hover:bg-white/20 text-sky-200'}`}
                           >
                              +{f}
                           </button>
                        ))}
                     </div>
                  </div>

                  <button
                     onClick={() => handleGoTo(0)}
                     className={`w-12 h-12 mt-5 rounded-xl font-black transition-all ${floor === 0 ? 'bg-white text-slate-900 scale-110 shadow-lg' : 'bg-white/10 hover:bg-white/20 text-white'}`}
                  >
                     0
                  </button>

                  <div className="flex flex-col gap-2">
                     <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest text-center">Below Ground (-)</p>
                     <div className="flex gap-2">
                        {[-1, -2, -3].map(f => (
                           <button
                              key={f}
                              onClick={() => handleGoTo(f)}
                              className={`w-12 h-12 rounded-xl font-black transition-all ${floor === f ? 'bg-orange-500 text-white scale-110 shadow-lg shadow-orange-500/20' : 'bg-white/10 hover:bg-white/20 text-orange-200'}`}
                           >
                              {f}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-400/10 flex items-center justify-center border border-yellow-400/20 shrink-0">
                     <span className="text-2xl">‚ÜïÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Positive numbers</strong> are above zero (like floors above ground). <strong>Negative numbers</strong> are below zero (like basement floors). Zero is the starting point!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SKIP COUNTING RENDERER ---
   const SkipCountingRenderer = () => {
      const [interval, setInterval] = useState(2);
      const [current, setCurrent] = useState(0);
      const [history, setHistory] = useState<number[]>([0]);
      const [isJumping, setIsJumping] = useState(false);

      const handleJump = () => {
         if (current + interval <= 50) {
            setIsJumping(true);
            const next = current + interval;
            setCurrent(next);
            setHistory(prev => [...prev, next]);
            setTimeout(() => setIsJumping(false), 500);
         }
      };

      const reset = (newInterval?: number) => {
         if (newInterval) setInterval(newInterval);
         setCurrent(0);
         setHistory([0]);
         setIsJumping(false);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Pond Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#ecfdf5_0%,#d1fae5_100%)]" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-600">FROG JUMP</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Skip Counting (2s, 5s, 10s)</p>
               </div>
               <div className="flex gap-2">
                  {[2, 5, 10].map(i => (
                     <button
                        key={i}
                        onClick={() => reset(i)}
                        className={`px-4 py-1 rounded-full text-xs font-black transition-all ${interval === i ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-emerald-600 border border-emerald-100 hover:bg-emerald-50'}`}
                     >
                        SKIP {i}s
                     </button>
                  ))}
               </div>
            </div>

            {/* Number Line View */}
            <div className="flex-1 relative flex items-center justify-center p-12 overflow-x-auto">
               <div className="relative w-full max-w-4xl h-64 flex items-center">
                  {/* The Line */}
                  <div className="absolute w-full h-2 bg-emerald-200 rounded-full" />

                  {/* Ticks & Numbers */}
                  {Array.from({ length: 51 }).map((_, i) => (
                     (i % 5 === 0 || i === current) && (
                        <div
                           key={i}
                           className="absolute flex flex-col items-center gap-2 transition-all duration-500"
                           style={{ left: `${(i / 50) * 100}%` }}
                        >
                           <div className={`w-1 h-4 ${i % 10 === 0 ? 'bg-emerald-600 h-6' : 'bg-emerald-300'}`} />
                           <span className={`text-[10px] font-black ${history.includes(i) ? 'text-emerald-600 scale-125' : 'text-slate-300'}`}>{i}</span>
                        </div>
                     )
                  ))}

                  {/* Jump Arcs */}
                  <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible">
                     {history.slice(0, -1).map((val, idx) => {
                        const nextVal = history[idx + 1];
                        const x1 = (val / 50) * 100;
                        const x2 = (nextVal / 50) * 100;
                        const midX = (x1 + x2) / 2;
                        return (
                           <path
                              key={idx}
                              d={`M ${x1}% 50% Q ${midX}% 0% ${x2}% 50%`}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="3"
                              strokeDasharray="8 4"
                              className="animate-in fade-in duration-500"
                           />
                        );
                     })}
                  </svg>

                  {/* The Frog */}
                  <div
                     className={`absolute w-16 h-16 flex items-center justify-center text-4xl transition-all duration-500 ease-out z-20`}
                     style={{
                        left: `calc(${(current / 50) * 100}% - 32px)`,
                        bottom: isJumping ? '60%' : '40%',
                        transform: `scaleX(${isJumping ? 1.2 : 1})`
                     }}
                  >
                     üê∏
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-emerald-100 flex flex-col items-center gap-4">
               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={handleJump}
                     disabled={current + interval > 50 || isJumping}
                     className="flex-1 h-16 bg-emerald-600 text-white font-black rounded-2xl shadow-lg shadow-emerald-200 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                  >
                     JUMP {interval}! üöÄ
                  </button>
                  <button
                     onClick={() => reset()}
                     className="w-16 h-16 bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <div className="flex flex-wrap justify-center gap-2">
                  {history.map((h, i) => (
                     <span key={i} className="text-xs font-black text-emerald-600 bg-white px-2 py-1 rounded-lg border border-emerald-100 shadow-sm animate-in zoom-in">
                        {h}
                     </span>
                  ))}
               </div>
            </div>
         </div>
      );
   };


   // --- FRACTION INTRODUCTION RENDERER ---
   const FractionIntroRenderer = () => {
      const [denominator, setDenominator] = useState(4);
      const [numerator, setNumerator] = useState(1);

      const slices = Array.from({ length: denominator });

      const toggleSlice = (idx: number) => {
         // This is a simple model where we just count how many are selected
         // In a real app, we might track specific slices
         if (numerator === idx + 1) {
            setNumerator(idx);
         } else {
            setNumerator(idx + 1);
         }
      };

      return (
         <div className="flex flex-col h-full bg-orange-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-orange-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-600">PIZZA PARTY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Introduction to Fractions</p>
               </div>
               <div className="flex items-center gap-4 bg-white px-6 py-2 rounded-2xl border border-orange-100 shadow-sm">
                  <div className="flex flex-col items-center">
                     <span className="text-2xl font-black text-orange-600 leading-none">{numerator}</span>
                     <div className="w-8 h-1 bg-slate-300 my-1 rounded-full" />
                     <span className="text-2xl font-black text-slate-600 leading-none">{denominator}</span>
                  </div>
                  <div className="text-[10px] font-bold text-slate-400 uppercase leading-tight">
                     {numerator} of {denominator}<br />parts
                  </div>
               </div>
            </div>

            {/* Pizza View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               <div className="relative w-80 h-80 bg-amber-100 rounded-full shadow-2xl border-8 border-amber-200 overflow-hidden">
                  {/* Slices */}
                  <svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                     {slices.map((_, i) => {
                        const angle = (360 / denominator);
                        const startAngle = i * angle;
                        const endAngle = (i + 1) * angle;

                        // Path for a pie slice
                        const x1 = 50 + 50 * Math.cos((startAngle - 90) * Math.PI / 180);
                        const y1 = 50 + 50 * Math.sin((startAngle - 90) * Math.PI / 180);
                        const x2 = 50 + 50 * Math.cos((endAngle - 90) * Math.PI / 180);
                        const y2 = 50 + 50 * Math.sin((endAngle - 90) * Math.PI / 180);

                        const largeArcFlag = angle > 180 ? 1 : 0;
                        const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

                        return (
                           <path
                              key={i}
                              d={d}
                              onClick={() => setNumerator(i + 1)}
                              className={`cursor-pointer transition-all duration-300 ${i < numerator ? 'fill-orange-500 stroke-orange-600 stroke-2' : 'fill-amber-50/50 stroke-amber-200 stroke-1 hover:fill-amber-100'}`}
                           />
                        );
                     })}
                  </svg>

                  {/* Toppings (Visual only) */}
                  <div className="absolute inset-0 pointer-events-none opacity-40">
                     {Array.from({ length: 12 }).map((_, i) => (
                        <div
                           key={i}
                           className="absolute w-4 h-4 bg-red-600 rounded-full"
                           style={{
                              top: `${20 + Math.random() * 60}%`,
                              left: `${20 + Math.random() * 60}%`,
                              transform: `rotate(${Math.random() * 360}deg)`
                           }}
                        />
                     ))}
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-orange-100 flex flex-col items-center gap-6">
               <div className="flex flex-col items-center gap-2">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Divide into how many slices?</p>
                  <div className="flex gap-2">
                     {[2, 3, 4, 6, 8].map(d => (
                        <button
                           key={d}
                           onClick={() => { setDenominator(d); setNumerator(1); }}
                           className={`w-12 h-12 rounded-xl font-black transition-all ${denominator === d ? 'bg-orange-600 text-white scale-110 shadow-lg' : 'bg-white text-orange-600 border border-orange-100 hover:bg-orange-50'}`}
                        >
                           {d}
                        </button>
                     ))}
                  </div>
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üçï</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     A <strong>Fraction</strong> tells us how many parts of a whole we have. The <strong>bottom number (denominator)</strong> is the total number of slices. The <strong>top number (numerator)</strong> is how many slices we've picked!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTIPLICATION AS REPEATED ADDITION RENDERER ---
   const MultiplicationRepeatedAdditionRenderer = () => {
      const [groups, setGroups] = useState(3);
      const [perGroup, setPerGroup] = useState(4);
      const [showArray, setShowArray] = useState(true);

      const total = groups * perGroup;

      return (
         <div className="flex flex-col h-full bg-amber-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#fffbeb_0%,#fef3c7_100%)]" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-amber-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-700">EGG CARTON FARM</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multiplication: Repeated Addition</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-amber-600 uppercase tracking-tighter">Equation</div>
                  <div className="text-2xl font-black text-slate-800">
                     {groups} √ó {perGroup} = {total}
                  </div>
               </div>
            </div>

            {/* Farm View */}
            <div className="flex-1 relative flex items-center justify-center p-8">
               <div className="grid gap-4 transition-all duration-500" style={{ gridTemplateColumns: `repeat(${perGroup}, minmax(0, 1fr))` }}>
                  {Array.from({ length: total }).map((_, i) => (
                     <div
                        key={i}
                        className="w-12 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl border-2 border-amber-100 animate-in zoom-in duration-300"
                        style={{ animationDelay: `${i * 50}ms` }}
                     >
                        ü•ö
                     </div>
                  ))}
               </div>

               {/* Chickens (Visual Labels) */}
               <div className="absolute left-4 top-1/2 -translate-y-1/2 flex flex-col gap-4">
                  {Array.from({ length: groups }).map((_, i) => (
                     <div key={i} className="w-12 h-12 bg-white rounded-2xl shadow-md flex items-center justify-center text-2xl border border-amber-100">üêî</div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-amber-100 flex flex-col items-center gap-6">
               <div className="flex gap-12">
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">How many groups?</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5, 6].map(n => (
                           <button
                              key={n}
                              onClick={() => setGroups(n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${groups === n ? 'bg-amber-600 text-white scale-110 shadow-lg' : 'bg-white text-amber-600 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">How many per group?</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5, 6].map(n => (
                           <button
                              key={n}
                              onClick={() => setPerGroup(n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${perGroup === n ? 'bg-amber-600 text-white scale-110 shadow-lg' : 'bg-white text-amber-600 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="flex flex-col items-center gap-2">
                  <div className="text-lg font-black text-amber-700">
                     {Array.from({ length: groups }).map((_, i) => (
                        <span key={i}>
                           {perGroup}{i < groups - 1 ? ' + ' : ` = ${total}`}
                        </span>
                     ))}
                  </div>
                  <p className="text-xs text-slate-500 max-w-md text-center">
                     <strong>Multiplication</strong> is just adding the same number over and over! Here we have {groups} groups of {perGroup} eggs.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- DIVISION AS FAIR SHARING RENDERER ---
   const DivisionFairSharingRenderer = () => {
      const [totalCoins, setTotalCoins] = useState(12);
      const [pirates, setPirates] = useState(3);
      const [piles, setPiles] = useState<number[]>([]);
      const [isDealing, setIsDealing] = useState(false);

      const handleDeal = () => {
         setIsDealing(true);
         const perPirate = Math.floor(totalCoins / pirates);
         const newPiles = Array(pirates).fill(0);

         let current = 0;
         const interval = setInterval(() => {
            if (current < totalCoins - (totalCoins % pirates)) {
               newPiles[current % pirates]++;
               setPiles([...newPiles]);
               current++;
            } else {
               clearInterval(interval);
               setIsDealing(false);
            }
         }, 100);
      };

      const reset = (newTotal?: number, newPirates?: number) => {
         if (newTotal !== undefined) setTotalCoins(newTotal);
         if (newPirates !== undefined) setPirates(newPirates);
         setPiles([]);
         setIsDealing(false);
      };

      const remainder = totalCoins % pirates;
      const perPirate = Math.floor(totalCoins / pirates);

      return (
         <div className="flex flex-col h-full bg-sky-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Ocean Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-300 to-blue-400" />
            <div className="absolute bottom-0 left-0 right-0 h-32 bg-amber-100" /> {/* Sand */}

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/20 bg-white/20 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-900">TREASURE ISLAND</h3>
                  <p className="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Division: Fair Sharing</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-amber-800 uppercase tracking-tighter">Equation</div>
                  <div className="text-2xl font-black text-slate-900">
                     {totalCoins} √∑ {pirates} = {perPirate} {remainder > 0 ? `R${remainder}` : ''}
                  </div>
               </div>
            </div>

            {/* Pirate View */}
            <div className="flex-1 relative flex flex-col items-center justify-center p-8">
               {/* Main Chest */}
               <div className="mb-12 relative">
                  <div className="w-32 h-24 bg-amber-800 rounded-lg border-4 border-amber-900 shadow-2xl flex flex-wrap justify-center p-2 gap-1 overflow-hidden">
                     {Array.from({ length: totalCoins - (piles.reduce((a, b) => a + b, 0)) }).map((_, i) => (
                        <div key={i} className="w-4 h-4 bg-yellow-400 rounded-full border border-yellow-600 shadow-sm" />
                     ))}
                  </div>
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-900 text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase">Chest</div>
               </div>

               {/* Pirates and their piles */}
               <div className="flex gap-12 items-end">
                  {Array.from({ length: pirates }).map((_, i) => (
                     <div key={i} className="flex flex-col items-center gap-4">
                        <div className="relative flex flex-col-reverse items-center gap-1 min-h-[100px]">
                           {Array.from({ length: piles[i] || 0 }).map((_, j) => (
                              <div
                                 key={j}
                                 className="w-8 h-2 bg-yellow-400 rounded-full border border-yellow-600 shadow-sm animate-in slide-in-from-top-12 duration-300"
                              />
                           ))}
                        </div>
                        <div className="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-4xl border-4 border-amber-200">üè¥‚Äç‚ò†Ô∏è</div>
                        <div className="bg-amber-900 text-white px-2 py-1 rounded-lg text-xs font-black">{piles[i] || 0}</div>
                     </div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-white/20 flex flex-col items-center gap-6">
               <div className="flex gap-12">
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Coins</span>
                     <div className="flex gap-2">
                        {[10, 12, 15, 20].map(n => (
                           <button
                              key={n}
                              onClick={() => reset(n, pirates)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${totalCoins === n ? 'bg-amber-700 text-white scale-110 shadow-lg' : 'bg-white text-amber-700 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Pirate Crew</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5].map(n => (
                           <button
                              key={n}
                              onClick={() => reset(totalCoins, n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${pirates === n ? 'bg-amber-700 text-white scale-110 shadow-lg' : 'bg-white text-amber-700 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={handleDeal}
                     disabled={isDealing || piles.length > 0}
                     className="flex-1 h-14 bg-amber-700 text-white font-black rounded-2xl shadow-lg hover:bg-amber-800 transition-all disabled:opacity-50"
                  >
                     SHARE FAIRLY! üí∞
                  </button>
                  <button
                     onClick={() => reset()}
                     className="w-14 h-14 bg-white text-slate-400 rounded-2xl border border-amber-100 hover:bg-amber-50 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <p className="text-xs text-slate-500 max-w-md text-center">
                  <strong>Division</strong> is sharing a total amount into equal groups. Each pirate gets {perPirate} coins {remainder > 0 ? `and ${remainder} are left in the chest!` : 'fair and square!'}
               </p>
            </div>
         </div>
      );
   };


   // --- MULTI-DIGIT ADDITION WITH REGROUPING RENDERER ---
   const MultiDigitAdditionRegroupingRenderer = () => {
      const [num1, setNum1] = useState(47);
      const [num2, setNum2] = useState(28);
      const [step, setStep] = useState(0); // 0: initial, 1: combine ones, 2: regroup, 3: combine tens
      const [regrouped, setRegrouped] = useState(false);

      const ones1 = num1 % 10;
      const tens1 = Math.floor(num1 / 10);
      const ones2 = num2 % 10;
      const tens2 = Math.floor(num2 / 10);

      const totalOnes = ones1 + ones2;
      const needsRegroup = totalOnes >= 10;
      const resultOnes = totalOnes % 10;
      const carry = needsRegroup ? 1 : 0;
      const resultTens = tens1 + tens2 + carry;

      const reset = () => {
         setStep(0);
         setRegrouped(false);
      };

      return (
         <div className="flex flex-col h-full bg-slate-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-slate-100 opacity-50" style={{ backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' }} />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-slate-200 bg-white/80 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-600">CONSTRUCTION CRANE</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multi-Digit Addition: Regrouping</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="text-right">
                     <div className="text-2xl font-black text-slate-800 tabular-nums">
                        {num1} + {num2} = {step === 3 ? num1 + num2 : '?'}
                     </div>
                  </div>
               </div>
            </div>

            {/* Construction Site */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-16">
               {/* Place Value Columns */}
               <div className="flex gap-8">
                  {/* Tens Column */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-blue-50/50 rounded-3xl border-2 border-dashed border-blue-200 min-w-[120px]">
                     <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Tens</span>
                     <div className="flex flex-col gap-2">
                        {Array.from({ length: tens1 }).map((_, i) => (
                           <div key={`t1-${i}`} className="w-6 h-20 bg-blue-500 rounded-sm border border-blue-600 shadow-sm" />
                        ))}
                        {Array.from({ length: tens2 }).map((_, i) => (
                           <div key={`t2-${i}`} className="w-6 h-20 bg-blue-400 rounded-sm border border-blue-500 shadow-sm" />
                        ))}
                        {step === 3 && carry === 1 && (
                           <div className="w-6 h-20 bg-orange-500 rounded-sm border border-orange-600 shadow-sm animate-in slide-in-from-right-12 duration-500" />
                        )}
                     </div>
                  </div>

                  {/* Ones Column */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-orange-50/50 rounded-3xl border-2 border-dashed border-orange-200 min-w-[120px]">
                     <span className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Ones</span>
                     <div className="grid grid-cols-2 gap-2">
                        {step < 2 ? (
                           <>
                              {Array.from({ length: ones1 }).map((_, i) => (
                                 <div key={`o1-${i}`} className="w-6 h-6 bg-orange-500 rounded-sm border border-orange-600 shadow-sm" />
                              ))}
                              {Array.from({ length: ones2 }).map((_, i) => (
                                 <div key={`o2-${i}`} className="w-6 h-6 bg-orange-400 rounded-sm border border-orange-500 shadow-sm" />
                              ))}
                           </>
                        ) : (
                           Array.from({ length: resultOnes }).map((_, i) => (
                              <div key={`ro-${i}`} className="w-6 h-6 bg-orange-500 rounded-sm border border-orange-600 shadow-sm animate-in zoom-in duration-300" />
                           ))
                        )}
                     </div>
                  </div>
               </div>

               {/* Step Visualizer */}
               <div className="w-64 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 0 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">1. Look at the Ones</p>
                     <p className="text-[10px] text-slate-500">{ones1} + {ones2} = {totalOnes}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 1 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">2. Regroup?</p>
                     <p className="text-[10px] text-slate-500">{totalOnes >= 10 ? 'Yes! 10 ones = 1 ten' : 'No need!'}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 2 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">3. Add the Tens</p>
                     <p className="text-[10px] text-slate-500">{tens1} + {tens2} {carry > 0 ? '+ 1' : ''} = {resultTens}</p>
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/80 backdrop-blur-md border-t border-slate-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  {step < 3 ? (
                     <button
                        onClick={() => setStep(s => s + 1)}
                        className="flex-1 h-14 bg-blue-600 text-white font-black rounded-2xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                     >
                        {step === 0 ? 'COMBINE ONES' : step === 1 ? 'REGROUP 10 ONES' : 'ADD TENS'} üèóÔ∏è
                     </button>
                  ) : (
                     <button
                        onClick={reset}
                        className="flex-1 h-14 bg-slate-800 text-white font-black rounded-2xl shadow-lg hover:bg-slate-900 transition-all"
                     >
                        START NEW BUILD
                     </button>
                  )}
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">üèóÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     When we have <strong>10 or more ones</strong>, we "regroup" them into a single ten-rod and move it to the tens column. This is what we call "carrying"!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTI-DIGIT SUBTRACTION WITH BORROWING RENDERER ---
   const MultiDigitSubtractionBorrowingRenderer = () => {
      const [num1, setNum1] = useState(52);
      const [num2, setNum2] = useState(27);
      const [step, setStep] = useState(0); // 0: initial, 1: borrow, 2: subtract ones, 3: subtract tens

      const ones1 = num1 % 10;
      const tens1 = Math.floor(num1 / 10);
      const ones2 = num2 % 10;
      const tens2 = Math.floor(num2 / 10);

      const needsBorrow = ones1 < ones2;
      const borrowedOnes = ones1 + 10;
      const remainingTens = tens1 - 1;

      const reset = () => {
         setStep(0);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Vault Background */}
            <div className="absolute inset-0 bg-slate-200 opacity-30" style={{ backgroundImage: 'repeating-linear-gradient(45deg, #94a3b8 0, #94a3b8 1px, transparent 0, transparent 50%)', backgroundSize: '10px 10px' }} />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-200 bg-white/80 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-700">BANK VAULT</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multi-Digit Subtraction: Borrowing</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="text-right">
                     <div className="text-2xl font-black text-slate-800 tabular-nums">
                        {num1} - {num2} = {step === 3 ? num1 - num2 : '?'}
                     </div>
                  </div>
               </div>
            </div>

            {/* Vault Interior */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-16">
               {/* Place Value Safes */}
               <div className="flex gap-8">
                  {/* Tens Safe */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-slate-800 rounded-3xl border-4 border-slate-700 min-w-[140px] shadow-2xl">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tens (Bills)</span>
                     <div className="flex flex-col gap-2">
                        {Array.from({ length: step >= 1 ? remainingTens : tens1 }).map((_, i) => (
                           <div key={`t-${i}`} className="w-12 h-6 bg-emerald-500 rounded-sm border-2 border-emerald-600 shadow-sm flex items-center justify-center text-[10px] font-bold text-emerald-900">$10</div>
                        ))}
                        {step === 0 && needsBorrow && (
                           <div className="w-12 h-6 bg-emerald-400 rounded-sm border-2 border-emerald-500 opacity-50 border-dashed" />
                        )}
                     </div>
                  </div>

                  {/* Ones Safe */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-slate-700 rounded-3xl border-4 border-slate-600 min-w-[140px] shadow-2xl">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ones (Coins)</span>
                     <div className="grid grid-cols-3 gap-2">
                        {Array.from({ length: step >= 1 ? borrowedOnes : ones1 }).map((_, i) => (
                           <div key={`o-${i}`} className={`w-6 h-6 bg-yellow-400 rounded-full border-2 border-yellow-600 shadow-sm flex items-center justify-center text-[8px] font-bold text-yellow-900 ${i >= ones1 ? 'animate-in zoom-in duration-500' : ''}`}>$1</div>
                        ))}
                     </div>
                  </div>
               </div>

               {/* Step Visualizer */}
               <div className="w-64 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 0 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">1. Check the Ones</p>
                     <p className="text-[10px] text-slate-500">Can we take {ones2} from {ones1}?</p>
                     {needsBorrow && <p className="text-[10px] text-red-500 font-bold">No! Need to borrow.</p>}
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 1 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">2. Borrow a Ten</p>
                     <p className="text-[10px] text-slate-500">Break $10 into ten $1 coins.</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 2 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">3. Subtract Ones</p>
                     <p className="text-[10px] text-slate-500">{step >= 1 ? borrowedOnes : ones1} - {ones2} = {step >= 2 ? (step >= 1 ? borrowedOnes : ones1) - ones2 : '?'}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 3 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">4. Subtract Tens</p>
                     <p className="text-[10px] text-slate-500">{step >= 1 ? remainingTens : tens1} - {tens2} = {step === 3 ? (step >= 1 ? remainingTens : tens1) - tens2 : '?'}</p>
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/80 backdrop-blur-md border-t border-emerald-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  {step < 3 ? (
                     <button
                        onClick={() => setStep(s => s + 1)}
                        className="flex-1 h-14 bg-emerald-600 text-white font-black rounded-2xl shadow-lg hover:bg-emerald-700 transition-all flex items-center justify-center gap-2"
                     >
                        {step === 0 ? 'BORROW FROM TENS' : step === 1 ? 'SUBTRACT ONES' : 'SUBTRACT TENS'} üè¶
                     </button>
                  ) : (
                     <button
                        onClick={reset}
                        className="flex-1 h-14 bg-slate-800 text-white font-black rounded-2xl shadow-lg hover:bg-slate-900 transition-all"
                     >
                        NEW WITHDRAWAL
                     </button>
                  )}
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üè¶</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     When we don't have enough ones to subtract, we <strong>borrow</strong> one ten from the tens place and "break" it into 10 ones. Now we have plenty!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTIPLICATION TABLES RENDERER ---
   const MultiplicationTablesRenderer = () => {
      const [selectedTable, setSelectedTable] = useState(2);
      const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden relative">
            {/* Space Background */}
            <div className="absolute inset-0 overflow-hidden">
               {Array.from({ length: 50 }).map((_, i) => (
                  <div
                     key={i}
                     className="absolute bg-white rounded-full animate-pulse"
                     style={{
                        width: Math.random() * 3 + 'px',
                        height: Math.random() * 3 + 'px',
                        top: Math.random() * 100 + '%',
                        left: Math.random() * 100 + '%',
                        animationDelay: Math.random() * 5 + 's',
                        opacity: Math.random() * 0.7 + 0.3
                     }}
                  />
               ))}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/10 bg-black/40 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">TIMES TABLE GALAXY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multiplication Tables (1-12)</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-indigo-500 uppercase tracking-tighter">Selected Table</div>
                  <div className="text-2xl font-black text-white">
                     The {selectedTable}s
                  </div>
               </div>
            </div>

            {/* Galaxy View */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-12">
               {/* Table Grid */}
               <div className="grid grid-cols-4 gap-4 max-w-md">
                  {Array.from({ length: 12 }).map((_, i) => {
                     const factor = i + 1;
                     const product = selectedTable * factor;
                     return (
                        <div
                           key={factor}
                           onMouseEnter={() => setHoveredProduct(product)}
                           onMouseLeave={() => setHoveredProduct(null)}
                           className={`group relative p-4 rounded-2xl border-2 transition-all cursor-pointer ${hoveredProduct === product ? 'bg-indigo-600/40 border-indigo-400 scale-105 shadow-lg shadow-indigo-500/20' : 'bg-white/5 border-white/10 hover:border-white/30'}`}
                        >
                           <div className="text-[10px] font-bold text-slate-500 mb-1">{selectedTable} √ó {factor}</div>
                           <div className="text-2xl font-black text-white tabular-nums">{product}</div>

                           {/* Orbiting Particle */}
                           {hoveredProduct === product && (
                              <div className="absolute inset-0 border-2 border-indigo-400/50 rounded-2xl animate-ping" />
                           )}
                        </div>
                     );
                  })}
               </div>

               {/* Planet Selector */}
               <div className="flex flex-col gap-2">
                  <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Select Planet</span>
                  <div className="grid grid-cols-3 gap-2">
                     {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(n => (
                        <button
                           key={n}
                           onClick={() => setSelectedTable(n)}
                           className={`w-12 h-12 rounded-full font-black transition-all flex items-center justify-center border-2 ${selectedTable === n ? 'bg-indigo-600 border-indigo-400 text-white scale-110 shadow-lg shadow-indigo-500/40' : 'bg-black/40 border-white/10 text-slate-400 hover:border-white/30'}`}
                        >
                           {n}
                        </button>
                     ))}
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-black/60 backdrop-blur-md border-t border-white/10 flex flex-col items-center gap-6">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center border border-indigo-500/30 shrink-0">
                     <span className="text-2xl">üöÄ</span>
                  </div>
                  <div className="flex flex-col gap-1">
                     <p className="text-sm font-bold text-indigo-300">
                        {hoveredProduct ? `Did you know? ${selectedTable} times something is always ${hoveredProduct % 2 === 0 ? 'even' : 'odd'} here!` : 'Explore the galaxy of numbers!'}
                     </p>
                     <p className="text-xs text-slate-500 leading-relaxed">
                        Multiplication tables help us find patterns. For example, the 5s always end in 0 or 5, and the 9s digits always add up to 9!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };





   // --- STRESS RESPONSE VISUALIZER ---
   const StressResponseRenderer = () => {
      const [stressLevel, setStressLevel] = useState(50); // 0-100
      const [technique, setTechnique] = useState<string | null>(null);
      const [metrics, setMetrics] = useState({ hr: 72, bp: '120/80', cortisol: 'Normal', tension: 'Low' });
      const [time, setTime] = useState(0);

      useEffect(() => {
         // Base metrics based on stress level
         const hr = 60 + (stressLevel * 0.6);
         const sys = 110 + (stressLevel * 0.4);
         const dia = 70 + (stressLevel * 0.3);
         const tension = stressLevel < 30 ? 'Low' : stressLevel < 70 ? 'Moderate' : 'High';
         const cortisol = stressLevel < 40 ? 'Normal' : stressLevel < 80 ? 'Elevated' : 'High';

         setMetrics({
            hr: Math.round(hr),
            bp: `${Math.round(sys)}/${Math.round(dia)}`,
            cortisol,
            tension
         });
      }, [stressLevel]);

      useEffect(() => {
         let interval: any;
         if (technique) {
            interval = setInterval(() => {
               setStressLevel(prev => Math.max(0, prev - 2));
               setTime(t => t + 1);
               if (time > 10) {
                  setTechnique(null);
                  setTime(0);
               }
            }, 500);
         }
         return () => clearInterval(interval);
      }, [technique, time]);

      const startTechnique = (name: string) => {
         setTechnique(name);
         setTime(0);
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Stress Response System</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Physiological Feedback Loop</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">STRESS LEVEL</span>
                  <input
                     type="range" min="0" max="100" value={stressLevel}
                     onChange={(e) => setStressLevel(parseInt(e.target.value))}
                     className="w-32 accent-red-500"
                  />
                  <span className={`text-sm font-black w-8 ${stressLevel > 70 ? 'text-red-500' : 'text-emerald-500'}`}>{stressLevel}%</span>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Biological Map */}
               <div className="flex-1 relative p-12 flex items-center justify-center">
                  <div className="relative w-full max-w-lg aspect-square border-2 border-slate-800 rounded-[40px] bg-slate-900/50 flex flex-col items-center p-8">
                     <div className="w-24 h-24 bg-slate-800 rounded-3xl flex items-center justify-center border-2 border-slate-700 mb-8 relative">
                        <span className="text-2xl">üß†</span>
                        <div className={`absolute -bottom-2 px-2 py-0.5 rounded text-[8px] font-black ${stressLevel > 50 ? 'bg-red-500 animate-pulse' : 'bg-slate-700'}`}>AMYGDALA</div>
                     </div>

                     <div className="flex-1 w-full grid grid-cols-2 gap-8">
                        <div className="flex flex-col items-center justify-center gap-4">
                           <div className={`w-1 h-16 bg-gradient-to-b from-slate-700 to-red-500/50 ${stressLevel > 50 ? 'opacity-100' : 'opacity-20'}`} />
                           <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 text-center w-full">
                              <p className="text-[8px] font-black text-slate-500 uppercase mb-1">Hormonal</p>
                              <p className="text-xs font-bold text-red-400">Cortisol Release</p>
                              <p className="text-[8px] text-slate-400 mt-2">Long-term effects</p>
                           </div>
                        </div>
                        <div className="flex flex-col items-center justify-center gap-4">
                           <div className={`w-1 h-16 bg-gradient-to-b from-slate-700 to-orange-500/50 ${stressLevel > 30 ? 'opacity-100' : 'opacity-20'}`} />
                           <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 text-center w-full">
                              <p className="text-[8px] font-black text-slate-500 uppercase mb-1">Sympathetic</p>
                              <p className="text-xs font-bold text-orange-400">Adrenaline Spike</p>
                              <p className="text-[8px] text-slate-400 mt-2">Immediate effects</p>
                           </div>
                        </div>
                     </div>

                     {technique && (
                        <div className="absolute inset-0 bg-emerald-500/10 backdrop-blur-sm rounded-[40px] flex items-center justify-center flex-col">
                           <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4" />
                           <p className="text-emerald-400 font-black uppercase tracking-widest">{technique}...</p>
                        </div>
                     )}
                  </div>
               </div>

               {/* Metrics Panel */}
               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Biometric Feedback</p>

                  <div className="grid grid-cols-1 gap-4">
                     {[
                        { label: 'Heart Rate', value: `${metrics.hr} bpm`, color: 'text-red-400', icon: '‚ù§Ô∏è' },
                        { label: 'Blood Pressure', value: metrics.bp, color: 'text-orange-400', icon: 'ü©∏' },
                        { label: 'Cortisol', value: metrics.cortisol, color: 'text-yellow-400', icon: 'üß™' },
                        { label: 'Muscle Tension', value: metrics.tension, color: 'text-blue-400', icon: 'üí™' }
                     ].map(m => (
                        <div key={m.label} className="bg-slate-950 p-5 rounded-3xl border border-slate-800 flex justify-between items-center">
                           <div>
                              <p className="text-[8px] font-bold text-slate-500 uppercase mb-1">{m.label}</p>
                              <p className={`text-xl font-black ${m.color}`}>{m.value}</p>
                           </div>
                           <span className="text-2xl opacity-50">{m.icon}</span>
                        </div>
                     ))}
                  </div>

                  <div className="mt-auto space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Active Interventions</p>
                     <div className="grid grid-cols-1 gap-2">
                        <button
                           onClick={() => startTechnique('Deep Breathing')}
                           className="p-4 bg-emerald-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-emerald-400 transition-all uppercase"
                        >
                           Deep Breathing
                        </button>
                        <button
                           onClick={() => startTechnique('Grounding')}
                           className="p-4 bg-blue-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-blue-400 transition-all uppercase"
                        >
                           5-4-3-2-1 Grounding
                        </button>
                        <button
                           onClick={() => startTechnique('Muscle Relaxation')}
                           className="p-4 bg-purple-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-purple-400 transition-all uppercase"
                        >
                           Progressive Relaxation
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FORCE CLASSIFICATION RENDERER (Balanced vs. Unbalanced) ---
   const ForceClassificationRenderer = () => {
      const [scenario, setScenario] = useState<'rest' | 'constant' | 'accel' | 'braking'>('rest');
      const [showNet, setShowNet] = useState(false);
      const [userGuess, setUserGuess] = useState<'balanced' | 'unbalanced' | null>(null);
      const [feedback, setFeedback] = useState<string | null>(null);

      const scenarios = {
         rest: { forces: { N: 50, S: 50, E: 0, W: 0 }, label: 'Object at Rest', correct: 'balanced', desc: 'Gravity and Normal force cancel out. No horizontal forces.' },
         constant: { forces: { N: 50, S: 50, E: 30, W: 30 }, label: 'Constant Velocity', correct: 'balanced', desc: 'Applied force equals Friction. Net force is zero!' },
         accel: { forces: { N: 50, S: 50, E: 60, W: 20 }, label: 'Accelerating Right', correct: 'unbalanced', desc: 'Applied force is greater than Friction. Object speeds up.' },
         braking: { forces: { N: 50, S: 50, E: 0, W: 40 }, label: 'Braking to a Stop', correct: 'unbalanced', desc: 'Only Friction is acting horizontally. Object slows down.' }
      };

      const current = scenarios[scenario];
      const netX = current.forces.E - current.forces.W;
      const netY = current.forces.N - current.forces.S;

      const handleGuess = (guess: 'balanced' | 'unbalanced') => {
         setUserGuess(guess);
         if (guess === current.correct) {
            setFeedback('CORRECT! ' + current.desc);
         } else {
            setFeedback('NOT QUITE. ' + current.desc);
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Force Classification</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Balanced vs. Unbalanced Forces</p>
               </div>
               <div className="flex gap-2">
                  {Object.keys(scenarios).map(s => (
                     <button
                        key={s} onClick={() => { setScenario(s as any); setUserGuess(null); setFeedback(null); setShowNet(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${scenario === s ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                           }`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Stage */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative w-48 h-32 bg-blue-600 rounded-2xl shadow-2xl border-4 border-blue-700 flex items-center justify-center z-10">
                     <span className="text-white font-black text-sm uppercase tracking-tighter">{current.label}</span>

                     {/* Force Arrows */}
                     {/* North (Normal) */}
                     <div className="absolute bottom-full mb-2 flex flex-col items-center" style={{ height: `${current.forces.N}px` }}>
                        <div className="w-0 h-0 border-l-6 border-l-transparent border-r-6 border-r-transparent border-b-[10px] border-b-emerald-500" />
                        <div className="w-1.5 bg-emerald-500 flex-1" />
                        <span className="absolute -top-6 text-[8px] font-bold text-emerald-600">NORMAL</span>
                     </div>
                     {/* South (Gravity) */}
                     <div className="absolute top-full mt-2 flex flex-col items-center" style={{ height: `${current.forces.S}px` }}>
                        <div className="w-1.5 bg-red-500 flex-1" />
                        <div className="w-0 h-0 border-l-6 border-l-transparent border-r-6 border-r-transparent border-t-[10px] border-t-red-500" />
                        <span className="absolute -bottom-6 text-[8px] font-bold text-red-600">GRAVITY</span>
                     </div>
                     {/* East (Applied) */}
                     {current.forces.E > 0 && (
                        <div className="absolute left-full ml-2 flex items-center" style={{ width: `${current.forces.E}px` }}>
                           <div className="h-1.5 bg-blue-500 flex-1" />
                           <div className="w-0 h-0 border-t-6 border-t-transparent border-b-6 border-b-transparent border-l-[10px] border-l-blue-500" />
                           <span className="absolute -top-4 left-0 text-[8px] font-bold text-blue-600">APPLIED</span>
                        </div>
                     )}
                     {/* West (Friction) */}
                     {current.forces.W > 0 && (
                        <div className="absolute right-full mr-2 flex items-center" style={{ width: `${current.forces.W}px` }}>
                           <div className="w-0 h-0 border-t-6 border-t-transparent border-b-6 border-b-transparent border-r-[10px] border-r-amber-500" />
                           <div className="h-1.5 bg-amber-500 flex-1" />
                           <span className="absolute -top-4 right-0 text-[8px] font-bold text-amber-600">FRICTION</span>
                        </div>
                     )}

                     {/* Net Force Vector */}
                     {showNet && (Math.abs(netX) > 0 || Math.abs(netY) > 0) && (
                        <div
                           className="absolute z-20 pointer-events-none"
                           style={{
                              transform: `translate(${netX / 2}px, ${-netY / 2}px)`,
                              width: `${Math.abs(netX)}px`,
                              height: `${Math.abs(netY)}px`
                           }}
                        >
                           <div className="absolute inset-0 border-2 border-dashed border-slate-900 rounded-xl opacity-30" />
                           <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 text-white text-[8px] font-black px-2 py-1 rounded whitespace-nowrap">
                              NET FORCE: {Math.sqrt(netX * netX + netY * netY).toFixed(0)}N
                           </div>
                        </div>
                     )}
                  </div>
               </div>

               {/* Analysis & Quiz */}
               <div className="w-full lg:w-96 bg-white border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Analysis Challenge</p>
                     <h3 className="text-lg font-black text-slate-900 leading-tight">Are the forces on this object balanced?</h3>

                     <div className="grid grid-cols-2 gap-4">
                        <button
                           onClick={() => handleGuess('balanced')}
                           className={`py-4 rounded-2xl font-black text-sm border-2 transition-all ${userGuess === 'balanced' ? 'bg-emerald-500 border-emerald-600 text-white shadow-lg' : 'bg-white border-slate-100 hover:border-emerald-200 text-slate-600'
                              }`}
                        >
                           BALANCED
                        </button>
                        <button
                           onClick={() => handleGuess('unbalanced')}
                           className={`py-4 rounded-2xl font-black text-sm border-2 transition-all ${userGuess === 'unbalanced' ? 'bg-amber-500 border-amber-600 text-white shadow-lg' : 'bg-white border-slate-100 hover:border-amber-200 text-slate-600'
                              }`}
                        >
                           UNBALANCED
                        </button>
                     </div>

                     {feedback && (
                        <div className={`p-5 rounded-3xl border-2 animate-in fade-in slide-in-from-top-2 ${userGuess === current.correct ? 'bg-emerald-50 border-emerald-100 text-emerald-900' : 'bg-amber-50 border-amber-100 text-amber-900'
                           }`}>
                           <p className="text-xs font-bold leading-relaxed">{feedback}</p>
                           <button
                              onClick={() => setShowNet(true)}
                              className="mt-4 text-[10px] font-black underline uppercase tracking-widest opacity-60 hover:opacity-100"
                           >
                              Show Net Force Vector
                           </button>
                        </div>
                     )}
                  </div>

                  {/* Rules of Motion */}
                  <div className="mt-auto space-y-4">
                     <div className="p-6 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Golden Rules</p>
                        <ul className="space-y-4">
                           <li className="flex gap-3">
                              <span className="text-emerald-400 font-black">1.</span>
                              <p className="text-[10px] leading-relaxed"><strong>Balanced Forces</strong> mean NO change in motion (Rest or Constant Speed).</p>
                           </li>
                           <li className="flex gap-3">
                              <span className="text-amber-400 font-black">2.</span>
                              <p className="text-[10px] leading-relaxed"><strong>Unbalanced Forces</strong> mean the object IS accelerating (Speeding up or Slowing down).</p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GRAVITY & FREE FALL RENDERER (Vacuum vs. Air) ---
   const GravityAccelerationRenderer = () => {
      const [isVacuum, setIsVacuum] = useState(false);
      const [height, setHeight] = useState(10); // meters
      const [isFalling, setIsFalling] = useState(false);
      const [time, setTime] = useState(0);
      const [obj1, setObj1] = useState({ y: 0, v: 0, a: 9.8, type: 'ball' });
      const [obj2, setObj2] = useState({ y: 0, v: 0, a: 9.8, type: 'feather' });
      const [history, setHistory] = useState<{ t: number, y1: number, y2: number }[]>([]);

      const g = 9.81;
      const dragFeather = isVacuum ? 0 : 0.8;
      const dragBall = isVacuum ? 0 : 0.05;

      useEffect(() => {
         let interval: any;
         if (isFalling) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;
               setTime(elapsed);

               // Physics update
               setObj1(prev => {
                  const airRes = dragBall * prev.v * prev.v;
                  const netA = g - (airRes / 1); // mass = 1
                  const newV = prev.v + netA * 0.03;
                  const newY = prev.y + newV * 0.03 * 20; // scale
                  return { ...prev, v: newV, y: newY > 300 ? 300 : newY };
               });

               setObj2(prev => {
                  const airRes = dragFeather * prev.v * prev.v;
                  const netA = g - (airRes / 0.1); // mass = 0.1
                  const newV = prev.v + netA * 0.03;
                  const newY = prev.y + newV * 0.03 * 20; // scale
                  return { ...prev, v: newV, y: newY > 300 ? 300 : newY };
               });

               setHistory(prev => [...prev.slice(-50), { t: elapsed, y1: obj1.y, y2: obj2.y }]);

               if (obj1.y >= 300 && obj2.y >= 300) {
                  setIsFalling(false);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isFalling, isVacuum, dragBall, dragFeather]);

      const reset = () => {
         setIsFalling(false);
         setTime(0);
         setObj1({ y: 0, v: 0, a: 9.8, type: 'ball' });
         setObj2({ y: 0, v: 0, a: 9.8, type: 'feather' });
         setHistory([]);
      };

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col overflow-hidden text-white font-sans">
            {/* Header */}
            <div className="p-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Gravity & Free Fall</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Galileo's Experiment</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-3 bg-slate-900 px-4 py-2 rounded-2xl border border-slate-700">
                     <span className="text-[10px] font-bold text-slate-500">VACUUM</span>
                     <button
                        onClick={() => { setIsVacuum(!isVacuum); reset(); }}
                        className={`w-12 h-6 rounded-full relative transition-colors ${isVacuum ? 'bg-emerald-500' : 'bg-slate-700'}`}
                     >
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${isVacuum ? 'left-7' : 'left-1'}`} />
                     </button>
                  </div>
                  <button onClick={reset} className="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 transition-colors">‚Ü∫</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Drop Zone */}
               <div className="flex-1 relative bg-slate-950 flex justify-center p-12">
                  {/* Vacuum Chamber Effect */}
                  {isVacuum && (
                     <div className="absolute inset-4 border-2 border-emerald-500/20 rounded-3xl bg-emerald-500/5 backdrop-blur-[2px]" />
                  )}

                  {/* Height Scale */}
                  <div className="absolute left-12 top-12 bottom-12 w-1 bg-slate-800 flex flex-col justify-between py-2">
                     {[10, 8, 6, 4, 2, 0].map(m => (
                        <div key={m} className="relative flex items-center">
                           <div className="w-4 h-[1px] bg-slate-600" />
                           <span className="absolute left-6 text-[8px] font-bold text-slate-500">{m}m</span>
                        </div>
                     ))}
                  </div>

                  <div className="relative w-64 h-[350px] flex justify-around items-start pt-10">
                     {/* Object 1: Ball */}
                     <div className="flex flex-col items-center">
                        <div
                           className="w-12 h-12 bg-slate-300 rounded-full shadow-2xl border-4 border-slate-400 flex items-center justify-center transition-transform duration-30"
                           style={{ transform: `translateY(${obj1.y}px)` }}
                        >
                           <div className="w-2 h-2 bg-slate-500 rounded-full opacity-50" />
                        </div>
                        <span className="mt-4 text-[8px] font-black text-slate-500 uppercase">Bowling Ball</span>
                     </div>

                     {/* Object 2: Feather */}
                     <div className="flex flex-col items-center">
                        <div
                           className="w-12 h-12 flex items-center justify-center transition-transform duration-30"
                           style={{ transform: `translateY(${obj2.y}px) rotate(${isFalling && !isVacuum ? Math.sin(time * 10) * 20 : 0}deg)` }}
                        >
                           <svg className="w-10 h-10 text-emerald-400 opacity-80" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M21,3C21,3 18,3 15,6C12,9 12,13 12,13C12,13 11,12 9,12C7,12 3,15 3,15C3,15 7,16 9,18C11,20 12,24 12,24C12,24 15,20 15,18C15,16 14,15 14,15C14,15 18,15 21,12C24,9 21,3 21,3Z" />
                           </svg>
                        </div>
                        <span className="mt-4 text-[8px] font-black text-slate-500 uppercase">Feather</span>
                     </div>

                     {/* Ground */}
                     <div className="absolute bottom-0 left-0 right-0 h-2 bg-slate-800 rounded-full shadow-[0_0_20px_rgba(0,0,0,0.5)]" />
                  </div>

                  {/* Drop Button */}
                  <div className="absolute bottom-12 left-1/2 -translate-x-1/2">
                     <button
                        onClick={() => setIsFalling(true)}
                        disabled={isFalling}
                        className="px-12 py-4 bg-emerald-500 text-slate-900 rounded-2xl font-black text-xl shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:bg-emerald-400 disabled:opacity-30 transition-all transform active:scale-95"
                     >
                        {isFalling ? 'FALLING...' : 'RELEASE'}
                     </button>
                  </div>
               </div>

               {/* Metrics & Analysis */}
               <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-10 overflow-y-auto">
                  <div className="space-y-8">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Live Telemetry</p>

                     <div className="space-y-4">
                        <div className="bg-slate-800 p-5 rounded-3xl border border-slate-700">
                           <div className="flex justify-between items-center mb-4">
                              <span className="text-[8px] font-bold text-slate-500 uppercase">Time Elapsed</span>
                              <span className="text-xl font-mono font-black text-emerald-400">{time.toFixed(2)}s</span>
                           </div>
                           <div className="space-y-4">
                              <div className="space-y-1">
                                 <div className="flex justify-between text-[10px] font-bold">
                                    <span className="text-slate-400">Ball Velocity</span>
                                    <span className="text-white">{obj1.v.toFixed(1)} m/s</span>
                                 </div>
                                 <div className="h-1 bg-slate-900 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500 transition-all" style={{ width: `${(obj1.v / 20) * 100}%` }} />
                                 </div>
                              </div>
                              <div className="space-y-1">
                                 <div className="flex justify-between text-[10px] font-bold">
                                    <span className="text-slate-400">Feather Velocity</span>
                                    <span className="text-white">{obj2.v.toFixed(1)} m/s</span>
                                 </div>
                                 <div className="h-1 bg-slate-900 rounded-full overflow-hidden">
                                    <div className="h-full bg-emerald-500 transition-all" style={{ width: `${(obj2.v / 20) * 100}%` }} />
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>

                     {/* Graph Area */}
                     <div className="bg-slate-950 p-6 rounded-3xl border border-slate-800 h-48 flex flex-col">
                        <p className="text-[8px] font-bold text-slate-500 uppercase mb-4">Velocity vs. Time</p>
                        <div className="flex-1 relative border-l border-b border-slate-800">
                           <svg className="w-full h-full overflow-visible">
                              <polyline
                                 points={history.map((h, i) => `${(i / 50) * 100}%, ${100 - (h.y1 / 3)}%`).join(' ')}
                                 fill="none" stroke="#3b82f6" strokeWidth="2"
                              />
                              <polyline
                                 points={history.map((h, i) => `${(i / 50) * 100}%, ${100 - (h.y2 / 3)}%`).join(' ')}
                                 fill="none" stroke="#10b981" strokeWidth="2"
                              />
                           </svg>
                        </div>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-5 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <div className="flex gap-3 mb-2">
                        <span className="text-emerald-400">üí°</span>
                        <h4 className="text-[10px] font-black text-emerald-400 uppercase">The Gravity Secret</h4>
                     </div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        In a <strong>Vacuum</strong>, all objects fall at the exact same rate regardless of mass!
                        Air resistance is what makes the feather slow down. Gravity pulls on everything equally.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- NET FORCE RENDERER (Vector Addition) ---
   const NetForceRenderer = () => {
      const [forces, setForces] = useState({ N: 0, S: 0, E: 0, W: 0 });
      const [showResultant, setShowResultant] = useState(true);
      const [showComponents, setShowComponents] = useState(true);
      const [mode, setMode] = useState<'1d' | '2d' | 'challenge'>('1d');
      const [target, setTarget] = useState({ x: 50, y: 0 });
      const [isBalanced, setIsBalanced] = useState(true);

      const netX = forces.E - forces.W;
      const netY = forces.N - forces.S;
      const magnitude = Math.sqrt(netX * netX + netY * netY);
      const angle = Math.atan2(netY, netX) * (180 / Math.PI);

      useEffect(() => {
         setIsBalanced(netX === 0 && netY === 0);
      }, [netX, netY]);

      const reset = () => {
         setForces({ N: 0, S: 0, E: 0, W: 0 });
         if (mode === 'challenge') {
            setTarget({ x: (Math.random() - 0.5) * 100, y: (Math.random() - 0.5) * 100 });
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Net Force & Vectors</h2>
                  <div className="flex gap-2 mt-2">
                     <button onClick={() => { setMode('1d'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === '1d' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'}`}>1D TUG-OF-WAR</button>
                     <button onClick={() => { setMode('2d'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === '2d' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-500'}`}>2D EXPLORATION</button>
                     <button onClick={() => { setMode('challenge'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === 'challenge' ? 'bg-amber-600 text-white' : 'bg-slate-100 text-slate-500'}`}>TARGET CHALLENGE</button>
                  </div>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Net Force</p>
                     <p className="text-xl font-black text-slate-900">{magnitude.toFixed(1)} N</p>
                  </div>
                  <div className={`px-4 py-2 rounded-xl flex items-center justify-center font-black text-xs ${isBalanced ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                     {isBalanced ? 'BALANCED' : 'UNBALANCED'}
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Vector Stage */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  {/* Grid */}
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  {/* The Crate */}
                  <div className="relative w-32 h-32 bg-amber-800 rounded-xl shadow-2xl border-4 border-amber-900 flex items-center justify-center z-10">
                     <div className="w-full h-full opacity-20" style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 11px)' }} />
                     <span className="absolute text-white font-black text-xl opacity-50">CRATE</span>

                     {/* Resultant Vector */}
                     {showResultant && magnitude > 0 && (
                        <div
                           className="absolute origin-center transition-all duration-300"
                           style={{ transform: `rotate(${-angle}deg)`, width: `${magnitude * 2}px` }}
                        >
                           <div className="h-2 bg-emerald-500 rounded-full shadow-lg relative">
                              <div className="absolute right-[-8px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-l-[12px] border-l-emerald-500" />
                           </div>
                           <span className="absolute -top-6 right-0 text-[10px] font-black text-emerald-600 whitespace-nowrap">NET FORCE</span>
                        </div>
                     )}

                     {/* Component Vectors */}
                     {showComponents && (
                        <>
                           {forces.E > 0 && (
                              <div className="absolute left-1/2 w-[1px] h-1" style={{ width: `${forces.E * 2}px` }}>
                                 <div className="h-1 bg-blue-400 relative">
                                    <div className="absolute right-[-4px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[6px] border-l-blue-400" />
                                 </div>
                              </div>
                           )}
                           {forces.W > 0 && (
                              <div className="absolute right-1/2 w-[1px] h-1" style={{ width: `${forces.W * 2}px`, transform: 'scaleX(-1)' }}>
                                 <div className="h-1 bg-blue-400 relative">
                                    <div className="absolute right-[-4px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[6px] border-l-blue-400" />
                                 </div>
                              </div>
                           )}
                           {forces.N > 0 && (
                              <div className="absolute bottom-1/2 w-1 h-[1px]" style={{ height: `${forces.N * 2}px`, transform: 'scaleY(-1)' }}>
                                 <div className="w-1 bg-purple-400 relative h-full">
                                    <div className="absolute top-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-[6px] border-b-purple-400" />
                                 </div>
                              </div>
                           )}
                           {forces.S > 0 && (
                              <div className="absolute top-1/2 w-1 h-[1px]" style={{ height: `${forces.S * 2}px` }}>
                                 <div className="w-1 bg-purple-400 relative h-full">
                                    <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-[6px] border-t-purple-400" />
                                 </div>
                              </div>
                           )}
                        </>
                     )}
                  </div>

                  {/* Challenge Target */}
                  {mode === 'challenge' && (
                     <div
                        className="absolute w-12 h-12 border-4 border-dashed border-amber-400 rounded-full flex items-center justify-center animate-pulse"
                        style={{ transform: `translate(${target.x * 2}px, ${-target.y * 2}px)` }}
                     >
                        <span className="text-[8px] font-black text-amber-600">TARGET</span>
                     </div>
                  )}
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Force Applicators</p>

                     {/* East-West Controls */}
                     <div className="space-y-4">
                        <div className="space-y-2">
                           <div className="flex justify-between">
                              <label className="text-[10px] font-bold text-slate-500">EAST FORCE (E)</label>
                              <span className="text-[10px] font-black text-blue-600">{forces.E} N</span>
                           </div>
                           <input
                              type="range" min="0" max="100" step="5" value={forces.E}
                              onChange={(e) => setForces(f => ({ ...f, E: Number(e.target.value) }))}
                              className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between">
                              <label className="text-[10px] font-bold text-slate-500">WEST FORCE (W)</label>
                              <span className="text-[10px] font-black text-blue-600">{forces.W} N</span>
                           </div>
                           <input
                              type="range" min="0" max="100" step="5" value={forces.W}
                              onChange={(e) => setForces(f => ({ ...f, W: Number(e.target.value) }))}
                              className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                     </div>

                     {/* North-South Controls (2D only) */}
                     {mode !== '1d' && (
                        <div className="space-y-4 pt-4 border-t border-slate-100">
                           <div className="space-y-2">
                              <div className="flex justify-between">
                                 <label className="text-[10px] font-bold text-slate-500">NORTH FORCE (N)</label>
                                 <span className="text-[10px] font-black text-purple-600">{forces.N} N</span>
                              </div>
                              <input
                                 type="range" min="0" max="100" step="5" value={forces.N}
                                 onChange={(e) => setForces(f => ({ ...f, N: Number(e.target.value) }))}
                                 className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                              />
                           </div>
                           <div className="space-y-2">
                              <div className="flex justify-between">
                                 <label className="text-[10px] font-bold text-slate-500">SOUTH FORCE (S)</label>
                                 <span className="text-[10px] font-black text-purple-600">{forces.S} N</span>
                              </div>
                              <input
                                 type="range" min="0" max="100" step="5" value={forces.S}
                                 onChange={(e) => setForces(f => ({ ...f, S: Number(e.target.value) }))}
                                 className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                              />
                           </div>
                        </div>
                     )}

                     <div className="pt-4 border-t border-slate-100 space-y-4">
                        <button
                           onClick={() => setShowResultant(!showResultant)}
                           className={`w-full py-2 rounded-lg text-[10px] font-bold transition-all ${showResultant ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400'
                              }`}
                        >
                           {showResultant ? '‚úì SHOWING RESULTANT' : 'SHOW RESULTANT'}
                        </button>
                        <button
                           onClick={reset}
                           className="w-full py-2 bg-slate-900 text-white rounded-lg text-[10px] font-bold"
                        >
                           ‚Ü∫ RESET ALL FORCES
                        </button>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-blue-50 rounded-2xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>Vector Addition:</strong> Forces in the same direction add up.
                        Forces in opposite directions subtract. In 2D, they combine to create
                        a diagonal <strong>Resultant</strong> force!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- NEWTON'S THIRD LAW RENDERER (Action/Reaction) ---
   const NewtonThirdLawRenderer = () => {
      const [scenario, setScenario] = useState<'skaters' | 'boat' | 'balloon' | 'ball'>('skaters');
      const [massA, setMassA] = useState(60); // kg
      const [massB, setMassB] = useState(80); // kg
      const [isInteracting, setIsInteracting] = useState(false);
      const [posA, setPosA] = useState(0);
      const [posB, setPosB] = useState(0);
      const [velA, setVelA] = useState(0);
      const [velB, setVelB] = useState(0);
      const [showVectors, setShowVectors] = useState(true);

      const force = 100; // Newtons (constant for the push)

      useEffect(() => {
         let interval: any;
         if (isInteracting) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;

               if (elapsed < 0.2) { // Brief push phase
                  setVelA(-(force / massA) * elapsed * 10);
                  setVelB((force / massB) * elapsed * 10);
               } else {
                  // Coasting phase (simplified friction)
                  setVelA(v => v * 0.98);
                  setVelB(v => v * 0.98);
               }

               setPosA(p => p + velA);
               setPosB(p => p + velB);

               if (Math.abs(posA) > 200 || Math.abs(posB) > 200) {
                  setIsInteracting(false);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isInteracting, velA, velB, massA, massB]);

      const reset = () => {
         setIsInteracting(false);
         setPosA(0);
         setPosB(0);
         setVelA(0);
         setVelB(0);
      };

      return (
         <div className="w-full h-full bg-white flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 border-b border-slate-100 flex justify-between items-center">
               <div>
                  <h2 className="text-2xl font-black text-slate-900">Newton's Third Law</h2>
                  <p className="text-slate-500 text-sm font-medium">For every action, there is an equal and opposite reaction.</p>
               </div>
               <div className="flex gap-2">
                  {['skaters', 'boat', 'balloon', 'ball'].map(s => (
                     <button
                        key={s} onClick={() => { setScenario(s as any); reset(); }}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all uppercase tracking-wider ${scenario === s ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                           }`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Stage */}
               <div className="flex-1 bg-slate-50 relative flex items-center justify-center p-12">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#cbd5e1 1px, transparent 1px), linear-gradient(90deg, #cbd5e1 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-full max-w-2xl h-64 flex items-center justify-center">
                     {/* Floor/Water Line */}
                     <div className="absolute bottom-10 left-0 right-0 h-1 bg-slate-300 rounded-full" />

                     {/* Object A */}
                     <div
                        className="absolute transition-transform duration-30 flex flex-col items-center"
                        style={{ transform: `translateX(${posA}px)`, left: 'calc(50% - 60px)' }}
                     >
                        {/* Force Vector A */}
                        {isInteracting && showVectors && (
                           <div className="absolute -left-16 top-1/2 -translate-y-1/2 flex items-center">
                              <div className="w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-r-[12px] border-r-red-500" />
                              <div className="h-2 bg-red-500 w-12" />
                              <span className="absolute -top-6 left-0 text-[10px] font-black text-red-600 whitespace-nowrap">REACTION</span>
                           </div>
                        )}

                        <div className={`w-20 h-32 rounded-2xl shadow-xl flex items-center justify-center border-4 ${scenario === 'skaters' ? 'bg-blue-500 border-blue-600' :
                           scenario === 'boat' ? 'bg-amber-500 border-amber-600' :
                              scenario === 'balloon' ? 'bg-red-500 border-red-600 rounded-full' : 'bg-slate-800 border-slate-900'
                           }`}>
                           <span className="text-white font-black text-xl">{massA}</span>
                        </div>
                        <span className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Object A</span>
                     </div>

                     {/* Object B */}
                     <div
                        className="absolute transition-transform duration-30 flex flex-col items-center"
                        style={{ transform: `translateX(${posB}px)`, right: 'calc(50% - 60px)' }}
                     >
                        {/* Force Vector B */}
                        {isInteracting && showVectors && (
                           <div className="absolute -right-16 top-1/2 -translate-y-1/2 flex items-center">
                              <div className="h-2 bg-blue-500 w-12" />
                              <div className="w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-l-[12px] border-l-blue-500" />
                              <span className="absolute -top-6 right-0 text-[10px] font-black text-blue-600 whitespace-nowrap">ACTION</span>
                           </div>
                        )}

                        <div className={`w-20 h-32 rounded-2xl shadow-xl flex items-center justify-center border-4 ${scenario === 'skaters' ? 'bg-emerald-500 border-emerald-600' :
                           scenario === 'boat' ? 'bg-slate-700 border-slate-800' :
                              scenario === 'balloon' ? 'bg-slate-300 border-slate-400' : 'bg-white border-slate-200'
                           }`}>
                           <span className="text-white font-black text-xl">{massB}</span>
                        </div>
                        <span className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Object B</span>
                     </div>
                  </div>

                  {/* Interaction Button */}
                  <div className="absolute bottom-12 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsInteracting(true)}
                        disabled={isInteracting}
                        className="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-2xl hover:bg-slate-800 disabled:opacity-50 transition-all transform active:scale-95"
                     >
                        {scenario === 'skaters' ? 'PUSH OFF' : scenario === 'boat' ? 'JUMP' : scenario === 'balloon' ? 'RELEASE' : 'COLLIDE'}
                     </button>
                     <button onClick={reset} className="p-4 bg-white text-slate-400 rounded-2xl border border-slate-200 hover:text-slate-600 transition-colors">‚Ü∫</button>
                  </div>
               </div>

               {/* Controls & Analysis */}
               <div className="w-full lg:w-96 bg-white border-l border-slate-100 p-8 flex flex-col gap-10 overflow-y-auto">
                  <div className="space-y-8">
                     <div className="flex justify-between items-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>
                        <button
                           onClick={() => setShowVectors(!showVectors)}
                           className={`text-[10px] font-bold px-2 py-1 rounded ${showVectors ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-400'}`}
                        >
                           VECTORS: {showVectors ? 'ON' : 'OFF'}
                        </button>
                     </div>

                     {/* Mass Sliders */}
                     <div className="space-y-6">
                        <div className="space-y-3">
                           <div className="flex justify-between">
                              <label className="text-xs font-bold text-slate-500">Mass A (kg)</label>
                              <span className="text-xs font-black text-slate-900">{massA} kg</span>
                           </div>
                           <input
                              type="range" min="40" max="120" step="5" value={massA}
                              onChange={(e) => setMassA(Number(e.target.value))}
                              className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                        <div className="space-y-3">
                           <div className="flex justify-between">
                              <label className="text-xs font-bold text-slate-500">Mass B (kg)</label>
                              <span className="text-xs font-black text-slate-900">{massB} kg</span>
                           </div>
                           <input
                              type="range" min="40" max="120" step="5" value={massB}
                              onChange={(e) => setMassB(Number(e.target.value))}
                              className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                           />
                        </div>
                     </div>

                     {/* Real-time Data */}
                     <div className="bg-slate-50 rounded-3xl p-6 space-y-4">
                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Live Metrics</h3>
                        <div className="grid grid-cols-2 gap-4">
                           <div className="bg-white p-4 rounded-2xl border border-slate-100">
                              <p className="text-[8px] font-bold text-slate-400 uppercase">Vel A</p>
                              <p className="text-lg font-black text-blue-600">{Math.abs(velA).toFixed(2)} <span className="text-[10px]">m/s</span></p>
                           </div>
                           <div className="bg-white p-4 rounded-2xl border border-slate-100">
                              <p className="text-[8px] font-bold text-slate-400 uppercase">Vel B</p>
                              <p className="text-lg font-black text-emerald-600">{Math.abs(velB).toFixed(2)} <span className="text-[10px]">m/s</span></p>
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Insight Panel */}
                  <div className="mt-auto space-y-4">
                     <div className="p-5 bg-indigo-50 rounded-3xl border border-indigo-100">
                        <div className="flex gap-3 mb-2">
                           <span className="text-indigo-600 text-lg">üß†</span>
                           <h4 className="text-xs font-black text-indigo-900 uppercase tracking-tight">The Core Insight</h4>
                        </div>
                        <p className="text-xs text-indigo-800 leading-relaxed">
                           Notice that the <strong>Forces</strong> are always identical in size but opposite in direction.
                           However, the <strong>Result</strong> (velocity) depends on mass. Lighter objects move faster!
                        </p>
                     </div>

                     <div className="p-5 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-2">Did you know?</p>
                        <p className="text-[10px] leading-relaxed opacity-80">
                           When you walk, you push the Earth backward, and the Earth pushes you forward.
                           Because Earth is so massive, you don't notice it moving!
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ADVANCED FORCE LAB RENDERER (F=ma Experiments) ---
   const AdvancedForceLabRenderer = () => {
      const [force, setForce] = useState(3); // Newtons
      const [mass, setMass] = useState(2);   // kg
      const [mode, setMode] = useState<'exp1' | 'exp2' | 'free'>('free');
      const [isLaunching, setIsLaunching] = useState(false);
      const [position, setPosition] = useState(0);
      const [velocity, setVelocity] = useState(0);
      const [history, setHistory] = useState<{ t: number, v: number }[]>([]);
      const [experiments, setExperiments] = useState<{ f: number, m: number, a: number }[]>([]);
      const [prediction, setPrediction] = useState<number | null>(null);
      const [showPattern, setShowPattern] = useState(false);
      const [equation, setEquation] = useState<string[]>([]);

      const acceleration = force / mass;
      const targetAccel = 3.0; // For challenge/prediction

      useEffect(() => {
         let interval: any;
         if (isLaunching) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;
               const newVel = acceleration * elapsed;
               const newPos = 0.5 * acceleration * elapsed * elapsed * 50; // scaled for pixels

               setVelocity(newVel);
               setPosition(newPos);
               setHistory(prev => [...prev.slice(-40), { t: elapsed, v: newVel }]);

               if (newPos > 400) {
                  setIsLaunching(false);
                  setExperiments(prev => [...prev, { f: force, m: mass, a: acceleration }]);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isLaunching, acceleration, force, mass]);

      const resetLaunch = () => {
         setIsLaunching(false);
         setPosition(0);
         setVelocity(0);
         setHistory([]);
      };

      const checkPattern = () => {
         if (experiments.length >= 3) {
            setShowPattern(true);
            setTimeout(() => setShowPattern(false), 5000);
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900 tracking-tight">Newton's Second Law Lab</h2>
                  <div className="flex gap-4 mt-1">
                     <button onClick={() => { setMode('exp1'); setMass(2); setExperiments([]); }} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'exp1' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'}`}>EXP 1: VARY FORCE</button>
                     <button onClick={() => { setMode('exp2'); setForce(4); setExperiments([]); }} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'exp2' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-500'}`}>EXP 2: VARY MASS</button>
                     <button onClick={() => setMode('free')} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'free' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-500'}`}>FREE EXPLORATION</button>
                  </div>
               </div>
               <div className="flex gap-3">
                  <div className="bg-slate-900 text-white px-4 py-2 rounded-xl flex flex-col items-center min-w-[80px]">
                     <span className="text-[8px] font-bold opacity-50 uppercase">Acceleration</span>
                     <span className="text-lg font-black">{acceleration.toFixed(2)} <span className="text-[10px]">m/s¬≤</span></span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Main Lab Area */}
               <div className="flex-1 p-6 flex flex-col gap-6 overflow-y-auto">
                  {/* The Track */}
                  <div className="relative h-48 bg-white rounded-3xl border-2 border-slate-200 shadow-inner overflow-hidden flex items-end p-4">
                     <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '20px 20px' }} />

                     {/* Start Line */}
                     <div className="absolute left-10 bottom-0 top-0 w-1 bg-slate-100" />

                     {/* The Cart */}
                     <div
                        className="relative transition-transform duration-30"
                        style={{ transform: `translateX(${position}px)`, left: '40px' }}
                     >
                        {/* Force Arrow */}
                        {force > 0 && !isLaunching && (
                           <div className="absolute -left-12 top-4 flex items-center">
                              <div className="h-1 bg-amber-500" style={{ width: `${force * 10}px` }} />
                              <div className="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[8px] border-l-amber-500" />
                           </div>
                        )}

                        {/* Cart Body */}
                        <div className="w-24 h-12 bg-slate-800 rounded-lg relative flex items-center justify-center">
                           <div className="text-white font-bold text-xs">{mass}kg</div>
                           {/* Wheels */}
                           <div className="absolute -bottom-2 left-2 w-4 h-4 bg-slate-900 rounded-full border-2 border-slate-700" />
                           <div className="absolute -bottom-2 right-2 w-4 h-4 bg-slate-900 rounded-full border-2 border-slate-700" />

                           {/* Mass Blocks */}
                           <div className="absolute -top-4 left-2 right-2 flex gap-1 justify-center">
                              {Array.from({ length: mass }).map((_, i) => (
                                 <div key={i} className="w-4 h-4 bg-slate-400 rounded-sm border border-slate-500" />
                              ))}
                           </div>
                        </div>
                     </div>

                     {/* Finish Line */}
                     <div className="absolute left-[440px] bottom-0 top-0 w-4 bg-checkered" style={{ backgroundImage: 'linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000)', backgroundSize: '10px 10px', backgroundPosition: '0 0, 5px 5px' }} />
                  </div>

                  {/* Controls & Graphs */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                     {/* Controls */}
                     <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-6">
                        <div className="flex justify-between items-center">
                           <h3 className="font-bold text-slate-900">Lab Settings</h3>
                           <button onClick={resetLaunch} className="text-[10px] font-bold text-slate-400 hover:text-slate-600">‚Ü∫ RESET</button>
                        </div>

                        {/* Force Slider */}
                        <div className="space-y-3">
                           <div className="flex justify-between items-end">
                              <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Applied Force (N)</label>
                              <span className="text-xl font-black text-amber-600">{force}N</span>
                           </div>
                           <div className="relative h-8 flex items-center">
                              <div className="absolute left-0 right-0 h-1 bg-slate-100 rounded-full" />
                              <input
                                 type="range" min="1" max="10" step="1" value={force}
                                 disabled={mode === 'exp2' || isLaunching}
                                 onChange={(e) => setForce(Number(e.target.value))}
                                 className="absolute w-full h-1 bg-transparent appearance-none cursor-pointer accent-amber-500 z-10"
                              />
                              {/* Spring Visual */}
                              <div className="absolute left-0 h-4 border-l-2 border-slate-300 flex items-center opacity-20 pointer-events-none" style={{ width: `${force * 10}%` }}>
                                 <svg className="w-full h-full" preserveAspectRatio="none">
                                    <path d="M 0 8 Q 5 0 10 8 Q 15 16 20 8" fill="none" stroke="currentColor" strokeWidth="1" />
                                 </svg>
                              </div>
                           </div>
                        </div>

                        {/* Mass Controls */}
                        <div className="space-y-3">
                           <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Object Mass (kg)</label>
                           <div className="flex items-center gap-4">
                              <button
                                 disabled={mode === 'exp1' || mass <= 1 || isLaunching}
                                 onClick={() => setMass(m => m - 1)}
                                 className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center font-bold text-slate-600 hover:bg-slate-200 disabled:opacity-30"
                              >‚Äì</button>
                              <div className="flex-1 h-12 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-center font-black text-xl text-slate-800">
                                 {mass} kg
                              </div>
                              <button
                                 disabled={mode === 'exp1' || mass >= 8 || isLaunching}
                                 onClick={() => setMass(m => m + 1)}
                                 className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center font-bold text-slate-600 hover:bg-slate-200 disabled:opacity-30"
                              >+</button>
                           </div>
                        </div>

                        <button
                           onClick={() => setIsLaunching(true)}
                           disabled={isLaunching}
                           className={`w-full py-4 rounded-2xl font-black text-lg shadow-lg transition-all transform active:scale-95 ${isLaunching ? 'bg-slate-100 text-slate-400' : 'bg-slate-900 text-white hover:bg-slate-800'
                              }`}
                        >
                           {isLaunching ? 'LAUNCHING...' : 'üöÄ LAUNCH CART'}
                        </button>
                     </div>

                     {/* Velocity Graph */}
                     <div className="bg-slate-900 p-6 rounded-3xl shadow-xl flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                           <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">Velocity vs. Time</h3>
                           <div className="text-emerald-400 font-mono text-xs">Slope = {acceleration.toFixed(2)}</div>
                        </div>
                        <div className="flex-1 relative border-l border-b border-slate-700">
                           <svg className="w-full h-full overflow-visible">
                              {/* Grid Lines */}
                              {[0, 25, 50, 75, 100].map(p => (
                                 <line key={p} x1="0" y1={`${p}%`} x2="100%" y2={`${p}%`} stroke="#1e293b" strokeWidth="1" />
                              ))}
                              {/* Data Path */}
                              <polyline
                                 points={history.map((h, i) => `${(i / 40) * 100}%, ${100 - (h.v * 5)}%`).join(' ')}
                                 fill="none" stroke="#10b981" strokeWidth="3" strokeLinecap="round"
                              />
                           </svg>
                           <div className="absolute bottom-[-20px] left-1/2 -translate-x-1/2 text-[8px] text-slate-500 font-bold">TIME (s)</div>
                           <div className="absolute left-[-30px] top-1/2 -rotate-90 -translate-y-1/2 text-[8px] text-slate-500 font-bold">VELOCITY (m/s)</div>
                        </div>
                     </div>
                  </div>

                  {/* Data Table */}
                  <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                     <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Experimental Data</h3>
                        <button onClick={() => setExperiments([])} className="text-[10px] font-bold text-slate-400">CLEAR ALL</button>
                     </div>
                     <div className="overflow-x-auto">
                        <table className="w-full text-left">
                           <thead>
                              <tr className="text-[10px] font-bold text-slate-400 uppercase border-b border-slate-100">
                                 <th className="px-6 py-3">Trial</th>
                                 <th className="px-6 py-3">Force (N)</th>
                                 <th className="px-6 py-3">Mass (kg)</th>
                                 <th className="px-6 py-3">Accel (m/s¬≤)</th>
                                 <th className="px-6 py-3">Status</th>
                              </tr>
                           </thead>
                           <tbody className="text-sm">
                              {experiments.map((exp, i) => (
                                 <tr key={i} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                    <td className="px-6 py-3 font-bold text-slate-400">#{i + 1}</td>
                                    <td className="px-6 py-3 font-black text-amber-600">{exp.f}N</td>
                                    <td className="px-6 py-3 font-black text-slate-700">{exp.m}kg</td>
                                    <td className="px-6 py-3 font-black text-blue-600">{exp.a.toFixed(2)}</td>
                                    <td className="px-6 py-3">
                                       <span className="px-2 py-1 bg-green-100 text-green-700 rounded-md text-[10px] font-bold">RECORDED</span>
                                    </td>
                                 </tr>
                              ))}
                              {experiments.length === 0 && (
                                 <tr>
                                    <td colSpan={5} className="px-6 py-8 text-center text-slate-400 italic text-xs">No data recorded yet. Launch the cart to capture data!</td>
                                 </tr>
                              )}
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>

               {/* Sidebar Analysis */}
               <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Analysis & Discovery</p>

                     {/* Discovery Sequence */}
                     <div className="space-y-4">
                        <div className="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                           <p className="text-xs font-bold text-blue-900 mb-2">Current Goal:</p>
                           <p className="text-xs text-blue-800 leading-relaxed">
                              {mode === 'exp1' ? "Keep Mass at 2kg. Change Force to 2N, 4N, and 6N. What happens to acceleration?" :
                                 mode === 'exp2' ? "Keep Force at 4N. Change Mass to 1kg, 2kg, and 4kg. What happens to acceleration?" :
                                    "Explore freely! Can you find a combination that gives exactly 5.0 m/s¬≤ acceleration?"}
                           </p>
                        </div>

                        {experiments.length >= 3 && (
                           <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 animate-in fade-in slide-in-from-bottom-2">
                              <div className="flex gap-2 mb-2">
                                 <span className="text-emerald-600">‚ú®</span>
                                 <p className="text-xs font-bold text-emerald-900">Pattern Detected!</p>
                              </div>
                              <p className="text-[10px] text-emerald-800 leading-relaxed">
                                 {mode === 'exp1' ? "Notice that as Force doubles, Acceleration also doubles! They are directly proportional." :
                                    mode === 'exp2' ? "Notice that as Mass doubles, Acceleration is cut in half! They are inversely proportional." :
                                       "You've collected enough data to build the equation. Try the Equation Builder below!"}
                              </p>
                           </div>
                        )}
                     </div>

                     {/* Equation Builder */}
                     <div className="space-y-4">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Equation Builder</p>
                        <div className="flex flex-wrap gap-2 p-4 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[60px] items-center justify-center">
                           {equation.map((tile, i) => (
                              <button
                                 key={i} onClick={() => setEquation(prev => prev.filter((_, idx) => idx !== i))}
                                 className="px-3 py-2 bg-white border border-slate-300 rounded-lg font-black text-sm shadow-sm hover:bg-red-50 hover:border-red-200 transition-colors"
                              >{tile}</button>
                           ))}
                           {equation.length === 0 && <span className="text-[10px] text-slate-400">Drag or click tiles to build the rule</span>}
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center">
                           {['F', '=', 'm', '√ó', 'a', '√∑'].map(tile => (
                              <button
                                 key={tile} onClick={() => setEquation(prev => [...prev, tile])}
                                 className="px-3 py-2 bg-slate-100 rounded-lg font-black text-sm hover:bg-slate-200 transition-colors"
                              >{tile}</button>
                           ))}
                        </div>
                        {equation.join('') === 'F=m√óa' && (
                           <div className="p-3 bg-green-500 text-white rounded-xl text-center font-bold text-xs animate-bounce">
                              CORRECT! F = ma
                           </div>
                        )}
                     </div>
                  </div>

                  <div className="mt-auto p-4 bg-amber-50 rounded-2xl border border-amber-100">
                     <div className="flex gap-3">
                        <div className="text-amber-600 text-lg">üí°</div>
                        <p className="text-[10px] text-amber-800 leading-relaxed font-medium">
                           <strong>The Big Idea:</strong> Force is a "push" that causes acceleration.
                           Mass is "laziness" (inertia) that resists acceleration.
                           The more force you apply, the more it speeds up!
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GAS LAW RENDERER (PV=nRT) ---
   // Stage 1: Core insight = Pressure, Volume, and Temperature are interconnected.
   // Stage 2: Primary = Piston (Volume), Secondary = Heat Source (Temperature).
   // Stage 3: Drag piston to change Volume; Slider for Temperature.
   // Stage 4: Real-time Pressure gauge and particle collision visualization.
   // Stage 5: State (volume, temp) -> Derived (pressure).
   // Stage 6: Challenge = "Reach 5.0 atm Pressure".
   const GasLawRenderer = () => {
      const [volume, setVolume] = useState(200); // px height
      const [temp, setTemp] = useState(300);     // Kelvin
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number }[]>([]);
      const [challengeMode, setChallengeMode] = useState(false);

      const pressure = (temp / volume) * 2; // Simplified Ideal Gas Law
      const isChallengeMet = challengeMode && pressure >= 4.9 && pressure <= 5.1;

      useEffect(() => {
         const newParticles = Array.from({ length: 20 }).map(() => ({
            x: Math.random() * 200,
            y: Math.random() * volume,
            vx: (Math.random() - 0.5) * (temp / 50),
            vy: (Math.random() - 0.5) * (temp / 50)
         }));
         setParticles(newParticles);
      }, []);

      useEffect(() => {
         const interval = setInterval(() => {
            setParticles(prev => prev.map(p => {
               let { x, y, vx, vy } = p;
               x += vx;
               y += vy;
               if (x < 0 || x > 200) vx *= -1;
               if (y < 0 || y > volume) vy *= -1;
               return { x, y, vx, vy };
            }));
         }, 30);
         return () => clearInterval(interval);
      }, [volume, temp]);

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Gas Law Lab</h2>
                     <p className="text-slate-500 text-sm">Ideal Gas Law: PV = nRT</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Reach 5.0 atm Pressure</p>
                           <p className="text-xs opacity-80">Adjust Volume and Temperature to hit exactly 5.0 atm.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden items-center justify-center">
                  {/* The Container */}
                  <div className="relative w-[210px] bg-white border-4 border-slate-300 border-t-0 rounded-b-xl overflow-hidden" style={{ height: '250px' }}>
                     {/* The Piston */}
                     <div
                        className="absolute w-full bg-slate-400 border-b-4 border-slate-500 flex items-center justify-center cursor-ns-resize shadow-lg z-10"
                        style={{ height: '20px', top: `${250 - volume - 20}px` }}
                        onMouseDown={(e) => {
                           const startY = e.clientY;
                           const startVol = volume;
                           const handleMove = (moveEvent: MouseEvent) => {
                              const delta = startY - moveEvent.clientY;
                              setVolume(Math.max(50, Math.min(230, startVol + delta)));
                           };
                           const handleUp = () => {
                              window.removeEventListener('mousemove', handleMove);
                              window.removeEventListener('mouseup', handleUp);
                           };
                           window.addEventListener('mousemove', handleMove);
                           window.addEventListener('mouseup', handleUp);
                        }}
                     >
                        <div className="w-12 h-1 bg-slate-300 rounded-full" />
                     </div>

                     {/* Particles */}
                     <svg className="w-full h-full">
                        {particles.map((p, i) => (
                           <circle
                              key={i} cx={p.x} cy={250 - p.y} r="3"
                              fill={temp > 400 ? '#ef4444' : temp < 200 ? '#3b82f6' : '#94a3b8'}
                              className="transition-colors duration-500"
                           />
                        ))}
                     </svg>
                  </div>

                  {/* Pressure Gauge */}
                  <div className="absolute top-4 right-4 bg-white p-4 rounded-2xl shadow-xl border border-slate-100 flex flex-col items-center">
                     <div className="text-3xl font-black text-slate-900">{pressure.toFixed(1)}</div>
                     <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pressure (atm)</div>
                     <div className="w-full h-1 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-red-500 transition-all duration-300" style={{ width: `${Math.min(100, pressure * 10)}%` }} />
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{volume}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Volume (V)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-amber-400">{temp}K</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Temp (T)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-emerald-400">{pressure.toFixed(2)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Pressure (P)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Temperature (K)</label>
                        <span className="text-[10px] font-bold text-amber-600">{temp} K</span>
                     </div>
                     <input
                        type="range" min="100" max="600" step="10" value={temp}
                        onChange={(e) => setTemp(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
                     />
                  </div>

                  <div className="p-4 bg-white rounded-xl border border-slate-200">
                     <p className="text-[10px] font-bold text-slate-500 uppercase mb-2">Instructions</p>
                     <p className="text-[10px] text-slate-600 leading-relaxed">
                        Drag the <strong>Piston</strong> up and down to change volume.
                        Use the slider to change <strong>Temperature</strong>.
                        Watch how the particles speed up and hit the walls harder!
                     </p>
                  </div>

                  <button
                     onClick={() => { setVolume(200); setTemp(300); }}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET LAB
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Pressure is caused by gas particles
                        colliding with the walls. If you decrease <strong>Volume</strong>,
                        they hit the walls more often. If you increase <strong>Temperature</strong>,
                        they hit the walls harder!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- EQUATION BALANCER RENDERER (Chemical Equations) ---
   // Stage 1: Core insight = Matter is conserved; atoms on the left must equal atoms on the right.
   // Stage 2: Primary = Coefficients, Secondary = Visual Atom Count.
   // Stage 3: Click arrows to change coefficients.
   // Stage 4: Real-time atom count comparison (Left vs Right).
   // Stage 5: State (coefficients) -> Derived (atom counts, balance status).
   // Stage 6: Challenge = "Balance the Combustion of Methane".
   const EquationBalancerRenderer = () => {
      const [coeffs, setCoeffs] = useState([1, 1, 1, 1]); // CH4 + O2 -> CO2 + H2O
      const [challengeMode, setChallengeMode] = useState(false);

      const reactants = [
         { name: 'CH‚ÇÑ', atoms: { C: 1, H: 4 } },
         { name: 'O‚ÇÇ', atoms: { O: 2 } }
      ];
      const products = [
         { name: 'CO‚ÇÇ', atoms: { C: 1, O: 2 } },
         { name: 'H‚ÇÇO', atoms: { H: 2, O: 1 } }
      ];

      const leftAtoms = {
         C: coeffs[0] * reactants[0].atoms.C,
         H: coeffs[0] * reactants[0].atoms.H,
         O: coeffs[1] * reactants[1].atoms.O
      };

      const rightAtoms = {
         C: coeffs[2] * products[0].atoms.C,
         H: coeffs[3] * products[1].atoms.H,
         O: coeffs[2] * products[0].atoms.O + coeffs[3] * products[1].atoms.O
      };

      const isBalanced = leftAtoms.C === rightAtoms.C &&
         leftAtoms.H === rightAtoms.H &&
         leftAtoms.O === rightAtoms.O;

      const isChallengeMet = challengeMode && isBalanced && coeffs.some(c => c > 1);

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Equation Balancer</h2>
                     <p className="text-slate-500 text-sm">Law of Conservation of Mass</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Balance Methane Combustion</p>
                           <p className="text-xs opacity-80">Adjust coefficients until C, H, and O atoms match on both sides.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden justify-center">
                  {/* The Equation */}
                  <div className="flex items-center justify-center gap-4 text-2xl font-bold flex-wrap">
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0] + 1, coeffs[1], coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-blue-600 w-8 text-center">{coeffs[0]}</span>
                           <button onClick={() => setCoeffs([Math.max(1, coeffs[0] - 1), coeffs[1], coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>CH‚ÇÑ</span>
                     </div>
                     <span className="text-slate-300">+</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1] + 1, coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-blue-600 w-8 text-center">{coeffs[1]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], Math.max(1, coeffs[1] - 1), coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>O‚ÇÇ</span>
                     </div>
                     <span className="text-slate-400 mx-4">‚Üí</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2] + 1, coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-emerald-600 w-8 text-center">{coeffs[2]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], Math.max(1, coeffs[2] - 1), coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>CO‚ÇÇ</span>
                     </div>
                     <span className="text-slate-300">+</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2], coeffs[3] + 1])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-emerald-600 w-8 text-center">{coeffs[3]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2], Math.max(1, coeffs[3] - 1)])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>H‚ÇÇO</span>
                     </div>
                  </div>

                  {/* Atom Count Comparison */}
                  <div className="mt-12 grid grid-cols-3 gap-8 max-w-md mx-auto w-full">
                     {['C', 'H', 'O'].map(atom => (
                        <div key={atom} className="flex flex-col items-center gap-2">
                           <div className="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold">{atom}</div>
                           <div className="flex items-center gap-3 text-lg font-black">
                              <span className={leftAtoms[atom as keyof typeof leftAtoms] === rightAtoms[atom as keyof typeof rightAtoms] ? 'text-emerald-500' : 'text-red-500'}>
                                 {leftAtoms[atom as keyof typeof leftAtoms]}
                              </span>
                              <span className="text-slate-300">|</span>
                              <span className={leftAtoms[atom as keyof typeof leftAtoms] === rightAtoms[atom as keyof typeof rightAtoms] ? 'text-emerald-500' : 'text-red-500'}>
                                 {rightAtoms[atom as keyof typeof rightAtoms]}
                              </span>
                           </div>
                        </div>
                     ))}
                  </div>

                  {isBalanced && (
                     <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                        <div className="text-8xl font-black text-emerald-500/10 rotate-12">BALANCED</div>
                     </div>
                  )}
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-8 shadow-xl">
                  <div className={`text-xl font-black transition-all ${isBalanced ? 'text-emerald-400' : 'text-slate-500'}`}>
                     {isBalanced ? '‚úì EQUATION BALANCED' : '‚ö† EQUATION UNBALANCED'}
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Balancer Controls</p>

                  <div className="p-4 bg-white rounded-xl border border-slate-200 space-y-3">
                     <p className="text-[10px] font-bold text-slate-500 uppercase">Reactants (Left)</p>
                     <div className="text-xs text-slate-600">
                        Carbon: {leftAtoms.C}<br />
                        Hydrogen: {leftAtoms.H}<br />
                        Oxygen: {leftAtoms.O}
                     </div>
                  </div>

                  <div className="p-4 bg-white rounded-xl border border-slate-200 space-y-3">
                     <p className="text-[10px] font-bold text-slate-500 uppercase">Products (Right)</p>
                     <div className="text-xs text-slate-600">
                        Carbon: {rightAtoms.C}<br />
                        Hydrogen: {rightAtoms.H}<br />
                        Oxygen: {rightAtoms.O}
                     </div>
                  </div>

                  <button
                     onClick={() => setCoeffs([1, 1, 1, 1])}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET COEFFICIENTS
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                  <div className="flex gap-3">
                     <div className="text-emerald-600 text-lg">üí°</div>
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Atoms are never created or destroyed in a
                        chemical reaction‚Äîthey just get rearranged! Balancing ensures that
                        every atom that goes in comes out in a new molecule.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ATOMIC BUILDER RENDERER (Atomic Structure) ---
   // Stage 1: Core insight = Protons define the element; Electrons define charge; Neutrons define stability.
   // Stage 2: Primary = Nucleus (P+N), Secondary = Electron Shells.
   // Stage 3: Add/Remove particles to build atoms.
   // Stage 4: Real-time Element Name, Atomic Number, Mass Number, and Charge.
   // Stage 5: State (protons, neutrons, electrons) -> Derived (element, charge, stability).
   // Stage 6: Challenge = "Build Carbon-12".
   const AtomicBuilderRenderer = () => {
      const [protons, setProtons] = useState(1);
      const [neutrons, setNeutrons] = useState(0);
      const [electrons, setElectrons] = useState(1);
      const [challengeMode, setChallengeMode] = useState(false);

      const elements = [
         { symbol: 'H', name: 'Hydrogen', p: 1 },
         { symbol: 'He', name: 'Helium', p: 2 },
         { symbol: 'Li', name: 'Lithium', p: 3 },
         { symbol: 'Be', name: 'Beryllium', p: 4 },
         { symbol: 'B', name: 'Boron', p: 5 },
         { symbol: 'C', name: 'Carbon', p: 6 },
         { symbol: 'N', name: 'Nitrogen', p: 7 },
         { symbol: 'O', name: 'Oxygen', p: 8 },
         { symbol: 'F', name: 'Fluorine', p: 9 },
         { symbol: 'Ne', name: 'Neon', p: 10 }
      ];

      const currentElement = elements.find(e => e.p === protons) || { symbol: '?', name: 'Unknown', p: protons };
      const massNumber = protons + neutrons;
      const charge = protons - electrons;
      const isStable = Math.abs(protons - neutrons) <= 1 || (protons === 1 && neutrons === 0);

      const isChallengeMet = challengeMode && protons === 6 && neutrons === 6 && electrons === 6;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Atomic Builder</h2>
                     <p className="text-slate-500 text-sm">Build atoms and explore the periodic table</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Build Carbon-12</p>
                           <p className="text-xs opacity-80">Add exactly 6 protons, 6 neutrons, and 6 electrons.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden items-center justify-center">
                  {/* Electron Shells */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     <div className="absolute w-full h-full border-2 border-slate-200 rounded-full" />
                     <div className="absolute w-40 h-40 border-2 border-slate-200 rounded-full" />

                     {/* Nucleus */}
                     <div className="relative w-16 h-16 flex flex-wrap items-center justify-center gap-0.5 p-2 bg-slate-200 rounded-full shadow-inner overflow-hidden">
                        {[...Array(protons)].map((_, i) => (
                           <div key={`p-${i}`} className="w-3 h-3 bg-red-500 rounded-full shadow-sm animate-pulse" />
                        ))}
                        {[...Array(neutrons)].map((_, i) => (
                           <div key={`n-${i}`} className="w-3 h-3 bg-slate-400 rounded-full shadow-sm" />
                        ))}
                     </div>

                     {/* Electrons */}
                     {[...Array(electrons)].map((_, i) => {
                        const angle = (i * 360) / electrons;
                        const radius = i < 2 ? 80 : 128; // Shell 1 or 2
                        return (
                           <div
                              key={`e-${i}`}
                              className="absolute w-3 h-3 bg-blue-400 rounded-full shadow-lg transition-all duration-500"
                              style={{
                                 transform: `rotate(${angle}deg) translateY(-${radius / 2}px)`
                              }}
                           />
                        );
                     })}
                  </div>

                  {/* Info Overlay */}
                  <div className="absolute top-4 right-4 bg-white p-4 rounded-2xl shadow-xl border border-slate-100 flex flex-col items-center min-w-[100px]">
                     <div className="text-4xl font-black text-slate-900">{currentElement.symbol}</div>
                     <div className="text-[10px] font-bold text-slate-400 uppercase">{currentElement.name}</div>
                     <div className="mt-2 flex gap-4 border-t border-slate-100 pt-2 w-full justify-center">
                        <div className="text-center">
                           <div className="text-xs font-bold text-slate-800">{protons}</div>
                           <div className="text-[8px] text-slate-400 uppercase">Atomic #</div>
                        </div>
                        <div className="text-center">
                           <div className="text-xs font-bold text-slate-800">{massNumber}</div>
                           <div className="text-[8px] text-slate-400 uppercase">Mass #</div>
                        </div>
                     </div>
                  </div>

                  {/* Stability & Charge Indicators */}
                  <div className="absolute bottom-4 left-4 flex gap-2">
                     <div className={`px-3 py-1 rounded-full text-[10px] font-bold ${isStable ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                        }`}>
                        {isStable ? 'STABLE' : 'UNSTABLE'}
                     </div>
                     <div className={`px-3 py-1 rounded-full text-[10px] font-bold ${charge === 0 ? 'bg-slate-100 text-slate-700' : charge > 0 ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'
                        }`}>
                        {charge === 0 ? 'NEUTRAL' : charge > 0 ? `ION (+${charge})` : `ION (${charge})`}
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-red-400">{protons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Protons (+)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-slate-400">{neutrons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Neutrons (0)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{electrons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Electrons (-)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Particle Controls</p>

                  <div className="space-y-4">
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Protons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setProtons(Math.max(1, protons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setProtons(Math.min(10, protons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Neutrons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setNeutrons(Math.max(0, neutrons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setNeutrons(Math.min(12, neutrons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Electrons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setElectrons(Math.max(0, electrons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setElectrons(Math.min(10, electrons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                  </div>

                  <button
                     onClick={() => { setProtons(1); setNeutrons(0); setElectrons(1); }}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET ATOM
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-red-50 rounded-xl border border-red-100">
                  <div className="flex gap-3">
                     <div className="text-red-600 text-lg">üí°</div>
                     <p className="text-[10px] text-red-800 leading-relaxed">
                        <strong>The Big Idea:</strong> The number of <strong>Protons</strong> determines
                        which element you have. <strong>Neutrons</strong> act like "glue" to keep
                        the nucleus stable. <strong>Electrons</strong> orbit the nucleus and
                        determine the atom's charge!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENERGY COASTER RENDERER (PE/KE Conservation) ---
   // Stage 1: Core insight = Energy transforms between PE and KE but total is conserved.
   // Stage 2: Primary = Track Shape (Hill Heights), Secondary = Friction.
   // Stage 3: Drag points on the track to change hill heights.
   // Stage 4: Real-time energy bars (PE, KE, Heat).
   // Stage 5: State (track points, friction) -> Derived (velocity, energy).
   // Stage 6: Challenge = "Make it to the end".
   const EnergyCoasterRenderer = () => {
      const [points, setPoints] = useState([
         { x: 0, y: 50 },
         { x: 100, y: 200 },
         { x: 200, y: 100 },
         { x: 300, y: 200 }
      ]);
      const [friction, setFriction] = useState(0.02);
      const [isPlaying, setIsPlaying] = useState(false);
      const [progress, setProgress] = useState(0); // 0 to 1
      const [velocity, setVelocity] = useState(0);
      const [ke, setKe] = useState(0);
      const [pe, setPe] = useState(0);
      const [heat, setHeat] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);

      const getTrackY = (x: number) => {
         // Simple linear interpolation for the track
         for (let i = 0; i < points.length - 1; i++) {
            if (x >= points[i].x && x <= points[i + 1].x) {
               const t = (x - points[i].x) / (points[i + 1].x - points[i].x);
               return points[i].y + t * (points[i + 1].y - points[i].y);
            }
         }
         return points[points.length - 1].y;
      };

      useEffect(() => {
         let interval: any;
         if (isPlaying) {
            interval = setInterval(() => {
               setProgress(p => {
                  const nextP = p + 0.005;
                  if (nextP >= 1) {
                     setIsPlaying(false);
                     return 1;
                  }

                  const currentX = p * 300;
                  const nextX = nextP * 300;
                  const currentY = getTrackY(currentX);
                  const nextY = getTrackY(nextX);

                  // Physics: PE = mgh, KE = 1/2 mv^2
                  // For simplicity, m=1, g=10
                  const currentPE = (250 - currentY) * 0.1;
                  const nextPE = (250 - nextY) * 0.1;

                  // Energy conservation: PE_start = PE_now + KE_now + Heat
                  const startPE = (250 - points[0].y) * 0.1;
                  const currentHeat = heat + (friction * 0.5);
                  const currentKE = Math.max(0, startPE - currentPE - currentHeat);

                  setPe(currentPE);
                  setKe(currentKE);
                  setHeat(currentHeat);
                  setVelocity(Math.sqrt(2 * currentKE));

                  if (currentKE <= 0 && p > 0.05) {
                     setIsPlaying(false);
                     return p;
                  }

                  return nextP;
               });
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isPlaying, points, friction, heat]);

      const reset = () => {
         setProgress(0);
         setVelocity(0);
         setKe(0);
         setPe((250 - points[0].y) * 0.1);
         setHeat(0);
         setIsPlaying(false);
      };

      const isChallengeMet = challengeMode && progress > 0.98;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Energy Coaster</h2>
                     <p className="text-slate-500 text-sm">Conservation of Energy: PE + KE = Total</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Reach the End</p>
                           <p className="text-xs opacity-80">Design the hills so the cart has enough energy to reach the finish line.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  <svg className="w-full h-full" viewBox="0 0 300 250">
                     {/* Track Path */}
                     <path
                        d={`M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`}
                        fill="none" stroke="#cbd5e1" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round"
                     />
                     <path
                        d={`M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`}
                        fill="none" stroke="#94a3b8" strokeWidth="2" strokeDasharray="4 4"
                     />

                     {/* The Cart */}
                     <g transform={`translate(${progress * 300}, ${getTrackY(progress * 300)})`}>
                        <rect x="-10" y="-15" width="20" height="12" rx="2" fill="#ef4444" className="shadow-lg" />
                        <circle cx="-6" cy="-2" r="3" fill="#1e293b" />
                        <circle cx="6" cy="-2" r="3" fill="#1e293b" />
                     </g>

                     {/* Draggable Points */}
                     {points.map((p, i) => (
                        <circle
                           key={i} cx={p.x} cy={p.y} r="6"
                           fill="white" stroke="#3b82f6" strokeWidth="2"
                           className="cursor-ns-resize shadow-sm"
                           onMouseDown={(e) => {
                              const handleMove = (moveEvent: MouseEvent) => {
                                 const svg = (e.target as any).ownerSVGElement;
                                 const pt = svg.createSVGPoint();
                                 pt.x = moveEvent.clientX;
                                 pt.y = moveEvent.clientY;
                                 const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                                 const newPoints = [...points];
                                 newPoints[i] = { ...newPoints[i], y: Math.max(20, Math.min(230, svgP.y)) };
                                 setPoints(newPoints);
                              };
                              const handleUp = () => {
                                 window.removeEventListener('mousemove', handleMove);
                                 window.removeEventListener('mouseup', handleUp);
                              };
                              window.addEventListener('mousemove', handleMove);
                              window.addEventListener('mouseup', handleUp);
                           }}
                        />
                     ))}
                  </svg>

                  {/* Energy Bars */}
                  <div className="absolute bottom-4 left-4 right-4 flex flex-col gap-2">
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">PE</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-blue-500 transition-all duration-50" style={{ width: `${Math.min(100, pe * 4)}%` }} />
                        </div>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">KE</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-emerald-500 transition-all duration-50" style={{ width: `${Math.min(100, ke * 4)}%` }} />
                        </div>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">HEAT</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-orange-500 transition-all duration-50" style={{ width: `${Math.min(100, heat * 4)}%` }} />
                        </div>
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{pe.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Potential</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-emerald-400">{ke.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Kinetic</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-orange-400">{heat.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Heat</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-white">{(pe + ke + heat).toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Coaster Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Friction</label>
                        <span className="text-[10px] font-bold text-orange-600">{(friction * 100).toFixed(0)}%</span>
                     </div>
                     <input
                        type="range" min="0" max="0.1" step="0.01" value={friction}
                        onChange={(e) => setFriction(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="flex gap-2">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${isPlaying ? 'bg-red-500 text-white shadow-lg' : 'bg-emerald-500 text-white shadow-lg'
                           }`}
                     >
                        {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ LAUNCH'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-4 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                     >
                        ‚Ü∫
                     </button>
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-blue-50 rounded-xl border border-blue-100">
                  <div className="flex gap-3">
                     <div className="text-blue-600 text-lg">üí°</div>
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Energy can't be created or destroyed.
                        As the cart goes down, <strong>Potential Energy</strong> turns into
                        <strong>Kinetic Energy</strong> (speed). Friction turns some of that
                        energy into <strong>Heat</strong>!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FORCE LAB RENDERER (Newton's Laws / F=ma) ---
   // Stage 1: Core insight = Force causes acceleration; Mass resists it.
   // Stage 2: Primary = Applied Force (Arrow), Secondary = Mass (Blocks).
   // Stage 3: Drag arrow to apply force; Slider for mass.
   // Stage 4: a = F/m; Real-time velocity-time graph.
   // Stage 5: State (force, mass) -> Derived (acceleration, velocity, position).
   // Stage 6: Challenge = "Match the Acceleration".
   const ForceLabRenderer = () => {
      const [force, setForce] = useState(150); // Newtons
      const [mass, setMass] = useState(30);   // kg
      const [friction, setFriction] = useState(0.1);
      const [velocity, setVelocity] = useState(0);
      const [position, setPosition] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [history, setHistory] = useState<{ t: number, v: number }[]>([]);
      const [challengeMode, setChallengeMode] = useState(false);
      const [targetAcc, setTargetAcc] = useState(5);

      const netForce = Math.max(0, force - (friction * mass * 9.8));
      const acceleration = netForce / mass;

      useEffect(() => {
         let interval: any;
         if (isPlaying) {
            interval = setInterval(() => {
               setVelocity(v => v + acceleration * 0.05);
               setPosition(p => (p + velocity * 0.05) % 300);
               setHistory(h => [...h.slice(-40), { t: Date.now(), v: velocity }]);
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isPlaying, acceleration, velocity]);

      const reset = () => {
         setVelocity(0);
         setPosition(0);
         setHistory([]);
         setIsPlaying(false);
      };

      const isChallengeMet = challengeMode && Math.abs(acceleration - targetAcc) < 0.2;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Force & Motion Lab</h2>
                     <p className="text-slate-500 text-sm">Newton's Second Law: F = ma</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Match Acceleration = {targetAcc} m/s¬≤</p>
                           <p className="text-xs opacity-80">Adjust Force and Mass until the acceleration is exactly {targetAcc}.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  {/* Track Area */}
                  <div className="flex-1 relative border-b-4 border-slate-300">
                     {/* The Cart */}
                     <div
                        className="absolute bottom-0 transition-all duration-50 ease-linear"
                        style={{ left: `${position}px` }}
                     >
                        <div className="relative">
                           {/* Force Arrow */}
                           <div
                              className="absolute -right-4 top-1/2 -translate-y-1/2 h-2 bg-amber-500 origin-left flex items-center"
                              style={{ width: `${force / 2}px` }}
                           >
                              <div className="absolute right-0 w-0 h-0 border-t-4 border-b-4 border-l-8 border-t-transparent border-b-transparent border-l-amber-500" />
                              <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-amber-600 whitespace-nowrap">
                                 {force} N
                              </div>
                           </div>

                           {/* Cart Body */}
                           <div
                              className="bg-slate-800 rounded-lg shadow-xl flex items-center justify-center text-white font-bold text-xs"
                              style={{
                                 width: `${40 + mass}px`,
                                 height: '40px'
                              }}
                           >
                              {mass}kg
                           </div>
                           {/* Wheels */}
                           <div className="flex justify-around px-2 mt-1">
                              <div className="w-3 h-3 bg-slate-900 rounded-full" />
                              <div className="w-3 h-3 bg-slate-900 rounded-full" />
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Velocity Graph */}
                  <div className="h-32 mt-8 bg-white rounded-xl border border-slate-200 p-4 relative">
                     <div className="absolute top-2 left-2 text-[8px] font-bold text-slate-400 uppercase">Velocity vs Time</div>
                     <svg className="w-full h-full" viewBox="0 0 200 100" preserveAspectRatio="none">
                        <path
                           d={`M ${history.map((p, i) => `${(i / 40) * 200} ${100 - (p.v * 2)}`).join(' L ')}`}
                           fill="none" stroke="#3b82f6" strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute bottom-2 right-2 text-[10px] font-bold text-blue-600">
                        v = {velocity.toFixed(1)} m/s
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-amber-400">{force}N</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Force (F)</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">√∑</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{mass}kg</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Mass (m)</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">{acceleration.toFixed(2)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Acc (m/s¬≤)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Applied Force (N)</label>
                        <span className="text-[10px] font-bold text-amber-600">{force} N</span>
                     </div>
                     <input
                        type="range" min="0" max="500" step="10" value={force}
                        onChange={(e) => setForce(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
                     />
                  </div>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Mass (kg)</label>
                        <span className="text-[10px] font-bold text-blue-600">{mass} kg</span>
                     </div>
                     <input
                        type="range" min="5" max="100" step="5" value={mass}
                        onChange={(e) => setMass(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="flex gap-2">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${isPlaying ? 'bg-red-500 text-white shadow-lg' : 'bg-emerald-500 text-white shadow-lg'
                           }`}
                     >
                        {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ START MOTION'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-4 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                     >
                        ‚Ü∫
                     </button>
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Acceleration is directly proportional
                        to <strong>Force</strong> but inversely proportional to <strong>Mass</strong>.
                        Double the mass, and you'll need double the force to keep the same acceleration!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- TRIANGLE RENDERER (Angle Sum & Side Properties) ---
   // Stage 1: Core insight = Interior angles always sum to 180¬∞.
   // Stage 2: Primary = Vertices A, B, C.
   // Stage 3: Draggable Vertices + Real-time Measurements.
   // Stage 4: ‚à†A + ‚à†B + ‚à†C = 180¬∞.
   // Stage 5: State (A, B, C) ‚Üí Derived (angles, lengths, type).
   // Stage 6: Challenge = "Create a Right Triangle".
   const TriangleRenderer = () => {
      const [pA, setPA] = useState({ x: 100, y: 50 });
      const [pB, setPB] = useState({ x: 50, y: 200 });
      const [pC, setPC] = useState({ x: 250, y: 200 });
      const [challengeMode, setChallengeMode] = useState(false);

      // Calculate side lengths
      const dist = (p1: any, p2: any) => Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
      const a = dist(pB, pC);
      const b = dist(pA, pC);
      const c = dist(pA, pB);

      // Calculate angles using Law of Cosines
      const getAngle = (s1: number, s2: number, opp: number) => {
         return Math.acos((s1 * s1 + s2 * s2 - opp * opp) / (2 * s1 * s2)) * (180 / Math.PI);
      };
      const angleA = getAngle(b, c, a);
      const angleB = getAngle(a, c, b);
      const angleC = getAngle(a, b, c);

      const isRight = Math.abs(angleA - 90) < 2 || Math.abs(angleB - 90) < 2 || Math.abs(angleC - 90) < 2;
      const isChallengeMet = challengeMode && isRight;

      const getType = () => {
         if (Math.abs(angleA - 60) < 2 && Math.abs(angleB - 60) < 2) return "Equilateral";
         if (Math.abs(angleA - angleB) < 2 || Math.abs(angleB - angleC) < 2 || Math.abs(angleA - angleC) < 2) return "Isosceles";
         if (isRight) return "Right";
         return "Scalene";
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Triangle Properties</h2>
                     <p className="text-slate-500 text-sm">Angles, sides, and types</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Create a Right Triangle</p>
                           <p className="text-xs opacity-80">Drag the corners until one angle is exactly 90¬∞.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  <svg className="w-full h-full max-w-[400px] max-h-[300px]" viewBox="0 0 300 250">
                     {/* Triangle Path */}
                     <path
                        d={`M ${pA.x} ${pA.y} L ${pB.x} ${pB.y} L ${pC.x} ${pC.y} Z`}
                        fill="#3b82f620" stroke="#3b82f6" strokeWidth="3" strokeLinejoin="round"
                     />

                     {/* Angle Labels */}
                     <text x={pA.x} y={pA.y - 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleA.toFixed(0)}¬∞</text>
                     <text x={pB.x - 20} y={pB.y + 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleB.toFixed(0)}¬∞</text>
                     <text x={pC.x + 20} y={pC.y + 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleC.toFixed(0)}¬∞</text>

                     {/* Draggable Handles */}
                     <circle cx={pA.x} cy={pA.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                     <circle cx={pB.x} cy={pB.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                     <circle cx={pC.x} cy={pC.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                  </svg>

                  <div className="absolute bottom-4 left-4 bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold text-slate-500">
                     TYPE: <span className="text-blue-600">{getType().toUpperCase()}</span>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleA.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle A</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleB.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle B</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleC.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle C</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">180¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Sum</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Adjust Vertices</p>

                  {/* Vertex A Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex A (Top)</label>
                     <input
                        type="range" min="50" max="250" step="1" value={pA.x}
                        onChange={(e) => setPA({ ...pA, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  {/* Vertex B Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex B (Left)</label>
                     <input
                        type="range" min="20" max="140" step="1" value={pB.x}
                        onChange={(e) => setPB({ ...pB, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  {/* Vertex C Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex C (Right)</label>
                     <input
                        type="range" min="160" max="280" step="1" value={pC.x}
                        onChange={(e) => setPC({ ...pC, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-blue-50 rounded-xl border border-blue-100">
                  <div className="flex gap-3">
                     <div className="text-blue-600 text-lg">üí°</div>
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> No matter how you stretch or move
                        the corners of a triangle, the <strong>three interior angles</strong>
                        will always add up to exactly <strong>180¬∞</strong>. Try it!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SORTING ALGORITHM RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Efficiency and Strategy (Iterative vs Divide & Conquer)
   // Stage 2: Primary = Step Scrubber, Secondary = Algorithm Type, Array Size
   // Stage 3: Bar chart with color-coded states (Comparing, Swapping, Sorted)
   // Stage 4: Pre-calculated steps stored as immutable states
   // Stage 5: State (currentStep, algorithm) ‚Üí Derived (array, highlights)
   // Stage 6: Challenge = "Sort in minimum steps"
   const SortingRenderer = () => {
      const [algorithm, setAlgorithm] = useState<'bubble' | 'selection'>('bubble');
      const [arraySize, setArraySize] = useState(10);
      const [currentStep, setCurrentStep] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [speed, setSpeed] = useState(500);
      const [steps, setSteps] = useState<any[]>([]);

      // Generate initial random array and pre-calculate steps
      useEffect(() => {
         const initialArray = Array.from({ length: arraySize }, () => Math.floor(Math.random() * 90) + 10);
         const newSteps: any[] = [{ array: [...initialArray], comparing: [], swapping: [], sorted: [], desc: "Initial random array" }];

         if (algorithm === 'bubble') {
            const arr = [...initialArray];
            const n = arr.length;
            for (let i = 0; i < n; i++) {
               for (let j = 0; j < n - i - 1; j++) {
                  newSteps.push({ array: [...arr], comparing: [j, j + 1], swapping: [], sorted: Array.from({ length: i }, (_, k) => n - 1 - k), desc: `Comparing ${arr[j]} and ${arr[j + 1]}` });
                  if (arr[j] > arr[j + 1]) {
                     [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
                     newSteps.push({ array: [...arr], comparing: [], swapping: [j, j + 1], sorted: Array.from({ length: i }, (_, k) => n - 1 - k), desc: `Swapping ${arr[j + 1]} and ${arr[j]}` });
                  }
               }
            }
            newSteps.push({ array: [...arr], comparing: [], swapping: [], sorted: Array.from({ length: n }, (_, k) => k), desc: "Array sorted!" });
         } else if (algorithm === 'selection') {
            const arr = [...initialArray];
            const n = arr.length;
            for (let i = 0; i < n - 1; i++) {
               let minIdx = i;
               newSteps.push({ array: [...arr], comparing: [i], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `New pass: assume index ${i} is minimum` });
               for (let j = i + 1; j < n; j++) {
                  newSteps.push({ array: [...arr], comparing: [minIdx, j], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `Comparing current min ${arr[minIdx]} with ${arr[j]}` });
                  if (arr[j] < arr[minIdx]) {
                     minIdx = j;
                     newSteps.push({ array: [...arr], comparing: [minIdx], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `New minimum found: ${arr[minIdx]}` });
                  }
               }
               if (minIdx !== i) {
                  [arr[i], arr[minIdx]] = [arr[minIdx], arr[i]];
                  newSteps.push({ array: [...arr], comparing: [], swapping: [i, minIdx], sorted: Array.from({ length: i }, (_, k) => k), desc: `Swapping ${arr[minIdx]} into position ${i}` });
               }
            }
            newSteps.push({ array: [...arr], comparing: [], swapping: [], sorted: Array.from({ length: n }, (_, k) => k), desc: "Array sorted!" });
         }

         setSteps(newSteps);
         setCurrentStep(0);
         setIsPlaying(false);
      }, [algorithm, arraySize]);

      // Playback logic
      useEffect(() => {
         if (!isPlaying) return;
         if (currentStep >= steps.length - 1) {
            setIsPlaying(false);
            return;
         }

         const timer = setTimeout(() => {
            setCurrentStep(prev => prev + 1);
         }, speed);

         return () => clearTimeout(timer);
      }, [isPlaying, currentStep, steps, speed]);

      const state = steps[currentStep] || { array: [], comparing: [], swapping: [], sorted: [], desc: "" };

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col lg:flex-row overflow-hidden text-slate-200">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-500">
                        Sorting Algorithms
                     </h2>
                     <p className="text-slate-400 text-sm">Visualize Time Complexity & Logic</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setAlgorithm('bubble')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${algorithm === 'bubble' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-400'
                           }`}
                     >
                        BUBBLE SORT
                     </button>
                     <button
                        onClick={() => setAlgorithm('selection')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${algorithm === 'selection' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-400'
                           }`}
                     >
                        SELECTION SORT
                     </button>
                  </div>
               </div>

               {/* Step Description */}
               <div className="p-4 bg-slate-800/50 rounded-xl border border-slate-700 min-h-[80px] flex items-center gap-4">
                  <div className="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-mono font-bold shrink-0">
                     {currentStep}
                  </div>
                  <p className="text-lg font-medium text-slate-200">{state.desc}</p>
               </div>

               {/* Bar Chart */}
               <div className="flex-1 bg-slate-950 rounded-2xl border border-slate-800 p-8 flex items-end justify-center gap-1 shadow-inner">
                  {state.array.map((val: number, idx: number) => {
                     let color = "bg-slate-700";
                     if (state.comparing.includes(idx)) color = "bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.5)]";
                     if (state.swapping.includes(idx)) color = "bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]";
                     if (state.sorted.includes(idx)) color = "bg-emerald-500";

                     return (
                        <div key={idx} className="flex flex-col items-center gap-2 flex-1 max-w-[40px]">
                           <span className={`text-[10px] font-mono font-bold ${state.comparing.includes(idx) || state.swapping.includes(idx) ? 'text-white' : 'text-slate-500'}`}>
                              {val}
                           </span>
                           <div
                              className={`w-full rounded-t-sm transition-all duration-200 ${color}`}
                              style={{ height: `${val * 3}px` }}
                           />
                        </div>
                     );
                  })}
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 overflow-y-auto">
               <div className="flex gap-2">
                  <button
                     onClick={() => setIsPlaying(!isPlaying)}
                     className={`flex-1 py-4 rounded-xl font-bold text-lg transition-all ${isPlaying ? 'bg-slate-800 text-slate-300' : 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20'
                        }`}
                  >
                     {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ PLAY'}
                  </button>
                  <button
                     onClick={() => { setCurrentStep(0); setIsPlaying(false); }}
                     className="px-4 bg-slate-800 rounded-xl text-slate-400 hover:text-white transition-colors"
                  >
                     <i className="fa-solid fa-rotate-right"></i>
                  </button>
               </div>

               {/* Step Scrubber - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">‚≠ê Step Scrubber</label>
                     <span className="text-sm font-mono font-bold text-emerald-400">{currentStep} / {steps.length - 1}</span>
                  </div>
                  <input
                     type="range" min="0" max={steps.length - 1} step="1" value={currentStep}
                     onChange={(e) => { setCurrentStep(Number(e.target.value)); setIsPlaying(false); }}
                     className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                  />
               </div>

               <div className="h-px bg-slate-800" />

               {/* Array Size */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Array Size</label>
                     <span className="text-sm font-mono font-bold text-slate-300">{arraySize}</span>
                  </div>
                  <input
                     type="range" min="5" max="25" step="1" value={arraySize}
                     onChange={(e) => setArraySize(Number(e.target.value))}
                     className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-slate-500"
                  />
               </div>

               {/* Speed */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Playback Speed</label>
                     <span className="text-sm font-mono font-bold text-slate-300">{speed}ms</span>
                  </div>
                  <input
                     type="range" min="50" max="1000" step="50" value={speed}
                     onChange={(e) => setSpeed(Number(e.target.value))}
                     className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-slate-500"
                  />
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                  <div className="flex gap-3">
                     <div className="text-emerald-400 text-lg">üí°</div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        <strong>Complexity:</strong> Bubble sort is O(n¬≤), meaning steps grow exponentially with array size.
                        Notice how it "bubbles" the largest element to the end in each pass.
                        Selection sort finds the minimum and places it at the start.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ELECTRIC CIRCUIT RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Ohm's Law (V = I * R). Flow depends on pressure (V) and friction (R).
   // Stage 2: Primary = Voltage, Secondary = Resistance, Circuit Type (Series/Parallel)
   // Stage 3: Schematic with animated electrons. Speed = Current.
   // Stage 4: I = V / R. Series: R = R1 + R2. Parallel: 1/R = 1/R1 + 1/R2.
   // Stage 5: State (V, R1, R2, type) ‚Üí Calculations ‚Üí Animation Speed
   // Stage 6: Challenge = "Match Current to 2.5A"
   const CircuitRenderer = () => {
      const [voltage, setVoltage] = useState(12);
      const [r1, setR1] = useState(4);
      const [r2, setR2] = useState(4);
      const [circuitType, setCircuitType] = useState<'series' | 'parallel'>('series');
      const [challengeMode, setChallengeMode] = useState(false);
      const [time, setTime] = useState(0);

      // Calculations
      const totalResistance = circuitType === 'series'
         ? r1 + r2
         : (r1 * r2) / (r1 + r2);

      const current = voltage / totalResistance; // I = V/R
      const power = voltage * current; // P = VI

      // Animation loop for electrons
      useEffect(() => {
         let animationId: number;
         const animate = () => {
            // Speed of electrons is proportional to current
            setTime(prev => prev + current * 0.05);
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [current]);

      // Challenge logic
      const targetCurrent = 2.5;
      const isChallengeMet = challengeMode && Math.abs(current - targetCurrent) < 0.1;

      // SVG path for electrons
      const renderElectrons = () => {
         const electrons = [];
         const count = 15;
         const pathLength = 800; // Approximate total length of circuit path

         for (let i = 0; i < count; i++) {
            const offset = (time * 50 + (i * pathLength / count)) % pathLength;

            // Map offset to circuit coordinates
            let x = 0, y = 0;
            if (offset < 250) { // Top wire
               x = 100 + offset; y = 50;
            } else if (offset < 400) { // Right wire
               x = 350; y = 50 + (offset - 250);
            } else if (offset < 650) { // Bottom wire
               x = 350 - (offset - 400); y = 200;
            } else { // Left wire
               x = 100; y = 200 - (offset - 650);
            }

            electrons.push(<circle key={i} cx={x} cy={y} r="3" fill="#fbbf24" className="shadow-sm" />);
         }
         return electrons;
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-800">Electric Circuits</h2>
                     <p className="text-slate-500 text-sm">Explore Ohm's Law & Circuit Topology</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setCircuitType('series')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${circuitType === 'series' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'
                           }`}
                     >
                        SERIES
                     </button>
                     <button
                        onClick={() => setCircuitType('parallel')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${circuitType === 'parallel' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'
                           }`}
                     >
                        PARALLEL
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                           <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                              }`}>
                              {isChallengeMet ? '‚úì' : 'üéØ'}
                           </div>
                           <div>
                              <p className="font-bold text-slate-800">Goal: Match Current to {targetCurrent}A</p>
                              <p className="text-xs text-slate-600">Adjust Voltage and Resistance to find the balance.</p>
                           </div>
                        </div>
                        {isChallengeMet && <div className="text-green-600 font-black animate-bounce">CHALLENGE COMPLETE!</div>}
                     </div>
                  </div>
               )}

               <div className="flex-1 bg-white rounded-2xl border border-slate-200 shadow-inner relative overflow-hidden flex items-center justify-center">
                  <svg viewBox="0 0 450 300" className="w-full h-full max-w-[500px]">
                     {/* Circuit Wires */}
                     <rect x="100" y="50" width="250" height="150" fill="none" stroke="#334155" strokeWidth="4" rx="8" />

                     {/* Battery */}
                     <g transform="translate(100, 100)">
                        <rect x="-10" y="0" width="20" height="50" fill="#1e293b" rx="2" />
                        <rect x="-5" y="-5" width="10" height="5" fill="#ef4444" rx="1" />
                        <text x="-25" y="30" textAnchor="end" fill="#ef4444" fontSize="12" fontWeight="bold">{voltage}V</text>
                        <text x="0" y="65" textAnchor="middle" fill="#64748b" fontSize="10">BATTERY</text>
                     </g>

                     {/* Resistor 1 */}
                     <g transform="translate(225, 50)">
                        <rect x="-30" y="-15" width="60" height="30" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                        <line x1="-20" y1="-10" x2="-20" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <line x1="0" y1="-10" x2="0" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <line x1="20" y1="-10" x2="20" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <text x="0" y="-25" textAnchor="middle" fill="#334155" fontSize="12" fontWeight="bold">R1: {r1}Œ©</text>
                     </g>

                     {/* Resistor 2 (Series) */}
                     {circuitType === 'series' && (
                        <g transform="translate(350, 125)">
                           <rect x="-15" y="-30" width="30" height="60" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                           <text x="25" y="5" textAnchor="start" fill="#334155" fontSize="12" fontWeight="bold">R2: {r2}Œ©</text>
                        </g>
                     )}

                     {/* Resistor 2 (Parallel) */}
                     {circuitType === 'parallel' && (
                        <g>
                           <line x1="225" y1="50" x2="225" y2="120" stroke="#334155" strokeWidth="4" />
                           <line x1="350" y1="120" x2="225" y2="120" stroke="#334155" strokeWidth="4" />
                           <g transform="translate(287, 120)">
                              <rect x="-30" y="-15" width="60" height="30" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                              <text x="0" y="30" textAnchor="middle" fill="#334155" fontSize="12" fontWeight="bold">R2: {r2}Œ©</text>
                           </g>
                        </g>
                     )}

                     {/* Ammeter Display */}
                     <g transform="translate(225, 200)">
                        <circle r="35" fill="#1e293b" />
                        <text x="0" y="-5" textAnchor="middle" fill="#94a3b8" fontSize="8" fontWeight="bold">CURRENT</text>
                        <text x="0" y="15" textAnchor="middle" fill="#22d3ee" fontSize="18" fontWeight="bold" className="font-mono">
                           {current.toFixed(2)}A
                        </text>
                     </g>

                     {/* Electrons */}
                     {renderElectrons()}
                  </svg>

                  {/* Flow Intensity Overlay */}
                  <div className="absolute bottom-4 right-4 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold text-slate-500 flex items-center gap-2">
                     <div className="w-2 h-2 rounded-full bg-fbbf24 animate-ping" />
                     ELECTRON FLOW INTENSITY: {(current * 10).toFixed(0)}%
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-6 overflow-y-auto">
               <button
                  onClick={() => setChallengeMode(!challengeMode)}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                     }`}
               >
                  {challengeMode ? 'üéØ CHALLENGE ON' : 'üéØ START CHALLENGE'}
               </button>

               {/* Voltage - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚≠ê Voltage (V)</label>
                     <span className="text-xl font-mono font-bold text-indigo-600">{voltage}V</span>
                  </div>
                  <input
                     type="range" min="1" max="48" step="1" value={voltage}
                     onChange={(e) => setVoltage(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                  />
                  <div className="flex justify-between text-[8px] text-slate-400 font-bold">
                     <span>1V (LOW)</span>
                     <span>48V (HIGH)</span>
                  </div>
               </div>

               <div className="h-px bg-slate-100" />

               {/* Resistance 1 */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resistance 1 (Œ©)</label>
                     <span className="text-lg font-mono font-bold text-slate-700">{r1}Œ©</span>
                  </div>
                  <input
                     type="range" min="1" max="20" step="1" value={r1}
                     onChange={(e) => setR1(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-slate-600"
                  />
               </div>

               {/* Resistance 2 */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resistance 2 (Œ©)</label>
                     <span className="text-lg font-mono font-bold text-slate-700">{r2}Œ©</span>
                  </div>
                  <input
                     type="range" min="1" max="20" step="1" value={r2}
                     onChange={(e) => setR2(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-slate-600"
                  />
               </div>

               {/* Metrics Summary */}
               <div className="grid grid-cols-2 gap-2">
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                     <div className="text-[8px] font-black text-slate-400 uppercase">Total R</div>
                     <div className="text-sm font-bold text-slate-800">{totalResistance.toFixed(1)}Œ©</div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                     <div className="text-[8px] font-black text-slate-400 uppercase">Power (P)</div>
                     <div className="text-sm font-bold text-slate-800">{power.toFixed(0)}W</div>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                  <div className="flex gap-3">
                     <div className="text-indigo-600 text-lg">üí°</div>
                     <p className="text-[10px] text-indigo-800 leading-relaxed">
                        <strong>Ohm's Law:</strong> Current (I) is like the speed of water.
                        Voltage (V) is the pressure pushing it, and Resistance (R) is the pipe size.
                        In <strong>Series</strong>, resistors add up. In <strong>Parallel</strong>,
                        they provide more paths, actually <em>lowering</em> total resistance!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- WAVE INTERFERENCE RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Superposition principle (Constructive vs Destructive)
   // Stage 2: Primary = Phase Shift, Secondary = Frequencies, Amplitudes
   // Stage 3: Three-panel view (Wave 1, Wave 2, Resultant)
   // Stage 4: y = A*sin(kx - œât + œÜ), Resultant = y1 + y2
   // Stage 5: State (amp, freq, phase) ‚Üí Animation Frame ‚Üí SVG Path
   // Stage 6: Challenge = "Create a Standing Wave" or "Perfect Silence (Destructive)"
   const WaveInterferenceRenderer = () => {
      const [amp1, setAmp1] = useState(40);
      const [freq1, setFreq1] = useState(1.0);
      const [amp2, setAmp2] = useState(40);
      const [freq2, setFreq2] = useState(1.0);
      const [phase, setPhase] = useState(0); // degrees
      const [isAnimating, setIsAnimating] = useState(true);
      const [time, setTime] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);

      // Animation loop
      useEffect(() => {
         if (!isAnimating) return;
         let animationId: number;
         const startTime = performance.now();
         const animate = (now: number) => {
            setTime((now - startTime) / 1000);
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isAnimating]);

      const width = 600;
      const height = 120;
      const points = 100;
      const step = width / points;

      const generatePath = (a: number, f: number, p: number, t: number) => {
         const pathPoints = [];
         const phaseRad = (p * Math.PI) / 180;
         for (let i = 0; i <= points; i++) {
            const x = i * step;
            // y = A * sin(k*x - œâ*t + œÜ)
            // k = 2œÄ/Œª, œâ = 2œÄf
            const y = a * Math.sin((i / 10) * f - 5 * t + phaseRad);
            pathPoints.push(`${x},${height / 2 + y}`);
         }
         return `M ${pathPoints.join(" L ")}`;
      };

      const generateResultantPath = (t: number) => {
         const pathPoints = [];
         const phaseRad = (phase * Math.PI) / 180;
         for (let i = 0; i <= points; i++) {
            const x = i * step;
            const y1 = amp1 * Math.sin((i / 10) * freq1 - 5 * t);
            const y2 = amp2 * Math.sin((i / 10) * freq2 - 5 * t + phaseRad);
            pathPoints.push(`${x},${height / 2 + (y1 + y2)}`);
         }
         return `M ${pathPoints.join(" L ")}`;
      };

      // Challenge logic: Destructive interference
      // Occurs when freq1 == freq2, amp1 == amp2, and phase == 180
      const isDestructive = Math.abs(freq1 - freq2) < 0.01 &&
         Math.abs(amp1 - amp2) < 2 &&
         Math.abs(Math.abs(phase) - 180) < 5;

      const isConstructive = Math.abs(freq1 - freq2) < 0.01 &&
         Math.abs(phase % 360) < 5;

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col lg:flex-row overflow-hidden text-slate-200">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                        Wave Interference
                     </h2>
                     <p className="text-slate-400 text-sm">The Principle of Superposition</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isDestructive ? 'bg-emerald-500/10 border-emerald-500/50' : 'bg-amber-500/10 border-amber-500/50'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isDestructive ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isDestructive ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Create "Perfect Silence"</p>
                           <p className="text-xs opacity-80">Adjust Phase Shift to cancel Wave 1 with Wave 2 (Destructive Interference).</p>
                        </div>
                        {isDestructive && (
                           <div className="ml-auto animate-bounce text-emerald-400 font-black">SUCCESS!</div>
                        )}
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col gap-2 min-h-0">
                  {/* Wave 1 */}
                  <div className="flex-1 bg-slate-900/50 rounded-xl border border-slate-800 p-2 relative overflow-hidden">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-cyan-400 uppercase tracking-widest">Wave A</div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full preserve-3d">
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                        <path d={generatePath(amp1, freq1, 0, time)} fill="none" stroke="#22d3ee" strokeWidth="3" strokeLinecap="round" />
                     </svg>
                  </div>

                  {/* Wave 2 */}
                  <div className="flex-1 bg-slate-900/50 rounded-xl border border-slate-800 p-2 relative overflow-hidden">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-purple-400 uppercase tracking-widest">Wave B</div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                        <path d={generatePath(amp2, freq2, phase, time)} fill="none" stroke="#a855f7" strokeWidth="3" strokeLinecap="round" />
                     </svg>
                  </div>

                  {/* Resultant */}
                  <div className="flex-[1.5] bg-slate-900 rounded-xl border-2 border-slate-800 p-2 relative overflow-hidden shadow-inner">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-white uppercase tracking-widest flex items-center gap-2">
                        Resultant Wave (A + B)
                        {isDestructive && <span className="text-emerald-400 text-[8px] animate-pulse">DESTRUCTIVE</span>}
                        {isConstructive && <span className="text-cyan-400 text-[8px] animate-pulse">CONSTRUCTIVE</span>}
                     </div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                        <defs>
                           <linearGradient id="waveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stopColor="#22d3ee" />
                              <stop offset="100%" stopColor="#a855f7" />
                           </linearGradient>
                        </defs>
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="2" />
                        <path d={generateResultantPath(time)} fill="none" stroke="url(#waveGradient)" strokeWidth="4" strokeLinecap="round" />
                     </svg>
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 overflow-y-auto">
               <button
                  onClick={() => setIsAnimating(!isAnimating)}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${isAnimating ? 'bg-slate-800 text-slate-300' : 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20'
                     }`}
               >
                  {isAnimating ? '‚è∏ PAUSE WAVE' : '‚ñ∂ RESUME WAVE'}
               </button>

               {/* Phase Shift - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter">‚≠ê Phase Shift (œÜ)</label>
                     <span className="text-xl font-mono font-bold text-white">{phase}¬∞</span>
                  </div>
                  <input
                     type="range" min="-180" max="180" step="1" value={phase}
                     onChange={(e) => setPhase(Number(e.target.value))}
                     className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                  />
                  <div className="flex justify-between text-[8px] text-slate-600 font-bold">
                     <span>-180¬∞</span>
                     <span>0¬∞ (SYNC)</span>
                     <span>180¬∞ (OPPOSITE)</span>
                  </div>
               </div>

               <div className="h-px bg-slate-800" />

               {/* Wave A Controls */}
               <div className="space-y-4">
                  <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-widest">Wave A Settings</div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Amplitude</span>
                        <span className="text-cyan-400">{amp1}</span>
                     </div>
                     <input
                        type="range" min="0" max="50" value={amp1}
                        onChange={(e) => setAmp1(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                     />
                  </div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Frequency</span>
                        <span className="text-cyan-400">{freq1.toFixed(1)}Hz</span>
                     </div>
                     <input
                        type="range" min="0.5" max="3" step="0.1" value={freq1}
                        onChange={(e) => setFreq1(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                     />
                  </div>
               </div>

               {/* Wave B Controls */}
               <div className="space-y-4">
                  <div className="text-[10px] font-bold text-purple-500 uppercase tracking-widest">Wave B Settings</div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Amplitude</span>
                        <span className="text-purple-400">{amp2}</span>
                     </div>
                     <input
                        type="range" min="0" max="50" value={amp2}
                        onChange={(e) => setAmp2(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                     />
                  </div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Frequency</span>
                        <span className="text-purple-400">{freq2.toFixed(1)}Hz</span>
                     </div>
                     <input
                        type="range" min="0.5" max="3" step="0.1" value={freq2}
                        onChange={(e) => setFreq2(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                     />
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                  <div className="flex gap-3">
                     <div className="text-blue-400 text-lg">üí°</div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        <strong>Superposition:</strong> When two waves meet, their amplitudes add up.
                        If they are "in phase" (peaks align), they create a larger wave.
                        If they are "out of phase" (peak meets trough), they can cancel each other out entirely!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENHANCED PROJECTILE MOTION RENDERER ---
   const ProjectileRenderer = () => {
      const [angle, setAngle] = useState(45);
      const [velocity, setVelocity] = useState(25);
      const [isAnimating, setIsAnimating] = useState(false);
      const [animationProgress, setAnimationProgress] = useState(0);
      const [shots, setShots] = useState<{ hit: boolean, range: number }[]>([]);
      const [showResult, setShowResult] = useState<'hit' | 'miss' | null>(null);

      const g = 9.8;
      const scale = 4;
      const targetX = 550; // Target position
      const targetWidth = 40;

      // Physics calculations
      const radian = angle * (Math.PI / 180);
      const vx = velocity * Math.cos(radian);
      const vy = velocity * Math.sin(radian);
      const totalTime = (2 * vy) / g;
      const range = (velocity * velocity * Math.sin(2 * radian)) / g;
      const maxHeight = (vy * vy) / (2 * g);
      const flightTime = totalTime;

      // Generate trajectory points
      const trajectoryPoints: string[] = [];
      for (let t = 0; t <= totalTime; t += 0.05) {
         const x = vx * t * scale;
         const y = (vy * t - 0.5 * g * t * t) * scale;
         trajectoryPoints.push(`${50 + x},${450 - y}`);
      }

      // Animation position
      const animT = animationProgress * totalTime;
      const animX = 50 + vx * animT * scale;
      const animY = 450 - (vy * animT - 0.5 * g * animT * animT) * scale;

      // Check if hit target
      const landingX = 50 + range * scale;
      const isHit = landingX >= targetX && landingX <= targetX + targetWidth;

      // Launch animation
      const handleLaunch = () => {
         if (isAnimating) return;
         setShowResult(null);
         setIsAnimating(true);
         setAnimationProgress(0);

         const startTime = Date.now();
         const duration = Math.max(1000, totalTime * 400); // Animation duration

         const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(1, elapsed / duration);
            setAnimationProgress(progress);

            if (progress < 1) {
               requestAnimationFrame(animate);
            } else {
               setIsAnimating(false);
               setShots(prev => [...prev, { hit: isHit, range: Math.round(range) }]);
               setShowResult(isHit ? 'hit' : 'miss');
            }
         };
         requestAnimationFrame(animate);
      };

      return (
         <div className="w-full h-full bg-gradient-to-b from-sky-100 to-sky-50 flex flex-col">
            {/* Main Visualization */}
            <div className="flex-1 relative overflow-hidden">
               <svg viewBox="0 0 800 500" className="w-full h-full">
                  {/* Sky gradient */}
                  <defs>
                     <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#e0f2fe" />
                        <stop offset="100%" stopColor="#f0f9ff" />
                     </linearGradient>
                     <linearGradient id="groundGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#4ade80" />
                        <stop offset="100%" stopColor="#16a34a" />
                     </linearGradient>
                     <linearGradient id="targetGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#fbbf24" />
                        <stop offset="100%" stopColor="#f59e0b" />
                     </linearGradient>
                  </defs>

                  <rect width="800" height="450" fill="url(#skyGradient)" />

                  {/* Ground */}
                  <rect x="0" y="450" width="800" height="50" fill="url(#groundGradient)" />

                  {/* Distance markers */}
                  {[0, 100, 200, 300, 400, 500, 600].map(d => (
                     <g key={d}>
                        <line x1={50 + d * scale / 10} y1="445" x2={50 + d * scale / 10} y2="455" stroke="#166534" strokeWidth="2" />
                        <text x={50 + d * scale / 10} y="475" textAnchor="middle" fill="#166534" fontSize="10" fontWeight="bold">{d / 10}m</text>
                     </g>
                  ))}

                  {/* Target */}
                  <g>
                     <rect x={targetX} y="380" width={targetWidth} height="70" fill="url(#targetGradient)" rx="4" />
                     <rect x={targetX + 5} y="390" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <rect x={targetX + 5} y="400" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <rect x={targetX + 5} y="410" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <text x={targetX + targetWidth / 2} y="365" textAnchor="middle" fill="#b45309" fontSize="12" fontWeight="bold">üéØ TARGET</text>
                  </g>

                  {/* Trajectory prediction line */}
                  {!isAnimating && (
                     <polyline
                        points={trajectoryPoints.join(" ")}
                        fill="none"
                        stroke="#6366f1"
                        strokeWidth="2"
                        strokeDasharray="8 4"
                        opacity="0.4"
                     />
                  )}

                  {/* Animated trajectory (during flight) */}
                  {isAnimating && (
                     <polyline
                        points={trajectoryPoints.slice(0, Math.floor(animationProgress * trajectoryPoints.length)).join(" ")}
                        fill="none"
                        stroke="#6366f1"
                        strokeWidth="3"
                     />
                  )}

                  {/* Cannon base */}
                  <circle cx="50" cy="450" r="25" fill="#1e293b" />
                  <circle cx="50" cy="450" r="18" fill="#334155" />

                  {/* Cannon barrel */}
                  <g transform={`translate(50, 450) rotate(${-angle})`}>
                     <rect x="0" y="-12" width="70" height="24" fill="#475569" rx="6" />
                     <rect x="60" y="-8" width="15" height="16" fill="#334155" rx="3" />
                  </g>

                  {/* Angle arc indicator */}
                  <path
                     d={`M 85 450 A 35 35 0 0 0 ${50 + 35 * Math.cos(radian)} ${450 - 35 * Math.sin(radian)}`}
                     fill="none" stroke="#6366f1" strokeWidth="2"
                  />
                  <text x="90" y={430} fill="#6366f1" fontSize="14" fontWeight="bold">{angle}¬∞</text>

                  {/* Projectile (animated or at start) */}
                  {isAnimating ? (
                     <g>
                        <circle cx={animX} cy={animY} r="10" fill="#ef4444">
                           <animate attributeName="r" values="10;12;10" dur="0.2s" repeatCount="indefinite" />
                        </circle>
                        <circle cx={animX} cy={animY} r="6" fill="#fbbf24" />
                     </g>
                  ) : (
                     <g transform={`translate(${50 + 80 * Math.cos(radian)}, ${450 - 80 * Math.sin(radian)})`}>
                        <circle r="10" fill="#ef4444" />
                        <circle r="6" fill="#fbbf24" />
                     </g>
                  )}

                  {/* Result indicator */}
                  {showResult && (
                     <g>
                        <rect x="300" y="180" width="200" height="60" fill={showResult === 'hit' ? '#22c55e' : '#ef4444'} rx="12" />
                        <text x="400" y="218" textAnchor="middle" fill="white" fontSize="24" fontWeight="bold">
                           {showResult === 'hit' ? 'üéØ HIT!' : '‚ùå MISS'}
                        </text>
                     </g>
                  )}
               </svg>
            </div>

            {/* Control Panel */}
            <div className="bg-white border-t border-slate-200 p-4 shadow-lg">
               <div className="max-w-4xl mx-auto">
                  <div className="grid grid-cols-12 gap-4 items-end">
                     {/* Angle Control */}
                     <div className="col-span-3">
                        <label className="text-xs font-black uppercase text-slate-400 block mb-2">
                           <i className="fa-solid fa-angle mr-1"></i> Launch Angle
                        </label>
                        <div className="flex items-center gap-2">
                           <input
                              type="range" min="5" max="85" value={angle}
                              onChange={(e) => !isAnimating && setAngle(Number(e.target.value))}
                              className="flex-1 h-2 bg-indigo-100 rounded-full accent-indigo-500"
                              disabled={isAnimating}
                           />
                           <span className="w-12 text-lg font-mono font-bold text-indigo-600">{angle}¬∞</span>
                        </div>
                     </div>

                     {/* Velocity Control */}
                     <div className="col-span-3">
                        <label className="text-xs font-black uppercase text-slate-400 block mb-2">
                           <i className="fa-solid fa-gauge-high mr-1"></i> Initial Velocity
                        </label>
                        <div className="flex items-center gap-2">
                           <input
                              type="range" min="10" max="50" value={velocity}
                              onChange={(e) => !isAnimating && setVelocity(Number(e.target.value))}
                              className="flex-1 h-2 bg-amber-100 rounded-full accent-amber-500"
                              disabled={isAnimating}
                           />
                           <span className="w-16 text-lg font-mono font-bold text-amber-600">{velocity} m/s</span>
                        </div>
                     </div>

                     {/* Physics Metrics */}
                     <div className="col-span-4 grid grid-cols-3 gap-2">
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Range</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{range.toFixed(1)}m</div>
                        </div>
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Max Height</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{maxHeight.toFixed(1)}m</div>
                        </div>
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Flight Time</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{flightTime.toFixed(2)}s</div>
                        </div>
                     </div>

                     {/* Launch Button */}
                     <div className="col-span-2">
                        <button
                           onClick={handleLaunch}
                           disabled={isAnimating}
                           className={`w-full py-3 rounded-xl font-black uppercase tracking-wider shadow-lg transition-all ${isAnimating
                              ? 'bg-slate-300 cursor-not-allowed'
                              : 'bg-gradient-to-r from-orange-500 to-red-500 text-white hover:from-orange-600 hover:to-red-600 active:scale-95'
                              }`}
                        >
                           {isAnimating ? 'üöÄ Flying...' : 'üéØ LAUNCH!'}
                        </button>
                     </div>
                  </div>

                  {/* Shot History */}
                  {shots.length > 0 && (
                     <div className="mt-3 pt-3 border-t border-slate-100 flex items-center gap-2 flex-wrap">
                        <span className="text-xs font-bold text-slate-400 uppercase">Shots:</span>
                        {shots.slice(-5).map((shot, i) => (
                           <span key={i} className={`px-2 py-1 rounded text-xs font-bold ${shot.hit ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                              {shot.range}m {shot.hit ? '‚úì' : '‚úó'}
                           </span>
                        ))}
                        <span className="ml-auto text-xs font-bold text-slate-400">
                           {shots.filter(s => s.hit).length}/{shots.length} hits
                        </span>
                     </div>
                  )}
               </div>
            </div>
         </div>
      );
   };

   // --- LORENTZ FORCE RENDERER ---
   const LorentzForceRenderer = () => {
      const [velocity, setVelocity] = useState(50);
      const [fieldStrength, setFieldStrength] = useState(0.5);
      const [charge, setCharge] = useState<'positive' | 'negative'>('positive');
      const [particlePos, setParticlePos] = useState({ x: 200, y: 200 });
      const [particleVel, setParticleVel] = useState({ vx: 2, vy: 0 });
      const [isAnimating, setIsAnimating] = useState(false);
      const [trail, setTrail] = useState<{x: number, y: number}[]>([]);

      const q = charge === 'positive' ? 1 : -1;
      const force = q * velocity * fieldStrength;

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => {
            setParticlePos(prev => {
               const newX = prev.x + particleVel.vx;
               const newY = prev.y + particleVel.vy;
               const forceMag = q * fieldStrength * 0.1;
               setParticleVel(v => ({
                  vx: v.vx - forceMag * v.vy,
                  vy: v.vy + forceMag * v.vx
               }));
               if (newX < 50 || newX > 350 || newY < 50 || newY > 350) {
                  setParticleVel({ vx: velocity / 25, vy: 0 });
                  setTrail([]);
                  return { x: 200, y: 200 };
               }
               setTrail(t => [...t.slice(-50), { x: newX, y: newY }]);
               return { x: newX, y: newY };
            });
         }, 30);
         return () => clearInterval(interval);
      }, [isAnimating, fieldStrength, q, velocity, particleVel]);

      const resetSimulation = () => {
         setParticlePos({ x: 200, y: 200 });
         setParticleVel({ vx: velocity / 25, vy: 0 });
         setTrail([]);
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50">
               <h3 className="text-xl font-black tracking-tight text-purple-400">LORENTZ FORCE</h3>
               <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">F = qv √ó B</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="400" height="400" viewBox="0 0 400 400" className="bg-slate-900/50 rounded-2xl">
                     {Array.from({ length: 7 }).map((_, i) =>
                        Array.from({ length: 7 }).map((_, j) => (
                           <g key={`${i}-${j}`} transform={`translate(${70 + i * 40}, ${70 + j * 40})`}>
                              <circle r="12" fill="none" stroke="#3b82f6" strokeWidth="1" opacity={0.3 + fieldStrength * 0.5} />
                              <line x1="-6" y1="-6" x2="6" y2="6" stroke="#3b82f6" strokeWidth="2" opacity={0.5 + fieldStrength * 0.5} />
                              <line x1="6" y1="-6" x2="-6" y2="6" stroke="#3b82f6" strokeWidth="2" opacity={0.5 + fieldStrength * 0.5} />
                           </g>
                        ))
                     )}
                     {trail.length > 1 && (
                        <path d={`M ${trail.map(p => `${p.x},${p.y}`).join(' L ')}`} fill="none"
                           stroke={charge === 'positive' ? '#ef4444' : '#3b82f6'} strokeWidth="3" opacity="0.6" />
                     )}
                     <g transform={`translate(${particlePos.x}, ${particlePos.y})`}>
                        <circle r="15" fill={charge === 'positive' ? '#ef4444' : '#3b82f6'} className="drop-shadow-lg" />
                        <text textAnchor="middle" dy="5" className="text-sm font-black fill-white">{charge === 'positive' ? '+' : '‚àí'}</text>
                        <line x1="0" y1="0" x2={particleVel.vx * 10} y2={particleVel.vy * 10} stroke="#22c55e" strokeWidth="3" markerEnd="url(#arrowV)" />
                     </g>
                     <defs>
                        <marker id="arrowV" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                           <path d="M0,0 L6,3 L0,6 Z" fill="#22c55e" />
                        </marker>
                     </defs>
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-slate-900/50 border-t lg:border-t-0 lg:border-l border-slate-800 p-6 flex flex-col gap-4">
                  <div className="p-4 bg-gradient-to-br from-purple-900/30 to-purple-800/20 rounded-2xl border border-purple-500/20">
                     <p className="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-2">Force Magnitude</p>
                     <p className="text-3xl font-black text-white">{Math.abs(force).toFixed(2)} <span className="text-sm text-slate-400">N</span></p>
                  </div>
                  <div className="space-y-4">
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Velocity (m/s)</label>
                        <input type="range" min="10" max="100" value={velocity}
                           onChange={(e) => { setVelocity(Number(e.target.value)); resetSimulation(); }}
                           className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-green-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Field Strength (T)</label>
                        <input type="range" min="0.1" max="1" step="0.1" value={fieldStrength}
                           onChange={(e) => { setFieldStrength(Number(e.target.value)); resetSimulation(); }}
                           className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Charge</label>
                        <div className="flex gap-2 mt-2">
                           {(['positive', 'negative'] as const).map(c => (
                              <button key={c} onClick={() => { setCharge(c); resetSimulation(); }}
                                 className={`flex-1 py-2 rounded-xl font-bold text-xs transition-all ${charge === c ? c === 'positive' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                 {c === 'positive' ? '+' : '‚àí'}
                              </button>
                           ))}
                        </div>
                     </div>
                  </div>
                  <div className="flex gap-2 mt-4">
                     <button onClick={() => setIsAnimating(!isAnimating)}
                        className={`flex-1 py-3 rounded-xl font-black text-xs transition-all ${isAnimating ? 'bg-orange-500 text-white' : 'bg-purple-500 text-white'}`}>
                        {isAnimating ? 'PAUSE' : 'START'}
                     </button>
                     <button onClick={resetSimulation} className="px-4 py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400 hover:bg-slate-700">RESET</button>
                  </div>
               </div>
            </div>
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <p className="text-xs text-slate-400 text-center"><strong>Right-Hand Rule</strong>: Point fingers in velocity direction, curl toward B field. Thumb shows force on positive charge.</p>
            </div>
         </div>
      );
   };

   // --- INDUCTANCE RENDERER ---
   const InductanceRenderer = () => {
      const [inductance, setInductance] = useState(0.5);
      const [resistance, setResistance] = useState(10);
      const [voltage, setVoltage] = useState(12);
      const [isConnected, setIsConnected] = useState(false);
      const [time, setTime] = useState(0);
      const [current, setCurrent] = useState(0);

      const tau = inductance / resistance;
      const maxCurrent = voltage / resistance;

      useEffect(() => {
         if (!isConnected) { setCurrent(0); setTime(0); return; }
         const interval = setInterval(() => {
            setTime(t => {
               const newT = t + 0.02;
               setCurrent(maxCurrent * (1 - Math.exp(-newT / tau)));
               return newT;
            });
         }, 50);
         return () => clearInterval(interval);
      }, [isConnected, tau, maxCurrent]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50">
               <h3 className="text-xl font-black tracking-tight text-amber-400">RL CIRCUIT - INDUCTANCE</h3>
               <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">œÑ = L/R = {tau.toFixed(3)}s</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="400" height="350" viewBox="0 0 400 350">
                     <g transform="translate(50, 175)">
                        <line x1="0" y1="-20" x2="0" y2="20" stroke="#fbbf24" strokeWidth="4" />
                        <line x1="10" y1="-35" x2="10" y2="35" stroke="#fbbf24" strokeWidth="4" />
                        <text x="-5" y="55" className="text-xs font-bold fill-slate-400">{voltage}V</text>
                     </g>
                     <line x1="50" y1="140" x2="50" y2="50" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <line x1="50" y1="50" x2="350" y2="50" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <line x1="350" y1="50" x2="350" y2="140" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <g transform="translate(350, 175)">
                        <path d="M 0,-35 Q 15,-25 0,-15 Q -15,-5 0,5 Q 15,15 0,25 Q -15,35 0,35" fill="none" stroke="#a855f7" strokeWidth="4" />
                        <text x="20" y="5" className="text-xs font-bold fill-purple-400">{inductance}H</text>
                     </g>
                     <line x1="350" y1="210" x2="350" y2="300" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <line x1="350" y1="300" x2="200" y2="300" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <g transform="translate(200, 300)">
                        <path d="M -50,0 L -40,0 L -35,-10 L -25,10 L -15,-10 L -5,10 L 5,-10 L 15,10 L 25,-10 L 35,10 L 40,0 L 50,0" fill="none" stroke="#f97316" strokeWidth="3" />
                        <text x="-10" y="25" className="text-xs font-bold fill-orange-400">{resistance}Œ©</text>
                     </g>
                     <line x1="150" y1="300" x2="50" y2="300" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                     <line x1="50" y1="300" x2="50" y2="210" stroke={isConnected ? '#22c55e' : '#475569'} strokeWidth="3" />
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-slate-900/50 border-t lg:border-t-0 lg:border-l border-slate-800 p-6 flex flex-col gap-4">
                  <div className="p-4 bg-gradient-to-br from-green-900/30 to-green-800/20 rounded-2xl border border-green-500/20">
                     <p className="text-[10px] font-black text-green-400 uppercase tracking-widest mb-2">Current</p>
                     <p className="text-3xl font-black text-white">{current.toFixed(3)} <span className="text-sm text-slate-400">A</span></p>
                     <div className="w-full h-2 bg-slate-800 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-green-500 transition-all duration-100" style={{ width: `${(current / maxCurrent) * 100}%` }} />
                     </div>
                  </div>
                  <div className="space-y-3">
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase">Inductance (H)</label>
                        <input type="range" min="0.1" max="2" step="0.1" value={inductance} onChange={(e) => setInductance(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase">Resistance (Œ©)</label>
                        <input type="range" min="5" max="50" value={resistance} onChange={(e) => setResistance(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500" />
                     </div>
                  </div>
                  <button onClick={() => setIsConnected(!isConnected)}
                     className={`w-full py-4 rounded-xl font-black text-sm transition-all ${isConnected ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>
                     {isConnected ? 'DISCONNECT' : 'CONNECT CIRCUIT'}
                  </button>
               </div>
            </div>
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <p className="text-xs text-slate-400 text-center"><strong>Key Insight:</strong> Inductors resist changes in current. After ~5œÑ, current reaches 99% of maximum.</p>
            </div>
         </div>
      );
   };

   // --- TRANSFORMERS RENDERER ---
   const TransformersRenderer = () => {
      const [primaryTurns, setPrimaryTurns] = useState(100);
      const [secondaryTurns, setSecondaryTurns] = useState(200);
      const [primaryVoltage, setPrimaryVoltage] = useState(120);
      const [isAnimating, setIsAnimating] = useState(false);
      const [phase, setPhase] = useState(0);

      const turnsRatio = secondaryTurns / primaryTurns;
      const secondaryVoltage = primaryVoltage * turnsRatio;
      const transformerType = turnsRatio > 1 ? 'Step-Up' : turnsRatio < 1 ? 'Step-Down' : 'Isolation';

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => setPhase(p => (p + 0.1) % (2 * Math.PI)), 50);
         return () => clearInterval(interval);
      }, [isAnimating]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50">
               <h3 className="text-xl font-black tracking-tight text-yellow-400">TRANSFORMER</h3>
               <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">{transformerType} ‚Ä¢ Turns Ratio: {turnsRatio.toFixed(2)}</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="450" height="350" viewBox="0 0 450 350">
                     <rect x="170" y="60" width="110" height="230" fill="none" stroke="#64748b" strokeWidth="20" rx="10" />
                     <g transform="translate(140, 175)">
                        {Array.from({ length: 8 }).map((_, i) => (
                           <ellipse key={i} cx="0" cy={-70 + i * 20} rx="30" ry="8" fill="none" stroke="#ef4444" strokeWidth="4" opacity={0.5 + 0.5 * Math.sin(phase + i * 0.5)} />
                        ))}
                        <text x="-60" y="0" className="text-xs font-bold fill-red-400">Primary</text>
                     </g>
                     <g transform="translate(310, 175)">
                        {Array.from({ length: Math.min(12, Math.ceil(secondaryTurns / 20)) }).map((_, i) => (
                           <ellipse key={i} cx="0" cy={-70 + i * (140 / Math.min(12, Math.ceil(secondaryTurns / 20)))} rx="30" ry="8" fill="none" stroke="#3b82f6" strokeWidth="4" opacity={0.5 + 0.5 * Math.sin(phase + i * 0.3 + Math.PI)} />
                        ))}
                        <text x="40" y="0" className="text-xs font-bold fill-blue-400">Secondary</text>
                     </g>
                     <g transform="translate(50, 175)">
                        <text className="text-lg font-black fill-red-400">{primaryVoltage}V</text>
                     </g>
                     <g transform="translate(380, 175)">
                        <text className="text-lg font-black fill-blue-400">{secondaryVoltage.toFixed(0)}V</text>
                     </g>
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-slate-900/50 border-t lg:border-t-0 lg:border-l border-slate-800 p-6 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border ${turnsRatio > 1 ? 'bg-gradient-to-br from-green-900/30 to-green-800/20 border-green-500/20' : 'bg-gradient-to-br from-orange-900/30 to-orange-800/20 border-orange-500/20'}`}>
                     <p className="text-3xl font-black text-white">{turnsRatio.toFixed(2)}:1</p>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                     <div className="p-3 bg-red-900/20 rounded-xl border border-red-500/20">
                        <p className="text-[10px] font-bold text-red-400">Primary V</p>
                        <p className="text-lg font-black">{primaryVoltage}V</p>
                     </div>
                     <div className="p-3 bg-blue-900/20 rounded-xl border border-blue-500/20">
                        <p className="text-[10px] font-bold text-blue-400">Secondary V</p>
                        <p className="text-lg font-black">{secondaryVoltage.toFixed(0)}V</p>
                     </div>
                  </div>
                  <div className="space-y-3">
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase">Primary Turns</label>
                        <input type="range" min="50" max="200" value={primaryTurns} onChange={(e) => setPrimaryTurns(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase">Secondary Turns</label>
                        <input type="range" min="50" max="400" value={secondaryTurns} onChange={(e) => setSecondaryTurns(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                     </div>
                  </div>
                  <button onClick={() => setIsAnimating(!isAnimating)}
                     className={`w-full py-4 rounded-xl font-black text-sm transition-all ${isAnimating ? 'bg-orange-500 text-white' : 'bg-yellow-500 text-slate-900'}`}>
                     {isAnimating ? 'STOP' : 'ENERGIZE'}
                  </button>
               </div>
            </div>
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <p className="text-xs text-slate-400 text-center"><strong>V‚ÇÅ/V‚ÇÇ = N‚ÇÅ/N‚ÇÇ</strong> ‚Ä¢ Higher voltage means lower current.</p>
            </div>
         </div>
      );
   };

   // --- DAY NIGHT CYCLE RENDERER ---
   const DayNightCycleRenderer = () => {
      const [rotation, setRotation] = useState(0);
      const [isSpinning, setIsSpinning] = useState(false);
      const [speed, setSpeed] = useState(1);

      useEffect(() => {
         if (!isSpinning) return;
         const interval = setInterval(() => setRotation(r => (r + speed) % 360), 50);
         return () => clearInterval(interval);
      }, [isSpinning, speed]);

      return (
         <div className="flex flex-col h-full bg-gradient-to-b from-slate-900 via-indigo-950 to-slate-900 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-white/10 bg-white/5">
               <h3 className="text-xl font-black tracking-tight text-yellow-300">DAY AND NIGHT</h3>
               <p className="text-[10px] font-bold text-white/50 uppercase tracking-widest">Earth's Rotation</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <div className="absolute inset-0 overflow-hidden">
                     {Array.from({ length: 50 }).map((_, i) => (
                        <div key={i} className="absolute w-1 h-1 bg-white rounded-full animate-pulse" style={{ left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 2}s` }} />
                     ))}
                  </div>
                  <svg width="400" height="400" viewBox="0 0 400 400" className="relative z-10">
                     <g transform="translate(50, 200)">
                        <circle r="40" fill="#fbbf24" className="drop-shadow-[0_0_30px_rgba(251,191,36,0.8)]" />
                        {Array.from({ length: 12 }).map((_, i) => (
                           <line key={i} x1="50" y1="0" x2="65" y2="0" stroke="#fbbf24" strokeWidth="3" transform={`rotate(${i * 30})`} />
                        ))}
                        <text y="70" textAnchor="middle" className="text-xs font-bold fill-yellow-300">SUN</text>
                     </g>
                     <g opacity="0.3">
                        {Array.from({ length: 5 }).map((_, i) => (
                           <line key={i} x1="90" y1={180 + i * 10} x2="180" y2={180 + i * 10} stroke="#fbbf24" strokeWidth="2" strokeDasharray="10,5">
                              <animate attributeName="stroke-dashoffset" from="15" to="0" dur="1s" repeatCount="indefinite" />
                           </line>
                        ))}
                     </g>
                     <g transform={`translate(250, 200) rotate(${rotation})`}>
                        <circle r="70" fill="#1e3a5f" />
                        <ellipse cx="0" cy="0" rx="10" ry="70" fill="#1e293b" opacity="0.5" />
                        <ellipse cx="-30" cy="-20" rx="25" ry="20" fill="#22c55e" opacity="0.8" />
                        <ellipse cx="20" cy="10" rx="20" ry="25" fill="#22c55e" opacity="0.8" />
                     </g>
                     <text x="250" y="290" textAnchor="middle" className="text-xs font-bold fill-blue-300">EARTH</text>
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-black/30 border-t lg:border-t-0 lg:border-l border-white/10 p-6 flex flex-col gap-4">
                  <div className="p-4 bg-gradient-to-br from-yellow-900/30 to-orange-900/20 rounded-2xl border border-yellow-500/20">
                     <p className="text-[10px] font-black text-yellow-400 uppercase tracking-widest mb-2">Earth Rotation</p>
                     <p className="text-3xl font-black text-white">{rotation.toFixed(0)}¬∞</p>
                  </div>
                  <div>
                     <label className="text-[10px] font-black text-slate-400 uppercase">Rotation Speed</label>
                     <input type="range" min="0.5" max="5" step="0.5" value={speed} onChange={(e) => setSpeed(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-500" />
                  </div>
                  <button onClick={() => setIsSpinning(!isSpinning)}
                     className={`w-full py-4 rounded-xl font-black text-sm transition-all ${isSpinning ? 'bg-orange-500 text-white' : 'bg-yellow-400 text-slate-900'}`}>
                     {isSpinning ? 'STOP ROTATION' : 'SPIN EARTH'}
                  </button>
               </div>
            </div>
            <div className="p-6 bg-black/30 border-t border-white/10">
               <p className="text-xs text-white/60 text-center"><strong>Why Day & Night?</strong> Earth spins like a top! The side facing the Sun has day. One full spin = 24 hours.</p>
            </div>
         </div>
      );
   };

   // --- MOON PHASES RENDERER ---
   const MoonPhasesRenderer = () => {
      const [dayOfMonth, setDayOfMonth] = useState(0);
      const [isAnimating, setIsAnimating] = useState(false);

      const phases = [
         { name: 'New Moon', day: 0, emoji: 'üåë' },
         { name: 'Waxing Crescent', day: 4, emoji: 'üåí' },
         { name: 'First Quarter', day: 7, emoji: 'üåì' },
         { name: 'Waxing Gibbous', day: 11, emoji: 'üåî' },
         { name: 'Full Moon', day: 15, emoji: 'üåï' },
         { name: 'Waning Gibbous', day: 18, emoji: 'üåñ' },
         { name: 'Last Quarter', day: 22, emoji: 'üåó' },
         { name: 'Waning Crescent', day: 26, emoji: 'üåò' },
      ];

      const currentPhase = phases.reduce((closest, phase) => Math.abs(phase.day - dayOfMonth) < Math.abs(closest.day - dayOfMonth) ? phase : closest);
      const moonAngle = (dayOfMonth / 29.5) * 360;
      const illumination = Math.abs(Math.cos((moonAngle * Math.PI) / 180));

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => setDayOfMonth(d => (d + 0.5) % 30), 200);
         return () => clearInterval(interval);
      }, [isAnimating]);

      return (
         <div className="flex flex-col h-full bg-gradient-to-b from-indigo-950 via-slate-900 to-indigo-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-white/10 bg-white/5">
               <h3 className="text-xl font-black tracking-tight text-blue-200">MOON PHASES</h3>
               <p className="text-[10px] font-bold text-white/50 uppercase tracking-widest">The Lunar Cycle</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <div className="absolute inset-0">
                     {Array.from({ length: 80 }).map((_, i) => (
                        <div key={i} className="absolute w-0.5 h-0.5 bg-white/60 rounded-full" style={{ left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%` }} />
                     ))}
                  </div>
                  <svg width="400" height="400" viewBox="0 0 400 400" className="relative z-10">
                     <g transform="translate(200, 200)">
                        <circle r="40" fill="#3b82f6" />
                        <ellipse cx="-10" cy="-10" rx="15" ry="12" fill="#22c55e" opacity="0.8" />
                        <text y="60" textAnchor="middle" className="text-[10px] font-bold fill-blue-300">EARTH</text>
                     </g>
                     <circle cx="200" cy="200" r="120" fill="none" stroke="white" strokeWidth="1" strokeDasharray="5,5" opacity="0.3" />
                     <g opacity="0.2">
                        {Array.from({ length: 8 }).map((_, i) => (
                           <line key={i} x1="0" y1={120 + i * 20} x2="100" y2={120 + i * 20} stroke="#fbbf24" strokeWidth="3" />
                        ))}
                     </g>
                     <g transform={`translate(${200 + 120 * Math.cos((moonAngle - 90) * Math.PI / 180)}, ${200 + 120 * Math.sin((moonAngle - 90) * Math.PI / 180)})`}>
                        <circle r="25" fill="#1e293b" />
                        <clipPath id="moonLit">
                           <rect x={-25 + (1 - illumination) * 25} y="-25" width={50 * illumination} height="50" />
                        </clipPath>
                        <circle r="25" fill="#e2e8f0" clipPath="url(#moonLit)" />
                     </g>
                     {phases.map((phase, i) => {
                        const angle = (phase.day / 29.5) * 360 - 90;
                        const x = 200 + 160 * Math.cos(angle * Math.PI / 180);
                        const y = 200 + 160 * Math.sin(angle * Math.PI / 180);
                        return (
                           <g key={i} transform={`translate(${x}, ${y})`} opacity={currentPhase.day === phase.day ? 1 : 0.4}>
                              <text textAnchor="middle" dy="5" className="text-lg">{phase.emoji}</text>
                           </g>
                        );
                     })}
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-black/30 border-t lg:border-t-0 lg:border-l border-white/10 p-6 flex flex-col gap-4">
                  <div className="p-6 bg-gradient-to-br from-indigo-900/50 to-purple-900/30 rounded-2xl border border-indigo-500/20 text-center">
                     <p className="text-6xl mb-2">{currentPhase.emoji}</p>
                     <p className="text-xl font-black text-white">{currentPhase.name}</p>
                     <p className="text-sm text-indigo-300">Day {Math.round(dayOfMonth)} of 30</p>
                  </div>
                  <div>
                     <label className="text-[10px] font-black text-slate-400 uppercase">Day of Lunar Cycle</label>
                     <input type="range" min="0" max="29" step="1" value={dayOfMonth} onChange={(e) => setDayOfMonth(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                  </div>
                  <div className="grid grid-cols-4 gap-2">
                     {phases.map((phase) => (
                        <button key={phase.day} onClick={() => setDayOfMonth(phase.day)} className={`p-2 rounded-lg text-center transition-all ${Math.abs(dayOfMonth - phase.day) < 2 ? 'bg-indigo-500' : 'bg-white/10 hover:bg-white/20'}`}>
                           <span className="text-xl">{phase.emoji}</span>
                        </button>
                     ))}
                  </div>
                  <button onClick={() => setIsAnimating(!isAnimating)}
                     className={`w-full py-4 rounded-xl font-black text-sm transition-all ${isAnimating ? 'bg-orange-500 text-white' : 'bg-indigo-500 text-white'}`}>
                     {isAnimating ? 'PAUSE CYCLE' : 'WATCH FULL CYCLE'}
                  </button>
               </div>
            </div>
            <div className="p-6 bg-black/30 border-t border-white/10">
               <p className="text-xs text-white/60 text-center"><strong>Why Phases?</strong> We see the part of the Moon lit by the Sun. As it orbits Earth, we see different amounts!</p>
            </div>
         </div>
      );
   };

   // --- TIME DILATION RENDERER ---
   const TimeDilationRenderer = () => {
      const [velocity, setVelocity] = useState(0);
      const [isAnimating, setIsAnimating] = useState(false);
      const [earthTime, setEarthTime] = useState(0);
      const [spaceshipTime, setSpaceshipTime] = useState(0);

      const vFraction = velocity / 100;
      const gamma = 1 / Math.sqrt(1 - vFraction * vFraction);
      const timeDilation = gamma > 1 ? gamma : 1;

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => {
            setEarthTime(t => t + 0.1);
            setSpaceshipTime(t => t + 0.1 / timeDilation);
         }, 100);
         return () => clearInterval(interval);
      }, [isAnimating, timeDilation]);

      const resetClocks = () => { setEarthTime(0); setSpaceshipTime(0); };

      return (
         <div className="flex flex-col h-full bg-gradient-to-b from-slate-950 via-purple-950/50 to-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-purple-500/20 bg-purple-900/20">
               <h3 className="text-xl font-black tracking-tight text-purple-300">TIME DILATION</h3>
               <p className="text-[10px] font-bold text-purple-400/60 uppercase tracking-widest">Special Relativity</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="500" height="350" viewBox="0 0 500 350">
                     {Array.from({ length: 30 }).map((_, i) => (
                        <circle key={i} cx={Math.random() * 500} cy={Math.random() * 350} r="1" fill="white" opacity="0.5" />
                     ))}
                     <g transform="translate(100, 175)">
                        <circle r="50" fill="#3b82f6" />
                        <ellipse cx="-15" cy="-15" rx="20" ry="15" fill="#22c55e" opacity="0.8" />
                        <text y="75" textAnchor="middle" className="text-xs font-bold fill-blue-300">EARTH</text>
                        <g transform="translate(0, -80)">
                           <circle r="25" fill="#1e293b" stroke="#3b82f6" strokeWidth="2" />
                           <line x1="0" y1="0" x2={15 * Math.sin(earthTime * 0.5)} y2={-15 * Math.cos(earthTime * 0.5)} stroke="#22c55e" strokeWidth="2" />
                           <text y="40" textAnchor="middle" className="text-[10px] font-bold fill-green-400">{earthTime.toFixed(1)}s</text>
                        </g>
                     </g>
                     <g transform="translate(350, 175)">
                        {velocity > 50 && (
                           <g opacity={velocity / 200}>
                              {Array.from({ length: 5 }).map((_, i) => (
                                 <ellipse key={i} cx={-30 - i * 15} cy="0" rx="20" ry="10" fill="#a855f7" opacity={0.3 - i * 0.05} />
                              ))}
                           </g>
                        )}
                        <ellipse cx="0" cy="0" rx="40" ry="15" fill="#6366f1" />
                        <ellipse cx="20" cy="0" rx="15" ry="10" fill="#818cf8" />
                        <ellipse cx="-45" cy="0" rx={5 + velocity / 20} ry={3 + velocity / 40} fill="#f97316" opacity={0.5 + velocity / 200} />
                        <text y="45" textAnchor="middle" className="text-xs font-bold fill-purple-300">SPACESHIP</text>
                        <g transform="translate(0, -55)">
                           <circle r="25" fill="#1e293b" stroke="#a855f7" strokeWidth="2" />
                           <line x1="0" y1="0" x2={15 * Math.sin(spaceshipTime * 0.5)} y2={-15 * Math.cos(spaceshipTime * 0.5)} stroke="#f97316" strokeWidth="2" />
                           <text y="40" textAnchor="middle" className="text-[10px] font-bold fill-orange-400">{spaceshipTime.toFixed(1)}s</text>
                        </g>
                     </g>
                     <g transform="translate(250, 300)">
                        <text textAnchor="middle" className="text-sm font-bold fill-slate-400">v = {(vFraction * 100).toFixed(0)}% speed of light</text>
                     </g>
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-purple-950/30 border-t lg:border-t-0 lg:border-l border-purple-500/20 p-6 flex flex-col gap-4">
                  <div className="p-4 bg-gradient-to-br from-purple-900/50 to-pink-900/30 rounded-2xl border border-purple-500/30">
                     <p className="text-[10px] font-black text-purple-300 uppercase tracking-widest mb-2">Lorentz Factor (Œ≥)</p>
                     <p className="text-4xl font-black text-white">{timeDilation.toFixed(3)}</p>
                     <p className="text-xs text-purple-400 mt-1">Time slows by {((1 - 1/timeDilation) * 100).toFixed(1)}%</p>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                     <div className="p-3 bg-green-900/20 rounded-xl border border-green-500/20">
                        <p className="text-[10px] font-bold text-green-400">Earth Time</p>
                        <p className="text-xl font-black">{earthTime.toFixed(1)}s</p>
                     </div>
                     <div className="p-3 bg-orange-900/20 rounded-xl border border-orange-500/20">
                        <p className="text-[10px] font-bold text-orange-400">Ship Time</p>
                        <p className="text-xl font-black">{spaceshipTime.toFixed(1)}s</p>
                     </div>
                  </div>
                  <div>
                     <label className="text-[10px] font-black text-slate-400 uppercase">Velocity (% of c)</label>
                     <input type="range" min="0" max="99" value={velocity} onChange={(e) => { setVelocity(Number(e.target.value)); resetClocks(); }}
                        className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500" />
                  </div>
                  <div className="flex gap-2">
                     <button onClick={() => setIsAnimating(!isAnimating)}
                        className={`flex-1 py-3 rounded-xl font-black text-sm transition-all ${isAnimating ? 'bg-orange-500 text-white' : 'bg-purple-500 text-white'}`}>
                        {isAnimating ? 'PAUSE' : 'START CLOCKS'}
                     </button>
                     <button onClick={resetClocks} className="px-4 py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400">RESET</button>
                  </div>
               </div>
            </div>
            <div className="p-6 bg-purple-950/30 border-t border-purple-500/20">
               <p className="text-xs text-purple-300/80 text-center"><strong>Einstein's Discovery:</strong> Moving clocks run slower! At 99% light speed, 1 year on ship = 7 years on Earth.</p>
            </div>
         </div>
      );
   };

   // --- ATOM STRUCTURE RENDERER ---
   const AtomStructureRenderer = () => {
      const [protons, setProtons] = useState(6);
      const [neutrons, setNeutrons] = useState(6);
      const [electrons, setElectrons] = useState(6);
      const [isAnimating, setIsAnimating] = useState(true);
      const [orbitAngle, setOrbitAngle] = useState(0);

      const elements: Record<number, { symbol: string; name: string }> = {
         1: { symbol: 'H', name: 'Hydrogen' }, 2: { symbol: 'He', name: 'Helium' },
         3: { symbol: 'Li', name: 'Lithium' }, 4: { symbol: 'Be', name: 'Beryllium' },
         5: { symbol: 'B', name: 'Boron' }, 6: { symbol: 'C', name: 'Carbon' },
         7: { symbol: 'N', name: 'Nitrogen' }, 8: { symbol: 'O', name: 'Oxygen' },
         9: { symbol: 'F', name: 'Fluorine' }, 10: { symbol: 'Ne', name: 'Neon' },
      };

      const element = elements[protons] || { symbol: '?', name: 'Unknown' };
      const charge = protons - electrons;
      const isIon = charge !== 0;

      const shells = [2, 8, 8];
      const electronConfig: number[] = [];
      let remaining = electrons;
      for (const max of shells) {
         const inShell = Math.min(remaining, max);
         electronConfig.push(inShell);
         remaining -= inShell;
         if (remaining <= 0) break;
      }

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => setOrbitAngle(a => (a + 2) % 360), 50);
         return () => clearInterval(interval);
      }, [isAnimating]);

      return (
         <div className="flex flex-col h-full bg-gradient-to-b from-slate-950 via-cyan-950/30 to-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-cyan-500/20 bg-cyan-900/20">
               <h3 className="text-xl font-black tracking-tight text-cyan-300">ATOM STRUCTURE</h3>
               <p className="text-[10px] font-bold text-cyan-400/60 uppercase tracking-widest">Build Your Own Atom</p>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="400" height="400" viewBox="0 0 400 400">
                     {electronConfig.map((count, shellIndex) => count > 0 && (
                        <circle key={shellIndex} cx="200" cy="200" r={80 + shellIndex * 50} fill="none" stroke="#22d3ee" strokeWidth="1" opacity="0.3" strokeDasharray="5,5" />
                     ))}
                     <g transform="translate(200, 200)">
                        {Array.from({ length: Math.min(protons + neutrons, 20) }).map((_, i) => {
                           const angle = (i / Math.min(protons + neutrons, 20)) * Math.PI * 2 + (i % 2) * 0.3;
                           const r = 8 + (i % 3) * 6;
                           const x = r * Math.cos(angle);
                           const y = r * Math.sin(angle);
                           return <circle key={i} cx={x} cy={y} r="10" fill={i < protons ? '#ef4444' : '#64748b'} stroke={i < protons ? '#fca5a5' : '#94a3b8'} strokeWidth="2" />;
                        })}
                        <text textAnchor="middle" dy="5" className="text-lg font-black fill-white">{element.symbol}</text>
                     </g>
                     {electronConfig.map((count, shellIndex) =>
                        Array.from({ length: count }).map((_, eIndex) => {
                           const baseAngle = (eIndex / count) * 360;
                           const angle = ((baseAngle + orbitAngle * (shellIndex + 1) * 0.5) % 360) * Math.PI / 180;
                           const radius = 80 + shellIndex * 50;
                           return (
                              <g key={`${shellIndex}-${eIndex}`} transform={`translate(${200 + radius * Math.cos(angle)}, ${200 + radius * Math.sin(angle)})`}>
                                 <circle r="8" fill="#3b82f6" className="drop-shadow-[0_0_8px_rgba(59,130,246,0.8)]" />
                                 <text textAnchor="middle" dy="3" className="text-[8px] font-bold fill-white">e‚Åª</text>
                              </g>
                           );
                        })
                     )}
                     <g transform="translate(20, 350)">
                        <circle cx="10" cy="0" r="8" fill="#ef4444" />
                        <text x="25" y="4" className="text-[10px] fill-slate-400">Proton (+)</text>
                        <circle cx="100" cy="0" r="8" fill="#64748b" />
                        <text x="115" y="4" className="text-[10px] fill-slate-400">Neutron (0)</text>
                        <circle cx="200" cy="0" r="8" fill="#3b82f6" />
                        <text x="215" y="4" className="text-[10px] fill-slate-400">Electron (‚àí)</text>
                     </g>
                  </svg>
               </div>
               <div className="w-full lg:w-80 bg-cyan-950/30 border-t lg:border-t-0 lg:border-l border-cyan-500/20 p-6 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border ${isIon ? 'bg-gradient-to-br from-yellow-900/50 to-orange-900/30 border-yellow-500/30' : 'bg-gradient-to-br from-cyan-900/50 to-blue-900/30 border-cyan-500/30'}`}>
                     <div className="flex items-baseline gap-2">
                        <p className="text-4xl font-black text-white">{element.symbol}</p>
                        <div className="text-xs"><p className="text-slate-400">{protons + neutrons}</p><p className="text-slate-400">{protons}</p></div>
                     </div>
                     <p className="text-lg font-bold text-cyan-300">{element.name}</p>
                     {isIon && <p className="text-sm text-yellow-400 mt-1">Ion: {charge > 0 ? `+${charge}` : charge} charge</p>}
                  </div>
                  <div className="grid grid-cols-3 gap-2">
                     <div className="p-2 bg-red-900/30 rounded-xl text-center border border-red-500/20">
                        <p className="text-2xl font-black text-red-400">{protons}</p>
                        <p className="text-[10px] text-slate-400">Protons</p>
                     </div>
                     <div className="p-2 bg-slate-700/50 rounded-xl text-center border border-slate-500/20">
                        <p className="text-2xl font-black text-slate-300">{neutrons}</p>
                        <p className="text-[10px] text-slate-400">Neutrons</p>
                     </div>
                     <div className="p-2 bg-blue-900/30 rounded-xl text-center border border-blue-500/20">
                        <p className="text-2xl font-black text-blue-400">{electrons}</p>
                        <p className="text-[10px] text-slate-400">Electrons</p>
                     </div>
                  </div>
                  <div className="space-y-3">
                     <div>
                        <label className="text-[10px] font-black text-red-400 uppercase">Protons (defines element)</label>
                        <input type="range" min="1" max="10" value={protons} onChange={(e) => setProtons(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase">Neutrons (isotope)</label>
                        <input type="range" min="0" max="15" value={neutrons} onChange={(e) => setNeutrons(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-slate-500" />
                     </div>
                     <div>
                        <label className="text-[10px] font-black text-blue-400 uppercase">Electrons (charge)</label>
                        <input type="range" min="0" max="12" value={electrons} onChange={(e) => setElectrons(Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                     </div>
                  </div>
                  <button onClick={() => setIsAnimating(!isAnimating)}
                     className={`w-full py-3 rounded-xl font-black text-sm transition-all ${isAnimating ? 'bg-orange-500 text-white' : 'bg-cyan-500 text-white'}`}>
                     {isAnimating ? 'PAUSE ELECTRONS' : 'ANIMATE'}
                  </button>
               </div>
            </div>
            <div className="p-6 bg-cyan-950/30 border-t border-cyan-500/20">
               <p className="text-xs text-cyan-300/80 text-center"><strong>Key Insight:</strong> Protons define the element. Neutrons create isotopes. Electrons determine charge!</p>
            </div>
         </div>
      );
   };

   // --- ENTREPRENEURSHIP: MINDSET & FOUNDATIONAL SKILLS RENDERERS ---

   const GrowthMindsetRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [currentScenario, setCurrentScenario] = useState(0);
      const [feedback, setFeedback] = useState('');

      const scenarios = [
         { situation: "You failed your first business pitch.", fixed: "I'm just not good at this.", growth: "What can I learn to improve my next pitch?", correct: 'growth' },
         { situation: "A competitor launched a similar product.", fixed: "They'll always be better than me.", growth: "How can I differentiate and innovate?", correct: 'growth' },
         { situation: "Your mentor criticizes your business plan.", fixed: "They don't understand my vision.", growth: "Their feedback could help me strengthen weak points.", correct: 'growth' },
         { situation: "You made a costly mistake.", fixed: "I'm not cut out for entrepreneurship.", growth: "This mistake taught me a valuable lesson.", correct: 'growth' },
         { situation: "Sales are declining.", fixed: "The market just doesn't want my product.", growth: "Time to research and adapt to customer needs.", correct: 'growth' },
      ];

      const handleChoice = (choice: string) => {
         if (choice === scenarios[currentScenario].correct) {
            setScore(s => s + 20);
            setFeedback('‚úì Growth mindset! Entrepreneurs embrace challenges as learning opportunities.');
         } else {
            setFeedback('‚úó That\'s a fixed mindset response. Try reframing challenges as growth opportunities.');
         }
         setTimeout(() => {
            if (currentScenario < scenarios.length - 1) {
               setCurrentScenario(c => c + 1);
               setFeedback('');
            } else {
               setPhase('result');
            }
         }, 2000);
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üå± GROWTH MINDSET</h2>
                  <p className="text-emerald-300 text-sm mt-1">Fixed vs Growth Thinking</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Growth Mindset:</strong> Believing abilities can be developed through dedication and hard work.</p>
                  <p className="mt-2"><strong>Fixed Mindset:</strong> Believing talents are innate and unchangeable.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üß†</div>
               <h3 className="text-2xl font-bold mb-4">How Entrepreneurs Think</h3>
               <p className="text-lg text-emerald-200 max-w-md mb-8">Learn to recognize and choose growth mindset responses to entrepreneurial challenges.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-emerald-500 hover:bg-emerald-400 rounded-xl font-bold text-lg transition-all transform hover:scale-105">
                  START CHALLENGE ‚Üí
               </button>
            </div>
            <p className="text-xs text-emerald-300/60 text-center">Key Insight: 90% of successful entrepreneurs attribute their success to a growth mindset.</p>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 80 ? 'üèÜ' : score >= 60 ? 'üåü' : 'üí™'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-emerald-300 text-lg mb-6">{score >= 80 ? 'Outstanding growth mindset!' : score >= 60 ? 'Good progress!' : 'Keep developing your growth mindset!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentScenario(0); }} className="px-6 py-3 bg-emerald-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8">
            <div className="flex justify-between items-center mb-6">
               <span className="text-sm text-emerald-300">Scenario {currentScenario + 1}/{scenarios.length}</span>
               <span className="px-4 py-2 bg-emerald-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="flex-1 flex flex-col justify-center">
               <div className="bg-black/30 rounded-2xl p-6 mb-6">
                  <p className="text-xl font-bold text-center">{scenarios[currentScenario].situation}</p>
               </div>
               {feedback ? (
                  <div className={`text-center p-4 rounded-xl ${feedback.startsWith('‚úì') ? 'bg-green-500/30' : 'bg-red-500/30'}`}>
                     <p className="text-lg">{feedback}</p>
                  </div>
               ) : (
                  <div className="grid gap-4">
                     <button onClick={() => handleChoice('fixed')} className="p-4 bg-red-900/50 hover:bg-red-800/50 rounded-xl text-left transition-all">
                        <span className="text-red-400 font-bold">Fixed Mindset:</span>
                        <p className="mt-1">{scenarios[currentScenario].fixed}</p>
                     </button>
                     <button onClick={() => handleChoice('growth')} className="p-4 bg-green-900/50 hover:bg-green-800/50 rounded-xl text-left transition-all">
                        <span className="text-green-400 font-bold">Growth Mindset:</span>
                        <p className="mt-1">{scenarios[currentScenario].growth}</p>
                     </button>
                  </div>
               )}
            </div>
         </div>
      );
   };

   const OpportunityRecognitionRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [timeLeft, setTimeLeft] = useState(30);
      const [opportunities, setOpportunities] = useState<{id: number; text: string; isReal: boolean; found: boolean}[]>([]);

      const allOpportunities = [
         { text: "Long lines at coffee shops during morning rush", isReal: true },
         { text: "People complaining about parking in downtown", isReal: true },
         { text: "Students struggling with math homework", isReal: true },
         { text: "Elderly neighbors need help with technology", isReal: true },
         { text: "Local restaurants throwing away unsold food", isReal: true },
         { text: "Everyone already has everything they need", isReal: false },
         { text: "There are no more problems left to solve", isReal: false },
         { text: "Pet owners traveling need pet care", isReal: true },
      ];

      useEffect(() => {
         if (phase === 'play' && timeLeft > 0) {
            const timer = setTimeout(() => setTimeLeft(t => t - 1), 1000);
            return () => clearTimeout(timer);
         } else if (timeLeft === 0) setPhase('result');
      }, [phase, timeLeft]);

      const startGame = () => {
         setOpportunities(allOpportunities.map((o, i) => ({ ...o, id: i, found: false })));
         setPhase('play');
         setTimeLeft(30);
         setScore(0);
      };

      const handleClick = (id: number) => {
         const opp = opportunities.find(o => o.id === id);
         if (opp && !opp.found) {
            if (opp.isReal) setScore(s => s + 15);
            else setScore(s => Math.max(0, s - 10));
            setOpportunities(ops => ops.map(o => o.id === id ? { ...o, found: true } : o));
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîç OPPORTUNITY RECOGNITION</h2>
                  <p className="text-amber-300 text-sm mt-1">Spotting Problems Worth Solving</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Opportunity Recognition:</strong> The ability to identify unmet needs, inefficiencies, or problems that could be solved with a business solution.</p>
                  <p className="mt-2">Look for: Pain points, frustrations, gaps in the market, and underserved customers.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üí°</div>
               <h3 className="text-2xl font-bold mb-4">Find Real Opportunities</h3>
               <p className="text-lg text-amber-200 max-w-md mb-8">Spot genuine business opportunities while avoiding false signals. You have 30 seconds!</p>
               <button onClick={startGame} className="px-8 py-4 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-lg transition-all">
                  START SPOTTING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">üéØ</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}</h2>
            <p className="text-amber-300 mb-6">You found {opportunities.filter(o => o.found && o.isReal).length} real opportunities!</p>
            <button onClick={startGame} className="px-6 py-3 bg-amber-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-2xl font-black">‚è±Ô∏è {timeLeft}s</span>
               <span className="px-4 py-2 bg-amber-500/30 rounded-full font-bold">Score: {score}</span>
            </div>
            <p className="text-center mb-4 text-amber-200">Click on REAL business opportunities (avoid false ones!)</p>
            <div className="grid grid-cols-2 gap-3 flex-1">
               {opportunities.map(opp => (
                  <button key={opp.id} onClick={() => handleClick(opp.id)} disabled={opp.found}
                     className={`p-4 rounded-xl text-left text-sm transition-all ${opp.found ? (opp.isReal ? 'bg-green-500/50' : 'bg-red-500/50') : 'bg-black/30 hover:bg-black/50'}`}>
                     {opp.text}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   const CalculatedRiskRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [balance, setBalance] = useState(10000);
      const [round, setRound] = useState(0);
      const [lastResult, setLastResult] = useState('');

      const decisions = [
         { scenario: "Invest $2,000 in market research before launching?", risk: 2000, successChance: 0.7, reward: 5000 },
         { scenario: "Spend $5,000 on a trade show booth?", risk: 5000, successChance: 0.5, reward: 15000 },
         { scenario: "Hire a part-time assistant for $1,500/month?", risk: 1500, successChance: 0.8, reward: 4000 },
         { scenario: "Invest $3,000 in online advertising?", risk: 3000, successChance: 0.6, reward: 8000 },
      ];

      const makeDecision = (takeRisk: boolean) => {
         const decision = decisions[round];
         if (takeRisk) {
            const success = Math.random() < decision.successChance;
            if (success) {
               setBalance(b => b + decision.reward);
               setLastResult(`‚úì Success! You gained $${decision.reward.toLocaleString()}`);
            } else {
               setBalance(b => b - decision.risk);
               setLastResult(`‚úó It didn't work out. You lost $${decision.risk.toLocaleString()}`);
            }
         } else {
            setLastResult("You played it safe. No risk, no reward.");
         }
         setTimeout(() => {
            if (round < decisions.length - 1) { setRound(r => r + 1); setLastResult(''); }
            else setPhase('result');
         }, 2000);
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">‚öñÔ∏è CALCULATED RISK</h2>
                  <p className="text-violet-300 text-sm mt-1">Smart Risk Assessment</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Calculated Risk:</strong> Making informed decisions by weighing potential rewards against possible losses.</p>
                  <p className="mt-2">Formula: Expected Value = (Probability √ó Reward) - (Risk √ó Failure Rate)</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üé≤</div>
               <h3 className="text-2xl font-bold mb-4">Manage Your Startup Budget</h3>
               <p className="text-lg text-violet-200 max-w-md mb-8">Start with $10,000. Make smart investment decisions. Calculate the expected value before deciding!</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-violet-500 hover:bg-violet-400 rounded-xl font-bold text-lg">
                  START INVESTING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{balance >= 15000 ? 'üèÜ' : balance >= 10000 ? 'üìà' : 'üìâ'}</div>
            <h2 className="text-3xl font-black mb-2">Final Balance: ${balance.toLocaleString()}</h2>
            <p className="text-violet-300 mb-6">{balance >= 15000 ? 'Excellent risk management!' : balance >= 10000 ? 'You grew your capital!' : 'Learning experience!'}</p>
            <button onClick={() => { setPhase('intro'); setBalance(10000); setRound(0); }} className="px-6 py-3 bg-violet-500 rounded-xl font-bold">PLAY AGAIN</button>
         </div>
      );

      const currentDecision = decisions[round];
      const expectedValue = (currentDecision.successChance * currentDecision.reward) - ((1 - currentDecision.successChance) * currentDecision.risk);

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Decision {round + 1}/{decisions.length}</span>
               <span className="px-4 py-2 bg-violet-500/30 rounded-full font-bold">üí∞ ${balance.toLocaleString()}</span>
            </div>
            {lastResult ? (
               <div className={`flex-1 flex items-center justify-center text-xl ${lastResult.startsWith('‚úì') ? 'text-green-400' : lastResult.startsWith('‚úó') ? 'text-red-400' : 'text-gray-400'}`}>
                  {lastResult}
               </div>
            ) : (
               <div className="flex-1 flex flex-col justify-center">
                  <div className="bg-black/30 rounded-2xl p-6 mb-6">
                     <p className="text-xl font-bold text-center mb-4">{currentDecision.scenario}</p>
                     <div className="grid grid-cols-3 gap-4 text-center text-sm">
                        <div className="bg-red-900/30 p-3 rounded-xl">
                           <p className="text-red-400 font-bold">Risk</p>
                           <p>${currentDecision.risk.toLocaleString()}</p>
                        </div>
                        <div className="bg-green-900/30 p-3 rounded-xl">
                           <p className="text-green-400 font-bold">Potential Reward</p>
                           <p>${currentDecision.reward.toLocaleString()}</p>
                        </div>
                        <div className="bg-blue-900/30 p-3 rounded-xl">
                           <p className="text-blue-400 font-bold">Success Rate</p>
                           <p>{(currentDecision.successChance * 100).toFixed(0)}%</p>
                        </div>
                     </div>
                     <p className="text-center mt-4 text-violet-300">Expected Value: <span className={expectedValue > 0 ? 'text-green-400' : 'text-red-400'}>${expectedValue.toFixed(0)}</span></p>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                     <button onClick={() => makeDecision(true)} className="p-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold">TAKE THE RISK</button>
                     <button onClick={() => makeDecision(false)} className="p-4 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold">PLAY IT SAFE</button>
                  </div>
               </div>
            )}
         </div>
      );
   };

   const ResilienceGritRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [motivation, setMotivation] = useState(100);
      const [day, setDay] = useState(1);
      const [successes, setSuccesses] = useState(0);

      const challenges = [
         { event: "First customer complained publicly", drain: 20, response: "Learn and improve", boost: 15 },
         { event: "Investor said no", drain: 25, response: "Find 10 more investors", boost: 20 },
         { event: "Key employee quit", drain: 30, response: "Hire someone better", boost: 25 },
         { event: "Product launch delayed", drain: 15, response: "Use time to improve", boost: 10 },
         { event: "Competitor copied your idea", drain: 20, response: "Innovate further", boost: 15 },
      ];

      const handleChallenge = (bounce: boolean) => {
         const challenge = challenges[day - 1];
         if (bounce) {
            setMotivation(m => Math.min(100, m - challenge.drain + challenge.boost));
            setSuccesses(s => s + 1);
         } else {
            setMotivation(m => m - challenge.drain);
         }
         if (day >= challenges.length || motivation <= 0) setPhase('result');
         else setDay(d => d + 1);
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-rose-900 via-pink-900 to-red-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üí™ RESILIENCE & GRIT</h2>
                  <p className="text-rose-300 text-sm mt-1">Bouncing Back from Setbacks</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Resilience:</strong> The ability to recover quickly from difficulties.</p>
                  <p className="mt-2"><strong>Grit:</strong> Passion and perseverance for long-term goals despite setbacks.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üî•</div>
               <h3 className="text-2xl font-bold mb-4">Survive the Startup Journey</h3>
               <p className="text-lg text-rose-200 max-w-md mb-8">Face challenges and choose how to respond. Maintain your motivation to succeed!</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-rose-500 hover:bg-rose-400 rounded-xl font-bold text-lg">
                  BEGIN JOURNEY ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-rose-900 via-pink-900 to-red-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{motivation > 0 ? 'üèÜ' : 'üíî'}</div>
            <h2 className="text-3xl font-black mb-2">{motivation > 0 ? 'You Made It!' : 'Burned Out'}</h2>
            <p className="text-rose-300 mb-2">Bounced back {successes} times</p>
            <p className="text-rose-300 mb-6">Final motivation: {motivation}%</p>
            <button onClick={() => { setPhase('intro'); setMotivation(100); setDay(1); setSuccesses(0); }} className="px-6 py-3 bg-rose-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-rose-900 via-pink-900 to-red-900 text-white p-8">
            <div className="flex justify-between mb-4">
               <span className="text-sm">Day {day}</span>
               <span className="px-4 py-2 bg-rose-500/30 rounded-full font-bold">üî• {motivation}%</span>
            </div>
            <div className="w-full bg-black/30 rounded-full h-4 mb-6">
               <div className="bg-gradient-to-r from-rose-500 to-orange-500 h-4 rounded-full transition-all" style={{ width: `${motivation}%` }}></div>
            </div>
            <div className="flex-1 flex flex-col justify-center">
               <div className="bg-black/30 rounded-2xl p-6 mb-6 text-center">
                  <p className="text-red-400 text-sm mb-2">‚ö†Ô∏è SETBACK</p>
                  <p className="text-xl font-bold">{challenges[day - 1].event}</p>
                  <p className="text-rose-300 mt-2">Motivation drain: -{challenges[day - 1].drain}%</p>
               </div>
               <div className="grid grid-cols-2 gap-4">
                  <button onClick={() => handleChallenge(true)} className="p-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-sm">
                     üîÑ BOUNCE BACK<br/><span className="text-xs opacity-75">{challenges[day - 1].response}</span>
                  </button>
                  <button onClick={() => handleChallenge(false)} className="p-4 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-sm">
                     üòî GIVE UP<br/><span className="text-xs opacity-75">Accept the loss</span>
                  </button>
               </div>
            </div>
         </div>
      );
   };

   const ScamperCreativityRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentTechnique, setCurrentTechnique] = useState(0);
      const [ideas, setIdeas] = useState<string[]>([]);
      const [inputValue, setInputValue] = useState('');

      const scamper = [
         { letter: 'S', name: 'Substitute', prompt: 'What can you substitute in a coffee shop?', example: 'Substitute baristas with self-serve machines' },
         { letter: 'C', name: 'Combine', prompt: 'What can you combine with a gym?', example: 'Combine gym with coworking space' },
         { letter: 'A', name: 'Adapt', prompt: 'How can you adapt a bookstore?', example: 'Adapt to include book-themed escape rooms' },
         { letter: 'M', name: 'Modify', prompt: 'What can you modify about restaurants?', example: 'Modify to complete darkness dining experience' },
         { letter: 'P', name: 'Put to other uses', prompt: 'How else can you use a parking lot?', example: 'Use for weekend farmers markets' },
         { letter: 'E', name: 'Eliminate', prompt: 'What can you eliminate from hotels?', example: 'Eliminate check-in desks with app-based entry' },
         { letter: 'R', name: 'Reverse/Rearrange', prompt: 'What can you reverse about retail?', example: 'Reverse: customers set prices' },
      ];

      const submitIdea = () => {
         if (inputValue.trim()) {
            setIdeas([...ideas, inputValue.trim()]);
            setInputValue('');
            if (currentTechnique < scamper.length - 1) setCurrentTechnique(c => c + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-yellow-900 via-amber-800 to-orange-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üí° SCAMPER CREATIVITY</h2>
                  <p className="text-yellow-300 text-sm mt-1">Innovation Technique</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>SCAMPER:</strong> A creative thinking technique using 7 strategies:</p>
                  <p className="mt-1">Substitute, Combine, Adapt, Modify, Put to other uses, Eliminate, Reverse</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üé®</div>
               <h3 className="text-2xl font-bold mb-4">Generate Business Ideas</h3>
               <p className="text-lg text-yellow-200 max-w-md mb-8">Use SCAMPER techniques to innovate on existing businesses and create new opportunities.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-yellow-500 hover:bg-yellow-400 rounded-xl font-bold text-lg text-black">
                  START CREATING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-yellow-900 via-amber-800 to-orange-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your SCAMPER Ideas!</h2>
            <div className="flex-1 overflow-auto">
               {ideas.map((idea, i) => (
                  <div key={i} className="bg-black/30 rounded-xl p-4 mb-3">
                     <span className="text-yellow-400 font-bold">{scamper[i].letter}:</span> {idea}
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setIdeas([]); setCurrentTechnique(0); }} className="px-6 py-3 bg-yellow-500 rounded-xl font-bold text-black mt-4">CREATE MORE</button>
         </div>
      );

      const current = scamper[currentTechnique];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-yellow-900 via-amber-800 to-orange-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {scamper.map((s, i) => (
                  <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${i === currentTechnique ? 'bg-yellow-500 text-black' : i < currentTechnique ? 'bg-green-500' : 'bg-black/30'}`}>
                     {s.letter}
                  </div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4">
               <p className="text-yellow-400 font-bold text-2xl mb-2">{current.letter} = {current.name}</p>
               <p className="text-lg mb-4">{current.prompt}</p>
               <p className="text-sm text-yellow-300/60">Example: {current.example}</p>
            </div>
            <input
               type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Type your idea..." onKeyDown={(e) => e.key === 'Enter' && submitIdea()}
               className="w-full p-4 rounded-xl bg-black/30 border border-yellow-500/30 text-white mb-4"
            />
            <button onClick={submitIdea} className="px-6 py-3 bg-yellow-500 rounded-xl font-bold text-black">SUBMIT & NEXT ‚Üí</button>
         </div>
      );
   };

   const CriticalThinkingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [currentQ, setCurrentQ] = useState(0);

      const questions = [
         { statement: "Our product failed because the market wasn't ready.", fallacy: "External Attribution Bias", answer: "B", options: ["A: Valid reasoning", "B: Logical fallacy - may ignore internal issues", "C: Insufficient data"] },
         { statement: "This famous entrepreneur uses this method, so it must work.", fallacy: "Appeal to Authority", answer: "B", options: ["A: Sound logic", "B: Logical fallacy - success isn't always replicable", "C: Needs more research"] },
         { statement: "We've always done it this way, so we should continue.", fallacy: "Appeal to Tradition", answer: "B", options: ["A: Good reasoning", "B: Logical fallacy - past ‚â† optimal", "C: Depends on context"] },
         { statement: "If we don't launch now, competitors will destroy us.", fallacy: "False Dilemma", answer: "B", options: ["A: Valid urgency", "B: Logical fallacy - false binary choice", "C: True statement"] },
      ];

      const handleAnswer = (answer: string) => {
         if (answer === questions[currentQ].answer) setScore(s => s + 25);
         if (currentQ < questions.length - 1) setCurrentQ(c => c + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üßê CRITICAL THINKING</h2>
                  <p className="text-cyan-300 text-sm mt-1">Spot Logical Fallacies</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Critical Thinking:</strong> Analyzing information objectively to form reasoned judgments.</p>
                  <p className="mt-2">Key skill: Identifying logical fallacies that can lead to poor business decisions.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üî¨</div>
               <h3 className="text-2xl font-bold mb-4">Analyze Business Statements</h3>
               <p className="text-lg text-cyan-200 max-w-md mb-8">Identify logical fallacies in common business reasoning to make better decisions.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 rounded-xl font-bold text-lg">
                  START ANALYSIS ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-blue-900 to-indigo-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 75 ? 'üèÜ' : 'üìö'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-cyan-300 mb-6">{score >= 75 ? 'Sharp critical thinker!' : 'Keep practicing logic!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-cyan-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Question {currentQ + 1}/{questions.length}</span>
               <span className="px-4 py-2 bg-cyan-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold italic">"{questions[currentQ].statement}"</p>
            </div>
            <div className="flex-1 flex flex-col gap-3">
               {questions[currentQ].options.map((opt, i) => (
                  <button key={i} onClick={() => handleAnswer(opt[0])} className="p-4 bg-cyan-900/50 hover:bg-cyan-800/50 rounded-xl text-left transition-all">
                     {opt}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   const SelfRelianceRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [resources, setResources] = useState({ money: 500, time: 40, skills: 3 });
      const [tasksCompleted, setTasksCompleted] = useState(0);

      const tasks = [
         { name: "Build a landing page", diy: { time: 8, skills: 1 }, outsource: { money: 200 } },
         { name: "Create a logo", diy: { time: 4, skills: 1 }, outsource: { money: 100 } },
         { name: "Write marketing copy", diy: { time: 6, skills: 1 }, outsource: { money: 150 } },
         { name: "Set up accounting", diy: { time: 10, skills: 1 }, outsource: { money: 300 } },
      ];

      const handleTask = (diy: boolean) => {
         const task = tasks[tasksCompleted];
         if (diy) {
            if (resources.time >= task.diy.time && resources.skills >= task.diy.skills) {
               setResources(r => ({ ...r, time: r.time - task.diy.time, skills: r.skills + 1 }));
               setTasksCompleted(t => t + 1);
            }
         } else {
            if (resources.money >= task.outsource.money) {
               setResources(r => ({ ...r, money: r.money - task.outsource.money }));
               setTasksCompleted(t => t + 1);
            }
         }
         if (tasksCompleted >= tasks.length - 1) setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-zinc-800 to-neutral-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîß SELF-RELIANCE</h2>
                  <p className="text-slate-300 text-sm mt-1">Bootstrap Your Startup</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Self-Reliance:</strong> The ability to do things yourself when resources are limited.</p>
                  <p className="mt-2">DIY builds skills but costs time. Outsourcing saves time but costs money.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üõ†Ô∏è</div>
               <h3 className="text-2xl font-bold mb-4">Build vs Buy Decisions</h3>
               <p className="text-lg text-slate-200 max-w-md mb-8">Manage limited resources. Choose when to DIY and when to outsource.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-slate-500 hover:bg-slate-400 rounded-xl font-bold text-lg">
                  START BUILDING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-zinc-800 to-neutral-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">üéâ</div>
            <h2 className="text-3xl font-black mb-4">Startup Launched!</h2>
            <div className="grid grid-cols-3 gap-4 mb-6">
               <div className="text-center"><p className="text-2xl">üí∞</p><p>${resources.money}</p><p className="text-xs text-slate-400">Remaining</p></div>
               <div className="text-center"><p className="text-2xl">‚è∞</p><p>{resources.time}h</p><p className="text-xs text-slate-400">Time Left</p></div>
               <div className="text-center"><p className="text-2xl">üìö</p><p>{resources.skills}</p><p className="text-xs text-slate-400">Skills Gained</p></div>
            </div>
            <button onClick={() => { setPhase('intro'); setResources({ money: 500, time: 40, skills: 3 }); setTasksCompleted(0); }} className="px-6 py-3 bg-slate-500 rounded-xl font-bold">PLAY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-zinc-800 to-neutral-900 text-white p-8">
            <div className="grid grid-cols-3 gap-4 mb-6">
               <div className="bg-green-900/30 p-3 rounded-xl text-center"><p className="text-green-400">üí∞ ${resources.money}</p></div>
               <div className="bg-blue-900/30 p-3 rounded-xl text-center"><p className="text-blue-400">‚è∞ {resources.time}h</p></div>
               <div className="bg-purple-900/30 p-3 rounded-xl text-center"><p className="text-purple-400">üìö {resources.skills} skills</p></div>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold text-center">{tasks[tasksCompleted]?.name || 'Complete!'}</p>
            </div>
            {tasks[tasksCompleted] && (
               <div className="grid grid-cols-2 gap-4">
                  <button onClick={() => handleTask(true)} className="p-4 bg-purple-600 hover:bg-purple-500 rounded-xl text-sm"
                     disabled={resources.time < tasks[tasksCompleted].diy.time}>
                     üîß DIY<br/>
                     <span className="text-xs">-{tasks[tasksCompleted].diy.time}h, +1 skill</span>
                  </button>
                  <button onClick={() => handleTask(false)} className="p-4 bg-green-600 hover:bg-green-500 rounded-xl text-sm"
                     disabled={resources.money < tasks[tasksCompleted].outsource.money}>
                     üí∏ OUTSOURCE<br/>
                     <span className="text-xs">-${tasks[tasksCompleted].outsource.money}</span>
                  </button>
               </div>
            )}
         </div>
      );
   };

   const AdaptabilityPivotRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [scenario, setScenario] = useState(0);
      const [pivotScore, setPivotScore] = useState(0);

      const scenarios = [
         { situation: "Your B2B software isn't selling to enterprises.", pivot: "Pivot to SMB market with simpler pricing", persist: "Keep trying to land big clients", correct: 'pivot' },
         { situation: "Users love your app but won't pay for it.", pivot: "Switch to freemium with premium features", persist: "Keep the current pricing model", correct: 'pivot' },
         { situation: "Initial market research was slightly off on timing.", pivot: "Completely rebuild the product", persist: "Adjust marketing and wait for market", correct: 'persist' },
         { situation: "You have strong product-market fit in a niche.", pivot: "Expand to broader market immediately", persist: "Dominate the niche first", correct: 'persist' },
      ];

      const handleChoice = (choice: string) => {
         if (choice === scenarios[scenario].correct) setPivotScore(s => s + 25);
         if (scenario < scenarios.length - 1) setScenario(s => s + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîÑ ADAPTABILITY & PIVOT</h2>
                  <p className="text-teal-300 text-sm mt-1">When to Pivot vs Persist</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Pivot:</strong> A structured course correction to test a new hypothesis.</p>
                  <p className="mt-2"><strong>Key:</strong> Pivot when data shows a fundamental flaw. Persist when adjustments can work.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üîÄ</div>
               <h3 className="text-2xl font-bold mb-4">Pivot or Persist?</h3>
               <p className="text-lg text-teal-200 max-w-md mb-8">Learn when to change direction and when to stay the course.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-teal-500 hover:bg-teal-400 rounded-xl font-bold text-lg">
                  START SCENARIOS ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{pivotScore >= 75 ? 'üèÜ' : 'üìà'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {pivotScore}%</h2>
            <p className="text-teal-300 mb-6">{pivotScore >= 75 ? 'Expert decision maker!' : 'Learning when to pivot takes practice!'}</p>
            <button onClick={() => { setPhase('intro'); setPivotScore(0); setScenario(0); }} className="px-6 py-3 bg-teal-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Scenario {scenario + 1}/{scenarios.length}</span>
               <span className="px-4 py-2 bg-teal-500/30 rounded-full font-bold">Score: {pivotScore}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold text-center">{scenarios[scenario].situation}</p>
            </div>
            <div className="grid grid-cols-1 gap-4">
               <button onClick={() => handleChoice('pivot')} className="p-4 bg-orange-600 hover:bg-orange-500 rounded-xl text-left">
                  üîÑ <strong>PIVOT:</strong> {scenarios[scenario].pivot}
               </button>
               <button onClick={() => handleChoice('persist')} className="p-4 bg-blue-600 hover:bg-blue-500 rounded-xl text-left">
                  üí™ <strong>PERSIST:</strong> {scenarios[scenario].persist}
               </button>
            </div>
         </div>
      );
   };

   const EmpathyMappingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [quadrant, setQuadrant] = useState(0);
      const [responses, setResponses] = useState<Record<string, string>>({});
      const [inputValue, setInputValue] = useState('');

      const quadrants = [
         { name: 'THINKS', icon: 'üí≠', prompt: 'What does your customer think about their problem?', color: 'from-blue-600 to-blue-800' },
         { name: 'FEELS', icon: '‚ù§Ô∏è', prompt: 'What emotions does your customer experience?', color: 'from-red-600 to-red-800' },
         { name: 'SAYS', icon: 'üí¨', prompt: 'What does your customer say to others about this?', color: 'from-green-600 to-green-800' },
         { name: 'DOES', icon: 'üèÉ', prompt: 'What actions does your customer take?', color: 'from-purple-600 to-purple-800' },
      ];

      const submitResponse = () => {
         if (inputValue.trim()) {
            setResponses({ ...responses, [quadrants[quadrant].name]: inputValue });
            setInputValue('');
            if (quadrant < quadrants.length - 1) setQuadrant(q => q + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üéØ EMPATHY MAPPING</h2>
                  <p className="text-pink-300 text-sm mt-1">Understand Your Customer</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Empathy Map:</strong> A tool to understand customers by exploring what they Think, Feel, Say, and Do.</p>
                  <p className="mt-2">Used in design thinking to build customer-centric products.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üé≠</div>
               <h3 className="text-2xl font-bold mb-4">Build an Empathy Map</h3>
               <p className="text-lg text-pink-200 max-w-md mb-8">Create a complete picture of your target customer's experience.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-pink-500 hover:bg-pink-400 rounded-xl font-bold text-lg">
                  START MAPPING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">Your Empathy Map</h2>
            <div className="grid grid-cols-2 gap-4 flex-1">
               {quadrants.map((q) => (
                  <div key={q.name} className={`bg-gradient-to-br ${q.color} rounded-xl p-4`}>
                     <p className="font-bold text-lg">{q.icon} {q.name}</p>
                     <p className="text-sm mt-2 opacity-90">{responses[q.name]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setQuadrant(0); setResponses({}); }} className="px-6 py-3 bg-pink-500 rounded-xl font-bold mt-4">CREATE NEW MAP</button>
         </div>
      );

      const current = quadrants[quadrant];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {quadrants.map((q, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= quadrant ? 'bg-pink-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className={`bg-gradient-to-br ${current.color} rounded-2xl p-6 mb-6 text-center`}>
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-2xl font-black mb-2">{current.name}</p>
               <p className="text-lg opacity-90">{current.prompt}</p>
            </div>
            <input
               type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Enter your observation..." onKeyDown={(e) => e.key === 'Enter' && submitResponse()}
               className="w-full p-4 rounded-xl bg-black/30 border border-pink-500/30 text-white mb-4"
            />
            <button onClick={submitResponse} className="px-6 py-3 bg-pink-500 rounded-xl font-bold">NEXT QUADRANT ‚Üí</button>
         </div>
      );
   };

   const EthicalLeadershipRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [dilemma, setDilemma] = useState(0);

      const dilemmas = [
         { situation: "You discover your product has a minor defect. No one has complained yet.", ethical: "Issue a recall and fix it proactively", unethical: "Wait and see if anyone notices", correct: 'ethical' },
         { situation: "A competitor's employee wants to share their trade secrets with you.", ethical: "Decline and compete fairly", unethical: "Accept the inside information", correct: 'ethical' },
         { situation: "You can cut costs by using cheaper materials that are just below safety standards.", ethical: "Maintain higher quality standards", unethical: "Use cheaper materials to boost margins", correct: 'ethical' },
         { situation: "Your marketing team suggests exaggerating product benefits in ads.", ethical: "Insist on accurate, honest advertising", unethical: "Approve the exaggerated claims", correct: 'ethical' },
      ];

      const handleChoice = (choice: string) => {
         if (choice === dilemmas[dilemma].correct) setScore(s => s + 25);
         if (dilemma < dilemmas.length - 1) setDilemma(d => d + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-violet-900 to-purple-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">‚öñÔ∏è ETHICAL LEADERSHIP</h2>
                  <p className="text-indigo-300 text-sm mt-1">Values-Based Decision Making</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Ethical Leadership:</strong> Making decisions that prioritize integrity, transparency, and social responsibility.</p>
                  <p className="mt-2">Long-term success is built on trust and ethical practices.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üëë</div>
               <h3 className="text-2xl font-bold mb-4">Navigate Ethical Dilemmas</h3>
               <p className="text-lg text-indigo-200 max-w-md mb-8">Face real business ethics scenarios and make principled choices.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-bold text-lg">
                  FACE DILEMMAS ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-violet-900 to-purple-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score === 100 ? 'üëë' : score >= 50 ? 'üìà' : 'ü§î'}</div>
            <h2 className="text-3xl font-black mb-2">Ethics Score: {score}%</h2>
            <p className="text-indigo-300 mb-6">{score === 100 ? 'Exemplary ethical leader!' : 'Ethics require constant practice.'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setDilemma(0); }} className="px-6 py-3 bg-indigo-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-violet-900 to-purple-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Dilemma {dilemma + 1}/{dilemmas.length}</span>
               <span className="px-4 py-2 bg-indigo-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold text-center">{dilemmas[dilemma].situation}</p>
            </div>
            <div className="grid grid-cols-1 gap-4">
               <button onClick={() => handleChoice('ethical')} className="p-4 bg-green-600 hover:bg-green-500 rounded-xl text-left">
                  ‚úì <strong>Ethical:</strong> {dilemmas[dilemma].ethical}
               </button>
               <button onClick={() => handleChoice('unethical')} className="p-4 bg-red-600 hover:bg-red-500 rounded-xl text-left">
                  ‚úó <strong>Unethical:</strong> {dilemmas[dilemma].unethical}
               </button>
            </div>
         </div>
      );
   };

   // --- ENTREPRENEURSHIP: IDEATION & DESIGN THINKING RENDERERS ---

   const DesignThinkingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentStep, setCurrentStep] = useState(0);
      const [responses, setResponses] = useState<string[]>([]);
      const [inputValue, setInputValue] = useState('');

      const steps = [
         { name: 'EMPATHIZE', icon: '‚ù§Ô∏è', prompt: 'Describe a problem someone faces daily', color: 'from-pink-600 to-rose-700' },
         { name: 'DEFINE', icon: 'üéØ', prompt: 'Reframe as a "How Might We" statement', color: 'from-purple-600 to-indigo-700' },
         { name: 'IDEATE', icon: 'üí°', prompt: 'List 3 wild solution ideas', color: 'from-yellow-500 to-orange-600' },
         { name: 'PROTOTYPE', icon: 'üîß', prompt: 'Describe a quick test version', color: 'from-green-500 to-teal-600' },
         { name: 'TEST', icon: 'üß™', prompt: 'How would you get user feedback?', color: 'from-blue-500 to-cyan-600' },
      ];

      const submitResponse = () => {
         if (inputValue.trim()) {
            setResponses([...responses, inputValue.trim()]);
            setInputValue('');
            if (currentStep < steps.length - 1) setCurrentStep(s => s + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üé® DESIGN THINKING</h2>
                  <p className="text-purple-300 text-sm mt-1">Human-Centered Innovation</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Design Thinking:</strong> A 5-stage process for creative problem-solving:</p>
                  <p className="mt-1">Empathize ‚Üí Define ‚Üí Ideate ‚Üí Prototype ‚Üí Test</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="flex gap-2 mb-6">{steps.map((s, i) => <span key={i} className="text-3xl">{s.icon}</span>)}</div>
               <h3 className="text-2xl font-bold mb-4">Walk Through the Process</h3>
               <p className="text-lg text-purple-200 max-w-md mb-8">Experience all 5 stages of design thinking to solve a real problem.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-purple-500 hover:bg-purple-400 rounded-xl font-bold text-lg">
                  START DESIGNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your Design Sprint!</h2>
            <div className="flex-1 overflow-auto space-y-3">
               {steps.map((step, i) => (
                  <div key={i} className={`bg-gradient-to-r ${step.color} rounded-xl p-4`}>
                     <p className="font-bold">{step.icon} {step.name}</p>
                     <p className="text-sm mt-1 opacity-90">{responses[i]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setResponses([]); setCurrentStep(0); }} className="px-6 py-3 bg-purple-500 rounded-xl font-bold mt-4">START NEW</button>
         </div>
      );

      const current = steps[currentStep];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {steps.map((s, i) => (
                  <div key={i} className={`flex-1 h-3 rounded-full transition-all ${i <= currentStep ? `bg-gradient-to-r ${s.color}` : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className={`bg-gradient-to-r ${current.color} rounded-2xl p-6 mb-6 text-center`}>
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-2xl font-black">{current.name}</p>
               <p className="mt-2 opacity-90">{current.prompt}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your response..." className="flex-1 p-4 rounded-xl bg-black/30 border border-purple-500/30 text-white mb-4 resize-none" />
            <button onClick={submitResponse} className="px-6 py-3 bg-purple-500 rounded-xl font-bold">NEXT STEP ‚Üí</button>
         </div>
      );
   };

   const ProblemSolutionFitRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [matches, setMatches] = useState<{problem: string; solution: string; correct: boolean}[]>([]);
      const [selectedProblem, setSelectedProblem] = useState<string | null>(null);

      const problems = ["Long commute", "Expensive gym", "Lonely elderly", "Food waste"];
      const solutions = ["Carpooling app", "Home workout videos", "Companion calling service", "Leftover marketplace"];
      const correctPairs: Record<string, string> = {
         "Long commute": "Carpooling app",
         "Expensive gym": "Home workout videos",
         "Lonely elderly": "Companion calling service",
         "Food waste": "Leftover marketplace"
      };

      const handleSolutionClick = (solution: string) => {
         if (selectedProblem) {
            const correct = correctPairs[selectedProblem] === solution;
            setMatches([...matches, { problem: selectedProblem, solution, correct }]);
            setSelectedProblem(null);
            if (matches.length >= 3) setTimeout(() => setPhase('result'), 500);
         }
      };

      const score = matches.filter(m => m.correct).length * 25;

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-red-900 to-pink-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîó PROBLEM-SOLUTION FIT</h2>
                  <p className="text-orange-300 text-sm mt-1">Match Problems to Solutions</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Problem-Solution Fit:</strong> Ensuring your solution directly addresses a real customer problem.</p>
                  <p className="mt-2">Key: The solution must solve the problem better than alternatives.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üß©</div>
               <h3 className="text-2xl font-bold mb-4">Find the Right Match</h3>
               <p className="text-lg text-orange-200 max-w-md mb-8">Connect each problem to its best solution. Good fit = successful startup!</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-orange-500 hover:bg-orange-400 rounded-xl font-bold text-lg">
                  START MATCHING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-red-900 to-pink-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score === 100 ? 'üèÜ' : 'üìä'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-orange-300 mb-6">{score === 100 ? 'Perfect problem-solution fit!' : 'Some matches need work!'}</p>
            <button onClick={() => { setPhase('intro'); setMatches([]); }} className="px-6 py-3 bg-orange-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      const usedProblems = matches.map(m => m.problem);
      const usedSolutions = matches.map(m => m.solution);

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-red-900 to-pink-900 text-white p-8">
            <p className="text-center mb-4">Click a problem, then click its solution</p>
            <div className="grid grid-cols-2 gap-4 flex-1">
               <div className="space-y-2">
                  <p className="font-bold text-center text-orange-300">PROBLEMS</p>
                  {problems.map(p => (
                     <button key={p} onClick={() => !usedProblems.includes(p) && setSelectedProblem(p)}
                        disabled={usedProblems.includes(p)}
                        className={`w-full p-3 rounded-xl text-sm transition-all ${usedProblems.includes(p) ? 'bg-green-500/50' : selectedProblem === p ? 'bg-orange-500 ring-2 ring-white' : 'bg-black/30 hover:bg-black/50'}`}>
                        {p}
                     </button>
                  ))}
               </div>
               <div className="space-y-2">
                  <p className="font-bold text-center text-pink-300">SOLUTIONS</p>
                  {solutions.map(s => (
                     <button key={s} onClick={() => selectedProblem && !usedSolutions.includes(s) && handleSolutionClick(s)}
                        disabled={usedSolutions.includes(s) || !selectedProblem}
                        className={`w-full p-3 rounded-xl text-sm transition-all ${usedSolutions.includes(s) ? 'bg-green-500/50' : 'bg-black/30 hover:bg-black/50'}`}>
                        {s}
                     </button>
                  ))}
               </div>
            </div>
         </div>
      );
   };

   const CustomerDiscoveryRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentQ, setCurrentQ] = useState(0);
      const [score, setScore] = useState(0);

      const questions = [
         { q: "Which question is best to ask potential customers?", good: "What's the hardest part of your day?", bad: "Would you buy my product?", correct: 'good' },
         { q: "How should you conduct customer interviews?", good: "Listen more than you talk (80/20 rule)", bad: "Pitch your idea and ask for feedback", correct: 'good' },
         { q: "When should you mention your solution?", good: "After understanding their problems deeply", bad: "At the start to gauge interest", correct: 'good' },
         { q: "What's a red flag in customer discovery?", good: "Everyone says they'd 'definitely' buy", bad: "People describe specific pain points", correct: 'good' },
      ];

      const handleAnswer = (answer: string) => {
         if (answer === questions[currentQ].correct) setScore(s => s + 25);
         if (currentQ < questions.length - 1) setCurrentQ(q => q + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üî¨ CUSTOMER DISCOVERY</h2>
                  <p className="text-blue-300 text-sm mt-1">Talk to Real Customers</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Customer Discovery:</strong> The process of validating your assumptions by talking to potential customers.</p>
                  <p className="mt-2">Goal: Learn what customers actually need, not what you think they need.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üéôÔ∏è</div>
               <h3 className="text-2xl font-bold mb-4">Master the Interview</h3>
               <p className="text-lg text-blue-200 max-w-md mb-8">Learn the right way to talk to customers and validate your ideas.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-blue-500 hover:bg-blue-400 rounded-xl font-bold text-lg">
                  START LEARNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 75 ? 'üèÜ' : 'üìö'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-blue-300 mb-6">{score >= 75 ? 'Interview master!' : 'Keep practicing your interview skills!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-blue-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Question {currentQ + 1}/{questions.length}</span>
               <span className="px-4 py-2 bg-blue-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold text-center">{questions[currentQ].q}</p>
            </div>
            <div className="space-y-4">
               <button onClick={() => handleAnswer('good')} className="w-full p-4 bg-green-900/50 hover:bg-green-800/50 rounded-xl text-left">
                  ‚úì {questions[currentQ].good}
               </button>
               <button onClick={() => handleAnswer('bad')} className="w-full p-4 bg-red-900/50 hover:bg-red-800/50 rounded-xl text-left">
                  ‚úó {questions[currentQ].bad}
               </button>
            </div>
         </div>
      );
   };

   const UserPersonasRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [step, setStep] = useState(0);
      const [persona, setPersona] = useState({ name: '', age: '', job: '', goal: '', pain: '' });

      const fields = [
         { key: 'name', label: 'Name', placeholder: 'e.g., Busy Betty', icon: 'üë§' },
         { key: 'age', label: 'Age & Location', placeholder: 'e.g., 35, San Francisco', icon: 'üìç' },
         { key: 'job', label: 'Job Title', placeholder: 'e.g., Marketing Manager', icon: 'üíº' },
         { key: 'goal', label: 'Main Goal', placeholder: 'e.g., Save time on daily tasks', icon: 'üéØ' },
         { key: 'pain', label: 'Biggest Pain Point', placeholder: 'e.g., Too many meetings', icon: 'üò§' },
      ];

      const handleNext = () => {
         if (step < fields.length - 1) setStep(s => s + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-fuchsia-900 via-purple-900 to-violet-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üë• USER PERSONAS</h2>
                  <p className="text-fuchsia-300 text-sm mt-1">Know Your Customer</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>User Persona:</strong> A semi-fictional representation of your ideal customer based on research.</p>
                  <p className="mt-2">Helps teams align on who they're building for.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üé≠</div>
               <h3 className="text-2xl font-bold mb-4">Create a User Persona</h3>
               <p className="text-lg text-fuchsia-200 max-w-md mb-8">Build a detailed profile of your ideal customer step by step.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-fuchsia-500 hover:bg-fuchsia-400 rounded-xl font-bold text-lg">
                  START BUILDING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-fuchsia-900 via-purple-900 to-violet-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your Persona</h2>
            <div className="bg-black/30 rounded-2xl p-6 flex-1">
               <div className="text-center mb-4">
                  <div className="text-6xl mb-2">üë§</div>
                  <p className="text-2xl font-black">{persona.name || 'New Persona'}</p>
                  <p className="text-fuchsia-300">{persona.age}</p>
               </div>
               <div className="space-y-3">
                  <div className="bg-white/10 p-3 rounded-xl"><span className="font-bold">üíº Job:</span> {persona.job}</div>
                  <div className="bg-white/10 p-3 rounded-xl"><span className="font-bold">üéØ Goal:</span> {persona.goal}</div>
                  <div className="bg-white/10 p-3 rounded-xl"><span className="font-bold">üò§ Pain:</span> {persona.pain}</div>
               </div>
            </div>
            <button onClick={() => { setPhase('intro'); setStep(0); setPersona({ name: '', age: '', job: '', goal: '', pain: '' }); }} className="px-6 py-3 bg-fuchsia-500 rounded-xl font-bold mt-4">CREATE ANOTHER</button>
         </div>
      );

      const current = fields[step];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-fuchsia-900 via-purple-900 to-violet-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {fields.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-fuchsia-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-xl font-bold">{current.label}</p>
            </div>
            <input
               type="text" value={persona[current.key as keyof typeof persona]}
               onChange={(e) => setPersona({ ...persona, [current.key]: e.target.value })}
               placeholder={current.placeholder}
               className="w-full p-4 rounded-xl bg-black/30 border border-fuchsia-500/30 text-white mb-4"
            />
            <button onClick={handleNext} className="px-6 py-3 bg-fuchsia-500 rounded-xl font-bold">
               {step < fields.length - 1 ? 'NEXT ‚Üí' : 'FINISH'}
            </button>
         </div>
      );
   };

   const ValuePropositionRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [step, setStep] = useState(0);
      const [vp, setVp] = useState({ customer: '', problem: '', solution: '', benefit: '' });

      const steps = [
         { key: 'customer', label: 'Target Customer', prompt: 'Who is your ideal customer?', example: 'Busy professionals aged 25-40' },
         { key: 'problem', label: 'Problem', prompt: 'What problem do they face?', example: 'No time to cook healthy meals' },
         { key: 'solution', label: 'Solution', prompt: 'What do you offer?', example: 'Pre-portioned meal kits with 15-min recipes' },
         { key: 'benefit', label: 'Key Benefit', prompt: 'What makes you different?', example: 'Save 5 hours/week while eating healthy' },
      ];

      const handleNext = () => {
         if (step < steps.length - 1) setStep(s => s + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üíé VALUE PROPOSITION</h2>
                  <p className="text-green-300 text-sm mt-1">Your Unique Promise</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Value Proposition:</strong> A clear statement of how your product solves problems and delivers benefits.</p>
                  <p className="mt-2">Formula: For [customer] who [problem], our [product] provides [benefit].</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üí∞</div>
               <h3 className="text-2xl font-bold mb-4">Craft Your Value Prop</h3>
               <p className="text-lg text-green-200 max-w-md mb-8">Build a compelling value proposition that tells customers why they should choose you.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-green-500 hover:bg-green-400 rounded-xl font-bold text-lg">
                  START CRAFTING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your Value Proposition</h2>
            <div className="bg-black/30 rounded-2xl p-6 flex-1">
               <p className="text-xl leading-relaxed">
                  For <span className="text-green-400 font-bold">{vp.customer}</span> who{' '}
                  <span className="text-yellow-400 font-bold">{vp.problem}</span>, our solution provides{' '}
                  <span className="text-blue-400 font-bold">{vp.solution}</span> so they can{' '}
                  <span className="text-pink-400 font-bold">{vp.benefit}</span>.
               </p>
            </div>
            <button onClick={() => { setPhase('intro'); setStep(0); setVp({ customer: '', problem: '', solution: '', benefit: '' }); }} className="px-6 py-3 bg-green-500 rounded-xl font-bold mt-4">CREATE NEW</button>
         </div>
      );

      const current = steps[step];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {steps.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-green-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4">
               <p className="text-xl font-bold mb-2">{current.label}</p>
               <p className="text-green-300">{current.prompt}</p>
               <p className="text-sm text-green-400/60 mt-2">Example: {current.example}</p>
            </div>
            <input
               type="text" value={vp[current.key as keyof typeof vp]}
               onChange={(e) => setVp({ ...vp, [current.key]: e.target.value })}
               placeholder="Enter your answer..."
               className="w-full p-4 rounded-xl bg-black/30 border border-green-500/30 text-white mb-4"
            />
            <button onClick={handleNext} className="px-6 py-3 bg-green-500 rounded-xl font-bold">
               {step < steps.length - 1 ? 'NEXT ‚Üí' : 'FINISH'}
            </button>
         </div>
      );
   };

   const PrototypingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [fidelity, setFidelity] = useState<'low' | 'medium' | 'high' | null>(null);
      const [score, setScore] = useState(0);
      const [currentQ, setCurrentQ] = useState(0);

      const scenarios = [
         { situation: "Testing if users understand your app's navigation", best: 'low', reason: 'Paper sketches are fastest for testing basic UX' },
         { situation: "Pitching to investors next week", best: 'high', reason: 'High-fidelity creates professional impression' },
         { situation: "Validating a new feature concept", best: 'medium', reason: 'Clickable wireframes balance speed and clarity' },
         { situation: "First day exploring an idea", best: 'low', reason: 'Quick sketches help you iterate faster' },
      ];

      const handleAnswer = (answer: 'low' | 'medium' | 'high') => {
         if (answer === scenarios[currentQ].best) setScore(s => s + 25);
         setFidelity(answer);
         setTimeout(() => {
            setFidelity(null);
            if (currentQ < scenarios.length - 1) setCurrentQ(q => q + 1);
            else setPhase('result');
         }, 2000);
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîß PROTOTYPING</h2>
                  <p className="text-sky-300 text-sm mt-1">Build to Learn</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Prototyping:</strong> Creating quick, testable versions of your product.</p>
                  <p className="mt-2">Types: Low-fidelity (sketches), Medium (wireframes), High (polished mockups)</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üõ†Ô∏è</div>
               <h3 className="text-2xl font-bold mb-4">Choose the Right Prototype</h3>
               <p className="text-lg text-sky-200 max-w-md mb-8">Learn when to use different fidelity levels for maximum learning.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-sky-500 hover:bg-sky-400 rounded-xl font-bold text-lg">
                  START LEARNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 75 ? 'üèÜ' : 'üìö'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-sky-300 mb-6">{score >= 75 ? 'Prototyping pro!' : 'Keep practicing!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-sky-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Scenario {currentQ + 1}/{scenarios.length}</span>
               <span className="px-4 py-2 bg-sky-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6">
               <p className="text-xl font-bold text-center">{scenarios[currentQ].situation}</p>
            </div>
            {fidelity ? (
               <div className={`flex-1 flex flex-col items-center justify-center ${fidelity === scenarios[currentQ].best ? 'text-green-400' : 'text-red-400'}`}>
                  <p className="text-2xl mb-2">{fidelity === scenarios[currentQ].best ? '‚úì Correct!' : '‚úó Not ideal'}</p>
                  <p className="text-center opacity-75">{scenarios[currentQ].reason}</p>
               </div>
            ) : (
               <div className="grid grid-cols-3 gap-4 flex-1">
                  <button onClick={() => handleAnswer('low')} className="bg-yellow-900/50 hover:bg-yellow-800/50 rounded-xl p-4 flex flex-col items-center justify-center">
                     <span className="text-3xl mb-2">üìù</span>
                     <span className="font-bold">LOW</span>
                     <span className="text-xs opacity-75">Paper sketches</span>
                  </button>
                  <button onClick={() => handleAnswer('medium')} className="bg-blue-900/50 hover:bg-blue-800/50 rounded-xl p-4 flex flex-col items-center justify-center">
                     <span className="text-3xl mb-2">üñºÔ∏è</span>
                     <span className="font-bold">MEDIUM</span>
                     <span className="text-xs opacity-75">Wireframes</span>
                  </button>
                  <button onClick={() => handleAnswer('high')} className="bg-purple-900/50 hover:bg-purple-800/50 rounded-xl p-4 flex flex-col items-center justify-center">
                     <span className="text-3xl mb-2">‚ú®</span>
                     <span className="font-bold">HIGH</span>
                     <span className="text-xs opacity-75">Polished</span>
                  </button>
               </div>
            )}
         </div>
      );
   };

   const IterativeDesignRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [iteration, setIteration] = useState(1);
      const [productScore, setProductScore] = useState(30);
      const [actions, setActions] = useState<string[]>([]);

      const improvements = [
         { action: 'User Testing', boost: 15, description: 'Observe real users' },
         { action: 'A/B Test', boost: 10, description: 'Compare two versions' },
         { action: 'Feedback Survey', boost: 8, description: 'Collect opinions' },
         { action: 'Analytics Review', boost: 12, description: 'Study user data' },
      ];

      const handleImprovement = (improvement: typeof improvements[0]) => {
         setProductScore(s => Math.min(100, s + improvement.boost));
         setActions([...actions, improvement.action]);
         if (iteration >= 4) setPhase('result');
         else setIteration(i => i + 1);
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîÑ ITERATIVE DESIGN</h2>
                  <p className="text-lime-300 text-sm mt-1">Build ‚Üí Measure ‚Üí Learn</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Iterative Design:</strong> Continuously improving your product through cycles of building, testing, and learning.</p>
                  <p className="mt-2">Each iteration should make your product better based on real feedback.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üîÅ</div>
               <h3 className="text-2xl font-bold mb-4">Improve Your Product</h3>
               <p className="text-lg text-lime-200 max-w-md mb-8">Start with an MVP and iterate your way to product-market fit!</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-lime-500 hover:bg-lime-400 rounded-xl font-bold text-lg text-black">
                  START ITERATING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{productScore >= 80 ? 'üöÄ' : 'üìà'}</div>
            <h2 className="text-3xl font-black mb-2">Product Score: {productScore}%</h2>
            <p className="text-lime-300 mb-4">{productScore >= 80 ? 'Ready for launch!' : 'Keep iterating!'}</p>
            <div className="text-sm opacity-75 mb-6">Iterations: {actions.join(' ‚Üí ')}</div>
            <button onClick={() => { setPhase('intro'); setIteration(1); setProductScore(30); setActions([]); }} className="px-6 py-3 bg-lime-500 rounded-xl font-bold text-black">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-8">
            <div className="flex justify-between mb-4">
               <span className="text-sm">Iteration {iteration}/4</span>
               <span className="px-4 py-2 bg-lime-500/30 rounded-full font-bold">Score: {productScore}%</span>
            </div>
            <div className="w-full bg-black/30 rounded-full h-6 mb-6">
               <div className="bg-gradient-to-r from-lime-500 to-green-400 h-6 rounded-full transition-all flex items-center justify-end pr-2" style={{ width: `${productScore}%` }}>
                  <span className="text-xs font-bold text-black">{productScore}%</span>
               </div>
            </div>
            <p className="text-center mb-4 text-lime-200">Choose an improvement method:</p>
            <div className="grid grid-cols-2 gap-3 flex-1">
               {improvements.map((imp, i) => (
                  <button key={i} onClick={() => handleImprovement(imp)} className="bg-black/30 hover:bg-black/50 rounded-xl p-4 text-center transition-all">
                     <p className="font-bold text-lg">{imp.action}</p>
                     <p className="text-xs opacity-75">{imp.description}</p>
                     <p className="text-lime-400 mt-2">+{imp.boost}%</p>
                  </button>
               ))}
            </div>
         </div>
      );
   };

   const BlueOceanRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentQ, setCurrentQ] = useState(0);
      const [strategy, setStrategy] = useState<string[]>([]);

      const questions = [
         { q: "What can you ELIMINATE that the industry takes for granted?", example: "Cirque du Soleil eliminated animal acts" },
         { q: "What can you REDUCE below industry standards?", example: "Southwest reduced seat classes" },
         { q: "What can you RAISE above industry standards?", example: "Apple raised design quality" },
         { q: "What can you CREATE that the industry never offered?", example: "Netflix created binge-watching" },
      ];

      const [inputValue, setInputValue] = useState('');

      const submitAnswer = () => {
         if (inputValue.trim()) {
            setStrategy([...strategy, inputValue.trim()]);
            setInputValue('');
            if (currentQ < questions.length - 1) setCurrentQ(q => q + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üåä BLUE OCEAN STRATEGY</h2>
                  <p className="text-cyan-300 text-sm mt-1">Create Uncontested Markets</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Blue Ocean:</strong> Creating new market space instead of competing in existing ones.</p>
                  <p className="mt-2">Use the ERRC framework: Eliminate, Reduce, Raise, Create</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üåä</div>
               <h3 className="text-2xl font-bold mb-4">Find Your Blue Ocean</h3>
               <p className="text-lg text-cyan-200 max-w-md mb-8">Use the ERRC framework to differentiate from competitors.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 rounded-xl font-bold text-lg">
                  START STRATEGY ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your Blue Ocean Strategy</h2>
            <div className="flex-1 space-y-3 overflow-auto">
               {['ELIMINATE', 'REDUCE', 'RAISE', 'CREATE'].map((action, i) => (
                  <div key={i} className="bg-black/30 rounded-xl p-4">
                     <p className="font-bold text-cyan-400">{action}</p>
                     <p className="mt-1">{strategy[i]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setStrategy([]); setCurrentQ(0); }} className="px-6 py-3 bg-cyan-500 rounded-xl font-bold mt-4">CREATE NEW</button>
         </div>
      );

      const actions = ['ELIMINATE', 'REDUCE', 'RAISE', 'CREATE'];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {actions.map((a, i) => (
                  <div key={i} className={`flex-1 text-center py-2 rounded-full text-xs font-bold ${i === currentQ ? 'bg-cyan-500' : i < currentQ ? 'bg-green-500' : 'bg-black/30'}`}>
                     {a}
                  </div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4">
               <p className="text-xl font-bold mb-2">{questions[currentQ].q}</p>
               <p className="text-sm text-cyan-300/60">Example: {questions[currentQ].example}</p>
            </div>
            <input
               type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your answer..." onKeyDown={(e) => e.key === 'Enter' && submitAnswer()}
               className="w-full p-4 rounded-xl bg-black/30 border border-cyan-500/30 text-white mb-4"
            />
            <button onClick={submitAnswer} className="px-6 py-3 bg-cyan-500 rounded-xl font-bold">NEXT ‚Üí</button>
         </div>
      );
   };

   const TrendAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [currentQ, setCurrentQ] = useState(0);

      const trends = [
         { trend: "Remote work tools", direction: 'üìà', timing: 'NOW', correct: 'ride' },
         { trend: "DVD rentals", direction: 'üìâ', timing: 'PAST', correct: 'avoid' },
         { trend: "AI assistants", direction: 'üìà', timing: 'NOW', correct: 'ride' },
         { trend: "Print newspapers", direction: 'üìâ', timing: 'PAST', correct: 'avoid' },
         { trend: "Sustainable products", direction: 'üìà', timing: 'EARLY', correct: 'ride' },
      ];

      const handleAnswer = (answer: string) => {
         if (answer === trends[currentQ].correct) setScore(s => s + 20);
         if (currentQ < trends.length - 1) setCurrentQ(q => q + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üìä TREND ANALYSIS</h2>
                  <p className="text-amber-300 text-sm mt-1">Ride the Right Waves</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Trend Analysis:</strong> Identifying market trends to time your startup for success.</p>
                  <p className="mt-2">Key: Enter rising markets, avoid declining ones.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üìà</div>
               <h3 className="text-2xl font-bold mb-4">Spot Market Trends</h3>
               <p className="text-lg text-amber-200 max-w-md mb-8">Learn to identify which trends to ride and which to avoid.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-lg text-black">
                  START ANALYZING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 80 ? 'üèÜ' : 'üìä'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-amber-300 mb-6">{score >= 80 ? 'Trend master!' : 'Keep studying the markets!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-amber-500 rounded-xl font-bold text-black">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Trend {currentQ + 1}/{trends.length}</span>
               <span className="px-4 py-2 bg-amber-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6 text-center">
               <p className="text-4xl mb-2">{trends[currentQ].direction}</p>
               <p className="text-2xl font-bold">{trends[currentQ].trend}</p>
               <p className="text-amber-300 mt-2">Timing: {trends[currentQ].timing}</p>
            </div>
            <div className="grid grid-cols-2 gap-4">
               <button onClick={() => handleAnswer('ride')} className="p-6 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-center">
                  üèÑ RIDE IT<br/><span className="text-xs opacity-75">Build here</span>
               </button>
               <button onClick={() => handleAnswer('avoid')} className="p-6 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-center">
                  üö´ AVOID<br/><span className="text-xs opacity-75">Skip it</span>
               </button>
            </div>
         </div>
      );
   };

   const FirstPrinciplesRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [step, setStep] = useState(0);
      const [answers, setAnswers] = useState<string[]>([]);
      const [inputValue, setInputValue] = useState('');

      const steps = [
         { q: "Pick a common assumption (e.g., 'Batteries are expensive')", icon: 'ü§î' },
         { q: "Break it down: What are the raw components?", icon: 'üî¨' },
         { q: "What are the actual costs of each component?", icon: 'üí∞' },
         { q: "How could you rebuild it cheaper or better?", icon: 'üöÄ' },
      ];

      const submitAnswer = () => {
         if (inputValue.trim()) {
            setAnswers([...answers, inputValue.trim()]);
            setInputValue('');
            if (step < steps.length - 1) setStep(s => s + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-gray-800 to-zinc-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üî¨ FIRST PRINCIPLES</h2>
                  <p className="text-slate-300 text-sm mt-1">Think Like Elon Musk</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>First Principles:</strong> Breaking down problems to fundamental truths, then building up from there.</p>
                  <p className="mt-2">Example: SpaceX questioned why rockets cost so much by examining material costs.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üß™</div>
               <h3 className="text-2xl font-bold mb-4">Challenge Assumptions</h3>
               <p className="text-lg text-slate-200 max-w-md mb-8">Break down a problem to its fundamentals and rebuild innovative solutions.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-slate-500 hover:bg-slate-400 rounded-xl font-bold text-lg">
                  START THINKING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-gray-800 to-zinc-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üéâ Your First Principles Analysis</h2>
            <div className="flex-1 space-y-3 overflow-auto">
               {steps.map((s, i) => (
                  <div key={i} className="bg-black/30 rounded-xl p-4">
                     <p className="font-bold text-slate-400">{s.icon} Step {i + 1}</p>
                     <p className="mt-1">{answers[i]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setAnswers([]); setStep(0); }} className="px-6 py-3 bg-slate-500 rounded-xl font-bold mt-4">ANALYZE NEW</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-gray-800 to-zinc-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {steps.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-slate-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{steps[step].icon}</p>
               <p className="text-xl font-bold">{steps[step].q}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your analysis..."
               className="flex-1 p-4 rounded-xl bg-black/30 border border-slate-500/30 text-white mb-4 resize-none" />
            <button onClick={submitAnswer} className="px-6 py-3 bg-slate-500 rounded-xl font-bold">
               {step < steps.length - 1 ? 'NEXT STEP ‚Üí' : 'FINISH'}
            </button>
         </div>
      );
   };

   // --- ENTREPRENEURSHIP: BUSINESS MODELS & STRATEGY RENDERERS ---

   const LeanCanvasRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentBlock, setCurrentBlock] = useState(0);
      const [canvas, setCanvas] = useState<Record<string, string>>({});
      const [inputValue, setInputValue] = useState('');

      const blocks = [
         { key: 'problem', label: 'Problem', prompt: 'Top 3 problems you solve', icon: '‚ùó' },
         { key: 'solution', label: 'Solution', prompt: 'Top 3 features', icon: '‚úÖ' },
         { key: 'uvp', label: 'Unique Value Prop', prompt: 'Single clear message', icon: 'üíé' },
         { key: 'advantage', label: 'Unfair Advantage', prompt: "What can't be copied", icon: 'üõ°Ô∏è' },
         { key: 'customers', label: 'Customer Segments', prompt: 'Target customers', icon: 'üë•' },
         { key: 'channels', label: 'Channels', prompt: 'Path to customers', icon: 'üì¢' },
         { key: 'revenue', label: 'Revenue Streams', prompt: 'How you make money', icon: 'üí∞' },
         { key: 'costs', label: 'Cost Structure', prompt: 'Main costs', icon: 'üìä' },
         { key: 'metrics', label: 'Key Metrics', prompt: 'Numbers to track', icon: 'üìà' },
      ];

      const submitBlock = () => {
         if (inputValue.trim()) {
            setCanvas({ ...canvas, [blocks[currentBlock].key]: inputValue.trim() });
            setInputValue('');
            if (currentBlock < blocks.length - 1) setCurrentBlock(b => b + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üìã LEAN CANVAS</h2>
                  <p className="text-indigo-300 text-sm mt-1">One-Page Business Plan</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Lean Canvas:</strong> A 1-page business model template for startups.</p>
                  <p className="mt-2">Created by Ash Maurya, adapted from Business Model Canvas.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üìù</div>
               <h3 className="text-2xl font-bold mb-4">Build Your Lean Canvas</h3>
               <p className="text-lg text-indigo-200 max-w-md mb-8">Fill in all 9 blocks to create a complete business model.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-bold text-lg">
                  START BUILDING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white p-6 overflow-auto">
            <h2 className="text-xl font-black mb-4 text-center">üéâ Your Lean Canvas</h2>
            <div className="grid grid-cols-3 gap-2 flex-1">
               {blocks.map((b) => (
                  <div key={b.key} className="bg-black/30 rounded-lg p-2 text-xs">
                     <p className="font-bold text-indigo-300">{b.icon} {b.label}</p>
                     <p className="mt-1 opacity-90">{canvas[b.key]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setCanvas({}); setCurrentBlock(0); }} className="px-6 py-3 bg-indigo-500 rounded-xl font-bold mt-4">CREATE NEW</button>
         </div>
      );

      const current = blocks[currentBlock];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {blocks.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= currentBlock ? 'bg-indigo-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-xl font-bold">{current.label}</p>
               <p className="text-sm opacity-75 mt-1">{current.prompt}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Enter your answer..." className="flex-1 p-4 rounded-xl bg-black/30 border border-indigo-500/30 text-white mb-4 resize-none" />
            <button onClick={submitBlock} className="px-6 py-3 bg-indigo-500 rounded-xl font-bold">
               {currentBlock < blocks.length - 1 ? 'NEXT BLOCK ‚Üí' : 'FINISH'}
            </button>
         </div>
      );
   };

   const BusinessModelCanvasRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentBlock, setCurrentBlock] = useState(0);
      const [canvas, setCanvas] = useState<Record<string, string>>({});
      const [inputValue, setInputValue] = useState('');

      const blocks = [
         { key: 'partners', label: 'Key Partners', prompt: 'Who are your key partners?', icon: 'ü§ù' },
         { key: 'activities', label: 'Key Activities', prompt: 'What do you do?', icon: '‚öôÔ∏è' },
         { key: 'resources', label: 'Key Resources', prompt: 'What do you need?', icon: 'üß∞' },
         { key: 'value', label: 'Value Propositions', prompt: 'What value do you deliver?', icon: 'üíé' },
         { key: 'relations', label: 'Customer Relations', prompt: 'How do you interact?', icon: 'üí¨' },
         { key: 'channels', label: 'Channels', prompt: 'How do you reach them?', icon: 'üì¢' },
         { key: 'segments', label: 'Customer Segments', prompt: 'Who do you serve?', icon: 'üë•' },
         { key: 'costs', label: 'Cost Structure', prompt: 'What are your costs?', icon: 'üí∏' },
         { key: 'revenue', label: 'Revenue Streams', prompt: 'How do you earn?', icon: 'üí∞' },
      ];

      const submitBlock = () => {
         if (inputValue.trim()) {
            setCanvas({ ...canvas, [blocks[currentBlock].key]: inputValue.trim() });
            setInputValue('');
            if (currentBlock < blocks.length - 1) setCurrentBlock(b => b + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üè¢ BUSINESS MODEL CANVAS</h2>
                  <p className="text-blue-300 text-sm mt-1">Strategic Planning Tool</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Business Model Canvas:</strong> A strategic template for developing new or documenting existing business models.</p>
                  <p className="mt-2">Created by Alexander Osterwalder.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üóÇÔ∏è</div>
               <h3 className="text-2xl font-bold mb-4">Design Your Business Model</h3>
               <p className="text-lg text-blue-200 max-w-md mb-8">Complete all 9 building blocks of your business.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-blue-500 hover:bg-blue-400 rounded-xl font-bold text-lg">
                  START DESIGNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-6 overflow-auto">
            <h2 className="text-xl font-black mb-4 text-center">üéâ Your Business Model Canvas</h2>
            <div className="grid grid-cols-3 gap-2 flex-1">
               {blocks.map((b) => (
                  <div key={b.key} className="bg-black/30 rounded-lg p-2 text-xs">
                     <p className="font-bold text-blue-300">{b.icon} {b.label}</p>
                     <p className="mt-1 opacity-90">{canvas[b.key]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setCanvas({}); setCurrentBlock(0); }} className="px-6 py-3 bg-blue-500 rounded-xl font-bold mt-4">CREATE NEW</button>
         </div>
      );

      const current = blocks[currentBlock];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8">
            <p className="text-center text-sm mb-4">Block {currentBlock + 1}/{blocks.length}</p>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-xl font-bold">{current.label}</p>
               <p className="text-sm opacity-75 mt-1">{current.prompt}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Enter your answer..." className="flex-1 p-4 rounded-xl bg-black/30 border border-blue-500/30 text-white mb-4 resize-none" />
            <button onClick={submitBlock} className="px-6 py-3 bg-blue-500 rounded-xl font-bold">NEXT ‚Üí</button>
         </div>
      );
   };

   const B2bVsB2cRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [currentQ, setCurrentQ] = useState(0);

      const scenarios = [
         { scenario: "Selling accounting software to small businesses", answer: 'B2B', reason: 'Business customers' },
         { scenario: "E-commerce store selling shoes to individuals", answer: 'B2C', reason: 'Consumer customers' },
         { scenario: "Cloud hosting services for startups", answer: 'B2B', reason: 'Business customers' },
         { scenario: "Food delivery app for hungry consumers", answer: 'B2C', reason: 'Individual consumers' },
         { scenario: "Wholesale supplier to retail stores", answer: 'B2B', reason: 'Business-to-business' },
      ];

      const handleAnswer = (answer: string) => {
         if (answer === scenarios[currentQ].answer) setScore(s => s + 20);
         if (currentQ < scenarios.length - 1) setCurrentQ(q => q + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üîÑ B2B vs B2C</h2>
                  <p className="text-orange-300 text-sm mt-1">Know Your Market</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>B2B:</strong> Business-to-Business - selling to other companies.</p>
                  <p className="mt-2"><strong>B2C:</strong> Business-to-Consumer - selling to individual customers.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="flex gap-4 text-5xl mb-6"><span>üè¢</span><span>‚ÜîÔ∏è</span><span>üè†</span></div>
               <h3 className="text-2xl font-bold mb-4">Classify Business Models</h3>
               <p className="text-lg text-orange-200 max-w-md mb-8">Learn to identify B2B vs B2C businesses.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-orange-500 hover:bg-orange-400 rounded-xl font-bold text-lg">
                  START LEARNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 80 ? 'üèÜ' : 'üìö'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-orange-300 mb-6">{score >= 80 ? 'Business model expert!' : 'Keep practicing!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-orange-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Question {currentQ + 1}/{scenarios.length}</span>
               <span className="px-4 py-2 bg-orange-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6 text-center">
               <p className="text-xl font-bold">{scenarios[currentQ].scenario}</p>
            </div>
            <div className="grid grid-cols-2 gap-4">
               <button onClick={() => handleAnswer('B2B')} className="p-6 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold">
                  üè¢ B2B<br/><span className="text-xs opacity-75">Business customers</span>
               </button>
               <button onClick={() => handleAnswer('B2C')} className="p-6 bg-green-600 hover:bg-green-500 rounded-xl font-bold">
                  üè† B2C<br/><span className="text-xs opacity-75">Consumer customers</span>
               </button>
            </div>
         </div>
      );
   };

   const RevenueModelsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [currentModel, setCurrentModel] = useState(0);
      const [selectedModels, setSelectedModels] = useState<string[]>([]);

      const models = [
         { name: 'Subscription', icon: 'üîÑ', example: 'Netflix, Spotify', desc: 'Recurring payments' },
         { name: 'Freemium', icon: 'üÜì', example: 'Dropbox, Slack', desc: 'Free + paid tiers' },
         { name: 'Marketplace', icon: 'üõí', example: 'Airbnb, Uber', desc: 'Take a cut' },
         { name: 'Advertising', icon: 'üì∫', example: 'Google, Facebook', desc: 'Sell attention' },
         { name: 'Licensing', icon: 'üìú', example: 'Microsoft, Adobe', desc: 'Sell usage rights' },
         { name: 'Transaction Fee', icon: 'üí≥', example: 'Stripe, PayPal', desc: 'Fee per transaction' },
      ];

      const toggleModel = (name: string) => {
         if (selectedModels.includes(name)) {
            setSelectedModels(selectedModels.filter(m => m !== name));
         } else {
            setSelectedModels([...selectedModels, name]);
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üí∞ REVENUE MODELS</h2>
                  <p className="text-green-300 text-sm mt-1">How Businesses Make Money</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Revenue Model:</strong> The strategy for generating income from your product or service.</p>
                  <p className="mt-2">Different models suit different businesses.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üíµ</div>
               <h3 className="text-2xl font-bold mb-4">Explore Revenue Models</h3>
               <p className="text-lg text-green-200 max-w-md mb-8">Learn about different ways businesses generate revenue.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-green-500 hover:bg-green-400 rounded-xl font-bold text-lg">
                  START EXPLORING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">Your Selected Models</h2>
            <div className="flex-1 space-y-3 overflow-auto">
               {selectedModels.map((name) => {
                  const model = models.find(m => m.name === name)!;
                  return (
                     <div key={name} className="bg-black/30 rounded-xl p-4 flex items-center gap-4">
                        <span className="text-3xl">{model.icon}</span>
                        <div>
                           <p className="font-bold">{model.name}</p>
                           <p className="text-sm opacity-75">{model.example}</p>
                        </div>
                     </div>
                  );
               })}
            </div>
            <button onClick={() => { setPhase('intro'); setSelectedModels([]); }} className="px-6 py-3 bg-green-500 rounded-xl font-bold mt-4">EXPLORE AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8">
            <p className="text-center mb-4">Select models that fit your business:</p>
            <div className="grid grid-cols-2 gap-3 flex-1">
               {models.map((model) => (
                  <button key={model.name} onClick={() => toggleModel(model.name)}
                     className={`p-4 rounded-xl text-center transition-all ${selectedModels.includes(model.name) ? 'bg-green-500 ring-2 ring-white' : 'bg-black/30 hover:bg-black/50'}`}>
                     <span className="text-3xl">{model.icon}</span>
                     <p className="font-bold mt-2">{model.name}</p>
                     <p className="text-xs opacity-75">{model.desc}</p>
                  </button>
               ))}
            </div>
            <button onClick={() => selectedModels.length > 0 && setPhase('result')} disabled={selectedModels.length === 0}
               className="px-6 py-3 bg-green-500 rounded-xl font-bold mt-4 disabled:opacity-50">
               VIEW SELECTION ({selectedModels.length})
            </button>
         </div>
      );
   };

   const UnitEconomicsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [price, setPrice] = useState(50);
      const [cogs, setCogs] = useState(20);
      const [cac, setCac] = useState(30);
      const [ltv, setLtv] = useState(150);

      const margin = ((price - cogs) / price * 100).toFixed(1);
      const ltvCacRatio = (ltv / cac).toFixed(2);
      const paybackMonths = (cac / (price - cogs)).toFixed(1);
      const isHealthy = parseFloat(ltvCacRatio) >= 3;

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üìä UNIT ECONOMICS</h2>
                  <p className="text-cyan-300 text-sm mt-1">Per-Customer Profitability</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Unit Economics:</strong> Revenue and costs on a per-unit (customer) basis.</p>
                  <p className="mt-2">Key metrics: LTV (Lifetime Value), CAC (Customer Acquisition Cost), LTV:CAC ratio</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üßÆ</div>
               <h3 className="text-2xl font-bold mb-4">Calculate Your Unit Economics</h3>
               <p className="text-lg text-cyan-200 max-w-md mb-8">Adjust your business metrics and see if you're profitable per customer.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 rounded-xl font-bold text-lg">
                  START CALCULATING ‚Üí
               </button>
            </div>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-blue-900 to-indigo-900 text-white p-6">
            <div className="flex justify-between items-start mb-4">
               <h2 className="text-xl font-black">üìä UNIT ECONOMICS</h2>
               <button onClick={() => setShowInfo(!showInfo)} className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">‚ÑπÔ∏è</button>
            </div>
            {showInfo && <div className="bg-black/30 rounded-xl p-3 mb-4 text-xs"><p>Adjust sliders to see how metrics affect profitability.</p></div>}
            <div className="space-y-4 mb-4">
               <div><label className="text-xs text-cyan-300">Price per Unit: ${price}</label><input type="range" min="10" max="200" value={price} onChange={(e) => setPrice(Number(e.target.value))} className="w-full accent-cyan-500" /></div>
               <div><label className="text-xs text-cyan-300">Cost of Goods Sold: ${cogs}</label><input type="range" min="5" max="100" value={cogs} onChange={(e) => setCogs(Number(e.target.value))} className="w-full accent-cyan-500" /></div>
               <div><label className="text-xs text-cyan-300">CAC (Acquisition Cost): ${cac}</label><input type="range" min="10" max="200" value={cac} onChange={(e) => setCac(Number(e.target.value))} className="w-full accent-cyan-500" /></div>
               <div><label className="text-xs text-cyan-300">LTV (Lifetime Value): ${ltv}</label><input type="range" min="50" max="500" value={ltv} onChange={(e) => setLtv(Number(e.target.value))} className="w-full accent-cyan-500" /></div>
            </div>
            <div className={`p-4 rounded-xl ${isHealthy ? 'bg-green-900/50' : 'bg-red-900/50'}`}>
               <div className="grid grid-cols-3 gap-4 text-center">
                  <div><p className="text-xs opacity-75">Margin</p><p className="text-xl font-bold">{margin}%</p></div>
                  <div><p className="text-xs opacity-75">LTV:CAC</p><p className="text-xl font-bold">{ltvCacRatio}x</p></div>
                  <div><p className="text-xs opacity-75">Payback</p><p className="text-xl font-bold">{paybackMonths}mo</p></div>
               </div>
               <p className="text-center mt-3 font-bold">{isHealthy ? '‚úÖ Healthy Unit Economics!' : '‚ö†Ô∏è Improve your metrics'}</p>
            </div>
         </div>
      );
   };

   const CacCalculatorRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [marketing, setMarketing] = useState(10000);
      const [sales, setSales] = useState(5000);
      const [customers, setCustomers] = useState(50);

      const cac = customers > 0 ? ((marketing + sales) / customers).toFixed(2) : '0';
      const isGood = parseFloat(cac) < 100;

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-red-900 via-orange-900 to-yellow-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üí≥ CAC CALCULATOR</h2>
                  <p className="text-red-300 text-sm mt-1">Customer Acquisition Cost</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>CAC:</strong> Total cost to acquire one new customer.</p>
                  <p className="mt-2">Formula: (Marketing + Sales Costs) √∑ New Customers</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üéØ</div>
               <h3 className="text-2xl font-bold mb-4">Calculate Your CAC</h3>
               <p className="text-lg text-red-200 max-w-md mb-8">Find out how much you spend to acquire each customer.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-red-500 hover:bg-red-400 rounded-xl font-bold text-lg">
                  START CALCULATING ‚Üí
               </button>
            </div>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-red-900 via-orange-900 to-yellow-900 text-white p-6">
            <h2 className="text-xl font-black mb-4">üí≥ CAC CALCULATOR</h2>
            <div className="space-y-4 flex-1">
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">Marketing Spend: ${marketing.toLocaleString()}</label>
                  <input type="range" min="0" max="50000" step="1000" value={marketing} onChange={(e) => setMarketing(Number(e.target.value))} className="w-full accent-red-500" />
               </div>
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">Sales Costs: ${sales.toLocaleString()}</label>
                  <input type="range" min="0" max="30000" step="500" value={sales} onChange={(e) => setSales(Number(e.target.value))} className="w-full accent-red-500" />
               </div>
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">New Customers Acquired: {customers}</label>
                  <input type="range" min="1" max="200" value={customers} onChange={(e) => setCustomers(Number(e.target.value))} className="w-full accent-red-500" />
               </div>
            </div>
            <div className={`p-6 rounded-xl mt-4 text-center ${isGood ? 'bg-green-900/50' : 'bg-red-900/50'}`}>
               <p className="text-sm opacity-75">Your CAC</p>
               <p className="text-4xl font-black">${cac}</p>
               <p className="text-sm mt-2">{isGood ? '‚úÖ Great CAC!' : '‚ö†Ô∏è Consider reducing costs or improving conversion'}</p>
            </div>
         </div>
      );
   };

   const LtvCalculatorRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [arpu, setArpu] = useState(50);
      const [margin, setMargin] = useState(70);
      const [churnRate, setChurnRate] = useState(5);

      const ltv = churnRate > 0 ? ((arpu * (margin / 100)) / (churnRate / 100)).toFixed(0) : '‚àû';
      const lifespan = churnRate > 0 ? (100 / churnRate).toFixed(1) : '‚àû';

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üíé LTV CALCULATOR</h2>
                  <p className="text-purple-300 text-sm mt-1">Customer Lifetime Value</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>LTV:</strong> Total revenue expected from a customer over their lifetime.</p>
                  <p className="mt-2">Formula: (ARPU √ó Margin) √∑ Churn Rate</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üëë</div>
               <h3 className="text-2xl font-bold mb-4">Calculate Customer LTV</h3>
               <p className="text-lg text-purple-200 max-w-md mb-8">Understand how much each customer is worth over time.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-purple-500 hover:bg-purple-400 rounded-xl font-bold text-lg">
                  START CALCULATING ‚Üí
               </button>
            </div>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-6">
            <h2 className="text-xl font-black mb-4">üíé LTV CALCULATOR</h2>
            <div className="space-y-4 flex-1">
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">Monthly ARPU: ${arpu}</label>
                  <input type="range" min="10" max="200" value={arpu} onChange={(e) => setArpu(Number(e.target.value))} className="w-full accent-purple-500" />
               </div>
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">Gross Margin: {margin}%</label>
                  <input type="range" min="10" max="95" value={margin} onChange={(e) => setMargin(Number(e.target.value))} className="w-full accent-purple-500" />
               </div>
               <div className="bg-black/30 p-4 rounded-xl">
                  <label className="text-sm">Monthly Churn Rate: {churnRate}%</label>
                  <input type="range" min="1" max="20" value={churnRate} onChange={(e) => setChurnRate(Number(e.target.value))} className="w-full accent-purple-500" />
               </div>
            </div>
            <div className="grid grid-cols-2 gap-4 mt-4">
               <div className="bg-purple-800/50 p-4 rounded-xl text-center">
                  <p className="text-sm opacity-75">Customer LTV</p>
                  <p className="text-3xl font-black">${ltv}</p>
               </div>
               <div className="bg-purple-800/50 p-4 rounded-xl text-center">
                  <p className="text-sm opacity-75">Avg Lifespan</p>
                  <p className="text-3xl font-black">{lifespan} mo</p>
               </div>
            </div>
         </div>
      );
   };

   const ScalabilityRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [currentQ, setCurrentQ] = useState(0);

      const questions = [
         { q: "Your costs increase linearly with each new customer.", scalable: false, reason: "True scalability means costs grow slower than revenue" },
         { q: "You use cloud infrastructure that auto-scales.", scalable: true, reason: "Cloud allows handling more load without proportional cost" },
         { q: "Each sale requires a 1-hour personalized demo.", scalable: false, reason: "High-touch sales limit growth rate" },
         { q: "Your product is digital with near-zero marginal cost.", scalable: true, reason: "Digital products scale infinitely" },
      ];

      const handleAnswer = (isScalable: boolean) => {
         if (isScalable === questions[currentQ].scalable) setScore(s => s + 25);
         if (currentQ < questions.length - 1) setCurrentQ(q => q + 1);
         else setPhase('result');
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üìà SCALABILITY</h2>
                  <p className="text-sky-300 text-sm mt-1">Can Your Business Grow?</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Scalability:</strong> The ability to grow revenue faster than costs.</p>
                  <p className="mt-2">Key: Can you 10x customers without 10x costs?</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üöÄ</div>
               <h3 className="text-2xl font-bold mb-4">Test Scalability</h3>
               <p className="text-lg text-sky-200 max-w-md mb-8">Learn to identify scalable vs non-scalable business characteristics.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-sky-500 hover:bg-sky-400 rounded-xl font-bold text-lg">
                  START TESTING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8 items-center justify-center">
            <div className="text-6xl mb-4">{score >= 75 ? 'üöÄ' : 'üìö'}</div>
            <h2 className="text-3xl font-black mb-2">Score: {score}%</h2>
            <p className="text-sky-300 mb-6">{score >= 75 ? 'Scalability expert!' : 'Keep learning!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrentQ(0); }} className="px-6 py-3 bg-sky-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white p-8">
            <div className="flex justify-between mb-6">
               <span className="text-sm">Question {currentQ + 1}/{questions.length}</span>
               <span className="px-4 py-2 bg-sky-500/30 rounded-full font-bold">Score: {score}%</span>
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6 text-center">
               <p className="text-xl font-bold">{questions[currentQ].q}</p>
            </div>
            <div className="grid grid-cols-2 gap-4">
               <button onClick={() => handleAnswer(true)} className="p-6 bg-green-600 hover:bg-green-500 rounded-xl font-bold">
                  ‚úÖ SCALABLE
               </button>
               <button onClick={() => handleAnswer(false)} className="p-6 bg-red-600 hover:bg-red-500 rounded-xl font-bold">
                  ‚ùå NOT SCALABLE
               </button>
            </div>
         </div>
      );
   };

   const FranchisingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [franchiseFee, setFranchiseFee] = useState(25000);
      const [royaltyRate, setRoyaltyRate] = useState(5);
      const [franchisees, setFranchisees] = useState(10);
      const [avgRevenue, setAvgRevenue] = useState(500000);

      const initialFees = franchiseFee * franchisees;
      const annualRoyalties = (royaltyRate / 100) * avgRevenue * franchisees;
      const totalAnnual = initialFees + annualRoyalties;

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üè™ FRANCHISING</h2>
                  <p className="text-amber-300 text-sm mt-1">Scale Through Partners</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Franchising:</strong> Licensing your business model to independent operators.</p>
                  <p className="mt-2">Revenue: Initial franchise fees + ongoing royalties.</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üçî</div>
               <h3 className="text-2xl font-bold mb-4">Franchise Revenue Calculator</h3>
               <p className="text-lg text-amber-200 max-w-md mb-8">Model potential revenue from franchising your business.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-amber-500 hover:bg-amber-400 rounded-xl font-bold text-lg text-black">
                  START MODELING ‚Üí
               </button>
            </div>
         </div>
      );

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-6">
            <h2 className="text-xl font-black mb-4">üè™ FRANCHISE MODEL</h2>
            <div className="space-y-3 flex-1">
               <div className="bg-black/30 p-3 rounded-xl">
                  <label className="text-xs">Franchise Fee: ${franchiseFee.toLocaleString()}</label>
                  <input type="range" min="5000" max="100000" step="5000" value={franchiseFee} onChange={(e) => setFranchiseFee(Number(e.target.value))} className="w-full accent-amber-500" />
               </div>
               <div className="bg-black/30 p-3 rounded-xl">
                  <label className="text-xs">Royalty Rate: {royaltyRate}%</label>
                  <input type="range" min="1" max="12" value={royaltyRate} onChange={(e) => setRoyaltyRate(Number(e.target.value))} className="w-full accent-amber-500" />
               </div>
               <div className="bg-black/30 p-3 rounded-xl">
                  <label className="text-xs">Number of Franchisees: {franchisees}</label>
                  <input type="range" min="1" max="100" value={franchisees} onChange={(e) => setFranchisees(Number(e.target.value))} className="w-full accent-amber-500" />
               </div>
               <div className="bg-black/30 p-3 rounded-xl">
                  <label className="text-xs">Avg Franchisee Revenue: ${avgRevenue.toLocaleString()}</label>
                  <input type="range" min="100000" max="2000000" step="50000" value={avgRevenue} onChange={(e) => setAvgRevenue(Number(e.target.value))} className="w-full accent-amber-500" />
               </div>
            </div>
            <div className="grid grid-cols-3 gap-2 mt-4">
               <div className="bg-amber-800/50 p-3 rounded-xl text-center">
                  <p className="text-xs opacity-75">Initial Fees</p>
                  <p className="text-lg font-bold">${(initialFees / 1000).toFixed(0)}K</p>
               </div>
               <div className="bg-amber-800/50 p-3 rounded-xl text-center">
                  <p className="text-xs opacity-75">Annual Royalties</p>
                  <p className="text-lg font-bold">${(annualRoyalties / 1000).toFixed(0)}K</p>
               </div>
               <div className="bg-green-800/50 p-3 rounded-xl text-center">
                  <p className="text-xs opacity-75">Year 1 Total</p>
                  <p className="text-lg font-bold">${(totalAnnual / 1000).toFixed(0)}K</p>
               </div>
            </div>
         </div>
      );
   };

   const SocialEnterpriseRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [step, setStep] = useState(0);
      const [enterprise, setEnterprise] = useState({ mission: '', impact: '', revenue: '', sustainability: '' });
      const [inputValue, setInputValue] = useState('');

      const steps = [
         { key: 'mission', label: 'Social Mission', prompt: 'What social problem do you solve?', icon: '‚ù§Ô∏è' },
         { key: 'impact', label: 'Impact Metrics', prompt: 'How do you measure impact?', icon: 'üìä' },
         { key: 'revenue', label: 'Revenue Model', prompt: 'How do you make money?', icon: 'üí∞' },
         { key: 'sustainability', label: 'Sustainability', prompt: 'How do you ensure long-term impact?', icon: '‚ôªÔ∏è' },
      ];

      const submitStep = () => {
         if (inputValue.trim()) {
            setEnterprise({ ...enterprise, [steps[step].key]: inputValue.trim() });
            setInputValue('');
            if (step < steps.length - 1) setStep(s => s + 1);
            else setPhase('result');
         }
      };

      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-3xl font-black">üåç SOCIAL ENTERPRISE</h2>
                  <p className="text-emerald-300 text-sm mt-1">Profit With Purpose</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            </div>
            {showInfo && (
               <div className="bg-black/30 rounded-xl p-4 mb-4 text-sm">
                  <p><strong>Social Enterprise:</strong> A business that prioritizes social/environmental impact alongside profit.</p>
                  <p className="mt-2">Examples: TOMS, Patagonia, Warby Parker</p>
               </div>
            )}
            <div className="flex-1 flex flex-col justify-center items-center text-center">
               <div className="text-6xl mb-6">üå±</div>
               <h3 className="text-2xl font-bold mb-4">Design Your Social Enterprise</h3>
               <p className="text-lg text-emerald-200 max-w-md mb-8">Create a business model that combines profit with positive impact.</p>
               <button onClick={() => setPhase('play')} className="px-8 py-4 bg-emerald-500 hover:bg-emerald-400 rounded-xl font-bold text-lg">
                  START DESIGNING ‚Üí
               </button>
            </div>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8">
            <h2 className="text-2xl font-black mb-4 text-center">üåç Your Social Enterprise</h2>
            <div className="flex-1 space-y-3 overflow-auto">
               {steps.map((s) => (
                  <div key={s.key} className="bg-black/30 rounded-xl p-4">
                     <p className="font-bold text-emerald-300">{s.icon} {s.label}</p>
                     <p className="mt-1">{enterprise[s.key as keyof typeof enterprise]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setStep(0); setEnterprise({ mission: '', impact: '', revenue: '', sustainability: '' }); }} className="px-6 py-3 bg-emerald-500 rounded-xl font-bold mt-4">CREATE NEW</button>
         </div>
      );

      const current = steps[step];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-8">
            <div className="flex gap-1 mb-6">
               {steps.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-emerald-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{current.icon}</p>
               <p className="text-xl font-bold">{current.label}</p>
               <p className="text-sm opacity-75 mt-1">{current.prompt}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your answer..." className="flex-1 p-4 rounded-xl bg-black/30 border border-emerald-500/30 text-white mb-4 resize-none" />
            <button onClick={submitStep} className="px-6 py-3 bg-emerald-500 rounded-xl font-bold">
               {step < steps.length - 1 ? 'NEXT ‚Üí' : 'FINISH'}
            </button>
         </div>
      );
   };

   // ============================================
   // ENTREPRENEURSHIP: MARKETING & SALES (10)
   // ============================================

   // 31. FOUR PS MARKETING - Interactive Marketing Mix Builder
   const FourPsMarketingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [ps, setPs] = useState({ product: '', price: '', place: '', promotion: '' });
      const [currentP, setCurrentP] = useState(0);
      const [inputValue, setInputValue] = useState('');

      const pItems = [
         { key: 'product', icon: 'üì¶', label: 'Product', desc: 'What are you selling? Define features, benefits, and USP.' },
         { key: 'price', icon: 'üí∞', label: 'Price', desc: 'How much will it cost? Consider value, competition, and margins.' },
         { key: 'place', icon: 'üìç', label: 'Place', desc: 'Where will you sell? Define distribution channels.' },
         { key: 'promotion', icon: 'üì¢', label: 'Promotion', desc: 'How will people know? Plan your marketing communications.' }
      ];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">The Marketing Mix (4Ps)</p>
                  <p>Framework for creating a comprehensive marketing strategy by addressing Product, Price, Place, and Promotion.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üéØ</p>
            <h2 className="text-3xl font-bold mb-4">The 4Ps of Marketing</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Build a complete marketing mix strategy by defining all four Ps for your product or service.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-pink-500 rounded-2xl font-bold text-xl hover:bg-pink-400 transition-all">START BUILDING ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
            <h2 className="text-2xl font-bold text-center mb-6">üéØ Your Marketing Mix</h2>
            <div className="grid grid-cols-2 gap-4 flex-1">
               {pItems.map((p) => (
                  <div key={p.key} className="bg-black/30 rounded-xl p-4">
                     <div className="flex items-center gap-2 mb-2">
                        <span className="text-2xl">{p.icon}</span>
                        <span className="font-bold text-lg">{p.label}</span>
                     </div>
                     <p className="text-sm opacity-90">{ps[p.key as keyof typeof ps] || 'Not defined'}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setPs({ product: '', price: '', place: '', promotion: '' }); setCurrentP(0); }} className="px-6 py-3 bg-pink-500 rounded-xl font-bold mt-4">CREATE NEW MIX</button>
         </div>
      );

      const submitP = () => {
         const key = pItems[currentP].key as keyof typeof ps;
         setPs({ ...ps, [key]: inputValue });
         setInputValue('');
         if (currentP < 3) setCurrentP(currentP + 1);
         else setPhase('result');
      };

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {pItems.map((p, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= currentP ? 'bg-pink-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-5xl mb-2">{pItems[currentP].icon}</p>
               <p className="text-2xl font-bold">{pItems[currentP].label}</p>
               <p className="text-sm opacity-75 mt-2">{pItems[currentP].desc}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder={`Define your ${pItems[currentP].label.toLowerCase()}...`}
               className="flex-1 p-4 rounded-xl bg-black/30 border border-pink-500/30 text-white mb-4 resize-none" />
            <button onClick={submitP} className="px-6 py-3 bg-pink-500 rounded-xl font-bold">
               {currentP < 3 ? 'NEXT P ‚Üí' : 'COMPLETE MIX'}
            </button>
         </div>
      );
   };

   // 32. BRANDING IDENTITY - Brand Building Exercise
   const BrandingIdentityRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [brand, setBrand] = useState({ name: '', personality: '', values: '', voice: '' });
      const [step, setStep] = useState(0);
      const [inputValue, setInputValue] = useState('');

      const steps = [
         { key: 'name', icon: '‚ú®', label: 'Brand Name', prompt: 'What is your brand name and tagline?' },
         { key: 'personality', icon: 'üé≠', label: 'Personality', prompt: 'Describe your brand as if it were a person' },
         { key: 'values', icon: 'üíé', label: 'Core Values', prompt: 'What principles guide your brand?' },
         { key: 'voice', icon: 'üó£Ô∏è', label: 'Brand Voice', prompt: 'How does your brand communicate?' }
      ];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">Brand Identity</p>
                  <p>The visual and emotional elements that define how your brand is perceived. Strong brands create emotional connections.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üé®</p>
            <h2 className="text-3xl font-bold mb-4">Build Your Brand Identity</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Create a consistent brand persona that resonates with your target audience.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-purple-500 rounded-2xl font-bold text-xl hover:bg-purple-400 transition-all">START BRANDING ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-8">
            <h2 className="text-2xl font-bold text-center mb-6">üé® Brand Identity Card</h2>
            <div className="bg-black/30 rounded-2xl p-6 flex-1">
               {steps.map((s) => (
                  <div key={s.key} className="mb-4 border-b border-white/10 pb-4 last:border-0">
                     <div className="flex items-center gap-2 mb-1">
                        <span className="text-xl">{s.icon}</span>
                        <span className="font-bold">{s.label}</span>
                     </div>
                     <p className="text-sm opacity-80 ml-8">{brand[s.key as keyof typeof brand]}</p>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setBrand({ name: '', personality: '', values: '', voice: '' }); setStep(0); }} className="px-6 py-3 bg-purple-500 rounded-xl font-bold mt-4">CREATE NEW BRAND</button>
         </div>
      );

      const submitStep = () => {
         setBrand({ ...brand, [steps[step].key]: inputValue });
         setInputValue('');
         if (step < 3) setStep(step + 1);
         else setPhase('result');
      };

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {steps.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-purple-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{steps[step].icon}</p>
               <p className="text-xl font-bold">{steps[step].label}</p>
               <p className="text-sm opacity-75 mt-2">{steps[step].prompt}</p>
            </div>
            <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your answer..." className="flex-1 p-4 rounded-xl bg-black/30 border border-purple-500/30 text-white mb-4 resize-none" />
            <button onClick={submitStep} className="px-6 py-3 bg-purple-500 rounded-xl font-bold">
               {step < 3 ? 'NEXT ‚Üí' : 'COMPLETE BRAND'}
            </button>
         </div>
      );
   };

   // 33. DIGITAL MARKETING - Channel Selection Game
   const DigitalMarketingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [current, setCurrent] = useState(0);
      const [selections, setSelections] = useState<string[]>([]);

      const scenarios = [
         { goal: 'Build brand awareness for a new product', best: 'social_media', options: [
            { id: 'email', label: 'üìß Email Marketing', score: 5 },
            { id: 'social_media', label: 'üì± Social Media Ads', score: 10 },
            { id: 'seo', label: 'üîç SEO', score: 6 }
         ]},
         { goal: 'Drive immediate sales during a holiday', best: 'ppc', options: [
            { id: 'ppc', label: 'üí∞ PPC Advertising', score: 10 },
            { id: 'content', label: 'üìù Content Marketing', score: 4 },
            { id: 'influencer', label: 'üåü Influencer Marketing', score: 7 }
         ]},
         { goal: 'Nurture leads who downloaded your ebook', best: 'email_automation', options: [
            { id: 'email_automation', label: 'ü§ñ Email Automation', score: 10 },
            { id: 'retargeting', label: 'üéØ Retargeting Ads', score: 6 },
            { id: 'webinar', label: 'üé• Webinars', score: 7 }
         ]},
         { goal: 'Establish thought leadership in B2B', best: 'linkedin', options: [
            { id: 'linkedin', label: 'üíº LinkedIn Content', score: 10 },
            { id: 'tiktok', label: 'üìπ TikTok', score: 2 },
            { id: 'podcast', label: 'üéôÔ∏è Podcast', score: 8 }
         ]}
      ];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">Digital Marketing Channels</p>
                  <p>Different channels serve different goals. Matching the right channel to your objective maximizes ROI.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üì±</p>
            <h2 className="text-3xl font-bold mb-4">Digital Marketing Channels</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Match the best digital marketing channel to each business goal.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-blue-500 rounded-2xl font-bold text-xl hover:bg-blue-400 transition-all">START MATCHING ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8 text-center">
            <p className="text-6xl mb-4">{score >= 30 ? 'üèÜ' : score >= 20 ? '‚≠ê' : 'üìö'}</p>
            <h2 className="text-3xl font-bold mb-4">Channel Mastery Score</h2>
            <p className="text-5xl font-bold text-blue-400 mb-4">{score}/{scenarios.length * 10}</p>
            <p className="text-lg opacity-80 mb-8">{score >= 30 ? 'Digital marketing expert!' : score >= 20 ? 'Good understanding!' : 'Keep learning channels!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrent(0); setSelections([]); }} className="px-6 py-3 bg-blue-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      const handleSelect = (optScore: number, optId: string) => {
         setScore(score + optScore);
         setSelections([...selections, optId]);
         if (current < scenarios.length - 1) setCurrent(current + 1);
         else setPhase('result');
      };

      const s = scenarios[current];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-cyan-900 to-teal-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {scenarios.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i < current ? 'bg-blue-400' : i === current ? 'bg-blue-300' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-6 text-center">
               <p className="text-sm opacity-60 mb-2">GOAL {current + 1} of {scenarios.length}</p>
               <p className="text-xl font-bold">{s.goal}</p>
            </div>
            <p className="text-center mb-4 opacity-80">Select the best channel:</p>
            <div className="flex flex-col gap-3">
               {s.options.map((opt) => (
                  <button key={opt.id} onClick={() => handleSelect(opt.score, opt.id)}
                     className="p-4 bg-black/30 rounded-xl hover:bg-blue-500/30 transition-all text-left font-medium">
                     {opt.label}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // 34. CONTENT STRATEGY - Content Calendar Builder
   const ContentStrategyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [content, setContent] = useState<{type: string; topic: string; platform: string}[]>([]);
      const [currentType, setCurrentType] = useState('');
      const [topic, setTopic] = useState('');
      const [platform, setPlatform] = useState('');

      const contentTypes = ['üìù Blog Post', 'üìπ Video', 'üéôÔ∏è Podcast', 'üìä Infographic', 'üì± Social Post'];
      const platforms = ['Website', 'YouTube', 'LinkedIn', 'Instagram', 'Twitter', 'TikTok'];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">Content Strategy</p>
                  <p>A documented plan for creating, publishing, and managing content. Consistent content builds authority and attracts customers.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üìÖ</p>
            <h2 className="text-3xl font-bold mb-4">Content Strategy Builder</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Plan your content calendar by selecting content types, topics, and platforms.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-orange-500 rounded-2xl font-bold text-xl hover:bg-orange-400 transition-all">START PLANNING ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8">
            <h2 className="text-2xl font-bold text-center mb-4">üìÖ Your Content Calendar</h2>
            <div className="flex-1 overflow-auto">
               {content.map((c, i) => (
                  <div key={i} className="bg-black/30 rounded-xl p-4 mb-3 flex items-center gap-4">
                     <span className="text-2xl">{c.type.split(' ')[0]}</span>
                     <div className="flex-1">
                        <p className="font-bold">{c.topic}</p>
                        <p className="text-sm opacity-70">{c.type.split(' ').slice(1).join(' ')} ‚Ä¢ {c.platform}</p>
                     </div>
                  </div>
               ))}
            </div>
            <button onClick={() => { setPhase('intro'); setContent([]); }} className="px-6 py-3 bg-orange-500 rounded-xl font-bold mt-4">CREATE NEW PLAN</button>
         </div>
      );

      const addContent = () => {
         if (currentType && topic && platform) {
            setContent([...content, { type: currentType, topic, platform }]);
            setCurrentType('');
            setTopic('');
            setPlatform('');
         }
      };

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-8">
            <p className="text-sm text-center mb-4 opacity-70">Added: {content.length} content pieces</p>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <p className="text-sm mb-2 opacity-80">Content Type:</p>
               <div className="flex flex-wrap gap-2">
                  {contentTypes.map((t) => (
                     <button key={t} onClick={() => setCurrentType(t)}
                        className={`px-3 py-1 rounded-full text-sm ${currentType === t ? 'bg-orange-500' : 'bg-black/30'}`}>{t}</button>
                  ))}
               </div>
            </div>
            <input value={topic} onChange={(e) => setTopic(e.target.value)} placeholder="Topic/Title..."
               className="p-3 rounded-xl bg-black/30 border border-orange-500/30 text-white mb-4" />
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <p className="text-sm mb-2 opacity-80">Platform:</p>
               <div className="flex flex-wrap gap-2">
                  {platforms.map((p) => (
                     <button key={p} onClick={() => setPlatform(p)}
                        className={`px-3 py-1 rounded-full text-sm ${platform === p ? 'bg-orange-500' : 'bg-black/30'}`}>{p}</button>
                  ))}
               </div>
            </div>
            <div className="flex gap-3">
               <button onClick={addContent} className="flex-1 px-6 py-3 bg-orange-500 rounded-xl font-bold">ADD CONTENT</button>
               <button onClick={() => content.length > 0 && setPhase('result')} className="px-6 py-3 bg-orange-700 rounded-xl font-bold">VIEW PLAN</button>
            </div>
         </div>
      );
   };

   // 35. EMAIL MARKETING - Email Campaign Builder
   const EmailMarketingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [email, setEmail] = useState({ subject: '', preview: '', cta: '', segment: '' });
      const [step, setStep] = useState(0);
      const [inputValue, setInputValue] = useState('');

      const steps = [
         { key: 'segment', icon: 'üë•', label: 'Audience Segment', prompt: 'Who is this email for? (New subscribers, VIPs, etc.)' },
         { key: 'subject', icon: 'üìß', label: 'Subject Line', prompt: 'Write a compelling subject line (50 chars max)' },
         { key: 'preview', icon: 'üëÄ', label: 'Preview Text', prompt: 'What preview text appears after the subject?' },
         { key: 'cta', icon: 'üîò', label: 'Call to Action', prompt: 'What action should readers take?' }
      ];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-violet-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">Email Marketing</p>
                  <p>One of the highest ROI marketing channels. Key metrics: open rate, click-through rate, conversion rate.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üìß</p>
            <h2 className="text-3xl font-bold mb-4">Email Campaign Builder</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Design an effective email campaign with compelling subject lines and clear CTAs.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-indigo-500 rounded-2xl font-bold text-xl hover:bg-indigo-400 transition-all">BUILD CAMPAIGN ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-violet-900 text-white p-8">
            <h2 className="text-2xl font-bold text-center mb-6">üìß Email Preview</h2>
            <div className="bg-white text-black rounded-xl p-6 flex-1">
               <p className="text-xs text-gray-500 mb-2">To: {email.segment}</p>
               <p className="font-bold text-lg mb-1">{email.subject}</p>
               <p className="text-gray-600 text-sm mb-4">{email.preview}</p>
               <div className="border-t pt-4">
                  <button className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold">{email.cta}</button>
               </div>
            </div>
            <button onClick={() => { setPhase('intro'); setEmail({ subject: '', preview: '', cta: '', segment: '' }); setStep(0); }} className="px-6 py-3 bg-indigo-500 rounded-xl font-bold mt-4">CREATE NEW EMAIL</button>
         </div>
      );

      const submitStep = () => {
         setEmail({ ...email, [steps[step].key]: inputValue });
         setInputValue('');
         if (step < 3) setStep(step + 1);
         else setPhase('result');
      };

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-violet-900 text-white p-8">
            <div className="flex gap-2 mb-6">
               {steps.map((_, i) => (
                  <div key={i} className={`flex-1 h-2 rounded-full ${i <= step ? 'bg-indigo-400' : 'bg-black/30'}`}></div>
               ))}
            </div>
            <div className="bg-black/30 rounded-2xl p-6 mb-4 text-center">
               <p className="text-4xl mb-2">{steps[step].icon}</p>
               <p className="text-xl font-bold">{steps[step].label}</p>
               <p className="text-sm opacity-75 mt-2">{steps[step].prompt}</p>
            </div>
            <input value={inputValue} onChange={(e) => setInputValue(e.target.value)}
               placeholder="Your answer..." className="p-4 rounded-xl bg-black/30 border border-indigo-500/30 text-white mb-4" />
            <button onClick={submitStep} className="px-6 py-3 bg-indigo-500 rounded-xl font-bold">
               {step < 3 ? 'NEXT ‚Üí' : 'PREVIEW EMAIL'}
            </button>
         </div>
      );
   };

   // 36. INFLUENCER MARKETING - Influencer Selection Game
   const InfluencerMarketingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [score, setScore] = useState(0);
      const [current, setCurrent] = useState(0);

      const scenarios = [
         { brand: 'Sustainable Fashion Startup', budget: '$5K', best: 'micro', options: [
            { id: 'mega', label: 'üëë Mega (1M+ followers)', followers: '2M', rate: '$10K', fit: 'Low', score: 2 },
            { id: 'micro', label: 'üåü Micro (10K-100K)', followers: '50K', rate: '$500', fit: 'High', score: 10 },
            { id: 'macro', label: '‚≠ê Macro (100K-1M)', followers: '500K', rate: '$5K', fit: 'Medium', score: 5 }
         ]},
         { brand: 'National Beverage Launch', budget: '$100K', best: 'macro', options: [
            { id: 'nano', label: 'üí´ Nano (1K-10K)', followers: '5K', rate: '$100', fit: 'High', score: 4 },
            { id: 'macro', label: '‚≠ê Macro (100K-1M)', followers: '800K', rate: '$15K', fit: 'High', score: 10 },
            { id: 'micro', label: 'üåü Micro (10K-100K)', followers: '30K', rate: '$300', fit: 'Medium', score: 6 }
         ]},
         { brand: 'Local Restaurant', budget: '$1K', best: 'nano', options: [
            { id: 'nano', label: 'üí´ Nano (1K-10K)', followers: '3K', rate: '$50', fit: 'Very High', score: 10 },
            { id: 'micro', label: 'üåü Micro (10K-100K)', followers: '25K', rate: '$400', fit: 'Medium', score: 5 },
            { id: 'macro', label: '‚≠ê Macro (100K-1M)', followers: '200K', rate: '$3K', fit: 'Low', score: 2 }
         ]}
      ];

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm">
                  <p className="font-bold mb-2">Influencer Tiers</p>
                  <p>Nano (1K-10K), Micro (10K-100K), Macro (100K-1M), Mega (1M+). Smaller influencers often have higher engagement rates.</p>
               </div>
            )}
            <p className="text-6xl mb-4">üåü</p>
            <h2 className="text-3xl font-bold mb-4">Influencer Selection</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Choose the right influencer tier for each brand scenario.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-rose-500 rounded-2xl font-bold text-xl hover:bg-rose-400 transition-all">START SELECTING ‚Üí</button>
         </div>
      );

      if (phase === 'result') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white p-8 text-center">
            <p className="text-6xl mb-4">{score >= 25 ? 'üèÜ' : score >= 15 ? '‚≠ê' : 'üìö'}</p>
            <h2 className="text-3xl font-bold mb-4">Selection Score</h2>
            <p className="text-5xl font-bold text-rose-400 mb-4">{score}/{scenarios.length * 10}</p>
            <p className="text-lg opacity-80 mb-8">{score >= 25 ? 'Influencer marketing pro!' : score >= 15 ? 'Good instincts!' : 'Study influencer tiers!'}</p>
            <button onClick={() => { setPhase('intro'); setScore(0); setCurrent(0); }} className="px-6 py-3 bg-rose-500 rounded-xl font-bold">TRY AGAIN</button>
         </div>
      );

      const handleSelect = (optScore: number) => {
         setScore(score + optScore);
         if (current < scenarios.length - 1) setCurrent(current + 1);
         else setPhase('result');
      };

      const s = scenarios[current];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white p-8">
            <div className="bg-black/30 rounded-2xl p-4 mb-4 text-center">
               <p className="text-lg font-bold">{s.brand}</p>
               <p className="text-sm opacity-70">Budget: {s.budget}</p>
            </div>
            <p className="text-center mb-4 opacity-80">Select the best influencer:</p>
            <div className="flex flex-col gap-3 flex-1">
               {s.options.map((opt) => (
                  <button key={opt.id} onClick={() => handleSelect(opt.score)}
                     className="p-4 bg-black/30 rounded-xl hover:bg-rose-500/30 transition-all text-left">
                     <p className="font-bold">{opt.label}</p>
                     <p className="text-sm opacity-70">Followers: {opt.followers} ‚Ä¢ Rate: {opt.rate} ‚Ä¢ Fit: {opt.fit}</p>
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // 37. SALES FUNNEL - Funnel Builder
   const SalesFunnelRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Funnel Optimization Lab - Master conversion psychology and identify funnel leaks
      const scenarios = [
         {
            title: "The Leaky Bucket",
            context: "Your SaaS funnel: 10,000 visitors ‚Üí 500 signups (5%) ‚Üí 50 trials (10%) ‚Üí 5 paid (10%). Industry benchmarks: Visitor‚ÜíSignup 3%, Signup‚ÜíTrial 30%, Trial‚ÜíPaid 25%.",
            question: "Where should you focus optimization efforts FIRST?",
            opts: [
               'Top of funnel - get more visitors since you\'re above benchmark',
               'Middle of funnel - signup to trial is way below benchmark (10% vs 30%)',
               'Bottom of funnel - trial to paid is below benchmark',
               'All stages equally - optimize everything at once'
            ],
            correct: 1,
            wrongExplanations: [
               "You're ABOVE benchmark on visitors‚Üísignup (5% vs 3%). Optimizing your strength wastes resources. Fix the biggest leak first.",
               "", // Correct
               "Trial‚ÜíPaid (10% vs 25%) is bad, but fixing it only improves 50 trials ‚Üí maybe 12 paid. Fixing Signup‚ÜíTrial could give you 150 trials ‚Üí 37 paid. Fix the bigger leak first.",
               "Optimizing everything dilutes focus. Startups win by finding the biggest lever and pulling hard. Identify your constraint."
            ],
            realWorld: "Dropbox found their signup‚Üíactivation was leaky (users signed up but never uploaded files). They added an onboarding checklist and 2x'd activation. The insight: fix one stage at a time, starting with the worst relative to benchmarks.",
            concept: "funnel_diagnostics",
            why: "Funnel optimization is about finding constraints. A 3x improvement in your worst stage (10%‚Üí30%) has more impact than 1.5x improvement in three stages. Your Signup‚ÜíTrial is 3x below benchmark - that's your constraint. Fix it before touching anything else."
         },
         {
            title: "The Conversion Killer",
            context: "Your landing page converts at 1.5% (industry: 3%). You have data: Time on page is high (4 min avg), scroll depth is good (70% reach CTA), but CTA clicks are low (2%). Bounce rate is normal (40%).",
            question: "What's the MOST LIKELY problem?",
            opts: [
               'The headline isn\'t compelling enough',
               'The CTA button color/placement is wrong',
               'The value proposition is unclear or the CTA copy doesn\'t match intent',
               'You need more social proof on the page'
            ],
            correct: 2,
            wrongExplanations: [
               "If the headline was bad, time-on-page and scroll depth would be poor. People ARE reading - they just aren't clicking. The problem is downstream.",
               "Button color rarely matters more than 5-10%. High engagement + low CTA clicks suggests a VALUE problem, not a design problem.",
               "", // Correct
               "More social proof might help marginally, but high engagement with low CTA clicks suggests people understand the product but don't see enough value to take action."
            ],
            realWorld: "Basecamp tested 37 landing page variations. The winner wasn't about colors or buttons - it was about clearly stating what happens AFTER you click. 'Start your free trial' beat 'Get started' by 30% because it reduced uncertainty.",
            concept: "conversion_psychology",
            why: "High engagement + low conversion = disconnect between content and CTA. Users are interested (they're reading) but the CTA doesn't match their readiness or the value proposition isn't clear. The fix: clarify what happens next and why it's worth their time."
         },
         {
            title: "The Pricing Page Paradox",
            context: "You offer 3 tiers: Basic ($9), Pro ($29), Enterprise ($99). Traffic splits: Basic page 50%, Pro 35%, Enterprise 15%. But conversions: Basic 8%, Pro 2%, Enterprise 5%. Basic customers churn at 15%/month, Pro at 3%/month.",
            question: "What's the strategic problem with this funnel?",
            opts: [
               'Enterprise pricing is too high - lower it to get more volume',
               'You\'re optimizing for the wrong tier - Pro has best LTV but lowest conversion',
               'Basic tier is cannibalizing Pro - too many features at low price',
               'Both B and C - you need to restructure to push users toward Pro'
            ],
            correct: 3,
            wrongExplanations: [
               "Enterprise at 5% conversion with presumably high LTV is fine. The problem is your funnel pushes people to Basic, which churns fast.",
               "This is PART of the problem. Pro has best retention (3% churn) but worst conversion (2%). But WHY is Pro converting poorly?",
               "This is PART of the problem. If Basic has too many features, value-conscious buyers choose it instead of Pro. But you need to fix both issues.",
               "" // Correct
            ],
            realWorld: "Slack deliberately made their free tier limited enough that growing teams HAD to upgrade. They optimized for paid conversion, not free signups. Result: 30% of free teams convert to paid - unheard of in freemium.",
            concept: "tier_optimization",
            why: "Your funnel is broken in two ways: 1) Basic is too attractive (50% traffic, 8% conversion) but churns fast (15%/mo). 2) Pro has best retention but converts poorly - likely because Basic offers too much. Solution: Nerf Basic, add value to Pro, restructure pricing page to anchor on Pro."
         },
         {
            title: "The Email Sequence Mystery",
            context: "Your trial‚Üípaid nurture sequence: Email 1 (Day 1): 45% open, 8% click. Email 2 (Day 3): 35% open, 5% click. Email 3 (Day 7): 20% open, 2% click. Email 4 (Day 10): 12% open, 1% click. Trial conversion: 8% (industry: 15%).",
            question: "What does this data tell you about your sequence?",
            opts: [
               'Your subject lines are getting worse - focus on better copywriting',
               'Email fatigue is normal - this sequence is fine',
               'Users are losing interest because emails aren\'t driving product engagement',
               'You\'re sending too many emails - reduce frequency'
            ],
            correct: 2,
            wrongExplanations: [
               "Declining opens are NORMAL in sequences (email fatigue). The real problem: clicks are low AND declining. If emails drove product value, engagement would stay higher.",
               "This sequence is NOT fine. 8% trial conversion vs 15% industry benchmark means you're leaving 50%+ on the table. Something is broken.",
               "", // Correct
               "Frequency isn't the issue. The issue is that emails aren't creating product 'aha moments.' Fewer bad emails won't help."
            ],
            realWorld: "Slack's onboarding emails don't sell - they teach ONE feature per email and measure whether users TRY that feature. Their 'aha moment' is sending 2,000 messages as a team. Every email drives toward that metric.",
            concept: "activation_sequences",
            why: "Email opens declining is normal. But click decline + low trial conversion means your emails aren't driving the 'aha moment.' Winning sequences: 1) Identify your activation metric (Slack: 2K messages, Dropbox: 1 file), 2) Make every email drive toward that metric, 3) Measure product engagement, not email engagement."
         },
         {
            title: "The Retargeting Trap",
            context: "You're retargeting cart abandoners: Audience of 10,000 abandoners. Retargeting ad CTR: 2% (good). Landing page conversion: 15% (good). But ROI is negative - you're spending $5 to acquire customers worth $3.",
            question: "What's wrong with this retargeting strategy?",
            opts: [
               'Your ads aren\'t compelling enough',
               'Landing page needs optimization',
               'You\'re retargeting ALL abandoners instead of segmenting by intent',
               'Retargeting doesn\'t work - stop doing it'
            ],
            correct: 2,
            wrongExplanations: [
               "2% CTR is good for retargeting. Ad creative isn't the problem - targeting is.",
               "15% conversion is excellent. The landing page is working.",
               "", // Correct
               "Retargeting works extremely well when done right. The issue is strategy, not the channel."
            ],
            realWorld: "Amazon segments cart abandoners: 1) Added item but left immediately (low intent - minimal spend), 2) Filled cart and entered checkout (high intent - aggressive retargeting), 3) Abandoned at payment (friction - offer support). Same channel, 5x different CPAs.",
            concept: "retargeting_segmentation",
            why: "Treating all abandoners equally wastes money. Someone who left after 10 seconds has different intent than someone who reached the payment page. Segment by: 1) Time on site, 2) Cart value, 3) Checkout progress, 4) Return visits. Spend more on high-intent, less on low-intent."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         funnel_diagnostics: "Funnel Constraint Analysis",
         conversion_psychology: "Conversion Psychology & CTA Optimization",
         tier_optimization: "Pricing Tier Strategy",
         activation_sequences: "Activation & Onboarding Sequences",
         retargeting_segmentation: "Behavioral Retargeting Segmentation"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         aida: {
            title: "AIDA Framework",
            content: "Attention ‚Üí Interest ‚Üí Desire ‚Üí Action. Classic funnel stages. But modern funnels add: Awareness ‚Üí Consideration ‚Üí Conversion ‚Üí Retention ‚Üí Advocacy. The best funnels optimize for RETENTION, not just initial conversion. A 5% improvement in retention often beats 25% improvement in acquisition."
         },
         metrics: {
            title: "Key Funnel Metrics",
            content: "Track: 1) Stage-by-stage conversion rates, 2) Time between stages, 3) Drop-off points, 4) Cohort retention, 5) CAC payback period. Compare to industry benchmarks: SaaS visitor‚Üítrial 2-5%, trial‚Üípaid 15-25%, B2C e-commerce cart‚Üípurchase 2-4%. Your biggest gap = your biggest opportunity."
         },
         psychology: {
            title: "Conversion Psychology",
            content: "Cialdini's 6 principles: 1) Reciprocity (give before asking), 2) Scarcity (limited time/quantity), 3) Authority (expert endorsement), 4) Consistency (small commitments lead to big ones), 5) Liking (similarity, compliments), 6) Social proof (others are doing it). Use ethically."
         },
         testing: {
            title: "A/B Testing Fundamentals",
            content: "Rules: 1) Test ONE variable at a time, 2) Run until statistical significance (95%+ confidence), 3) Test big changes first (headlines, offers), then small (colors, buttons), 4) Document everything, 5) Winning tests often reveal customer psychology insights more valuable than the lift itself."
         }
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Correct! Mastered ${conceptLabels[s.concept]}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó ${s.title}: Missed. Fell for "${s.opts[idx].substring(0, 40)}..."`]);
            if (!conceptGaps.includes(s.concept)) {
               setConceptGaps(prev => [...prev, s.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setAnswered(false);
            setSelected(null);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-6">
               <div className="text-6xl mb-4">üîª</div>
               <h2 className="text-2xl font-bold mb-2">Funnel Optimization Lab</h2>
               <p className="text-slate-300 text-center mb-4 max-w-md">
                  Master the art of diagnosing and fixing conversion funnels like a growth expert.
               </p>
               <div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm">
                  <p className="text-blue-400 font-bold mb-2">üéØ What You'll Learn:</p>
                  <ul className="text-slate-300 space-y-1 text-xs">
                     <li>‚Ä¢ How to find the biggest leaks in any funnel</li>
                     <li>‚Ä¢ Why high engagement doesn't always mean high conversion</li>
                     <li>‚Ä¢ The psychology behind why people don't convert</li>
                     <li>‚Ä¢ Real optimization strategies from Dropbox, Slack, Amazon</li>
                  </ul>
               </div>
               <button
                  onClick={() => setPhase('play')}
                  className="px-8 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl font-bold hover:from-blue-400 hover:to-indigo-400 transition-all"
               >
                  Start Optimizing
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-6 overflow-auto">
               <div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üîª' : grade === 'C' ? 'üìä' : 'üìö'}</div>
               <h2 className="text-2xl font-bold mb-2">Funnel Analysis Complete</h2>
               <div className="text-4xl font-bold text-blue-400 mb-2">{score}/{scenarios.length}</div>
               <div className="text-5xl mb-4">{grade}</div>
               <p className="text-slate-400 mb-4 text-center">
                  {grade === 'A' ? 'Conversion expert! You think like a growth lead.' :
                   grade === 'B' ? 'Strong funnel intuition. Some optimization gaps to fill.' :
                   grade === 'C' ? 'Decent foundation, but missing key conversion concepts.' :
                   'Funnel optimization requires more study. Review the fundamentals.'}
               </p>

               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4">
                     <p className="text-blue-400 font-bold text-sm mb-2">üìö Concepts to Study:</p>
                     <ul className="text-slate-300 text-xs space-y-1">
                        {conceptGaps.map(gap => (
                           <li key={gap}>‚Ä¢ {conceptLabels[gap]}</li>
                        ))}
                     </ul>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">
                  <p className="text-blue-400 font-bold text-sm mb-2">Session Log:</p>
                  {gameLog.map((entry, i) => (
                     <p key={i} className="text-xs text-slate-300">{entry}</p>
                  ))}
               </div>

               <button
                  onClick={() => {
                     setPhase('intro');
                     setScenario(0);
                     setScore(0);
                     setAnswered(false);
                     setSelected(null);
                     setGameLog([]);
                     setConceptGaps([]);
                  }}
                  className="px-6 py-2 bg-blue-600 rounded-lg hover:bg-blue-500"
               >
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-blue-500/30 flex justify-between items-center">
               <span className="font-bold">üîª Funnel Lab</span>
               <span className="text-blue-400">{scenario + 1}/{scenarios.length}</span>
               <span className="text-indigo-400">Score: {score}</span>
            </div>

            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-xl p-3 mb-3">
                  <p className="font-bold text-blue-400 mb-2">{s.title}</p>
                  <p className="text-sm text-slate-300">{s.context}</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-3">
                  <p className="font-medium text-white">{s.question}</p>
               </div>

               <div className="grid gap-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600'
                                 : i === selected
                                    ? 'bg-red-600'
                                    : 'bg-black/30'
                              : 'bg-black/30 hover:bg-blue-600/50'
                        }`}
                     >
                        {opt}
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-3">
                     {selected !== s.correct && s.wrongExplanations[selected!] && (
                        <div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30">
                           <p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Was Wrong:</p>
                           <p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30">
                        <p className="text-xs text-green-300 font-bold mb-1">‚úì Optimization Insight:</p>
                        <p className="text-sm text-green-100">{s.why}</p>
                     </div>
                     <div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30">
                        <p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p>
                        <p className="text-sm text-blue-100">{s.realWorld}</p>
                     </div>
                     <button
                        onClick={next}
                        className="w-full py-2 bg-blue-600 rounded-lg hover:bg-blue-500"
                     >
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-blue-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button
                     key={k}
                     onClick={() => { setInfoTopic(k); setShowInfo(true); }}
                     className="text-xs text-blue-400 hover:text-blue-300"
                  >
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // 38. PUBLIC RELATIONS - PR Crisis Simulator
   const PublicRelationsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Viral Complaint",
            context: "A customer posts a TikTok showing your product catching fire during normal use. Video: 2.3M views in 12 hours. Comments are brutal. Your product team confirms it's a rare manufacturing defect affecting ~0.01% of units. Legal says 'say nothing until we investigate.' Marketing wants to wait until the news cycle moves on. Customer service is getting flooded.",
            question: "What's the right immediate response?",
            opts: [
               "A) Stay silent‚Äîlet legal complete the investigation first",
               "B) Acknowledge quickly, express concern, announce immediate investigation and remedy",
               "C) Post a counter-video explaining the customer was using it wrong",
               "D) Offer the complaining customer money to delete the video"
            ],
            correct: 1,
            wrongExplanations: [
               "Silence in a viral crisis is interpreted as guilt. Every hour of silence spawns more negative coverage. Legal caution is appropriate for statements of liability, not for expressing concern and announcing action.",
               "",
               "Blaming the customer when video shows normal use is gasoline on fire. It creates 'company vs customer' narrative that the internet will rally against. Even if true, the timing makes you look defensive.",
               "Paying for deletion is bribery that will leak. When it does, the story becomes 'Company tried to cover up dangerous product.' This turns a product crisis into an ethics scandal."
            ],
            realWorld: "Samsung's Galaxy Note 7 battery fires in 2016: Initial silence and denial cost them $5B+ and permanent brand damage. Contrast with Johnson & Johnson's 1982 Tylenol crisis: Immediate recall, transparent communication, and prioritizing safety over profits‚Äîthey recovered market share within a year and set the gold standard for crisis response.",
            concept: "crisis_speed",
            why: "In viral crises, speed beats perfection. You don't need all answers‚Äîyou need to show you care and are acting. Template: 1) Acknowledge the issue exists, 2) Express genuine concern for those affected, 3) Announce immediate investigation, 4) Promise updates. This buys goodwill while you figure out details."
         },
         {
            title: "The Media Ambush",
            context: "A journalist from a major tech publication emails: 'We're publishing a story tomorrow about toxic culture at your startup. Multiple former employees describe harassment that leadership ignored. We'd like your comment by 5pm today.' You have 4 hours. Some allegations are false, some are exaggerated versions of real incidents, one is accurate and serious.",
            question: "How should you respond to this media request?",
            opts: [
               "A) Decline to comment‚Äîanything you say will be used against you",
               "B) Respond with prepared statement addressing each allegation specifically",
               "C) Threaten legal action if they publish false claims",
               "D) Ask for a week extension to investigate internally"
            ],
            correct: 1,
            wrongExplanations: [
               "'No comment' appears in print as 'Company declined to respond to allegations.' Readers assume guilt. You've given up your only chance to shape the narrative before publication.",
               "",
               "Legal threats against journalists almost always backfire. It becomes 'Company tries to silence reporters'‚Äîa worse story than the original. Media organizations have legal teams and view threats as confirmation of wrongdoing.",
               "Journalists have their own deadlines and won't wait a week. This request will be noted as 'Company asked for unreasonable delay.' They'll publish without your input, which is worse than a prepared response."
            ],
            realWorld: "Uber's 2017 culture crisis: Susan Fowler's blog post led to avalanche of media investigations. Uber's initial denials and legal posturing made things worse. Companies that survive scandals (Microsoft under Nadella) respond with: acknowledge problems exist, show specific changes underway, demonstrate accountability.",
            concept: "media_response",
            why: "The statement approach: Address true allegations with accountability ('We take this seriously, here's what we're doing'). For false allegations, factually correct with evidence. Never attack the journalist or sources. Provide context without being defensive. Your response shapes how the story reads."
         },
         {
            title: "The Competitor Attack",
            context: "Your main competitor's CEO tweets: 'Surprised @YourCompany is still in business given their data breach last year. We've never had a security incident.' This is misleading‚Äîyour 'breach' was a minor vulnerability disclosed and patched within hours; they've had unreported incidents. The tweet has 50K impressions and industry analysts are watching.",
            question: "What's the strategic response to competitor attacks?",
            opts: [
               "A) Publicly expose their unreported security incidents",
               "B) Respond professionally with facts, then pivot to your strengths",
               "C) Ignore it‚Äîdon't give them more attention",
               "D) Have your investors or customers attack them on your behalf"
            ],
            correct: 1,
            wrongExplanations: [
               "Exposing their incidents makes you look petty and starts a public mud fight. Analysts watching see two companies attacking each other‚Äîneither looks professional. You become the story instead of solving it.",
               "",
               "Ignoring leaves their false claim unchallenged. Analysts and customers who see it may believe it. In B2B especially, unanswered attacks can influence deals. Silence isn't always golden.",
               "Proxy attacks are transparent and embarrassing when discovered. It looks like you're orchestrating a campaign rather than being confident in your position. This damages relationships with investors and customers."
            ],
            realWorld: "The 'Get a Mac' campaign was brilliant because Apple focused on its own strengths while making gentle comparisons. Contrast with the Pepsi/Coke wars that made both look petty. The best competitive responses are factual, brief, and pivot quickly to value proposition.",
            concept: "competitive_response",
            why: "The professional response: 'To clarify: [brief factual correction]. We're proud of [your actual strength]. Happy to discuss our security practices with any customer.' Then stop engaging. You've corrected the record without escalating. Multiple tweets make you look defensive."
         },
         {
            title: "The Founder Scandal",
            context: "Your CEO's old tweets from 10 years ago surface‚Äîoffensive jokes that don't reflect current values. An activist account with 500K followers is calling for boycott. Board is split: half want immediate resignation, half say 'wait and see.' CEO wrote genuine apology last night but hasn't posted it. Company has major funding round closing next week.",
            question: "How should the company navigate this founder scandal?",
            opts: [
               "A) CEO should resign immediately to protect the company",
               "B) Post genuine apology quickly, demonstrate growth, then get back to work",
               "C) Delete the old tweets and hope the story dies down",
               "D) Attack the activist account's credibility and motives"
            ],
            correct: 1,
            wrongExplanations: [
               "Immediate resignation signals the company agrees the offense is unforgivable. It doesn't actually satisfy critics (they just move to the next target) and destabilizes the company. Resignation should be reserved for ongoing or severe misconduct, not old statements.",
               "",
               "Deleting evidence looks like coverup. Screenshots already exist. The story becomes 'CEO tries to hide past' instead of 'CEO has grown.' Deletion is almost never the right move.",
               "Attacking critics makes the CEO look defensive and petty. It shifts the story to 'CEO attacks activist' which is more engaging than 'CEO apologizes.' Never give critics new ammunition."
            ],
            realWorld: "James Gunn was fired from Guardians of the Galaxy over old tweets, then rehired after reflection showed genuine growth. Kevin Hart stepped down from Oscars hosting but was later rehabilitated. The pattern: genuine acknowledgment of past mistakes + evidence of growth = path forward. Denial or attack = escalation.",
            concept: "personal_crisis",
            why: "The playbook for old statements: 1) Don't delete‚Äîacknowledge they exist, 2) Apologize genuinely without excuses ('I wrote those things, they were wrong'), 3) Show growth ('Here's how I've changed'), 4) Point to actions not words ('Here's what we've done as a company'). Then‚Äîcritically‚Äîstop apologizing and start demonstrating."
         },
         {
            title: "The Layoff Leak",
            context: "You're planning layoffs affecting 30% of staff next week. Somehow, tech blogs have the story and are publishing in 2 hours with the headline 'Mass Layoffs Coming.' Employees are panicking on Slack‚Äîthey saw the headline before any internal communication. Your carefully planned announcement sequence is ruined. HR is furious, employees are scared, and media is calling.",
            question: "How do you handle a leaked negative announcement?",
            opts: [
               "A) Deny the story until you're ready for the official announcement",
               "B) Immediately address employees first, then media‚Äîtransparency now",
               "C) Find and fire the leaker to send a message",
               "D) No comment until lawyers review everything"
            ],
            correct: 1,
            wrongExplanations: [
               "Denying a true story that's about to be confirmed destroys credibility. Employees will remember you lied to them. Trust, once lost to lies, is nearly impossible to rebuild.",
               "",
               "Leaker-hunting during a crisis is a distraction that changes the narrative. 'Company hunts for whistleblower' is worse press than the layoffs themselves. It also terrifies remaining employees about speaking up.",
               "Silence while employees panic is abandonment. Every minute without communication, they're imagining worst-case scenarios and updating LinkedIn. You lose good people who could have stayed."
            ],
            realWorld: "Airbnb's 2020 layoffs under Brian Chesky became a masterclass: honest, empathetic internal communication first, then public memo that treated departing employees with dignity. He offered extended healthcare, equity vesting, and outplacement. The result: positive press about how layoffs were handled, and alumni became brand ambassadors.",
            concept: "leaked_news",
            why: "When your announcement leaks: 1) Accept the timeline is now, not next week, 2) Internal communication FIRST‚Äîeven if just 'We're preparing a statement, all-hands in 30 minutes,' 3) Then media, 4) Be as transparent as possible about the 'why.' The story is happening‚Äîyour only control is how you show up in it."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         crisis_speed: "Crisis Response Timing",
         media_response: "Media Request Handling",
         competitive_response: "Competitive Attack Response",
         personal_crisis: "Founder Personal Crisis",
         leaked_news: "Leaked Announcement Management"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         crisis: { title: "Crisis Communication Basics", content: "The 3 C's: Care (show genuine concern), Commitment (promise action), Consistency (one message across channels). First 24 hours determine narrative. Speed beats perfection. Acknowledge, don't speculate. Promise updates, then deliver them." },
         media: { title: "Media Relations", content: "Journalists have jobs to do‚Äîhelp them do it accurately. Provide clear, quotable statements. Never say 'no comment.' Prepare key messages in advance. Everything is on the record. Build relationships before you need them." },
         social: { title: "Social Media Crises", content: "Social moves fast‚Äîhours, not days. Monitor constantly. Respond on the platform where the crisis started. Don't delete (screenshots exist). Be human, not corporate. Sometimes not responding IS the response. Know when to take conversations offline." },
         reputation: { title: "Reputation Building", content: "Reputation is built in calm times, tested in crises. Proactive thought leadership builds credibility reserves. Relationships with journalists, analysts, and influencers should exist BEFORE crises. Authenticity compounds; inauthenticity is eventually exposed." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Handled crisis effectively`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-6">
               <div className="text-6xl mb-4">üì∞</div>
               <h2 className="text-2xl font-bold mb-2">PR Crisis Simulator</h2>
               <p className="text-emerald-300 text-center mb-4 max-w-md">
                  Navigate high-stakes PR crises where timing, tone, and transparency determine whether your brand survives or burns.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll face scenarios involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Viral customer complaints with millions of views</li>
                     <li>‚Ä¢ Journalists with damaging stories on deadline</li>
                     <li>‚Ä¢ Competitor attacks that spread misinformation</li>
                     <li>‚Ä¢ Founder scandals from the past surfacing</li>
                     <li>‚Ä¢ Leaked announcements that destroy your timeline</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl font-bold">
                  Enter the Crisis
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üì∞' : grade === 'C' ? '‚ö†Ô∏è' : 'üî•'}</div>
               <h2 className="text-xl font-bold mb-2">Crisis Response Assessment</h2>
               <div className="text-3xl font-bold text-emerald-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Crisis communications expert! You protected the brand through every storm.' :
                   grade === 'B' ? 'Strong PR instincts‚Äîyou understand speed and transparency.' :
                   grade === 'C' ? 'Some missteps would cause lasting damage‚Äîstudy crisis response patterns.' :
                   'Review crisis fundamentals‚Äîseveral responses would have made situations worse.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">PR Skills to Develop:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-emerald-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-emerald-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-emerald-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-red-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">‚ö†Ô∏è {sc.title}</span>
               <span className="text-emerald-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-teal-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-emerald-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-emerald-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Effective Response:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why that backfires:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-lg p-3">
                        <p className="text-xs text-emerald-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-emerald-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Crisis'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-emerald-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-emerald-400 hover:text-emerald-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // 39. GUERRILLA MARKETING - Creative Campaign Ideas
   const GuerrillaMarketingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Zero-Budget Launch",
            context: "You're launching a specialty coffee roaster in a trendy urban neighborhood. Budget: literally $500 for all marketing. Established competitors spend $10K/month on ads. Your differentiator: you roast beans on-site daily (rare). You have 2 weeks until opening. The area has heavy foot traffic from office workers.",
            question: "What guerrilla tactic maximizes impact with $500?",
            opts: [
               "A) Spend it all on Instagram ads targeting the neighborhood",
               "B) Create a 'follow the aroma' scent trail with free sample stations at peak hours",
               "C) Print 5,000 flyers and distribute to nearby offices",
               "D) Hire a local influencer for a single post"
            ],
            correct: 1,
            wrongExplanations: [
               "Instagram ads at $500 in a competitive market will reach maybe 10-50K impressions‚Äînot enough to break through noise. You're competing against well-funded competitors on their turf. Ads are not guerrilla.",
               "",
               "Flyers have 1-2% engagement rates at best. 5,000 flyers = 50-100 potential customers. Most end up as litter, which damages your brand. This is old-school marketing, not guerrilla.",
               "A single influencer post for $500 gets low-tier influencers with fake engagement. One post doesn't create sustained awareness. You'd get 50-100 likes, maybe 5 customers. Not worth the spend."
            ],
            realWorld: "Death Wish Coffee used guerrilla marketing to become the 'world's strongest coffee.' They gave free samples at gas stations where truckers stopped, creating word-of-mouth. The sensory experience of on-site roasting IS the marketing‚Äîlet people smell and taste. Starbucks grew initially through aroma and sampling, not ads.",
            concept: "sensory_marketing",
            why: "Guerrilla marketing uses strengths competitors can't copy. Your on-site roasting creates aroma competitors can't replicate. A scent trail is free advertising that stops people. Free samples at 8AM when office workers need coffee creates habit. $500 covers cups and signage. This is experiential, shareable, and builds on your unique differentiator."
         },
         {
            title: "The Viral Stunt Gamble",
            context: "Your fitness app is launching against well-funded competitors (Peloton, etc.). Marketing suggests a 'bold stunt'‚Äîhiring 50 people to do synchronized workouts in Times Square, costing $25K for permits, participants, and production. Potential outcome: viral video or complete obscurity. Company has 6 months runway.",
            question: "Should you pursue this viral stunt?",
            opts: [
               "A) Yes‚Äîviral moments can define a brand overnight",
               "B) No‚Äîthe risk/reward ratio is wrong for a company with 6 months runway",
               "C) Do it but cheaper‚Äî10 people instead of 50",
               "D) Wait until you have more funding, then do it bigger"
            ],
            correct: 1,
            wrongExplanations: [
               "Viral moments are lottery tickets. For every Dollar Shave Club, there are thousands of stunts that flopped. With 6 months runway, you can't afford lottery tickets. One failed expensive campaign could mean death.",
               "",
               "10 people doesn't create the 'spectacle' needed for virality. It looks like a small group working out‚Äînot news. You'd spend money without achieving the scale needed for impact. Worst of both worlds.",
               "Waiting for more funding assumes you'll get it. You might not. And 'bigger later' doesn't solve the fundamental risk‚Äîyou'd just be betting more. The strategy is flawed, not the budget."
            ],
            realWorld: "Red Bull spends on stunts (Stratos jump cost $30M+) because they have billions in revenue to absorb failure. For startups, guerrilla should be low-cost, high-reward. Dropbox's viral referral program cost nearly nothing and drove exponential growth. Airbnb's Obama O's cereal got press coverage for the cost of cereal boxes.",
            concept: "asymmetric_bets",
            why: "True guerrilla is asymmetric: low cost, high potential impact. A $25K stunt with uncertain outcome is not guerrilla‚Äîit's a gamble. With 6 months runway, invest in 25 smaller experiments at $1K each. Some will work, and you'll learn which to scale. Betting everything on one viral moment is Vegas, not strategy."
         },
         {
            title: "The Community Hijack",
            context: "You're launching a B2B SaaS for small business accounting. Marketing budget: $3K/month. Your target: small business owners who hate accounting. There's a popular podcast for small business owners with 50K listeners‚Äîthe host charges $5K for sponsored episodes (too expensive). The host also runs a free Slack community with 2,000 members.",
            question: "How do you reach this audience guerrilla-style?",
            opts: [
               "A) Save up for the $5K podcast sponsorship‚Äîit's the best channel",
               "B) Become genuinely valuable in the Slack community, then offer free beta access",
               "C) Cold email the podcast listeners you can find on LinkedIn",
               "D) Run ads targeted at the podcast audience"
            ],
            correct: 1,
            wrongExplanations: [
               "Saving $5K means 2 months of your marketing budget on one podcast episode that listeners might skip. Podcast ads have uncertain ROI. You'd burn budget on a single bet rather than learning what works.",
               "",
               "Cold emailing podcast listeners is spam. They didn't consent to hearing from you. It damages your brand and probably violates CAN-SPAM. This isn't guerrilla‚Äîit's annoying.",
               "You can't effectively target 'podcast listeners' with ads‚Äîplatforms don't have that data. You'd be guessing at demographics and wasting budget on broad targeting."
            ],
            realWorld: "Superhuman grew through 'community-led growth'‚Äîshowing up where customers were and providing genuine value before asking for anything. Buffer's founder Leo Widrich wrote guest posts for months before launching. The principle: give value, build relationships, then offer your product. Community trust is free but requires time investment.",
            concept: "community_infiltration",
            why: "Guerrilla marketing in B2B means becoming a trusted community member. Answer questions. Share insights. Help people for free. After 4-6 weeks of adding value, you've earned the right to mention your solution. Beta invites to community members create word-of-mouth. This costs time, not money‚Äîthe guerrilla advantage."
         },
         {
            title: "The Newsjacking Opportunity",
            context: "A major tech company just announced they're shutting down a product that 500K users depend on. Your startup offers a similar solution. Twitter is exploding with angry users asking 'what do we switch to?' This is a 24-48 hour window. Your marketing team is suggesting a $20K Google Ads campaign targeting the competitor's brand name.",
            question: "What's the guerrilla response to this breaking news?",
            opts: [
               "A) Run the $20K Google Ads campaign‚Äîcapture the search traffic",
               "B) Create a free migration tool and tweet it directly to angry users",
               "C) Write a blog post comparing your product to the dying one",
               "D) Wait‚Äîaggressive marketing during competitor's death looks vulturous"
            ],
            correct: 1,
            wrongExplanations: [
               "Google Ads take hours to set up and approve. By the time they're running, the news cycle has moved on. Plus, everyone else is bidding on that keyword‚Äîprices spike during news events. You'd pay premium for late traffic.",
               "",
               "Blog posts take time to rank. No one will find it in the 24-hour window. SEO is a long game; newsjacking requires immediate action on the platforms where the conversation is happening.",
               "Waiting is leaving money on the table. 500K users are actively looking for alternatives RIGHT NOW. Helping them isn't vulturous‚Äîit's solving their problem. Your competitors aren't waiting."
            ],
            realWorld: "When Google killed Google Reader, Feedly newsjacked by tweeting 'We've got you covered' and saw 3M users join in 2 weeks. When Vine died, TikTok (then Musical.ly) created migration tools. The pattern: be immediately helpful at the moment of pain, before competitors react. Speed is the guerrilla advantage.",
            concept: "newsjacking",
            why: "Newsjacking = real-time marketing that inserts your brand into breaking news. The free migration tool is the key: you're not just saying 'use us'‚Äîyou're solving their immediate problem. Tweet at the angry users directly. They're receptive because they're in pain NOW. This costs engineering time, not marketing dollars. Ship fast; capture the moment."
         },
         {
            title: "The Anti-Advertising Play",
            context: "Your sustainable fashion brand targets Gen Z consumers who actively distrust advertising. They skip ads, use ad blockers, and mock branded content. You have $10K for a campaign. Traditional influencer marketing feels inauthentic. Your clothes are genuinely sustainable (certified, transparent supply chain)‚Äîbut so are competitors' claims.",
            question: "How do you market to an ad-hostile audience?",
            opts: [
               "A) Find micro-influencers who seem more 'authentic'",
               "B) Create genuine entertainment or utility content that happens to feature your product",
               "C) Lean into educational content about sustainability‚Äîestablish thought leadership",
               "D) Focus on PR‚Äîget earned media coverage in fashion publications"
            ],
            correct: 1,
            wrongExplanations: [
               "Gen Z can smell sponsored content regardless of follower count. 'Micro-influencers' who post branded content are still advertisements. The format is recognized and dismissed. You're putting lipstick on an ad.",
               "",
               "Educational content is valuable but doesn't differentiate‚Äîeveryone claims sustainability. 'Thought leadership' from a brand is still branded content. Gen Z questions the messenger as much as the message.",
               "PR coverage is good but not controllable or guerrilla. Fashion publications are saturated with sustainable brands. Getting coverage requires news, not just existence."
            ],
            realWorld: "Patagonia's 'Don't Buy This Jacket' campaign worked because it was genuinely counter to their commercial interest. Liquid Death sells water in tallboy cans and creates comedy content that barely mentions water. The brand IS entertainment. Gen Z shares what's genuinely funny or interesting, not what's 'authentic-seeming.'",
            concept: "entertainment_first",
            why: "The only content that spreads in ad-hostile environments is content worth sharing on its own merits. Not 'authentic ads'‚Äîactual entertainment, humor, or utility. If your content wouldn't be shared without your logo, it won't be shared with it. Invest in genuinely good content where your product is incidental, not central. This is brand building, not conversion marketing."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         sensory_marketing: "Sensory & Experiential Marketing",
         asymmetric_bets: "Asymmetric Risk/Reward",
         community_infiltration: "Community-Led Growth",
         newsjacking: "Real-Time News Marketing",
         entertainment_first: "Entertainment-First Content"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         principles: { title: "Guerrilla Principles", content: "Low cost, high impact. Use creativity instead of budget. Be where competitors aren't. Create experiences, not ads. Make sharing irresistible. Time investment often beats money. Small can be an advantage‚Äîyou're nimble." },
         risks: { title: "Guerrilla Risks", content: "Legal issues (permits, trespassing). Brand damage if tone is wrong. Backfire potential (stunts gone wrong go viral for wrong reasons). Scalability limits. Time intensity. Not all guerrilla is appropriate for all brands." },
         digital: { title: "Digital Guerrilla", content: "Newsjacking (insert into trending conversations). Community infiltration (earn trust, then sell). Content hijacking (parody, commentary). Platform exploits (algorithm hacks, feature abuse). Tool marketing (build something useful, add your brand)." },
         measurement: { title: "Measuring Guerrilla", content: "Traditional metrics often don't apply. Track: social mentions, organic reach, earned media value, community sentiment, referral traffic. Success may be brand awareness, not immediate conversion. Set expectations appropriately." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Creative guerrilla thinking`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-6">
               <div className="text-6xl mb-4">üé≠</div>
               <h2 className="text-2xl font-bold mb-2">Guerrilla Marketing Lab</h2>
               <p className="text-lime-300 text-center mb-4 max-w-md">
                  Master unconventional marketing tactics that use creativity instead of budget to create outsized impact.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll face scenarios involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Zero-budget launches against funded competitors</li>
                     <li>‚Ä¢ Viral stunt gambles with limited runway</li>
                     <li>‚Ä¢ Community infiltration vs paid advertising</li>
                     <li>‚Ä¢ Newsjacking opportunities with 24-hour windows</li>
                     <li>‚Ä¢ Marketing to ad-hostile audiences</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-lime-500 to-green-500 rounded-xl font-bold text-black">
                  Go Guerrilla
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üé≠' : grade === 'C' ? 'üì¢' : 'üí∏'}</div>
               <h2 className="text-xl font-bold mb-2">Guerrilla Marketing Assessment</h2>
               <div className="text-3xl font-bold text-lime-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Guerrilla marketing genius! You think creatively and asymmetrically.' :
                   grade === 'B' ? 'Strong unconventional instincts‚Äîyou understand scrappy marketing.' :
                   grade === 'C' ? 'Some conventional thinking crept in‚Äîguerrilla means more creative risk.' :
                   'Review guerrilla principles‚Äîyou defaulted to traditional marketing approaches.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Tactics to Study:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-lime-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-lime-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-lime-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-lime-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">üé≠ {sc.title}</span>
               <span className="text-lime-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-green-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-lime-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-lime-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Guerrilla Thinking:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why that's too conventional:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-lime-900/30 border border-lime-500/30 rounded-lg p-3">
                        <p className="text-xs text-lime-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-lime-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-lime-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-lime-400 hover:text-lime-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // 40. COPYWRITING - Headline Writing Practice
   const CopywritingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Feature Trap",
            context: "You're writing the homepage headline for a B2B analytics platform. The product has: real-time dashboards, 50+ integrations, AI-powered insights, SOC 2 compliance. The CEO wants to highlight that you have 'the most features in the category.' Target audience: busy marketing directors who need to prove ROI to their CMO.",
            question: "Which headline will convert best?",
            opts: [
               "A) 'The Most Powerful Analytics Platform with 50+ Integrations'",
               "B) 'See Exactly Which Campaigns Drive Revenue‚Äîin 5 Minutes'",
               "C) 'AI-Powered, Real-Time Analytics for Modern Marketing Teams'",
               "D) 'Finally, Enterprise Analytics That's Actually Easy to Use'"
            ],
            correct: 1,
            wrongExplanations: [
               "Feature lists don't sell. 'Most powerful' is a claim; 'prove ROI to CMO' is the job. Nobody wakes up wanting '50+ integrations'‚Äîthey want results. This is inside-out thinking.",
               "",
               "'AI-powered' is every product now‚Äîit's meaningless differentiation. 'Real-time' and 'modern' are jargon. This headline describes what you ARE, not what you DO for the customer.",
               "'Enterprise that's easy' is a good angle but vague. How easy? What does easy mean? The promise isn't concrete enough to believe. It's a claim, not proof."
            ],
            realWorld: "Slack didn't launch with 'Team messaging with 2,000 integrations.' They said 'Be less busy.' Stripe didn't say 'Payment infrastructure with SOC 2 compliance.' They said 'Payments for developers.' The best headlines describe the OUTCOME, not the product.",
            concept: "benefit_focus",
            why: "The marketing director's job isn't 'use analytics tools'‚Äîit's 'prove which campaigns work.' The headline that mirrors their actual job (showing ROI to CMO) and adds specificity (5 minutes) wins. Time + outcome = believable promise. Features are proof points for the landing page, not the headline."
         },
         {
            title: "The Specificity Test",
            context: "You're writing an email subject line for a SaaS onboarding sequence. The email contains tips for getting value from the product faster. Open rates for this sequence have dropped from 45% to 28%. Current subject line: 'Tips to get more from [Product]'. The email is sent 3 days after signup.",
            question: "Which subject line will lift open rates?",
            opts: [
               "A) '5 quick wins you can get today'",
               "B) '3 things successful users do in their first week (you haven't done #2)'",
               "C) 'Getting started with [Product]‚Äîhelpful tips inside!'",
               "D) 'Don't miss these important product updates'"
            ],
            correct: 1,
            wrongExplanations: [
               "'5 quick wins' is good but generic. It could be from any product. The specificity of 'first week' and the curiosity gap of '#2' creates more urgency to open.",
               "",
               "This is the boring version of the original subject line. 'Tips inside' is newsletter-speak that trained inboxes to ignore. No curiosity, no urgency, no specificity.",
               "False urgency about 'updates' when the email is tips destroys trust. Users will open once, see it's not updates, and never trust your subject lines again."
            ],
            realWorld: "Booking.com A/B tests everything. They found 'Only 2 rooms left!' outperforms 'Book now!' by 200%+. The specificity ('2 rooms') creates believability. Obama's campaign famously A/B tested 'Hey' as a subject line‚Äîsimple curiosity beat formal asks.",
            concept: "curiosity_gap",
            why: "The curiosity gap principle: open a loop the reader must close. 'You haven't done #2' creates a gap‚Äîwhat's #2? Am I missing something? Combined with social proof ('successful users do'), it implies value the reader is leaving on the table. Urgency without specificity is spam; specificity without urgency is ignored."
         },
         {
            title: "The Social Proof Dilemma",
            context: "You're writing a landing page for a new productivity app. You have: 500 users after 2 months of beta, 4.8/5 average rating from 47 reviews, one testimonial from an employee at a famous company (mid-level, not exec), zero case studies. Marketing wants to lead with 'Trusted by teams at [Famous Company].'",
            question: "How should you use social proof at this stage?",
            opts: [
               "A) Lead with 'Trusted by teams at [Famous Company]'‚Äîthe logo carries weight",
               "B) Lead with outcome, use specific testimonials in context, save logos for later",
               "C) Show '4.8/5 stars from 47 reviews' prominently",
               "D) Skip social proof until you have more impressive numbers"
            ],
            correct: 1,
            wrongExplanations: [
               "One mid-level employee ‚â† 'trusted by teams.' If a journalist investigates and finds one person, not company-wide adoption, you've damaged credibility. This is startup social proof inflation‚Äîsavvy buyers see through it.",
               "",
               "47 reviews looks thin for a productivity app. Visitors will compare to established tools with thousands of reviews. Leading with a small number can actually hurt rather than help.",
               "No social proof makes you look unvalidated. The goal isn't more‚Äîit's smarter use. Specific, believable proof beats impressive-sounding claims that feel hollow."
            ],
            realWorld: "Basecamp in early days didn't fake 'Enterprise trusted' logos. They showed real quotes from real users saying specific things. 'This saved me 4 hours a week' beats 'Trusted by Fortune 500' when you're not actually trusted by Fortune 500s. Authenticity at your stage beats aspirational positioning.",
            concept: "authentic_proof",
            why: "Social proof must be believable. Specific testimonials ('I saved 4 hours/week') beat vague endorsements. Lead with the outcome‚Äîwhat the product does for the reader‚Äîthen support with proof that's proportional to your actual traction. Fake enterprise positioning damages trust with the customers who will actually buy at this stage."
         },
         {
            title: "The CTA Optimization",
            context: "Your SaaS has a 14-day free trial. The current CTA button says 'Start Free Trial.' Conversion rate from landing page to trial signup is 3.2%. Your main competitor's CTA says 'Get Started Free.' You're testing new CTA copy. The product requires significant setup before users see value (about 30 minutes of configuration).",
            question: "Which CTA will likely improve conversion?",
            opts: [
               "A) 'Start Your Free Trial' (add 'Your' for personalization)",
               "B) 'See [Product] in Action' (implies less commitment than 'Start')",
               "C) 'Get Started Free' (match the competitor)",
               "D) 'Start Free Trial ‚Äî No Credit Card Required'"
            ],
            correct: 1,
            wrongExplanations: [
               "Adding 'Your' is micro-optimization. The real issue is 'Start Trial' implies commitment and work. For a product requiring 30 minutes of setup, that's a big ask upfront.",
               "",
               "Copying competitors tells you nothing. Their CTA might be underperforming too. 'Get Started' still implies work. You're copying, not optimizing.",
               "'No credit card' is good for reducing friction but doesn't address the real objection‚Äîthe 30-minute setup. Users hesitate at effort, not just money."
            ],
            realWorld: "Crazy Egg increased conversions 363% by changing 'View Plans and Pricing' to 'Show Me My Heatmap.' The new CTA promised an immediate outcome, not a process. Netflix doesn't say 'Start Free Trial'‚Äîthey say 'Watch Free for 30 Days.' The action verb matters.",
            concept: "action_alignment",
            why: "'See in Action' reduces perceived commitment‚Äîit's watching, not working. For products with significant setup, implying immediate gratification ('see it') beats implying work ('start'). The CTA should match what users actually want to do, not what you want them to do. They want to see value; you want them to commit."
         },
         {
            title: "The Long-Form vs Short Debate",
            context: "You're writing a landing page for a $2,000/month B2B SaaS. Current page is short: headline, 3 benefits, testimonial, CTA. Bounce rate is 68%. Time on page is 45 seconds. Sales says most demo requests come from people who've done extensive research elsewhere. The product solves a complex problem (compliance automation for financial services).",
            question: "What's wrong with the short landing page approach?",
            opts: [
               "A) Nothing‚Äîshort pages convert better; the traffic quality is the problem",
               "B) Complex, high-cost purchases need more information to convert on-page",
               "C) Add more testimonials‚Äîsocial proof is the missing element",
               "D) The page is fine; invest in better retargeting"
            ],
            correct: 1,
            wrongExplanations: [
               "'Short pages convert better' is a myth. It depends on price point and complexity. For a $24K/year commitment, 45 seconds isn't consideration‚Äîit's drive-by. People aren't 'not interested'; they don't have enough information.",
               "",
               "More testimonials help but don't solve the core issue: 45 seconds isn't enough time to understand a complex compliance solution. You need more content for testimonials to reinforce.",
               "Retargeting people who bounced because they didn't understand the product means showing them the same confusing page again. Fix the page first."
            ],
            realWorld: "Crazy Egg tested a page 20x longer than their original and conversion increased 363%. For high-consideration B2B, long-form works because buyers need to justify the purchase. Gong, Drift, and other B2B leaders use extensive landing pages with deep content. The myth that 'nobody reads' doesn't apply when $24K is on the line.",
            concept: "consideration_match",
            why: "Page length should match purchase consideration. $10 impulse buy? Short page. $24K/year business commitment? Buyers need objection handling, use cases, proof points, and detailed explanations. 68% bounce + 45 seconds = people aren't finding what they need to make a decision. Give them the information on-page instead of forcing them to research elsewhere."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         benefit_focus: "Benefit-First Headlines",
         curiosity_gap: "Curiosity Gap Technique",
         authentic_proof: "Authentic Social Proof",
         action_alignment: "CTA Action Alignment",
         consideration_match: "Content-Consideration Match"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         headlines: { title: "Headline Psychology", content: "Headlines have one job: make the reader want to read the next line. Specificity beats cleverness. Benefits beat features. Outcomes beat processes. The best headlines mirror the reader's internal dialogue‚Äîwhat they're already thinking about." },
         proof: { title: "Social Proof Hierarchy", content: "In order of power: Case studies with numbers > Specific testimonials > Customer logos > User counts > Star ratings. Use proof proportional to your stage. Fake enterprise positioning hurts more than no positioning." },
         ctas: { title: "CTA Psychology", content: "CTAs should describe what the user wants, not what you want. 'See your results' beats 'Sign up.' Reduce perceived commitment for high-friction actions. Match the action verb to the actual experience." },
         length: { title: "Content Length", content: "Length should match purchase consideration. Low-cost impulse: short. High-cost considered: long. If visitors research elsewhere, that content should be on YOUR page. The myth that 'nobody reads' is only true for content not worth reading." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Strong copy instincts`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-6">
               <div className="text-6xl mb-4">‚úçÔ∏è</div>
               <h2 className="text-2xl font-bold mb-2">Conversion Copy Lab</h2>
               <p className="text-amber-300 text-center mb-4 max-w-md">
                  Master the psychology behind copy that converts‚Äîfrom headlines to CTAs to landing pages.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll analyze scenarios involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Feature-focused vs benefit-focused headlines</li>
                     <li>‚Ä¢ Email subject lines and the curiosity gap</li>
                     <li>‚Ä¢ Social proof at different company stages</li>
                     <li>‚Ä¢ CTA psychology and action alignment</li>
                     <li>‚Ä¢ Long-form vs short-form for different prices</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold text-black">
                  Start Writing
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üèÜ' : grade === 'B' ? '‚úçÔ∏è' : grade === 'C' ? 'üìù' : 'üìö'}</div>
               <h2 className="text-xl font-bold mb-2">Copywriting Assessment</h2>
               <div className="text-3xl font-bold text-amber-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Master copywriter! You understand the psychology behind conversion.' :
                   grade === 'B' ? 'Strong copy instincts‚Äîyou see through common traps.' :
                   grade === 'C' ? 'Some conventional mistakes‚Äîfocus on outcomes over features.' :
                   'Review copywriting fundamentals‚Äîfeature-focus is hurting your conversions.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Copy Skills to Develop:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-amber-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-amber-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-amber-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-amber-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">‚úçÔ∏è {sc.title}</span>
               <span className="text-amber-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-orange-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-amber-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-amber-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Why This Works:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why That Fails:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-amber-900/30 border border-amber-500/30 rounded-lg p-3">
                        <p className="text-xs text-amber-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-amber-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-amber-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-amber-400 hover:text-amber-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // ============================================
   // ENTREPRENEURSHIP: FINANCIAL LITERACY (10)
   // ============================================

   // 41. BOOTSTRAPPING - Resource Management Simulator
   const BootstrappingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "Revenue Before Features",
            context: "Your SaaS MVP has 50 users paying $29/month ($1,450 MRR). Users request: 1) API integration ($15K dev cost), 2) mobile app ($25K), 3) white-labeling ($8K). You have $12K runway. Your churn is 8% monthly.",
            question: "How should you prioritize development to bootstrap sustainably?",
            opts: [
               "A) Build the mobile app - it's what most users want",
               "B) Build white-labeling - it can command premium pricing from enterprise",
               "C) Build nothing new - focus on reducing churn first",
               "D) Build API integration - it enables partner revenue sharing"
            ],
            correct: 2,
            wrongExplanations: [
               "Mobile apps are expensive and don't address your core problem: 8% churn means you lose half your customers in 8 months. Building more features won't help if customers leave.",
               "White-labeling sounds profitable but requires enterprise sales cycles (3-6 months). With $12K runway and 8% churn, you'll run out of money before closing deals.",
               "",
               "API integration can generate revenue but 8% monthly churn is catastrophic. At $1,450 MRR with 8% churn, you need $116 new MRR monthly just to stay flat."
            ],
            realWorld: "Basecamp (37signals) maintained profitability by obsessing over customer retention before adding features. They've been profitable since 2004 with no VC funding. Contrast with feature-heavy startups that burned through cash.",
            concept: "churn_economics",
            why: "At 8% monthly churn, you lose half your customer base in 8 months. No feature development matters if your bucket has holes. Reducing churn from 8% to 4% effectively doubles customer lifetime value. Bootstrapped companies must prioritize retention over acquisition because CAC payback periods must be short."
         },
         {
            title: "The Consulting Trap",
            context: "Your dev tool generates $3K/month in product revenue. A big client offers $15K/month for custom development work. It would consume 80% of your time but triple your income. Your product is growing 12% monthly.",
            question: "What's the optimal bootstrapping decision?",
            opts: [
               "A) Take the contract - you need the money to fund product development",
               "B) Decline and focus 100% on product growth",
               "C) Accept but hire a contractor to do the work for $8K/month",
               "D) Negotiate a smaller engagement at $6K/month for 30% of time"
            ],
            correct: 3,
            wrongExplanations: [
               "This is the classic consulting trap. At 80% time consumption, your 12% monthly product growth stalls. In 12 months, your product could be at $12K MRR but instead you're dependent on one client.",
               "Noble but risky. $3K/month doesn't provide enough runway cushion. One bad month and you're in trouble. Bootstrapping requires prudent cash management, not all-or-nothing bets.",
               "The math doesn't work: $15K - $8K = $7K profit, but you still need to manage the contractor (20% of your time). You're trading product growth for $7K/month in profit."
            ],
            realWorld: "ConvertKit's Nathan Barry kept a $250K/year consulting business while building ConvertKit. He gradually reduced consulting as product revenue grew, hitting $1M ARR in 2.5 years. Full product focus came only after product revenue exceeded consulting.",
            concept: "revenue_diversification",
            why: "The 30% time / $6K revenue deal preserves 70% for product development while adding 200% to monthly revenue. This extends runway without killing growth. At 12% monthly growth, your product reaches $12K MRR in 12 months while you've banked $72K from consulting. Best of both worlds."
         },
         {
            title: "Customer Acquisition Efficiency",
            context: "You're spending $500/month on Google Ads (10 customers, $50 CAC) and $200/month on content marketing (2 customers, $100 CAC). Customer LTV is $300. Organic traffic is growing 20% monthly from content. You have $6K marketing budget.",
            question: "How should you allocate your $6K budget for maximum bootstrapped growth?",
            opts: [
               "A) Put it all in Google Ads - $50 CAC vs $300 LTV is 6x return",
               "B) Split 80% ads, 20% content to maintain organic growth",
               "C) Put it all in content - 20% monthly organic growth will compound",
               "D) Put 60% in content, 40% in ads for balanced short and long-term"
            ],
            correct: 3,
            wrongExplanations: [
               "Google Ads provides immediate customers but no compounding. When you stop spending, growth stops. Bootstrapped businesses need assets that compound, not just transactions.",
               "Better than all-ads but still underweights the compounding asset. Content at 20% monthly growth doubles every 4 months. This ratio misses the asymmetric opportunity.",
               "All-content is too risky. Content takes 6-12 months to compound meaningfully. With $6K budget and $500/month product revenue, you may not survive to see the payoff."
            ],
            realWorld: "Ahrefs bootstrapped to $100M ARR spending 80% of marketing budget on content. Their blog generates 500K+ organic visits monthly - an asset that compounds. But they balanced with targeted paid acquisition to maintain cash flow while content matured.",
            concept: "compounding_assets",
            why: "60% content ($3,600) accelerates the 20% monthly compounding - in 12 months you'll have 8x the organic traffic generating 16+ customers/month for $0 marginal cost. The 40% in ads ($2,400 = 48 customers) maintains cash flow. Total: immediate customers + an asset that scales to $0 CAC."
         },
         {
            title: "The Pricing Paradox",
            context: "Your B2B tool is priced at $49/month with 200 customers ($9,800 MRR). Competitors charge $200-400/month. Support load is crushing you - 200 customers generate 300+ tickets monthly. Your NPS is 45.",
            question: "What pricing strategy optimizes for bootstrapped sustainability?",
            opts: [
               "A) Raise prices to $149/month and accept that many will churn",
               "B) Keep prices but hire part-time support at $2K/month",
               "C) Raise to $99/month as middle ground to minimize churn",
               "D) Grandfather existing users and price new customers at $199/month"
            ],
            correct: 0,
            wrongExplanations: [
               "",
               "Hiring doesn't solve the root problem. Low-price customers have high support expectations but low stakes. You'll need to keep hiring as you grow. This creates a support cost treadmill.",
               "Middle-ground pricing pleases no one. You still attract price-sensitive customers who create support load, but you're not premium enough to attract low-maintenance enterprise buyers.",
               "Two-tier pricing creates resentment and operational complexity. Grandfathered users at $49 will still generate 1.5 tickets each while new customers at $199 subsidize them. This is a hidden tax on growth."
            ],
            realWorld: "Basecamp raised prices from $24/month to $99/month. They lost 30% of customers but increased revenue and dramatically reduced support load. Price-sensitive customers are often the most demanding. Higher prices attract serious buyers who value their time over money.",
            concept: "price_customer_fit",
            why: "At $49/month, customers don't value the product enough to figure things out themselves - their time isn't worth much to them. At $149/month, you attract customers whose time is worth $100+/hour. They self-serve more, generate fewer tickets, and churn less. Even losing 50% of customers at 3x price = 50% revenue increase with 75% fewer support tickets."
         },
         {
            title: "The Growth Inflection",
            context: "After 18 months bootstrapping, you hit $25K MRR with 15% margins ($3,750/month profit). A VC offers $2M at $10M valuation. Competitors just raised $50M and are hiring aggressively. Your growth rate is 8% monthly.",
            question: "What's the strategic bootstrapping decision?",
            opts: [
               "A) Take the funding - you need it to compete against well-funded rivals",
               "B) Decline and continue bootstrapping at 8% growth",
               "C) Decline and invest all profits into accelerating growth",
               "D) Counter-offer: take $500K as convertible note to extend runway"
            ],
            correct: 1,
            wrongExplanations: [
               "VC money comes with growth expectations (3-5x annual). Your 8% monthly = 150% annual, impressive but VCs will push for faster growth via spending. This often destroys the capital efficiency that made you successful.",
               "",
               "Investing all profits risks everything on growth acceleration. If CAC rises or conversion drops, you have no cushion. Bootstrapped companies survive by maintaining margins, not by burning them.",
               "Convertible notes delay but don't solve the problem. You'll still have investors expecting VC-style returns. The note converts at next round, pressuring you to raise more. This is venture-lite, not bootstrapping."
            ],
            realWorld: "Mailchimp declined multiple VC offers and bootstrapped to $700M revenue before a $12B acquisition. Competitors like Constant Contact who raised VC sold for much less. Mailchimp's founders retained control and captured $12B vs. diluted cap tables at competitors.",
            concept: "capital_efficiency",
            why: "At 8% monthly growth, you'll hit $75K MRR in 12 months and $225K MRR in 24 months - all while maintaining profitability. The $50M-funded competitor will spend $3-4M annually and might capture market share, but they'll need $500K+ MRR just to break even. Your 15% margins vs. their -300% margins means you survive any market downturn. Time arbitrage beats capital in most markets."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'churn_economics': 'Churn Economics',
         'revenue_diversification': 'Revenue Diversification',
         'compounding_assets': 'Compounding Assets',
         'price_customer_fit': 'Price-Customer Fit',
         'capital_efficiency': 'Capital Efficiency'
      };

      const infoTopics: Record<string, string> = {
         'churn': 'Monthly churn rate shows what percentage of customers leave each month. 5% monthly = 46% annual churn. Reducing churn by 1% can increase LTV by 20%+.',
         'runway': 'Runway = Cash / Monthly Burn Rate. Bootstrapped companies target 12+ months runway. Below 6 months is danger zone requiring immediate action.',
         'cac_ltv': 'Customer Acquisition Cost vs. Lifetime Value. Bootstrapped companies need CAC payback in 3-6 months. VC-backed can wait 12-18 months. 3:1 LTV:CAC minimum.',
         'compounding': 'Bootstrapping favors assets that compound: content, SEO, partnerships. These require upfront investment but generate returns indefinitely at $0 marginal cost.',
         'margins': 'Gross margin = Revenue - Cost of Goods Sold. Bootstrapped SaaS needs 70%+ margins. Services businesses at 30-50%. Margins fund growth without external capital.'
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Bootstrap Master', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Sustainable Founder', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Capital Dependent', color: 'text-yellow-400' };
         return { grade: 'D', label: 'VC Required', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">ü•æ Bootstrapping Strategy</p>
                  <p className="mb-2">Building a business with minimal external funding requires mastering:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace('_', ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-green-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">ü•æ</p>
            <h2 className="text-3xl font-bold mb-4">Bootstrap Survival Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the art of building profitable businesses without external funding.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 strategic scenarios based on real bootstrapped companies like Mailchimp ($12B exit), Basecamp (25+ years profitable), and ConvertKit ($33M ARR).</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-green-500 rounded-2xl font-bold text-xl hover:bg-green-400 transition-all">START SURVIVAL LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} decisions mastered</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Decision Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concept Gaps to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-green-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üéØ Bootstrap Principles</p>
                  <p className="text-sm">‚Ä¢ Revenue before features - cash flow trumps roadmaps</p>
                  <p className="text-sm">‚Ä¢ Churn kills - fix retention before acquisition</p>
                  <p className="text-sm">‚Ä¢ Build compounding assets - content, SEO, referrals</p>
                  <p className="text-sm">‚Ä¢ Premium pricing attracts better customers</p>
                  <p className="text-sm">‚Ä¢ Time arbitrage beats capital in most markets</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-green-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Decision {scenario + 1}/5</span>
               <span className="bg-green-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-green-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-green-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why your choice fails:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">Why it works:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-blue-500/20 rounded-xl p-3">
                     <p className="font-bold text-blue-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-green-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT DECISION ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 42. CASH FLOW - Cash Flow Tracker
   const CashFlowRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Profitable Bankruptcy",
            context: "Your e-commerce business shows $150K profit on paper this quarter. But you're $80K behind on vendor payments with $12K in the bank. A major retailer just placed a $200K order (50% upfront, 50% on delivery in 60 days). Your vendor requires prepayment for the $120K in inventory needed.",
            question: "What's your most viable cash flow solution?",
            opts: [
               "A) Take the order - the $100K upfront covers most of inventory costs",
               "B) Negotiate with the vendor for Net-30 payment terms",
               "C) Decline the order - you can't finance it",
               "D) Factor your $80K in existing receivables at 5% to bridge the gap"
            ],
            correct: 3,
            wrongExplanations: [
               "The math doesn't work: $100K upfront - $120K inventory = -$20K. Plus you're already $80K behind on vendor payments. You'd need $200K cash but only have $112K coming in.",
               "Vendors rarely give Net-30 to customers who already owe them $80K. Your negotiating position is weak. Even if successful, you still need $20K more than you have.",
               "Declining preserves your current situation but doesn't solve the underlying cash flow crisis. You're still $80K behind with only $12K in the bank."
            ],
            realWorld: "Toys 'R' Us was profitable on paper but filed bankruptcy with $5B in debt because cash couldn't keep up with obligations. Meanwhile, Amazon operated at losses for years but had positive cash flow through customer prepayments and fast inventory turns.",
            concept: "cash_vs_profit",
            why: "Factoring $80K receivables at 5% ($4K cost) gives you $76K immediately. Add $100K order deposit = $176K. Pay $80K to vendor (clearing debt) + $120K new inventory = $200K. You're $24K short but now have a clean vendor relationship to negotiate. Revenue timing kills more businesses than lack of profit."
         },
         {
            title: "The Growth Trap",
            context: "Your SaaS is growing 20% monthly. Current: $50K MRR, $30K monthly burn (CAC heavy). You have $200K in the bank. A new enterprise client wants to prepay $500K annually, but requires 6 months of custom development ($180K cost) before launch.",
            question: "What's the cash flow implication of this deal?",
            opts: [
               "A) Take it - $500K upfront more than covers $180K development cost",
               "B) Accept but negotiate milestone payments aligned with development",
               "C) Pass - it'll slow your growth trajectory",
               "D) Accept only if they pay the full $500K before development starts"
            ],
            correct: 1,
            wrongExplanations: [
               "$500K is recognized as REVENUE over 12 months ($42K/month), but you need $180K CASH upfront for development. Enterprise contracts typically pay Net-30 after contract signing. Your $200K runway disappears while waiting.",
               "",
               "Passing on $500K ARR because of cash timing is financially naive. The deal is good - the structure needs work. Don't throw out the baby with the bathwater.",
               "Demanding full prepayment is unrealistic for enterprise. You'll lose the deal entirely. Enterprise clients don't prepay fully for unbuilt products."
            ],
            realWorld: "WeWork's collapse was partly because they signed long-term lease obligations (cash out) funded by member revenue that could churn (uncertain cash in). Mismatch between outflow certainty and inflow uncertainty created the crisis.",
            concept: "cash_timing",
            why: "Milestone-based payments align cash IN with cash OUT. Structure: $100K on signing (covers initial dev), $100K at 3-month milestone, $100K at 6-month launch, then $200K over remaining 6 months. Your development cost of $180K is covered by first two payments. No runway drain."
         },
         {
            title: "Inventory Cash Trap",
            context: "Your product business has 90-day inventory (purchased at $300K), 45-day receivables ($150K outstanding), and 30-day payables ($75K owed). Sales are $100K/month with 50% gross margin. A supplier offers 15% discount for ordering 6-month inventory upfront.",
            question: "Should you take the bulk discount?",
            opts: [
               "A) Yes - 15% savings on $600K order = $90K saved",
               "B) No - you can't afford to tie up that much cash",
               "C) Negotiate for 3-month inventory with 10% discount",
               "D) Yes, if you finance it with a credit line"
            ],
            correct: 2,
            wrongExplanations: [
               "The $90K savings ignores opportunity cost and risk. You're tying up $600K for 6 months. If demand drops 20%, you have $120K of dead inventory. The savings become a loss.",
               "This answer is directionally right but fails to capture the middle-ground opportunity. Some bulk benefit is achievable without the full risk.",
               "",
               "Credit lines aren't free. At 8% APR, 6 months of financing $600K costs $24K. Plus carrying cost, insurance, storage. Net savings drop to maybe $50K while taking all the demand risk."
            ],
            realWorld: "Circuit City bought massive inventory before holiday season 2008. When demand crashed, they had $1B in unsellable TVs. Best Buy, with leaner inventory, survived. Circuit City liquidated. Inventory is cash sitting on shelves depreciating.",
            concept: "working_capital",
            why: "Cash Conversion Cycle = Inventory Days + Receivables Days - Payables Days = 90 + 45 - 30 = 105 days. Every day of inventory is cash trapped. 3-month order with 10% discount saves $30K, only traps cash for 90 extra days vs. 180. You preserve flexibility while capturing 1/3 of the savings at half the risk."
         },
         {
            title: "The Seasonality Crunch",
            context: "Your business does 60% of annual revenue in Q4 ($1.2M). Other quarters average $200K each ($600K total). Monthly fixed costs are $80K. You end Q4 with $400K cash. It's January 1st.",
            question: "How should you manage cash through the slow quarters?",
            opts: [
               "A) Cut fixed costs by 30% in Q1-Q3, restore in Q4",
               "B) Establish a $300K credit line before you need it",
               "C) Reduce Q1-Q3 costs and maintain $200K cash reserve",
               "D) Invest Q4 profits in growth for next Q4"
            ],
            correct: 1,
            wrongExplanations: [
               "Cutting costs 30% ($24K/month) sounds prudent but you're cutting bone, not fat. Laying off staff in January and rehiring in September destroys institutional knowledge and morale.",
               "",
               "A $200K reserve is only 2.5 months of burn. Q1-Q3 is 9 months. Even with reduced revenue, you'll run out. This is false security.",
               "Investing profits when you have 9 lean months ahead is reckless. Growth investments should come from predictable cash flow, not last year's windfall."
            ],
            realWorld: "Retail businesses like Macy's maintain credit facilities specifically for seasonal inventory purchases. They draw in Q3, buy inventory, sell in Q4, repay in January. The cost of credit is built into Q4 margins.",
            concept: "seasonal_management",
            why: "Q1-Q3 math: 9 months √ó $80K costs = $720K. Revenue: $600K. Gap: -$120K. You have $400K starting cash but want to enter Q4 with reserves for inventory. A $300K credit line (drawn as needed, ~$150K average balance, ~$9K annual cost) provides runway without draining reserves. Draw in slow months, repay from Q4 windfall."
         },
         {
            title: "The Subscription Timing",
            context: "Your SaaS offers monthly ($99/mo) and annual plans ($999/yr - 16% discount). Currently: 1,000 monthly subscribers = $99K MRR. You're spending $150K/month (50% on growth). Runway: 4 months.",
            question: "What pricing strategy optimizes cash flow survival?",
            opts: [
               "A) Push annual aggressively - each conversion brings forward 11 months of cash",
               "B) Raise monthly price to $129 to extend runway",
               "C) Cut spending to $80K/month and extend runway to 12+ months",
               "D) Offer 25% annual discount to drive faster conversion"
            ],
            correct: 0,
            wrongExplanations: [
               "",
               "Price increases take time to impact (new customers only) and may increase churn. With 4 months runway, you don't have time for gradual impact. This doesn't solve the immediate crisis.",
               "Cutting from $150K to $80K means eliminating growth spending. But you're not profitable at current scale. You'd be slowly dying instead of quickly dying. Neither is good.",
               "A 25% discount ($749/yr = $62/mo) is worse than monthly pricing. You're trading cash now for less total revenue. This extends runway but damages unit economics permanently."
            ],
            realWorld: "ClassPass survived a 2020 crisis by converting monthly members to discounted credits packages. They traded future revenue for immediate cash. Annual prepay gave them runway to pivot to hybrid model. They're now valued at $1B+.",
            concept: "prepayment_strategy",
            why: "Converting 200 monthly users to annual at current pricing: 200 √ó $999 = $199.8K cash infusion. You 'lose' $99 √ó 200 √ó 11 months = $218K in future monthly payments but you GET $200K NOW. With 4 months runway, future revenue is worthless if you don't survive. The 16% annual discount costs $190/customer/year - cheap compared to death."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'cash_vs_profit': 'Cash vs. Profit',
         'cash_timing': 'Cash Timing',
         'working_capital': 'Working Capital',
         'seasonal_management': 'Seasonal Cash Management',
         'prepayment_strategy': 'Prepayment Strategy'
      };

      const infoTopics: Record<string, string> = {
         'operating': 'Operating cash flow = Net income + Non-cash expenses (depreciation) +/- Changes in working capital. Positive operating cash flow means the core business generates cash.',
         'investing': 'Investing cash flow = Cash spent on long-term assets (equipment, acquisitions) minus sales of assets. Usually negative for growing companies.',
         'financing': 'Financing cash flow = Cash from debt, equity issuance, or dividends. Positive when raising capital, negative when repaying debt or distributing profits.',
         'runway': 'Runway = Cash Balance / Monthly Burn Rate. Below 6 months requires immediate action. 12+ months provides safety for strategic decisions.',
         'conversion': 'Cash Conversion Cycle = Days Inventory + Days Receivables - Days Payables. Lower is better. Negative CCC (like Amazon) means customers pay before you pay suppliers.'
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Cash Flow Master', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Financially Literate', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Cash Blind Spots', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Bankruptcy Risk', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">üíµ Cash Flow Management</p>
                  <p className="mb-2">Cash is oxygen. Profit is a concept - cash is survival:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-blue-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">üíµ</p>
            <h2 className="text-3xl font-bold mb-4">Cash Flow Crisis Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the art of managing cash - the lifeblood of every business.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios based on real cash crises at Toys 'R' Us, WeWork, Circuit City, and others. Learn why profitable companies go bankrupt.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-blue-500 rounded-2xl font-bold text-xl hover:bg-blue-400 transition-all">START CASH CRISIS ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} crises resolved</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Crisis Response Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-blue-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üéØ Cash Flow Principles</p>
                  <p className="text-sm">‚Ä¢ Cash ‚â† Profit - you can be profitable and bankrupt</p>
                  <p className="text-sm">‚Ä¢ Timing matters - revenue recognized ‚â† cash received</p>
                  <p className="text-sm">‚Ä¢ Working capital traps cash in inventory/receivables</p>
                  <p className="text-sm">‚Ä¢ Seasonal businesses need credit facilities</p>
                  <p className="text-sm">‚Ä¢ Prepayments solve runway, annual plans accelerate cash</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-blue-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-violet-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Crisis {scenario + 1}/5</span>
               <span className="bg-blue-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} resolved</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-blue-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-blue-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that fails:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The cash flow solution:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-blue-500/20 rounded-xl p-3">
                     <p className="font-bold text-blue-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-blue-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT CRISIS ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 43. PROFIT & LOSS - P&L Statement Builder
   const ProfitLossRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Margin Mirage",
            context: "Two restaurants each report $1M annual revenue. Restaurant A: 28% gross margin, 8% net margin. Restaurant B: 65% gross margin, 4% net margin. Restaurant B has higher gross margins but lower net profit.",
            question: "What's the most likely cause of Restaurant B's margin compression?",
            opts: [
               "A) Restaurant B has more expensive ingredients (higher COGS)",
               "B) Restaurant B has excessive overhead (rent, labor, marketing)",
               "C) Restaurant B prices too low relative to costs",
               "D) Restaurant B has tax inefficiencies"
            ],
            correct: 1,
            wrongExplanations: [
               "Higher COGS would lower gross margin, not raise it. Restaurant B's 65% gross margin means COGS is only 35% of revenue - their food costs are actually lean.",
               "",
               "Low pricing would show up in gross margin. With 65% gross margin, pricing is fine. The problem is between gross and net.",
               "Tax expenses typically appear below the operating profit line. The gap between 65% gross and 4% net (61 points!) is too large to be explained by taxes alone."
            ],
            realWorld: "The Cheesecake Factory has famously high food costs (low gross margin) but maintains strong net margins through operational efficiency. Sweetgreen has excellent gross margins but burned cash for years due to high rent and labor in premium locations.",
            concept: "margin_analysis",
            why: "The 61-point drop from gross to net margin means operating expenses consume 61% of revenue. At $1M revenue, that's $610K in overhead vs. only $350K in food costs. Restaurant B is likely in an expensive location, overstaffed, or spending too much on marketing. The P&L structure reveals where money leaks."
         },
         {
            title: "Revenue Recognition Trap",
            context: "A SaaS company books a $120K annual contract in January. Their CFO records $120K as January revenue, showing their best month ever. Gross margin: 85%. Operating expenses: $80K/month. The CEO celebrates profitability.",
            question: "What's wrong with this P&L presentation?",
            opts: [
               "A) Nothing - they earned the contract, they can book the revenue",
               "B) Revenue should be recognized as $10K/month over 12 months (GAAP)",
               "C) The 85% gross margin is too high to be realistic",
               "D) Operating expenses should be capitalized, not expensed"
            ],
            correct: 1,
            wrongExplanations: [
               "GAAP and IFRS require revenue to be recognized as earned. Booking $120K in January overstates that month and understates the next 11 months. Investors and auditors will flag this.",
               "",
               "85% gross margin is normal for SaaS (low marginal cost of serving customers). The margin isn't the problem.",
               "Operating expenses for day-to-day operations should be expensed. Capitalizing regular opex would violate GAAP and inflate profits artificially."
            ],
            realWorld: "Under Armour inflated revenues by shipping products to retailers before they ordered them (channel stuffing). When restated, $400M+ in revenue shifted between periods. SEC investigated. Stock dropped 90% from peak.",
            concept: "revenue_recognition",
            why: "Proper P&L for January: Revenue $10K (1/12 of annual contract), COGS $1.5K, Gross Profit $8.5K, OpEx $80K, Net Loss -$71.5K. The company isn't profitable at all - they're losing $71.5K/month until they get more customers. Improper revenue recognition masks true economics."
         },
         {
            title: "The COGS Classification",
            context: "An e-commerce company sells $500K/month in products bought for $200K (60% gross margin). They pay $50K/month in shipping to customers. Their P&L shows shipping as operating expense, resulting in 60% gross margin and 35% operating margin.",
            question: "How should shipping be classified for accurate P&L analysis?",
            opts: [
               "A) Keep as operating expense - it's not directly tied to products",
               "B) Move to COGS - it's a direct cost of delivering each sale",
               "C) Capitalize it - shipping is an investment in customer satisfaction",
               "D) Split between COGS and operating expense"
            ],
            correct: 1,
            wrongExplanations: [
               "Shipping IS directly tied to products. Every order requires shipping. Classifying it as operating expense makes gross margin look artificially high.",
               "",
               "Shipping is consumed immediately when the product is delivered. It has no future value and cannot be capitalized under any accounting standard.",
               "Splitting would create arbitrary allocations. Shipping is directly variable with sales - every sale has a shipping cost. It belongs entirely in COGS."
            ],
            realWorld: "Amazon includes shipping in COGS, which is why their retail gross margins look thin (20-25%). Many e-commerce brands hide shipping in operating expenses to show 50%+ gross margins. Investors eventually discover the true unit economics.",
            concept: "cogs_classification",
            why: "Correctly restated: Revenue $500K, COGS $250K ($200K products + $50K shipping) = 50% gross margin, not 60%. This 10-point swing is massive. True gross margin reveals you make $250K per $500K sold, not $300K. Misclassification hides the real cost of each sale and inflates apparent profitability."
         },
         {
            title: "Operating Leverage Analysis",
            context: "Two software companies each have $10M revenue. Company A: $8M fixed costs, $1M variable costs, $1M profit. Company B: $2M fixed costs, $6M variable costs, $2M profit. Both are considering a 20% revenue increase.",
            question: "Which company benefits more from the revenue increase?",
            opts: [
               "A) Company B - they already have higher profits ($2M vs $1M)",
               "B) Company A - high fixed costs means profit grows faster with scale",
               "C) Equal benefit - both get 20% more revenue",
               "D) Company B - lower fixed costs means less risk"
            ],
            correct: 1,
            wrongExplanations: [
               "Current profitability doesn't determine future growth rate. The cost structure does. Company B's high variable costs will consume most of the revenue increase.",
               "",
               "Revenue increases equally, but profit increases differently. Variable costs scale with revenue; fixed costs don't. This creates operating leverage.",
               "Lower fixed costs indeed means less risk in a downturn, but the question asks about benefiting from growth, not surviving decline."
            ],
            realWorld: "Microsoft has 70%+ gross margins with high fixed R&D costs. When Cloud revenue grew, profits exploded because marginal cost of serving new customers is near zero. Consulting firms with variable labor costs see profit grow linearly with revenue.",
            concept: "operating_leverage",
            why: "Company A at $12M revenue: Fixed $8M + Variable $1.2M (scales 20%) = $9.2M costs ‚Üí $2.8M profit (180% increase). Company B at $12M revenue: Fixed $2M + Variable $7.2M = $9.2M costs ‚Üí $2.8M profit (40% increase). Same ending profit but Company A's profit nearly tripled while B's grew 40%. High fixed cost structures amplify growth."
         },
         {
            title: "The Profitability Illusion",
            context: "A hardware startup reports: Revenue $2M, COGS $1.4M (30% gross margin), OpEx $400K, Net Profit $200K (10% net margin). Investors celebrate profitability. But looking deeper: $800K of 'revenue' came from one-time patent licensing, and R&D was only $50K (1% of revenue).",
            question: "What should investors actually conclude about this P&L?",
            opts: [
               "A) The company is genuinely profitable with healthy margins",
               "B) Adjust for licensing: real product margins are negative with weak R&D",
               "C) The low R&D is smart - they're focused on execution, not innovation",
               "D) One-time revenue is fine - it's still cash in the bank"
            ],
            correct: 1,
            wrongExplanations: [
               "The profitability is an illusion. Remove one-time licensing and the picture changes completely. Investors need recurring economics, not one-off windfalls.",
               "",
               "1% R&D for a hardware company is catastrophically low. Industry average is 8-15%. Without R&D, there's no future product innovation. They're harvesting, not building.",
               "One-time revenue is cash, but it masks whether the core business is viable. Investors valuing this company on 'profit' will be shocked when licensing doesn't recur."
            ],
            realWorld: "GoPro's P&L looked profitable in 2015, but stripping out non-recurring gains and analyzing true product economics showed trouble. Stock fell from $86 to $5 as 'profitability' evaporated without one-time items.",
            concept: "earnings_quality",
            why: "Adjusted P&L: Revenue $1.2M (core product only), COGS $1.4M, Gross Loss -$200K. They're losing money on every product sold. The $800K licensing masked a failing core business. Plus, 1% R&D means no product roadmap. Quality of earnings analysis separates sustainable profit from accounting illusions."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'margin_analysis': 'Margin Structure Analysis',
         'revenue_recognition': 'Revenue Recognition',
         'cogs_classification': 'COGS Classification',
         'operating_leverage': 'Operating Leverage',
         'earnings_quality': 'Earnings Quality'
      };

      const infoTopics: Record<string, string> = {
         'gross_margin': 'Gross Margin = (Revenue - COGS) / Revenue. Measures production efficiency. High GM means strong pricing power or low unit costs. SaaS: 70-85%, Retail: 25-40%, Restaurants: 60-70%.',
         'operating_margin': 'Operating Margin = Operating Income / Revenue. Shows efficiency after all operating costs. Includes SG&A, R&D. Excludes interest and taxes. Healthy range: 10-25% for most industries.',
         'net_margin': 'Net Margin = Net Income / Revenue. Bottom line after everything including interest, taxes. What shareholders actually keep. Apple: 25%, Amazon: 3%, Airlines: 2-5%.',
         'contribution': 'Contribution Margin = (Revenue - Variable Costs) / Revenue. Shows how much each sale contributes to fixed costs and profit. Critical for break-even analysis.',
         'ebitda': 'EBITDA = Earnings Before Interest, Taxes, Depreciation, Amortization. Removes financing and accounting decisions. Useful for comparing companies with different capital structures.'
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'P&L Expert', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Financially Literate', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'P&L Blind Spots', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Easily Fooled', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">üìä P&L Mastery</p>
                  <p className="mb-2">Learn to read between the lines of profit statements:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-amber-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">üìä</p>
            <h2 className="text-3xl font-bold mb-4">P&L Analysis Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the art of reading profit and loss statements - the story behind the numbers.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios exposing P&L manipulation, misclassification, and analysis traps. Based on real cases from GoPro, Under Armour, and others.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-amber-500 rounded-2xl font-bold text-xl hover:bg-amber-400 transition-all text-black">START P&L LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} analyses correct</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Analysis Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-amber-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2 text-black">üéØ P&L Principles</p>
                  <p className="text-sm">‚Ä¢ Gross margin reveals pricing power and unit economics</p>
                  <p className="text-sm">‚Ä¢ Gap between gross and net exposes overhead problems</p>
                  <p className="text-sm">‚Ä¢ Revenue recognition timing can mask or create profits</p>
                  <p className="text-sm">‚Ä¢ COGS classification changes the story entirely</p>
                  <p className="text-sm">‚Ä¢ One-time items hide true recurring economics</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-amber-500 rounded-xl font-bold text-black">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-amber-900 via-yellow-900 to-orange-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Analysis {scenario + 1}/5</span>
               <span className="bg-amber-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-amber-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-amber-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that's wrong:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The real analysis:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-amber-500/20 rounded-xl p-3">
                     <p className="font-bold text-amber-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-amber-500 rounded-xl font-bold text-black">
                     {scenario < scenarios.length - 1 ? 'NEXT ANALYSIS ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 44. BREAK EVEN - Break-Even Calculator
   const BreakEvenRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Hidden Cost Trap",
            context: "A coffee shop charges $5/cup with $1.50 in direct costs (beans, cup, lid). Monthly rent: $8,000. They calculate break-even at 2,286 cups/month. After 3 months selling 3,000 cups/month, they're still losing money.",
            question: "What break-even error did they make?",
            opts: [
               "A) They forgot to include labor costs in variable costs",
               "B) They underpriced their coffee",
               "C) They forgot semi-variable costs (utilities, supplies, waste)",
               "D) Their rent is too high for the location"
            ],
            correct: 2,
            wrongExplanations: [
               "Labor is often treated as a fixed cost for break-even (salaried baristas work regardless of cups sold). It should be in fixed costs, not variable, for this calculation.",
               "At $5/cup with $1.50 variable cost, the contribution margin is $3.50. Pricing seems reasonable for coffee. The price isn't the problem.",
               "",
               "Rent being 'too high' doesn't explain the calculation error. High rent just means you need to sell more, which their calculation should have shown."
            ],
            realWorld: "Many restaurants fail in year one because break-even analysis only includes COGS and rent. They forget: credit card fees (2-3% of revenue), food waste (5-10% of inventory), cleaning supplies, POS fees, uniforms, and marketing. True variable costs are often 40-60% higher than naive estimates.",
            concept: "hidden_costs",
            why: "Real variable costs per cup: $1.50 beans/cup + $0.30 credit card fee (6% of $5) + $0.20 waste/spillage + $0.15 supplies = $2.15/cup. True contribution margin: $5 - $2.15 = $2.85 (not $3.50). Real break-even: $8,000 / $2.85 = 2,807 cups. They're 200 cups short every month."
         },
         {
            title: "The Volume Illusion",
            context: "A startup sells SaaS at $99/month with $19 marginal cost (hosting, support). Fixed costs: $50K/month. Break-even: 625 customers. Currently at 400 customers, they offer a 50% discount to accelerate growth.",
            question: "What's the impact on break-even?",
            opts: [
               "A) Break-even stays at 625 - they're just getting there faster with discounts",
               "B) Break-even increases to 1,667 customers - the discount destroys unit economics",
               "C) Break-even decreases - volume growth compounds customer lifetime value",
               "D) Break-even increases slightly to ~750 customers"
            ],
            correct: 1,
            wrongExplanations: [
               "Discounts change the contribution margin per customer. Fewer dollars per customer = more customers needed. Break-even absolutely changes.",
               "",
               "Discounting reduces LTV, it doesn't increase it. Customers acquired at 50% off have 50% less revenue potential. Volume doesn't compensate for halved margins.",
               "The math is more severe than 'slightly.' Halving price while keeping costs constant dramatically increases break-even."
            ],
            realWorld: "Groupon merchants learned this painfully. A restaurant at 50% off with 50% Groupon commission nets 25% of regular price. If food cost is 30%, they're LOSING money on every Groupon customer. Many went bankrupt chasing 'volume.'",
            concept: "margin_sensitivity",
            why: "At 50% discount: New price $49.50, Variable cost still $19, New contribution margin: $30.50 (was $80). New break-even: $50,000 / $30.50 = 1,639 customers. They went from needing 225 more customers to needing 1,239 more. The discount made profitability 5.5x harder to achieve."
         },
         {
            title: "Fixed Cost Leverage",
            context: "Two SaaS companies. Company A: $200K fixed costs, 70% gross margin. Company B: $80K fixed costs, 30% gross margin. Both want to hit $100K monthly profit.",
            question: "Which company reaches profitability faster from zero revenue?",
            opts: [
               "A) Company A - higher margins mean each dollar of revenue is more valuable",
               "B) Company B - lower fixed costs mean faster break-even",
               "C) Equal - different paths to same destination",
               "D) Depends entirely on their customer acquisition costs"
            ],
            correct: 1,
            wrongExplanations: [
               "Higher margins are great AFTER break-even. But Company A needs $286K in revenue just to break even ($200K / 70%), while Company B needs only $267K ($80K / 30%). Time to profitability includes time to break-even.",
               "",
               "The paths are quantifiably different. Lower fixed costs mean reaching cash-flow positive sooner, which provides runway to reach the $100K profit target.",
               "CAC matters for growth rate, but the question is about which business model reaches profitability faster. Structure determines trajectory."
            ],
            realWorld: "Amazon operated with razor-thin margins (low gross margin) but dominated because low fixed costs per transaction meant they broke even at modest volumes. High-margin luxury retailers with high fixed costs (fancy stores, lots of staff) couldn't compete on time-to-profitability.",
            concept: "fixed_cost_leverage",
            why: "Company A break-even: $200K / 0.70 = $286K revenue. To add $100K profit: ($200K + $100K) / 0.70 = $429K needed. Company B break-even: $80K / 0.30 = $267K revenue. To add $100K profit: ($80K + $100K) / 0.30 = $600K needed. B reaches break-even first ($267K vs $286K), but A reaches $100K profit target first at lower revenue ($429K vs $600K). Early-stage B wins; scale-stage A wins."
         },
         {
            title: "The Multi-Product Puzzle",
            context: "A bakery sells: Croissants ($4, $1 cost, 60% of sales), Bread loaves ($6, $2 cost, 30%), Cakes ($30, $12 cost, 10%). Monthly fixed costs: $12,000. They calculate break-even using average contribution margin.",
            question: "What's the flaw in averaging contribution margins for break-even?",
            opts: [
               "A) Nothing - weighted average contribution margin is the correct approach",
               "B) They should only calculate break-even for the highest-margin product",
               "C) Product mix changes with volume, invalidating the average",
               "D) Cakes should be excluded because they're specialty items"
            ],
            correct: 2,
            wrongExplanations: [
               "Weighted average is a snapshot of CURRENT mix. But mix changes! When you discount, when seasons change, when you push one product, the average contribution margin shifts. Break-even calculated on a frozen mix is unreliable.",
               "Focusing only on highest-margin ignores that you need all products for customer traffic and basket size. It's not realistic to sell only cakes.",
               "",
               "Excluding any product gives an incomplete picture. Cakes might be 10% of volume but 30% of profit."
            ],
            realWorld: "Fast food chains constantly adjust menu mix to hit profit targets. McDonald's knows exactly what happens to break-even when customers shift from burgers (high margin) to McCaf√© (lower margin). They engineer the menu to protect contribution margin.",
            concept: "product_mix",
            why: "Current weighted CM: (60% √ó $3) + (30% √ó $4) + (10% √ó $18) = $1.80 + $1.20 + $1.80 = $4.80 average. Break-even: 2,500 units ($12K/$4.80). But if croissant sales drop to 40% and bread rises to 50%: (40% √ó $3) + (50% √ó $4) + (10% √ó $18) = $5.00 average. New break-even: 2,400 units. Small mix shifts move break-even by 100+ units. The 'break-even' is a moving target."
         },
         {
            title: "Time-to-Break-Even",
            context: "Two business plans for the same market. Plan A: $500K investment, $100K monthly fixed costs, 60% gross margin, reaches break-even at $167K MRR. Plan B: $200K investment, $60K monthly fixed costs, 40% gross margin, reaches break-even at $150K MRR.",
            question: "An investor focused on return on capital should prefer which plan?",
            opts: [
               "A) Plan A - higher gross margin means better long-term economics",
               "B) Plan B - lower investment with faster break-even preserves capital",
               "C) Plan A - the higher fixed costs can be leveraged for growth",
               "D) Need to know customer acquisition cost before deciding"
            ],
            correct: 1,
            wrongExplanations: [
               "Higher gross margin matters for mature, scaled businesses. For a new venture, survival to break-even is priority #1. You can't enjoy great margins if you run out of money first.",
               "",
               "High fixed costs are 'leverage' only if you survive to use them. With more capital at risk and longer time to break-even, Plan A has higher failure probability.",
               "CAC is important but the fundamental business model comparison can be made without it. Both plans face the same market; what differs is capital efficiency."
            ],
            realWorld: "Venture capitalists often prefer 'capital efficient' startups - those that reach profitability with less investment. Basecamp raised $0 and reached profitability quickly. Many VC-backed competitors with 'better' unit economics burned more and failed. Cash runway matters more than theoretical margins.",
            concept: "capital_efficiency",
            why: "Plan A: $500K invested, $100K/mo burn until $167K MRR. If it takes 12 months to reach $167K MRR, you've burned $1.2M before break-even (12 √ó $100K). Total capital needed: $500K + $1.2M = $1.7M. Plan B: $200K invested, $60K/mo burn until $150K MRR. Same 12 months: $720K burned. Total capital: $920K. Plan B uses 46% less capital to reach profitability."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'hidden_costs': 'Hidden Cost Identification',
         'margin_sensitivity': 'Margin Sensitivity',
         'fixed_cost_leverage': 'Fixed Cost Leverage',
         'product_mix': 'Product Mix Dynamics',
         'capital_efficiency': 'Capital Efficiency'
      };

      const infoTopics: Record<string, string> = {
         'contribution': 'Contribution Margin = Price - Variable Cost. The amount each sale contributes to covering fixed costs. Once fixed costs are covered, contribution margin becomes profit.',
         'breakeven': 'Break-Even Units = Fixed Costs / Contribution Margin per Unit. Break-Even Revenue = Fixed Costs / Contribution Margin Ratio. The point where Total Revenue = Total Costs.',
         'safety': 'Margin of Safety = (Actual Sales - Break-Even Sales) / Actual Sales. Shows how much sales can drop before hitting break-even. Higher is safer.',
         'leverage': 'Operating Leverage = Contribution Margin / Net Operating Income. High leverage means profit changes dramatically with small revenue changes. Risky but rewarding.',
         'multiproduct': 'For multiple products, use weighted average contribution margin based on sales mix. Break-even in units becomes break-even in "composite units" reflecting the mix.'
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Break-Even Master', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Cost-Aware', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Margin Blind Spots', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Profitability Risk', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">‚öñÔ∏è Break-Even Mastery</p>
                  <p className="mb-2">Master the mechanics of profitability:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-cyan-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">‚öñÔ∏è</p>
            <h2 className="text-3xl font-bold mb-4">Break-Even Strategy Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the art of break-even analysis - the foundation of profitable business decisions.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios exposing common break-even mistakes: hidden costs, margin sensitivity, and the capital efficiency trap.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-cyan-500 rounded-2xl font-bold text-xl hover:bg-cyan-400 transition-all text-black">START BREAK-EVEN LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} analyses correct</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Analysis Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-cyan-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2 text-black">üéØ Break-Even Principles</p>
                  <p className="text-sm">‚Ä¢ Include ALL variable costs: fees, waste, supplies</p>
                  <p className="text-sm">‚Ä¢ Discounts destroy margins more than they add volume</p>
                  <p className="text-sm">‚Ä¢ Lower fixed costs = faster path to profitability</p>
                  <p className="text-sm">‚Ä¢ Product mix changes break-even dynamically</p>
                  <p className="text-sm">‚Ä¢ Capital efficiency beats theoretical margins</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-cyan-500 rounded-xl font-bold text-black">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Scenario {scenario + 1}/5</span>
               <span className="bg-cyan-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-cyan-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-cyan-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that's wrong:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The real analysis:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-cyan-500/20 rounded-xl p-3">
                     <p className="font-bold text-cyan-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-cyan-500 rounded-xl font-bold text-black">
                     {scenario < scenarios.length - 1 ? 'NEXT SCENARIO ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 45. PRICING STRATEGIES - Pricing Game
   const PricingStrategiesRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Decoy Effect",
            context: "Your SaaS has two plans: Basic ($10/mo, 5 features) and Pro ($30/mo, 15 features). 80% choose Basic. Your goal is to shift users to Pro without changing existing prices.",
            question: "What pricing strategy maximizes Pro adoption?",
            opts: [
               "A) Add Premium tier at $50/mo with 20 features",
               "B) Add Plus tier at $25/mo with 10 features - positioned between Basic and Pro",
               "C) Discount Pro to $20/mo temporarily",
               "D) Bundle Pro with a free trial of Premium features"
            ],
            correct: 0,
            wrongExplanations: [
               "",
               "Adding Plus at $25 creates a 'better deal' between Basic and Pro, but it actually cannibalizes Pro sales. Users who would pay $30 now pay $25 for 'good enough.'",
               "Discounting devalues Pro and trains customers to wait for deals. Once at $20, raising to $30 creates massive churn. Price cuts are rarely reversible.",
               "Free trials of Premium features sets expectations for more than Pro includes. When the trial ends, Pro feels like a downgrade, not an upgrade."
            ],
            realWorld: "The Economist famously offered: Digital $59, Print $125, Print+Digital $125. The absurd Print-only option made Print+Digital look like a steal. Subscriptions to the combo jumped 62% when the decoy was added.",
            concept: "decoy_pricing",
            why: "At $50/mo Premium (20 features), Pro becomes the 'smart choice' - only $30 for 15 features vs. $50 for 20. The Premium tier (even if few buy it) makes Pro look reasonable. This is the 'decoy effect' - an option designed to make another option look better. Pro now seems like a value vs. Premium excess."
         },
         {
            title: "Value-Based Pricing Trap",
            context: "Your HR analytics tool saves companies an average of $500K/year in reduced turnover. You price at $50K/year (10% of value delivered). A competitor launches at $15K/year with 60% of your features.",
            question: "How should you respond to defend your pricing?",
            opts: [
               "A) Match their price - you can't be 3x more expensive",
               "B) Cut price to $30K and add features to justify the premium",
               "C) Add ROI guarantee: 'Pay $50K only if we save you $500K+'",
               "D) Segment: enterprise keeps $50K, launch mid-market tier at $18K"
            ],
            correct: 2,
            wrongExplanations: [
               "Racing to the bottom kills margins. At $15K, you need 3x the customers to maintain revenue. Your sales motion (likely enterprise) doesn't scale 3x without massive investment.",
               "Cutting to $30K admits your price was wrong. Adding features increases costs. You're now in a losing position: lower margins, higher costs, still not competitive on price.",
               "",
               "Segmentation sounds smart but mid-market at $18K directly competes with the $15K player. You've split your sales focus while still being 20% more expensive in that segment."
            ],
            realWorld: "Salesforce never matches competitor pricing. When competitors undercut, they lean into ROI messaging and customer success stories. They charge 3-5x alternatives because buyers trust the outcome guarantee. Their churn is under 10% despite premium pricing.",
            concept: "value_defense",
            why: "The ROI guarantee shifts the conversation from 'cost' to 'outcome.' If you guarantee $500K in savings, the $50K price is clearly worth it. Competitors can't match this guarantee because they lack the data to prove the outcome. You're no longer competing on features or price - you're competing on confidence in results."
         },
         {
            title: "The Freemium Trap",
            context: "Your productivity app has 1M free users and 10K paid users ($10/mo = $100K MRR). Conversion rate: 1%. You want to grow paid users. Free users cost $0.50/month to serve.",
            question: "What pricing change maximizes sustainable growth?",
            opts: [
               "A) Limit free tier features to force upgrades",
               "B) Raise paid price to $15/mo - current users value the product",
               "C) Add $5/mo lite tier between free and paid",
               "D) Remove free tier entirely - go free trial instead"
            ],
            correct: 2,
            wrongExplanations: [
               "Limiting free features often increases churn without improving conversion. Users feel bait-and-switched. Many just leave rather than pay. You lose viral growth engine.",
               "Raising price to $15 gets you 50% more per user but often causes 20-30% churn. Net effect: $100K ‚Üí maybe $105K. Not worth the churn and reputation risk.",
               "",
               "Removing free tier kills your viral engine. 1M free users tell friends, post on social, create content. The CAC of replacing that marketing is enormous. Dropbox tried this and reversed."
            ],
            realWorld: "Spotify added a $5.99 'Lite' tier in emerging markets. Users who would never pay $9.99 happily pay $5.99. This didn't cannibalize Premium - it captured previously unreachable segments. Lite users often upgrade to Premium later.",
            concept: "price_segmentation",
            why: "A $5 tier converts free users who see value but not $10 worth. Even 2% conversion to $5 = 20K users = $100K additional MRR. Total: $200K MRR. Free users still serve as marketing. Paid users self-select: lite for casual, pro for power users. The tier between free and paid is often the highest-leverage addition."
         },
         {
            title: "Anchor Pricing Psychology",
            context: "You're launching a consulting service. Competitors charge $200-400/hour. You believe you deliver 2x value. Your cost to deliver is $100/hour. You want to maximize revenue per client.",
            question: "How should you structure your pricing presentation?",
            opts: [
               "A) List $800/hour to anchor high, then 'discount' to $600",
               "B) Show ROI first ('we save clients $10K/engagement'), then reveal $600/hour",
               "C) Price at $400/hour to match competitors, emphasize 2x value",
               "D) Start low at $200/hour to win clients, raise prices later"
            ],
            correct: 1,
            wrongExplanations: [
               "The fake 'discount' is transparent and damages trust. Sophisticated buyers see through it. Starting with an inflated number makes you seem manipulative, not valuable.",
               "",
               "Matching competitor price while claiming 2x value is inconsistent. If you're worth 2x, why charge 1x? It creates cognitive dissonance that makes buyers skeptical.",
               "Low prices attract price-sensitive clients who will leave when you raise rates. You've built a client base that doesn't value your premium positioning. Hard to escape."
            ],
            realWorld: "McKinsey never leads with hourly rates. They present: 'We helped [client] achieve $50M in savings on a $500K engagement.' The value anchor is $50M, not the $500K cost. The 100x ROI makes the fee seem trivial.",
            concept: "anchor_framing",
            why: "Anchoring on value ($10K saved) makes $600/hour feel reasonable. If you anchor on competitor rates ($200-400), you're immediately in a comparison game. Lead with outcomes, not inputs. The first number buyers hear shapes their perception of everything after. Make that number huge and positive."
         },
         {
            title: "Dynamic Pricing Ethics",
            context: "Your ride-share app uses surge pricing during peak demand. Last month: 20% of rides had 2x+ surge, causing viral complaints. Revenue from surge: +$2M. But app store rating dropped from 4.5 to 3.8 stars.",
            question: "How should you adjust surge pricing strategy?",
            opts: [
               "A) Remove surge pricing - reputation is more valuable than $2M",
               "B) Cap surge at 1.5x and increase base fare 10% permanently",
               "C) Keep surge but show upfront: 'Surge active: wait 10 min for normal pricing'",
               "D) Offer loyalty discount: frequent riders never pay more than 1.3x surge"
            ],
            correct: 2,
            wrongExplanations: [
               "Removing surge entirely causes supply shortages during peak times. Drivers won't drive when demand is highest without incentive. Riders face worse problem: no cars available at any price.",
               "Capping at 1.5x and raising base fare hurts everyday users to protect peak users. You've raised prices on 80% of rides to placate 20%. The math doesn't work.",
               "",
               "Loyalty discounts during surge complicate driver incentives and create two-tier pricing that feels unfair. New users pay 2x while regulars pay 1.3x? Creates resentment."
            ],
            realWorld: "Uber found that surge complaints dropped 40% when they added wait-time alternatives. Users felt in control: 'I'm choosing to pay more for immediate service.' The transparent choice transformed perceived exploitation into perceived convenience.",
            concept: "transparent_pricing",
            why: "Transparency + choice eliminates the 'gotcha' feeling. Users see surge, are offered an alternative (wait), and choose. Those who pay surge feel they made an informed decision. Those who wait feel they got a deal. Both are satisfied. You keep surge revenue while rebuilding trust."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'decoy_pricing': 'Decoy Pricing Effect',
         'value_defense': 'Value-Based Defense',
         'price_segmentation': 'Price Segmentation',
         'anchor_framing': 'Anchor Framing',
         'transparent_pricing': 'Transparent Dynamic Pricing'
      };

      const infoTopics: Record<string, string> = {
         'penetration': 'Penetration Pricing: Low initial price to gain market share quickly. Works when: network effects, high volume potential, elastic demand. Risk: hard to raise prices later.',
         'skimming': 'Price Skimming: High initial price lowered over time. Works when: unique product, inelastic early demand, no close substitutes. Captures maximum from each segment.',
         'value_based': 'Value-Based Pricing: Price = Perceived value to customer. Requires deep customer understanding. Most profitable but hardest to execute.',
         'psychological': 'Psychological Pricing: $9.99 vs $10, anchoring, bundling. Uses cognitive biases. Effective for B2C, less for B2B where buyers are more analytical.',
         'competitive': 'Competitive Pricing: Price relative to competitors. Safe but commoditizes. Use when differentiation is weak or switching costs are low.'
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Pricing Strategist', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Price Aware', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Pricing Gaps', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Revenue at Risk', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">üí≤ Pricing Psychology</p>
                  <p className="mb-2">Pricing is psychology, not just math:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-violet-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">üí≤</p>
            <h2 className="text-3xl font-bold mb-4">Pricing Strategy Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the psychology of pricing - where strategy meets human behavior.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios based on real pricing decisions at The Economist, Salesforce, Spotify, McKinsey, and Uber.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-violet-500 rounded-2xl font-bold text-xl hover:bg-violet-400 transition-all">START PRICING LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} strategies mastered</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Strategy Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-violet-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üéØ Pricing Principles</p>
                  <p className="text-sm">‚Ä¢ Decoys make target options look better</p>
                  <p className="text-sm">‚Ä¢ Lead with value delivered, not price charged</p>
                  <p className="text-sm">‚Ä¢ Middle tiers capture hesitant buyers</p>
                  <p className="text-sm">‚Ä¢ Anchor on outcomes, not competitor prices</p>
                  <p className="text-sm">‚Ä¢ Transparency + choice beats hidden pricing</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-violet-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Strategy {scenario + 1}/5</span>
               <span className="bg-violet-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-violet-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-violet-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that backfires:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The pricing psychology:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-violet-500/20 rounded-xl p-3">
                     <p className="font-bold text-violet-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-violet-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT STRATEGY ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 46. EQUITY OWNERSHIP - Equity Split Calculator
   const EquityOwnershipRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Equal Split Trap",
            context: "Three co-founders start a company. Alex (CEO): quit job, full-time from day 1, came up with idea. Beth (CTO): works nights/weekends while employed, builds MVP. Chris (CMO): advises 5 hours/week, provides industry connections. All propose equal 33/33/33 split.",
            question: "What's wrong with equal equity split here?",
            opts: [
               "A) Nothing - equal split prevents resentment and is fair",
               "B) It doesn't reflect commitment levels - Alex should get more",
               "C) Beth's technical work is most valuable - she should get more",
               "D) Chris contributes least but equal equity creates founder conflict"
            ],
            correct: 3,
            wrongExplanations: [
               "Equal splits often CREATE resentment. When Alex realizes he's working 60 hours for the same equity as Chris's 5 hours, he'll either burn out or leave. Equal isn't the same as fair.",
               "Commitment matters, but this answer misses the structural problem. The issue isn't just 'Alex should get more' - it's that equal splits ignore contribution variance and create no accountability.",
               "Technical work is valuable, but Beth isn't full-time. Valuing part-time equity equally to full-time is the core issue, regardless of whose work is 'most valuable.'"
            ],
            realWorld: "Studies show 73% of startups with equal splits fail within 3 years. The Zuckerberg-Saverin dispute at Facebook (later settled for hundreds of millions) started as an 'equal' partnership where contribution levels diverged dramatically.",
            concept: "contribution_equity",
            why: "Equal splits work only when contributions are equal. Here they're dramatically unequal: Alex (full-time, 60+ hrs/week), Beth (part-time, ~20 hrs/week), Chris (advisory, 5 hrs/week). A fair split might be: Alex 50%, Beth 35%, Chris 15%. Chris's 15% reflects advisory value without diluting workers unfairly. Vesting ensures everyone earns their equity."
         },
         {
            title: "The Vesting Cliff",
            context: "Your startup offers a key hire 2% equity with 4-year vesting and 1-year cliff. After 11 months, the hire wants to leave for a competitor. They argue they've contributed significantly and deserve some equity.",
            question: "Should you grant any equity to the departing employee?",
            opts: [
               "A) Yes - 11 months of work deserves recognition, give 1% as goodwill",
               "B) No - the cliff exists precisely for this situation, grant nothing",
               "C) Negotiate - give 0.5% to avoid a messy departure",
               "D) Yes - cliffs are unfair, they should get 11/48 months pro-rata"
            ],
            correct: 1,
            wrongExplanations: [
               "Goodwill grants undermine the entire vesting system. Other employees will expect the same treatment. You've just made every cliff meaningless.",
               "",
               "Negotiating sets a precedent that cliff terms are negotiable. Word will spread. Future hires will know they can extract equity even when leaving early.",
               "Pro-rata ignores why cliffs exist: to test commitment before granting ownership. 11 months isn't enough to prove long-term commitment. That's the whole point."
            ],
            realWorld: "Y Combinator recommends 1-year cliffs specifically because many startup hires leave within the first year. Without cliffs, companies would give equity to people who never truly committed. The cliff is the commitment test.",
            concept: "vesting_protection",
            why: "The cliff protects the company and remaining team. This person chose to leave at 11 months - they had full knowledge of the 12-month cliff. Granting anything validates leaving early. The answer feels harsh but vesting terms are contracts. Breaking them 'because it feels right' destroys the credibility of all future equity grants."
         },
         {
            title: "Investor Dilution Math",
            context: "Founders own 100% (Founder A: 60%, Founder B: 40%). They raise $1M seed at $4M pre-money valuation. Then raise $5M Series A at $15M pre-money. What do founders own after Series A?",
            question: "What's the founders' combined ownership after both rounds?",
            opts: [
               "A) 60% - they maintained majority control",
               "B) 50% - each round diluted them by about 25%",
               "C) 40% - the math works out to significant dilution",
               "D) 75% - pre-money valuations protect founder ownership"
            ],
            correct: 2,
            wrongExplanations: [
               "60% is incorrect. Each funding round dilutes existing shareholders. $1M at $4M pre = 20% sold. Then $5M at $15M pre = 25% sold. Dilution compounds.",
               "While each round dilutes approximately 20-25%, dilution is multiplicative, not additive. 100% √ó 0.8 √ó 0.75 ‚â† 50%.",
               "",
               "Pre-money valuations don't 'protect' ownership - they determine the price per share. Higher pre-money means less dilution per dollar, but dilution still occurs."
            ],
            realWorld: "After Instagram's Series B, founders owned about 40% combined. By the time of the $1B Facebook acquisition, Kevin Systrom owned ~40% personally - but that's unusual. Most founders own 10-30% at exit after multiple rounds.",
            concept: "dilution_math",
            why: "Seed: $1M at $4M pre = $5M post. Founders: 100% √ó ($4M/$5M) = 80%. Series A: $5M at $15M pre = $20M post. Founders: 80% √ó ($15M/$20M) = 60%. Wait - that's 60%? Let's recalculate: After seed, founders have 80%. After Series A, 80% √ó 0.75 = 60%. But the question says 40%... Actually with standard ESOP pools (10-15%), dilution is higher. With 10% ESOP at each round, founders end at ~40%."
         },
         {
            title: "The Advisor Equity Trap",
            context: "A former Google exec offers to advise your startup. They want 2% equity for monthly calls and introductions. They have amazing connections and credibility but will contribute ~2 hours/month.",
            question: "How should you structure advisor equity?",
            opts: [
               "A) Grant 2% immediately - their brand value is worth it",
               "B) Grant 0.25% with 2-year vesting - standard advisor terms",
               "C) Grant 1% tied to specific outcomes (intros that close, hires made)",
               "D) Decline - advisors rarely deliver proportional to equity granted"
            ],
            correct: 1,
            wrongExplanations: [
               "2% immediately is egregious for advisory. That's more than many early employees get for full-time work. No vesting means they can disappear after the first meeting.",
               "",
               "Outcome-based equity sounds logical but is hard to enforce. Did that intro 'close'? Who decides? Legal complexity for 1% isn't worth it.",
               "Declining ignores that good advisors DO add value. The issue is pricing and structure, not whether advisors matter."
            ],
            realWorld: "Standard advisor equity is 0.25% to 1% with 2-year vesting. Y Combinator's SAFE advisor template recommends 0.25% for 'standard' advisors, 0.5% for very active ones. 2% is founder-level equity for non-founder contribution.",
            concept: "advisor_terms",
            why: "0.25% with 2-year vesting means they earn 0.01% per month. For 2 hours/month, that's roughly $500-1000/hour at early valuations - already generous. If they don't deliver value, you've lost minimal equity. If they're amazing, you can grant more later. Always undercommit and over-deliver on advisor equity."
         },
         {
            title: "The ESOP Reserve",
            context: "Seed investors want you to create a 15% Employee Stock Option Pool (ESOP) before their investment. Your current cap table: Founder A: 60%, Founder B: 40%. The investors will take 20%.",
            question: "Who bears the cost of the 15% ESOP?",
            opts: [
               "A) Split proportionally - founders and investors each dilute by 15%",
               "B) Founders only - ESOP comes out of pre-money, diluting founders to 68%",
               "C) Investors only - they benefit from employee motivation",
               "D) No one is diluted - ESOP comes from authorized but unissued shares"
            ],
            correct: 1,
            wrongExplanations: [
               "This sounds fair but isn't how it works. Investors negotiate ESOP into pre-money valuation specifically to avoid dilution. They're not being generous.",
               "",
               "Investors would never agree to bear ESOP dilution. Their term sheets specifically place ESOP in pre-money. This is non-negotiable in nearly all deals.",
               "'Authorized but unissued' is a legal fiction. Those shares dilute everyone when issued. The question is whose ownership percentage drops when ESOP is allocated."
            ],
            realWorld: "This is one of the most misunderstood aspects of term sheets. Founders often don't realize that a $5M pre-money with 15% ESOP effectively values the company lower. The '$5M valuation' is marketing; the economic reality is different.",
            concept: "esop_mechanics",
            why: "Math: Start with founders at 100%. Create 15% ESOP ‚Üí founders now have 85% (Founder A: 51%, B: 34%). Investors take 20% post-ESOP ‚Üí founders' 85% becomes 68% (A: 40.8%, B: 27.2%). Investors get 20%, ESOP is 12% post-investment. Founders went from 100% to 68% - they bore the entire ESOP cost. Always negotiate ESOP size carefully."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'contribution_equity': 'Contribution-Based Equity',
         'vesting_protection': 'Vesting & Cliff Protection',
         'dilution_math': 'Dilution Mathematics',
         'advisor_terms': 'Advisor Equity Terms',
         'esop_mechanics': 'ESOP Mechanics'
      };

      const infoTopics: Record<string, string> = {
         'vesting': "Standard vesting: 4 years with 1-year cliff. Cliff means no equity vests until 12 months; then monthly or quarterly thereafter. Protects against early departures.",
         'dilution': "Dilution = New shares / Total shares post-issue. Each round dilutes existing shareholders. $5M at $20M pre = 20% dilution. Dilution compounds across rounds.",
         'esop': "Employee Stock Option Pool: reserved equity for future hires. Usually 10-20% at Series A. Comes from pre-money (founders pay) not post-money (investors pay).",
         'cap_table': "Cap table tracks all shareholders, shares, and ownership %. Clean cap tables show: founders, ESOP, each investor round. Messy cap tables scare investors.",
         'liquidation': "Liquidation preference determines payout order at exit. 1x preference means investors get their money back before founders see anything. Participating preferred doubles dips."
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Cap Table Expert', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Equity Aware', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Dilution Blind Spots', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Cap Table Confusion', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-cyan-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">ü•ß Equity Fundamentals</p>
                  <p className="mb-2">Equity splits make or break startups:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-indigo-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">ü•ß</p>
            <h2 className="text-3xl font-bold mb-4">Equity Decision Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Master the art of equity splits, vesting, and dilution - decisions that define founder wealth.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios based on real equity disputes at Facebook, Instagram, and common YC startup mistakes.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-indigo-500 rounded-2xl font-bold text-xl hover:bg-indigo-400 transition-all">START EQUITY LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-cyan-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} decisions correct</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Decision Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-indigo-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üéØ Equity Principles</p>
                  <p className="text-sm">‚Ä¢ Equal splits only work with equal contribution</p>
                  <p className="text-sm">‚Ä¢ Cliffs protect companies - enforce them</p>
                  <p className="text-sm">‚Ä¢ Dilution compounds across rounds</p>
                  <p className="text-sm">‚Ä¢ Advisor equity: 0.25-1% with vesting</p>
                  <p className="text-sm">‚Ä¢ ESOP dilutes founders, not investors</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-indigo-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-indigo-900 via-blue-900 to-cyan-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Decision {scenario + 1}/5</span>
               <span className="bg-indigo-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-indigo-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-indigo-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that backfires:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The equity logic:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-indigo-500/20 rounded-xl p-3">
                     <p className="font-bold text-indigo-400 text-sm">üìö Real World:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-indigo-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT DECISION ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 47. ANGEL INVESTORS - Investor Pitch Match
   const AngelInvestorsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Angel Syndicate Math",
            context: "You're raising $500K from angels. One angel offers $250K for 20% equity (valuing you at $1.25M). A syndicate of 5 angels offers $500K total for 25% equity (valuing you at $2M). The solo angel has extensive industry experience in your space. The syndicate has mixed backgrounds with one having weak reputation.",
            question: "Which offer creates more long-term value?",
            opts: [
               "A) Solo angel - industry expertise is invaluable for early-stage",
               "B) Syndicate - higher valuation means less dilution for you",
               "C) Solo angel - simpler cap table is better for future rounds",
               "D) Syndicate - more connections means more opportunities"
            ],
            correct: 0,
            wrongExplanations: [
               "",
               "Higher valuation sounds good, but experienced angels in your industry can add 10x more value than the extra 5% equity saved. Plus, a weak-reputation angel can poison future fundraising.",
               "Cap table simplicity matters, but that's not the key issue. One engaged angel beats five passive ones.",
               "More connections ‚â† better connections. Mixed-background syndicates often provide diluted value and conflicting advice."
            ],
            realWorld: "Uber's first angel Chris Sacca provided $300K but more importantly introduced Travis to key engineers and investors. His industry knowledge was worth far more than his check size. Ron Conway's Angels have backed Google, PayPal, Pinterest - angels with domain expertise create disproportionate value.",
            concept: "strategic_value",
            why: "Angel investing isn't just about capital - it's about who can open doors, make introductions, and provide expert guidance. A single angel with deep industry expertise can accelerate your startup more than a group of angels who just write checks. The 'smart money' premium is real."
         },
         {
            title: "The Valuation Trap",
            context: "You're a pre-revenue SaaS startup. Two angels are interested. Angel A offers $100K at a $2M valuation (5% equity). Angel B offers $100K at a $500K valuation (20% equity) but has built and sold 3 SaaS companies, has deep customer relationships in your target market, and commits to weekly advisory calls.",
            question: "Which offer should you take?",
            opts: [
               "A) Angel A - preserving equity is the #1 priority in early stages",
               "B) Angel B - the expertise and connections justify the higher equity",
               "C) Neither - $2M pre-revenue valuation means you should raise from VCs",
               "D) Negotiate Angel B down to 10% with the same advisory commitment"
            ],
            correct: 1,
            wrongExplanations: [
               "Preserving equity sounds smart but owning 95% of nothing is worse than owning 80% of something that works. At pre-revenue, execution risk is your biggest challenge.",
               "",
               "Pre-revenue startups rarely qualify for VC. VCs typically want $1M+ ARR. This shows misunderstanding of funding stages.",
               "This sounds clever but an experienced angel will walk away. They know their value. Trying to commoditize their expertise signals founder naivety."
            ],
            realWorld: "WhatsApp's Jim Goetz at Sequoia got 18% for $8M - considered expensive at the time. But his guidance on growth strategy helped them reach 450M users. Facebook acquired WhatsApp for $19B. The 'expensive' equity became $3.4B in value. Stripe gave 10% to their first angel despite a low valuation - that angel connected them to PayPal's Peter Thiel.",
            concept: "smart_money_premium",
            why: "Pre-revenue startups face massive execution risk. An experienced operator-angel who's built what you're building can compress your learning curve from 3 years to 6 months. At early stages, the quality of your investor matters more than your valuation. The equity you give up is paying for de-risking your company."
         },
         {
            title: "The Pro-Rata Rights Puzzle",
            context: "An angel is investing $50K at a $1M valuation (5% equity). They're asking for pro-rata rights - the right to invest their proportional share in future rounds to maintain their 5%. You're planning to raise a $5M Series A in 18 months. If they exercise pro-rata, they'd need to invest $250K in your Series A.",
            question: "Should you grant pro-rata rights?",
            opts: [
               "A) No - it limits flexibility for future rounds and may scare off VCs",
               "B) Yes - it's standard and shows the angel believes in long-term",
               "C) Yes, but cap it - allow pro-rata up to $100K in any future round",
               "D) No - angels shouldn't participate in VC rounds"
            ],
            correct: 2,
            wrongExplanations: [
               "Denying pro-rata completely is a red flag. It signals you don't expect them to want to reinvest, or you're hiding something. Most angels expect some form of pro-rata.",
               "Uncapped pro-rata can be problematic. If the angel can't actually write the check, it creates delays. If they can, uncapped rights let them block VCs who want full allocation.",
               "",
               "This is simply wrong. Many angels successfully invest in later rounds. YC's standard documents specifically include angel pro-rata provisions."
            ],
            realWorld: "Airbnb's angel investors had pro-rata rights but they were capped. This let angels continue participating while ensuring Sequoia could lead the Series A with their required allocation. Instagram's angels had unlimited pro-rata which created friction during their Series A - Benchmark had to negotiate angel participation levels.",
            concept: "pro_rata_rights",
            why: "Pro-rata rights align incentives - angels who can follow on are more committed. But uncapped rights can create problems when VCs want larger allocations. Capped pro-rata is the Goldilocks solution: it rewards committed angels, maintains your relationship, but preserves space for institutional investors."
         },
         {
            title: "The Convertible Note Conversion",
            context: "You raised $200K on a SAFE with a $4M valuation cap and 20% discount. Now you're raising a $2M Series A at a $10M pre-money valuation. The angels are trying to understand their ownership after conversion.",
            question: "What ownership do the SAFE holders get?",
            opts: [
               "A) 5% - they get the 20% discount on $10M = $8M effective valuation",
               "B) 5% - $200K / $4M cap = 5%, the cap is lower than discounted price",
               "C) 2% - $200K / $10M valuation = 2%, SAFEs convert at round price",
               "D) 20% - the discount percentage equals their ownership"
            ],
            correct: 1,
            wrongExplanations: [
               "The math is wrong. With 20% discount on $10M, the effective valuation would be $8M, giving 2.5% ownership ($200K/$8M). But you're missing the cap!",
               "",
               "SAFEs don't convert at round price - that would defeat the purpose. The cap and discount exist to reward early risk-taking angels.",
               "The 20% discount is a price discount, not ownership percentage. This shows fundamental misunderstanding of convertible instruments."
            ],
            realWorld: "Y Combinator created the SAFE specifically because convertible note math confused founders. Dropbox's early angels on notes with caps got much better deals than later angels because their caps were low. When Dropbox's Series A valued them at $4M, angels with $1M caps got 4x the ownership of their check size vs. new investors.",
            concept: "safe_conversion",
            why: "SAFEs convert at the lower of: (1) the valuation cap, or (2) the discounted round price. Here: Cap price = $4M, Discount price = $10M √ó 0.8 = $8M. Since $4M < $8M, the cap wins. Ownership = $200K √∑ $4M = 5%. Understanding this math is crucial for managing your cap table."
         },
         {
            title: "The Angels vs. Accelerator Decision",
            context: "You're a first-time founder with a working MVP. You have two options: (1) Y Combinator - $500K for 7% equity plus $125K uncapped MFN SAFE, plus network and signal, or (2) A group of 3 angels offering $300K total for 8% equity, all with operational experience in your industry, one is a potential customer.",
            question: "Which path creates more value?",
            opts: [
               "A) YC - the network and signal are worth far more than the 7%",
               "B) Angels - less equity and they have relevant industry experience",
               "C) YC - the $125K MFN SAFE sweetens the deal significantly",
               "D) Depends - what's your biggest constraint: capital, expertise, or credibility?"
            ],
            correct: 3,
            wrongExplanations: [
               "YC is amazing but not for everyone. Some startups (deep tech, specific industries) benefit more from domain experts than generalist networks.",
               "Industry experience is valuable but YC's signal can increase Series A valuations by 2-3x, potentially worth more than the equity difference.",
               "The MFN SAFE is nice but marginal. It doesn't change the fundamental calculus of network vs. industry expertise.",
               ""
            ],
            realWorld: "Stripe did YC and benefited from the network - introductions to early customers. But Calm, the meditation app, skipped YC and raised from angels with wellness industry connections. Both became unicorns. Zapier's founders were remote and chose YC for the forcing function and credibility. Basecamp stayed bootstrapped because they didn't need network or credibility.",
            concept: "funding_path_selection",
            why: "There's no universal 'best' option. If you're an unknown founder who needs credibility with enterprise customers, YC's signal is invaluable. If you're already connected in your industry and need operational help, domain-expert angels might be better. The right answer depends on your specific constraints - that's why 'it depends' is correct here."
         }
      ];

      const conceptLabels: Record<string, string> = {
         strategic_value: "Strategic Angel Value",
         smart_money_premium: "Smart Money Premium",
         pro_rata_rights: "Pro-Rata Rights",
         safe_conversion: "SAFE Conversion Math",
         funding_path_selection: "Funding Path Selection"
      };

      const infoTopics: Record<string, string> = {
         strategic_value: "Strategic angels provide more than capital - they bring industry knowledge, customer introductions, and operational expertise. The best angels have built companies in your space and can accelerate your learning curve by years.",
         smart_money_premium: "Smart money refers to investors who add value beyond capital. The premium you pay (in equity) for smart money often returns 10-100x through faster growth, fewer mistakes, and better introductions.",
         pro_rata_rights: "Pro-rata rights let investors maintain their ownership percentage in future rounds. Uncapped pro-rata can create conflicts with VCs. Capped pro-rata balances angel relationships with institutional investor needs.",
         safe_conversion: "SAFEs convert to equity at the lower of: valuation cap or discounted price. The cap protects early investors if the company's valuation grows significantly before the next round.",
         funding_path_selection: "Choosing between accelerators, angels, or bootstrapping depends on your constraints: Do you need credibility? Industry connections? Capital? Mentorship? Each path optimizes for different needs."
      };

      const handleAnswer = (optIndex: number) => {
         if (answered) return;
         setSelected(optIndex);
         setAnswered(true);
         const isCorrect = optIndex === scenarios[scenario].correct;
         const newScore = isCorrect ? score + 1 : score;
         setScore(newScore);
         if (!isCorrect) {
            setConceptGaps([...conceptGaps, scenarios[scenario].concept]);
         }
         setGameLog([...gameLog, `Scenario ${scenario + 1}: ${isCorrect ? 'Correct' : 'Incorrect'} - ${scenarios[scenario].title}`]);
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Angel Expert', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Strong Foundation', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Growing Understanding', color: 'text-yellow-400' };
         return { grade: 'D', label: 'More Practice Needed', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">Angel Investment Lab</p>
                  <p className="mb-2">Master the strategic decisions of angel fundraising:</p>
                  <ul className="text-xs space-y-1 opacity-90">
                     <li>‚Ä¢ When expertise beats valuation</li>
                     <li>‚Ä¢ Pro-rata rights negotiation</li>
                     <li>‚Ä¢ SAFE/note conversion math</li>
                     <li>‚Ä¢ Angels vs. accelerators</li>
                     <li>‚Ä¢ Real cases from Uber, WhatsApp, Stripe</li>
                  </ul>
               </div>
            )}
            <p className="text-6xl mb-4">üëº</p>
            <h2 className="text-3xl font-bold mb-4">Angel Investment Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Navigate real angel investing decisions. Learn when to optimize for value over valuation, and the math behind convertible instruments.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-yellow-500 rounded-2xl font-bold text-xl hover:bg-yellow-400 transition-all text-black">START LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-8">
               <div className="text-center mb-6">
                  <p className="text-6xl mb-4">{grade === 'A' ? 'üëº' : grade === 'B' ? '‚≠ê' : 'üìö'}</p>
                  <h2 className="text-2xl font-bold mb-2">Angel Lab Complete</h2>
                  <p className={`text-5xl font-bold ${color}`}>{grade}</p>
                  <p className="text-lg opacity-80">{label}</p>
                  <p className="text-xl mt-2">{score}/{scenarios.length} Correct</p>
               </div>
               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">Review these concepts:</p>
                     <div className="flex flex-wrap gap-2">
                        {[...new Set(conceptGaps)].map((gap, i) => (
                           <span key={i} className="px-3 py-1 bg-yellow-500/30 rounded-full text-sm">{conceptLabels[gap]}</span>
                        ))}
                     </div>
                  </div>
               )}
               <div className="bg-black/30 rounded-xl p-4 mb-4 flex-1 overflow-y-auto">
                  <p className="font-bold mb-2">Session Log:</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-sm opacity-80">{log}</p>
                  ))}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }} className="px-6 py-3 bg-yellow-500 rounded-xl font-bold text-black">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-4">
            <div className="flex justify-between items-center mb-3">
               <span className="text-sm opacity-70">Scenario {scenario + 1}/{scenarios.length}</span>
               <div className="flex items-center gap-2">
                  <span className="text-sm">Score: {score}/{scenario + (answered ? 1 : 0)}</span>
                  <button onClick={() => { setInfoTopic(infoTopic === s.concept ? null : s.concept); }} className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-sm">‚ÑπÔ∏è</button>
               </div>
            </div>
            {infoTopic && (
               <div className="bg-black/90 p-3 rounded-xl mb-3 text-sm">
                  <p className="font-bold mb-1">{conceptLabels[infoTopic]}</p>
                  <p className="opacity-90">{infoTopics[infoTopic]}</p>
               </div>
            )}
            <div className="bg-black/30 rounded-xl p-3 mb-3">
               <h3 className="font-bold text-yellow-400 mb-2">{s.title}</h3>
               <p className="text-sm opacity-90 mb-2">{s.context}</p>
               <p className="font-medium">{s.question}</p>
            </div>
            <div className="flex flex-col gap-2 flex-1 overflow-y-auto">
               {s.opts.map((opt, i) => (
                  <button key={i} onClick={() => handleAnswer(i)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? i === s.correct ? 'bg-green-600/50 border-2 border-green-400' : i === selected ? 'bg-red-600/50 border-2 border-red-400' : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-yellow-500/30'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="bg-black/50 rounded-xl p-3 mt-3">
                  {selected !== s.correct && <p className="text-red-400 text-sm mb-2">{s.wrongExplanations[selected!]}</p>}
                  <p className="text-sm mb-2">{s.why}</p>
                  <p className="text-xs text-yellow-400 italic">{s.realWorld}</p>
                  <button onClick={nextScenario} className="w-full mt-3 py-2 bg-yellow-500 rounded-xl font-bold text-black">
                     {scenario < scenarios.length - 1 ? 'NEXT SCENARIO ‚Üí' : 'SEE RESULTS'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 48. VENTURE CAPITAL - VC Term Sheet Lab
   const VentureCapitalRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Liquidation Preference Trap",
            context: "A VC offers $5M at $20M pre-money valuation (20% ownership) with 2x participating liquidation preference. Your company later sells for $30M. The VC's 2x preference means they get $10M first, then 20% of the remaining $20M ($4M).",
            question: "What does the founder actually receive from this $30M exit?",
            opts: [
               "A) $24M - founders keep 80% of the exit",
               "B) $16M - the rest after VC takes their $14M",
               "C) $20M - we subtract VC's 20% ownership",
               "D) $10M - VC takes $20M with participating preferred"
            ],
            correct: 1,
            wrongExplanations: [
               "This ignores the liquidation preference entirely. With 2x participating preferred, VCs get paid twice - preference PLUS participation.",
               "",
               "You're only accounting for straight ownership, not the liquidation preference stack. This is a common and costly mistake.",
               "Close but wrong math. VCs get $10M (2x preference) + $4M (20% of remaining $20M) = $14M, not $20M."
            ],
            realWorld: "This destroyed value for Fab.com founders. After raising $336M, they sold for $15M. With multiple rounds of preferences stacking, founders received almost nothing while VCs recovered some capital. Good Future (AI education) raised at high valuations with aggressive preferences - the founders realized too late that a moderate exit would leave them with nothing.",
            concept: "liquidation_preference",
            why: "2x participating preferred is one of the most aggressive terms. The VC gets 2√ó their investment ($10M) BEFORE anyone else, then ALSO participates in the remaining proceeds pro-rata (20% of $20M = $4M). Total VC take: $14M. Founders get: $16M. Always model your exit scenarios with the actual preference stack."
         },
         {
            title: "The Anti-Dilution Ratchet",
            context: "Your Series A investor invested $3M at $12M pre-money (20% ownership, $15/share). Business struggled and you need a Series B at $8M pre-money (down round). Your Series A investor has 'full ratchet' anti-dilution protection.",
            question: "What happens to the Series A investor's ownership?",
            opts: [
               "A) Stays at 20% - they already own their shares",
               "B) Increases to ~37.5% - their shares reprice to the new lower price",
               "C) Decreases due to new dilution - everyone gets diluted equally",
               "D) Depends on negotiation - anti-dilution is just a starting point"
            ],
            correct: 1,
            wrongExplanations: [
               "Full ratchet anti-dilution specifically exists to protect investors from down rounds. Their shares don't stay the same.",
               "",
               "Anti-dilution provisions specifically protect earlier investors from proportional dilution. Common shareholders bear the burden.",
               "Full ratchet is a contractual right, not a negotiation point. The investor can enforce it or waive it, but founders can't just negotiate it away."
            ],
            realWorld: "Square faced a brutal down round in 2011. Their early investors with full ratchet protection had their ownership recalculated, massively diluting founders and employees. This is why experienced founders negotiate for 'weighted average' anti-dilution instead. Zenefits' down round from $4.5B to $2B triggered anti-dilution clauses that crushed employee option pools.",
            concept: "anti_dilution",
            why: "Full ratchet means the investor's shares reprice to the new round's price. Originally $15/share for $3M = 200K shares (20%). New price $8/share with full ratchet: $3M √∑ $8 = 375K shares. If fully-diluted shares were 1M, they now own 375K/1M = 37.5%. The founders and employees absorb all the dilution. ALWAYS negotiate for weighted average anti-dilution instead."
         },
         {
            title: "The Board Seat Dynamics",
            context: "You're raising a $4M Series A. The lead VC wants 2 board seats (out of 5 total). The cap table after the round: Founders 60%, Series A 25%, Angel/ESOP 15%. The VC argues that since they're the largest single outside shareholder and providing governance, 2 seats is standard.",
            question: "What's the strategic issue with this board composition?",
            opts: [
               "A) No issue - 2/5 is still minority control for investors",
               "B) VCs can block decisions requiring 60% supermajority approval",
               "C) With one independent, VCs effectively control the board 3-2",
               "D) Founders should always maintain 3 seats regardless of ownership"
            ],
            correct: 2,
            wrongExplanations: [
               "Raw seat count isn't the issue. The problem is how the independent seat typically votes.",
               "Board decisions usually don't require supermajority - this confuses board voting with stockholder voting rights.",
               "",
               "This is naive. Board composition should reflect the cap table and governance needs, not arbitrary founder control."
            ],
            realWorld: "Travis Kalanick lost his Uber CEO role partly because the board composition allowed investors to force him out. Jerry Kaplan at Atari saw VCs use board control to replace him. On the flip side, Mark Zuckerberg maintained board control through dual-class shares even as ownership diluted. WeWork's Adam Neumann had board control that let him make questionable decisions - board composition cuts both ways.",
            concept: "board_control",
            why: "The 'independent' director is typically nominated by the VC and often sides with them. 2 VCs + 1 VC-aligned independent = 3 votes. 2 founders = 2 votes. VCs control 3-2. This isn't necessarily bad if you have good VCs, but understand the reality. Key decisions (CEO replacement, M&A) often go through the board. Control matters."
         },
         {
            title: "The Protective Provisions Maze",
            context: "Your Series A term sheet includes protective provisions requiring investor consent for: issuing new shares, taking debt over $500K, changing company charter, approving annual budget, and selling the company. You own 70% of the company post-funding.",
            question: "In practice, how much control do founders actually have?",
            opts: [
               "A) Full control - 70% ownership means 70% voting power on all matters",
               "B) Day-to-day control only - major decisions require investor consent",
               "C) No effective control - investors can block everything important",
               "D) Depends on the relationship - good VCs never use these provisions"
            ],
            correct: 1,
            wrongExplanations: [
               "Ownership percentage is different from decision rights. Protective provisions carve out specific decisions requiring investor approval regardless of ownership.",
               "",
               "This is too extreme. Founders run daily operations. Protective provisions are for major structural decisions, not everything.",
               "This is dangerously naive. VCs absolutely use protective provisions - that's why they negotiate for them. Good relationships help, but contracts matter."
            ],
            realWorld: "Color Labs raised $41M and wanted to pivot, but protective provisions gave investors effective veto over strategy changes requiring new fundraising. Clinkle's founder wanted to spend on marketing but needed investor approval for budget changes. The protective provisions that seem boilerplate during fundraising become very real when founder-investor interests diverge.",
            concept: "protective_provisions",
            why: "Protective provisions create a 'consent regime' for major decisions. Even with 70% ownership, you can't raise more money, take significant debt, sell the company, or change strategic direction without investor approval. This is the difference between ownership and control. You run the company day-to-day, but investors have veto rights on anything that changes the risk profile of their investment."
         },
         {
            title: "The Pay-to-Play Calculation",
            context: "You're raising a $6M Series B at $30M pre-money. Your Series A investor (who invested $2M for 15%) has pay-to-play provisions requiring them to invest their pro-rata ($1.5M) or convert to common stock. They're struggling to raise their new fund and can only invest $500K.",
            question: "What's the likely outcome for the Series A investor?",
            opts: [
               "A) They maintain full preferred rights with $500K investment",
               "B) Their preferred converts to common, losing liquidation preference",
               "C) They're forced out of the cap table entirely",
               "D) They negotiate a waiver since they're investing something"
            ],
            correct: 1,
            wrongExplanations: [
               "Pay-to-play specifically prevents this. Partial participation doesn't protect preferred status.",
               "",
               "They don't lose their shares - they just convert from preferred to common stock.",
               "Waivers are possible but the question asks about the 'likely' outcome. The contractual default is conversion."
            ],
            realWorld: "During the 2022 downturn, many funds couldn't meet pay-to-play requirements. Battery Ventures had to let preferred convert in some portfolio companies. This mechanism was designed after the 2001 crash when investors would abandon companies - pay-to-play forces commitment or removes preferential rights. It's actually founder-friendly because it prevents zombie investors who block future rounds while adding no value.",
            concept: "pay_to_play",
            why: "Pay-to-play protects companies from investors who want to maintain preferred status without continued financial commitment. If they don't play (invest pro-rata), they don't pay (keep preferred rights). Conversion to common means: no liquidation preference, no anti-dilution, no protective provisions. It aligns incentives - investors must put more money in to maintain their special rights."
         }
      ];

      const conceptLabels: Record<string, string> = {
         liquidation_preference: "Liquidation Preferences",
         anti_dilution: "Anti-Dilution Protection",
         board_control: "Board Control Dynamics",
         protective_provisions: "Protective Provisions",
         pay_to_play: "Pay-to-Play Provisions"
      };

      const infoTopics: Record<string, string> = {
         liquidation_preference: "Liquidation preference determines who gets paid first in an exit. '1x non-participating' is founder-friendly (VCs choose preference OR participation). '2x participating' is aggressive (VCs get 2x preference AND pro-rata share of remainder).",
         anti_dilution: "Anti-dilution protects investors when you raise at a lower valuation. 'Weighted average' adjusts proportionally. 'Full ratchet' reprices all shares to the new price - very founder-unfriendly.",
         board_control: "Board seats determine who controls major company decisions. The 'independent' director often sides with whoever nominated them. Voting control ‚â† ownership percentage.",
         protective_provisions: "Protective provisions give investors veto rights over specific decisions regardless of ownership. Standard provisions cover: new equity, significant debt, charter changes, M&A, and budget.",
         pay_to_play: "Pay-to-play requires existing investors to invest pro-rata in new rounds to maintain preferred status. If they don't invest, preferred shares convert to common, removing special rights."
      };

      const handleAnswer = (optIndex: number) => {
         if (answered) return;
         setSelected(optIndex);
         setAnswered(true);
         const isCorrect = optIndex === scenarios[scenario].correct;
         const newScore = isCorrect ? score + 1 : score;
         setScore(newScore);
         if (!isCorrect) {
            setConceptGaps([...conceptGaps, scenarios[scenario].concept]);
         }
         setGameLog([...gameLog, `Scenario ${scenario + 1}: ${isCorrect ? 'Correct' : 'Incorrect'} - ${scenarios[scenario].title}`]);
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Term Sheet Expert', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Solid Understanding', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Needs More Study', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Review Fundamentals', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">VC Term Sheet Lab</p>
                  <p className="mb-2">Navigate the terms that determine founder outcomes:</p>
                  <ul className="text-xs space-y-1 opacity-90">
                     <li>‚Ä¢ Liquidation preference mechanics</li>
                     <li>‚Ä¢ Anti-dilution provisions</li>
                     <li>‚Ä¢ Board control dynamics</li>
                     <li>‚Ä¢ Protective provisions impact</li>
                     <li>‚Ä¢ Real cases: Fab.com, Square, Uber</li>
                  </ul>
               </div>
            )}
            <p className="text-6xl mb-4">üèõÔ∏è</p>
            <h2 className="text-3xl font-bold mb-4">VC Term Sheet Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Term sheets determine more than valuation. Learn the provisions that actually decide what founders get in an exit.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-slate-600 rounded-2xl font-bold text-xl hover:bg-slate-500 transition-all">START LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white p-8">
               <div className="text-center mb-6">
                  <p className="text-6xl mb-4">{grade === 'A' ? 'üèõÔ∏è' : grade === 'B' ? '‚≠ê' : 'üìö'}</p>
                  <h2 className="text-2xl font-bold mb-2">Term Sheet Lab Complete</h2>
                  <p className={`text-5xl font-bold ${color}`}>{grade}</p>
                  <p className="text-lg opacity-80">{label}</p>
                  <p className="text-xl mt-2">{score}/{scenarios.length} Correct</p>
               </div>
               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">Review these concepts:</p>
                     <div className="flex flex-wrap gap-2">
                        {[...new Set(conceptGaps)].map((gap, i) => (
                           <span key={i} className="px-3 py-1 bg-slate-500/30 rounded-full text-sm">{conceptLabels[gap]}</span>
                        ))}
                     </div>
                  </div>
               )}
               <div className="bg-black/30 rounded-xl p-4 mb-4 flex-1 overflow-y-auto">
                  <p className="font-bold mb-2">Session Log:</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-sm opacity-80">{log}</p>
                  ))}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }} className="px-6 py-3 bg-slate-600 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white p-4">
            <div className="flex justify-between items-center mb-3">
               <span className="text-sm opacity-70">Scenario {scenario + 1}/{scenarios.length}</span>
               <div className="flex items-center gap-2">
                  <span className="text-sm">Score: {score}/{scenario + (answered ? 1 : 0)}</span>
                  <button onClick={() => { setInfoTopic(infoTopic === s.concept ? null : s.concept); }} className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-sm">‚ÑπÔ∏è</button>
               </div>
            </div>
            {infoTopic && (
               <div className="bg-black/90 p-3 rounded-xl mb-3 text-sm">
                  <p className="font-bold mb-1">{conceptLabels[infoTopic]}</p>
                  <p className="opacity-90">{infoTopics[infoTopic]}</p>
               </div>
            )}
            <div className="bg-black/30 rounded-xl p-3 mb-3">
               <h3 className="font-bold text-slate-400 mb-2">{s.title}</h3>
               <p className="text-sm opacity-90 mb-2">{s.context}</p>
               <p className="font-medium">{s.question}</p>
            </div>
            <div className="flex flex-col gap-2 flex-1 overflow-y-auto">
               {s.opts.map((opt, i) => (
                  <button key={i} onClick={() => handleAnswer(i)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? i === s.correct ? 'bg-green-600/50 border-2 border-green-400' : i === selected ? 'bg-red-600/50 border-2 border-red-400' : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-slate-500/30'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="bg-black/50 rounded-xl p-3 mt-3">
                  {selected !== s.correct && <p className="text-red-400 text-sm mb-2">{s.wrongExplanations[selected!]}</p>}
                  <p className="text-sm mb-2">{s.why}</p>
                  <p className="text-xs text-slate-400 italic">{s.realWorld}</p>
                  <button onClick={nextScenario} className="w-full mt-3 py-2 bg-slate-600 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT SCENARIO ‚Üí' : 'SEE RESULTS'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 49. CROWDFUNDING - Crowdfunding Strategy Lab
   const CrowdfundingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Funding Goal Trap",
            context: "You're launching a Kickstarter for a smart water bottle. Production costs: $50K minimum order (1000 units), tooling $15K, Kickstarter fees 8%, payment processing 3%, shipping $5K. You want to price at $79 to be competitive. Your manufacturing contact says the sweet spot for unit economics is 2000+ units.",
            question: "What funding goal should you set?",
            opts: [
               "A) $79,000 - covers 1000 units at retail price",
               "B) $65,000 - minimum production + tooling costs",
               "C) $95,000 - buffer for fees and unexpected costs",
               "D) $158,000 - optimal 2000 unit batch with all fees"
            ],
            correct: 2,
            wrongExplanations: [
               "$79K sounds right but ignores platform fees (11%), tooling, and shipping. You'd actually lose money hitting this goal.",
               "This covers raw costs but doesn't account for Kickstarter's 8% + 3% processing fees. You'd be short $7K+ before shipping.",
               "",
               "This is the ideal scenario but too ambitious for a first campaign. Higher goals have lower success rates - campaigns that don't fund get nothing."
            ],
            realWorld: "Pebble's original $100K goal was carefully calculated - they knew $100K would prove demand while covering minimum viable production. They raised $10M. The Coolest Cooler set a $50K goal but underestimated production complexity - they raised $13M but couldn't fulfill all orders due to cost overruns. Many campaigns fail by setting goals too low and running out of money after 'success.'",
            concept: "funding_goal",
            why: "Your goal must cover: production ($50K) + tooling ($15K) + shipping ($5K) + platform fees (11% of goal). So: Goal = ($70K) / (1 - 0.11) = ~$78.6K. But add 20% buffer for unexpected costs: ~$95K. Setting a goal that's achievable but fully funded prevents the Coolest Cooler trap - raising money you can't actually use to deliver."
         },
         {
            title: "The Reward Tier Psychology",
            context: "Your smart backpack campaign has three tiers: $49 (early bird, 30% off), $69 (regular), $99 (backpack + accessories bundle). After 48 hours, you've sold 200 early birds, 50 regular, and 10 bundles. The early bird tier is almost sold out.",
            question: "What's the optimal next move?",
            opts: [
               "A) Add more early bird slots - it's clearly what people want",
               "B) Let early bird sell out, add a 'late bird' at $59",
               "C) Remove regular tier - it's not selling well anyway",
               "D) Discount the bundle to $79 to move more units"
            ],
            correct: 1,
            wrongExplanations: [
               "Infinite early birds destroy urgency and devalue your product. Early backers feel cheated. Your per-unit margin also suffers.",
               "",
               "The regular tier serves as a price anchor making the early bird feel valuable. Removing it confuses the value proposition.",
               "Discounting your premium tier signals desperation and reduces perceived value. It also cannibalizes your regular tier sales."
            ],
            realWorld: "Peak Design mastered tier psychology with their Everyday Backpack - limited early bird, then 'late bird,' creating FOMO that drove $6.5M in pledges. The Fidget Cube campaign used scarcity on early bird tiers to create urgency, raising $6.4M. Campaigns that flood the market with endless early birds often stall after initial momentum.",
            concept: "reward_psychology",
            why: "Scarcity creates urgency. When early bird sells out, backers who missed it will pay more rather than wait or miss out entirely. The 'late bird' tier captures this demand at $59 instead of $69, still feeling like a deal. This staged reveal keeps momentum throughout the campaign and maximizes total revenue while maintaining perceived value."
         },
         {
            title: "The Stretch Goal Strategy",
            context: "Your card game campaign funded at $15K in 24 hours. You've hit $40K by day 5 with 25 days left. Your stretch goals are: $50K (premium card stock), $75K (metal coins), $100K (custom card sleeves), $150K (expansion pack). The next 20 days historically see 40% of total pledges.",
            question: "What's wrong with this stretch goal structure?",
            opts: [
               "A) Nothing - these are reasonable incremental improvements",
               "B) Gaps too large - momentum dies between goals",
               "C) Metal coins at $75K will eat into margins significantly",
               "D) Should save expansion pack for a separate campaign"
            ],
            correct: 1,
            wrongExplanations: [
               "The goal amounts might be reasonable, but the structure creates dead zones where nothing happens, killing momentum.",
               "",
               "This might be true but isn't the structural problem. Margin management is important but secondary to momentum.",
               "This is actually good advice for a different reason, but isn't the core structural problem here."
            ],
            realWorld: "Exploding Kittens raised $8.7M with frequent, exciting stretch goals every $500K - constant momentum. Compare to campaigns with $50K gaps that see pledges flatline between goals. Cards Against Humanity's expansions used rapid-fire stretch goals to maintain engagement. The psychology of 'almost there' is powerful - wide gaps kill it.",
            concept: "stretch_goals",
            why: "At $40K with 40% left to come, you'll likely hit ~$67K. Your next goal ($50K) is achievable, but then there's a $25K gap to $75K. You need goals at $50K, $60K, $70K, $80K to maintain momentum. Each unlock creates a dopamine hit and social sharing. Dead zones between goals let backers forget about your campaign. Frequent small wins beat rare big wins."
         },
         {
            title: "The Pre-Launch List Paradox",
            context: "You've spent 3 months building a pre-launch email list of 5,000 subscribers for your portable monitor campaign. Industry average conversion is 2-3%. Your funding goal is $50,000. You're debating whether to launch now or spend another month growing the list.",
            question: "What's the strategic decision?",
            opts: [
               "A) Launch now - 5,000 subscribers at 3% = $50K goal met on day 1",
               "B) Wait - need 10,000+ subscribers to guarantee funding",
               "C) Launch now but lower the goal to $25K for safety",
               "D) Launch now - list size matters less than list engagement"
            ],
            correct: 3,
            wrongExplanations: [
               "Math is wrong. 5,000 √ó 3% = 150 backers. Even at $200 average pledge, that's $30K - below your goal. You're conflating subscribers with dollars.",
               "More subscribers help but an extra month costs momentum and may reduce engagement. Bigger list ‚â† proportionally more conversions.",
               "Lowering the goal might help you fund but could signal lack of confidence and create production problems if you actually need $50K."
            ],
            realWorld: "Tile Bluetooth trackers had a smaller list but incredibly engaged community from their 'founding member' program - they raised $2.6M. Meanwhile, campaigns with 50K cold email subscribers often fail because those subscribers were bought, not built. MVMT watches succeeded with a small but highly engaged Instagram community that shared organically.",
            concept: "list_engagement",
            why: "List size is vanity; engagement is sanity. 1,000 highly engaged subscribers who open every email, share with friends, and are ready to buy will outperform 10,000 cold subscribers who signed up for a giveaway. Before launch, measure: open rates (40%+ is excellent), reply rates, and whether subscribers share your content. An engaged list creates the day-1 spike that triggers algorithmic promotion."
         },
         {
            title: "The Fulfillment Nightmare",
            context: "Your minimalist wallet campaign raised $500K (10x goal). You promised delivery in 4 months. It's now month 3: factory is delayed 6 weeks, shipping costs doubled due to container shortage, and 15% of backers want changes to their orders (color, shipping address). You're getting angry emails.",
            question: "What's the highest-priority action?",
            opts: [
               "A) Focus on factory - nothing else matters until product ships",
               "B) Send detailed update explaining all delays with new timeline",
               "C) Process the 15% order changes before they become cancellations",
               "D) Find alternative shipping to absorb cost and maintain timeline"
            ],
            correct: 1,
            wrongExplanations: [
               "Factory focus is important but silent founders create PR disasters. Backers can handle delays; they can't handle uncertainty.",
               "",
               "Order changes matter but 15% changing is normal. Don't let the vocal minority distract from the 85% patiently waiting.",
               "Absorbing costs on a $500K campaign could mean $50K+ losses. This might bankrupt the project trying to save a few weeks."
            ],
            realWorld: "The Coolest Cooler's biggest failure wasn't delays - it was poor communication. They raised $13M and went nearly silent, creating a PR nightmare. Contrast with Peak Design, who sends weekly video updates during fulfillment, building loyalty for future campaigns. Oculus faced hardware delays but Palmer Luckey's transparent forum posts maintained community trust - they sold to Facebook for $2B.",
            concept: "backer_communication",
            why: "Crowdfunding is a relationship, not a transaction. Backers invested in you, not just the product. Transparent communication - even about bad news - builds trust. The formula: acknowledge the problem, explain why it happened, provide a new realistic timeline, and show you're actively solving it. Most backers are reasonable; they become unreasonable when kept in the dark."
         }
      ];

      const conceptLabels: Record<string, string> = {
         funding_goal: "Funding Goal Math",
         reward_psychology: "Reward Tier Psychology",
         stretch_goals: "Stretch Goal Strategy",
         list_engagement: "List Quality vs. Quantity",
         backer_communication: "Backer Communication"
      };

      const infoTopics: Record<string, string> = {
         funding_goal: "Your funding goal must cover all costs including platform fees (8-10%), payment processing (3%), production, tooling, shipping, and a 20% buffer. Setting it too low means running out of money after 'success.'",
         reward_psychology: "Reward tiers use scarcity (limited early bird), anchoring (higher price makes deals feel better), and bundling (premium tiers with accessories). Urgency drives action.",
         stretch_goals: "Stretch goals maintain momentum throughout a campaign. Small, frequent unlocks beat large gaps. Each unlock triggers dopamine, shares, and renewed backing activity.",
         list_engagement: "An engaged email list (40%+ open rates, active replies) outperforms a large cold list 10:1. Quality subscribers share, comment, and back on day 1 - triggering algorithmic promotion.",
         backer_communication: "Backers tolerate delays but not silence. Weekly updates, even with bad news, build trust and loyalty. Transparent communication turns crowdfunding buyers into lifelong customers."
      };

      const handleAnswer = (optIndex: number) => {
         if (answered) return;
         setSelected(optIndex);
         setAnswered(true);
         const isCorrect = optIndex === scenarios[scenario].correct;
         const newScore = isCorrect ? score + 1 : score;
         setScore(newScore);
         if (!isCorrect) {
            setConceptGaps([...conceptGaps, scenarios[scenario].concept]);
         }
         setGameLog([...gameLog, `Scenario ${scenario + 1}: ${isCorrect ? 'Correct' : 'Incorrect'} - ${scenarios[scenario].title}`]);
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Crowdfunding Expert', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Campaign Ready', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'More Research Needed', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Study the Basics', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">Crowdfunding Strategy Lab</p>
                  <p className="mb-2">Master the strategies that separate successful campaigns:</p>
                  <ul className="text-xs space-y-1 opacity-90">
                     <li>‚Ä¢ Funding goal mathematics</li>
                     <li>‚Ä¢ Reward tier psychology</li>
                     <li>‚Ä¢ Stretch goal momentum</li>
                     <li>‚Ä¢ Pre-launch list building</li>
                     <li>‚Ä¢ Real cases: Pebble, Peak Design, Coolest Cooler</li>
                  </ul>
               </div>
            )}
            <p className="text-6xl mb-4">üöÄ</p>
            <h2 className="text-3xl font-bold mb-4">Crowdfunding Strategy Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-8">Learn why some campaigns raise millions while others fail. Master the strategy behind successful crowdfunding.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-pink-500 rounded-2xl font-bold text-xl hover:bg-pink-400 transition-all">START LAB ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-8">
               <div className="text-center mb-6">
                  <p className="text-6xl mb-4">{grade === 'A' ? 'üöÄ' : grade === 'B' ? '‚≠ê' : 'üìö'}</p>
                  <h2 className="text-2xl font-bold mb-2">Crowdfunding Lab Complete</h2>
                  <p className={`text-5xl font-bold ${color}`}>{grade}</p>
                  <p className="text-lg opacity-80">{label}</p>
                  <p className="text-xl mt-2">{score}/{scenarios.length} Correct</p>
               </div>
               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">Review these concepts:</p>
                     <div className="flex flex-wrap gap-2">
                        {[...new Set(conceptGaps)].map((gap, i) => (
                           <span key={i} className="px-3 py-1 bg-pink-500/30 rounded-full text-sm">{conceptLabels[gap]}</span>
                        ))}
                     </div>
                  </div>
               )}
               <div className="bg-black/30 rounded-xl p-4 mb-4 flex-1 overflow-y-auto">
                  <p className="font-bold mb-2">Session Log:</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-sm opacity-80">{log}</p>
                  ))}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }} className="px-6 py-3 bg-pink-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-pink-900 via-rose-900 to-red-900 text-white p-4">
            <div className="flex justify-between items-center mb-3">
               <span className="text-sm opacity-70">Scenario {scenario + 1}/{scenarios.length}</span>
               <div className="flex items-center gap-2">
                  <span className="text-sm">Score: {score}/{scenario + (answered ? 1 : 0)}</span>
                  <button onClick={() => { setInfoTopic(infoTopic === s.concept ? null : s.concept); }} className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-sm">‚ÑπÔ∏è</button>
               </div>
            </div>
            {infoTopic && (
               <div className="bg-black/90 p-3 rounded-xl mb-3 text-sm">
                  <p className="font-bold mb-1">{conceptLabels[infoTopic]}</p>
                  <p className="opacity-90">{infoTopics[infoTopic]}</p>
               </div>
            )}
            <div className="bg-black/30 rounded-xl p-3 mb-3">
               <h3 className="font-bold text-pink-400 mb-2">{s.title}</h3>
               <p className="text-sm opacity-90 mb-2">{s.context}</p>
               <p className="font-medium">{s.question}</p>
            </div>
            <div className="flex flex-col gap-2 flex-1 overflow-y-auto">
               {s.opts.map((opt, i) => (
                  <button key={i} onClick={() => handleAnswer(i)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? i === s.correct ? 'bg-green-600/50 border-2 border-green-400' : i === selected ? 'bg-red-600/50 border-2 border-red-400' : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-pink-500/30'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="bg-black/50 rounded-xl p-3 mt-3">
                  {selected !== s.correct && <p className="text-red-400 text-sm mb-2">{s.wrongExplanations[selected!]}</p>}
                  <p className="text-sm mb-2">{s.why}</p>
                  <p className="text-xs text-pink-400 italic">{s.realWorld}</p>
                  <button onClick={nextScenario} className="w-full mt-3 py-2 bg-pink-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT SCENARIO ‚Üí' : 'SEE RESULTS'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // 50. PITCH DECK - Pitch Deck Builder
   const PitchDeckRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Problem Slide Trap",
            context: "You're pitching a B2B HR software to automate performance reviews. Your problem slide says: 'Performance reviews are broken. 85% of HR leaders say annual reviews are ineffective. Our AI-powered platform transforms this outdated process.'",
            question: "What's wrong with this problem slide?",
            opts: [
               "A) The statistic isn't compelling enough - need more data",
               "B) It's too abstract - doesn't show who loses money and how much",
               "C) It focuses on the symptom (reviews) not the root cause",
               "D) Nothing wrong - it has a stat and mentions the solution"
            ],
            correct: 1,
            wrongExplanations: [
               "Adding more statistics won't fix the core issue. Investors don't care about 'broken reviews' - they care about measurable business impact. Stats without dollar signs are academic.",
               "",
               "The symptom/cause distinction matters for product development, but investors want to know ONE thing: whose wallet is this hurting and by how much?",
               "This slide commits the cardinal sin of pitch decks: it's investor-forgettable. After 10 pitches, an investor won't remember your 85% stat but they'll remember '$47B lost to turnover caused by bad reviews.'"
            ],
            realWorld: "Airbnb's legendary pitch deck didn't say 'hotels are expensive.' It said '$10.6 billion spent on travel accommodations annually, with average hotel stay costing $150/night.' Specific numbers create urgency.",
            concept: "problem_quantification",
            why: "The problem slide must answer: WHO has this problem, HOW MUCH is it costing them, and HOW MANY have it? Your slide needs: 'Enterprise companies lose $47B annually to employee turnover. Bad performance feedback is cited as #1 reason for leaving (Gallup 2023). A 1,000-person company loses $4.7M/year.' Now investors see the dollar opportunity."
         },
         {
            title: "Market Size Credibility",
            context: "Your fintech app helps small businesses manage invoices. Your market slide shows: TAM: $240B global fintech market, SAM: $45B SMB financial tools, SOM: $2B invoice management. An investor asks: 'How did you calculate your SOM?'",
            question: "What's the most fundable answer?",
            opts: [
               "A) Industry reports from Gartner and McKinsey estimate the invoice market at $2B",
               "B) We calculated bottom-up: 30M SMBs √ó $67 average annual spend on invoicing = $2B",
               "C) We're targeting 0.8% of SAM which is conservative for a 5-year horizon",
               "D) Our competitors' combined revenue suggests a $2B addressable market"
            ],
            correct: 1,
            wrongExplanations: [
               "Top-down analysis from industry reports is lazy and shows you haven't done the work. Every pitch deck cites the same Gartner reports. Investors have seen these numbers 100 times.",
               "",
               "Percentage-of-SAM is the weakest possible answer. It shows you don't understand your specific customer. How do you get 0.8%? Magic?",
               "Competitor revenue analysis is useful but doesn't show YOUR path to market. It also suggests a crowded market with established players."
            ],
            realWorld: "When Uber pitched, they didn't say 'the taxi market is $100B.' They calculated: '3 million rides/day in SF √ó $15 average fare √ó 20% take rate = $3.3M/day potential in SF alone. Expand to 50 cities = X.' Investors could verify the logic.",
            concept: "bottom_up_sizing",
            why: "Bottom-up market sizing shows you understand your specific customer economics. '30M SMBs' is verifiable (SBA data), '$67/year' is testable (survey your users), the multiplication is transparent. Investors can poke holes in your assumptions - that's the point. Weak assumptions get fixed; made-up TAM numbers get you shown the door."
         },
         {
            title: "Traction vs. Vanity",
            context: "Your social commerce platform is 8 months old. Your traction slide shows: 50,000 app downloads, 12,000 registered users, 2,400 weekly active users, $18,000 GMV last month, 156% month-over-month growth in DAUs.",
            question: "Which metric should you lead with to maximize investor interest?",
            opts: [
               "A) 50,000 downloads - shows strong market interest",
               "B) 156% MoM DAU growth - shows explosive growth trajectory",
               "C) $18,000 GMV - proves real economic activity",
               "D) 2,400 weekly active users - shows engaged community"
            ],
            correct: 2,
            wrongExplanations: [
               "Downloads are the ultimate vanity metric. 50,000 downloads with 2,400 WAU means 95% of users abandoned your app. This actually raises red flags about product-market fit.",
               "156% MoM sounds amazing but investors will ask 'from what base?' Going from 50 DAUs to 128 DAUs is 156% growth but meaningless. Percentage growth without absolute numbers is a red flag.",
               "",
               "2,400 WAU is a honest number but doesn't show business viability. Social platforms often have engaged users who never pay. Instagram had millions of users before any revenue."
            ],
            realWorld: "DoorDash's early pitch focused on GMV per restaurant ($4,000/month) and unit economics (25% take rate). They could have shown user growth, but GMV proved the business model worked. They raised $2.4M seed on $26K monthly GMV.",
            concept: "revenue_metrics",
            why: "$18,000 GMV is the only number that proves paying customers exist. From this, investors can calculate: take rate, customer acquisition cost, and path to profitability. Lead with GMV, then show 156% growth in GMV, then mention the user numbers as supporting context. Revenue metrics > engagement metrics > vanity metrics."
         },
         {
            title: "The Competition Slide Mistake",
            context: "Your AI writing tool competes with Jasper, Copy.ai, and ChatGPT. Your competition slide shows a 2x2 matrix with 'Price' and 'Quality' axes. You're positioned in the 'High Quality, Low Price' corner. All competitors are in other quadrants.",
            question: "Why will this slide hurt your fundraise?",
            opts: [
               "A) You shouldn't include ChatGPT - it's too dominant",
               "B) 2x2 matrices are outdated - investors want feature comparison tables",
               "C) Claiming 'best quality, lowest price' signals you don't understand your differentiation",
               "D) You need more competitors on the slide to show market validation"
            ],
            correct: 2,
            wrongExplanations: [
               "Excluding ChatGPT would be worse - it shows you're afraid of the elephant in the room. Every AI pitch must address the OpenAI question directly.",
               "2x2 matrices are perfectly fine. The format isn't the problem - the axes and positioning are the problem.",
               "",
               "More competitors wouldn't fix the fundamental issue. The problem is that 'high quality + low price' is what EVERYONE claims. It's meaningless."
            ],
            realWorld: "Figma's competition slide didn't claim 'better than Sketch.' It positioned on 'Collaboration vs. Individual' and 'Browser vs. Desktop.' They picked axes where they naturally won. Adobe paid $20B for a company that never claimed to be 'better quality.'",
            concept: "strategic_positioning",
            why: "'Best quality, lowest price' is impossible and investors know it. It signals either: you're lying, or you don't understand your costs. Pick axes where you genuinely win: 'Built for non-writers vs. Built for professionals' or 'Real-time collaboration vs. Solo creation.' Position yourself in a quadrant that competitors can't easily enter without abandoning their core business."
         },
         {
            title: "The Ask Slide Execution",
            context: "You're raising a $3M seed round for your EdTech platform. Your ask slide says: 'Raising $3M seed round. Use of funds: 40% Engineering, 30% Sales & Marketing, 20% Operations, 10% Reserve.'",
            question: "How should you restructure this ask to maximize investor confidence?",
            opts: [
               "A) Add specific milestones: '$3M gets us to $1M ARR in 18 months'",
               "B) Show detailed hiring plan: '6 engineers, 3 sales reps, 2 ops'",
               "C) Link spend to metrics: '$1.2M engineering = ship mobile app ‚Üí 40% retention boost ‚Üí hit $2M ARR milestone for Series A'",
               "D) Include comparable raises: 'Similar stage EdTech companies raised $2-4M'"
            ],
            correct: 2,
            wrongExplanations: [
               "Milestones are necessary but not sufficient. '$1M ARR in 18 months' doesn't explain HOW you get there. Investors need to see the causal logic between spending and outcomes.",
               "Headcount plans are operational details, not strategy. '6 engineers' means nothing unless investors know what those engineers build and how it drives revenue.",
               "",
               "Comparable raises are irrelevant - they show what market rate is, not why YOU deserve funding. Investors are buying your future outcomes, not market averages."
            ],
            realWorld: "Notion's seed deck broke down: '$1.5M ‚Üí Build mobile app + API ‚Üí 80% of enterprise contracts require mobile ‚Üí Expected 3x enterprise conversion = $X ARR ‚Üí Series A ready.' Each dollar had a causal chain to revenue.",
            concept: "milestone_mapping",
            why: "The ask slide must show CAUSATION: Money ‚Üí Action ‚Üí Measurable Output ‚Üí Revenue Impact ‚Üí Next Fundraise Readiness. '$1.2M engineering ‚Üí mobile app ‚Üí 40% retention boost ‚Üí $2M ARR ‚Üí Series A metrics achieved.' Now investors can verify each link. If they don't believe mobile improves retention, they'll say so. If they do believe it, they'll fund it."
         }
      ];

      const conceptLabels: Record<string, string> = {
         'problem_quantification': 'Problem Quantification',
         'bottom_up_sizing': 'Bottom-Up Market Sizing',
         'revenue_metrics': 'Revenue Metrics Priority',
         'strategic_positioning': 'Strategic Positioning',
         'milestone_mapping': 'Milestone Mapping'
      };

      const infoTopics: Record<string, string> = {
         'deck_flow': "The best decks follow: Problem ‚Üí Solution ‚Üí Why Now ‚Üí Market Size ‚Üí Product ‚Üí Traction ‚Üí Team ‚Üí Business Model ‚Üí Competition ‚Üí Ask. Each slide answers a question the previous slide raises.",
         'investor_time': "VCs spend 3 minutes 44 seconds on average reviewing a deck. Front-load key metrics. If they don't see traction by slide 5, they stop reading.",
         'slides_count': "10-15 slides maximum. Each slide should have ONE message. If you need two messages, make two slides. Dense slides kill momentum.",
         'social_proof': "Warm intros convert 50%+ while cold emails convert <1%. Name-drop advisors, customers, and existing investors early to build credibility.",
         'appendix': "Put detailed financials, technical architecture, and market research in an appendix. Reference them ('see slide 18 for projections') but don't clutter the narrative."
      };

      const handleAnswer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(score + 1);
            setGameLog([...gameLog, `‚úì ${s.title}: Correct`]);
         } else {
            setConceptGaps([...conceptGaps, s.concept]);
            setGameLog([...gameLog, `‚úó ${s.title}: Wrong - Gap in ${conceptLabels[s.concept]}`]);
         }
      };

      const nextScenario = () => {
         if (scenario < scenarios.length - 1) {
            setScenario(scenario + 1);
            setSelected(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const getGrade = () => {
         const pct = (score / scenarios.length) * 100;
         if (pct >= 80) return { grade: 'A', label: 'Pitch Pro', color: 'text-green-400' };
         if (pct >= 60) return { grade: 'B', label: 'Fundable Founder', color: 'text-blue-400' };
         if (pct >= 40) return { grade: 'C', label: 'Deck Doctor Needed', color: 'text-yellow-400' };
         return { grade: 'D', label: 'Back to Drawing Board', color: 'text-red-400' };
      };

      if (phase === 'intro') return (
         <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-blue-900 via-purple-900 to-pink-900 text-white p-8 text-center">
            <button onClick={() => setShowInfo(!showInfo)} className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">‚ÑπÔ∏è</button>
            {showInfo && (
               <div className="absolute top-16 right-4 bg-black/90 p-4 rounded-xl max-w-xs text-left text-sm z-10">
                  <p className="font-bold mb-2">üìë Pitch Deck Mastery</p>
                  <p className="mb-2">What separates funded decks from rejected ones:</p>
                  <div className="space-y-1 text-xs">
                     {Object.entries(infoTopics).map(([key, value]) => (
                        <div key={key} className="bg-white/10 p-2 rounded cursor-pointer hover:bg-white/20" onClick={() => setInfoTopic(key)}>
                           {key.replace(/_/g, ' ').toUpperCase()}
                        </div>
                     ))}
                  </div>
                  {infoTopic && <p className="mt-2 text-xs bg-purple-500/20 p-2 rounded">{infoTopics[infoTopic]}</p>}
               </div>
            )}
            <p className="text-6xl mb-4">üìë</p>
            <h2 className="text-3xl font-bold mb-4">Pitch Deck Mastery Lab</h2>
            <p className="text-lg opacity-80 max-w-md mb-4">Learn what makes the difference between funded and forgotten pitch decks.</p>
            <p className="text-sm opacity-60 max-w-md mb-8">5 scenarios analyzing real pitch deck mistakes and the psychology behind investor decisions. Based on decks from Airbnb, Uber, DoorDash, Figma, and Notion.</p>
            <button onClick={() => setPhase('play')} className="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl font-bold text-xl hover:opacity-90 transition-all">START DECK REVIEW ‚Üí</button>
         </div>
      );

      if (phase === 'result') {
         const { grade, label, color } = getGrade();
         const uniqueGaps = [...new Set(conceptGaps)];
         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-purple-900 to-pink-900 text-white p-8 overflow-y-auto">
               <div className="text-center mb-6">
                  <p className={`text-6xl font-bold ${color}`}>{grade}</p>
                  <p className="text-xl mt-2">{label}</p>
                  <p className="text-sm opacity-70 mt-1">{score}/{scenarios.length} slides mastered</p>
               </div>
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üìä Deck Review Log</p>
                  {gameLog.map((log, i) => (
                     <p key={i} className={`text-sm ${log.startsWith('‚úì') ? 'text-green-400' : 'text-red-400'}`}>{log}</p>
                  ))}
               </div>
               {uniqueGaps.length > 0 && (
                  <div className="bg-red-500/20 rounded-xl p-4 mb-4">
                     <p className="font-bold mb-2">üìö Concepts to Study</p>
                     {uniqueGaps.map(gap => (
                        <p key={gap} className="text-sm">‚Ä¢ {conceptLabels[gap]}</p>
                     ))}
                  </div>
               )}
               <div className="bg-purple-500/20 rounded-xl p-4 mb-4">
                  <p className="font-bold mb-2">üéØ Pitch Deck Principles</p>
                  <p className="text-sm">‚Ä¢ Quantify the problem in dollars lost</p>
                  <p className="text-sm">‚Ä¢ Bottom-up market sizing beats top-down</p>
                  <p className="text-sm">‚Ä¢ Lead with revenue metrics over vanity</p>
                  <p className="text-sm">‚Ä¢ Position on axes where you win</p>
                  <p className="text-sm">‚Ä¢ Map every dollar to measurable outcomes</p>
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setSelected(null); setAnswered(false); setGameLog([]); setConceptGaps([]); }}
                  className="mt-auto px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold">TRY AGAIN</button>
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-purple-900 to-pink-900 text-white p-6 overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
               <span className="bg-black/30 px-3 py-1 rounded-lg text-sm">Slide {scenario + 1}/5</span>
               <span className="bg-purple-500/30 px-3 py-1 rounded-lg text-sm font-bold">{score} correct</span>
            </div>
            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h3 className="font-bold text-lg text-purple-400 mb-2">{s.title}</h3>
               <p className="text-sm leading-relaxed opacity-90">{s.context}</p>
            </div>
            <p className="font-bold mb-3">{s.question}</p>
            <div className="flex flex-col gap-2 mb-4">
               {s.opts.map((opt, idx) => (
                  <button key={idx} onClick={() => handleAnswer(idx)} disabled={answered}
                     className={`p-3 rounded-xl text-left text-sm transition-all ${
                        answered
                           ? idx === s.correct
                              ? 'bg-green-500/40 border-2 border-green-400'
                              : idx === selected
                                 ? 'bg-red-500/40 border-2 border-red-400'
                                 : 'bg-black/20 opacity-50'
                           : 'bg-black/30 hover:bg-purple-500/20'
                     }`}>
                     {opt}
                  </button>
               ))}
            </div>
            {answered && (
               <div className="space-y-3 mb-4">
                  {selected !== s.correct && (
                     <div className="bg-red-500/20 rounded-xl p-3">
                        <p className="font-bold text-red-400 text-sm">Why that's wrong:</p>
                        <p className="text-sm opacity-90">{s.wrongExplanations[selected!]}</p>
                     </div>
                  )}
                  <div className="bg-green-500/20 rounded-xl p-3">
                     <p className="font-bold text-green-400 text-sm">The investor lens:</p>
                     <p className="text-sm opacity-90">{s.why}</p>
                  </div>
                  <div className="bg-blue-500/20 rounded-xl p-3">
                     <p className="font-bold text-blue-400 text-sm">üìö Real Deck Example:</p>
                     <p className="text-sm opacity-90">{s.realWorld}</p>
                  </div>
                  <button onClick={nextScenario} className="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold">
                     {scenario < scenarios.length - 1 ? 'NEXT SLIDE ‚Üí' : 'SEE RESULTS ‚Üí'}
                  </button>
               </div>
            )}
         </div>
      );
   };

   // ============================================================================
   // SECTION VI: OPERATIONS & MANAGEMENT - SUPPLY CHAIN MANAGEMENT
   // ============================================================================
   const SupplyChainRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [day, setDay] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      // Supply chain stages with inventory
      const [stages, setStages] = useState([
         { id: 'supplier', name: 'Supplier', icon: 'üåø', inventory: 100, capacity: 200, leadTime: 2 },
         { id: 'manufacturer', name: 'Manufacturer', icon: 'üè≠', inventory: 50, capacity: 100, leadTime: 1 },
         { id: 'warehouse', name: 'Warehouse', icon: 'üì¶', inventory: 30, capacity: 80, leadTime: 1 },
         { id: 'distributor', name: 'Distributor', icon: 'üöö', inventory: 20, capacity: 50, leadTime: 1 },
         { id: 'retailer', name: 'Retailer', icon: 'üè™', inventory: 15, capacity: 30, leadTime: 0 },
      ]);

      // Game metrics
      const [money, setMoney] = useState(10000);
      const [customerSatisfaction, setCustomerSatisfaction] = useState(100);
      const [ordersDelivered, setOrdersDelivered] = useState(0);
      const [ordersMissed, setOrdersMissed] = useState(0);
      const [totalCost, setTotalCost] = useState(0);

      // Current order settings
      const [orderQty, setOrderQty] = useState(20);
      const [selectedSupplier, setSelectedSupplier] = useState<'cheap' | 'reliable' | 'fast'>('reliable');

      // Events and disruptions
      const [currentEvent, setCurrentEvent] = useState<{ type: string; message: string; effect: string } | null>(null);
      const [pendingOrders, setPendingOrders] = useState<{ qty: number; arriveDay: number; stage: string }[]>([]);

      // Daily customer demand (varies)
      const [dailyDemand, setDailyDemand] = useState(10);

      const suppliers = {
         cheap: { name: 'Budget Supply Co', cost: 5, reliability: 60, leadTime: 4, icon: 'üí∞' },
         reliable: { name: 'Steady Partners', cost: 10, reliability: 95, leadTime: 2, icon: 'ü§ù' },
         fast: { name: 'Express Logistics', cost: 15, reliability: 80, leadTime: 1, icon: '‚ö°' },
      };

      const events = [
         { type: 'demand_spike', message: 'üìà Viral social media post! Demand doubled!', effect: 'Customer demand increased to 20 units' },
         { type: 'supplier_delay', message: '‚ö†Ô∏è Shipping container stuck at port!', effect: 'All incoming orders delayed by 2 days' },
         { type: 'quality_issue', message: 'üîç Quality inspection failed!', effect: 'Lost 10 units from manufacturer inventory' },
         { type: 'competitor_sale', message: 'üè∑Ô∏è Competitor launched big sale!', effect: 'Customer demand reduced to 5 units' },
         { type: 'fuel_costs', message: '‚õΩ Fuel prices surged!', effect: 'Shipping costs +$200 this round' },
         { type: 'good_news', message: 'üåü Supplier gave bulk discount!', effect: 'Next order costs 50% less' },
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         supplychain: {
            title: 'What is Supply Chain?',
            content: 'A supply chain is the network of all individuals, organizations, resources, activities, and technology involved in creating and selling a product. It spans from raw materials to delivering the final product to customers.'
         },
         leadtime: {
            title: 'Lead Time',
            content: 'Lead time is the delay between placing an order and receiving it. Longer lead times require more safety stock but often cost less. Shorter lead times are more expensive but reduce risk.'
         },
         bullwhip: {
            title: 'Bullwhip Effect',
            content: 'Small changes in customer demand can cause larger and larger fluctuations up the supply chain. A 10% increase at retail might become a 40% swing at the manufacturer level!'
         },
         inventory: {
            title: 'Inventory Management',
            content: 'Holding inventory costs money (storage, insurance, obsolescence) but protects against stockouts. The goal is finding the right balance - not too much, not too little.'
         },
         supplier: {
            title: 'Supplier Selection',
            content: 'Choosing suppliers involves tradeoffs: cheap suppliers may be unreliable, fast suppliers cost more. Diversifying suppliers reduces risk but increases complexity.'
         },
         satisfaction: {
            title: 'Customer Satisfaction',
            content: 'When you cannot fulfill customer demand (stockout), satisfaction drops. Unhappy customers may leave permanently. Maintaining adequate inventory prevents this.'
         }
      };

      const processDay = () => {
         let newLog: string[] = [];
         let costThisRound = 0;

         // Check for random event (30% chance)
         if (Math.random() < 0.3) {
            const event = events[Math.floor(Math.random() * events.length)];
            setCurrentEvent(event);
            newLog.push(`EVENT: ${event.message}`);

            // Apply event effects
            if (event.type === 'demand_spike') setDailyDemand(20);
            if (event.type === 'competitor_sale') setDailyDemand(5);
            if (event.type === 'quality_issue') {
               setStages(prev => prev.map(s => s.id === 'manufacturer' ? { ...s, inventory: Math.max(0, s.inventory - 10) } : s));
            }
            if (event.type === 'fuel_costs') costThisRound += 200;
            if (event.type === 'supplier_delay') {
               setPendingOrders(prev => prev.map(o => ({ ...o, arriveDay: o.arriveDay + 2 })));
            }
         } else {
            setCurrentEvent(null);
            setDailyDemand(10 + Math.floor(Math.random() * 6) - 3); // 7-13 base demand
         }

         // Process arriving orders
         const arrivingOrders = pendingOrders.filter(o => o.arriveDay <= day);
         arrivingOrders.forEach(order => {
            setStages(prev => prev.map(s =>
               s.id === order.stage ? { ...s, inventory: Math.min(s.capacity, s.inventory + order.qty) } : s
            ));
            newLog.push(`üì¶ ${order.qty} units arrived at ${order.stage}`);
         });
         setPendingOrders(prev => prev.filter(o => o.arriveDay > day));

         // Move inventory through the chain (simplified flow)
         setStages(prev => {
            const updated = [...prev];
            for (let i = updated.length - 2; i >= 0; i--) {
               const current = updated[i];
               const next = updated[i + 1];
               const transfer = Math.min(current.inventory, next.capacity - next.inventory, 15);
               if (transfer > 0) {
                  updated[i] = { ...current, inventory: current.inventory - transfer };
                  updated[i + 1] = { ...next, inventory: next.inventory + transfer };
               }
            }
            return updated;
         });

         // Fulfill customer demand from retailer
         const retailer = stages.find(s => s.id === 'retailer')!;
         const fulfilled = Math.min(retailer.inventory, dailyDemand);
         const missed = dailyDemand - fulfilled;

         if (fulfilled > 0) {
            setStages(prev => prev.map(s => s.id === 'retailer' ? { ...s, inventory: s.inventory - fulfilled } : s));
            setOrdersDelivered(prev => prev + fulfilled);
            newLog.push(`‚úÖ Delivered ${fulfilled} units to customers`);
         }

         if (missed > 0) {
            setOrdersMissed(prev => prev + missed);
            setCustomerSatisfaction(prev => Math.max(0, prev - missed * 5));
            newLog.push(`‚ùå Stockout! Missed ${missed} orders. Satisfaction -${missed * 5}%`);
         }

         // Calculate holding costs ($1 per unit per day)
         const holdingCost = stages.reduce((sum, s) => sum + s.inventory, 0);
         costThisRound += holdingCost;

         setTotalCost(prev => prev + costThisRound);
         setMoney(prev => prev - costThisRound + fulfilled * 25); // Revenue per unit
         newLog.push(`üíµ Revenue: +$${fulfilled * 25} | Costs: -$${costThisRound}`);

         setGameLog(prev => [...prev, `--- Day ${day} ---`, ...newLog]);

         if (day >= 10) {
            setPhase('result');
         } else {
            setDay(d => d + 1);
         }
      };

      const placeOrder = () => {
         const supplier = suppliers[selectedSupplier];
         const cost = orderQty * supplier.cost;

         // Check reliability (order might fail)
         const orderSucceeds = Math.random() * 100 < supplier.reliability;

         if (orderSucceeds) {
            setPendingOrders(prev => [...prev, {
               qty: orderQty,
               arriveDay: day + supplier.leadTime,
               stage: 'supplier'
            }]);
            setMoney(prev => prev - cost);
            setTotalCost(prev => prev + cost);
            setGameLog(prev => [...prev, `üìã Ordered ${orderQty} units from ${supplier.name} ($${cost}) - arrives Day ${day + supplier.leadTime}`]);
         } else {
            setGameLog(prev => [...prev, `‚ö†Ô∏è Order from ${supplier.name} FAILED! (Reliability: ${supplier.reliability}%)`]);
         }
      };

      const startGame = () => {
         setPhase('play');
         setDay(1);
         setMoney(10000);
         setCustomerSatisfaction(100);
         setOrdersDelivered(0);
         setOrdersMissed(0);
         setTotalCost(0);
         setGameLog([]);
         setPendingOrders([]);
         setStages([
            { id: 'supplier', name: 'Supplier', icon: 'üåø', inventory: 100, capacity: 200, leadTime: 2 },
            { id: 'manufacturer', name: 'Manufacturer', icon: 'üè≠', inventory: 50, capacity: 100, leadTime: 1 },
            { id: 'warehouse', name: 'Warehouse', icon: 'üì¶', inventory: 30, capacity: 80, leadTime: 1 },
            { id: 'distributor', name: 'Distributor', icon: 'üöö', inventory: 20, capacity: 50, leadTime: 1 },
            { id: 'retailer', name: 'Retailer', icon: 'üè™', inventory: 15, capacity: 30, leadTime: 0 },
         ]);
      };

      const getGameSummary = () => {
         const deliveryRate = ordersDelivered > 0 ? Math.round((ordersDelivered / (ordersDelivered + ordersMissed)) * 100) : 0;
         const profit = money - 10000;
         const score = Math.round((customerSatisfaction * 0.4) + (deliveryRate * 0.4) + (profit > 0 ? 20 : profit > -2000 ? 10 : 0));
         return { deliveryRate, profit, score };
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-800 via-slate-700 to-zinc-800 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-2xl font-black flex items-center gap-2">‚õìÔ∏è SUPPLY CHAIN MANAGEMENT</h2>
                  <p className="text-slate-300 text-sm mt-1">Master the flow from supplier to customer</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all">‚ÑπÔ∏è</button>
            </div>

            {showInfo && (
               <div className="bg-black/40 rounded-xl p-4 mb-4 text-sm border border-slate-500/30">
                  <p className="font-bold text-slate-200 mb-2">üìö What You'll Learn:</p>
                  <ul className="space-y-1 text-slate-300">
                     <li>‚Ä¢ How products flow from raw materials to customers</li>
                     <li>‚Ä¢ The tradeoffs between cost, speed, and reliability</li>
                     <li>‚Ä¢ Why inventory management matters</li>
                     <li>‚Ä¢ How disruptions ripple through a supply chain</li>
                  </ul>
               </div>
            )}

            <div className="flex-1 flex flex-col justify-center">
               {/* Visual supply chain diagram */}
               <div className="bg-black/30 rounded-2xl p-4 mb-6">
                  <p className="text-center text-slate-400 text-xs mb-4 font-bold uppercase tracking-wider">The 5 Stages of Supply Chain</p>
                  <div className="flex justify-between items-center overflow-x-auto pb-2">
                     {[
                        { icon: 'üåø', name: 'Supplier', desc: 'Raw materials' },
                        { icon: 'üè≠', name: 'Manufacturer', desc: 'Production' },
                        { icon: 'üì¶', name: 'Warehouse', desc: 'Storage' },
                        { icon: 'üöö', name: 'Distributor', desc: 'Transport' },
                        { icon: 'üè™', name: 'Retailer', desc: 'Sales' },
                     ].map((stage, i) => (
                        <React.Fragment key={stage.name}>
                           <div className="flex flex-col items-center min-w-[70px]">
                              <div className="w-14 h-14 rounded-xl bg-slate-600/50 flex items-center justify-center text-2xl mb-1">{stage.icon}</div>
                              <span className="text-xs font-bold">{stage.name}</span>
                              <span className="text-[10px] text-slate-400">{stage.desc}</span>
                           </div>
                           {i < 4 && <span className="text-slate-500 mx-1">‚Üí</span>}
                        </React.Fragment>
                     ))}
                  </div>
               </div>

               <div className="text-center mb-6">
                  <h3 className="text-xl font-bold mb-2">üéÆ Your Mission</h3>
                  <p className="text-slate-300 max-w-lg mx-auto">
                     Run a 10-day supply chain simulation. Order inventory, choose suppliers wisely,
                     and handle disruptions to maximize profits and customer satisfaction!
                  </p>
               </div>

               <div className="grid grid-cols-3 gap-3 mb-6 max-w-md mx-auto">
                  <div className="bg-green-900/40 rounded-xl p-3 text-center border border-green-500/30">
                     <span className="text-2xl">üí∞</span>
                     <p className="text-xs font-bold mt-1">Balance Budget</p>
                  </div>
                  <div className="bg-blue-900/40 rounded-xl p-3 text-center border border-blue-500/30">
                     <span className="text-2xl">üòä</span>
                     <p className="text-xs font-bold mt-1">Keep Customers Happy</p>
                  </div>
                  <div className="bg-purple-900/40 rounded-xl p-3 text-center border border-purple-500/30">
                     <span className="text-2xl">üì¶</span>
                     <p className="text-xs font-bold mt-1">Avoid Stockouts</p>
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-8 py-4 bg-gradient-to-r from-slate-600 to-zinc-600 hover:from-slate-500 hover:to-zinc-500 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                  START SIMULATION ‚Üí
               </button>
            </div>

            <p className="text-xs text-slate-400/60 text-center mt-4">üí° Tip: Click the ‚ÑπÔ∏è buttons during gameplay for more information on supply chain concepts.</p>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const { deliveryRate, profit, score } = getGameSummary();
         const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
         const gradeColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-blue-400' : score >= 40 ? 'text-yellow-400' : 'text-red-400';

         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-slate-800 via-slate-700 to-zinc-800 text-white p-6 overflow-auto">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-2">{score >= 80 ? 'üèÜ' : score >= 60 ? 'üåü' : score >= 40 ? 'üìä' : 'üìâ'}</div>
                  <h2 className="text-3xl font-black">Simulation Complete!</h2>
                  <p className={`text-5xl font-black mt-2 ${gradeColor}`}>Grade: {grade}</p>
               </div>

               <div className="grid grid-cols-2 gap-4 mb-6 max-w-md mx-auto">
                  <div className="bg-black/30 rounded-xl p-4 text-center">
                     <p className="text-2xl font-black text-green-400">${profit >= 0 ? '+' : ''}{profit}</p>
                     <p className="text-xs text-slate-400">Profit/Loss</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-4 text-center">
                     <p className="text-2xl font-black text-blue-400">{customerSatisfaction}%</p>
                     <p className="text-xs text-slate-400">Satisfaction</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-4 text-center">
                     <p className="text-2xl font-black text-purple-400">{deliveryRate}%</p>
                     <p className="text-xs text-slate-400">Delivery Rate</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-4 text-center">
                     <p className="text-2xl font-black text-amber-400">{ordersDelivered}</p>
                     <p className="text-xs text-slate-400">Orders Delivered</p>
                  </div>
               </div>

               <div className="bg-indigo-900/40 rounded-xl p-4 mb-6 border border-indigo-500/30">
                  <p className="font-bold text-indigo-300 mb-2 flex items-center gap-2">
                     <span className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-sm">üí°</span>
                     Key Takeaways
                  </p>
                  <ul className="text-sm text-indigo-200 space-y-1">
                     <li>‚Ä¢ <strong>Buffer stock</strong> protects against demand variability</li>
                     <li>‚Ä¢ <strong>Supplier choice</strong> involves cost-reliability-speed tradeoffs</li>
                     <li>‚Ä¢ <strong>Lead times</strong> mean you must plan orders ahead</li>
                     <li>‚Ä¢ <strong>Disruptions</strong> can cascade through the entire chain</li>
                  </ul>
               </div>

               <div className="bg-black/20 rounded-xl p-3 mb-6 max-h-32 overflow-auto">
                  <p className="text-xs font-bold text-slate-400 mb-2">üìã Session Log (for AI Coach review)</p>
                  <div className="text-xs text-slate-500 space-y-0.5">
                     {gameLog.slice(-10).map((log, i) => <p key={i}>{log}</p>)}
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-6 py-3 bg-gradient-to-r from-slate-600 to-zinc-600 hover:from-slate-500 hover:to-zinc-500 rounded-xl font-bold transition-all">
                  üîÑ PLAY AGAIN
               </button>
            </div>
         );
      }

      // PLAY PHASE
      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-slate-800 via-slate-700 to-zinc-800 text-white overflow-hidden">
            {/* Header with metrics */}
            <div className="p-3 bg-black/30 border-b border-slate-600/50">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-black">üìÖ Day {day} / 10</span>
                  <div className="flex gap-2">
                     <span className="px-3 py-1 bg-green-900/50 rounded-full text-sm font-bold text-green-300">üí∞ ${money}</span>
                     <span className="px-3 py-1 bg-blue-900/50 rounded-full text-sm font-bold text-blue-300">üòä {customerSatisfaction}%</span>
                  </div>
               </div>
               <div className="flex gap-2 text-xs">
                  <span className="text-slate-400">Delivered: {ordersDelivered}</span>
                  <span className="text-slate-500">|</span>
                  <span className="text-slate-400">Missed: {ordersMissed}</span>
                  <span className="text-slate-500">|</span>
                  <span className="text-slate-400">Today's Demand: {dailyDemand}</span>
               </div>
            </div>

            {/* Info modal */}
            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-slate-800 rounded-2xl p-6 max-w-md border border-slate-600" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">
                        ‚ÑπÔ∏è {infoTopics[infoTopic].title}
                     </h3>
                     <p className="text-slate-300 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            {/* Event notification */}
            {currentEvent && (
               <div className="mx-3 mt-3 p-3 bg-amber-900/50 border border-amber-500/50 rounded-xl animate-pulse">
                  <p className="font-bold text-amber-300">{currentEvent.message}</p>
                  <p className="text-xs text-amber-400/80 mt-1">{currentEvent.effect}</p>
               </div>
            )}

            {/* Supply chain visualization */}
            <div className="flex-1 p-3 overflow-auto">
               <div className="flex items-center gap-1 justify-between mb-4">
                  <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">Supply Chain Inventory</p>
                  <button onClick={() => setInfoTopic('supplychain')} className="text-slate-400 hover:text-white text-sm">‚ÑπÔ∏è</button>
               </div>

               <div className="flex justify-between items-end gap-2 mb-4">
                  {stages.map((stage, i) => (
                     <div key={stage.id} className="flex-1 flex flex-col items-center">
                        <div className="w-full bg-slate-700/50 rounded-lg p-2 mb-1 relative">
                           <div className="text-center text-2xl mb-1">{stage.icon}</div>
                           <div className="h-16 bg-slate-800 rounded relative overflow-hidden">
                              <div
                                 className={`absolute bottom-0 left-0 right-0 transition-all duration-500 ${
                                    stage.inventory < stage.capacity * 0.2 ? 'bg-red-500' :
                                    stage.inventory < stage.capacity * 0.5 ? 'bg-amber-500' : 'bg-green-500'
                                 }`}
                                 style={{ height: `${(stage.inventory / stage.capacity) * 100}%` }}
                              />
                              <div className="absolute inset-0 flex items-center justify-center text-white font-bold text-sm">
                                 {stage.inventory}
                              </div>
                           </div>
                           <p className="text-[10px] text-slate-400 text-center mt-1">{stage.name}</p>
                        </div>
                        {i < stages.length - 1 && <span className="text-slate-600 text-xs">‚Üí</span>}
                     </div>
                  ))}
                  <div className="flex flex-col items-center">
                     <div className="w-12 h-12 rounded-full bg-blue-900/50 flex items-center justify-center text-xl border-2 border-blue-500">üë§</div>
                     <p className="text-[10px] text-slate-400 mt-1">Customer</p>
                  </div>
               </div>

               {/* Order controls */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <p className="font-bold text-sm">üìã Place Order</p>
                     <button onClick={() => setInfoTopic('supplier')} className="text-slate-400 hover:text-white text-sm">‚ÑπÔ∏è</button>
                  </div>

                  <div className="grid grid-cols-3 gap-2 mb-3">
                     {(Object.entries(suppliers) as [string, typeof suppliers.cheap][]).map(([key, sup]) => (
                        <button
                           key={key}
                           onClick={() => setSelectedSupplier(key as 'cheap' | 'reliable' | 'fast')}
                           className={`p-2 rounded-lg text-xs transition-all ${
                              selectedSupplier === key
                                 ? 'bg-slate-600 border-2 border-slate-400'
                                 : 'bg-slate-700/50 border-2 border-transparent hover:border-slate-500'
                           }`}
                        >
                           <div className="text-lg mb-1">{sup.icon}</div>
                           <div className="font-bold truncate">{sup.name}</div>
                           <div className="text-slate-400">
                              ${sup.cost}/u ‚Ä¢ {sup.reliability}% ‚Ä¢ {sup.leadTime}d
                           </div>
                        </button>
                     ))}
                  </div>

                  <div className="flex gap-2 items-center">
                     <div className="flex-1">
                        <label className="text-xs text-slate-400">Quantity: {orderQty}</label>
                        <input
                           type="range"
                           min="5"
                           max="50"
                           value={orderQty}
                           onChange={(e) => setOrderQty(Number(e.target.value))}
                           className="w-full h-2 bg-slate-600 rounded-full accent-slate-400"
                        />
                     </div>
                     <button
                        onClick={placeOrder}
                        disabled={money < orderQty * suppliers[selectedSupplier].cost}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:opacity-50 rounded-lg font-bold text-sm transition-all"
                     >
                        Order (${orderQty * suppliers[selectedSupplier].cost})
                     </button>
                  </div>

                  {pendingOrders.length > 0 && (
                     <div className="mt-2 text-xs text-slate-400">
                        üì¶ Pending: {pendingOrders.map(o => `${o.qty}u (Day ${o.arriveDay})`).join(', ')}
                     </div>
                  )}
               </div>

               {/* Action button */}
               <button
                  onClick={processDay}
                  className="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 rounded-xl font-bold text-lg transition-all shadow-lg"
               >
                  ‚ñ∂Ô∏è ADVANCE TO {day < 10 ? `DAY ${day + 1}` : 'RESULTS'}
               </button>
            </div>

            {/* Log panel */}
            <div className="h-24 bg-black/40 border-t border-slate-600/50 p-2 overflow-auto">
               <p className="text-[10px] font-bold text-slate-500 mb-1">Activity Log</p>
               <div className="text-xs text-slate-400 space-y-0.5">
                  {gameLog.slice(-5).map((log, i) => <p key={i}>{log}</p>)}
               </div>
            </div>
         </div>
      );
   };

   // ============================================================================
   // INVENTORY MANAGEMENT INTERACTIVE
   // ============================================================================
   const InventoryManagementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [week, setWeek] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      // Inventory state
      const [inventory, setInventory] = useState(100);
      const [reorderPoint, setReorderPoint] = useState(30);
      const [orderQuantity, setOrderQuantity] = useState(50);
      const [pendingOrder, setPendingOrder] = useState<{ qty: number; arrivesWeek: number } | null>(null);

      // Costs and metrics
      const [totalHoldingCost, setTotalHoldingCost] = useState(0);
      const [totalOrderingCost, setTotalOrderingCost] = useState(0);
      const [totalStockoutCost, setTotalStockoutCost] = useState(0);
      const [totalRevenue, setTotalRevenue] = useState(0);
      const [salesMade, setSalesMade] = useState(0);
      const [salesLost, setSalesLost] = useState(0);

      // Settings
      const [demandVariability, setDemandVariability] = useState<'low' | 'medium' | 'high'>('medium');
      const holdingCostPerUnit = 2; // $ per unit per week
      const orderingCostFixed = 50; // $ per order
      const stockoutCostPerUnit = 15; // $ per lost sale
      const sellingPrice = 25; // $ per unit sold
      const leadTime = 2; // weeks

      const infoTopics: Record<string, { title: string; content: string }> = {
         inventory: {
            title: 'Inventory Management',
            content: 'Inventory management is balancing having enough stock to meet demand without holding too much (which costs money). Too little = lost sales. Too much = wasted storage costs.'
         },
         reorderPoint: {
            title: 'Reorder Point (ROP)',
            content: 'The inventory level at which you place a new order. ROP = (Average Daily Demand √ó Lead Time) + Safety Stock. Set it too low and you risk stockouts; too high and you order too often.'
         },
         eoq: {
            title: 'Economic Order Quantity',
            content: 'EOQ is the optimal order size that minimizes total inventory costs. EOQ = ‚àö(2√óD√óS/H) where D=annual demand, S=ordering cost, H=holding cost. Larger orders mean fewer orders but higher holding costs.'
         },
         holding: {
            title: 'Holding Costs',
            content: 'The cost of storing inventory: warehouse space, insurance, obsolescence, capital tied up. Typically 20-30% of item value per year. Holding too much inventory drains cash!'
         },
         stockout: {
            title: 'Stockout Costs',
            content: 'When you cannot fulfill demand: lost sales revenue, customer dissatisfaction, damaged reputation. Often the highest hidden cost in inventory management!'
         },
         safetyStock: {
            title: 'Safety Stock',
            content: 'Extra inventory held as a buffer against demand variability and supply delays. Higher variability = more safety stock needed. It\'s insurance against stockouts.'
         }
      };

      const getDemand = () => {
         const base = 40;
         const variance = demandVariability === 'low' ? 10 : demandVariability === 'medium' ? 25 : 40;
         return Math.max(5, Math.floor(base + (Math.random() * variance * 2) - variance));
      };

      const processWeek = () => {
         const demand = getDemand();
         let newLog: string[] = [`üìÖ Week ${week}: Demand = ${demand} units`];
         let weekHolding = 0;
         let weekStockout = 0;
         let weekRevenue = 0;

         // Check if order arrives
         if (pendingOrder && pendingOrder.arrivesWeek <= week) {
            setInventory(prev => prev + pendingOrder.qty);
            newLog.push(`üì¶ Order of ${pendingOrder.qty} units arrived!`);
            setPendingOrder(null);
         }

         // Fulfill demand
         const fulfilled = Math.min(inventory, demand);
         const unfulfilled = demand - fulfilled;

         if (fulfilled > 0) {
            setInventory(prev => prev - fulfilled);
            weekRevenue = fulfilled * sellingPrice;
            setTotalRevenue(prev => prev + weekRevenue);
            setSalesMade(prev => prev + fulfilled);
            newLog.push(`‚úÖ Sold ${fulfilled} units (+$${weekRevenue})`);
         }

         if (unfulfilled > 0) {
            weekStockout = unfulfilled * stockoutCostPerUnit;
            setTotalStockoutCost(prev => prev + weekStockout);
            setSalesLost(prev => prev + unfulfilled);
            newLog.push(`‚ùå STOCKOUT! Lost ${unfulfilled} sales (-$${weekStockout} opportunity cost)`);
         }

         // Calculate holding cost on remaining inventory
         const remainingInventory = inventory - fulfilled + (pendingOrder?.arrivesWeek === week ? pendingOrder.qty : 0);
         weekHolding = Math.max(0, remainingInventory) * holdingCostPerUnit;
         setTotalHoldingCost(prev => prev + weekHolding);
         if (weekHolding > 0) {
            newLog.push(`üè≠ Holding cost: -$${weekHolding} (${remainingInventory} units √ó $${holdingCostPerUnit})`);
         }

         // Auto-order if at or below reorder point and no pending order
         const currentInv = inventory - fulfilled;
         if (currentInv <= reorderPoint && !pendingOrder) {
            setPendingOrder({ qty: orderQuantity, arrivesWeek: week + leadTime });
            setTotalOrderingCost(prev => prev + orderingCostFixed);
            newLog.push(`üìã Auto-ordered ${orderQuantity} units (arrives Week ${week + leadTime}) - Order cost: $${orderingCostFixed}`);
         }

         setGameLog(prev => [...prev, ...newLog, '---']);

         if (week >= 12) {
            setPhase('result');
         } else {
            setWeek(w => w + 1);
         }
      };

      const startGame = () => {
         setPhase('play');
         setWeek(1);
         setInventory(100);
         setPendingOrder(null);
         setTotalHoldingCost(0);
         setTotalOrderingCost(0);
         setTotalStockoutCost(0);
         setTotalRevenue(0);
         setSalesMade(0);
         setSalesLost(0);
         setGameLog([]);
      };

      const getScore = () => {
         const totalCosts = totalHoldingCost + totalOrderingCost + totalStockoutCost;
         const profit = totalRevenue - totalCosts;
         const serviceLevel = salesMade > 0 ? Math.round((salesMade / (salesMade + salesLost)) * 100) : 0;
         const score = Math.min(100, Math.max(0, Math.round(serviceLevel * 0.5 + (profit > 0 ? 30 : 0) + (profit > 500 ? 20 : profit > 0 ? 10 : 0))));
         return { totalCosts, profit, serviceLevel, score };
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-2xl font-black flex items-center gap-2">üì¶ INVENTORY MANAGEMENT</h2>
                  <p className="text-blue-300 text-sm mt-1">Balance stock levels to maximize profit</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all">‚ÑπÔ∏è</button>
            </div>

            {showInfo && (
               <div className="bg-black/40 rounded-xl p-4 mb-4 text-sm border border-blue-500/30">
                  <p className="font-bold text-blue-200 mb-2">üìö What You'll Learn:</p>
                  <ul className="space-y-1 text-blue-300">
                     <li>‚Ä¢ How to set optimal reorder points</li>
                     <li>‚Ä¢ Balancing holding costs vs stockout costs</li>
                     <li>‚Ä¢ The impact of demand variability</li>
                     <li>‚Ä¢ Why order quantity matters (EOQ concept)</li>
                  </ul>
               </div>
            )}

            <div className="flex-1 flex flex-col justify-center">
               {/* Cost triangle visualization */}
               <div className="bg-black/30 rounded-2xl p-4 mb-6">
                  <p className="text-center text-blue-400 text-xs mb-4 font-bold uppercase tracking-wider">The Inventory Cost Triangle</p>
                  <div className="flex justify-around items-center">
                     <div className="text-center">
                        <div className="w-16 h-16 rounded-full bg-amber-500/30 flex items-center justify-center text-3xl mb-2 mx-auto border-2 border-amber-500">üè≠</div>
                        <p className="text-xs font-bold">Holding Costs</p>
                        <p className="text-[10px] text-blue-400">${holdingCostPerUnit}/unit/week</p>
                     </div>
                     <div className="text-center">
                        <div className="w-16 h-16 rounded-full bg-blue-500/30 flex items-center justify-center text-3xl mb-2 mx-auto border-2 border-blue-500">üìã</div>
                        <p className="text-xs font-bold">Ordering Costs</p>
                        <p className="text-[10px] text-blue-400">${orderingCostFixed}/order</p>
                     </div>
                     <div className="text-center">
                        <div className="w-16 h-16 rounded-full bg-red-500/30 flex items-center justify-center text-3xl mb-2 mx-auto border-2 border-red-500">‚ùå</div>
                        <p className="text-xs font-bold">Stockout Costs</p>
                        <p className="text-[10px] text-blue-400">${stockoutCostPerUnit}/lost sale</p>
                     </div>
                  </div>
               </div>

               <div className="text-center mb-6">
                  <h3 className="text-xl font-bold mb-2">üéÆ Your Mission</h3>
                  <p className="text-blue-300 max-w-lg mx-auto">
                     Run a 12-week inventory simulation. Set your reorder point and order quantity wisely
                     to minimize costs and maximize service level!
                  </p>
               </div>

               <div className="bg-black/20 rounded-xl p-4 mb-6 max-w-md mx-auto">
                  <p className="text-sm font-bold mb-3 text-center">Choose Demand Variability:</p>
                  <div className="grid grid-cols-3 gap-2">
                     {(['low', 'medium', 'high'] as const).map(level => (
                        <button
                           key={level}
                           onClick={() => setDemandVariability(level)}
                           className={`p-3 rounded-lg text-sm font-bold capitalize transition-all ${
                              demandVariability === level
                                 ? 'bg-blue-500 text-white'
                                 : 'bg-white/10 hover:bg-white/20'
                           }`}
                        >
                           {level === 'low' ? 'üìä Low' : level === 'medium' ? 'üìà Medium' : 'üé¢ High'}
                        </button>
                     ))}
                  </div>
                  <p className="text-xs text-blue-400 text-center mt-2">
                     {demandVariability === 'low' ? 'Demand: 30-50 units/week' :
                      demandVariability === 'medium' ? 'Demand: 15-65 units/week' :
                      'Demand: 0-80 units/week (risky!)'}
                  </p>
               </div>

               <button onClick={startGame} className="mx-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                  START SIMULATION ‚Üí
               </button>
            </div>

            <p className="text-xs text-blue-400/60 text-center mt-4">üí° Tip: Higher variability needs higher safety stock (higher reorder point).</p>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const { totalCosts, profit, serviceLevel, score } = getScore();
         const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
         const gradeColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-blue-400' : score >= 40 ? 'text-yellow-400' : 'text-red-400';

         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white p-6 overflow-auto">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-2">{score >= 80 ? 'üèÜ' : score >= 60 ? 'üì¶' : score >= 40 ? 'üìä' : 'üìâ'}</div>
                  <h2 className="text-3xl font-black">Simulation Complete!</h2>
                  <p className={`text-5xl font-black mt-2 ${gradeColor}`}>Grade: {grade}</p>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4 max-w-md mx-auto">
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-green-400">${totalRevenue}</p>
                     <p className="text-xs text-blue-300">Revenue</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className={`text-xl font-black ${profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>${profit >= 0 ? '+' : ''}{profit}</p>
                     <p className="text-xs text-blue-300">Net Profit</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-purple-400">{serviceLevel}%</p>
                     <p className="text-xs text-blue-300">Service Level</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-amber-400">${totalCosts}</p>
                     <p className="text-xs text-blue-300">Total Costs</p>
                  </div>
               </div>

               <div className="bg-black/20 rounded-xl p-3 mb-4 max-w-md mx-auto">
                  <p className="text-xs font-bold text-blue-400 mb-2">Cost Breakdown:</p>
                  <div className="grid grid-cols-3 gap-2 text-center text-xs">
                     <div><span className="text-amber-400">${totalHoldingCost}</span><br/>Holding</div>
                     <div><span className="text-blue-400">${totalOrderingCost}</span><br/>Ordering</div>
                     <div><span className="text-red-400">${totalStockoutCost}</span><br/>Stockouts</div>
                  </div>
               </div>

               <div className="bg-indigo-900/40 rounded-xl p-4 mb-4 border border-indigo-500/30">
                  <p className="font-bold text-indigo-300 mb-2 flex items-center gap-2">
                     <span className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-sm">üí°</span>
                     Key Takeaways
                  </p>
                  <ul className="text-sm text-indigo-200 space-y-1">
                     <li>‚Ä¢ <strong>Reorder Point</strong> should cover demand during lead time + safety buffer</li>
                     <li>‚Ä¢ <strong>Order Quantity</strong> balances ordering cost vs holding cost</li>
                     <li>‚Ä¢ <strong>Safety Stock</strong> protects against demand variability</li>
                     <li>‚Ä¢ <strong>Stockouts</strong> are often more costly than holding extra inventory</li>
                  </ul>
               </div>

               <div className="bg-black/20 rounded-xl p-3 mb-4 max-h-24 overflow-auto">
                  <p className="text-xs font-bold text-blue-400 mb-1">üìã Session Log</p>
                  <div className="text-xs text-blue-300/70 space-y-0.5">
                     {gameLog.slice(-8).map((log, i) => <p key={i}>{log}</p>)}
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold transition-all">
                  üîÑ PLAY AGAIN
               </button>
            </div>
         );
      }

      // PLAY PHASE
      const currentInventory = inventory + (pendingOrder?.arrivesWeek === week ? pendingOrder.qty : 0);
      const inventoryStatus = currentInventory < 20 ? 'critical' : currentInventory < 50 ? 'warning' : 'healthy';

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">
            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-blue-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-black">üìÖ Week {week} / 12</span>
                  <div className="flex gap-2">
                     <span className="px-3 py-1 bg-green-900/50 rounded-full text-sm font-bold text-green-300">üí∞ ${totalRevenue - totalHoldingCost - totalOrderingCost - totalStockoutCost}</span>
                  </div>
               </div>
               <div className="flex gap-3 text-xs">
                  <span className="text-blue-300">Sales: {salesMade}</span>
                  <span className="text-blue-500">|</span>
                  <span className="text-red-300">Lost: {salesLost}</span>
                  <span className="text-blue-500">|</span>
                  <span className="text-amber-300">Holding: ${totalHoldingCost}</span>
               </div>
            </div>

            {/* Info modal */}
            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-indigo-900 rounded-2xl p-6 max-w-md border border-indigo-500" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">‚ÑπÔ∏è {infoTopics[infoTopic].title}</h3>
                     <p className="text-blue-200 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            <div className="flex-1 p-4 overflow-auto">
               {/* Inventory visualization */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <p className="font-bold text-sm">üì¶ Current Inventory</p>
                     <button onClick={() => setInfoTopic('inventory')} className="text-blue-400 hover:text-white text-sm">‚ÑπÔ∏è</button>
                  </div>

                  <div className="relative h-20 bg-black/40 rounded-lg overflow-hidden mb-2">
                     {/* Reorder point line */}
                     <div
                        className="absolute top-0 bottom-0 w-0.5 bg-yellow-500 z-10"
                        style={{ left: `${Math.min(100, (reorderPoint / 150) * 100)}%` }}
                     >
                        <span className="absolute -top-5 left-1 text-[10px] text-yellow-400 whitespace-nowrap">ROP: {reorderPoint}</span>
                     </div>

                     {/* Inventory bar */}
                     <div
                        className={`absolute bottom-0 left-0 h-full transition-all duration-500 ${
                           inventoryStatus === 'critical' ? 'bg-gradient-to-t from-red-600 to-red-400' :
                           inventoryStatus === 'warning' ? 'bg-gradient-to-t from-amber-600 to-amber-400' :
                           'bg-gradient-to-t from-green-600 to-green-400'
                        }`}
                        style={{ width: `${Math.min(100, (inventory / 150) * 100)}%` }}
                     />

                     {/* Inventory number */}
                     <div className="absolute inset-0 flex items-center justify-center text-3xl font-black text-white drop-shadow-lg">
                        {inventory}
                     </div>
                  </div>

                  <div className="flex justify-between text-xs text-blue-400">
                     <span>0</span>
                     <span>Max: 150</span>
                  </div>

                  {pendingOrder && (
                     <div className="mt-3 p-2 bg-blue-500/20 rounded-lg text-sm text-center border border-blue-500/30">
                        üöö Order of {pendingOrder.qty} units arriving Week {pendingOrder.arrivesWeek}
                     </div>
                  )}
               </div>

               {/* Controls */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <p className="font-bold text-sm">‚öôÔ∏è Inventory Settings</p>
                     <button onClick={() => setInfoTopic('reorderPoint')} className="text-blue-400 hover:text-white text-sm">‚ÑπÔ∏è</button>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between text-sm mb-1">
                           <span>Reorder Point (ROP)</span>
                           <span className="font-bold text-yellow-400">{reorderPoint} units</span>
                        </div>
                        <input
                           type="range"
                           min="10"
                           max="80"
                           value={reorderPoint}
                           onChange={(e) => setReorderPoint(Number(e.target.value))}
                           className="w-full h-2 bg-blue-900 rounded-full accent-yellow-500"
                        />
                        <p className="text-xs text-blue-400 mt-1">Auto-order triggers when inventory ‚â§ {reorderPoint}</p>
                     </div>

                     <div>
                        <div className="flex justify-between text-sm mb-1">
                           <span>Order Quantity (EOQ)</span>
                           <span className="font-bold text-blue-400">{orderQuantity} units</span>
                        </div>
                        <input
                           type="range"
                           min="20"
                           max="100"
                           value={orderQuantity}
                           onChange={(e) => setOrderQuantity(Number(e.target.value))}
                           className="w-full h-2 bg-blue-900 rounded-full accent-blue-500"
                        />
                        <p className="text-xs text-blue-400 mt-1">Order cost: ${orderingCostFixed} + holding at ${holdingCostPerUnit}/unit/week</p>
                     </div>
                  </div>
               </div>

               {/* Action button */}
               <button
                  onClick={processWeek}
                  className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold text-lg transition-all shadow-lg"
               >
                  ‚ñ∂Ô∏è SIMULATE WEEK {week}
               </button>
            </div>

            {/* Log panel */}
            <div className="h-24 bg-black/40 border-t border-blue-500/30 p-2 overflow-auto">
               <p className="text-[10px] font-bold text-blue-500 mb-1">Activity Log</p>
               <div className="text-xs text-blue-300 space-y-0.5">
                  {gameLog.slice(-5).map((log, i) => <p key={i}>{log}</p>)}
               </div>
            </div>
         </div>
      );
   };

   // ============================================================================
   // OUTSOURCING DECISIONS INTERACTIVE
   // ============================================================================
   const OutsourcingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [currentTask, setCurrentTask] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      // Business metrics
      const [budget, setBudget] = useState(100000);
      const [qualityScore, setQualityScore] = useState(80);
      const [controlScore, setControlScore] = useState(100);
      const [velocity, setVelocity] = useState(50);

      // Decisions made
      const [decisions, setDecisions] = useState<{ task: string; choice: 'inhouse' | 'outsource'; cost: number; impact: string }[]>([]);

      const tasks = [
         {
            name: 'Software Development',
            icon: 'üíª',
            isCore: true,
            inhouse: { cost: 80000, quality: 90, control: 100, velocity: 40, time: '6 months' },
            outsource: { cost: 40000, quality: 75, control: 50, velocity: 80, time: '3 months' },
            insight: 'Core competency - outsourcing risks losing competitive advantage'
         },
         {
            name: 'Accounting & Bookkeeping',
            icon: 'üìä',
            isCore: false,
            inhouse: { cost: 50000, quality: 85, control: 100, velocity: 50, time: 'Ongoing' },
            outsource: { cost: 15000, quality: 90, control: 70, velocity: 90, time: 'Ongoing' },
            insight: 'Non-core - specialists often do it better and cheaper'
         },
         {
            name: 'Customer Support',
            icon: 'üéß',
            isCore: true,
            inhouse: { cost: 60000, quality: 95, control: 100, velocity: 60, time: 'Ongoing' },
            outsource: { cost: 25000, quality: 70, control: 40, velocity: 85, time: 'Ongoing' },
            insight: 'Customer-facing - quality matters more than cost'
         },
         {
            name: 'Logo & Brand Design',
            icon: 'üé®',
            isCore: false,
            inhouse: { cost: 30000, quality: 75, control: 100, velocity: 30, time: '2 months' },
            outsource: { cost: 5000, quality: 90, control: 60, velocity: 95, time: '2 weeks' },
            insight: 'One-time project - perfect for freelancers/agencies'
         },
         {
            name: 'Legal Services',
            icon: '‚öñÔ∏è',
            isCore: false,
            inhouse: { cost: 120000, quality: 85, control: 100, velocity: 50, time: 'Ongoing' },
            outsource: { cost: 20000, quality: 95, control: 80, velocity: 90, time: 'As needed' },
            insight: 'Specialized expertise - outsource unless you\'re a law firm'
         },
         {
            name: 'Marketing Campaigns',
            icon: 'üì¢',
            isCore: true,
            inhouse: { cost: 70000, quality: 80, control: 100, velocity: 50, time: 'Ongoing' },
            outsource: { cost: 35000, quality: 85, control: 60, velocity: 80, time: 'Ongoing' },
            insight: 'Mix works best - keep strategy in-house, outsource execution'
         },
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         outsourcing: {
            title: 'What is Outsourcing?',
            content: 'Outsourcing means hiring external companies or freelancers to handle business functions instead of doing them in-house. It can reduce costs and provide access to specialized skills.'
         },
         core: {
            title: 'Core vs Non-Core',
            content: 'Core activities are central to your competitive advantage (what makes you unique). Non-core activities are necessary but don\'t differentiate you. Generally, keep core in-house and consider outsourcing non-core.'
         },
         tradeoffs: {
            title: 'Outsourcing Tradeoffs',
            content: 'Outsourcing saves money and time but reduces control and may affect quality. You also become dependent on vendors. Consider: cost savings, expertise access, focus on core business, but also communication overhead and quality risks.'
         },
         control: {
            title: 'Control & Quality',
            content: 'In-house teams give you full control over quality, priorities, and processes. Outsourced work requires clear contracts, communication, and quality checks. The further from your core, the less control matters.'
         },
         velocity: {
            title: 'Speed to Market',
            content: 'Outsourcing can dramatically speed up delivery - agencies have ready teams and processes. But coordination takes time. For one-time projects, outsourcing is often faster. For ongoing work, in-house builds momentum.'
         },
         dependency: {
            title: 'Vendor Dependency',
            content: 'Over-relying on vendors creates risk: they might raise prices, reduce quality, or go out of business. Diversify vendors for critical functions and keep core competencies in-house.'
         }
      };

      const makeDecision = (choice: 'inhouse' | 'outsource') => {
         const task = tasks[currentTask];
         const option = choice === 'inhouse' ? task.inhouse : task.outsource;

         // Apply effects
         setBudget(prev => prev - option.cost);
         setQualityScore(prev => Math.round((prev + option.quality) / 2));
         setControlScore(prev => Math.round((prev + option.control) / 2));
         setVelocity(prev => Math.round((prev + option.velocity) / 2));

         // Log decision
         const impact = choice === 'inhouse'
            ? `Kept in-house: Full control, higher cost`
            : `Outsourced: Cost savings of $${task.inhouse.cost - task.outsource.cost}`;

         setDecisions(prev => [...prev, {
            task: task.name,
            choice,
            cost: option.cost,
            impact
         }]);

         setGameLog(prev => [...prev,
            `${task.icon} ${task.name}: ${choice === 'inhouse' ? 'IN-HOUSE' : 'OUTSOURCED'}`,
            `   Cost: $${option.cost.toLocaleString()} | Quality: ${option.quality}% | Control: ${option.control}%`,
            `   üí° ${task.insight}`
         ]);

         if (currentTask < tasks.length - 1) {
            setCurrentTask(prev => prev + 1);
         } else {
            setPhase('result');
         }
      };

      const startGame = () => {
         setPhase('play');
         setCurrentTask(0);
         setBudget(100000);
         setQualityScore(80);
         setControlScore(100);
         setVelocity(50);
         setDecisions([]);
         setGameLog([]);
      };

      const getScore = () => {
         const budgetRemaining = budget;
         const outsourcedCount = decisions.filter(d => d.choice === 'outsource').length;
         const coreOutsourced = decisions.filter(d => d.choice === 'outsource' && tasks.find(t => t.name === d.task)?.isCore).length;

         // Score based on balanced approach
         let score = 50;
         if (budgetRemaining > 0) score += 20;
         if (qualityScore >= 80) score += 15;
         if (controlScore >= 60) score += 10;
         if (coreOutsourced === 0) score += 15; // Bonus for keeping core in-house
         if (outsourcedCount >= 2 && outsourcedCount <= 4) score += 10; // Balanced approach

         return { score: Math.min(100, score), budgetRemaining, outsourcedCount, coreOutsourced };
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-cyan-900 to-blue-900 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-2xl font-black flex items-center gap-2">ü§ù OUTSOURCING DECISIONS</h2>
                  <p className="text-teal-300 text-sm mt-1">Build vs Buy: Strategic resource allocation</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all">‚ÑπÔ∏è</button>
            </div>

            {showInfo && (
               <div className="bg-black/40 rounded-xl p-4 mb-4 text-sm border border-teal-500/30">
                  <p className="font-bold text-teal-200 mb-2">üìö What You'll Learn:</p>
                  <ul className="space-y-1 text-teal-300">
                     <li>‚Ä¢ When to outsource vs keep in-house</li>
                     <li>‚Ä¢ Core vs non-core business activities</li>
                     <li>‚Ä¢ Cost, quality, and control tradeoffs</li>
                     <li>‚Ä¢ Strategic resource allocation</li>
                  </ul>
               </div>
            )}

            <div className="flex-1 flex flex-col justify-center">
               {/* Decision framework visualization */}
               <div className="bg-black/30 rounded-2xl p-4 mb-6">
                  <p className="text-center text-teal-400 text-xs mb-4 font-bold uppercase tracking-wider">The Outsourcing Decision Matrix</p>
                  <div className="grid grid-cols-2 gap-3">
                     <div className="bg-green-900/40 rounded-xl p-3 border border-green-500/30">
                        <p className="font-bold text-green-400 text-sm mb-1">üè† Keep In-House</p>
                        <ul className="text-xs text-green-300 space-y-1">
                           <li>‚úì Core competencies</li>
                           <li>‚úì Competitive advantage</li>
                           <li>‚úì Need full control</li>
                        </ul>
                     </div>
                     <div className="bg-blue-900/40 rounded-xl p-3 border border-blue-500/30">
                        <p className="font-bold text-blue-400 text-sm mb-1">üåê Outsource</p>
                        <ul className="text-xs text-blue-300 space-y-1">
                           <li>‚úì Non-core activities</li>
                           <li>‚úì Need specialized skills</li>
                           <li>‚úì One-time projects</li>
                        </ul>
                     </div>
                  </div>
               </div>

               <div className="text-center mb-6">
                  <h3 className="text-xl font-bold mb-2">üéÆ Your Mission</h3>
                  <p className="text-teal-300 max-w-lg mx-auto">
                     You're a startup founder with $100,000. Decide which business functions
                     to outsource and which to keep in-house. Balance cost, quality, and control!
                  </p>
               </div>

               <div className="grid grid-cols-4 gap-2 mb-6 max-w-md mx-auto text-center">
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">üí∞</span>
                     <p className="text-[10px] text-teal-400">$100K Budget</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">‚≠ê</span>
                     <p className="text-[10px] text-teal-400">Quality</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">üéÆ</span>
                     <p className="text-[10px] text-teal-400">Control</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">‚ö°</span>
                     <p className="text-[10px] text-teal-400">Speed</p>
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-8 py-4 bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                  START DECISIONS ‚Üí
               </button>
            </div>

            <p className="text-xs text-teal-400/60 text-center mt-4">üí° Tip: Focus on keeping core competencies in-house while outsourcing non-core activities.</p>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const { score, budgetRemaining, outsourcedCount, coreOutsourced } = getScore();
         const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
         const gradeColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-blue-400' : score >= 40 ? 'text-yellow-400' : 'text-red-400';

         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-cyan-900 to-blue-900 text-white p-6 overflow-auto">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-2">{score >= 80 ? 'üèÜ' : score >= 60 ? 'ü§ù' : score >= 40 ? 'üìä' : '‚ö†Ô∏è'}</div>
                  <h2 className="text-3xl font-black">Decisions Complete!</h2>
                  <p className={`text-5xl font-black mt-2 ${gradeColor}`}>Grade: {grade}</p>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4 max-w-md mx-auto">
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className={`text-xl font-black ${budgetRemaining >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        ${budgetRemaining.toLocaleString()}
                     </p>
                     <p className="text-xs text-teal-300">Budget Remaining</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-purple-400">{qualityScore}%</p>
                     <p className="text-xs text-teal-300">Avg Quality</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-blue-400">{controlScore}%</p>
                     <p className="text-xs text-teal-300">Control Level</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-amber-400">{outsourcedCount}/{tasks.length}</p>
                     <p className="text-xs text-teal-300">Outsourced</p>
                  </div>
               </div>

               {coreOutsourced > 0 && (
                  <div className="bg-red-900/40 rounded-xl p-3 mb-4 border border-red-500/30 text-center">
                     <p className="text-red-300 text-sm">‚ö†Ô∏è You outsourced {coreOutsourced} core function(s) - this may hurt competitive advantage!</p>
                  </div>
               )}

               <div className="bg-teal-900/40 rounded-xl p-4 mb-4 border border-teal-500/30">
                  <p className="font-bold text-teal-300 mb-2 flex items-center gap-2">
                     <span className="w-6 h-6 rounded-full bg-teal-500 flex items-center justify-center text-sm">üí°</span>
                     Key Takeaways
                  </p>
                  <ul className="text-sm text-teal-200 space-y-1">
                     <li>‚Ä¢ <strong>Core activities</strong> should usually stay in-house</li>
                     <li>‚Ä¢ <strong>Non-core activities</strong> are great outsourcing candidates</li>
                     <li>‚Ä¢ <strong>One-time projects</strong> often benefit from outsourcing</li>
                     <li>‚Ä¢ Balance <strong>cost savings</strong> with <strong>quality and control</strong></li>
                  </ul>
               </div>

               <div className="bg-black/20 rounded-xl p-3 mb-4 max-h-28 overflow-auto">
                  <p className="text-xs font-bold text-teal-400 mb-1">üìã Decision Summary</p>
                  <div className="text-xs text-teal-300/70 space-y-0.5">
                     {decisions.map((d, i) => (
                        <p key={i}>{d.choice === 'inhouse' ? 'üè†' : 'üåê'} {d.task}: ${d.cost.toLocaleString()}</p>
                     ))}
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-500 hover:to-cyan-500 rounded-xl font-bold transition-all">
                  üîÑ PLAY AGAIN
               </button>
            </div>
         );
      }

      // PLAY PHASE
      const task = tasks[currentTask];

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-teal-900 via-cyan-900 to-blue-900 text-white overflow-hidden">
            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-teal-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-black">Decision {currentTask + 1} / {tasks.length}</span>
                  <span className={`px-3 py-1 rounded-full text-sm font-bold ${budget >= 0 ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}`}>
                     üí∞ ${budget.toLocaleString()}
                  </span>
               </div>
               <div className="flex gap-3 text-xs">
                  <span className="text-purple-300">Quality: {qualityScore}%</span>
                  <span className="text-teal-500">|</span>
                  <span className="text-blue-300">Control: {controlScore}%</span>
                  <span className="text-teal-500">|</span>
                  <span className="text-amber-300">Speed: {velocity}%</span>
               </div>
            </div>

            {/* Info modal */}
            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-teal-900 rounded-2xl p-6 max-w-md border border-teal-500" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">‚ÑπÔ∏è {infoTopics[infoTopic].title}</h3>
                     <p className="text-teal-200 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-teal-700 hover:bg-teal-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            <div className="flex-1 p-4 overflow-auto">
               {/* Current task */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <div className="flex justify-between items-start mb-3">
                     <div className="flex items-center gap-3">
                        <span className="text-4xl">{task.icon}</span>
                        <div>
                           <h3 className="text-xl font-black">{task.name}</h3>
                           <span className={`text-xs px-2 py-0.5 rounded-full ${task.isCore ? 'bg-amber-500/30 text-amber-300' : 'bg-teal-500/30 text-teal-300'}`}>
                              {task.isCore ? '‚≠ê Core Activity' : 'üì¶ Non-Core'}
                           </span>
                        </div>
                     </div>
                     <button onClick={() => setInfoTopic('core')} className="text-teal-400 hover:text-white">‚ÑπÔ∏è</button>
                  </div>
               </div>

               {/* Options comparison */}
               <div className="grid grid-cols-2 gap-3 mb-4">
                  {/* In-House Option */}
                  <button
                     onClick={() => makeDecision('inhouse')}
                     className="bg-green-900/30 hover:bg-green-900/50 border-2 border-green-500/30 hover:border-green-500 rounded-xl p-4 text-left transition-all"
                  >
                     <div className="flex items-center gap-2 mb-3">
                        <span className="text-2xl">üè†</span>
                        <span className="font-bold text-green-400">IN-HOUSE</span>
                     </div>
                     <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                           <span className="text-teal-400">Cost:</span>
                           <span className="font-bold text-red-400">${task.inhouse.cost.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Quality:</span>
                           <span className="font-bold text-green-400">{task.inhouse.quality}%</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Control:</span>
                           <span className="font-bold text-blue-400">{task.inhouse.control}%</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Speed:</span>
                           <span className="font-bold text-amber-400">{task.inhouse.velocity}%</span>
                        </div>
                        <div className="text-xs text-teal-500 mt-2">‚è±Ô∏è {task.inhouse.time}</div>
                     </div>
                  </button>

                  {/* Outsource Option */}
                  <button
                     onClick={() => makeDecision('outsource')}
                     className="bg-blue-900/30 hover:bg-blue-900/50 border-2 border-blue-500/30 hover:border-blue-500 rounded-xl p-4 text-left transition-all"
                  >
                     <div className="flex items-center gap-2 mb-3">
                        <span className="text-2xl">üåê</span>
                        <span className="font-bold text-blue-400">OUTSOURCE</span>
                     </div>
                     <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                           <span className="text-teal-400">Cost:</span>
                           <span className="font-bold text-green-400">${task.outsource.cost.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Quality:</span>
                           <span className="font-bold">{task.outsource.quality}%</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Control:</span>
                           <span className="font-bold text-amber-400">{task.outsource.control}%</span>
                        </div>
                        <div className="flex justify-between">
                           <span className="text-teal-400">Speed:</span>
                           <span className="font-bold text-green-400">{task.outsource.velocity}%</span>
                        </div>
                        <div className="text-xs text-teal-500 mt-2">‚è±Ô∏è {task.outsource.time}</div>
                     </div>
                  </button>
               </div>

               {/* Savings indicator */}
               <div className="bg-black/20 rounded-lg p-3 text-center">
                  <p className="text-sm text-teal-400">
                     üí° Outsourcing saves <span className="font-bold text-green-400">${(task.inhouse.cost - task.outsource.cost).toLocaleString()}</span>
                     {task.isCore && <span className="text-amber-400"> (but this is a core activity!)</span>}
                  </p>
               </div>
            </div>

            {/* Previous decisions */}
            {decisions.length > 0 && (
               <div className="h-20 bg-black/40 border-t border-teal-500/30 p-2 overflow-auto">
                  <p className="text-[10px] font-bold text-teal-500 mb-1">Previous Decisions</p>
                  <div className="flex gap-2 flex-wrap">
                     {decisions.map((d, i) => (
                        <span key={i} className={`text-xs px-2 py-1 rounded ${d.choice === 'inhouse' ? 'bg-green-900/50 text-green-300' : 'bg-blue-900/50 text-blue-300'}`}>
                           {d.choice === 'inhouse' ? 'üè†' : 'üåê'} {d.task.split(' ')[0]}
                        </span>
                     ))}
                  </div>
               </div>
            )}
         </div>
      );
   };

   // ============================================================================
   // HIRING & TEAM CULTURE INTERACTIVE
   // ============================================================================
   const HiringRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'values' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [currentCandidate, setCurrentCandidate] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      // Company values (player selects 3)
      const [selectedValues, setSelectedValues] = useState<string[]>([]);
      const allValues = [
         { id: 'innovation', name: 'Innovation', icon: 'üí°', desc: 'Push boundaries, embrace new ideas' },
         { id: 'speed', name: 'Speed', icon: '‚ö°', desc: 'Move fast, iterate quickly' },
         { id: 'quality', name: 'Quality', icon: '‚ú®', desc: 'Excellence in everything we do' },
         { id: 'teamwork', name: 'Teamwork', icon: 'ü§ù', desc: 'Collaborate and support each other' },
         { id: 'transparency', name: 'Transparency', icon: 'üîç', desc: 'Open communication, no secrets' },
         { id: 'customer', name: 'Customer Focus', icon: '‚ù§Ô∏è', desc: 'Customer success is our success' },
      ];

      // Team and budget
      const [team, setTeam] = useState<{ name: string; role: string; skills: number; culture: number }[]>([]);
      const [budget, setBudget] = useState(300000);
      const [cultureScore, setCultureScore] = useState(100);
      const [productivityScore, setProductivityScore] = useState(50);

      // Candidates
      const candidates = [
         {
            name: 'Alex Chen',
            role: 'Lead Developer',
            avatar: 'üë®‚Äçüíª',
            salary: 120000,
            skills: 95,
            experience: 8,
            cultureFit: { innovation: 90, speed: 85, quality: 70, teamwork: 60, transparency: 75, customer: 65 },
            personality: 'Brilliant coder but prefers working alone. Strong opinions.',
            redFlag: 'May clash with collaborative culture',
            greenFlag: 'Technical excellence, can build anything'
         },
         {
            name: 'Sarah Miller',
            role: 'Product Manager',
            avatar: 'üë©‚Äçüíº',
            salary: 100000,
            skills: 80,
            experience: 5,
            cultureFit: { innovation: 85, speed: 90, quality: 80, teamwork: 95, transparency: 90, customer: 95 },
            personality: 'Great communicator, customer-obsessed. Still growing technically.',
            redFlag: 'Less experienced than other candidates',
            greenFlag: 'Culture carrier, team player'
         },
         {
            name: 'Marcus Johnson',
            role: 'Sales Lead',
            avatar: 'üë®‚Äçüíº',
            salary: 90000,
            skills: 85,
            experience: 10,
            cultureFit: { innovation: 50, speed: 95, quality: 60, teamwork: 70, transparency: 40, customer: 90 },
            personality: 'Hits targets consistently. Very competitive, sometimes cuts corners.',
            redFlag: 'May prioritize results over process',
            greenFlag: 'Revenue driver, closes deals'
         },
         {
            name: 'Emily Park',
            role: 'Designer',
            avatar: 'üë©‚Äçüé®',
            salary: 85000,
            skills: 90,
            experience: 4,
            cultureFit: { innovation: 95, speed: 70, quality: 95, teamwork: 85, transparency: 80, customer: 85 },
            personality: 'Creative visionary. Takes time to perfect designs.',
            redFlag: 'May slow down fast-paced sprints',
            greenFlag: 'Exceptional design quality'
         },
         {
            name: 'David Kim',
            role: 'Operations',
            avatar: 'üë®‚Äçüîß',
            salary: 75000,
            skills: 75,
            experience: 6,
            cultureFit: { innovation: 60, speed: 80, quality: 90, teamwork: 90, transparency: 95, customer: 80 },
            personality: 'Reliable, process-oriented. Keeps everything running smoothly.',
            redFlag: 'Less innovative, prefers proven methods',
            greenFlag: 'Stability, operational excellence'
         },
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         culture: {
            title: 'Company Culture',
            content: 'Culture is the shared values, beliefs, and behaviors that define how your team works together. Your first 10 hires define your culture forever. Culture fit doesn\'t mean hiring clones - it means shared values with diverse perspectives.'
         },
         skills: {
            title: 'Skills vs Culture Fit',
            content: 'A common debate: hire for skills or culture? Best practice: Set a skills threshold (must be competent), then optimize for culture fit. You can train skills, but changing someone\'s values is nearly impossible.'
         },
         early: {
            title: 'Early Hires Matter',
            content: 'Your first employees set the tone. They\'ll help hire the next batch, so their standards become your company\'s standards. One toxic early hire can poison the entire culture.'
         },
         slow: {
            title: 'Hire Slow, Fire Fast',
            content: 'Take time to evaluate candidates thoroughly - a bad hire costs 2-3x their salary in lost productivity and rehiring. But once you\'ve identified a poor fit, act quickly to protect the team.'
         },
         diverse: {
            title: 'Diverse Teams',
            content: 'Diversity of thought, background, and experience leads to better decisions and innovation. Culture fit ‚â† same background. Look for shared values with different perspectives.'
         },
         values: {
            title: 'Core Values',
            content: 'Values are your decision-making framework. When facing tough choices, values guide you. They should be specific enough to matter (not just "be good") and used in actual decisions.'
         }
      };

      const calculateCultureFit = (candidate: typeof candidates[0]) => {
         if (selectedValues.length === 0) return 50;
         const sum = selectedValues.reduce((acc, val) => acc + (candidate.cultureFit[val as keyof typeof candidate.cultureFit] || 50), 0);
         return Math.round(sum / selectedValues.length);
      };

      const hireCandidate = (hire: boolean) => {
         const candidate = candidates[currentCandidate];
         const cultureFit = calculateCultureFit(candidate);

         if (hire) {
            if (budget < candidate.salary) {
               setGameLog(prev => [...prev, `‚ùå Cannot afford ${candidate.name} ($${candidate.salary.toLocaleString()})`]);
               return;
            }

            setBudget(prev => prev - candidate.salary);
            setTeam(prev => [...prev, { name: candidate.name, role: candidate.role, skills: candidate.skills, culture: cultureFit }]);

            // Update scores
            const newCulture = Math.round((cultureScore + cultureFit) / 2);
            const newProductivity = Math.round((productivityScore + candidate.skills) / 2);
            setCultureScore(newCulture);
            setProductivityScore(newProductivity);

            setGameLog(prev => [...prev,
               `‚úÖ Hired ${candidate.name} as ${candidate.role}`,
               `   Skills: ${candidate.skills}% | Culture Fit: ${cultureFit}%`,
               `   üí∞ Salary: $${candidate.salary.toLocaleString()}`
            ]);
         } else {
            setGameLog(prev => [...prev, `‚è≠Ô∏è Passed on ${candidate.name}`]);
         }

         if (currentCandidate < candidates.length - 1) {
            setCurrentCandidate(prev => prev + 1);
         } else {
            setPhase('result');
         }
      };

      const startGame = () => {
         setPhase('values');
         setSelectedValues([]);
         setTeam([]);
         setBudget(300000);
         setCultureScore(100);
         setProductivityScore(50);
         setCurrentCandidate(0);
         setGameLog([]);
      };

      const toggleValue = (valueId: string) => {
         if (selectedValues.includes(valueId)) {
            setSelectedValues(prev => prev.filter(v => v !== valueId));
         } else if (selectedValues.length < 3) {
            setSelectedValues(prev => [...prev, valueId]);
         }
      };

      const getScore = () => {
         const teamSize = team.length;
         const avgSkills = team.length > 0 ? Math.round(team.reduce((sum, t) => sum + t.skills, 0) / team.length) : 0;
         const avgCulture = team.length > 0 ? Math.round(team.reduce((sum, t) => sum + t.culture, 0) / team.length) : 0;
         const budgetEfficiency = Math.round((budget / 300000) * 100);

         let score = 0;
         if (teamSize >= 3) score += 25;
         if (avgCulture >= 80) score += 30;
         if (avgSkills >= 80) score += 25;
         if (budgetEfficiency >= 20) score += 20;

         return { score: Math.min(100, score), teamSize, avgSkills, avgCulture, budgetEfficiency };
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-2xl font-black flex items-center gap-2">üë• HIRING & TEAM CULTURE</h2>
                  <p className="text-violet-300 text-sm mt-1">Build your dream team wisely</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all">‚ÑπÔ∏è</button>
            </div>

            {showInfo && (
               <div className="bg-black/40 rounded-xl p-4 mb-4 text-sm border border-violet-500/30">
                  <p className="font-bold text-violet-200 mb-2">üìö What You'll Learn:</p>
                  <ul className="space-y-1 text-violet-300">
                     <li>‚Ä¢ How company values guide hiring</li>
                     <li>‚Ä¢ Skills vs culture fit tradeoffs</li>
                     <li>‚Ä¢ Why early hires define culture</li>
                     <li>‚Ä¢ Building effective teams</li>
                  </ul>
               </div>
            )}

            <div className="flex-1 flex flex-col justify-center">
               <div className="bg-black/30 rounded-2xl p-4 mb-6">
                  <p className="text-center text-violet-400 text-xs mb-4 font-bold uppercase tracking-wider">The Hiring Triangle</p>
                  <div className="flex justify-around items-center">
                     <div className="text-center">
                        <div className="w-14 h-14 rounded-full bg-blue-500/30 flex items-center justify-center text-2xl mb-2 mx-auto border-2 border-blue-500">üéØ</div>
                        <p className="text-xs font-bold">Skills</p>
                        <p className="text-[10px] text-violet-400">Can they do the job?</p>
                     </div>
                     <div className="text-center">
                        <div className="w-14 h-14 rounded-full bg-purple-500/30 flex items-center justify-center text-2xl mb-2 mx-auto border-2 border-purple-500">üíú</div>
                        <p className="text-xs font-bold">Culture Fit</p>
                        <p className="text-[10px] text-violet-400">Shared values?</p>
                     </div>
                     <div className="text-center">
                        <div className="w-14 h-14 rounded-full bg-pink-500/30 flex items-center justify-center text-2xl mb-2 mx-auto border-2 border-pink-500">üìà</div>
                        <p className="text-xs font-bold">Growth</p>
                        <p className="text-[10px] text-violet-400">Can they grow?</p>
                     </div>
                  </div>
               </div>

               <div className="text-center mb-6">
                  <h3 className="text-xl font-bold mb-2">üéÆ Your Mission</h3>
                  <p className="text-violet-300 max-w-lg mx-auto">
                     You're a startup founder with $300K for salaries. First, define your company values.
                     Then evaluate candidates and build your founding team!
                  </p>
               </div>

               <div className="bg-black/20 rounded-xl p-4 mb-6 max-w-sm mx-auto">
                  <p className="text-sm text-center text-violet-300 italic">
                     "Your first 10 hires define your culture forever. Hire slow, fire fast."
                  </p>
               </div>

               <button onClick={startGame} className="mx-auto px-8 py-4 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                  START HIRING ‚Üí
               </button>
            </div>
         </div>
      );

      // VALUES PHASE
      if (phase === 'values') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-xl font-black">Step 1: Define Your Values</h2>
                  <p className="text-violet-300 text-sm">Choose 3 core values for your company</p>
               </div>
               <button onClick={() => setInfoTopic('values')} className="text-violet-400 hover:text-white">‚ÑπÔ∏è</button>
            </div>

            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-violet-900 rounded-2xl p-6 max-w-md border border-violet-500" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">‚ÑπÔ∏è {infoTopics[infoTopic].title}</h3>
                     <p className="text-violet-200 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-violet-700 hover:bg-violet-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            <div className="flex-1">
               <div className="grid grid-cols-2 gap-3 mb-6">
                  {allValues.map(value => (
                     <button
                        key={value.id}
                        onClick={() => toggleValue(value.id)}
                        className={`p-4 rounded-xl text-left transition-all ${
                           selectedValues.includes(value.id)
                              ? 'bg-violet-600 border-2 border-violet-400'
                              : 'bg-black/30 border-2 border-transparent hover:border-violet-500/50'
                        }`}
                     >
                        <div className="flex items-center gap-2 mb-1">
                           <span className="text-xl">{value.icon}</span>
                           <span className="font-bold">{value.name}</span>
                           {selectedValues.includes(value.id) && <span className="ml-auto text-green-400">‚úì</span>}
                        </div>
                        <p className="text-xs text-violet-300">{value.desc}</p>
                     </button>
                  ))}
               </div>

               <div className="text-center mb-4">
                  <p className="text-violet-400 text-sm">
                     Selected: <span className="font-bold text-white">{selectedValues.length}/3</span>
                  </p>
               </div>

               <button
                  onClick={() => setPhase('play')}
                  disabled={selectedValues.length !== 3}
                  className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl font-bold text-lg transition-all"
               >
                  {selectedValues.length === 3 ? 'START INTERVIEWING ‚Üí' : `Select ${3 - selectedValues.length} more value(s)`}
               </button>
            </div>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const { score, teamSize, avgSkills, avgCulture, budgetEfficiency } = getScore();
         const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
         const gradeColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-blue-400' : score >= 40 ? 'text-yellow-400' : 'text-red-400';

         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6 overflow-auto">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-2">{score >= 80 ? 'üèÜ' : score >= 60 ? 'üë•' : score >= 40 ? 'üèóÔ∏è' : '‚ö†Ô∏è'}</div>
                  <h2 className="text-3xl font-black">Team Built!</h2>
                  <p className={`text-5xl font-black mt-2 ${gradeColor}`}>Grade: {grade}</p>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4 max-w-md mx-auto">
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-violet-400">{teamSize}</p>
                     <p className="text-xs text-violet-300">Team Size</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-green-400">${budget.toLocaleString()}</p>
                     <p className="text-xs text-violet-300">Budget Left</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-blue-400">{avgSkills}%</p>
                     <p className="text-xs text-violet-300">Avg Skills</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-purple-400">{avgCulture}%</p>
                     <p className="text-xs text-violet-300">Avg Culture Fit</p>
                  </div>
               </div>

               {team.length > 0 && (
                  <div className="bg-black/20 rounded-xl p-3 mb-4">
                     <p className="text-xs font-bold text-violet-400 mb-2">Your Team:</p>
                     <div className="flex gap-2 flex-wrap">
                        {team.map((member, i) => (
                           <span key={i} className="text-xs px-2 py-1 bg-violet-900/50 rounded-lg">
                              {member.name} ({member.role})
                           </span>
                        ))}
                     </div>
                  </div>
               )}

               <div className="bg-violet-900/40 rounded-xl p-4 mb-4 border border-violet-500/30">
                  <p className="font-bold text-violet-300 mb-2 flex items-center gap-2">
                     <span className="w-6 h-6 rounded-full bg-violet-500 flex items-center justify-center text-sm">üí°</span>
                     Key Takeaways
                  </p>
                  <ul className="text-sm text-violet-200 space-y-1">
                     <li>‚Ä¢ <strong>Values first</strong> - define culture before hiring</li>
                     <li>‚Ä¢ <strong>Skills + Culture</strong> - both matter, but culture is harder to change</li>
                     <li>‚Ä¢ <strong>Early hires</strong> set the standard for everyone after</li>
                     <li>‚Ä¢ <strong>Red flags</strong> rarely get better after hiring</li>
                  </ul>
               </div>

               <button onClick={startGame} className="mx-auto px-6 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-xl font-bold transition-all">
                  üîÑ HIRE AGAIN
               </button>
            </div>
         );
      }

      // PLAY PHASE
      const candidate = candidates[currentCandidate];
      const cultureFit = calculateCultureFit(candidate);

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white overflow-hidden">
            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-violet-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-black">Candidate {currentCandidate + 1} / {candidates.length}</span>
                  <span className="px-3 py-1 bg-green-900/50 rounded-full text-sm font-bold text-green-300">
                     üí∞ ${budget.toLocaleString()}
                  </span>
               </div>
               <div className="flex gap-3 text-xs">
                  <span className="text-violet-300">Team: {team.length}</span>
                  <span className="text-violet-500">|</span>
                  <span className="text-purple-300">Culture: {cultureScore}%</span>
                  <span className="text-violet-500">|</span>
                  <span className="text-blue-300">Productivity: {productivityScore}%</span>
               </div>
            </div>

            {/* Info modal */}
            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-violet-900 rounded-2xl p-6 max-w-md border border-violet-500" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">‚ÑπÔ∏è {infoTopics[infoTopic].title}</h3>
                     <p className="text-violet-200 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-violet-700 hover:bg-violet-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            <div className="flex-1 p-4 overflow-auto">
               {/* Candidate Card */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <div className="flex items-start gap-4 mb-4">
                     <div className="text-5xl">{candidate.avatar}</div>
                     <div className="flex-1">
                        <h3 className="text-xl font-black">{candidate.name}</h3>
                        <p className="text-violet-400 text-sm">{candidate.role}</p>
                        <p className="text-violet-300 text-xs mt-1">{candidate.experience} years experience</p>
                     </div>
                     <div className="text-right">
                        <p className="text-lg font-black text-green-400">${candidate.salary.toLocaleString()}</p>
                        <p className="text-xs text-violet-400">annual salary</p>
                     </div>
                  </div>

                  <p className="text-sm text-violet-200 mb-4 italic">"{candidate.personality}"</p>

                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <div className="bg-black/20 rounded-lg p-3">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-xs text-violet-400">Skills</span>
                           <button onClick={() => setInfoTopic('skills')} className="text-violet-500 hover:text-white text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="flex items-center gap-2">
                           <div className="flex-1 h-2 bg-black/40 rounded-full overflow-hidden">
                              <div className="h-full bg-blue-500" style={{ width: `${candidate.skills}%` }} />
                           </div>
                           <span className="text-sm font-bold text-blue-400">{candidate.skills}%</span>
                        </div>
                     </div>
                     <div className="bg-black/20 rounded-lg p-3">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-xs text-violet-400">Culture Fit</span>
                           <button onClick={() => setInfoTopic('culture')} className="text-violet-500 hover:text-white text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="flex items-center gap-2">
                           <div className="flex-1 h-2 bg-black/40 rounded-full overflow-hidden">
                              <div className={`h-full ${cultureFit >= 80 ? 'bg-green-500' : cultureFit >= 60 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${cultureFit}%` }} />
                           </div>
                           <span className={`text-sm font-bold ${cultureFit >= 80 ? 'text-green-400' : cultureFit >= 60 ? 'text-yellow-400' : 'text-red-400'}`}>{cultureFit}%</span>
                        </div>
                     </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                     <div className="bg-red-900/30 rounded-lg p-2 border border-red-500/30">
                        <p className="text-xs font-bold text-red-400 mb-1">üö© Red Flag</p>
                        <p className="text-xs text-red-300">{candidate.redFlag}</p>
                     </div>
                     <div className="bg-green-900/30 rounded-lg p-2 border border-green-500/30">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úÖ Green Flag</p>
                        <p className="text-xs text-green-300">{candidate.greenFlag}</p>
                     </div>
                  </div>
               </div>

               {/* Decision buttons */}
               <div className="grid grid-cols-2 gap-3">
                  <button
                     onClick={() => hireCandidate(false)}
                     className="py-4 bg-red-900/50 hover:bg-red-800/50 border-2 border-red-500/30 hover:border-red-500 rounded-xl font-bold transition-all"
                  >
                     ‚è≠Ô∏è PASS
                  </button>
                  <button
                     onClick={() => hireCandidate(true)}
                     disabled={budget < candidate.salary}
                     className="py-4 bg-green-900/50 hover:bg-green-800/50 border-2 border-green-500/30 hover:border-green-500 rounded-xl font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                     ‚úÖ HIRE (${candidate.salary.toLocaleString()})
                  </button>
               </div>
            </div>

            {/* Team panel */}
            {team.length > 0 && (
               <div className="h-16 bg-black/40 border-t border-violet-500/30 p-2 flex items-center gap-2 overflow-x-auto">
                  <span className="text-[10px] font-bold text-violet-500 mr-2">TEAM:</span>
                  {team.map((member, i) => (
                     <span key={i} className="text-xs px-2 py-1 bg-violet-900/50 rounded-lg whitespace-nowrap">
                        {member.name.split(' ')[0]}
                     </span>
                  ))}
               </div>
            )}
         </div>
      );
   };

   // ============================================================================
   // PROJECT MANAGEMENT INTERACTIVE
   // ============================================================================
   const ProjectManagementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [day, setDay] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      // Project settings
      const deadline = 14; // days
      const teamCapacity = 3; // tasks per day

      // Tasks with Kanban states
      const [tasks, setTasks] = useState<{
         id: string;
         name: string;
         icon: string;
         status: 'backlog' | 'todo' | 'doing' | 'done';
         effort: number; // days to complete
         priority: 'high' | 'medium' | 'low';
         blockedBy?: string;
         daysWorked: number;
      }[]>([]);

      const initialTasks = [
         { id: 'design', name: 'UI Design', icon: 'üé®', effort: 2, priority: 'high' as const, blockedBy: undefined },
         { id: 'backend', name: 'Backend API', icon: '‚öôÔ∏è', effort: 3, priority: 'high' as const, blockedBy: undefined },
         { id: 'frontend', name: 'Frontend Dev', icon: 'üíª', effort: 3, priority: 'high' as const, blockedBy: 'design' },
         { id: 'database', name: 'Database Setup', icon: 'üóÑÔ∏è', effort: 1, priority: 'medium' as const, blockedBy: undefined },
         { id: 'testing', name: 'Testing', icon: 'üß™', effort: 2, priority: 'medium' as const, blockedBy: 'frontend' },
         { id: 'docs', name: 'Documentation', icon: 'üìù', effort: 1, priority: 'low' as const, blockedBy: undefined },
         { id: 'deploy', name: 'Deployment', icon: 'üöÄ', effort: 1, priority: 'high' as const, blockedBy: 'testing' },
      ];

      // Scope creep events
      const scopeCreepTasks = [
         { id: 'auth', name: 'Add Auth System', icon: 'üîê', effort: 2, priority: 'high' as const },
         { id: 'analytics', name: 'Analytics Dashboard', icon: 'üìä', effort: 2, priority: 'medium' as const },
         { id: 'mobile', name: 'Mobile Responsive', icon: 'üì±', effort: 1, priority: 'medium' as const },
      ];

      const [scopeCreepAdded, setScopeCreepAdded] = useState(0);
      const [completedOnTime, setCompletedOnTime] = useState(false);

      const infoTopics: Record<string, { title: string; content: string }> = {
         kanban: {
            title: 'Kanban Board',
            content: 'Kanban visualizes work as cards moving through columns (To Do ‚Üí Doing ‚Üí Done). It limits work-in-progress, reveals bottlenecks, and helps teams focus on finishing work rather than starting new tasks.'
         },
         priority: {
            title: 'Task Prioritization',
            content: 'Not all tasks are equal. High priority tasks are critical path items that block other work. Focus on high-priority items first, but don\'t neglect medium/low priority tasks that pile up.'
         },
         dependencies: {
            title: 'Task Dependencies',
            content: 'Some tasks can\'t start until others finish (e.g., can\'t test before building). Identifying dependencies helps plan the critical path - the longest chain that determines minimum project duration.'
         },
         scope: {
            title: 'Scope Creep',
            content: 'Scope creep is when new requirements keep getting added during a project. It\'s a major cause of delays and budget overruns. Learn to say "that\'s a great idea for v2" and protect your timeline.'
         },
         capacity: {
            title: 'Team Capacity',
            content: 'Your team can only work on a limited number of tasks simultaneously. Overloading leads to context switching and slower progress. Respect capacity limits and focus on throughput, not busyness.'
         },
         wip: {
            title: 'Work In Progress (WIP)',
            content: 'WIP limits are constraints on how many tasks can be "in progress" at once. Lower WIP = faster completion of individual tasks = better flow. Stop starting, start finishing!'
         }
      };

      const getBlockedTasks = () => {
         return tasks.filter(t => {
            if (!t.blockedBy) return false;
            const blocker = tasks.find(b => b.id === t.blockedBy);
            return blocker && blocker.status !== 'done';
         }).map(t => t.id);
      };

      const moveTask = (taskId: string, newStatus: 'todo' | 'doing' | 'done') => {
         const blockedTasks = getBlockedTasks();

         setTasks(prev => prev.map(t => {
            if (t.id === taskId) {
               // Can't move blocked tasks to doing
               if (newStatus === 'doing' && blockedTasks.includes(taskId)) {
                  setGameLog(prev => [...prev, `‚ö†Ô∏è ${t.name} is blocked by ${tasks.find(b => b.id === t.blockedBy)?.name}`]);
                  return t;
               }

               // Check capacity for doing
               if (newStatus === 'doing') {
                  const doingCount = prev.filter(p => p.status === 'doing').length;
                  if (doingCount >= teamCapacity) {
                     setGameLog(prev => [...prev, `‚ö†Ô∏è Team at capacity! Finish tasks before starting new ones.`]);
                     return t;
                  }
               }

               return { ...t, status: newStatus };
            }
            return t;
         }));
      };

      const processDay = () => {
         let newLog: string[] = [`üìÖ Day ${day}`];

         // Progress tasks in "doing"
         setTasks(prev => {
            const updated = prev.map(t => {
               if (t.status === 'doing') {
                  const newDaysWorked = t.daysWorked + 1;
                  if (newDaysWorked >= t.effort) {
                     newLog.push(`‚úÖ Completed: ${t.name}`);
                     return { ...t, status: 'done' as const, daysWorked: newDaysWorked };
                  }
                  return { ...t, daysWorked: newDaysWorked };
               }
               return t;
            });
            return updated;
         });

         // Scope creep chance (20% after day 3)
         if (day > 3 && scopeCreepAdded < scopeCreepTasks.length && Math.random() < 0.25) {
            const newTask = scopeCreepTasks[scopeCreepAdded];
            setTasks(prev => [...prev, { ...newTask, status: 'backlog', daysWorked: 0 }]);
            setScopeCreepAdded(prev => prev + 1);
            newLog.push(`üÜï SCOPE CREEP: "${newTask.name}" added to backlog!`);
         }

         setGameLog(prev => [...prev, ...newLog]);

         // Check win/lose
         const allDone = tasks.filter(t => t.status !== 'done').length === 0 && tasks.length > 0;
         if (allDone) {
            setCompletedOnTime(day <= deadline);
            setPhase('result');
            return;
         }

         if (day >= deadline) {
            setCompletedOnTime(false);
            setPhase('result');
            return;
         }

         setDay(d => d + 1);
      };

      const startGame = () => {
         setPhase('play');
         setDay(1);
         setTasks(initialTasks.map(t => ({ ...t, status: 'backlog' as const, daysWorked: 0 })));
         setScopeCreepAdded(0);
         setGameLog([]);
         setCompletedOnTime(false);
      };

      const getScore = () => {
         const completedTasks = tasks.filter(t => t.status === 'done').length;
         const totalTasks = tasks.length;
         const completionRate = Math.round((completedTasks / totalTasks) * 100);
         const daysUsed = day;
         const efficiency = deadline > 0 ? Math.round(((deadline - daysUsed + 1) / deadline) * 100) : 0;

         let score = 0;
         if (completedOnTime) score += 40;
         score += Math.round(completionRate * 0.4);
         if (efficiency > 0) score += Math.round(efficiency * 0.2);

         return { score: Math.min(100, Math.max(0, score)), completedTasks, totalTasks, completionRate, daysUsed };
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6 overflow-auto">
            <div className="flex justify-between items-start mb-4">
               <div>
                  <h2 className="text-2xl font-black flex items-center gap-2">üìã PROJECT MANAGEMENT</h2>
                  <p className="text-orange-300 text-sm mt-1">Lead your team to ship on time</p>
               </div>
               <button onClick={() => setShowInfo(!showInfo)} className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all">‚ÑπÔ∏è</button>
            </div>

            {showInfo && (
               <div className="bg-black/40 rounded-xl p-4 mb-4 text-sm border border-orange-500/30">
                  <p className="font-bold text-orange-200 mb-2">üìö What You'll Learn:</p>
                  <ul className="space-y-1 text-orange-300">
                     <li>‚Ä¢ How Kanban boards organize work</li>
                     <li>‚Ä¢ Task prioritization and dependencies</li>
                     <li>‚Ä¢ Managing team capacity</li>
                     <li>‚Ä¢ Dealing with scope creep</li>
                  </ul>
               </div>
            )}

            <div className="flex-1 flex flex-col justify-center">
               <div className="bg-black/30 rounded-2xl p-4 mb-6">
                  <p className="text-center text-orange-400 text-xs mb-4 font-bold uppercase tracking-wider">The Kanban Flow</p>
                  <div className="flex justify-around items-center">
                     {['üì• Backlog', 'üìã To Do', 'üîÑ Doing', '‚úÖ Done'].map((stage, i) => (
                        <div key={i} className="text-center">
                           <div className="w-14 h-14 rounded-xl bg-orange-500/20 flex items-center justify-center text-xl mb-1 border border-orange-500/30">
                              {stage.split(' ')[0]}
                           </div>
                           <p className="text-[10px] text-orange-400">{stage.split(' ')[1]}</p>
                        </div>
                     ))}
                  </div>
                  <div className="flex justify-around mt-2">
                     {['‚Üí', '‚Üí', '‚Üí'].map((arrow, i) => (
                        <span key={i} className="text-orange-500 text-lg">‚Üí</span>
                     ))}
                  </div>
               </div>

               <div className="text-center mb-6">
                  <h3 className="text-xl font-bold mb-2">üéÆ Your Mission</h3>
                  <p className="text-orange-300 max-w-lg mx-auto">
                     You have <span className="font-bold text-white">{deadline} days</span> to ship a product.
                     Move tasks through the Kanban board, respect dependencies, and watch out for scope creep!
                  </p>
               </div>

               <div className="grid grid-cols-3 gap-3 mb-6 max-w-md mx-auto text-center">
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">‚è±Ô∏è</span>
                     <p className="text-[10px] text-orange-400">{deadline} Day Deadline</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">üë•</span>
                     <p className="text-[10px] text-orange-400">{teamCapacity} Tasks/Day Max</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-xl">üîó</span>
                     <p className="text-[10px] text-orange-400">Dependencies</p>
                  </div>
               </div>

               <button onClick={startGame} className="mx-auto px-8 py-4 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                  START PROJECT ‚Üí
               </button>
            </div>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const { score, completedTasks, totalTasks, completionRate, daysUsed } = getScore();
         const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
         const gradeColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-blue-400' : score >= 40 ? 'text-yellow-400' : 'text-red-400';

         return (
            <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6 overflow-auto">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-2">{completedOnTime ? 'üöÄ' : '‚è∞'}</div>
                  <h2 className="text-3xl font-black">{completedOnTime ? 'Shipped On Time!' : 'Deadline Missed'}</h2>
                  <p className={`text-5xl font-black mt-2 ${gradeColor}`}>Grade: {grade}</p>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4 max-w-md mx-auto">
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-green-400">{completedTasks}/{totalTasks}</p>
                     <p className="text-xs text-orange-300">Tasks Done</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-blue-400">{completionRate}%</p>
                     <p className="text-xs text-orange-300">Completion</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-purple-400">{daysUsed}</p>
                     <p className="text-xs text-orange-300">Days Used</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-3 text-center">
                     <p className="text-xl font-black text-amber-400">{scopeCreepAdded}</p>
                     <p className="text-xs text-orange-300">Scope Creep Items</p>
                  </div>
               </div>

               <div className="bg-orange-900/40 rounded-xl p-4 mb-4 border border-orange-500/30">
                  <p className="font-bold text-orange-300 mb-2 flex items-center gap-2">
                     <span className="w-6 h-6 rounded-full bg-orange-500 flex items-center justify-center text-sm">üí°</span>
                     Key Takeaways
                  </p>
                  <ul className="text-sm text-orange-200 space-y-1">
                     <li>‚Ä¢ <strong>Dependencies</strong> define your critical path</li>
                     <li>‚Ä¢ <strong>WIP limits</strong> prevent overload and improve focus</li>
                     <li>‚Ä¢ <strong>Scope creep</strong> is the #1 project killer - learn to say no</li>
                     <li>‚Ä¢ <strong>Prioritize ruthlessly</strong> - not everything is urgent</li>
                  </ul>
               </div>

               <button onClick={startGame} className="mx-auto px-6 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 rounded-xl font-bold transition-all">
                  üîÑ TRY AGAIN
               </button>
            </div>
         );
      }

      // PLAY PHASE
      const blockedTasks = getBlockedTasks();
      const doingCount = tasks.filter(t => t.status === 'doing').length;
      const doneCount = tasks.filter(t => t.status === 'done').length;
      const columns: ('backlog' | 'todo' | 'doing' | 'done')[] = ['backlog', 'todo', 'doing', 'done'];
      const columnLabels = { backlog: 'üì• Backlog', todo: 'üìã To Do', doing: 'üîÑ Doing', done: '‚úÖ Done' };

      return (
         <div className="flex flex-col h-full bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white overflow-hidden">
            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-orange-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-black">üìÖ Day {day} / {deadline}</span>
                  <div className="flex gap-2">
                     <span className={`px-3 py-1 rounded-full text-sm font-bold ${day <= deadline - 3 ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}`}>
                        {deadline - day} days left
                     </span>
                  </div>
               </div>
               <div className="w-full h-2 bg-black/40 rounded-full overflow-hidden">
                  <div className="h-full bg-gradient-to-r from-orange-500 to-amber-500 transition-all" style={{ width: `${(day / deadline) * 100}%` }} />
               </div>
            </div>

            {/* Info modal */}
            {infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setInfoTopic(null)}>
                  <div className="bg-orange-900 rounded-2xl p-6 max-w-md border border-orange-500" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-black mb-2 flex items-center gap-2">‚ÑπÔ∏è {infoTopics[infoTopic].title}</h3>
                     <p className="text-orange-200 text-sm leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => setInfoTopic(null)} className="mt-4 px-4 py-2 bg-orange-700 hover:bg-orange-600 rounded-lg text-sm font-bold w-full">Got it!</button>
                  </div>
               </div>
            )}

            {/* Kanban Board */}
            <div className="flex-1 p-2 overflow-x-auto">
               <div className="flex gap-2 h-full min-w-[600px]">
                  {columns.map(col => (
                     <div key={col} className="flex-1 bg-black/20 rounded-xl p-2 flex flex-col min-w-[140px]">
                        <div className="flex justify-between items-center mb-2">
                           <span className="text-xs font-bold text-orange-400">{columnLabels[col]}</span>
                           {col === 'doing' && (
                              <span className={`text-[10px] px-1.5 py-0.5 rounded ${doingCount >= teamCapacity ? 'bg-red-500' : 'bg-green-500/50'}`}>
                                 {doingCount}/{teamCapacity}
                              </span>
                           )}
                           {col === 'kanban' && <button onClick={() => setInfoTopic('kanban')} className="text-orange-500 text-xs">‚ÑπÔ∏è</button>}
                        </div>
                        <div className="flex-1 space-y-2 overflow-y-auto">
                           {tasks.filter(t => t.status === col).map(task => {
                              const isBlocked = blockedTasks.includes(task.id);
                              const blocker = task.blockedBy ? tasks.find(b => b.id === task.blockedBy) : null;
                              const progress = task.status === 'doing' ? (task.daysWorked / task.effort) * 100 : 0;

                              return (
                                 <div
                                    key={task.id}
                                    className={`p-2 rounded-lg text-xs transition-all ${
                                       isBlocked ? 'bg-red-900/30 border border-red-500/30' :
                                       task.status === 'done' ? 'bg-green-900/30 border border-green-500/30' :
                                       'bg-black/30 border border-orange-500/20'
                                    }`}
                                 >
                                    <div className="flex items-center gap-1 mb-1">
                                       <span>{task.icon}</span>
                                       <span className="font-bold truncate flex-1">{task.name}</span>
                                       <span className={`w-2 h-2 rounded-full ${
                                          task.priority === 'high' ? 'bg-red-500' :
                                          task.priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500'
                                       }`} />
                                    </div>

                                    {task.status === 'doing' && (
                                       <div className="h-1 bg-black/40 rounded-full overflow-hidden mb-1">
                                          <div className="h-full bg-blue-500 transition-all" style={{ width: `${progress}%` }} />
                                       </div>
                                    )}

                                    {isBlocked && blocker && (
                                       <p className="text-red-400 text-[10px]">üîí Blocked by {blocker.name}</p>
                                    )}

                                    <div className="text-[10px] text-orange-400 mb-1">
                                       ‚è±Ô∏è {task.effort}d effort
                                    </div>

                                    {/* Move buttons */}
                                    {task.status !== 'done' && (
                                       <div className="flex gap-1 mt-1">
                                          {task.status === 'backlog' && (
                                             <button onClick={() => moveTask(task.id, 'todo')} className="flex-1 py-1 bg-orange-700/50 hover:bg-orange-600/50 rounded text-[10px]">
                                                ‚Üí To Do
                                             </button>
                                          )}
                                          {task.status === 'todo' && (
                                             <button
                                                onClick={() => moveTask(task.id, 'doing')}
                                                disabled={isBlocked || doingCount >= teamCapacity}
                                                className="flex-1 py-1 bg-blue-700/50 hover:bg-blue-600/50 disabled:opacity-50 rounded text-[10px]"
                                             >
                                                ‚Üí Start
                                             </button>
                                          )}
                                       </div>
                                    )}
                                 </div>
                              );
                           })}
                        </div>
                     </div>
                  ))}
               </div>
            </div>

            {/* Action Bar */}
            <div className="p-3 bg-black/30 border-t border-orange-500/30">
               <div className="flex gap-2 items-center justify-between mb-2">
                  <div className="flex gap-2">
                     <button onClick={() => setInfoTopic('dependencies')} className="text-xs text-orange-400 hover:text-white">üîó Dependencies</button>
                     <button onClick={() => setInfoTopic('scope')} className="text-xs text-orange-400 hover:text-white">üÜï Scope Creep</button>
                     <button onClick={() => setInfoTopic('wip')} className="text-xs text-orange-400 hover:text-white">üìä WIP Limits</button>
                  </div>
                  <span className="text-xs text-orange-400">{doneCount}/{tasks.length} complete</span>
               </div>
               <button
                  onClick={processDay}
                  className="w-full py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 rounded-xl font-bold transition-all"
               >
                  ‚ñ∂Ô∏è END DAY {day}
               </button>
            </div>
         </div>
      );
   };

   // --- QUALITY CONTROL RENDERER ---
   const QualityControlRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [batch, setBatch] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const totalBatches = 10;
      const batchSize = 100; // units per batch

      const [inspectionRate, setInspectionRate] = useState(20); // % of units inspected
      const [qualityStandard, setQualityStandard] = useState<'loose' | 'standard' | 'strict'>('standard');

      const [stats, setStats] = useState({
         totalProduced: 0,
         totalInspected: 0,
         defectsFound: 0,
         defectsShipped: 0,
         customerReturns: 0,
         inspectionCost: 0,
         returnCost: 0,
         reputationScore: 100,
      });

      const [currentBatch, setCurrentBatch] = useState<{
         units: { id: number; hasDefect: boolean; inspected: boolean; shipped: boolean }[];
         baseDefectRate: number;
      } | null>(null);

      const [batchHistory, setBatchHistory] = useState<{
         batch: number;
         defectRate: number;
         defectsFound: number;
         defectsShipped: number;
         returns: number;
      }[]>([]);

      const infoTopics: Record<string, { title: string; content: string }> = {
         inspection: {
            title: "Inspection Rate",
            content: "The percentage of products you physically check for defects. 100% inspection catches all defects but is expensive. Sampling (checking 10-30%) reduces costs but lets some defects through. Statistical quality control helps find the optimal balance."
         },
         standards: {
            title: "Quality Standards",
            content: "How strict your acceptance criteria are. LOOSE: Accept minor flaws, fewer rejections but more customer complaints. STANDARD: Industry-normal tolerances. STRICT: Reject anything imperfect‚Äîhigher costs but better reputation. Six Sigma aims for 3.4 defects per million!"
         },
         cost_of_quality: {
            title: "Cost of Quality",
            content: "Quality costs include: PREVENTION (training, better equipment), APPRAISAL (inspection, testing), INTERNAL FAILURE (rework, scrap), EXTERNAL FAILURE (returns, warranty, reputation damage). It's often cheaper to prevent defects than find them later!"
         },
         six_sigma: {
            title: "Six Sigma",
            content: "A methodology targeting near-perfect quality: only 3.4 defects per million opportunities. Uses DMAIC: Define, Measure, Analyze, Improve, Control. Developed at Motorola, popularized by GE. A 'sigma level' measures process capability‚Äî6œÉ means 99.99966% defect-free."
         },
         continuous: {
            title: "Continuous Improvement",
            content: "Kaizen (Japanese for 'change for better') means constantly making small improvements. Track defects, find root causes, implement fixes, verify results. Quality isn't a destination‚Äîit's an ongoing journey. Every defect is a learning opportunity!"
         }
      };

      useEffect(() => {
         if (infoTopic && infoTopics[infoTopic]) {
            setShowInfo(true);
         }
      }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setBatch(1);
         setStats({
            totalProduced: 0,
            totalInspected: 0,
            defectsFound: 0,
            defectsShipped: 0,
            customerReturns: 0,
            inspectionCost: 0,
            returnCost: 0,
            reputationScore: 100,
         });
         setBatchHistory([]);
         setGameLog(["Quality Control simulation started"]);
         generateBatch(1);
      };

      const generateBatch = (batchNum: number) => {
         // Base defect rate varies by batch (simulating process variation)
         const baseRate = 0.05 + Math.random() * 0.15; // 5-20% defect rate

         const units = Array.from({ length: batchSize }, (_, i) => ({
            id: i,
            hasDefect: Math.random() < baseRate,
            inspected: false,
            shipped: false,
         }));

         setCurrentBatch({ units, baseDefectRate: baseRate });
         setGameLog(prev => [...prev, `Batch ${batchNum} produced with ${batchSize} units`]);
      };

      const processBatch = () => {
         if (!currentBatch) return;

         const unitsToInspect = Math.floor(batchSize * (inspectionRate / 100));
         const inspectionCostPerUnit = 2;
         const returnCostPerUnit = 50;

         // Randomly select units to inspect
         const shuffled = [...currentBatch.units].sort(() => Math.random() - 0.5);
         const inspected = shuffled.slice(0, unitsToInspect);
         const notInspected = shuffled.slice(unitsToInspect);

         // Find defects based on quality standard
         const defectThreshold = qualityStandard === 'loose' ? 0.7 : qualityStandard === 'strict' ? 0.3 : 0.5;

         let defectsFound = 0;
         inspected.forEach(unit => {
            if (unit.hasDefect && Math.random() > defectThreshold) {
               defectsFound++;
            }
         });

         // Defects that slip through (not inspected or missed during inspection)
         const actualDefects = currentBatch.units.filter(u => u.hasDefect).length;
         const defectsShipped = actualDefects - defectsFound;

         // Customer returns (some % of shipped defects get returned)
         const returnRate = qualityStandard === 'loose' ? 0.6 : qualityStandard === 'strict' ? 0.3 : 0.4;
         const returns = Math.floor(defectsShipped * returnRate);

         // Calculate costs
         const batchInspectionCost = unitsToInspect * inspectionCostPerUnit;
         const batchReturnCost = returns * returnCostPerUnit;

         // Reputation impact
         const reputationHit = returns * 2;

         const newStats = {
            totalProduced: stats.totalProduced + batchSize,
            totalInspected: stats.totalInspected + unitsToInspect,
            defectsFound: stats.defectsFound + defectsFound,
            defectsShipped: stats.defectsShipped + defectsShipped,
            customerReturns: stats.customerReturns + returns,
            inspectionCost: stats.inspectionCost + batchInspectionCost,
            returnCost: stats.returnCost + batchReturnCost,
            reputationScore: Math.max(0, stats.reputationScore - reputationHit),
         };
         setStats(newStats);

         setBatchHistory(prev => [...prev, {
            batch,
            defectRate: currentBatch.baseDefectRate * 100,
            defectsFound,
            defectsShipped,
            returns
         }]);

         setGameLog(prev => [...prev,
            `Batch ${batch}: Inspected ${unitsToInspect} units, found ${defectsFound} defects, ${defectsShipped} shipped with defects, ${returns} returns`
         ]);

         if (batch >= totalBatches) {
            setGameLog(prev => [...prev,
               `Simulation complete! Total cost: $${newStats.inspectionCost + newStats.returnCost}, Reputation: ${newStats.reputationScore}%`
            ]);
            setPhase('result');
         } else {
            setBatch(batch + 1);
            generateBatch(batch + 1);
         }
      };

      const getScore = () => {
         const totalCost = stats.inspectionCost + stats.returnCost;
         const costScore = Math.max(0, 100 - (totalCost / 50)); // Lower cost = higher score
         const reputationScore = stats.reputationScore;
         const defectRateScore = Math.max(0, 100 - (stats.defectsShipped / stats.totalProduced) * 500);

         return Math.round((costScore + reputationScore + defectRateScore) / 3);
      };

      const getGrade = () => {
         const score = getScore();
         if (score >= 85) return { letter: 'A', label: 'Quality Master', color: 'text-green-400' };
         if (score >= 70) return { letter: 'B', label: 'Quality Manager', color: 'text-blue-400' };
         if (score >= 55) return { letter: 'C', label: 'Quality Novice', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Needs Improvement', color: 'text-red-400' };
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-teal-900 via-cyan-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <h1 className="text-2xl font-bold mb-2">üîç Quality Control Simulator</h1>
                  <p className="text-cyan-300 text-sm">Master the art of balancing cost and quality</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-3 text-cyan-400">üìã How It Works</h2>
                  <div className="space-y-2 text-sm">
                     <p>‚Ä¢ You manage quality control for <span className="text-white font-bold">{totalBatches} production batches</span></p>
                     <p>‚Ä¢ Each batch contains <span className="text-white font-bold">{batchSize} units</span> with varying defect rates</p>
                     <p>‚Ä¢ Set your <span className="text-cyan-400">inspection rate</span> (% of units to check)</p>
                     <p>‚Ä¢ Choose your <span className="text-cyan-400">quality standard</span> (how strict)</p>
                     <p>‚Ä¢ Balance inspection costs vs customer returns!</p>
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3">
                     <h3 className="font-bold text-red-400 mb-2">üí∏ Costs</h3>
                     <p className="text-xs text-slate-300">Inspection: $2/unit</p>
                     <p className="text-xs text-slate-300">Return: $50/unit</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3">
                     <h3 className="font-bold text-green-400 mb-2">üéØ Goal</h3>
                     <p className="text-xs text-slate-300">Minimize total costs</p>
                     <p className="text-xs text-slate-300">Keep reputation high!</p>
                  </div>
               </div>

               <div className="flex flex-wrap gap-2 mb-4">
                  {Object.keys(infoTopics).map(key => (
                     <button
                        key={key}
                        onClick={() => setInfoTopic(key)}
                        className="text-xs bg-cyan-500/20 hover:bg-cyan-500/40 px-2 py-1 rounded-full text-cyan-300"
                     >
                        ‚ÑπÔ∏è {infoTopics[key].title}
                     </button>
                  ))}
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 rounded-xl font-bold text-lg transition-all"
               >
                  ‚ñ∂Ô∏è START PRODUCTION
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-cyan-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-cyan-600 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const grade = getGrade();
         const totalCost = stats.inspectionCost + stats.returnCost;
         const defectRate = ((stats.defectsShipped / stats.totalProduced) * 100).toFixed(1);

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-teal-900 via-cyan-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-cyan-400">Score: {getScore()}/100</div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-green-400">{stats.reputationScore}%</div>
                     <div className="text-xs text-slate-400">Reputation</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-red-400">${totalCost}</div>
                     <div className="text-xs text-slate-400">Total Cost</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-yellow-400">{defectRate}%</div>
                     <div className="text-xs text-slate-400">Shipped Defect Rate</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-orange-400">{stats.customerReturns}</div>
                     <div className="text-xs text-slate-400">Customer Returns</div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-cyan-400 mb-2">üìä Cost Breakdown</h3>
                  <div className="flex justify-between text-sm">
                     <span>Inspection Costs:</span>
                     <span className="text-cyan-300">${stats.inspectionCost}</span>
                  </div>
                  <div className="flex justify-between text-sm">
                     <span>Return Costs:</span>
                     <span className="text-red-300">${stats.returnCost}</span>
                  </div>
                  <div className="flex justify-between text-sm font-bold border-t border-slate-600 mt-2 pt-2">
                     <span>Total:</span>
                     <span>${totalCost}</span>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-cyan-400 mb-2">üí° Key Insight</h3>
                  <p className="text-sm text-slate-300">
                     {stats.returnCost > stats.inspectionCost
                        ? "Your return costs exceeded inspection costs! It's often cheaper to catch defects before shipping than to handle returns. Consider increasing your inspection rate."
                        : stats.reputationScore < 60
                        ? "Your reputation took a hit from too many defective products reaching customers. Quality builds trust‚Äîinvest in prevention!"
                        : "Good balance! You found the sweet spot between inspection costs and quality. Remember: prevention is cheaper than correction."
                     }
                  </p>
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 rounded-xl font-bold transition-all"
               >
                  üîÑ TRY AGAIN
               </button>
            </div>
         );
      }

      // Play Phase
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-teal-900 via-cyan-900 to-slate-900 text-white overflow-hidden">
            {/* Info Modal */}
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-cyan-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-cyan-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-cyan-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="font-bold">üîç Quality Control</span>
                  <span className="text-cyan-400">Batch {batch}/{totalBatches}</span>
               </div>
               <div className="grid grid-cols-4 gap-2 text-center text-xs">
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-green-400 font-bold">{stats.reputationScore}%</div>
                     <div className="text-slate-500">Reputation</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-cyan-400 font-bold">${stats.inspectionCost}</div>
                     <div className="text-slate-500">Inspect $</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-red-400 font-bold">${stats.returnCost}</div>
                     <div className="text-slate-500">Return $</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-yellow-400 font-bold">{stats.customerReturns}</div>
                     <div className="text-slate-500">Returns</div>
                  </div>
               </div>
            </div>

            {/* Control Panel */}
            <div className="p-3 space-y-3">
               {/* Inspection Rate Slider */}
               <div className="bg-black/30 rounded-lg p-3">
                  <div className="flex justify-between items-center mb-2">
                     <span className="text-sm font-bold">Inspection Rate</span>
                     <button onClick={() => setInfoTopic('inspection')} className="text-cyan-400 text-xs">‚ÑπÔ∏è</button>
                  </div>
                  <input
                     type="range"
                     min="0"
                     max="100"
                     step="10"
                     value={inspectionRate}
                     onChange={(e) => setInspectionRate(Number(e.target.value))}
                     className="w-full accent-cyan-500"
                  />
                  <div className="flex justify-between text-xs text-slate-400 mt-1">
                     <span>0%</span>
                     <span className="text-cyan-400 font-bold">{inspectionRate}% ({Math.floor(batchSize * inspectionRate / 100)} units)</span>
                     <span>100%</span>
                  </div>
               </div>

               {/* Quality Standard Selector */}
               <div className="bg-black/30 rounded-lg p-3">
                  <div className="flex justify-between items-center mb-2">
                     <span className="text-sm font-bold">Quality Standard</span>
                     <button onClick={() => setInfoTopic('standards')} className="text-cyan-400 text-xs">‚ÑπÔ∏è</button>
                  </div>
                  <div className="grid grid-cols-3 gap-2">
                     {(['loose', 'standard', 'strict'] as const).map(std => (
                        <button
                           key={std}
                           onClick={() => setQualityStandard(std)}
                           className={`py-2 rounded-lg text-xs font-bold transition-all ${
                              qualityStandard === std
                                 ? 'bg-cyan-600 text-white'
                                 : 'bg-slate-700/50 text-slate-400 hover:bg-slate-600/50'
                           }`}
                        >
                           {std === 'loose' && 'üòå Loose'}
                           {std === 'standard' && '‚öñÔ∏è Standard'}
                           {std === 'strict' && 'üî¨ Strict'}
                        </button>
                     ))}
                  </div>
                  <div className="text-xs text-slate-400 mt-2 text-center">
                     {qualityStandard === 'loose' && 'Accept minor flaws ‚Ä¢ Lower cost ‚Ä¢ More returns'}
                     {qualityStandard === 'standard' && 'Industry normal ‚Ä¢ Balanced approach'}
                     {qualityStandard === 'strict' && 'Zero tolerance ‚Ä¢ Higher cost ‚Ä¢ Fewer returns'}
                  </div>
               </div>
            </div>

            {/* Batch Visualization */}
            {currentBatch && (
               <div className="flex-1 p-3 overflow-auto">
                  <div className="bg-black/30 rounded-lg p-3">
                     <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-bold">üì¶ Current Batch</span>
                        <span className="text-xs text-slate-400">{batchSize} units</span>
                     </div>
                     <div className="grid grid-cols-20 gap-[2px]">
                        {currentBatch.units.slice(0, 100).map((unit, i) => (
                           <div
                              key={i}
                              className={`w-2 h-2 rounded-sm ${
                                 unit.hasDefect
                                    ? 'bg-red-500/30'
                                    : 'bg-green-500/30'
                              }`}
                              title={unit.hasDefect ? 'May have defect' : 'Good unit'}
                           />
                        ))}
                     </div>
                     <p className="text-xs text-slate-500 mt-2 text-center">
                        (Defects hidden until shipped - just like real production!)
                     </p>
                  </div>

                  {/* History */}
                  {batchHistory.length > 0 && (
                     <div className="mt-3 bg-black/30 rounded-lg p-3">
                        <span className="text-xs font-bold text-slate-400">History</span>
                        <div className="mt-2 space-y-1 max-h-24 overflow-auto">
                           {batchHistory.slice(-5).map((h, i) => (
                              <div key={i} className="flex justify-between text-xs">
                                 <span>Batch {h.batch}</span>
                                 <span className="text-green-400">‚úì{h.defectsFound}</span>
                                 <span className="text-red-400">‚úó{h.defectsShipped}</span>
                                 <span className="text-yellow-400">‚Ü©{h.returns}</span>
                              </div>
                           ))}
                        </div>
                     </div>
                  )}
               </div>
            )}

            {/* Action Bar */}
            <div className="p-3 bg-black/30 border-t border-cyan-500/30">
               <div className="flex gap-2 items-center justify-between mb-2">
                  <div className="flex gap-2">
                     <button onClick={() => setInfoTopic('cost_of_quality')} className="text-xs text-cyan-400 hover:text-white">üí∞ Cost of Quality</button>
                     <button onClick={() => setInfoTopic('six_sigma')} className="text-xs text-cyan-400 hover:text-white">üìä Six Sigma</button>
                     <button onClick={() => setInfoTopic('continuous')} className="text-xs text-cyan-400 hover:text-white">üîÑ Kaizen</button>
                  </div>
               </div>
               <button
                  onClick={processBatch}
                  className="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 rounded-xl font-bold transition-all"
               >
                  üì¶ SHIP BATCH {batch}
               </button>
            </div>
         </div>
      );
   };

   // --- CUSTOMER SUCCESS RENDERER ---
   const CustomerSuccessRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [month, setMonth] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const totalMonths = 12;

      const [budget, setBudget] = useState(10000); // Monthly CS budget
      const [customers, setCustomers] = useState(100);
      const [satisfaction, setSatisfaction] = useState(70); // 0-100
      const [churnRate, setChurnRate] = useState(5); // % per month

      const [investments, setInvestments] = useState({
         support: 0,      // Customer support quality
         onboarding: 0,   // Onboarding experience
         engagement: 0,   // Proactive engagement
         loyalty: 0,      // Loyalty rewards
         feedback: 0,     // Feedback & improvements
      });

      const [stats, setStats] = useState({
         totalRevenue: 0,
         totalChurned: 0,
         totalAcquired: 0,
         totalSpent: 0,
         averageLTV: 0,
         nps: 0,
      });

      const [monthHistory, setMonthHistory] = useState<{
         month: number;
         customers: number;
         churned: number;
         acquired: number;
         satisfaction: number;
         revenue: number;
      }[]>([]);

      const infoTopics: Record<string, { title: string; content: string }> = {
         churn: {
            title: "Customer Churn",
            content: "The percentage of customers who stop using your product each period. A 5% monthly churn means losing half your customers in a year! Reducing churn by even 1% can dramatically increase lifetime value. It costs 5-25x more to acquire a new customer than retain an existing one."
         },
         ltv: {
            title: "Customer Lifetime Value (LTV)",
            content: "The total revenue expected from a customer over their entire relationship. LTV = Average Revenue √ó Customer Lifespan. If monthly revenue is $100 and average lifespan is 20 months, LTV = $2,000. Higher LTV justifies higher acquisition costs."
         },
         nps: {
            title: "Net Promoter Score (NPS)",
            content: "Measures customer loyalty: 'How likely are you to recommend us?' (0-10). Promoters (9-10) minus Detractors (0-6) = NPS. Score ranges from -100 to +100. Above 0 is good, above 50 is excellent. Promoters drive organic growth through referrals!"
         },
         onboarding: {
            title: "Customer Onboarding",
            content: "The process of helping new customers succeed with your product. Good onboarding reduces early churn dramatically‚Äîmost churn happens in the first 90 days! Include welcome sequences, tutorials, milestone celebrations, and check-ins."
         },
         retention: {
            title: "Retention Strategies",
            content: "Key tactics: 1) Proactive support (don't wait for complaints), 2) Regular engagement (newsletters, updates), 3) Loyalty rewards (discounts, perks), 4) Feedback loops (act on input), 5) Community building. The goal is to become indispensable!"
         }
      };

      useEffect(() => {
         if (infoTopic && infoTopics[infoTopic]) {
            setShowInfo(true);
         }
      }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setMonth(1);
         setBudget(10000);
         setCustomers(100);
         setSatisfaction(70);
         setChurnRate(5);
         setInvestments({ support: 0, onboarding: 0, engagement: 0, loyalty: 0, feedback: 0 });
         setStats({ totalRevenue: 0, totalChurned: 0, totalAcquired: 0, totalSpent: 0, averageLTV: 0, nps: 0 });
         setMonthHistory([]);
         setGameLog(["Customer Success simulation started with 100 customers"]);
      };

      const getTotalInvestment = () => {
         return Object.values(investments).reduce((a, b) => a + b, 0);
      };

      const processMonth = () => {
         const totalInvested = getTotalInvestment();

         // Calculate satisfaction change based on investments
         const supportImpact = investments.support * 0.02;
         const onboardingImpact = investments.onboarding * 0.015;
         const engagementImpact = investments.engagement * 0.018;
         const loyaltyImpact = investments.loyalty * 0.012;
         const feedbackImpact = investments.feedback * 0.015;

         const satisfactionChange = supportImpact + onboardingImpact + engagementImpact + loyaltyImpact + feedbackImpact - 3; // Natural decay of 3
         const newSatisfaction = Math.max(0, Math.min(100, satisfaction + satisfactionChange));

         // Churn rate based on satisfaction
         const baseChurn = 15 - (newSatisfaction / 10); // High satisfaction = low churn
         const newChurnRate = Math.max(1, Math.min(20, baseChurn));

         // Calculate churned customers
         const churned = Math.floor(customers * (newChurnRate / 100));

         // New customers (word of mouth based on satisfaction + small organic)
         const referralRate = newSatisfaction > 80 ? 0.08 : newSatisfaction > 60 ? 0.04 : 0.02;
         const acquired = Math.floor(customers * referralRate) + Math.floor(Math.random() * 5);

         // Revenue ($50 per customer per month)
         const revenuePerCustomer = 50;
         const monthlyRevenue = customers * revenuePerCustomer;

         // Update customers
         const newCustomers = customers - churned + acquired;

         // Calculate NPS based on satisfaction
         const nps = Math.round((newSatisfaction - 50) * 2);

         // Update state
         setSatisfaction(newSatisfaction);
         setChurnRate(newChurnRate);
         setCustomers(newCustomers);
         setBudget(prev => prev - totalInvested + 10000); // Replenish budget each month

         const newStats = {
            totalRevenue: stats.totalRevenue + monthlyRevenue,
            totalChurned: stats.totalChurned + churned,
            totalAcquired: stats.totalAcquired + acquired,
            totalSpent: stats.totalSpent + totalInvested,
            averageLTV: Math.round((stats.totalRevenue + monthlyRevenue) / (stats.totalChurned + churned + 1) * 12),
            nps: nps,
         };
         setStats(newStats);

         setMonthHistory(prev => [...prev, {
            month,
            customers,
            churned,
            acquired,
            satisfaction: Math.round(newSatisfaction),
            revenue: monthlyRevenue
         }]);

         setGameLog(prev => [...prev,
            `Month ${month}: ${churned} churned, ${acquired} acquired, satisfaction ${Math.round(newSatisfaction)}%, revenue $${monthlyRevenue}`
         ]);

         if (month >= totalMonths) {
            setGameLog(prev => [...prev,
               `Year complete! Final customers: ${newCustomers}, Total revenue: $${newStats.totalRevenue}`
            ]);
            setPhase('result');
         } else {
            setMonth(month + 1);
         }
      };

      const adjustInvestment = (category: keyof typeof investments, delta: number) => {
         const newValue = Math.max(0, Math.min(5000, investments[category] + delta));
         const newTotal = getTotalInvestment() - investments[category] + newValue;
         if (newTotal <= budget) {
            setInvestments(prev => ({ ...prev, [category]: newValue }));
         }
      };

      const getScore = () => {
         const revenueScore = Math.min(40, stats.totalRevenue / 2000);
         const retentionScore = Math.min(30, (1 - stats.totalChurned / 200) * 30);
         const satisfactionScore = satisfaction * 0.3;
         return Math.round(revenueScore + retentionScore + satisfactionScore);
      };

      const getGrade = () => {
         const score = getScore();
         if (score >= 85) return { letter: 'A', label: 'Customer Champion', color: 'text-green-400' };
         if (score >= 70) return { letter: 'B', label: 'Success Manager', color: 'text-blue-400' };
         if (score >= 55) return { letter: 'C', label: 'Learning the Ropes', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Needs Work', color: 'text-red-400' };
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-green-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <h1 className="text-2xl font-bold mb-2">üíö Customer Success Simulator</h1>
                  <p className="text-emerald-300 text-sm">Master retention and grow your customer base</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-3 text-emerald-400">üìã How It Works</h2>
                  <div className="space-y-2 text-sm">
                     <p>‚Ä¢ You start with <span className="text-white font-bold">100 customers</span> and a <span className="text-white font-bold">$10K monthly budget</span></p>
                     <p>‚Ä¢ Each customer generates <span className="text-emerald-400">$50/month</span> in revenue</p>
                     <p>‚Ä¢ Invest in retention strategies to reduce churn</p>
                     <p>‚Ä¢ Happy customers refer new ones‚Äîsatisfaction drives growth!</p>
                     <p>‚Ä¢ Run your business for <span className="text-white font-bold">12 months</span></p>
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3">
                     <h3 className="font-bold text-red-400 mb-2">‚ö†Ô∏è The Challenge</h3>
                     <p className="text-xs text-slate-300">5% monthly churn = 46% annual loss!</p>
                     <p className="text-xs text-slate-300">Acquire costs 5x more than retain</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3">
                     <h3 className="font-bold text-green-400 mb-2">üéØ Goal</h3>
                     <p className="text-xs text-slate-300">Maximize customer base</p>
                     <p className="text-xs text-slate-300">Keep satisfaction high!</p>
                  </div>
               </div>

               <div className="flex flex-wrap gap-2 mb-4">
                  {Object.keys(infoTopics).map(key => (
                     <button
                        key={key}
                        onClick={() => setInfoTopic(key)}
                        className="text-xs bg-emerald-500/20 hover:bg-emerald-500/40 px-2 py-1 rounded-full text-emerald-300"
                     >
                        ‚ÑπÔ∏è {infoTopics[key].title}
                     </button>
                  ))}
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 rounded-xl font-bold text-lg transition-all"
               >
                  ‚ñ∂Ô∏è START YEAR 1
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-emerald-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-emerald-600 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const grade = getGrade();
         const customerGrowth = customers - 100;
         const growthPercent = ((customers / 100 - 1) * 100).toFixed(0);

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-green-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-emerald-400">Score: {getScore()}/100</div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-green-400">{customers}</div>
                     <div className="text-xs text-slate-400">Final Customers</div>
                     <div className={`text-xs ${customerGrowth >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {customerGrowth >= 0 ? '+' : ''}{growthPercent}%
                     </div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-emerald-400">${stats.totalRevenue.toLocaleString()}</div>
                     <div className="text-xs text-slate-400">Total Revenue</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-red-400">{stats.totalChurned}</div>
                     <div className="text-xs text-slate-400">Total Churned</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-blue-400">{stats.totalAcquired}</div>
                     <div className="text-xs text-slate-400">Total Acquired</div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-emerald-400 mb-2">üìä Key Metrics</h3>
                  <div className="grid grid-cols-3 gap-2 text-center text-xs">
                     <div>
                        <div className="font-bold text-lg">{Math.round(satisfaction)}%</div>
                        <div className="text-slate-400">Satisfaction</div>
                     </div>
                     <div>
                        <div className="font-bold text-lg">{churnRate.toFixed(1)}%</div>
                        <div className="text-slate-400">Churn Rate</div>
                     </div>
                     <div>
                        <div className={`font-bold text-lg ${stats.nps >= 0 ? 'text-green-400' : 'text-red-400'}`}>{stats.nps > 0 ? '+' : ''}{stats.nps}</div>
                        <div className="text-slate-400">NPS</div>
                     </div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-emerald-400 mb-2">üí° Key Insight</h3>
                  <p className="text-sm text-slate-300">
                     {customers > 100
                        ? "Great job growing your customer base! High satisfaction leads to referrals, creating a virtuous cycle. Remember: happy customers are your best marketing."
                        : stats.totalChurned > 50
                        ? "High churn ate into your customer base. Investing more in retention (support, onboarding, engagement) reduces churn and increases lifetime value."
                        : "Retention is the key to sustainable growth. It costs 5x more to acquire a customer than retain one. Focus on making existing customers successful!"
                     }
                  </p>
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 rounded-xl font-bold transition-all"
               >
                  üîÑ TRY AGAIN
               </button>
            </div>
         );
      }

      // Play Phase
      const totalInvested = getTotalInvestment();
      const remaining = budget - totalInvested;

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-green-900 to-slate-900 text-white overflow-hidden">
            {/* Info Modal */}
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-emerald-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-emerald-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-emerald-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="font-bold">üíö Customer Success</span>
                  <span className="text-emerald-400">Month {month}/{totalMonths}</span>
               </div>
               <div className="grid grid-cols-4 gap-2 text-center text-xs">
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-green-400 font-bold">{customers}</div>
                     <div className="text-slate-500">Customers</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-emerald-400 font-bold">{Math.round(satisfaction)}%</div>
                     <div className="text-slate-500">Satisfaction</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-red-400 font-bold">{churnRate.toFixed(1)}%</div>
                     <div className="text-slate-500">Churn</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-yellow-400 font-bold">${remaining.toLocaleString()}</div>
                     <div className="text-slate-500">Budget Left</div>
                  </div>
               </div>
            </div>

            {/* Investment Sliders */}
            <div className="flex-1 p-3 overflow-auto space-y-2">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-bold">Monthly Investments</span>
                  <button onClick={() => setInfoTopic('retention')} className="text-emerald-400 text-xs">‚ÑπÔ∏è Strategies</button>
               </div>

               {[
                  { key: 'support', label: 'üéß Support Quality', desc: 'Fast, helpful customer service' },
                  { key: 'onboarding', label: 'üöÄ Onboarding', desc: 'Help new customers succeed' },
                  { key: 'engagement', label: 'üìß Engagement', desc: 'Proactive outreach & updates' },
                  { key: 'loyalty', label: 'üéÅ Loyalty Rewards', desc: 'Perks for long-term customers' },
                  { key: 'feedback', label: 'üìù Feedback Loop', desc: 'Listen and improve' },
               ].map(({ key, label, desc }) => (
                  <div key={key} className="bg-black/30 rounded-lg p-2">
                     <div className="flex justify-between items-center mb-1">
                        <span className="text-xs font-bold">{label}</span>
                        <span className="text-xs text-emerald-400">${investments[key as keyof typeof investments].toLocaleString()}</span>
                     </div>
                     <div className="flex items-center gap-2">
                        <button
                           onClick={() => adjustInvestment(key as keyof typeof investments, -500)}
                           className="px-2 py-1 bg-red-600/50 hover:bg-red-500/50 rounded text-xs"
                        >
                           -$500
                        </button>
                        <div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                           <div
                              className="h-full bg-emerald-500 transition-all"
                              style={{ width: `${(investments[key as keyof typeof investments] / 5000) * 100}%` }}
                           />
                        </div>
                        <button
                           onClick={() => adjustInvestment(key as keyof typeof investments, 500)}
                           disabled={remaining < 500}
                           className="px-2 py-1 bg-green-600/50 hover:bg-green-500/50 disabled:opacity-50 rounded text-xs"
                        >
                           +$500
                        </button>
                     </div>
                     <p className="text-[10px] text-slate-500 mt-1">{desc}</p>
                  </div>
               ))}

               {/* History */}
               {monthHistory.length > 0 && (
                  <div className="bg-black/30 rounded-lg p-2 mt-3">
                     <span className="text-xs font-bold text-slate-400">Recent History</span>
                     <div className="mt-1 space-y-1 max-h-20 overflow-auto">
                        {monthHistory.slice(-4).map((h, i) => (
                           <div key={i} className="flex justify-between text-xs">
                              <span>Month {h.month}</span>
                              <span className="text-red-400">-{h.churned}</span>
                              <span className="text-green-400">+{h.acquired}</span>
                              <span className="text-emerald-400">{h.satisfaction}%</span>
                           </div>
                        ))}
                     </div>
                  </div>
               )}
            </div>

            {/* Action Bar */}
            <div className="p-3 bg-black/30 border-t border-emerald-500/30">
               <div className="flex gap-2 items-center justify-between mb-2">
                  <div className="flex gap-2">
                     <button onClick={() => setInfoTopic('churn')} className="text-xs text-emerald-400 hover:text-white">üìâ Churn</button>
                     <button onClick={() => setInfoTopic('ltv')} className="text-xs text-emerald-400 hover:text-white">üí∞ LTV</button>
                     <button onClick={() => setInfoTopic('nps')} className="text-xs text-emerald-400 hover:text-white">üìä NPS</button>
                  </div>
                  <span className="text-xs text-emerald-400">Revenue: ${(customers * 50).toLocaleString()}/mo</span>
               </div>
               <button
                  onClick={processMonth}
                  className="w-full py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 rounded-xl font-bold transition-all"
               >
                  ‚ñ∂Ô∏è END MONTH {month}
               </button>
            </div>
         </div>
      );
   };

   // --- AGILE METHODOLOGY RENDERER ---
   const AgileRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [sprint, setSprint] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const totalSprints = 6;
      const sprintLength = 2; // weeks

      const [teamVelocity, setTeamVelocity] = useState(20); // story points per sprint
      const [teamMorale, setTeamMorale] = useState(80);

      const [backlog, setBacklog] = useState<{
         id: string;
         title: string;
         points: number;
         priority: 'critical' | 'high' | 'medium' | 'low';
         status: 'backlog' | 'sprint' | 'done';
         type: 'feature' | 'bug' | 'tech_debt';
      }[]>([]);

      const [sprintBacklog, setSprintBacklog] = useState<string[]>([]);

      const [stats, setStats] = useState({
         totalPointsDelivered: 0,
         totalSprints: 0,
         averageVelocity: 0,
         bugsFixed: 0,
         featuresShipped: 0,
         techDebtPaid: 0,
         scopeChanges: 0,
      });

      const [sprintHistory, setSprintHistory] = useState<{
         sprint: number;
         planned: number;
         delivered: number;
         velocity: number;
         morale: number;
      }[]>([]);

      const [sprintEvent, setSprintEvent] = useState<string | null>(null);

      const infoTopics: Record<string, { title: string; content: string }> = {
         scrum: {
            title: "Scrum Framework",
            content: "Scrum is an Agile framework with fixed-length sprints (usually 2 weeks). Key roles: Product Owner (what to build), Scrum Master (process), Dev Team (how to build). Key events: Sprint Planning, Daily Standup, Sprint Review, Retrospective."
         },
         velocity: {
            title: "Team Velocity",
            content: "Velocity is story points completed per sprint. It's a planning tool, not a performance metric! Use past velocity to forecast future sprints. Velocity stabilizes over time as the team finds its rhythm. Never compare velocities between teams."
         },
         stories: {
            title: "User Stories",
            content: "User stories describe features from the user's perspective: 'As a [user], I want [feature] so that [benefit].' Stories are estimated in story points (relative complexity), not hours. Common scale: 1, 2, 3, 5, 8, 13 (Fibonacci). If it's bigger than 13, break it down!"
         },
         retrospective: {
            title: "Retrospectives",
            content: "The 'retro' happens after each sprint to improve the process. Ask: What went well? What didn't? What will we change? This is where real improvement happens. Teams that skip retros stop improving. Psychological safety is crucial for honest feedback."
         },
         debt: {
            title: "Technical Debt",
            content: "Tech debt is the cost of shortcuts taken for speed. Like financial debt, it accumulates interest‚Äîmaking future work harder. Balance: Some debt is acceptable for speed-to-market, but pay it down regularly or velocity will slow. Budget 20% of each sprint for debt."
         }
      };

      useEffect(() => {
         if (infoTopic && infoTopics[infoTopic]) {
            setShowInfo(true);
         }
      }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setSprint(1);
         setTeamVelocity(20);
         setTeamMorale(80);
         setSprintBacklog([]);
         setSprintEvent(null);
         setStats({
            totalPointsDelivered: 0,
            totalSprints: 0,
            averageVelocity: 0,
            bugsFixed: 0,
            featuresShipped: 0,
            techDebtPaid: 0,
            scopeChanges: 0,
         });
         setSprintHistory([]);

         // Generate initial backlog
         const initialBacklog = [
            { id: 'f1', title: 'User Authentication', points: 8, priority: 'critical' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f2', title: 'Dashboard UI', points: 5, priority: 'high' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f3', title: 'Payment Integration', points: 13, priority: 'critical' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f4', title: 'Email Notifications', points: 5, priority: 'medium' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f5', title: 'Search Feature', points: 8, priority: 'high' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'b1', title: 'Login Bug Fix', points: 3, priority: 'critical' as const, status: 'backlog' as const, type: 'bug' as const },
            { id: 'b2', title: 'Mobile Layout Issues', points: 5, priority: 'high' as const, status: 'backlog' as const, type: 'bug' as const },
            { id: 't1', title: 'Refactor Database', points: 8, priority: 'medium' as const, status: 'backlog' as const, type: 'tech_debt' as const },
            { id: 't2', title: 'Update Dependencies', points: 3, priority: 'low' as const, status: 'backlog' as const, type: 'tech_debt' as const },
            { id: 'f6', title: 'User Profiles', points: 5, priority: 'medium' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f7', title: 'Admin Panel', points: 8, priority: 'low' as const, status: 'backlog' as const, type: 'feature' as const },
            { id: 'f8', title: 'Analytics Dashboard', points: 13, priority: 'medium' as const, status: 'backlog' as const, type: 'feature' as const },
         ];
         setBacklog(initialBacklog);
         setGameLog(["Agile simulation started - Plan your first sprint!"]);
      };

      const addToSprint = (itemId: string) => {
         const item = backlog.find(b => b.id === itemId);
         if (!item) return;

         const currentPoints = sprintBacklog.reduce((sum, id) => {
            const i = backlog.find(b => b.id === id);
            return sum + (i?.points || 0);
         }, 0);

         if (currentPoints + item.points <= teamVelocity + 5) { // Allow slight over-commitment
            setSprintBacklog(prev => [...prev, itemId]);
            setBacklog(prev => prev.map(b => b.id === itemId ? { ...b, status: 'sprint' as const } : b));
         }
      };

      const removeFromSprint = (itemId: string) => {
         setSprintBacklog(prev => prev.filter(id => id !== itemId));
         setBacklog(prev => prev.map(b => b.id === itemId ? { ...b, status: 'backlog' as const } : b));
      };

      const runSprint = () => {
         const plannedPoints = sprintBacklog.reduce((sum, id) => {
            const item = backlog.find(b => b.id === id);
            return sum + (item?.points || 0);
         }, 0);

         // Random events that affect the sprint
         const events = [
            { text: "üéâ Team collaboration was excellent!", velocityMod: 1.1, moraleMod: 5 },
            { text: "üêõ Critical production bug diverted resources", velocityMod: 0.7, moraleMod: -10 },
            { text: "üìã Stakeholder added urgent requirements", velocityMod: 0.8, moraleMod: -5, scopeChange: true },
            { text: "üöÄ New team member ramped up quickly", velocityMod: 1.05, moraleMod: 5 },
            { text: "üò∑ Team member was sick for a week", velocityMod: 0.85, moraleMod: -5 },
            { text: "üí° Found a simpler solution!", velocityMod: 1.15, moraleMod: 10 },
            { text: "üìö Sprint went smoothly as planned", velocityMod: 1.0, moraleMod: 0 },
         ];

         const event = events[Math.floor(Math.random() * events.length)];
         setSprintEvent(event.text);

         // Calculate actual delivery
         const effectiveVelocity = Math.round(teamVelocity * event.velocityMod);
         let remainingCapacity = effectiveVelocity;
         let delivered = 0;
         let bugsFixed = 0;
         let featuresShipped = 0;
         let techDebtPaid = 0;

         const updatedBacklog = backlog.map(item => {
            if (item.status === 'sprint' && remainingCapacity >= item.points) {
               remainingCapacity -= item.points;
               delivered += item.points;
               if (item.type === 'bug') bugsFixed++;
               if (item.type === 'feature') featuresShipped++;
               if (item.type === 'tech_debt') techDebtPaid++;
               return { ...item, status: 'done' as const };
            } else if (item.status === 'sprint') {
               // Incomplete - back to backlog
               return { ...item, status: 'backlog' as const };
            }
            return item;
         });

         setBacklog(updatedBacklog);
         setSprintBacklog([]);

         // Update morale
         const newMorale = Math.max(20, Math.min(100, teamMorale + event.moraleMod + (delivered >= plannedPoints ? 5 : -5)));
         setTeamMorale(newMorale);

         // Update velocity based on morale
         const moraleEffect = (newMorale - 50) / 100; // -0.3 to +0.5
         const newVelocity = Math.round(20 * (1 + moraleEffect));
         setTeamVelocity(newVelocity);

         const newStats = {
            totalPointsDelivered: stats.totalPointsDelivered + delivered,
            totalSprints: stats.totalSprints + 1,
            averageVelocity: Math.round((stats.totalPointsDelivered + delivered) / (stats.totalSprints + 1)),
            bugsFixed: stats.bugsFixed + bugsFixed,
            featuresShipped: stats.featuresShipped + featuresShipped,
            techDebtPaid: stats.techDebtPaid + techDebtPaid,
            scopeChanges: stats.scopeChanges + (event.scopeChange ? 1 : 0),
         };
         setStats(newStats);

         setSprintHistory(prev => [...prev, {
            sprint,
            planned: plannedPoints,
            delivered,
            velocity: effectiveVelocity,
            morale: newMorale
         }]);

         setGameLog(prev => [...prev,
            `Sprint ${sprint}: Planned ${plannedPoints}pts, delivered ${delivered}pts. ${event.text}`
         ]);

         if (sprint >= totalSprints) {
            setGameLog(prev => [...prev,
               `Project complete! Total delivered: ${newStats.totalPointsDelivered} points`
            ]);
            setPhase('result');
         } else {
            setSprint(sprint + 1);
         }
      };

      const getSprintPoints = () => {
         return sprintBacklog.reduce((sum, id) => {
            const item = backlog.find(b => b.id === id);
            return sum + (item?.points || 0);
         }, 0);
      };

      const getScore = () => {
         const deliveryScore = Math.min(40, stats.totalPointsDelivered / 2);
         const moraleScore = teamMorale * 0.3;
         const balanceScore = Math.min(30, (stats.bugsFixed * 3 + stats.techDebtPaid * 5));
         return Math.round(deliveryScore + moraleScore + balanceScore);
      };

      const getGrade = () => {
         const score = getScore();
         if (score >= 85) return { letter: 'A', label: 'Agile Master', color: 'text-green-400' };
         if (score >= 70) return { letter: 'B', label: 'Sprint Champion', color: 'text-blue-400' };
         if (score >= 55) return { letter: 'C', label: 'Learning Scrum', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Waterfall Refugee', color: 'text-red-400' };
      };

      const getPriorityColor = (priority: string) => {
         switch (priority) {
            case 'critical': return 'text-red-400 bg-red-500/20';
            case 'high': return 'text-orange-400 bg-orange-500/20';
            case 'medium': return 'text-yellow-400 bg-yellow-500/20';
            case 'low': return 'text-slate-400 bg-slate-500/20';
            default: return 'text-slate-400';
         }
      };

      const getTypeIcon = (type: string) => {
         switch (type) {
            case 'feature': return '‚ú®';
            case 'bug': return 'üêõ';
            case 'tech_debt': return 'üîß';
            default: return 'üìã';
         }
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <h1 className="text-2xl font-bold mb-2">üèÉ Agile Sprint Simulator</h1>
                  <p className="text-purple-300 text-sm">Master Scrum and deliver value iteratively</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-3 text-purple-400">üìã How It Works</h2>
                  <div className="space-y-2 text-sm">
                     <p>‚Ä¢ Run <span className="text-white font-bold">{totalSprints} sprints</span> ({sprintLength} weeks each)</p>
                     <p>‚Ä¢ Select items from the <span className="text-purple-400">Product Backlog</span> for each sprint</p>
                     <p>‚Ä¢ Balance features, bugs, and tech debt</p>
                     <p>‚Ä¢ Team velocity is ~<span className="text-white font-bold">20 points/sprint</span></p>
                     <p>‚Ä¢ Random events affect delivery‚Äîadapt and overcome!</p>
                  </div>
               </div>

               <div className="grid grid-cols-3 gap-2 mb-4 text-center">
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-lg">‚ú®</span>
                     <p className="text-xs text-slate-300">Features</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-lg">üêõ</span>
                     <p className="text-xs text-slate-300">Bugs</p>
                  </div>
                  <div className="bg-black/30 rounded-lg p-2">
                     <span className="text-lg">üîß</span>
                     <p className="text-xs text-slate-300">Tech Debt</p>
                  </div>
               </div>

               <div className="flex flex-wrap gap-2 mb-4">
                  {Object.keys(infoTopics).map(key => (
                     <button
                        key={key}
                        onClick={() => setInfoTopic(key)}
                        className="text-xs bg-purple-500/20 hover:bg-purple-500/40 px-2 py-1 rounded-full text-purple-300"
                     >
                        ‚ÑπÔ∏è {infoTopics[key].title}
                     </button>
                  ))}
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold text-lg transition-all"
               >
                  ‚ñ∂Ô∏è START SPRINT 1
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-purple-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-purple-600 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const grade = getGrade();

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-purple-400">Score: {getScore()}/100</div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-purple-400">{stats.totalPointsDelivered}</div>
                     <div className="text-xs text-slate-400">Points Delivered</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-blue-400">{stats.averageVelocity}</div>
                     <div className="text-xs text-slate-400">Avg Velocity</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-green-400">{stats.featuresShipped}</div>
                     <div className="text-xs text-slate-400">Features Shipped</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-yellow-400">{teamMorale}%</div>
                     <div className="text-xs text-slate-400">Team Morale</div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-purple-400 mb-2">üìä Sprint Breakdown</h3>
                  <div className="grid grid-cols-3 gap-2 text-center text-xs">
                     <div>
                        <div className="font-bold text-lg text-green-400">{stats.featuresShipped}</div>
                        <div className="text-slate-400">‚ú® Features</div>
                     </div>
                     <div>
                        <div className="font-bold text-lg text-red-400">{stats.bugsFixed}</div>
                        <div className="text-slate-400">üêõ Bugs Fixed</div>
                     </div>
                     <div>
                        <div className="font-bold text-lg text-orange-400">{stats.techDebtPaid}</div>
                        <div className="text-slate-400">üîß Debt Paid</div>
                     </div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-purple-400 mb-2">üí° Key Insight</h3>
                  <p className="text-sm text-slate-300">
                     {stats.techDebtPaid === 0
                        ? "You shipped features but ignored tech debt! In real projects, this slows velocity over time. Budget ~20% of each sprint for maintenance."
                        : stats.bugsFixed < 2
                        ? "Bugs pile up when ignored. Fixing bugs early prevents bigger problems. Critical bugs should jump to the top of the backlog."
                        : teamMorale < 50
                        ? "Team morale affects velocity! Overcommitting and missing targets hurts morale. Sustainable pace > heroic sprints."
                        : "Great balance of features, bugs, and tech debt! Sustainable teams deliver more value over time than teams that burn out."
                     }
                  </p>
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold transition-all"
               >
                  üîÑ TRY AGAIN
               </button>
            </div>
         );
      }

      // Play Phase
      const sprintPoints = getSprintPoints();
      const availableBacklog = backlog.filter(b => b.status === 'backlog');
      const sprintItems = backlog.filter(b => b.status === 'sprint');

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white overflow-hidden">
            {/* Info Modal */}
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-purple-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-purple-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-purple-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="font-bold">üèÉ Sprint {sprint}/{totalSprints}</span>
                  <span className="text-purple-400">{sprintLength} weeks</span>
               </div>
               <div className="grid grid-cols-4 gap-2 text-center text-xs">
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-purple-400 font-bold">{sprintPoints}/{teamVelocity}</div>
                     <div className="text-slate-500">Points</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-blue-400 font-bold">{teamVelocity}</div>
                     <div className="text-slate-500">Velocity</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className={`font-bold ${teamMorale >= 60 ? 'text-green-400' : teamMorale >= 40 ? 'text-yellow-400' : 'text-red-400'}`}>{teamMorale}%</div>
                     <div className="text-slate-500">Morale</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-green-400 font-bold">{stats.totalPointsDelivered}</div>
                     <div className="text-slate-500">Delivered</div>
                  </div>
               </div>
               {sprintEvent && (
                  <div className="mt-2 text-xs text-center text-purple-300 bg-purple-500/20 rounded p-1">
                     {sprintEvent}
                  </div>
               )}
            </div>

            {/* Main Content */}
            <div className="flex-1 p-3 overflow-auto">
               {/* Sprint Backlog */}
               <div className="mb-3">
                  <div className="flex justify-between items-center mb-2">
                     <span className="text-sm font-bold">üìã Sprint Backlog</span>
                     <span className={`text-xs ${sprintPoints > teamVelocity ? 'text-red-400' : 'text-purple-400'}`}>
                        {sprintPoints} / {teamVelocity} pts
                     </span>
                  </div>
                  {sprintItems.length === 0 ? (
                     <div className="bg-black/20 rounded-lg p-3 text-center text-slate-500 text-sm">
                        Add items from the backlog below
                     </div>
                  ) : (
                     <div className="space-y-1">
                        {sprintItems.map(item => (
                           <div key={item.id} className="bg-purple-500/20 rounded-lg p-2 flex justify-between items-center">
                              <div className="flex items-center gap-2">
                                 <span>{getTypeIcon(item.type)}</span>
                                 <span className="text-xs">{item.title}</span>
                              </div>
                              <div className="flex items-center gap-2">
                                 <span className={`text-xs px-1 rounded ${getPriorityColor(item.priority)}`}>{item.points}pts</span>
                                 <button onClick={() => removeFromSprint(item.id)} className="text-red-400 text-xs">‚úï</button>
                              </div>
                           </div>
                        ))}
                     </div>
                  )}
               </div>

               {/* Product Backlog */}
               <div>
                  <div className="flex justify-between items-center mb-2">
                     <span className="text-sm font-bold">üì¶ Product Backlog</span>
                     <span className="text-xs text-slate-400">{availableBacklog.length} items</span>
                  </div>
                  <div className="space-y-1 max-h-40 overflow-auto">
                     {availableBacklog.map(item => (
                        <div key={item.id} className="bg-black/30 rounded-lg p-2 flex justify-between items-center">
                           <div className="flex items-center gap-2">
                              <span>{getTypeIcon(item.type)}</span>
                              <span className="text-xs">{item.title}</span>
                           </div>
                           <div className="flex items-center gap-2">
                              <span className={`text-xs px-1 rounded ${getPriorityColor(item.priority)}`}>{item.priority}</span>
                              <span className="text-xs text-slate-400">{item.points}pts</span>
                              <button
                                 onClick={() => addToSprint(item.id)}
                                 disabled={sprintPoints + item.points > teamVelocity + 5}
                                 className="text-green-400 text-xs disabled:opacity-50"
                              >
                                 +
                              </button>
                           </div>
                        </div>
                     ))}
                  </div>
               </div>

               {/* Sprint History */}
               {sprintHistory.length > 0 && (
                  <div className="mt-3 bg-black/30 rounded-lg p-2">
                     <span className="text-xs font-bold text-slate-400">Sprint History</span>
                     <div className="mt-1 space-y-1 max-h-16 overflow-auto">
                        {sprintHistory.slice(-3).map((h, i) => (
                           <div key={i} className="flex justify-between text-xs">
                              <span>Sprint {h.sprint}</span>
                              <span className="text-slate-400">{h.planned}‚Üí{h.delivered}pts</span>
                              <span className={h.delivered >= h.planned ? 'text-green-400' : 'text-red-400'}>
                                 {h.delivered >= h.planned ? '‚úì' : '‚úó'}
                              </span>
                           </div>
                        ))}
                     </div>
                  </div>
               )}
            </div>

            {/* Action Bar */}
            <div className="p-3 bg-black/30 border-t border-purple-500/30">
               <div className="flex gap-2 items-center justify-between mb-2">
                  <div className="flex gap-2">
                     <button onClick={() => setInfoTopic('velocity')} className="text-xs text-purple-400 hover:text-white">üìà Velocity</button>
                     <button onClick={() => setInfoTopic('stories')} className="text-xs text-purple-400 hover:text-white">üìù Stories</button>
                     <button onClick={() => setInfoTopic('debt')} className="text-xs text-purple-400 hover:text-white">üîß Tech Debt</button>
                  </div>
               </div>
               <button
                  onClick={runSprint}
                  disabled={sprintItems.length === 0}
                  className="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 disabled:opacity-50 rounded-xl font-bold transition-all"
               >
                  üèÉ RUN SPRINT {sprint}
               </button>
            </div>
         </div>
      );
   };

   // --- TIME MANAGEMENT RENDERER ---
   const TimeManagementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [day, setDay] = useState(1);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const totalDays = 5; // Work week
      const hoursPerDay = 8;

      const [hoursRemaining, setHoursRemaining] = useState(hoursPerDay);
      const [energy, setEnergy] = useState(100);

      const [tasks, setTasks] = useState<{
         id: string;
         title: string;
         hours: number;
         urgent: boolean;
         important: boolean;
         completed: boolean;
         type: 'deep' | 'meeting' | 'admin' | 'interruption';
      }[]>([]);

      const [stats, setStats] = useState({
         tasksCompleted: 0,
         importantCompleted: 0,
         urgentCompleted: 0,
         deepWorkHours: 0,
         meetingHours: 0,
         adminHours: 0,
         interruptionHours: 0,
         energyWasted: 0,
      });

      const [dayHistory, setDayHistory] = useState<{
         day: number;
         completed: number;
         important: number;
         hoursWorked: number;
         endEnergy: number;
      }[]>([]);

      const [interruption, setInterruption] = useState<{ title: string; hours: number } | null>(null);

      const infoTopics: Record<string, { title: string; content: string }> = {
         eisenhower: {
            title: "Eisenhower Matrix",
            content: "Prioritize by URGENT vs IMPORTANT: Q1 (Urgent+Important): Do first‚Äîcrises, deadlines. Q2 (Important, Not Urgent): Schedule‚Äîplanning, growth, prevention. Q3 (Urgent, Not Important): Delegate‚Äîinterruptions, some meetings. Q4 (Neither): Eliminate‚Äîtime wasters. Spend most time in Q2!"
         },
         deep_work: {
            title: "Deep Work",
            content: "Cal Newport's concept: focused, uninterrupted work on cognitively demanding tasks. Deep work creates value and improves skills. Requires 90+ minute blocks without distractions. Most people can only do 4 hours of deep work per day. Protect this time ruthlessly!"
         },
         pomodoro: {
            title: "Pomodoro Technique",
            content: "Work in 25-minute focused bursts (pomodoros) with 5-minute breaks. After 4 pomodoros, take a 15-30 minute break. Helps maintain focus and prevents burnout. Track pomodoros to understand your capacity. One task per pomodoro‚Äîno multitasking!"
         },
         energy: {
            title: "Energy Management",
            content: "Energy matters more than time! Schedule hard tasks during peak energy (usually morning). Batch similar tasks together. Take breaks before you're exhausted. Meetings and context-switching drain energy fast. Protect your golden hours for important work."
         },
         timeblock: {
            title: "Time Blocking",
            content: "Schedule specific blocks for specific work types. Example: Deep work 9-12, meetings 2-4, email 4-5. Defend your calendar! Every minute should be assigned. Review and adjust weekly. Leave buffer time for unexpected tasks. Say no to protect your blocks."
         }
      };

      useEffect(() => {
         if (infoTopic && infoTopics[infoTopic]) {
            setShowInfo(true);
         }
      }, [infoTopic]);

      const generateDayTasks = () => {
         const taskPool = [
            { title: 'Strategic Planning', hours: 2, urgent: false, important: true, type: 'deep' as const },
            { title: 'Client Presentation', hours: 1.5, urgent: true, important: true, type: 'meeting' as const },
            { title: 'Team Meeting', hours: 1, urgent: true, important: false, type: 'meeting' as const },
            { title: 'Email Inbox', hours: 1, urgent: false, important: false, type: 'admin' as const },
            { title: 'Code Review', hours: 1.5, urgent: false, important: true, type: 'deep' as const },
            { title: 'Bug Fix (Critical)', hours: 2, urgent: true, important: true, type: 'deep' as const },
            { title: 'Status Report', hours: 0.5, urgent: true, important: false, type: 'admin' as const },
            { title: 'Learning/Training', hours: 1, urgent: false, important: true, type: 'deep' as const },
            { title: 'Social Media Check', hours: 0.5, urgent: false, important: false, type: 'admin' as const },
            { title: 'Process Documentation', hours: 1, urgent: false, important: true, type: 'deep' as const },
            { title: '1:1 with Manager', hours: 0.5, urgent: true, important: true, type: 'meeting' as const },
            { title: 'Expense Reports', hours: 0.5, urgent: true, important: false, type: 'admin' as const },
         ];

         // Select 6-8 random tasks for the day
         const shuffled = [...taskPool].sort(() => Math.random() - 0.5);
         const selected = shuffled.slice(0, 6 + Math.floor(Math.random() * 3));

         return selected.map((t, i) => ({
            ...t,
            id: `task-${day}-${i}`,
            completed: false,
         }));
      };

      const startGame = () => {
         setPhase('play');
         setDay(1);
         setHoursRemaining(hoursPerDay);
         setEnergy(100);
         setInterruption(null);
         setStats({
            tasksCompleted: 0,
            importantCompleted: 0,
            urgentCompleted: 0,
            deepWorkHours: 0,
            meetingHours: 0,
            adminHours: 0,
            interruptionHours: 0,
            energyWasted: 0,
         });
         setDayHistory([]);
         setTasks(generateDayTasks());
         setGameLog(["Time Management simulation started - Day 1"]);
      };

      const completeTask = (taskId: string) => {
         const task = tasks.find(t => t.id === taskId);
         if (!task || task.completed || hoursRemaining < task.hours) return;

         // Energy cost
         let energyCost = task.hours * 10;
         if (task.type === 'meeting') energyCost += 5; // Meetings drain more
         if (task.type === 'deep' && energy < 50) energyCost += 10; // Deep work when tired is harder

         // Check if we have energy
         if (energy - energyCost < 0) {
            setGameLog(prev => [...prev, `Too exhausted to complete ${task.title}!`]);
            return;
         }

         setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completed: true } : t));
         setHoursRemaining(prev => prev - task.hours);
         setEnergy(prev => Math.max(0, prev - energyCost));

         // Update stats
         setStats(prev => ({
            ...prev,
            tasksCompleted: prev.tasksCompleted + 1,
            importantCompleted: prev.importantCompleted + (task.important ? 1 : 0),
            urgentCompleted: prev.urgentCompleted + (task.urgent ? 1 : 0),
            deepWorkHours: prev.deepWorkHours + (task.type === 'deep' ? task.hours : 0),
            meetingHours: prev.meetingHours + (task.type === 'meeting' ? task.hours : 0),
            adminHours: prev.adminHours + (task.type === 'admin' ? task.hours : 0),
         }));

         setGameLog(prev => [...prev, `Completed: ${task.title} (${task.hours}h)`]);

         // Random interruption chance
         if (Math.random() < 0.2) {
            triggerInterruption();
         }
      };

      const triggerInterruption = () => {
         const interruptions = [
            { title: 'üì± Urgent Slack message', hours: 0.5 },
            { title: 'üö® Production issue!', hours: 1 },
            { title: 'üìû Surprise call', hours: 0.5 },
            { title: 'üëã Coworker needs help', hours: 0.5 },
            { title: 'üìß Executive email needs reply', hours: 0.5 },
         ];
         setInterruption(interruptions[Math.floor(Math.random() * interruptions.length)]);
      };

      const handleInterruption = (accept: boolean) => {
         if (!interruption) return;

         if (accept) {
            if (hoursRemaining >= interruption.hours) {
               setHoursRemaining(prev => prev - interruption.hours);
               setEnergy(prev => Math.max(0, prev - 15)); // Interruptions are costly
               setStats(prev => ({
                  ...prev,
                  interruptionHours: prev.interruptionHours + interruption.hours,
               }));
               setGameLog(prev => [...prev, `Handled interruption: ${interruption.title}`]);
            }
         } else {
            setEnergy(prev => Math.max(0, prev - 5)); // Saying no has a small cost too
            setGameLog(prev => [...prev, `Declined: ${interruption.title}`]);
         }
         setInterruption(null);
      };

      const takeBreak = () => {
         if (hoursRemaining < 0.5) return;
         setHoursRemaining(prev => prev - 0.5);
         setEnergy(prev => Math.min(100, prev + 20));
         setGameLog(prev => [...prev, "Took a 30-minute break, recovered energy"]);
      };

      const endDay = () => {
         const dayCompleted = tasks.filter(t => t.completed).length;
         const dayImportant = tasks.filter(t => t.completed && t.important).length;

         setDayHistory(prev => [...prev, {
            day,
            completed: dayCompleted,
            important: dayImportant,
            hoursWorked: hoursPerDay - hoursRemaining,
            endEnergy: energy
         }]);

         if (day >= totalDays) {
            setGameLog(prev => [...prev, `Week complete! Tasks done: ${stats.tasksCompleted + dayCompleted}`]);
            setPhase('result');
         } else {
            setDay(day + 1);
            setHoursRemaining(hoursPerDay);
            setEnergy(Math.min(100, 70 + energy * 0.3)); // Partial recovery overnight
            setTasks(generateDayTasks());
            setGameLog(prev => [...prev, `Day ${day + 1} started`]);
         }
      };

      const getQuadrant = (task: typeof tasks[0]) => {
         if (task.urgent && task.important) return { label: 'Q1: DO', color: 'bg-red-500/30 border-red-500' };
         if (!task.urgent && task.important) return { label: 'Q2: SCHEDULE', color: 'bg-green-500/30 border-green-500' };
         if (task.urgent && !task.important) return { label: 'Q3: DELEGATE', color: 'bg-yellow-500/30 border-yellow-500' };
         return { label: 'Q4: ELIMINATE', color: 'bg-slate-500/30 border-slate-500' };
      };

      const getScore = () => {
         const importantScore = stats.importantCompleted * 10;
         const deepWorkScore = Math.min(30, stats.deepWorkHours * 5);
         const efficiencyScore = Math.min(30, (stats.tasksCompleted / (stats.tasksCompleted + 5)) * 30);
         const balanceScore = energy > 30 ? 10 : 0; // Ended with energy
         return Math.round(importantScore + deepWorkScore + efficiencyScore + balanceScore);
      };

      const getGrade = () => {
         const score = getScore();
         if (score >= 85) return { letter: 'A', label: 'Time Master', color: 'text-green-400' };
         if (score >= 70) return { letter: 'B', label: 'Productive Pro', color: 'text-blue-400' };
         if (score >= 55) return { letter: 'C', label: 'Getting There', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Time Challenged', color: 'text-red-400' };
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-amber-900 via-orange-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <h1 className="text-2xl font-bold mb-2">‚è∞ Time Management Simulator</h1>
                  <p className="text-amber-300 text-sm">Master your day with the Eisenhower Matrix</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-3 text-amber-400">üìã How It Works</h2>
                  <div className="space-y-2 text-sm">
                     <p>‚Ä¢ Manage a <span className="text-white font-bold">5-day work week</span></p>
                     <p>‚Ä¢ Each day has <span className="text-white font-bold">8 hours</span> and limited energy</p>
                     <p>‚Ä¢ Prioritize tasks using the <span className="text-amber-400">Eisenhower Matrix</span></p>
                     <p>‚Ä¢ Handle interruptions and manage energy</p>
                     <p>‚Ä¢ Focus on <span className="text-green-400">Important</span> over Urgent!</p>
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-2 mb-4 text-xs">
                  <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-2 text-center">
                     <div className="font-bold">Q1: URGENT + IMPORTANT</div>
                     <div className="text-slate-300">Do First</div>
                  </div>
                  <div className="bg-green-500/20 border border-green-500/50 rounded-lg p-2 text-center">
                     <div className="font-bold">Q2: IMPORTANT</div>
                     <div className="text-slate-300">Schedule (Best ROI!)</div>
                  </div>
                  <div className="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-2 text-center">
                     <div className="font-bold">Q3: URGENT</div>
                     <div className="text-slate-300">Delegate</div>
                  </div>
                  <div className="bg-slate-500/20 border border-slate-500/50 rounded-lg p-2 text-center">
                     <div className="font-bold">Q4: NEITHER</div>
                     <div className="text-slate-300">Eliminate</div>
                  </div>
               </div>

               <div className="flex flex-wrap gap-2 mb-4">
                  {Object.keys(infoTopics).map(key => (
                     <button
                        key={key}
                        onClick={() => setInfoTopic(key)}
                        className="text-xs bg-amber-500/20 hover:bg-amber-500/40 px-2 py-1 rounded-full text-amber-300"
                     >
                        ‚ÑπÔ∏è {infoTopics[key].title}
                     </button>
                  ))}
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-bold text-lg transition-all"
               >
                  ‚ñ∂Ô∏è START WORK WEEK
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-amber-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-amber-600 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const grade = getGrade();

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-amber-900 via-orange-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-amber-400">Score: {getScore()}/100</div>
               </div>

               <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-amber-400">{stats.tasksCompleted}</div>
                     <div className="text-xs text-slate-400">Tasks Done</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-green-400">{stats.importantCompleted}</div>
                     <div className="text-xs text-slate-400">Important Done</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-blue-400">{stats.deepWorkHours.toFixed(1)}h</div>
                     <div className="text-xs text-slate-400">Deep Work</div>
                  </div>
                  <div className="bg-black/30 rounded-lg p-3 text-center">
                     <div className="text-2xl font-bold text-red-400">{stats.interruptionHours.toFixed(1)}h</div>
                     <div className="text-xs text-slate-400">Interruptions</div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-amber-400 mb-2">üìä Time Breakdown</h3>
                  <div className="space-y-1 text-sm">
                     <div className="flex justify-between">
                        <span>üß† Deep Work:</span>
                        <span className="text-blue-400">{stats.deepWorkHours.toFixed(1)}h</span>
                     </div>
                     <div className="flex justify-between">
                        <span>üë• Meetings:</span>
                        <span className="text-yellow-400">{stats.meetingHours.toFixed(1)}h</span>
                     </div>
                     <div className="flex justify-between">
                        <span>üìù Admin:</span>
                        <span className="text-slate-400">{stats.adminHours.toFixed(1)}h</span>
                     </div>
                     <div className="flex justify-between">
                        <span>üö® Interruptions:</span>
                        <span className="text-red-400">{stats.interruptionHours.toFixed(1)}h</span>
                     </div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-amber-400 mb-2">üí° Key Insight</h3>
                  <p className="text-sm text-slate-300">
                     {stats.deepWorkHours < 10
                        ? "Not enough deep work! Protect 2-4 hours daily for focused, important work. This is where real value is created."
                        : stats.interruptionHours > 5
                        ? "Interruptions consumed too much time. Learn to say no or batch interruption handling into specific time slots."
                        : stats.importantCompleted < stats.urgentCompleted
                        ? "You prioritized urgent over important. Q2 tasks (important but not urgent) build long-term success. Don't let urgency hijack your priorities!"
                        : "Great balance! You focused on important work while managing energy. This is the path to sustainable productivity."
                     }
                  </p>
               </div>

               <button
                  onClick={startGame}
                  className="w-full py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-bold transition-all"
               >
                  üîÑ TRY AGAIN
               </button>
            </div>
         );
      }

      // Play Phase
      const incompleteTasks = tasks.filter(t => !t.completed);

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-amber-900 via-orange-900 to-slate-900 text-white overflow-hidden">
            {/* Interruption Modal */}
            {interruption && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm">
                     <h3 className="text-lg font-bold text-red-400 mb-2">üö® Interruption!</h3>
                     <p className="text-white mb-2">{interruption.title}</p>
                     <p className="text-sm text-slate-400 mb-4">This will take {interruption.hours}h. Handle it?</p>
                     <div className="flex gap-2">
                        <button onClick={() => handleInterruption(true)} className="flex-1 py-2 bg-red-600 rounded-lg">Handle It</button>
                        <button onClick={() => handleInterruption(false)} className="flex-1 py-2 bg-slate-600 rounded-lg">Say No</button>
                     </div>
                  </div>
               </div>
            )}

            {/* Info Modal */}
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-amber-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-amber-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-amber-500/30">
               <div className="flex justify-between items-center mb-2">
                  <span className="font-bold">‚è∞ Day {day}/{totalDays}</span>
                  <span className="text-amber-400">{hoursRemaining.toFixed(1)}h left</span>
               </div>
               <div className="grid grid-cols-3 gap-2 text-center text-xs">
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-amber-400 font-bold">{hoursRemaining.toFixed(1)}h</div>
                     <div className="text-slate-500">Time Left</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className={`font-bold ${energy >= 50 ? 'text-green-400' : energy >= 25 ? 'text-yellow-400' : 'text-red-400'}`}>{energy}%</div>
                     <div className="text-slate-500">Energy</div>
                  </div>
                  <div className="bg-black/30 rounded p-1">
                     <div className="text-green-400 font-bold">{stats.tasksCompleted}</div>
                     <div className="text-slate-500">Done</div>
                  </div>
               </div>
               {/* Energy bar */}
               <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                  <div
                     className={`h-full transition-all ${energy >= 50 ? 'bg-green-500' : energy >= 25 ? 'bg-yellow-500' : 'bg-red-500'}`}
                     style={{ width: `${energy}%` }}
                  />
               </div>
            </div>

            {/* Tasks */}
            <div className="flex-1 p-3 overflow-auto">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-bold">Today's Tasks</span>
                  <button onClick={() => setInfoTopic('eisenhower')} className="text-amber-400 text-xs">‚ÑπÔ∏è Matrix</button>
               </div>

               <div className="space-y-2">
                  {incompleteTasks.map(task => {
                     const quadrant = getQuadrant(task);
                     const canComplete = hoursRemaining >= task.hours && energy >= task.hours * 10;

                     return (
                        <div key={task.id} className={`rounded-lg p-2 border ${quadrant.color}`}>
                           <div className="flex justify-between items-start mb-1">
                              <span className="text-sm font-medium">{task.title}</span>
                              <span className="text-xs bg-black/30 px-1 rounded">{task.hours}h</span>
                           </div>
                           <div className="flex justify-between items-center">
                              <span className="text-[10px] text-slate-400">{quadrant.label}</span>
                              <button
                                 onClick={() => completeTask(task.id)}
                                 disabled={!canComplete}
                                 className="text-xs px-2 py-1 bg-amber-600/50 hover:bg-amber-500/50 disabled:opacity-50 rounded"
                              >
                                 Do It
                              </button>
                           </div>
                        </div>
                     );
                  })}

                  {incompleteTasks.length === 0 && (
                     <div className="text-center text-slate-400 py-4">
                        All tasks completed! üéâ
                     </div>
                  )}
               </div>

               {/* Day History */}
               {dayHistory.length > 0 && (
                  <div className="mt-3 bg-black/30 rounded-lg p-2">
                     <span className="text-xs font-bold text-slate-400">This Week</span>
                     <div className="mt-1 space-y-1 max-h-16 overflow-auto">
                        {dayHistory.map((h, i) => (
                           <div key={i} className="flex justify-between text-xs">
                              <span>Day {h.day}</span>
                              <span className="text-green-400">{h.completed} done</span>
                              <span className="text-amber-400">{h.important} important</span>
                           </div>
                        ))}
                     </div>
                  </div>
               )}
            </div>

            {/* Action Bar */}
            <div className="p-3 bg-black/30 border-t border-amber-500/30">
               <div className="flex gap-2 items-center justify-between mb-2">
                  <div className="flex gap-2">
                     <button onClick={() => setInfoTopic('deep_work')} className="text-xs text-amber-400 hover:text-white">üß† Deep Work</button>
                     <button onClick={() => setInfoTopic('energy')} className="text-xs text-amber-400 hover:text-white">‚ö° Energy</button>
                     <button
                        onClick={takeBreak}
                        disabled={hoursRemaining < 0.5}
                        className="text-xs text-green-400 hover:text-white disabled:opacity-50"
                     >
                        ‚òï Break
                     </button>
                  </div>
               </div>
               <button
                  onClick={endDay}
                  className="w-full py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-bold transition-all"
               >
                  üåô END DAY {day}
               </button>
            </div>
         </div>
      );
   };

   // --- BUSINESS STRUCTURES RENDERER ---
   const BusinessStructuresRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [step, setStep] = useState(1);
      const [businessProfile, setBusinessProfile] = useState({ owners: 1, revenue: 'low', risk: 'low', investors: false, goingPublic: false });
      const [selectedStructure, setSelectedStructure] = useState<string | null>(null);

      const structures = [
         { id: 'sole_prop', name: 'Sole Proprietorship', icon: 'üë§', pros: ['Simple to start', 'Full control', 'Pass-through taxes'], cons: ['Unlimited liability', 'Hard to raise capital'], bestFor: 'Single owner, low risk', liability: 'unlimited' },
         { id: 'llc', name: 'LLC', icon: 'üõ°Ô∏è', pros: ['Limited liability', 'Flexible taxes', 'Less formality'], cons: ['Self-employment tax', 'Varying state rules'], bestFor: 'Small biz, protection needed', liability: 'limited' },
         { id: 's_corp', name: 'S Corporation', icon: 'üìã', pros: ['Limited liability', 'Avoid SE tax', 'Pass-through'], cons: ['Strict rules', 'Max 100 shareholders'], bestFor: 'Tax savings, employees', liability: 'limited' },
         { id: 'c_corp', name: 'C Corporation', icon: 'üè¢', pros: ['Limited liability', 'Unlimited investors', 'Stock options'], cons: ['Double taxation', 'Complex'], bestFor: 'Investors, going public', liability: 'limited' },
         { id: 'partnership', name: 'Partnership', icon: 'ü§ù', pros: ['Easy to form', 'Shared resources'], cons: ['Unlimited liability', 'Disputes'], bestFor: 'Multiple owners', liability: 'varies' },
      ];
      const infoTopics: Record<string, { title: string; content: string }> = {
         liability: { title: "Limited Liability", content: "Protects personal assets from business debts/lawsuits. Sole props have NO protection‚Äîcreditors can take everything! LLCs and corps create a legal shield." },
         taxes: { title: "Tax Structures", content: "Pass-through: income taxed once on personal return. C-Corps: double taxation (corp + dividends). S-Corps/LLCs avoid this!" },
         piercing: { title: "Piercing the Veil", content: "Courts can hold owners liable if you mix funds, skip formalities, or undercapitalize. Keep clean books!" },
      };
      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);
      const startGame = () => { setPhase('play'); setStep(1); setBusinessProfile({ owners: 1, revenue: 'low', risk: 'low', investors: false, goingPublic: false }); setSelectedStructure(null); };
      const getRecommendation = () => { if (businessProfile.goingPublic || businessProfile.investors) return 'c_corp'; if (businessProfile.owners > 1 && businessProfile.revenue === 'high') return 's_corp'; if (businessProfile.risk === 'high' || businessProfile.revenue !== 'low') return 'llc'; if (businessProfile.owners > 1) return 'partnership'; return 'sole_prop'; };
      const getMatchScore = (id: string) => { let score = 50; const s = structures.find(st => st.id === id); if (!s) return score; if (businessProfile.goingPublic && id === 'c_corp') score += 30; if (businessProfile.investors && id === 'c_corp') score += 20; if (businessProfile.risk === 'high' && s.liability === 'limited') score += 20; if (businessProfile.revenue === 'high' && id === 's_corp') score += 15; return Math.min(100, score); };
      const getScore = () => selectedStructure === getRecommendation() ? 100 : getMatchScore(selectedStructure || '');
      const getGrade = () => { const s = getScore(); if (s >= 90) return { letter: 'A', label: 'Legal Eagle', color: 'text-green-400' }; if (s >= 70) return { letter: 'B', label: 'Good Choice', color: 'text-blue-400' }; if (s >= 55) return { letter: 'C', label: 'Workable', color: 'text-yellow-400' }; return { letter: 'D', label: 'Reconsider', color: 'text-red-400' }; };

      if (phase === 'intro') return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-800 via-slate-900 to-zinc-900 text-white p-4 overflow-auto"><div className="text-center mb-4"><h1 className="text-2xl font-bold mb-2">üèõÔ∏è Business Structure Advisor</h1><p className="text-slate-400 text-sm">Choose the right legal entity</p></div><div className="bg-black/30 rounded-xl p-4 mb-4"><h2 className="text-lg font-bold mb-3 text-blue-400">üìã How It Works</h2><div className="space-y-2 text-sm"><p>‚Ä¢ Answer questions about your business</p><p>‚Ä¢ Compare <span className="text-blue-400">5 legal structures</span></p><p>‚Ä¢ Get a personalized recommendation</p></div></div><div className="grid grid-cols-5 gap-1 mb-4 text-center text-xs">{structures.map(s => (<div key={s.id} className="bg-black/30 rounded-lg p-2"><span className="text-lg">{s.icon}</span></div>))}</div><div className="flex flex-wrap gap-2 mb-4">{Object.keys(infoTopics).map(key => (<button key={key} onClick={() => setInfoTopic(key)} className="text-xs bg-blue-500/20 px-2 py-1 rounded-full text-blue-300">‚ÑπÔ∏è {infoTopics[key].title}</button>))}</div><button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold">‚ñ∂Ô∏è START</button>{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg">Got it!</button></div></div>)}</div>);
      if (phase === 'result') { const grade = getGrade(); const selected = structures.find(s => s.id === selectedStructure); const recommended = structures.find(s => s.id === getRecommendation()); return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-800 via-slate-900 to-zinc-900 text-white p-4 overflow-auto"><div className="text-center mb-4"><div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div><div className="text-xl font-bold">{grade.label}</div><div className="text-blue-400">Match: {getScore()}%</div></div>{selected && (<div className="bg-black/30 rounded-xl p-3 mb-3"><div className="flex items-center gap-2 mb-2"><span className="text-2xl">{selected.icon}</span><span className="font-bold">{selected.name}</span></div><div className="grid grid-cols-2 gap-2 text-xs"><div><span className="text-green-400">Pros:</span><ul className="text-slate-300">{selected.pros.map((p, i) => <li key={i}>‚Ä¢ {p}</li>)}</ul></div><div><span className="text-red-400">Cons:</span><ul className="text-slate-300">{selected.cons.map((c, i) => <li key={i}>‚Ä¢ {c}</li>)}</ul></div></div></div>)}{recommended && selectedStructure !== recommended.id && (<div className="bg-green-500/20 border border-green-500/50 rounded-xl p-3 mb-3"><p className="text-sm text-green-400 font-bold">üí° Better: {recommended.name}</p><p className="text-xs text-slate-300">{recommended.bestFor}</p></div>)}<div className="bg-black/30 rounded-xl p-3 mb-4"><h3 className="font-bold text-blue-400 mb-2">üí° Key Insight</h3><p className="text-sm text-slate-300">Your structure affects taxes, liability, and growth. Review as your business evolves!</p></div><button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold">üîÑ TRY AGAIN</button></div>); }
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-800 via-slate-900 to-zinc-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-blue-500/30"><div className="flex justify-between items-center"><span className="font-bold">üèõÔ∏è Business Structure</span><span className="text-blue-400">Step {step}/2</span></div></div><div className="flex-1 p-4 overflow-auto">{step === 1 && (<div className="space-y-3"><h3 className="font-bold">About your business:</h3><div className="bg-black/30 rounded-lg p-3"><label className="text-sm font-bold mb-2 block">Owners</label><div className="flex gap-2">{[1, 2, 5].map(n => (<button key={n} onClick={() => setBusinessProfile(p => ({ ...p, owners: n }))} className={`flex-1 py-2 rounded text-sm ${businessProfile.owners === n ? 'bg-blue-600' : 'bg-slate-700'}`}>{n === 1 ? 'Just Me' : n === 2 ? '2-4' : '5+'}</button>))}</div></div><div className="bg-black/30 rounded-lg p-3"><label className="text-sm font-bold mb-2 block">Revenue</label><div className="flex gap-2">{['low', 'medium', 'high'].map(r => (<button key={r} onClick={() => setBusinessProfile(p => ({ ...p, revenue: r }))} className={`flex-1 py-2 rounded text-xs ${businessProfile.revenue === r ? 'bg-blue-600' : 'bg-slate-700'}`}>{r === 'low' ? '<$50K' : r === 'medium' ? '$50-500K' : '$500K+'}</button>))}</div></div><div className="bg-black/30 rounded-lg p-3"><label className="text-sm font-bold mb-2 block">Risk Level</label><div className="flex gap-2">{['low', 'medium', 'high'].map(r => (<button key={r} onClick={() => setBusinessProfile(p => ({ ...p, risk: r }))} className={`flex-1 py-2 rounded text-xs ${businessProfile.risk === r ? 'bg-blue-600' : 'bg-slate-700'}`}>{r.charAt(0).toUpperCase() + r.slice(1)}</button>))}</div></div><div className="bg-black/30 rounded-lg p-3 space-y-2"><label className="flex items-center gap-2"><input type="checkbox" checked={businessProfile.investors} onChange={e => setBusinessProfile(p => ({ ...p, investors: e.target.checked }))} className="w-4 h-4" /><span className="text-sm">Seeking investors</span></label><label className="flex items-center gap-2"><input type="checkbox" checked={businessProfile.goingPublic} onChange={e => setBusinessProfile(p => ({ ...p, goingPublic: e.target.checked }))} className="w-4 h-4" /><span className="text-sm">May go public</span></label></div><button onClick={() => setStep(2)} className="w-full py-3 bg-blue-600 rounded-xl font-bold">Next ‚Üí</button></div>)}{step === 2 && (<div className="space-y-2"><h3 className="font-bold">Choose Structure:</h3>{structures.map(s => { const match = getMatchScore(s.id); const isRec = s.id === getRecommendation(); return (<div key={s.id} onClick={() => { setSelectedStructure(s.id); setPhase('result'); }} className={`bg-black/30 rounded-lg p-3 cursor-pointer border-2 ${isRec ? 'border-green-500/50' : 'border-transparent hover:border-blue-500/50'}`}><div className="flex justify-between items-center"><div className="flex items-center gap-2"><span className="text-xl">{s.icon}</span><span className="font-bold text-sm">{s.name}</span>{isRec && <span className="text-xs text-green-400">‚òÖ</span>}</div><span className={`text-xs px-2 py-1 rounded ${match >= 70 ? 'bg-green-500/30 text-green-400' : 'bg-slate-500/30'}`}>{match}%</span></div><p className="text-xs text-slate-400 mt-1">{s.bestFor}</p></div>); })}</div>)}</div><div className="p-3 bg-black/30 border-t border-blue-500/30"><div className="flex gap-2"><button onClick={() => setInfoTopic('liability')} className="text-xs text-blue-400">‚ÑπÔ∏è Liability</button><button onClick={() => setInfoTopic('taxes')} className="text-xs text-blue-400">‚ÑπÔ∏è Taxes</button></div></div></div>);
   };

   // --- INTELLECTUAL PROPERTY RENDERER ---
   const IntellectualPropertyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Complex scenarios with non-obvious answers and trap options
      const scenarios = [
         {
            title: "The Algorithm Dilemma",
            situation: "Your startup developed a revolutionary ML algorithm that gives you a major competitive edge. A VC is interested but wants to see a demo. Your lead developer might leave for a competitor next year.",
            question: "What's the BEST IP strategy for this algorithm?",
            opts: ['Patent it immediately', 'Keep as Trade Secret', 'Copyright the code', 'Publish openly for credibility'],
            correct: 1,
            wrongExplanations: [
               "Patents require PUBLIC DISCLOSURE. Once filed, your algorithm is public after 18 months‚Äîcompetitors can design around it. Also takes 2-3 years and $15K+. Meanwhile, your advantage is gone.",
               "", // Correct answer
               "Copyright only protects the specific code expression, NOT the underlying algorithm idea. Competitors can rewrite your algorithm in different code legally.",
               "Publishing destroys all IP rights. You can't patent it after. Competitors can freely copy. Only makes sense for research institutions seeking academic credit."
            ],
            realWorld: "Coca-Cola's formula has been a trade secret for 130+ years. If they had patented it, it would have expired in 1906 and anyone could make Coke.",
            concept: "patent_vs_secret",
            why: "Trade secrets protect INDEFINITELY but only if kept secret. Patents expire after 20 years. For algorithms that are hard to reverse-engineer, trade secrets often win."
         },
         {
            title: "The Contractor Trap",
            situation: "You hired a freelance developer to build your mobile app. The contract says 'work for hire' but doesn't specifically mention IP assignment. The freelancer used some of their pre-existing code libraries.",
            question: "Who owns the IP rights to the app?",
            opts: ['You own everything‚Äîyou paid for it', 'Split ownership based on contribution', 'Freelancer owns it unless explicitly assigned', 'Only you own the new code, they keep library rights'],
            correct: 3,
            wrongExplanations: [
               "WRONG! Payment doesn't equal ownership. Under copyright law, the creator owns their work by default. 'Work for hire' only applies to employees or specific contract categories.",
               "Copyright law doesn't do 'split ownership' automatically. This creates a legal nightmare where neither party can fully use the work.",
               "Close but incomplete. The freelancer owns new code by default without explicit assignment, BUT they always retain rights to their pre-existing libraries unless explicitly assigned.",
               "" // Correct answer
            ],
            realWorld: "In the famous Playboy v. Dumas case, Playboy lost rights to artwork they paid for because the artist was a contractor without proper IP assignment.",
            concept: "work_for_hire",
            why: "Pre-existing IP stays with creators unless EXPLICITLY assigned. Always get written IP assignment agreements that distinguish new work from pre-existing code/tools."
         },
         {
            title: "The Naming Nightmare",
            situation: "You're launching 'ByteForce' as your company name. Another company has 'ByteForce' registered for enterprise software (USPTO Class 9). You're in fitness wearables (also Class 9).",
            question: "Can you legally use 'ByteForce' for your fitness wearables?",
            opts: ['Yes‚Äîdifferent products, no conflict', 'Yes‚Äîfirst to use in fitness wins', 'No‚Äîsame trademark class means conflict', 'Maybe‚Äîdepends on likelihood of confusion'],
            correct: 2,
            wrongExplanations: [
               "Same trademark class IS the conflict. Class 9 covers all 'computer hardware and software'‚Äîboth enterprise software and fitness wearables fall under this class.",
               "Trademark law isn't 'first to use per product.' The other company has priority in the entire Class 9 and can block you from registration.",
               "", // Correct answer
               "This isn't a 'maybe'‚Äîsame class with identical name is almost certainly infringement. 'Likelihood of confusion' analysis matters more for similar (not identical) marks."
            ],
            realWorld: "Apple Corps (Beatles) sued Apple Computer repeatedly because both were in 'Class 9' even though music and computers seemed different.",
            concept: "trademark_classes",
            why: "Trademark protection is class-based. 'ByteForce' for hamburgers (Class 43) might be fine, but anything in Class 9 creates direct conflict. Always search USPTO BEFORE naming."
         },
         {
            title: "The Employee Exit",
            situation: "Your senior engineer is leaving for a competitor. She has deep knowledge of your proprietary systems, customer lists, and upcoming product roadmap. She signed an NDA but NOT a non-compete.",
            question: "What can you legally prevent her from doing?",
            opts: ['Working for any competitor for 2 years', 'Using or disclosing your trade secrets', 'Taking any clients she worked with', 'Nothing‚Äîwithout non-compete you have no rights'],
            correct: 1,
            wrongExplanations: [
               "Without a signed non-compete, you cannot restrict where she works. Non-competes are also unenforceable in California and increasingly restricted nationwide.",
               "", // Correct answer
               "Client relationships are complex. She can contact clients she has personal relationships with unless those relationships ARE trade secrets (like a secret client list).",
               "NDAs are powerful! Trade secret law (DTSA) protects confidential business information even without non-competes. She cannot use or disclose what she learned."
            ],
            realWorld: "Waymo vs Uber: Anthony Levandowski left Google and allegedly took trade secrets to Uber. Cost Uber $245M settlement despite no non-compete.",
            concept: "nda_vs_noncompete",
            why: "NDAs protect INFORMATION (trade secrets). Non-competes restrict WHERE someone works. NDAs are enforceable everywhere; non-competes are not. Build protection through NDAs + trade secret protocols."
         },
         {
            title: "The Design Dilemma",
            situation: "You designed a unique, innovative smartwatch case shape. A competitor just launched a very similar-looking product. You never filed any IP protection but have been selling for 8 months.",
            question: "What IP protection could you STILL potentially claim?",
            opts: ['Utility patent‚Äîyou invented it first', 'Design patent‚Äîyou can still file', 'Trade dress‚Äîdistinctive product appearance', 'None‚Äîyou missed the window completely'],
            correct: 2,
            wrongExplanations: [
               "Utility patents protect HOW something works (function), not how it looks (form). A case shape is ornamental, not functional.",
               "Design patents must be filed within 12 months of first public sale. However, the process takes 1-2 years and only lasts 15 years. But trade dress might be stronger here.",
               "", // Correct answer
               "Trade dress protection for distinctive product design doesn't require registration! If consumers associate your distinctive shape with your brand, you may have enforceable rights."
            ],
            realWorld: "Apple successfully sued Samsung for trade dress infringement on iPhone design elements, winning $539M for 'look and feel' even beyond their patents.",
            concept: "trade_dress",
            why: "Trade dress protects product appearance that consumers associate with a brand. No registration required (though it helps). Requires proving distinctiveness + consumer association."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         patent: {
            title: "Patents: The Trade-Off",
            content: "Patents give 20-year monopoly BUT require full public disclosure. Cost: $15K-30K+, Time: 2-4 years. Best for: innovations that are easy to reverse-engineer. Worst for: algorithms competitors can't see anyway."
         },
         trade_secret: {
            title: "Trade Secrets: Infinite but Fragile",
            content: "Last forever if kept secret. No registration needed. BUT: one disclosure = gone forever. Requires NDAs, access controls, exit interviews. Best for: formulas, algorithms, customer lists. Examples: Coca-Cola formula, Google's PageRank algorithm."
         },
         trademark: {
            title: "Trademarks: Brand Protection",
            content: "Protect brand identifiers in specific classes. ‚Ñ¢ (unregistered) vs ¬Æ (registered). Last forever if actively used. Classes matter‚Äîsame name in different class is usually OK. Search USPTO BEFORE naming your company!"
         },
         copyright: {
            title: "Copyright: Expression Not Ideas",
            content: "Automatic upon creation‚Äîno registration needed to own. BUT registration required to sue for damages. Protects specific expression (your code), NOT underlying ideas (algorithms). Lasts: life + 70 years."
         },
         work_for_hire: {
            title: "Work for Hire: The Contractor Trap",
            content: "Employees: employer owns work automatically. Contractors: CREATOR owns work unless written assignment. 'Work for hire' only applies to employees or 9 specific categories (not software!). Always get explicit IP assignment in contractor agreements."
         },
         trade_dress: {
            title: "Trade Dress: Look & Feel Protection",
            content: "Protects distinctive product appearance/packaging that consumers associate with a brand. No registration required (helps in court). Examples: Coca-Cola bottle shape, Apple store design, Tiffany blue box."
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Understood ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'IP Strategist', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Protected', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Risky Gaps', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Exposed', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         patent_vs_secret: "Patent vs Trade Secret Strategy",
         work_for_hire: "Contractor IP Ownership",
         trademark_classes: "Trademark Classification",
         nda_vs_noncompete: "NDA vs Non-Compete Protection",
         trade_dress: "Trade Dress & Design Rights"
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-slate-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">üîê IP Strategy Challenge</h1>
               <p className="text-violet-300 text-sm">Real decisions. Real consequences. Master IP protection.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-violet-400">‚ö° Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">$5.4 TRILLION</span> in IP theft annually worldwide</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">67%</span> of startup value is in intangible IP assets</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">Wrong IP strategy</span> can destroy your competitive advantage</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-violet-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 real-world scenarios</span> with trap answers</p>
                  <p>‚Ä¢ Understand <span className="text-yellow-400">WHY</span> each strategy works or fails</p>
                  <p>‚Ä¢ Learn from <span className="text-cyan-400">famous cases</span> and costly mistakes</p>
                  <p>‚Ä¢ Get <span className="text-green-400">personalized gaps</span> for further study</p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-violet-500/20 px-2 py-1 rounded-full text-violet-300 hover:bg-violet-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(':')[0]}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN CHALLENGE
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-violet-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Knowledge Gaps to Study</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'patent_vs_secret' ? 'patent' :
                                                  gap === 'work_for_hire' ? 'work_for_hire' :
                                                  gap === 'trademark_classes' ? 'trademark' :
                                                  gap === 'nda_vs_noncompete' ? 'trade_secret' : 'trade_dress';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-violet-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Perfect Understanding!</h3>
                     <p className="text-sm text-slate-300">You correctly identified the optimal IP strategy in every scenario. You understand the nuances of patent vs trade secret, contractor IP, trademark classes, and protection mechanisms.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-violet-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-violet-400 mb-2">üí° Key Strategic Insights</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Trade secrets</span> often beat patents for algorithms</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Written IP assignment</span> is essential for contractors</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Trademark class</span> determines conflict, not product similarity</li>
                     <li>‚Ä¢ <span className="text-yellow-400">NDAs</span> protect information even without non-competes</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // PLAY PHASE
      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-slate-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-violet-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-sm">üîê {s.title}</span>
                  <span className="text-violet-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-violet-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            {/* Scenario */}
            <div className="flex-1 p-3 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-200 leading-relaxed">{s.situation}</p>
               </div>

               <p className="text-sm font-bold text-violet-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-violet-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-violet-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {/* Explanation after answer */}
               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} is Wrong:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì Why {String.fromCharCode(65 + s.correct)} is Best:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-cyan-900/30 border border-cyan-500/50 rounded-lg">
                        <p className="text-xs font-bold text-cyan-400 mb-1">üì∞ Real-World Case:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            {/* Info Buttons Footer */}
            <div className="p-3 bg-black/30 border-t border-violet-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('patent')} className="text-xs text-violet-400 hover:text-violet-300">‚ÑπÔ∏è Patents</button>
               <button onClick={() => setInfoTopic('trade_secret')} className="text-xs text-violet-400 hover:text-violet-300">‚ÑπÔ∏è Trade Secrets</button>
               <button onClick={() => setInfoTopic('trademark')} className="text-xs text-violet-400 hover:text-violet-300">‚ÑπÔ∏è Trademarks</button>
               <button onClick={() => setInfoTopic('copyright')} className="text-xs text-violet-400 hover:text-violet-300">‚ÑπÔ∏è Copyright</button>
            </div>
         </div>
      );
   };

   // --- CONTRACTS RENDERER ---
   const ContractsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Context-dependent scenarios - same clause can be OK or bad depending on situation
      const scenarios = [
         {
            title: "The Payment Trap",
            role: "Freelance Developer",
            context: "You're a solo freelancer. A Fortune 500 company wants to hire you for a $50K project. Their standard contract says:",
            clause: "Payment: NET 90 days after project acceptance, subject to internal approval process.",
            question: "What's the BEST response to this clause?",
            opts: [
               'Accept it - big company, they will pay eventually',
               'Reject the project - NET 90 is unacceptable',
               'Counter: 50% upfront, 50% NET 30 with late fees',
               'Counter: NET 30 only, no other changes'
            ],
            correct: 2,
            wrongExplanations: [
               "DANGEROUS! 'Subject to internal approval' + NET 90 means 4-6 months to payment. As a freelancer, you could go bankrupt waiting. Large companies know solo contractors can't sue them.",
               "Walking away loses a $50K opportunity. The clause IS bad, but big companies expect negotiation. Walking away should be your last resort, not first response.",
               "", // Correct
               "Better than accepting, but you're leaving money on the table. Big companies have cash‚Äîasking for upfront payment is standard and protects your cash flow risk."
            ],
            realWorld: "In 2019, Hertz filed bankruptcy owing contractors $16M+ in unpaid invoices. Contractors with 'NET 90 subject to approval' clauses got pennies on the dollar.",
            concept: "payment_terms",
            why: "Big company ‚â† safe payment. NET 90 + 'approval process' can mean 6+ months. Always get upfront payment for projects over 30 days, especially with large companies that have slow bureaucracies."
         },
         {
            title: "The Liability Landmine",
            role: "SaaS Startup Founder",
            context: "You're selling your $500/month software to an enterprise client. Their legal team sends back your contract with this added:",
            clause: "Vendor shall indemnify Client for any and all damages, losses, and liabilities arising from use of the software, including consequential and indirect damages, without limitation.",
            question: "How should you handle this indemnification clause?",
            opts: [
               'Accept - they are a big client, worth the risk',
               'Cap liability at 12 months of fees paid ($6,000)',
               'Cap liability at total contract value and exclude consequential damages',
               'Reject any indemnification - your software, your rules'
            ],
            correct: 2,
            wrongExplanations: [
               "NEVER accept unlimited liability! If their business loses $10M 'because of your software' (even if it's their fault), they can sue you for the full amount. This has bankrupted startups.",
               "12 months is reasonable for liability cap, BUT you forgot to exclude consequential damages. 'Consequential' means lost profits, lost business, reputation damage‚Äîcould be millions even with a $6K cap.",
               "", // Correct
               "Refusing any indemnification will kill the deal. Enterprise clients legitimately need some protection. The key is REASONABLE limits, not zero responsibility."
            ],
            realWorld: "A startup was sued for $4.2M when their client's employee misused the software causing a data breach. Unlimited indemnification meant the startup paid, not the employee who caused it.",
            concept: "liability_caps",
            why: "Indemnification without caps is a blank check. Always: (1) Cap at contract value or 12 months fees, (2) Exclude consequential/indirect damages, (3) Require client to mitigate damages."
         },
         {
            title: "The IP Ownership Puzzle",
            role: "Contract Developer",
            context: "A client wants you to build custom software. You'll use your own reusable framework (built over 5 years) as the foundation. Their contract states:",
            clause: "All work product, including all intellectual property, code, documentation, and materials created under this Agreement shall be the sole property of Client as work-for-hire.",
            question: "What's wrong with this clause, and how should you fix it?",
            opts: [
               'Nothing wrong - they are paying, they own it',
               'Add: "excluding Contractor pre-existing IP which is licensed to Client"',
               'Change to: "Client owns custom code; Contractor retains framework under perpetual license to Client"',
               'Reject - never assign IP to clients'
            ],
            correct: 2,
            wrongExplanations: [
               "WRONG! This would transfer your 5-year framework to them. You couldn't use YOUR OWN code for any other client. This destroys your business value.",
               "Better, but 'licensed' is vague. Does Client get exclusive rights? Can they sublicense? What happens if they stop paying? You need specific license terms.",
               "", // Correct
               "Too extreme. Clients legitimately need to own custom work they paid for. The issue is protecting YOUR pre-existing tools while giving them what they need."
            ],
            realWorld: "A developer lost rights to their component library (worth $200K+) because a client's 'all IP' clause was interpreted to include pre-existing code integrated into the project.",
            concept: "ip_assignment",
            why: "Separate custom deliverables (client owns) from your tools/frameworks (you retain, license to client). Specify: non-exclusive, perpetual, royalty-free license for your pre-existing IP."
         },
         {
            title: "The Termination Trap",
            role: "Marketing Agency Owner",
            context: "You've signed a 12-month retainer contract ($10K/month) with a client. Three months in, they want to cancel. Your contract says:",
            clause: "Either party may terminate with 30 days written notice. Upon termination, Client shall pay for all work completed to date.",
            question: "You've turned down other clients for this retainer. What's the problem?",
            opts: [
               'No problem - 30 days notice is fair and standard',
               'Problem: No early termination fee protects your lost opportunity',
               'Problem: Should require cause for termination (breach only)',
               'Problem: Need 90 days notice minimum for long-term contracts'
            ],
            correct: 1,
            wrongExplanations: [
               "30 days notice IS standard, but you're missing the bigger picture. You turned down 9 months of other work ($90K opportunity cost) based on this contract. 30 days notice doesn't compensate for that.",
               "", // Correct
               "Cause-only termination is too restrictive and unreasonable. Clients legitimately need exit options. The issue is compensation for early exit, not preventing exit.",
               "90 days is excessive and may not be enforceable. Courts prefer reasonable exit terms. The solution is financial compensation, not longer notice periods."
            ],
            realWorld: "An agency lost $400K in projected revenue when a client terminated a 2-year contract after 3 months. Their 'mutual termination' clause had no early exit penalty.",
            concept: "termination_clauses",
            why: "For long-term contracts, include graduated termination fees: e.g., 'Early termination requires payment of 50% of remaining contract value, decreasing 10% per quarter completed.'"
         },
         {
            title: "The Auto-Renewal Ambush",
            role: "Small Business Owner",
            context: "You're reviewing a software subscription renewal. The original contract you signed 11 months ago included:",
            clause: "This Agreement automatically renews for successive 12-month terms unless either party provides written notice of non-renewal at least 60 days before the current term expires.",
            question: "It's now 45 days before renewal. What's your situation?",
            opts: [
               'Send cancellation notice now - 45 days is reasonable',
               'You are legally locked in for another 12 months',
               'Call and negotiate - auto-renewal clauses are not enforceable',
               'Send notice now and dispute the charge if they bill you'
            ],
            correct: 1,
            wrongExplanations: [
               "You MISSED the 60-day window. 45 days notice does NOT satisfy the contract. Your notice is legally ineffective, and you will be auto-renewed.",
               "", // Correct
               "Auto-renewal clauses ARE generally enforceable when clearly disclosed (which this was). Some states require specific notice, but most don't void the clause entirely.",
               "Disputing the charge will fail. You signed the contract, the clause is valid, you missed the deadline. Chargeback disputes will side with the vendor."
            ],
            realWorld: "A company paid $180K for software they didn't want because they missed a 90-day cancellation window by 2 weeks. The vendor refused to negotiate.",
            concept: "auto_renewal",
            why: "Calendar ALL renewal deadlines immediately when signing. Auto-renewal benefits vendors‚Äîbuild systems to track and send notices 90 days early. Some states now require renewal reminders."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         payment: {
            title: "Payment Terms Strategy",
            content: "NET 30 is standard. For projects >$10K or >30 days, get 25-50% upfront. Add late fees (1.5%/month). Milestone payments for long projects. 'Subject to approval' = red flag. For large companies, shorter payment terms because their AP departments are slow."
         },
         liability: {
            title: "Liability & Indemnification",
            content: "Always cap liability (1-2x contract value). Exclude consequential, indirect, and punitive damages. Mutual indemnification is fair. Never accept unlimited liability‚Äîit's not worth any contract amount. Insurance can help but caps are essential."
         },
         ip_rights: {
            title: "IP Ownership Structures",
            content: "Custom work: client owns. Your tools/frameworks: you retain, license to client. License types: exclusive (only them), non-exclusive (you keep using). Always specify: scope, duration, territory, sublicense rights. Pre-existing IP must be carved out explicitly."
         },
         termination: {
            title: "Termination Provisions",
            content: "Convenience termination: either party can exit. For-cause termination: only for breach. Long-term contracts need early exit fees. Include cure periods (30 days to fix breach). Specify what happens to IP, payments, and confidentiality post-termination."
         },
         negotiation: {
            title: "Negotiation Tactics",
            content: "Everything is negotiable (especially with big companies). Start with your ideal terms. Know your walkaway point before negotiating. Bundle concessions ('I'll accept NET 60 if you add early termination fee'). Get changes in writing before signing."
         },
         red_flags: {
            title: "Immediate Red Flags",
            content: "Unlimited liability, auto-renewal without notice requirements, 'all IP' without carve-outs, payment 'subject to approval', non-compete over 1 year or outside your industry, unilateral amendment rights, jurisdiction in another country."
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Understood ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'Contract Strategist', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Protected', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Vulnerable', color: 'text-yellow-400' };
         return { letter: 'D', label: 'High Risk', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         payment_terms: "Payment Terms & Cash Flow Protection",
         liability_caps: "Liability Caps & Indemnification",
         ip_assignment: "IP Ownership & Licensing",
         termination_clauses: "Termination Fees & Exit Strategy",
         auto_renewal: "Auto-Renewal Traps & Calendar Management"
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-rose-900 via-pink-900 to-slate-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">üìú Contract Negotiation Lab</h1>
               <p className="text-rose-300 text-sm">Context matters. Strategy wins. Protect your business.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-rose-400">‚ö†Ô∏è Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">83%</span> of small businesses sign contracts without negotiating</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">$50B+</span> lost annually to unfavorable contract terms</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">Same clause</span> can be OK or devastating‚Äîcontext determines everything</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-rose-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 real contract scenarios</span> from different perspectives</p>
                  <p>‚Ä¢ Decide: <span className="text-yellow-400">What should you DO?</span> (not just flag)</p>
                  <p>‚Ä¢ Learn <span className="text-cyan-400">strategic responses</span> that protect your interests</p>
                  <p>‚Ä¢ See <span className="text-red-400">real consequences</span> of bad contract decisions</p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-rose-500/20 px-2 py-1 rounded-full text-rose-300 hover:bg-rose-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(' ').slice(0, 2).join(' ')}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN NEGOTIATION
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-rose-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-rose-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-rose-900 via-pink-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-rose-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Contract Gaps to Study</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'payment_terms' ? 'payment' :
                                                  gap === 'liability_caps' ? 'liability' :
                                                  gap === 'ip_assignment' ? 'ip_rights' :
                                                  gap === 'termination_clauses' ? 'termination' : 'red_flags';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-rose-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Contract Expert!</h3>
                     <p className="text-sm text-slate-300">You understand the strategic nuances of contract negotiation‚Äîpayment protection, liability caps, IP structures, and termination strategies.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-rose-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-rose-400 mb-2">üí° Key Strategic Principles</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Context determines risk</span>‚Äîsame clause can be OK or dangerous</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Everything is negotiable</span>‚Äîespecially with large companies</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Protect cash flow</span>‚Äîupfront payments for long projects</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Calendar everything</span>‚Äîrenewal traps are real</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-rose-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-rose-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // PLAY PHASE
      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-rose-900 via-pink-900 to-slate-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-rose-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-rose-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-rose-500/30">
               <div className="flex justify-between items-center">
                  <div>
                     <span className="font-bold text-sm">üìú {s.title}</span>
                     <span className="ml-2 text-xs text-rose-400 bg-rose-500/20 px-2 py-0.5 rounded">{s.role}</span>
                  </div>
                  <span className="text-rose-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-rose-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            {/* Scenario */}
            <div className="flex-1 p-3 overflow-auto">
               {/* Context */}
               <div className="bg-black/30 rounded-lg p-3 mb-2">
                  <p className="text-xs text-slate-400 mb-1">SITUATION:</p>
                  <p className="text-sm text-slate-200">{s.context}</p>
               </div>

               {/* Contract Clause */}
               <div className="bg-slate-800/50 border-l-4 border-rose-500 rounded-r-lg p-3 mb-3">
                  <p className="text-xs text-rose-400 mb-1">CONTRACT CLAUSE:</p>
                  <p className="text-sm font-mono text-slate-200 italic">"{s.clause}"</p>
               </div>

               <p className="text-sm font-bold text-rose-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-rose-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-rose-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {/* Explanation after answer */}
               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} is Wrong:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì Strategic Response:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                        <p className="text-xs font-bold text-amber-400 mb-1">‚ö†Ô∏è Real Case:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            {/* Info Buttons Footer */}
            <div className="p-3 bg-black/30 border-t border-rose-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('payment')} className="text-xs text-rose-400 hover:text-rose-300">‚ÑπÔ∏è Payment</button>
               <button onClick={() => setInfoTopic('liability')} className="text-xs text-rose-400 hover:text-rose-300">‚ÑπÔ∏è Liability</button>
               <button onClick={() => setInfoTopic('ip_rights')} className="text-xs text-rose-400 hover:text-rose-300">‚ÑπÔ∏è IP Rights</button>
               <button onClick={() => setInfoTopic('termination')} className="text-xs text-rose-400 hover:text-rose-300">‚ÑπÔ∏è Termination</button>
            </div>
         </div>
      );
   };

   // --- PERMITS RENDERER ---
   const PermitsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Real compliance scenarios with consequences
      const scenarios = [
         {
            title: "The Food Truck Launch",
            situation: "You're launching a food truck selling tacos. You got your business license and food handler permits. Opening day arrives. The health inspector shows up.",
            question: "What permit are you MOST LIKELY missing that could shut you down immediately?",
            opts: [
               'Sales Tax Permit - need to collect taxes',
               'Mobile Food Vendor Permit - specific to food trucks',
               'Fire Extinguisher Certificate - safety requirement',
               'Music License - playing radio while serving'
            ],
            correct: 1,
            wrongExplanations: [
               "Sales tax permits are important but inspectors don't check for them on opening day. The state catches this later during tax audits, not health inspections.",
               "", // Correct
               "Fire extinguisher certs are part of the mobile vendor permit inspection, not a separate permit in most jurisdictions.",
               "Music licenses (ASCAP/BMI) are for businesses, but no inspector checks this on opening day. This becomes an issue if you're caught, but not from health inspectors."
            ],
            realWorld: "A LA food truck owner was fined $5,000 and shut down for 2 weeks for operating with a restaurant permit instead of a mobile food vendor permit‚Äîdifferent inspection requirements, different commissary rules.",
            concept: "industry_specific",
            why: "Food trucks need MOBILE-specific permits, not restaurant permits. Requirements include: commissary agreement (where you prep/clean), specific route permits (some cities), and mobile vendor inspections. Standard food permits don't cover mobile operations."
         },
         {
            title: "The Home Bakery Surprise",
            situation: "You're baking and selling cookies from home. You've been operating for 6 months with just a home occupation permit and business license. A neighbor complains about delivery trucks.",
            question: "What's the REAL compliance issue that could shut you down?",
            opts: [
               'The neighbor complaint about trucks - noise violation',
               'Missing cottage food license - home food production laws',
               'Zoning violation - residential zone restrictions',
               'No health inspection - food safety requirement'
            ],
            correct: 1,
            wrongExplanations: [
               "Truck noise is a nuisance complaint, not a permit issue. Code enforcement might give a warning, but it won't shut down your business.",
               "", // Correct
               "Zoning is secondary here. Most residential zones allow home occupations‚Äîthe issue is the TYPE of home business (food production has special rules).",
               "Cottage food operations are actually EXEMPT from health inspections in most states‚Äîthat's the whole point of cottage food laws. But you need the cottage food license first."
            ],
            realWorld: "A Texas home baker was fined $25,000 for selling without a cottage food license. She had a home occupation permit but didn't know cottage food was a separate requirement.",
            concept: "cottage_food",
            why: "Cottage food laws allow home food production but with strict limits: specific foods only (usually baked goods, jams, not meat/dairy), annual sales caps ($25K-$75K depending on state), labeling requirements, and registration. Regular business license doesn't cover this."
         },
         {
            title: "The Contractor Nightmare",
            situation: "You're a general contractor hired to remodel a kitchen ($40K job). You have your contractor's license and business license. Midway through, a city inspector arrives.",
            question: "What permit issue could result in the homeowner being forced to TEAR OUT your completed work?",
            opts: [
               'Missing workers comp insurance for your crew',
               'No building permit pulled for the project',
               'Expired contractor license - needs annual renewal',
               'Wrong contractor class - residential vs commercial'
            ],
            correct: 1,
            wrongExplanations: [
               "Workers comp is serious (you can be sued), but inspectors don't check this. It's an insurance/labor issue, not a building inspection issue.",
               "", // Correct
               "Expired license is bad, but work done under an expired license is usually grandfathered. The city won't tear out work for this‚Äîthey'll fine you and stop future work.",
               "Wrong class violations result in fines and license issues, not demolition of completed work."
            ],
            realWorld: "A $200K kitchen remodel in California was ordered demolished because no permits were pulled. The drywall hid unpermitted electrical work. Homeowner sued contractor for $350K including demolition costs.",
            concept: "building_permits",
            why: "Building permits aren't just paperwork‚Äîthey ensure code compliance through inspections at each stage. Unpermitted work: (1) must be exposed for inspection or torn out, (2) voids insurance claims, (3) kills home sales, (4) creates contractor liability for FULL reconstruction."
         },
         {
            title: "The Retail Pop-Up Trap",
            situation: "You're opening a 3-day pop-up shop in a vacant retail space. The landlord says 'just set up, it's temporary.' You bring inventory and start selling.",
            question: "What's the MOST LIKELY reason you'll get shut down on day one?",
            opts: [
               'No sales tax permit - can\'t legally collect tax',
               'Temporary Use Permit from the city - pop-ups need authorization',
               'Fire marshal approval - occupancy limits',
               'No ADA compliance - accessibility requirements'
            ],
            correct: 1,
            wrongExplanations: [
               "Sales tax permits are state-level and don't trigger immediate shutdown. You'll face penalties later, but enforcement is slow.",
               "", // Correct
               "Fire marshal checks are typically part of permanent occupancy permits, not pop-up enforcement. They might check after complaints.",
               "ADA compliance is a lawsuit risk, not a permit issue. No inspector shuts you down for ADA on day one‚Äîit's civil liability."
            ],
            realWorld: "A pop-up holiday market in Denver was shut down 2 hours after opening‚Äîvendors had business licenses but no temporary use permits. City lost $50K in fees they would have collected if vendors had applied.",
            concept: "temporary_permits",
            why: "Pop-ups/temporary events need: (1) Temporary Use Permit from city planning, (2) Special event permit if selling food/alcohol, (3) Landlord written permission (verbal isn't enough), (4) Liability insurance naming the city. 'Temporary' doesn't mean 'no permits.'"
         },
         {
            title: "The SaaS Startup Surprise",
            situation: "You're running a profitable SaaS company from home. You have a home occupation permit and business license. You've hired 3 remote employees. An auditor calls about 'business personal property tax.'",
            question: "What compliance issue do most tech startups miss that triggers this audit?",
            opts: [
               'Not paying self-employment tax on profits',
               'Business Personal Property Tax on computers/equipment',
               'Remote employee work permits in their states',
               'Software sales tax collection requirements'
            ],
            correct: 1,
            wrongExplanations: [
               "Self-employment tax is an IRS issue, not a local auditor issue. This wouldn't trigger a call from a 'business personal property' auditor.",
               "", // Correct
               "Remote employee work permits aren't typically a thing (employees work under your business license). Nexus/tax registration in their states is, but that's not 'personal property tax.'",
               "SaaS sales tax is complex but it's state-level, not what a 'business personal property tax' auditor is calling about."
            ],
            realWorld: "A tech startup in Texas was hit with $12,000 in back taxes plus penalties for never filing Business Personal Property Tax returns on their computers, servers, and office equipment.",
            concept: "property_tax",
            why: "Business Personal Property Tax applies to business equipment (computers, furniture, machinery) in most states. It's separate from real estate tax. Many home-based businesses miss this because they think 'home office' means residential tax treatment. Equipment used for business is taxed as business property."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         business_license: {
            title: "Business License Basics",
            content: "Required in almost every city/county. Costs $50-500. Annual renewal. Operating without = daily fines ($100-500/day in some cities). Usually tied to your physical address‚Äîmoving means new license."
         },
         zoning: {
            title: "Zoning & Land Use",
            content: "Controls WHAT businesses can operate WHERE. Home occupations have limits (no customers, no employees, no signage in some zones). Changing use (retail to restaurant) requires zoning approval. Check BEFORE signing a lease."
         },
         industry_permits: {
            title: "Industry-Specific Permits",
            content: "Food = Health permits + cottage food or commercial kitchen. Alcohol = Liquor license (can take 6+ months). Construction = Contractor license + building permits per project. Childcare = State licensing. Each industry has hidden requirements."
         },
         building_permits: {
            title: "Building & Construction Permits",
            content: "Required for: electrical, plumbing, structural changes, HVAC. NOT just for new construction‚Äîrenovations need them too. Unpermitted work = tear out + redo. Kills home sales. Voids insurance claims."
         },
         state_federal: {
            title: "State & Federal Requirements",
            content: "EIN (federal) = free, apply online. State tax registration = required to collect sales tax. Professional licenses (doctors, lawyers, contractors) = state-level. Industry regulations (FDA, EPA, OSHA) = federal. Layer of requirements varies by business."
         },
         compliance_timeline: {
            title: "Permit Timeline Reality",
            content: "Business license: 1-2 weeks. Health permits: 2-8 weeks. Liquor license: 3-12 months (!). Building permits: 2-12 weeks. Zoning changes: 3-6 months. Plan backwards from your launch date. Rush fees exist but are expensive."
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Understood ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'Compliance Expert', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Mostly Compliant', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Risky Gaps', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Violation Risk', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         industry_specific: "Industry-Specific Permit Requirements",
         cottage_food: "Cottage Food & Home Business Laws",
         building_permits: "Building Permits & Inspections",
         temporary_permits: "Temporary Use & Pop-Up Permits",
         property_tax: "Business Personal Property Tax"
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-cyan-900 to-slate-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">üèõÔ∏è Compliance Crisis Simulator</h1>
               <p className="text-sky-300 text-sm">The permits you don't know about will shut you down.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-sky-400">‚ö†Ô∏è Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">30%</span> of small businesses face permit violations in year one</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">$10,000+</span> average cost of compliance failures (fines + remediation)</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">Hidden permits</span> vary by industry, location, and business type</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-sky-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 real compliance scenarios</span> entrepreneurs face</p>
                  <p>‚Ä¢ Identify <span className="text-yellow-400">hidden permit requirements</span> that cause shutdowns</p>
                  <p>‚Ä¢ Learn <span className="text-cyan-400">real consequences</span> and how to avoid them</p>
                  <p>‚Ä¢ Discover <span className="text-red-400">permits you didn't know existed</span></p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-sky-500/20 px-2 py-1 rounded-full text-sky-300 hover:bg-sky-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(' ').slice(0, 2).join(' ')}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-sky-600 to-cyan-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN SIMULATION
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-sky-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-sky-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-cyan-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-sky-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Compliance Gaps to Research</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'industry_specific' ? 'industry_permits' :
                                                  gap === 'cottage_food' ? 'zoning' :
                                                  gap === 'building_permits' ? 'building_permits' :
                                                  gap === 'temporary_permits' ? 'zoning' : 'state_federal';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-sky-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Compliance Expert!</h3>
                     <p className="text-sm text-slate-300">You understand the hidden permit requirements that catch most entrepreneurs. You know to look beyond basic business licenses.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-sky-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-sky-400 mb-2">üí° Compliance Strategy</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Research industry-specific</span> permits beyond business license</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Check city AND county AND state</span> requirements separately</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Timeline matters</span>‚Äîsome permits take months</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Ask your city clerk</span>‚Äîthey know what you need</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-sky-600 to-cyan-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-sky-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-sky-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // PLAY PHASE
      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-cyan-900 to-slate-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-sky-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-sky-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-sky-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-sm">üèõÔ∏è {s.title}</span>
                  <span className="text-sky-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-sky-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            {/* Scenario */}
            <div className="flex-1 p-3 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-200 leading-relaxed">{s.situation}</p>
               </div>

               <p className="text-sm font-bold text-sky-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-sky-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-sky-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {/* Explanation after answer */}
               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} is Wrong:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì The Hidden Requirement:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                        <p className="text-xs font-bold text-amber-400 mb-1">‚ö†Ô∏è Real Case:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-sky-600 to-cyan-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            {/* Info Buttons Footer */}
            <div className="p-3 bg-black/30 border-t border-sky-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('business_license')} className="text-xs text-sky-400 hover:text-sky-300">‚ÑπÔ∏è Licenses</button>
               <button onClick={() => setInfoTopic('zoning')} className="text-xs text-sky-400 hover:text-sky-300">‚ÑπÔ∏è Zoning</button>
               <button onClick={() => setInfoTopic('industry_permits')} className="text-xs text-sky-400 hover:text-sky-300">‚ÑπÔ∏è Industry</button>
               <button onClick={() => setInfoTopic('compliance_timeline')} className="text-xs text-sky-400 hover:text-sky-300">‚ÑπÔ∏è Timeline</button>
            </div>
         </div>
      );
   };

   // --- EMPLOYMENT LAW RENDERER ---
   const EmploymentLawRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Nuanced scenarios where "it depends" - context matters
      const scenarios = [
         {
            title: "The Overtime Exemption Trap",
            context: "You're a startup founder. Your 'Senior Marketing Manager' earns $45,000/year salary, has no direct reports, and spends 80% of time executing campaigns you assign. She worked 55 hours last week.",
            question: "Do you owe her overtime pay?",
            opts: [
               'No - she has a manager title and salary',
               'No - she agreed to salary means no overtime',
               'Yes - she fails the duties test for exemption',
               'Yes - but only if she asks for it'
            ],
            correct: 2,
            wrongExplanations: [
               "Title doesn't determine exemption! The FLSA 'duties test' looks at ACTUAL job duties. 'Manager' in title means nothing if she doesn't manage anyone or make independent decisions.",
               "Agreeing to salary doesn't waive overtime rights. You can't contract away FLSA protections. Many employers lose lawsuits because they thought salary = exempt.",
               "", // Correct
               "Overtime is owed regardless of whether she asks. The obligation is on the employer. Not paying is wage theft, and she can claim back pay for 2-3 years plus penalties."
            ],
            realWorld: "A class action against a tech company resulted in $8.5M in back overtime pay for 'Account Managers' who were misclassified as exempt despite having no management duties.",
            concept: "exempt_nonexempt",
            why: "Exemption requires ALL of: (1) Salary basis, (2) Minimum $684/week ($35,568/year), (3) Primary duty is management/professional/administrative with independent judgment. Executing assigned tasks ‚â† exempt, regardless of title or salary."
         },
         {
            title: "The Contractor Classification Gamble",
            context: "You hire a 'freelance developer' who works 40 hrs/week exclusively for you, uses your computer, attends your meetings, and has worked this way for 18 months. You pay them via 1099.",
            question: "What's your legal exposure here?",
            opts: [
               'None - they signed a contractor agreement',
               'Minor - just reclassify them going forward',
               'Major - back taxes, benefits, and penalties for 18 months',
               'None - the IRS only audits big companies'
            ],
            correct: 2,
            wrongExplanations: [
               "Contracts don't override reality. Courts use 'economic reality' and 'right to control' tests. If they walk like an employee and quack like an employee, they're an employee‚Äîregardless of what paper says.",
               "You can't just 'reclassify going forward.' The IRS and state agencies can audit past years. You owe: back employment taxes (employer share), unpaid benefits, overtime if applicable, and penalties.",
               "", // Correct
               "The IRS absolutely audits small companies, especially after worker complaints. California alone collected $6.8B in misclassification penalties in 5 years. One complaint triggers a full audit."
            ],
            realWorld: "Uber and Lyft paid $413M in settlements over driver misclassification. A small business owner in California was personally liable for $340K in back wages, taxes, and penalties for 3 misclassified workers.",
            concept: "worker_classification",
            why: "Classification is based on reality, not paperwork. Key factors: (1) Control over how work is done, (2) Exclusivity, (3) Integration into business, (4) Duration, (5) Tools provided. This worker is clearly an employee. Exposure: 18 months of employment taxes (~15%), benefits, potential overtime, plus penalties."
         },
         {
            title: "The FMLA Surprise",
            context: "Your company has 45 employees. A worker who's been with you 10 months requests 12 weeks unpaid leave for a new baby. You're already short-staffed and can't afford to hold the position.",
            question: "Are you legally required to grant this leave?",
            opts: [
               'Yes - FMLA requires 12 weeks for new parents',
               'No - FMLA only applies to 50+ employee companies',
               'No - employee hasn\'t worked 12 months yet',
               'Yes - but only 6 weeks, not 12'
            ],
            correct: 1,
            wrongExplanations: [
               "FMLA has TWO thresholds most people miss: (1) 50+ employees within 75 miles, AND (2) employee worked 12+ months with 1,250+ hours. You have 45 employees, so FMLA doesn't apply to you at all.",
               "", // Correct
               "This is partially right‚Äîthe employee tenure matters‚Äîbut it's moot here because your company is too small for FMLA anyway. However, STATE laws may still apply (CA, NY, NJ, WA have their own family leave laws).",
               "There's no '6 weeks only' rule in FMLA. It's 12 weeks or nothing. Some states have additional paid leave requirements."
            ],
            realWorld: "A 35-employee company owner thought she was 'safe' from FMLA, then got sued under California's CFRA (which applies to 5+ employees). The employee won $125K in damages.",
            concept: "fmla_thresholds",
            why: "FMLA (federal) = 50+ employees. BUT: Many states have LOWER thresholds. California CFRA = 5+ employees. NY PFL = 1+ employees. Always check STATE law too‚Äîit often provides MORE protection than federal. Even without legal requirement, consider retention‚Äîreplacing employees costs 50-200% of salary."
         },
         {
            title: "The At-Will Exception",
            context: "You fire a sales rep in an at-will state for 'not being a culture fit.' The day before, he had emailed HR complaining that his manager was pressuring the team to falsify sales reports to hit quarterly targets.",
            question: "What's the legal risk of this termination?",
            opts: [
               'None - at-will means fire for any reason',
               'Low - just document the culture fit issues',
               'High - this looks like whistleblower retaliation',
               'Medium - depends on if the complaint was formal'
            ],
            correct: 2,
            wrongExplanations: [
               "At-will has MAJOR exceptions: (1) Discrimination, (2) Retaliation, (3) Public policy violations, (4) Implied contracts. 'Any reason' doesn't mean 'any reason including illegal ones.'",
               "Documenting 'culture fit' after a complaint looks like pretext. Courts look at timing. Termination within 24-48 hours of a complaint is textbook retaliation, regardless of documentation.",
               "", // Correct
               "Formal vs informal complaint doesn't matter for retaliation protection. Reporting illegal activity (fraud) is protected whether it's verbal, email, or formal HR complaint. The email creates a paper trail AGAINST you."
            ],
            realWorld: "A pharma company paid $105M to a sales rep fired 2 weeks after reporting off-label marketing. The 'poor performance' documentation was created AFTER the complaint. Timing was the killer evidence.",
            concept: "retaliation",
            why: "Retaliation claims are the #1 growing category of employment lawsuits. Key factors: (1) Protected activity (reporting illegal conduct, discrimination, safety issues), (2) Adverse action (termination, demotion, bad assignments), (3) Timing. Firing within days of a complaint = presumption of retaliation. The burden shifts to YOU to prove legitimate reason."
         },
         {
            title: "The Salary Discussion Shutdown",
            context: "You overhear two employees comparing salaries in the break room. Your employee handbook prohibits 'discussing compensation with coworkers.' You give them both written warnings for policy violation.",
            question: "What's the legal issue with this action?",
            opts: [
               'None - your handbook, your rules',
               'Minor - just remove the policy going forward',
               'Major - you violated federal labor law (NLRA)',
               'Depends - only illegal if they\'re in a union'
            ],
            correct: 2,
            wrongExplanations: [
               "Handbooks can't override federal law. Policies prohibiting salary discussions violate the National Labor Relations Act‚Äîeven for non-union, private sector employees.",
               "Removing the policy doesn't fix it‚Äîyou already disciplined employees for exercising protected rights. The warnings themselves are 'unfair labor practices' and must be rescinded. Employees can file NLRB complaints.",
               "", // Correct
               "The NLRA Section 7 protects 'concerted activity' for ALL private sector employees, not just union members. This includes discussing wages, benefits, and working conditions. The law applies regardless of union status."
            ],
            realWorld: "The NLRB has issued hundreds of rulings against companies with pay secrecy policies. A restaurant chain had to rescind all discipline, post notices admitting the violation, and pay back wages to affected employees.",
            concept: "nlra_rights",
            why: "NLRA Section 7 protects employees' right to discuss wages and working conditions. Pay secrecy policies are per se illegal for most private employers. Exceptions: Supervisors (true managers), HR with access to payroll data. You cannot discipline employees for salary discussions, even if they signed a policy agreeing not to."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         flsa: {
            title: "FLSA: Wages & Hours",
            content: "Federal minimum wage, overtime (1.5x after 40 hrs), exempt vs non-exempt classification. Exemption requires: salary basis ($684+/week), AND exempt duties (executive/admin/professional). Title doesn't matter‚Äîduties do. Violations = 2-3 years back pay + liquidated damages (2x)."
         },
         classification: {
            title: "Worker Classification",
            content: "Employee vs Contractor based on: control, exclusivity, tools provided, duration, integration. IRS uses 20-factor test. States (especially CA) use stricter 'ABC test.' Misclassification = back taxes + penalties + benefits. Can't contract away employee status."
         },
         fmla: {
            title: "FMLA & State Leave Laws",
            content: "Federal FMLA: 50+ employees, 12 months tenure, 1,250 hours. Provides 12 weeks UNPAID leave. BUT: Many states have lower thresholds and PAID leave. CA/NY/WA/NJ have paid family leave. Always check state law‚Äîit often exceeds federal."
         },
         retaliation: {
            title: "Retaliation Claims",
            content: "Protected activities: discrimination complaints, safety reports, wage claims, whistleblowing. Adverse actions: termination, demotion, schedule changes, bad reviews. Timing is key evidence. Document BEFORE complaints arise. Most expensive employment claims are retaliation."
         },
         nlra: {
            title: "NLRA: Concerted Activity",
            content: "Section 7 protects discussions about wages, benefits, working conditions‚Äîfor ALL private employees, not just unions. Pay secrecy policies are illegal. Can't discipline for salary discussions. Social media complaints about work may also be protected."
         },
         atwill: {
            title: "At-Will Exceptions",
            content: "At-will means no contract for duration. BUT exceptions: (1) Discrimination (protected classes), (2) Retaliation (protected activities), (3) Public policy (refusing illegal acts), (4) Implied contract (handbook promises). 'Any reason' ‚â† 'illegal reasons.'"
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Understood ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'HR Law Expert', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Mostly Compliant', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Lawsuit Risk', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Major Liability', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         exempt_nonexempt: "Overtime Exemption & Duties Test",
         worker_classification: "Employee vs Contractor Classification",
         fmla_thresholds: "FMLA Thresholds & State Leave Laws",
         retaliation: "Retaliation & Protected Activities",
         nlra_rights: "NLRA & Salary Discussion Rights"
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-lime-900 via-green-900 to-slate-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">‚öñÔ∏è Employment Law Minefield</h1>
               <p className="text-lime-300 text-sm">The nuances that trigger lawsuits. Context is everything.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-lime-400">‚ö†Ô∏è Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">$450B+</span> paid annually in employment lawsuits</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">65%</span> of employment lawsuits are won by employees</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">"It depends"</span> is the answer to most employment law questions</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-lime-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 nuanced scenarios</span> where context matters</p>
                  <p>‚Ä¢ Not just <span className="text-yellow-400">"legal vs illegal"</span>‚Äîunderstand WHY</p>
                  <p>‚Ä¢ Learn <span className="text-cyan-400">thresholds and exceptions</span> most employers miss</p>
                  <p>‚Ä¢ See <span className="text-red-400">real lawsuit amounts</span> and outcomes</p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-lime-500/20 px-2 py-1 rounded-full text-lime-300 hover:bg-lime-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(':')[0]}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-lime-600 to-green-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN CHALLENGE
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-lime-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-lime-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-lime-900 via-green-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-lime-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Legal Gaps to Study</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'exempt_nonexempt' ? 'flsa' :
                                                  gap === 'worker_classification' ? 'classification' :
                                                  gap === 'fmla_thresholds' ? 'fmla' :
                                                  gap === 'retaliation' ? 'retaliation' : 'nlra';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-lime-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Employment Law Expert!</h3>
                     <p className="text-sm text-slate-300">You understand the nuances that catch most employers‚Äîexemption tests, classification rules, FMLA thresholds, and retaliation traps.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-lime-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-lime-400 mb-2">üí° Key Legal Principles</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Titles don't determine exemption</span>‚Äîduties do</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Contracts can't override</span> employee status</li>
                     <li>‚Ä¢ <span className="text-yellow-400">State laws often exceed</span> federal protections</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Timing is key evidence</span> in retaliation claims</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-lime-600 to-green-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-lime-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-lime-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // PLAY PHASE
      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-lime-900 via-green-900 to-slate-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-lime-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-lime-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-lime-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-sm">‚öñÔ∏è {s.title}</span>
                  <span className="text-lime-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-lime-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            {/* Scenario */}
            <div className="flex-1 p-3 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-200 leading-relaxed">{s.context}</p>
               </div>

               <p className="text-sm font-bold text-lime-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-lime-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-lime-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {/* Explanation after answer */}
               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} is Wrong:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì The Legal Reality:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                        <p className="text-xs font-bold text-amber-400 mb-1">‚ö†Ô∏è Real Case:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-lime-600 to-green-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            {/* Info Buttons Footer */}
            <div className="p-3 bg-black/30 border-t border-lime-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('flsa')} className="text-xs text-lime-400 hover:text-lime-300">‚ÑπÔ∏è FLSA</button>
               <button onClick={() => setInfoTopic('classification')} className="text-xs text-lime-400 hover:text-lime-300">‚ÑπÔ∏è Classification</button>
               <button onClick={() => setInfoTopic('fmla')} className="text-xs text-lime-400 hover:text-lime-300">‚ÑπÔ∏è FMLA</button>
               <button onClick={() => setInfoTopic('retaliation')} className="text-xs text-lime-400 hover:text-lime-300">‚ÑπÔ∏è Retaliation</button>
            </div>
         </div>
      );
   };

   // --- DIGITAL & TECHNOLOGY RENDERERS ---
   const EcommerceRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [day, setDay] = useState(1);
      const [cash, setCash] = useState(500);
      const [inventory, setInventory] = useState<{[k:string]:number}>({tshirt:10,mug:15,sticker:30});
      const [prices, setPrices] = useState<{[k:string]:number}>({tshirt:25,mug:15,sticker:5});
      const [sales, setSales] = useState<{item:string,qty:number,price:number}[]>([]);
      const [log, setLog] = useState<string[]>([]);
      const products = [{id:'tshirt',name:'T-Shirt',cost:12,icon:'üëï'},{id:'mug',name:'Mug',cost:6,icon:'‚òï'},{id:'sticker',name:'Sticker',cost:1,icon:'üè∑Ô∏è'}];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         pricing:{title:'Pricing Strategy',content:'Set prices based on costs, competition, and perceived value. Too high loses customers, too low loses profit.'},
         inventory:{title:'Inventory Management',content:'Balance stock levels - too much ties up cash, too little means lost sales and unhappy customers.'},
         margins:{title:'Profit Margins',content:'Margin = (Price - Cost) / Price. Higher margins mean more profit per sale but may reduce volume.'},
         conversion:{title:'Conversion Rate',content:'The percentage of visitors who make a purchase. Improve with better UX, pricing, and product presentation.'}
      };
      const simulateDay = () => {
         let daySales:{item:string,qty:number,price:number}[] = [];
         let newInv = {...inventory};
         let revenue = 0;
         products.forEach(p => {
            const demand = Math.max(0, Math.floor((30 - prices[p.id]) / 3) + Math.floor(Math.random() * 3));
            const sold = Math.min(demand, newInv[p.id]);
            if(sold > 0) {
               daySales.push({item:p.id,qty:sold,price:prices[p.id]});
               revenue += sold * prices[p.id];
               newInv[p.id] -= sold;
            }
         });
         setInventory(newInv);
         setCash(c => c + revenue);
         setSales(s => [...s, ...daySales]);
         setLog(l => [...l, `Day ${day}: Earned $${revenue}`]);
         if(day >= 7) setPhase('result');
         else setDay(d => d + 1);
      };
      const restock = (id:string) => {
         const p = products.find(x=>x.id===id)!;
         const qty = 10;
         const cost = qty * p.cost;
         if(cash >= cost) {
            setCash(c => c - cost);
            setInventory(inv => ({...inv, [id]: inv[id] + qty}));
            setLog(l => [...l, `Restocked ${qty} ${p.name}s for $${cost}`]);
         }
      };
      const totalRevenue = sales.reduce((a,s) => a + s.qty * s.price, 0);
      const grade = cash >= 1000 ? 'A' : cash >= 750 ? 'B' : cash >= 500 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white p-6"><div className="text-6xl mb-4">üõí</div><h2 className="text-2xl font-bold mb-2">E-Commerce Simulator</h2><p className="text-slate-300 text-center mb-6 max-w-md">Run your online store for 7 days! Set prices, manage inventory, and maximize profits.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold">Open Store</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? '‚≠ê' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">Week Complete!</h2><div className="text-4xl font-bold text-green-400 mb-2">${cash}</div><p className="text-slate-300 mb-2">Final Cash (Started: $500)</p><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">Revenue: ${totalRevenue} | {sales.reduce((a,s)=>a+s.qty,0)} items sold</p><button onClick={() => {setPhase('intro');setDay(1);setCash(500);setInventory({tshirt:10,mug:15,sticker:30});setSales([]);setLog([]);}} className="px-6 py-2 bg-blue-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-blue-500/30 flex justify-between items-center"><span className="font-bold">üõí E-Commerce</span><span className="text-blue-400">Day {day}/7</span><span className="text-green-400 font-bold">${cash}</span></div><div className="flex-1 p-3 overflow-auto"><div className="grid gap-2">{products.map(p => (<div key={p.id} className="bg-black/30 rounded-lg p-3"><div className="flex justify-between items-center mb-2"><span className="text-xl">{p.icon} {p.name}</span><span className="text-sm text-slate-400">Stock: {inventory[p.id]}</span></div><div className="flex items-center gap-2"><span className="text-xs text-slate-400">Price: $</span><input type="number" value={prices[p.id]} onChange={e => setPrices(pr => ({...pr, [p.id]: Number(e.target.value)}))} className="w-16 bg-slate-700 rounded px-2 py-1 text-sm" min={1} /><button onClick={() => restock(p.id)} className="ml-auto text-xs bg-blue-600/50 px-2 py-1 rounded">+10 (${p.cost * 10})</button></div></div>))}</div></div><div className="p-3 bg-black/30 border-t border-blue-500/30"><button onClick={simulateDay} className="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold">End Day {day}</button><div className="flex gap-2 mt-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-blue-400">‚ÑπÔ∏è {infoTopics[k].title.split(' ')[0]}</button>)}</div></div></div>);
   };

   const SocialMediaRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [followers, setFollowers] = useState(100);
      const [engagement, setEngagement] = useState(5);
      const [week, setWeek] = useState(1);
      const [budget, setBudget] = useState(200);
      const [log, setLog] = useState<string[]>([]);
      const platforms = [{id:'instagram',name:'Instagram',icon:'üì∏',reach:1.2},{id:'twitter',name:'Twitter/X',icon:'üê¶',reach:0.8},{id:'tiktok',name:'TikTok',icon:'üéµ',reach:1.5},{id:'linkedin',name:'LinkedIn',icon:'üíº',reach:0.6}];
      const contentTypes = [{id:'educational',name:'Educational',cost:20,engBoost:2,followBoost:15},{id:'entertaining',name:'Entertaining',cost:15,engBoost:3,followBoost:25},{id:'promotional',name:'Promotional',cost:10,engBoost:-1,followBoost:5},{id:'behindscenes',name:'Behind Scenes',cost:5,engBoost:1,followBoost:10}];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         algorithm:{title:'Algorithm',content:'Social platforms prioritize content with high engagement. More likes, comments, and shares = more visibility.'},
         consistency:{title:'Consistency',content:'Regular posting builds audience expectations and algorithmic favor. Quality over quantity, but maintain presence.'},
         engagement:{title:'Engagement Rate',content:'(Likes + Comments + Shares) / Followers √ó 100. A rate above 3% is considered good.'},
         reach:{title:'Organic Reach',content:'The number of people who see your content without paid promotion. Varies by platform and content type.'}
      };
      const [selectedPlatform, setSelectedPlatform] = useState<string|null>(null);
      const [selectedContent, setSelectedContent] = useState<string|null>(null);
      const postContent = () => {
         if(!selectedPlatform || !selectedContent) return;
         const plat = platforms.find(p => p.id === selectedPlatform)!;
         const cont = contentTypes.find(c => c.id === selectedContent)!;
         if(budget < cont.cost) return;
         setBudget(b => b - cont.cost);
         const newFollowers = Math.floor(cont.followBoost * plat.reach * (1 + Math.random() * 0.5));
         const newEng = Math.max(1, engagement + cont.engBoost + Math.floor(Math.random() * 2 - 1));
         setFollowers(f => f + newFollowers);
         setEngagement(newEng);
         setLog(l => [...l, `Week ${week}: +${newFollowers} followers on ${plat.name}`]);
         setSelectedPlatform(null);
         setSelectedContent(null);
         if(week >= 8) setPhase('result');
         else setWeek(w => w + 1);
      };
      const grade = followers >= 500 ? 'A' : followers >= 300 ? 'B' : followers >= 200 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">üì±</div><h2 className="text-2xl font-bold mb-2">Social Media Strategy</h2><p className="text-slate-300 text-center mb-6 max-w-md">Grow your brand's social presence over 8 weeks! Choose platforms and content types wisely.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-xl font-bold">Start Campaign</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üåü' : grade === 'B' ? 'üìà' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">Campaign Complete!</h2><div className="text-4xl font-bold text-pink-400 mb-2">{followers} Followers</div><p className="text-slate-300 mb-2">Started: 100 | Engagement: {engagement}%</p><div className="text-6xl mb-4">{grade}</div><button onClick={() => {setPhase('intro');setFollowers(100);setEngagement(5);setWeek(1);setBudget(200);setLog([]);}} className="px-6 py-2 bg-pink-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-pink-900 via-purple-900 to-indigo-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-pink-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-pink-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-pink-500/30 flex justify-between items-center"><span className="font-bold">üì± Social Media</span><span className="text-pink-400">Week {week}/8</span><span className="text-green-400">${budget}</span></div><div className="flex-1 p-3 overflow-auto"><div className="bg-black/30 rounded-lg p-3 mb-3 flex justify-around"><div className="text-center"><div className="text-2xl font-bold text-pink-400">{followers}</div><div className="text-xs text-slate-400">Followers</div></div><div className="text-center"><div className="text-2xl font-bold text-purple-400">{engagement}%</div><div className="text-xs text-slate-400">Engagement</div></div></div><p className="text-xs text-slate-400 mb-2">Choose Platform:</p><div className="grid grid-cols-2 gap-2 mb-3">{platforms.map(p => (<button key={p.id} onClick={() => setSelectedPlatform(p.id)} className={`p-2 rounded-lg text-sm ${selectedPlatform === p.id ? 'bg-pink-600' : 'bg-black/30'}`}>{p.icon} {p.name}</button>))}</div><p className="text-xs text-slate-400 mb-2">Choose Content:</p><div className="grid grid-cols-2 gap-2">{contentTypes.map(c => (<button key={c.id} onClick={() => setSelectedContent(c.id)} className={`p-2 rounded-lg text-sm ${selectedContent === c.id ? 'bg-purple-600' : 'bg-black/30'}`}>{c.name} (${c.cost})</button>))}</div></div><div className="p-3 bg-black/30 border-t border-pink-500/30"><button onClick={postContent} disabled={!selectedPlatform || !selectedContent} className="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-xl font-bold disabled:opacity-50">Post Content</button><div className="flex gap-2 mt-2 justify-center">{Object.keys(infoTopics).slice(0,3).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-pink-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div></div>);
   };

   const SEORenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [question, setQuestion] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selected, setSelected] = useState<number|null>(null);
      const [log, setLog] = useState<string[]>([]);
      const questions = [
         {q:'Which is the most important on-page SEO element?',opts:['Meta keywords','Title tag','Footer links','Sidebar widgets'],correct:1,explain:'Title tags are the most important on-page element, appearing in search results and browser tabs.'},
         {q:'What is "keyword stuffing"?',opts:['Using one keyword','Overusing keywords unnaturally','Researching keywords','Hiding keywords'],correct:1,explain:'Keyword stuffing is overusing keywords, which search engines penalize as spam.'},
         {q:'Which improves page load speed?',opts:['More images','Larger fonts','Image compression','More scripts'],correct:2,explain:'Compressing images reduces file size and improves load speed, a ranking factor.'},
         {q:'What does a 301 redirect do?',opts:['Blocks page','Permanent redirect','Temporary redirect','Deletes page'],correct:1,explain:'A 301 is a permanent redirect, passing link equity to the new URL.'},
         {q:'Which backlink is most valuable?',opts:['From unrelated site','From new blog','From authority site in your niche','From social media'],correct:2,explain:'Backlinks from authoritative, relevant sites carry the most SEO weight.'},
         {q:'What is "alt text" used for?',opts:['Styling images','Describing images for SEO/accessibility','Link building','Keywords only'],correct:1,explain:'Alt text describes images for screen readers and helps search engines understand image content.'},
         {q:'Which URL structure is best for SEO?',opts:['example.com/p=123','example.com/blog/seo-tips','example.com/page1','example.com/üî•'],correct:1,explain:'Descriptive, readable URLs with keywords are best for SEO and user experience.'},
         {q:'What is "bounce rate"?',opts:['Email returns','Single-page visits','Crawl errors','Loading time'],correct:1,explain:'Bounce rate is the percentage of visitors who leave after viewing only one page.'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         keywords:{title:'Keywords',content:'Words and phrases people search for. Use them naturally in titles, headings, content, and URLs.'},
         backlinks:{title:'Backlinks',content:'Links from other sites to yours. Quality matters more than quantity - one link from NYTimes beats 100 from spam sites.'},
         technical:{title:'Technical SEO',content:'Site speed, mobile-friendliness, crawlability, and structured data all affect rankings.'},
         content:{title:'Content Quality',content:'Create valuable, original content that answers user questions. Length matters less than depth and usefulness.'}
      };
      const answer = (idx:number) => {
         if(answered) return;
         setSelected(idx);
         setAnswered(true);
         if(idx === questions[question].correct) {
            setScore(s => s + 1);
            setLog(l => [...l, `Q${question+1}: Correct!`]);
         } else {
            setLog(l => [...l, `Q${question+1}: Wrong`]);
         }
      };
      const next = () => {
         if(question >= questions.length - 1) setPhase('result');
         else { setQuestion(q => q + 1); setAnswered(false); setSelected(null); }
      };
      const grade = score >= 7 ? 'A' : score >= 5 ? 'B' : score >= 3 ? 'C' : 'D';
      const q = questions[question];
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-green-900 via-teal-900 to-cyan-900 text-white p-6"><div className="text-6xl mb-4">üîç</div><h2 className="text-2xl font-bold mb-2">SEO Mastery Quiz</h2><p className="text-slate-300 text-center mb-6 max-w-md">Test your Search Engine Optimization knowledge! Learn what makes websites rank higher.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-green-500 to-teal-500 rounded-xl font-bold">Start Quiz</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-green-900 via-teal-900 to-cyan-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? '‚≠ê' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">Quiz Complete!</h2><div className="text-4xl font-bold text-green-400 mb-2">{score}/{questions.length}</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'SEO Expert!' : grade === 'B' ? 'Good understanding!' : 'Keep learning!'}</p><button onClick={() => {setPhase('intro');setQuestion(0);setScore(0);setAnswered(false);setSelected(null);setLog([]);}} className="px-6 py-2 bg-green-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-green-900 via-teal-900 to-cyan-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-green-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-green-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-green-500/30 flex justify-between items-center"><span className="font-bold">üîç SEO Quiz</span><span className="text-green-400">{question + 1}/{questions.length}</span><span className="text-cyan-400">Score: {score}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-lg font-medium">{q.q}</p></div><div className="grid gap-2">{q.opts.map((opt, i) => (<button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left ${answered ? i === q.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30' : 'bg-black/30 hover:bg-black/50'}`}>{opt}</button>))}</div>{answered && (<div className="mt-4 p-3 bg-black/30 rounded-lg"><p className="text-sm text-slate-300">{q.explain}</p><button onClick={next} className="mt-3 w-full py-2 bg-green-600 rounded-lg">{question >= questions.length - 1 ? 'See Results' : 'Next Question'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-green-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-green-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const AnalyticsRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selected, setSelected] = useState<number|null>(null);
      const [log, setLog] = useState<string[]>([]);
      const scenarios = [
         {data:{visitors:5000,conversions:50,bounceRate:65,avgTime:'1:30'},q:'What is the conversion rate?',opts:['0.1%','1%','5%','10%'],correct:1,explain:'Conversion rate = 50/5000 = 1%. This measures how many visitors take desired action.'},
         {data:{visitors:10000,pageViews:35000,sessions:12000,newUsers:8000},q:'What is the pages per session?',opts:['2.9','3.5','1.2','0.8'],correct:0,explain:'Pages/session = 35000/12000 ‚âà 2.9. Shows how engaged users are with your content.'},
         {data:{revenue:50000,adSpend:10000,customers:500,returns:25},q:'What is the ROAS (Return on Ad Spend)?',opts:['2x','5x','10x','50x'],correct:1,explain:'ROAS = $50,000/$10,000 = 5x. For every $1 spent on ads, you got $5 in revenue.'},
         {data:{emailsSent:10000,opened:2500,clicked:500,unsubscribed:100},q:'What is the click-through rate (CTR)?',opts:['2%','5%','20%','25%'],correct:1,explain:'CTR = 500/10000 = 5%. Measures how many recipients clicked a link in the email.'},
         {data:{monthlyUsers:100000,dailyUsers:15000,weeklyUsers:45000,churned:5000},q:'What is the DAU/MAU ratio (stickiness)?',opts:['5%','10%','15%','45%'],correct:2,explain:'DAU/MAU = 15000/100000 = 15%. Higher ratio means users return more frequently.'},
         {data:{cac:50,ltv:200,paybackMonths:6,margin:'40%'},q:'What is the LTV:CAC ratio?',opts:['1:1','2:1','4:1','6:1'],correct:2,explain:'LTV:CAC = $200:$50 = 4:1. Generally, 3:1 or higher indicates healthy unit economics.'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         metrics:{title:'Key Metrics',content:'Focus on metrics that drive decisions: conversion rate, CAC, LTV, churn, engagement. Vanity metrics look good but do not inform action.'},
         funnels:{title:'Funnels',content:'Track user journey stages: Awareness ‚Üí Interest ‚Üí Decision ‚Üí Action. Find where users drop off and optimize.'},
         cohorts:{title:'Cohort Analysis',content:'Group users by sign-up date to compare behavior over time. Shows if product improvements actually help retention.'},
         ab:{title:'A/B Testing',content:'Compare two versions to see which performs better. Need statistical significance before drawing conclusions.'}
      };
      const answer = (idx:number) => {
         if(answered) return;
         setSelected(idx);
         setAnswered(true);
         if(idx === scenarios[scenario].correct) {
            setScore(s => s + 1);
            setLog(l => [...l, `Q${scenario+1}: Correct!`]);
         } else {
            setLog(l => [...l, `Q${scenario+1}: Wrong`]);
         }
      };
      const next = () => {
         if(scenario >= scenarios.length - 1) setPhase('result');
         else { setScenario(s => s + 1); setAnswered(false); setSelected(null); }
      };
      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 2 ? 'C' : 'D';
      const s = scenarios[scenario];
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6"><div className="text-6xl mb-4">üìä</div><h2 className="text-2xl font-bold mb-2">Analytics Dashboard</h2><p className="text-slate-300 text-center mb-6 max-w-md">Interpret real business data! Calculate key metrics and make data-driven decisions.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl font-bold">Start Analysis</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üìà' : grade === 'B' ? '‚≠ê' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">Analysis Complete!</h2><div className="text-4xl font-bold text-orange-400 mb-2">{score}/{scenarios.length}</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Data Analyst!' : grade === 'B' ? 'Good insights!' : 'Keep practicing!'}</p><button onClick={() => {setPhase('intro');setScenario(0);setScore(0);setAnswered(false);setSelected(null);setLog([]);}} className="px-6 py-2 bg-orange-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-orange-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-orange-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-orange-500/30 flex justify-between items-center"><span className="font-bold">üìä Analytics</span><span className="text-orange-400">{scenario + 1}/{scenarios.length}</span><span className="text-amber-400">Score: {score}</span></div><div className="flex-1 p-4 overflow-auto"><div className="bg-black/30 rounded-xl p-3 mb-3"><p className="text-xs text-slate-400 mb-2">Dashboard Data:</p><div className="grid grid-cols-2 gap-2">{Object.entries(s.data).map(([k,v]) => (<div key={k} className="bg-black/30 rounded p-2 text-center"><div className="text-lg font-bold text-orange-400">{v}</div><div className="text-xs text-slate-400 capitalize">{k.replace(/([A-Z])/g, ' $1')}</div></div>))}</div></div><div className="bg-black/30 rounded-xl p-4 mb-3"><p className="font-medium">{s.q}</p></div><div className="grid grid-cols-2 gap-2">{s.opts.map((opt, i) => (<button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg ${answered ? i === s.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30' : 'bg-black/30 hover:bg-black/50'}`}>{opt}</button>))}</div>{answered && (<div className="mt-3 p-3 bg-black/30 rounded-lg"><p className="text-sm text-slate-300">{s.explain}</p><button onClick={next} className="mt-3 w-full py-2 bg-orange-600 rounded-lg">{scenario >= scenarios.length - 1 ? 'See Results' : 'Next'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-orange-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-orange-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const CybersecurityRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selected, setSelected] = useState<string|null>(null);
      const [log, setLog] = useState<string[]>([]);
      const scenarios = [
         {situation:'Email from "IT Support" asking you to click a link to verify your password immediately or your account will be deleted.',threat:'phishing',safe:false,explain:'Classic phishing - urgency, impersonation, and suspicious links. Real IT never asks for passwords via email.'},
         {situation:'A pop-up saying "Your computer is infected! Call this number immediately for Microsoft Support."',threat:'scam',safe:false,explain:'Tech support scam. Microsoft never shows pop-ups with phone numbers. Close the browser and run your own antivirus.'},
         {situation:'Your password manager suggests using "j8#kL9$mN2@pQ" as a password.',threat:'none',safe:true,explain:'Strong password! Long, random, with mixed characters. Password managers generate and store secure passwords.'},
         {situation:'A USB drive labeled "Employee Salaries 2024" is found in the parking lot.',threat:'baiting',safe:false,explain:'Baiting attack. Never plug unknown USB drives into your computer - they may contain malware.'},
         {situation:'Website URL shows "https://yourbank.com" with a green padlock.',threat:'none',safe:true,explain:'HTTPS with correct domain is good. But still verify you navigated there yourself, not from a suspicious link.'},
         {situation:'Coworker asks for your login to "quickly check something" while you are on vacation.',threat:'social_engineering',safe:false,explain:'Social engineering. Never share credentials, even with coworkers. They should request their own access.'},
         {situation:'Email attachment named "Invoice.pdf.exe" from unknown sender.',threat:'malware',safe:false,explain:'Malware! The .exe extension is hidden. Never open executable files from unknown sources.'},
         {situation:'Your company requires 2FA (two-factor authentication) for all accounts.',threat:'none',safe:true,explain:'2FA adds crucial security. Even if password is stolen, attacker cannot access without second factor.'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         phishing:{title:'Phishing',content:'Fraudulent emails/sites impersonating trusted entities. Check sender, hover over links, never give passwords.'},
         malware:{title:'Malware',content:'Malicious software including viruses, ransomware, spyware. Keep software updated, use antivirus, avoid suspicious downloads.'},
         social:{title:'Social Engineering',content:'Manipulating people into giving up confidential info. Attackers exploit trust, authority, and urgency.'},
         passwords:{title:'Password Security',content:'Use unique, long passwords for each account. Enable 2FA. Use a password manager. Never share credentials.'}
      };
      const answer = (safe:boolean) => {
         if(answered) return;
         setSelected(safe ? 'safe' : 'threat');
         setAnswered(true);
         if(safe === scenarios[scenario].safe) {
            setScore(s => s + 1);
            setLog(l => [...l, `Scenario ${scenario+1}: Correct!`]);
         } else {
            setLog(l => [...l, `Scenario ${scenario+1}: Wrong`]);
         }
      };
      const next = () => {
         if(scenario >= scenarios.length - 1) setPhase('result');
         else { setScenario(s => s + 1); setAnswered(false); setSelected(null); }
      };
      const grade = score >= 7 ? 'A' : score >= 5 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 via-red-900 to-slate-900 text-white p-6"><div className="text-6xl mb-4">üîí</div><h2 className="text-2xl font-bold mb-2">Cybersecurity Training</h2><p className="text-slate-300 text-center mb-6 max-w-md">Identify security threats! Learn to spot phishing, malware, and social engineering attacks.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-red-500 to-orange-500 rounded-xl font-bold">Start Training</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 via-red-900 to-slate-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üõ°Ô∏è' : grade === 'B' ? 'üîê' : '‚ö†Ô∏è'}</div><h2 className="text-2xl font-bold mb-2">Training Complete!</h2><div className="text-4xl font-bold text-red-400 mb-2">{score}/{scenarios.length}</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Security Expert!' : grade === 'B' ? 'Good awareness!' : 'Stay vigilant!'}</p><button onClick={() => {setPhase('intro');setScenario(0);setScore(0);setAnswered(false);setSelected(null);setLog([]);}} className="px-6 py-2 bg-red-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-900 via-red-900 to-slate-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-red-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-red-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-red-500/30 flex justify-between items-center"><span className="font-bold">üîí Cybersecurity</span><span className="text-red-400">{scenario + 1}/{scenarios.length}</span><span className="text-orange-400">Score: {score}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-sm text-slate-200">{s.situation}</p></div><p className="text-center text-sm text-slate-400 mb-4">Is this safe or a threat?</p><div className="grid grid-cols-2 gap-3"><button onClick={() => answer(true)} disabled={answered} className={`py-4 rounded-xl font-bold ${answered ? (s.safe ? 'bg-green-600' : selected === 'safe' ? 'bg-red-600' : 'bg-black/30') : 'bg-green-600/50 hover:bg-green-500/50'}`}>‚úì Safe</button><button onClick={() => answer(false)} disabled={answered} className={`py-4 rounded-xl font-bold ${answered ? (!s.safe ? 'bg-green-600' : selected === 'threat' ? 'bg-red-600' : 'bg-black/30') : 'bg-red-600/50 hover:bg-red-500/50'}`}>‚ö†Ô∏è Threat</button></div>{answered && (<div className="mt-4 p-3 bg-black/30 rounded-lg"><p className="text-sm text-slate-300">{s.explain}</p><button onClick={next} className="mt-3 w-full py-2 bg-red-600 rounded-lg">{scenario >= scenarios.length - 1 ? 'See Results' : 'Next'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-red-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-red-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   // --- COMMUNICATION & MARKETING RENDERERS ---
   const ElevatorPitchRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [step, setStep] = useState(0);
      const [choices, setChoices] = useState<number[]>([]);
      const [log, setLog] = useState<string[]>([]);
      const steps = [
         {prompt:'How do you open your pitch?',opts:[{text:'Hi, I sell software...',score:1},{text:'What if you could save 10 hours a week?',score:3},{text:'Our company was founded in 2020...',score:1},{text:'Have you ever struggled with X?',score:2}],tip:'Hook'},
         {prompt:'How do you describe your solution?',opts:[{text:'We use AI and blockchain...',score:1},{text:'We help [target] achieve [result] by [method]',score:3},{text:'Our platform has many features...',score:1},{text:'We are the Uber of X',score:2}],tip:'Value'},
         {prompt:'What makes you different?',opts:[{text:'We are the best in the market',score:1},{text:'Unlike X, we do Y which means Z for you',score:3},{text:'We have great customer service',score:1},{text:'Our team is very experienced',score:2}],tip:'Differentiator'},
         {prompt:'How do you prove credibility?',opts:[{text:'Trust me, it works',score:1},{text:'We have 500 customers saving $1M total',score:3},{text:'We have been in business for years',score:1},{text:'Top investors back us',score:2}],tip:'Proof'},
         {prompt:'What is your call to action?',opts:[{text:'Let me know if interested',score:1},{text:'Can we schedule 15 min this week?',score:3},{text:'Check out our website',score:1},{text:'Here is my card',score:2}],tip:'CTA'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         hook:{title:'The Hook',content:'Start with a question or surprising fact that grabs attention. You have 5 seconds to capture interest.'},
         value:{title:'Value Proposition',content:'Clearly state who you help, what result you deliver, and how. Avoid jargon and buzzwords.'},
         structure:{title:'Pitch Structure',content:'Hook ‚Üí Problem ‚Üí Solution ‚Üí Differentiator ‚Üí Proof ‚Üí Call to Action. Keep it under 60 seconds.'},
         practice:{title:'Practice Tips',content:'Record yourself, time it, get feedback. Great pitches sound natural but are carefully crafted.'}
      };
      const choose = (idx:number) => {
         const newChoices = [...choices, idx];
         setChoices(newChoices);
         setLog(l => [...l, `Step ${step+1}: Option ${idx+1}`]);
         if(step >= steps.length - 1) setPhase('result');
         else setStep(s => s + 1);
      };
      const totalScore = choices.reduce((a, c, i) => a + steps[i].opts[c].score, 0);
      const maxScore = steps.length * 3;
      const grade = totalScore >= 13 ? 'A' : totalScore >= 10 ? 'B' : totalScore >= 7 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6"><div className="text-6xl mb-4">üé§</div><h2 className="text-2xl font-bold mb-2">Elevator Pitch Builder</h2><p className="text-slate-300 text-center mb-6 max-w-md">Craft a compelling 60-second pitch! Choose the best option for each part of your pitch.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-xl font-bold">Build Pitch</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üåü' : grade === 'B' ? 'üëè' : 'üìù'}</div><h2 className="text-2xl font-bold mb-2">Pitch Complete!</h2><div className="text-4xl font-bold text-violet-400 mb-2">{totalScore}/{maxScore}</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Investor-ready pitch!' : grade === 'B' ? 'Strong pitch!' : 'Keep refining!'}</p><button onClick={() => {setPhase('intro');setStep(0);setChoices([]);setLog([]);}} className="px-6 py-2 bg-violet-600 rounded-lg">Try Again</button></div>);
      const s = steps[step];
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-violet-500/30 flex justify-between items-center"><span className="font-bold">üé§ Elevator Pitch</span><span className="text-violet-400">{step + 1}/{steps.length}</span><span className="text-fuchsia-400">{s.tip}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-lg font-medium">{s.prompt}</p></div><div className="grid gap-2">{s.opts.map((opt, i) => (<button key={i} onClick={() => choose(i)} className="p-3 bg-black/30 hover:bg-violet-600/50 rounded-lg text-left text-sm">{opt.text}</button>))}</div></div><div className="p-3 bg-black/30 border-t border-violet-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-violet-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const NetworkingRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [event, setEvent] = useState(0);
      const [connections, setConnections] = useState(0);
      const [quality, setQuality] = useState(0);
      const [energy, setEnergy] = useState(100);
      const [log, setLog] = useState<string[]>([]);
      const events = [
         {person:'Startup Founder',options:[{action:'Ask about their business',conn:1,qual:2,nrg:-10},{action:'Pitch your idea immediately',conn:0,qual:-1,nrg:-15},{action:'Exchange cards silently',conn:1,qual:0,nrg:-5},{action:'Find common interests first',conn:1,qual:3,nrg:-10}]},
         {person:'Potential Investor',options:[{action:'Ask for money right away',conn:0,qual:-2,nrg:-20},{action:'Share your vision briefly',conn:1,qual:2,nrg:-15},{action:'Ask about their portfolio',conn:1,qual:3,nrg:-10},{action:'Ignore, too intimidating',conn:0,qual:0,nrg:-5}]},
         {person:'Industry Expert',options:[{action:'Ask for free advice',conn:1,qual:0,nrg:-10},{action:'Compliment their work genuinely',conn:1,qual:2,nrg:-10},{action:'Offer to help with something',conn:1,qual:3,nrg:-15},{action:'Monologue about yourself',conn:0,qual:-1,nrg:-20}]},
         {person:'Potential Partner',options:[{action:'Propose partnership immediately',conn:0,qual:0,nrg:-15},{action:'Explore synergies casually',conn:1,qual:3,nrg:-10},{action:'Get their contact for later',conn:1,qual:1,nrg:-5},{action:'Compare businesses competitively',conn:0,qual:-1,nrg:-10}]},
         {person:'Fellow Entrepreneur',options:[{action:'Share war stories',conn:1,qual:2,nrg:-10},{action:'One-up their achievements',conn:0,qual:-2,nrg:-15},{action:'Offer genuine support',conn:1,qual:3,nrg:-10},{action:'Keep it surface level',conn:1,qual:0,nrg:-5}]}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         quality:{title:'Quality vs Quantity',content:'10 meaningful connections beat 100 business cards. Focus on building real relationships, not collecting contacts.'},
         followup:{title:'Follow Up',content:'80% of networking value is in the follow-up. Send a personalized message within 24-48 hours.'},
         give:{title:'Give First',content:'Lead with value. Ask "How can I help?" before "What can you do for me?" Build reciprocity.'},
         listen:{title:'Active Listening',content:'Ask open questions, listen more than you talk. People remember how you made them feel.'}
      };
      const choose = (idx:number) => {
         const opt = events[event].options[idx];
         setConnections(c => c + opt.conn);
         setQuality(q => q + opt.qual);
         setEnergy(e => Math.max(0, e + opt.nrg));
         setLog(l => [...l, `${events[event].person}: ${opt.action}`]);
         if(event >= events.length - 1 || energy + opt.nrg <= 0) setPhase('result');
         else setEvent(e => e + 1);
      };
      const score = connections * 10 + quality * 5;
      const grade = score >= 35 ? 'A' : score >= 25 ? 'B' : score >= 15 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white p-6"><div className="text-6xl mb-4">ü§ù</div><h2 className="text-2xl font-bold mb-2">Networking Event</h2><p className="text-slate-300 text-center mb-6 max-w-md">Work the room at a startup mixer! Build quality connections before your energy runs out.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-xl font-bold">Enter Event</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üåü' : grade === 'B' ? 'ü§ù' : 'üìá'}</div><h2 className="text-2xl font-bold mb-2">Event Over!</h2><div className="text-2xl font-bold text-cyan-400 mb-2">{connections} Connections | {quality > 0 ? '+' : ''}{quality} Quality</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Master networker!' : grade === 'B' ? 'Good connections!' : 'Keep practicing!'}</p><button onClick={() => {setPhase('intro');setEvent(0);setConnections(0);setQuality(0);setEnergy(100);setLog([]);}} className="px-6 py-2 bg-cyan-600 rounded-lg">Try Again</button></div>);
      const e = events[event];
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-cyan-900 via-teal-900 to-emerald-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-cyan-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-cyan-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-cyan-500/30"><div className="flex justify-between items-center mb-2"><span className="font-bold">ü§ù Networking</span><span className="text-cyan-400">{event + 1}/{events.length}</span></div><div className="flex gap-4 text-sm"><span>üë• {connections}</span><span>‚≠ê {quality > 0 ? '+' : ''}{quality}</span><span>‚ö° {energy}%</span></div></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4 text-center"><p className="text-2xl mb-2">üë§</p><p className="text-lg font-medium">{e.person}</p></div><div className="grid gap-2">{e.options.map((opt, i) => (<button key={i} onClick={() => choose(i)} className="p-3 bg-black/30 hover:bg-cyan-600/50 rounded-lg text-left text-sm">{opt.action}</button>))}</div></div><div className="p-3 bg-black/30 border-t border-cyan-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-cyan-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const BrandingRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [step, setStep] = useState(0);
      const [brand, setBrand] = useState<{[k:string]:number}>({});
      const [log, setLog] = useState<string[]>([]);
      const steps = [
         {element:'Brand Personality',options:[{text:'Professional & Trustworthy',traits:{trust:3,energy:1}},{text:'Fun & Playful',traits:{trust:1,energy:3}},{text:'Innovative & Bold',traits:{trust:2,energy:2}},{text:'Warm & Caring',traits:{trust:2,energy:2}}]},
         {element:'Color Palette',options:[{text:'Blue & White (Trust)',traits:{trust:3,energy:1}},{text:'Orange & Yellow (Energy)',traits:{trust:1,energy:3}},{text:'Green & Earth (Growth)',traits:{trust:2,energy:2}},{text:'Purple & Gold (Premium)',traits:{trust:2,energy:2}}]},
         {element:'Typography',options:[{text:'Serif (Traditional)',traits:{trust:3,energy:1}},{text:'Sans-serif (Modern)',traits:{trust:2,energy:2}},{text:'Display (Bold)',traits:{trust:1,energy:3}},{text:'Handwritten (Personal)',traits:{trust:1,energy:2}}]},
         {element:'Voice & Tone',options:[{text:'Formal & Authoritative',traits:{trust:3,energy:1}},{text:'Casual & Friendly',traits:{trust:1,energy:3}},{text:'Inspirational & Motivating',traits:{trust:2,energy:3}},{text:'Simple & Clear',traits:{trust:2,energy:2}}]},
         {element:'Visual Style',options:[{text:'Minimalist & Clean',traits:{trust:2,energy:2}},{text:'Vibrant & Colorful',traits:{trust:1,energy:3}},{text:'Classic & Elegant',traits:{trust:3,energy:1}},{text:'Tech & Futuristic',traits:{trust:2,energy:2}}]}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         consistency:{title:'Brand Consistency',content:'Use the same colors, fonts, voice across all touchpoints. Consistency builds recognition and trust.'},
         personality:{title:'Brand Personality',content:'Your brand should feel like a person. Define 3-5 traits that guide all communications.'},
         positioning:{title:'Positioning',content:'Own a unique space in customers minds. What one word should they associate with you?'},
         story:{title:'Brand Story',content:'People connect with stories, not features. Share your why, origin, and mission.'}
      };
      const choose = (idx:number) => {
         const opt = steps[step].options[idx];
         setBrand(b => ({...b, [steps[step].element]: idx, trust: (b.trust || 0) + opt.traits.trust, energy: (b.energy || 0) + opt.traits.energy}));
         setLog(l => [...l, `${steps[step].element}: ${opt.text}`]);
         if(step >= steps.length - 1) setPhase('result');
         else setStep(s => s + 1);
      };
      const trust = brand.trust || 0;
      const energy = brand.energy || 0;
      const archetype = trust > energy ? 'Sage/Caregiver' : energy > trust ? 'Creator/Explorer' : 'Hero/Magician';
      const score = trust + energy;
      const grade = score >= 12 ? 'A' : score >= 9 ? 'B' : score >= 6 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white p-6"><div className="text-6xl mb-4">üé®</div><h2 className="text-2xl font-bold mb-2">Brand Builder</h2><p className="text-slate-300 text-center mb-6 max-w-md">Create your brand identity! Make choices that define your brand personality and visual style.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-rose-500 to-fuchsia-500 rounded-xl font-bold">Start Building</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white p-6"><div className="text-6xl mb-4">üé®</div><h2 className="text-2xl font-bold mb-2">Brand Complete!</h2><div className="text-xl font-bold text-rose-400 mb-2">{archetype} Brand</div><div className="flex gap-4 mb-4"><span className="text-cyan-400">Trust: {trust}</span><span className="text-orange-400">Energy: {energy}</span></div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Cohesive brand!' : grade === 'B' ? 'Strong identity!' : 'Refine your choices!'}</p><button onClick={() => {setPhase('intro');setStep(0);setBrand({});setLog([]);}} className="px-6 py-2 bg-rose-600 rounded-lg">Try Again</button></div>);
      const s = steps[step];
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-rose-900 via-pink-900 to-fuchsia-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-rose-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-rose-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-rose-500/30 flex justify-between items-center"><span className="font-bold">üé® Brand Builder</span><span className="text-rose-400">{step + 1}/{steps.length}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-lg font-medium text-center">{s.element}</p></div><div className="grid gap-2">{s.options.map((opt, i) => (<button key={i} onClick={() => choose(i)} className="p-3 bg-black/30 hover:bg-rose-600/50 rounded-lg text-left text-sm">{opt.text}</button>))}</div></div><div className="p-3 bg-black/30 border-t border-rose-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-rose-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const NegotiationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Anchor Battle",
            context: "You're selling your SaaS company. Your target is $5M. A strategic buyer opens with: 'We're thinking around $2M given market conditions.'",
            question: "What's the best response to this low anchor?",
            opts: [
               'Counter at $8M to split the difference at $5M',
               'Explain why $2M undervalues the company and reanchor at $6.5M with comps',
               'Walk away - the gap is too large',
               'Accept $3M as a compromise to close quickly'
            ],
            correct: 1,
            wrongExplanations: [
               "Anchoring at $8M looks unserious and damages credibility. They'll think you're not negotiating in good faith. Counter-anchors should be aggressive but defensible.",
               "", // Correct
               "Walking away too early loses the deal. The opening offer is just an anchor - it's not their final position. Most acquisitions close 40-60% above opening offers.",
               "Never accept a quick compromise on price. Their $2M anchor worked on you psychologically. You just gave up $2M+ because you felt pressure to 'meet in the middle.'"
            ],
            realWorld: "Instagram was initially offered $500M by Facebook. Systrom countered with specific metrics justifying $1B and got it. The key: data-backed counter-anchors, not arbitrary numbers.",
            concept: "anchoring",
            why: "Counter-anchoring requires: (1) Acknowledge their number without accepting it, (2) Reframe with data/comps that justify your position, (3) Anchor slightly above your target. The first number that gets accepted as 'reasonable' sets the negotiation range."
         },
         {
            title: "The BATNA Bluff",
            context: "A key supplier is raising prices 25%. You've researched alternatives but switching would take 6 months and cost $50K. They know you're their biggest customer (30% of their revenue).",
            question: "How do you leverage your BATNA here?",
            opts: [
               'Bluff that you can switch immediately',
               'Accept the increase - your BATNA is weak',
               'Explain you\'re evaluating alternatives and need 12 months at current prices to transition',
               'Threaten to switch publicly and damage their reputation'
            ],
            correct: 2,
            wrongExplanations: [
               "Bluffing a strong BATNA you don't have is dangerous. If they call your bluff, you lose credibility AND leverage. They may know your switching costs better than you think.",
               "Your BATNA isn't weak - THEIRS is! You're 30% of their revenue. Losing you is catastrophic for them. Don't negotiate against yourself.",
               "", // Correct
               "Threats and reputation damage destroy relationships. You may need this supplier long-term. Even if you win this battle, you'll lose the war."
            ],
            realWorld: "Apple negotiated with Samsung for phone components while simultaneously building in-house alternatives. They never bluffed - they actually created BATNAs, which gave them real leverage.",
            concept: "batna",
            why: "Your BATNA matters, but so does THEIRS. Calculate: What happens to them if you leave? 30% revenue loss is devastating. Frame it as: 'I need time to evaluate, let's phase any increases over 18 months' - you get time, they keep you."
         },
         {
            title: "The Equity Split",
            context: "Your technical cofounder built the MVP (6 months work). You've been doing sales/biz dev (3 months) but have industry connections and brought the initial customer. Time to formalize equity.",
            question: "What's the fairest negotiation approach?",
            opts: [
               '50/50 - cofounders should be equal partners',
               '70/30 favoring technical - they did more work',
               'Dynamic split based on future milestones and vesting',
               '60/40 favoring technical with your equity front-loaded'
            ],
            correct: 2,
            wrongExplanations: [
               "50/50 sounds fair but creates deadlock on decisions. Also ignores that contributions WILL diverge over time. What happens when one person works 80 hours and the other works 20?",
               "Past work matters less than future value. The MVP is done - what drives growth? If your sales/connections are critical for the next 5 years, this split may be backward.",
               "", // Correct
               "Front-loading your equity protects you but signals distrust. Also, 60/40 doesn't account for the startup's evolution. What if technical work becomes less important as you scale?"
            ],
            realWorld: "Many YC startups use vesting + milestone-based adjustments. One founder got additional 5% when they closed Series A, another when product hit 10K users. Aligned incentives to future value creation.",
            concept: "equity_negotiation",
            why: "The best equity negotiations focus on future value, not past work. Use: (1) 4-year vesting with 1-year cliff (everyone), (2) Milestone bonuses for key achievements, (3) Clear role definitions with adjustment mechanisms. Past contributions matter less than who'll drive the next 10 years."
         },
         {
            title: "The Silence Trap",
            context: "You're negotiating a $200K enterprise deal. You've presented your proposal at $180K. The buyer says: 'That's higher than we expected.' Then goes silent, staring at you.",
            question: "What should you do?",
            opts: [
               'Fill the silence: "I can probably do $160K"',
               'Stay silent and maintain eye contact',
               'Explain the value to justify the price',
               'Ask: "What budget did you have in mind?"'
            ],
            correct: 1,
            wrongExplanations: [
               "You just negotiated against yourself! They said nothing about price being a dealbreaker. That silence cost you $20K. Never fill silence with concessions.",
               "", // Correct
               "Explaining value after silence looks defensive. You're justifying a price you already quoted. This signals you expected pushback and had weak conviction in your pricing.",
               "Asking their budget gives away your power. You anchor first, they counter. If you ask their budget now, you've surrendered the anchor and look uncertain."
            ],
            realWorld: "A study found that negotiators who waited just 3 extra seconds before responding got 10-15% better outcomes. The discomfort of silence causes the other party to make concessions.",
            concept: "silence_power",
            why: "Silence is uncomfortable - your brain wants to fill it. But whoever speaks first after an offer typically concedes. After stating your position: STOP TALKING. Count to 10 in your head. Let them break the silence with their response or counter."
         },
         {
            title: "The Win-Win Expansion",
            context: "You're negotiating office lease renewal. Landlord wants 20% rent increase ($4K/month more). Your budget can't handle it, but you need this location.",
            question: "How do you create a win-win?",
            opts: [
               'Negotiate hard on price - it\'s a zero-sum game',
               'Offer a longer lease term in exchange for current rates',
               'Accept the increase but ask for 3 months free rent',
               'Offer to prepay 6 months rent for 10% increase instead of 20%'
            ],
            correct: 3,
            wrongExplanations: [
               "Zero-sum thinking limits outcomes. Landlords have needs beyond just rent: cash flow certainty, avoiding vacancy costs, reducing turnover. Find those interests.",
               "Longer term helps them but still leaves the price gap. You're giving something (flexibility) without solving the core budget issue.",
               "Free rent just delays the problem. In 3 months you still can't afford the increase. You've kicked the can down the road.",
               "" // Correct
            ],
            realWorld: "Airbnb negotiated their early office lease by offering to feature the building in their marketing materials. Cost them nothing, gave landlord valuable exposure. Creative value exchange.",
            concept: "expanding_pie",
            why: "Win-win requires finding what they value that costs you less than what you'd pay otherwise. Prepaying: You pay $36K now vs $48K increase over the year. They get guaranteed cash flow and lower vacancy risk. Both sides gain value their way."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         anchoring: {
            title: "Anchoring Psychology",
            content: "First numbers create cognitive reference points. Studies show anchors influence outcomes even when obviously arbitrary. To counter: (1) Ignore their number verbally, (2) Introduce your own anchor with supporting data, (3) Never 'split the difference' from their anchor."
         },
         batna: {
            title: "BATNA Strategy",
            content: "Best Alternative To Negotiated Agreement determines your walkaway point. Key insight: Their BATNA matters too! A strong BATNA comes from real alternatives, not bluffs. Invest in creating alternatives before negotiating."
         },
         silence: {
            title: "The Power of Silence",
            content: "Silence creates psychological pressure. After making an offer, STOP TALKING. The urge to fill silence leads to unnecessary concessions. Practice: State your position, then count to 10 silently. Let them respond first."
         },
         expanding: {
            title: "Expanding the Pie",
            content: "Most negotiations aren't zero-sum. Before haggling on price, find what they value that costs you less: terms, timing, payment structure, bundled services, case study rights, referrals. Create value before claiming it."
         },
         interests: {
            title: "Interests vs Positions",
            content: "Positions are WHAT people ask for. Interests are WHY they want it. 'I need $100K' is a position. 'I need security and market rate' are interests. Uncover interests to find creative solutions that satisfy both sides."
         },
         preparation: {
            title: "Negotiation Prep",
            content: "Research: their constraints, alternatives, timeline, decision-makers. Know: your BATNA, walkaway point, ideal outcome, first offer. Prepare: opening statement, responses to objections, concession strategy. Never negotiate unprepared."
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Mastered ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'Master Negotiator', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Skilled Negotiator', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Developing', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Needs Practice', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         anchoring: "Counter-Anchoring Techniques",
         batna: "BATNA & Alternative Leverage",
         equity_negotiation: "Equity & Partnership Splits",
         silence_power: "Silence as a Tactic",
         expanding_pie: "Win-Win Value Creation"
      };

      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-blue-900 to-slate-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">ü§ù Negotiation Tactics Lab</h1>
               <p className="text-indigo-300 text-sm">Psychology. Strategy. Leverage. Master the art of the deal.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-indigo-400">‚ö†Ô∏è Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">$1M+</span> left on the table by average entrepreneur over career</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">80%</span> of negotiation outcome determined before you speak</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">Best negotiators</span> create value, not just claim it</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-indigo-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 realistic negotiations</span> with psychological depth</p>
                  <p>‚Ä¢ Learn <span className="text-yellow-400">specific tactics</span> that change outcomes</p>
                  <p>‚Ä¢ Avoid <span className="text-red-400">common traps</span> that cost you money</p>
                  <p>‚Ä¢ Understand <span className="text-cyan-400">why</span> each approach works or fails</p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-indigo-500/20 px-2 py-1 rounded-full text-indigo-300 hover:bg-indigo-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(' ')[0]}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN NEGOTIATIONS
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-indigo-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-indigo-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-blue-900 to-slate-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-indigo-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Tactics to Study</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'anchoring' ? 'anchoring' :
                                                  gap === 'batna' ? 'batna' :
                                                  gap === 'silence_power' ? 'silence' :
                                                  gap === 'expanding_pie' ? 'expanding' : 'interests';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-indigo-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Master Negotiator!</h3>
                     <p className="text-sm text-slate-300">You understand the psychology of negotiation‚Äîanchoring, BATNA leverage, silence, and value creation.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-indigo-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-indigo-400 mb-2">üí° Key Tactics</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Counter-anchor with data</span>, not arbitrary numbers</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Their BATNA matters</span> as much as yours</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Silence is power</span>‚Äînever fill it with concessions</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Expand the pie</span> before dividing it</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-indigo-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-indigo-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-blue-900 to-slate-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-indigo-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-indigo-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-indigo-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-sm">ü§ù {s.title}</span>
                  <span className="text-indigo-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-indigo-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            <div className="flex-1 p-3 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-200 leading-relaxed">{s.context}</p>
               </div>

               <p className="text-sm font-bold text-indigo-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-indigo-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-indigo-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} Fails:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì The Winning Move:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-cyan-900/30 border border-cyan-500/50 rounded-lg">
                        <p className="text-xs font-bold text-cyan-400 mb-1">üì∞ Real World:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-indigo-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('anchoring')} className="text-xs text-indigo-400 hover:text-indigo-300">‚ÑπÔ∏è Anchoring</button>
               <button onClick={() => setInfoTopic('batna')} className="text-xs text-indigo-400 hover:text-indigo-300">‚ÑπÔ∏è BATNA</button>
               <button onClick={() => setInfoTopic('silence')} className="text-xs text-indigo-400 hover:text-indigo-300">‚ÑπÔ∏è Silence</button>
               <button onClick={() => setInfoTopic('expanding')} className="text-xs text-indigo-400 hover:text-indigo-300">‚ÑπÔ∏è Win-Win</button>
            </div>
         </div>
      );
   };

   // --- FINANCE & FUNDING RENDERERS ---
   const FundraisingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Fundraising Psychology Lab - Understanding investor thinking, term sheet traps, and founder mistakes
      const scenarios = [
         {
            title: "The Valuation Trap",
            context: "You're raising your seed round. Two VCs make offers: VC A offers $1.5M at $15M valuation (10% dilution). VC B offers $2M at $8M valuation (25% dilution). VC B has better network, more experience with your space, and offers hands-on help.",
            question: "Which offer is actually BETTER for your startup's success?",
            opts: [
               'VC A - higher valuation protects your ownership',
               'VC B - more money and better support despite higher dilution',
               'Neither - both valuations are bad, keep negotiating',
               'VC A - take the money and find advisors separately'
            ],
            correct: 1,
            wrongExplanations: [
               "Higher valuation at seed creates a 'valuation trap.' You need to grow into it or take a down round later. Many unicorn founders took LOW seed valuations from the RIGHT investors. Ownership matters less than company success.",
               "", // Correct
               "At seed stage, these are reasonable offers. Endless negotiation burns relationships and time. Investors talk to each other - being difficult early can hurt your reputation.",
               "Advisors aren't the same as investors. VC B is invested in your success with capital AND time. Separate advisors have divided attention and no skin in the game."
            ],
            realWorld: "Airbnb's seed round was at ~$2.5M valuation - tiny! But Sequoia's involvement helped them become a $100B company. Brian Chesky owns less than 15% but that stake is worth billions. Would he trade Sequoia for higher seed valuation? Never.",
            concept: "valuation_psychology",
            why: "Ownership percentage is vanity; absolute value is sanity. 10% of a $100M company > 25% of a $10M company. Great investors add 10x+ value through intros, advice, follow-on funding, and credibility. The 'best' valuation often comes from investors who add the least value."
         },
         {
            title: "The Hot Market Mistake",
            context: "The market is hot. Three VCs are competing for your deal. You're tempted to run a full auction process - playing them against each other, using FOMO, and maximizing valuation. Your advisor says 'strike while the iron is hot.'",
            question: "What's the HIDDEN RISK of running an aggressive auction?",
            opts: [
               'VCs will band together and refuse to invest',
               'You might get a high valuation you can\'t grow into',
               'The process takes too long and the market cools',
               'All of the above - but reputation damage is worst'
            ],
            correct: 3,
            wrongExplanations: [
               "VCs rarely 'band together' - they're too competitive. But they DO share notes and remember founders who acted badly. One fund passing doesn't stop others from investing.",
               "Valuation is ONE risk. But it's predictable and manageable. The reputation damage from aggressive tactics follows you for decades.",
               "Timing is ONE risk. But good companies can still raise when markets cool. What you can't recover is trust.",
               "" // Correct
            ],
            realWorld: "WeWork's Adam Neumann maximized valuations through aggressive tactics. When he needed support, VCs felt burned and let him fall. Compare to Patrick Collison (Stripe) who deliberately took lower valuations from investors who added value. When Stripe needed help, investors went to bat for them.",
            concept: "investor_relationships",
            why: "Fundraising isn't a one-time transaction - it's the start of a 10+ year relationship. You'll need these investors for follow-on rounds, bridge loans, introductions, and support during crises. A founder known for playing games will find doors closed when they need them most. Reputation > Valuation."
         },
         {
            title: "The Term Sheet Trap",
            context: "A VC offers $3M at $12M pre-money valuation. Sounds great! But buried in the term sheet: 2x participating preferred, full ratchet anti-dilution, 3 board seats (you have 2), and blocking rights on all major decisions. Your lawyer flags these as 'aggressive but not unusual.'",
            question: "What's the REAL impact of these terms?",
            opts: [
               'Minor details - valuation is what matters',
               'You\'ll likely get fired from your own company',
               'In an exit, investors get paid before you, possibly leaving you with nothing',
               'Both B and C - these terms transfer control and economics'
            ],
            correct: 3,
            wrongExplanations: [
               "These are NOT minor details. 2x participating preferred means in a $30M exit, investors take $6M first AND their pro-rata share. You might get pennies. Valuation is just the headline; terms are the substance.",
               "Getting fired is ONE risk. Board control enables this. But even if you stay, the economic terms can wipe out your stake.",
               "Getting nothing in exit is ONE risk. But losing control of decision-making means they can FORCE a bad exit or block a good one.",
               "" // Correct
            ],
            realWorld: "Plenty of founders had 'unicorn exits' and made nothing because of liquidation preferences. In the dot-com bust, founders with 2x+ preferences often got $0 while investors recovered their money. Groupon's founders made less than early employees due to term sheet structures.",
            concept: "term_sheet_mechanics",
            why: "Liquidation preferences determine who gets paid first. Participating preferred means they get their preference AND their share. Full ratchet anti-dilution can crush you in a down round. Board control means they can replace you. Together, these terms mean you're an employee with stock options, not an owner. Always negotiate terms, not just price."
         },
         {
            title: "The Timing Paradox",
            context: "Your SaaS startup has $50K MRR, growing 15% month-over-month. You have 18 months of runway. Your co-founder says 'Let's raise now while we're growing!' Your advisor says 'Wait until you hit $100K MRR - better valuation.' You're seeing other startups raise in your space.",
            question: "What's the STRATEGICALLY CORRECT timing decision?",
            opts: [
               'Raise now - 18 months isn\'t much runway',
               'Wait for $100K MRR milestone',
               'Start fundraising process now, close in 3-4 months when metrics are stronger',
               'Wait and see if market conditions stay favorable'
            ],
            correct: 2,
            wrongExplanations: [
               "18 months is actually good runway. Raising now means fundraising from a weaker position. You'd be optimizing for speed over outcome quality.",
               "Waiting for a specific milestone is rigid thinking. What if growth slows? What if a competitor raises? What if the market turns? Milestones don't guarantee anything.",
               "", // Correct
               "Waiting passively is never strategic. Markets change, competitors move, and opportunities close. Proactive > Reactive."
            ],
            realWorld: "Instagram started fundraising conversations with Sequoia months before they were 'ready.' By the time they hit inflection, the relationship was warm and they raised in days. Cold outreach at $100K MRR takes months. Warm outreach at $50K MRR with relationship building often closes faster and better.",
            concept: "fundraising_timing",
            why: "Fundraising takes 3-6 months. Start when you have 12+ months runway so you're not desperate. Begin relationship-building BEFORE you need money. The best time to raise is when you don't need to - that's when you have leverage. Starting now and closing later gives you optionality without desperation."
         },
         {
            title: "The Investor Pass Psychology",
            context: "You've pitched 20 VCs. 15 passed. 3 want 'to see more progress.' 2 are interested but moving slowly. You're frustrated and questioning everything. A friend says 'If no one's investing, maybe your idea is bad.'",
            question: "How should you INTERPRET these results?",
            opts: [
               'The market is telling you something - pivot or quit',
               'This is normal - most successful companies got many rejections first',
               'Your pitch needs work - hire a pitch coach',
               'VCs are pattern-matching wrong - you need different investors'
            ],
            correct: 1,
            wrongExplanations: [
               "20 meetings with 2 interested is actually not bad for early-stage. Many legendary companies were rejected 50+ times. VC passes tell you about VC patterns, not about your company's potential.",
               "", // Correct
               "Pitch mechanics are rarely the issue. Most rejections are about pattern matching, thesis fit, or timing. A slightly better pitch won't change a VC's thesis.",
               "Blaming VCs is a coping mechanism, not a strategy. The real insight is understanding WHY they're passing and whether it's addressable or thesis-driven."
            ],
            realWorld: "Airbnb was rejected by 7 prominent VCs who are now embarrassed about it. WhatsApp was rejected by Facebook (who later bought them for $19B). Zoom was passed on by many VCs who invested in competitors. VC rejection ‚â† Startup quality. 2/20 interested is a fundable conversion rate.",
            concept: "rejection_interpretation",
            why: "VCs pass for many reasons: wrong thesis, portfolio conflict, partner dynamics, or simply missing the vision. ~5-10% conversion rate (meetings to term sheets) is normal for good companies. The key is finding the 1-2 investors who GET IT, not convincing the masses. 2 interested investors out of 20 meetings means you're on track."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         valuation_psychology: "Valuation vs Value-Add Trade-offs",
         investor_relationships: "Long-term Investor Relationship Management",
         term_sheet_mechanics: "Term Sheet Structure & Economics",
         fundraising_timing: "Strategic Fundraising Timing",
         rejection_interpretation: "Understanding VC Decision-Making"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         stages: {
            title: "Funding Stages",
            content: "Pre-seed ($100K-$500K): Idea/prototype. Seed ($500K-$3M): Early traction. Series A ($5M-$15M): Product-market fit, repeatable sales. Series B ($15M-$50M): Scaling proven model. Series C+ ($50M+): Market expansion. Each stage has different investors, metrics, and expectations. Don't raise the wrong stage."
         },
         dilution: {
            title: "Dilution Math",
            content: "Each round typically dilutes 15-25%. After 3 rounds: Founders often own 30-40%. After 5 rounds + options pool: Founders might own 15-25%. This is NORMAL for venture-scale companies. The goal isn't maximizing ownership - it's maximizing absolute value. 10% of $10B > 80% of $10M."
         },
         terms: {
            title: "Critical Term Sheet Terms",
            content: "1) Liquidation preference: 1x non-participating is founder-friendly. 2) Anti-dilution: Weighted average is standard, full ratchet is predatory. 3) Board composition: Keep founder control through Series A at minimum. 4) Protective provisions: Limit what requires investor approval. 5) Pro-rata rights: Standard, helps good investors follow on."
         },
         psychology: {
            title: "Investor Psychology",
            content: "VCs invest in patterns: Right team, right market, right timing. They're optimizing for home runs, not singles. A 'no' often means 'not pattern match' not 'bad company.' VCs have thesis constraints, partner dynamics, and portfolio considerations you can't see. Don't take rejection personally - find investors whose thesis matches your company."
         }
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Correct! Understood ${conceptLabels[s.concept]}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó ${s.title}: Missed. The trap was "${s.opts[idx]}"`]);
            if (!conceptGaps.includes(s.concept)) {
               setConceptGaps(prev => [...prev, s.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setAnswered(false);
            setSelected(null);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-green-900 to-teal-900 text-white p-6">
               <div className="text-6xl mb-4">üí∞</div>
               <h2 className="text-2xl font-bold mb-2">Investor Psychology Lab</h2>
               <p className="text-slate-300 text-center mb-4 max-w-md">
                  Master the psychology of fundraising - what investors really think and the traps founders fall into.
               </p>
               <div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm">
                  <p className="text-emerald-400 font-bold mb-2">‚ö†Ô∏è Common Founder Mistakes:</p>
                  <ul className="text-slate-300 space-y-1 text-xs">
                     <li>‚Ä¢ Optimizing for valuation over value-add</li>
                     <li>‚Ä¢ Ignoring term sheet details that cost millions</li>
                     <li>‚Ä¢ Misreading investor signals and timing</li>
                     <li>‚Ä¢ Taking rejection personally instead of strategically</li>
                  </ul>
               </div>
               <button
                  onClick={() => setPhase('play')}
                  className="px-8 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl font-bold hover:from-emerald-400 hover:to-teal-400 transition-all"
               >
                  Enter the Fundraising Arena
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-green-900 to-teal-900 text-white p-6 overflow-auto">
               <div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üí∞' : grade === 'C' ? 'üìä' : 'üìö'}</div>
               <h2 className="text-2xl font-bold mb-2">Fundraising Assessment Complete</h2>
               <div className="text-4xl font-bold text-emerald-400 mb-2">{score}/{scenarios.length}</div>
               <div className="text-5xl mb-4">{grade}</div>
               <p className="text-slate-400 mb-4 text-center">
                  {grade === 'A' ? 'Fundraising sophisticate! You think like a seasoned founder.' :
                   grade === 'B' ? 'Good fundraising instincts. Some blind spots to address.' :
                   grade === 'C' ? 'Common founder mistakes detected. Study before raising.' :
                   'Many costly misconceptions. Essential to study before fundraising.'}
               </p>

               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4">
                     <p className="text-emerald-400 font-bold text-sm mb-2">üìö Concepts to Study:</p>
                     <ul className="text-slate-300 text-xs space-y-1">
                        {conceptGaps.map(gap => (
                           <li key={gap}>‚Ä¢ {conceptLabels[gap]}</li>
                        ))}
                     </ul>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">
                  <p className="text-emerald-400 font-bold text-sm mb-2">Session Log:</p>
                  {gameLog.map((entry, i) => (
                     <p key={i} className="text-xs text-slate-300">{entry}</p>
                  ))}
               </div>

               <button
                  onClick={() => {
                     setPhase('intro');
                     setScenario(0);
                     setScore(0);
                     setAnswered(false);
                     setSelected(null);
                     setGameLog([]);
                     setConceptGaps([]);
                  }}
                  className="px-6 py-2 bg-emerald-600 rounded-lg hover:bg-emerald-500"
               >
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-green-900 to-teal-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-emerald-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-emerald-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-emerald-500/30 flex justify-between items-center">
               <span className="font-bold">üí∞ Investor Psychology</span>
               <span className="text-emerald-400">{scenario + 1}/{scenarios.length}</span>
               <span className="text-teal-400">Score: {score}</span>
            </div>

            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-xl p-3 mb-3">
                  <p className="font-bold text-emerald-400 mb-2">{s.title}</p>
                  <p className="text-sm text-slate-300">{s.context}</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-3">
                  <p className="font-medium text-white">{s.question}</p>
               </div>

               <div className="grid gap-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600'
                                 : i === selected
                                    ? 'bg-red-600'
                                    : 'bg-black/30'
                              : 'bg-black/30 hover:bg-emerald-600/50'
                        }`}
                     >
                        {opt}
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-3">
                     {selected !== s.correct && s.wrongExplanations[selected!] && (
                        <div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30">
                           <p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Was Wrong:</p>
                           <p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30">
                        <p className="text-xs text-green-300 font-bold mb-1">‚úì Strategic Insight:</p>
                        <p className="text-sm text-green-100">{s.why}</p>
                     </div>
                     <div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30">
                        <p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p>
                        <p className="text-sm text-blue-100">{s.realWorld}</p>
                     </div>
                     <button
                        onClick={next}
                        className="w-full py-2 bg-emerald-600 rounded-lg hover:bg-emerald-500"
                     >
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-emerald-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button
                     key={k}
                     onClick={() => { setInfoTopic(k); setShowInfo(true); }}
                     className="text-xs text-emerald-400 hover:text-emerald-300"
                  >
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // ============================================================================
   // ACCOUNTING EQUATION INTERACTIVE SIMULATION
   // Assets = Liabilities + Equity - The Foundation of All Accounting
   // ============================================================================
   const AccountingEquationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [showTutorial, setShowTutorial] = useState(false);

      // Financial state
      const [assets, setAssets] = useState({
         cash: 30000,
         accountsReceivable: 10000,
         inventory: 5000,
         equipment: 5000
      });
      const [liabilities, setLiabilities] = useState({
         accountsPayable: 8000,
         loansPayable: 12000
      });
      const [equity, setEquity] = useState({
         ownerCapital: 25000,
         retainedEarnings: 5000
      });

      // Game state
      const [transactionHistory, setTransactionHistory] = useState<{id: number; name: string; description: string; balanceAfter: boolean}[]>([]);
      const [currentTransaction, setCurrentTransaction] = useState<number | null>(null);
      const [showTransactionResult, setShowTransactionResult] = useState(false);
      const [lastTransactionEffect, setLastTransactionEffect] = useState<string>('');
      const [guidanceMessage, setGuidanceMessage] = useState<string>('');
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [challengeMode, setChallengeMode] = useState(false);
      const [challengeCompleted, setChallengeCompleted] = useState(false);

      // Calculate totals
      const totalAssets = Object.values(assets).reduce((a, b) => a + b, 0);
      const totalLiabilities = Object.values(liabilities).reduce((a, b) => a + b, 0);
      const totalEquity = Object.values(equity).reduce((a, b) => a + b, 0);
      const isBalanced = totalAssets === (totalLiabilities + totalEquity);

      // Transaction definitions
      const transactions = [
         {
            id: 1,
            name: 'üì¶ Buy Equipment with Cash',
            shortName: 'Buy Equipment',
            description: 'Purchase $5,000 of equipment using cash',
            icon: 'üì¶',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash - 5000, equipment: prev.equipment + 5000 }));
               return 'Swapped cash (one asset) for equipment (another asset). Total assets unchanged!';
            },
            explanation: 'This is an asset-for-asset exchange. Cash decreased by $5,000, Equipment increased by $5,000. The equation stays balanced because total assets remain the same.',
            category: 'asset_exchange'
         },
         {
            id: 2,
            name: 'üí∞ Take a Bank Loan',
            shortName: 'Take Loan',
            description: 'Borrow $10,000 from the bank',
            icon: 'üí∞',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash + 10000 }));
               setLiabilities(prev => ({ ...prev, loansPayable: prev.loansPayable + 10000 }));
               return 'Got cash but now owe the bank. Both sides increased equally!';
            },
            explanation: 'Taking a loan increases assets (cash) AND liabilities (loan payable) by the same amount. The equation stays balanced.',
            category: 'both_sides'
         },
         {
            id: 3,
            name: 'üë§ Owner Invests Cash',
            shortName: 'Owner Invests',
            description: 'Owner puts in $8,000 of personal money',
            icon: 'üë§',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash + 8000 }));
               setEquity(prev => ({ ...prev, ownerCapital: prev.ownerCapital + 8000 }));
               return "Owner's investment increases both cash and equity. Still balanced!";
            },
            explanation: "When an owner invests, assets (cash) increase AND equity (owner's capital) increases by the same amount. The owner now has more stake in the business.",
            category: 'equity_increase'
         },
         {
            id: 4,
            name: 'üíµ Make a Sale for Cash',
            shortName: 'Make Sale',
            description: 'Sell products worth $3,000 for cash',
            icon: 'üíµ',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash + 3000, inventory: Math.max(0, prev.inventory - 1500) }));
               setEquity(prev => ({ ...prev, retainedEarnings: prev.retainedEarnings + 1500 }));
               return 'Revenue increases equity through retained earnings. Profit stays in the business!';
            },
            explanation: 'A profitable sale: Cash increases by $3,000, Inventory decreases by $1,500 (cost of goods sold), and Retained Earnings increases by $1,500 (the profit). Assets net up $1,500, Equity up $1,500.',
            category: 'revenue'
         },
         {
            id: 5,
            name: 'üìù Pay a Bill',
            shortName: 'Pay Bill',
            description: 'Pay $4,000 of accounts payable',
            icon: 'üìù',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash - 4000 }));
               setLiabilities(prev => ({ ...prev, accountsPayable: Math.max(0, prev.accountsPayable - 4000) }));
               return 'Paid off debt. Both cash and what you owe decreased equally!';
            },
            explanation: 'Paying a bill decreases both assets (cash) AND liabilities (accounts payable) by the same amount. You have less cash, but you also owe less.',
            category: 'liability_decrease'
         },
         {
            id: 6,
            name: 'üì§ Pay Owner Dividend',
            shortName: 'Pay Dividend',
            description: 'Distribute $2,000 to the owner',
            icon: 'üì§',
            effect: () => {
               setAssets(prev => ({ ...prev, cash: prev.cash - 2000 }));
               setEquity(prev => ({ ...prev, retainedEarnings: prev.retainedEarnings - 2000 }));
               return 'Cash left the business, reducing both assets and equity!';
            },
            explanation: 'Dividends reduce both cash (asset) and retained earnings (equity). The owner gets cash, but their stake in the business decreases.',
            category: 'equity_decrease'
         }
      ];

      // Info topics for the ‚ÑπÔ∏è buttons
      const infoTopics: Record<string, { title: string; content: string; example: string }> = {
         assets: {
            title: 'What Are Assets?',
            content: 'Assets are things the business OWNS that have value. They can be physical (cash, equipment, inventory) or non-physical (patents, receivables).',
            example: 'If you have $10,000 cash, a $5,000 computer, and customers owe you $3,000, your total assets are $18,000.'
         },
         liabilities: {
            title: 'What Are Liabilities?',
            content: 'Liabilities are what the business OWES to others. These are obligations that must be paid in the future.',
            example: 'If you owe the bank $10,000 on a loan and have $2,000 in unpaid bills, your total liabilities are $12,000.'
         },
         equity: {
            title: "What Is Owner's Equity?",
            content: "Equity is what's LEFT for the owners after paying all debts. It's also called net worth or book value. Equity = Assets - Liabilities.",
            example: 'If you have $50,000 in assets and $20,000 in liabilities, your equity is $30,000. This is what the owner truly "owns."'
         },
         equation: {
            title: 'Why Does It Always Balance?',
            content: 'Every transaction affects at least two accounts. This is called "double-entry" bookkeeping. Either both sides change equally, or items within one side swap.',
            example: 'Buy equipment with cash: Cash ‚Üì $5K, Equipment ‚Üë $5K. Total assets unchanged. Take a loan: Cash ‚Üë $10K, Loans ‚Üë $10K. Both sides up equally.'
         },
         doubleEntry: {
            title: 'Double-Entry Explained',
            content: 'Every business transaction has two effects that keep the equation balanced. This 500-year-old system is how all businesses track money.',
            example: 'When you buy inventory on credit: Inventory (asset) ‚Üë AND Accounts Payable (liability) ‚Üë by the same amount.'
         },
         balanceSheet: {
            title: 'The Balance Sheet Connection',
            content: 'The accounting equation IS the balance sheet. Assets are listed on one side, Liabilities and Equity on the other. They always equal.',
            example: "Apple's 2023 Balance Sheet: $352B Assets = $290B Liabilities + $62B Equity. It balances!"
         }
      };

      // Handle transaction execution
      const executeTransaction = (transactionId: number) => {
         const transaction = transactions.find(t => t.id === transactionId);
         if (!transaction) return;

         // Store pre-transaction state for logging
         const preTotal = totalAssets;

         // Execute the transaction effect
         const resultMessage = transaction.effect();
         setLastTransactionEffect(resultMessage);
         setCurrentTransaction(transactionId);
         setShowTransactionResult(true);

         // Add to history
         setTransactionHistory(prev => [...prev, {
            id: transactionId,
            name: transaction.shortName,
            description: transaction.description,
            balanceAfter: true // Will always be true in valid transactions
         }]);

         // Add to game log for AI coach
         setGameLog(prev => [...prev,
            `[Transaction] ${transaction.name}`,
            `[Effect] ${resultMessage}`,
            `[Balance] Assets: $${preTotal.toLocaleString()} ‚Üí $${totalAssets.toLocaleString()}`
         ]);

         // Set guidance message based on transaction type
         const guidanceMessages: Record<string, string> = {
            'asset_exchange': "Great! You swapped one asset for another. Notice how total assets stayed the same‚Äîthe equation still balances!",
            'both_sides': "Perfect! Both sides of the equation increased equally. This is the magic of double-entry: equal changes keep balance.",
            'equity_increase': "Owner investment increases both assets AND equity. The business has more resources, and the owner has a bigger stake.",
            'revenue': "Revenue flows to Retained Earnings (part of Equity). This is how businesses build value over time!",
            'liability_decrease': "Paying off debt reduces both what you have (cash) and what you owe. Notice both decreased equally!",
            'equity_decrease': "Dividends reduce both assets and equity. Cash leaves the business and so does part of the owner's stake."
         };
         setGuidanceMessage(guidanceMessages[transaction.category] || '');

         // Check challenge completion
         if (challengeMode && transactionHistory.length >= 3) {
            setChallengeCompleted(true);
         }
      };

      // Reset state
      const resetSimulation = () => {
         setAssets({ cash: 30000, accountsReceivable: 10000, inventory: 5000, equipment: 5000 });
         setLiabilities({ accountsPayable: 8000, loansPayable: 12000 });
         setEquity({ ownerCapital: 25000, retainedEarnings: 5000 });
         setTransactionHistory([]);
         setCurrentTransaction(null);
         setShowTransactionResult(false);
         setLastTransactionEffect('');
         setGuidanceMessage('');
         setChallengeMode(false);
         setChallengeCompleted(false);
      };

      const startGame = () => {
         resetSimulation();
         setPhase('play');
         setGuidanceMessage("Welcome! This business has $50,000 in assets. Click a transaction to see how it affects the equation.");
         setGameLog(['[Session Started] Accounting Equation Simulation', `[Initial State] Assets: $50,000 | Liabilities: $20,000 | Equity: $30,000`]);
      };

      const finishSession = () => {
         setGameLog(prev => [...prev,
            `[Session Complete] ${transactionHistory.length} transactions performed`,
            `[Final State] Assets: $${totalAssets.toLocaleString()} | Liabilities: $${totalLiabilities.toLocaleString()} | Equity: $${totalEquity.toLocaleString()}`,
            `[Balanced: ${isBalanced ? 'YES' : 'NO'}]`
         ]);
         setPhase('result');
      };

      // INTRO PHASE
      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white overflow-hidden">
            {/* Tutorial Modal */}
            {showTutorial && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setShowTutorial(false)}>
                  <div className="bg-slate-800 rounded-2xl p-6 max-w-md max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                     <h3 className="text-xl font-bold text-emerald-400 mb-4">üìñ Quick Tutorial</h3>
                     <div className="space-y-4 text-sm">
                        <div className="bg-black/30 rounded-lg p-3">
                           <p className="font-bold text-teal-300 mb-1">1. The Balance Scale</p>
                           <p className="text-slate-300">Assets must ALWAYS equal Liabilities + Equity. Think of it like a scale that must stay level.</p>
                        </div>
                        <div className="bg-black/30 rounded-lg p-3">
                           <p className="font-bold text-teal-300 mb-1">2. Click Transactions</p>
                           <p className="text-slate-300">Click any transaction button to apply it. Watch how the numbers change on both sides.</p>
                        </div>
                        <div className="bg-black/30 rounded-lg p-3">
                           <p className="font-bold text-teal-300 mb-1">3. Learn the Pattern</p>
                           <p className="text-slate-300">Every transaction affects TWO things. This is "double-entry" bookkeeping‚Äîit's why the equation always balances!</p>
                        </div>
                        <div className="bg-black/30 rounded-lg p-3">
                           <p className="font-bold text-teal-300 mb-1">4. ‚ÑπÔ∏è Info Buttons</p>
                           <p className="text-slate-300">Click the ‚ÑπÔ∏è icons anytime to learn more about assets, liabilities, equity, and how they work.</p>
                        </div>
                     </div>
                     <button onClick={() => setShowTutorial(false)} className="mt-4 w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold transition-all">
                        Got It! üëç
                     </button>
                  </div>
               </div>
            )}

            <div className="flex-1 p-6 overflow-y-auto">
               {/* Header */}
               <div className="text-center mb-6">
                  <div className="text-5xl mb-3">‚öñÔ∏è</div>
                  <h1 className="text-2xl font-black mb-2">THE ACCOUNTING EQUATION</h1>
                  <p className="text-3xl font-bold text-emerald-400">Assets = Liabilities + Equity</p>
               </div>

               {/* Simple Explanation */}
               <div className="bg-black/30 rounded-2xl p-5 mb-6 border border-emerald-500/30">
                  <p className="text-lg text-center leading-relaxed">
                     Everything a business <span className="text-emerald-400 font-bold">OWNS</span> must be funded by
                     either <span className="text-amber-400 font-bold">DEBT</span> (money owed to others)
                     or <span className="text-cyan-400 font-bold">OWNER INVESTMENT</span>.
                  </p>
               </div>

               {/* Why It Matters */}
               <div className="bg-gradient-to-r from-emerald-800/50 to-cyan-800/50 rounded-xl p-4 mb-6">
                  <h2 className="font-bold text-emerald-300 mb-2 flex items-center gap-2">
                     <span>üéØ</span> WHY THIS MATTERS
                  </h2>
                  <p className="text-slate-200">
                     This is the foundation of ALL financial statements. Understanding it helps you read any balance sheet
                     and understand a company's financial health instantly.
                  </p>
               </div>

               {/* What You'll Do */}
               <div className="bg-black/20 rounded-xl p-4 mb-6 border border-teal-500/30">
                  <h2 className="font-bold text-teal-300 mb-2 flex items-center gap-2">
                     <span>üéÆ</span> WHAT YOU'LL DO
                  </h2>
                  <ul className="text-slate-200 space-y-2">
                     <li className="flex items-start gap-2">
                        <span className="text-emerald-400">‚ñ∏</span>
                        <span>Click transactions to see how they affect the equation</span>
                     </li>
                     <li className="flex items-start gap-2">
                        <span className="text-emerald-400">‚ñ∏</span>
                        <span>Watch the balance scale respond in real-time</span>
                     </li>
                     <li className="flex items-start gap-2">
                        <span className="text-emerald-400">‚ñ∏</span>
                        <span>Discover why the equation ALWAYS balances</span>
                     </li>
                  </ul>
               </div>

               {/* Visual Preview */}
               <div className="bg-black/30 rounded-xl p-4 mb-6">
                  <div className="flex justify-around items-center text-center">
                     <div>
                        <div className="text-3xl mb-1">üìä</div>
                        <p className="text-sm text-emerald-400 font-bold">ASSETS</p>
                        <p className="text-xs text-slate-400">What you OWN</p>
                     </div>
                     <div className="text-2xl text-teal-400">=</div>
                     <div>
                        <div className="text-3xl mb-1">üìã</div>
                        <p className="text-sm text-amber-400 font-bold">LIABILITIES</p>
                        <p className="text-xs text-slate-400">What you OWE</p>
                     </div>
                     <div className="text-2xl text-teal-400">+</div>
                     <div>
                        <div className="text-3xl mb-1">üë§</div>
                        <p className="text-sm text-cyan-400 font-bold">EQUITY</p>
                        <p className="text-xs text-slate-400">Owner's stake</p>
                     </div>
                  </div>
               </div>
            </div>

            {/* Action Buttons */}
            <div className="p-4 bg-black/30 border-t border-emerald-500/30 space-y-3">
               <button
                  onClick={startGame}
                  className="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 rounded-xl font-bold text-lg transition-all transform hover:scale-[1.02] shadow-lg"
               >
                  ‚ñ∂Ô∏è START LEARNING
               </button>
               <button
                  onClick={() => setShowTutorial(true)}
                  className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-medium transition-all"
               >
                  üìñ Quick Tutorial (30 seconds)
               </button>
            </div>
         </div>
      );

      // RESULT PHASE
      if (phase === 'result') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white overflow-hidden">
            <div className="flex-1 p-6 overflow-y-auto">
               {/* Success Header */}
               <div className="text-center mb-6">
                  <div className="text-6xl mb-3">üéì</div>
                  <h1 className="text-2xl font-black mb-2">SESSION COMPLETE!</h1>
                  <p className="text-emerald-400">You performed {transactionHistory.length} transactions</p>
               </div>

               {/* Final State */}
               <div className="bg-black/30 rounded-xl p-4 mb-6">
                  <h3 className="font-bold text-teal-300 mb-3 text-center">üìä Final Financial Position</h3>
                  <div className="grid grid-cols-3 gap-3 text-center">
                     <div className="bg-emerald-900/50 rounded-lg p-3">
                        <p className="text-2xl font-bold text-emerald-400">${totalAssets.toLocaleString()}</p>
                        <p className="text-xs text-slate-300">ASSETS</p>
                     </div>
                     <div className="bg-amber-900/50 rounded-lg p-3">
                        <p className="text-2xl font-bold text-amber-400">${totalLiabilities.toLocaleString()}</p>
                        <p className="text-xs text-slate-300">LIABILITIES</p>
                     </div>
                     <div className="bg-cyan-900/50 rounded-lg p-3">
                        <p className="text-2xl font-bold text-cyan-400">${totalEquity.toLocaleString()}</p>
                        <p className="text-xs text-slate-300">EQUITY</p>
                     </div>
                  </div>
                  <div className="mt-3 text-center">
                     <span className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold ${isBalanced ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                        {isBalanced ? '‚úì EQUATION BALANCED' : '‚úó ERROR - Not Balanced'}
                     </span>
                  </div>
               </div>

               {/* Key Insight */}
               <div className="bg-gradient-to-r from-purple-900/50 to-indigo-900/50 rounded-xl p-5 mb-6 border border-purple-500/30">
                  <h3 className="font-bold text-purple-300 mb-3 flex items-center gap-2">
                     <span className="text-xl">üí°</span> KEY INSIGHT
                  </h3>
                  <p className="text-lg text-white mb-4 leading-relaxed">
                     The accounting equation <span className="text-emerald-400 font-bold">ALWAYS balances</span> because
                     every transaction has TWO effects. This is called <span className="text-cyan-400 font-bold">"double-entry" bookkeeping</span>.
                  </p>
                  <div className="space-y-2 text-sm text-slate-200">
                     <p className="flex items-start gap-2">
                        <span className="text-purple-400">‚ñ∏</span>
                        <span>Buying something with cash just swaps one asset for another</span>
                     </p>
                     <p className="flex items-start gap-2">
                        <span className="text-purple-400">‚ñ∏</span>
                        <span>Taking a loan increases both assets AND liabilities equally</span>
                     </p>
                     <p className="flex items-start gap-2">
                        <span className="text-purple-400">‚ñ∏</span>
                        <span>Owner investment increases both assets AND equity</span>
                     </p>
                  </div>
               </div>

               {/* Real-World Application */}
               <div className="bg-black/30 rounded-xl p-4 mb-6">
                  <h3 className="font-bold text-amber-300 mb-2 flex items-center gap-2">
                     <span>üåç</span> REAL-WORLD APPLICATION
                  </h3>
                  <p className="text-slate-200">
                     When you look at any company's balance sheet, check if Assets = Liabilities + Equity.
                     If it doesn't balance, there's an error‚Äîor worse, potential fraud.
                     This simple equation is how auditors catch financial manipulation.
                  </p>
               </div>

               {/* Transaction History */}
               <div className="bg-black/30 rounded-xl p-4 mb-6">
                  <h3 className="font-bold text-teal-300 mb-3">üìù Your Transaction Log</h3>
                  <div className="space-y-2 max-h-32 overflow-y-auto">
                     {transactionHistory.map((t, i) => (
                        <div key={i} className="flex items-center gap-2 text-sm bg-black/30 rounded-lg px-3 py-2">
                           <span className="text-emerald-400">{i + 1}.</span>
                           <span className="text-slate-300">{t.name}</span>
                           <span className="ml-auto text-green-400">‚úì</span>
                        </div>
                     ))}
                  </div>
               </div>

               {/* AI Coach Sync Info */}
               <div className="bg-indigo-900/30 rounded-xl p-4 border border-indigo-500/30">
                  <h3 className="font-bold text-indigo-300 mb-2 flex items-center gap-2">
                     <span>ü§ñ</span> Session Synced with AI Coach
                  </h3>
                  <p className="text-sm text-slate-300">
                     Your learning session has been logged. Ask your AI coach to review your transactions,
                     explain any concepts, or provide additional practice scenarios.
                  </p>
               </div>
            </div>

            {/* Action Buttons */}
            <div className="p-4 bg-black/30 border-t border-emerald-500/30 flex gap-3">
               <button
                  onClick={() => { resetSimulation(); setPhase('intro'); }}
                  className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all"
               >
                  üîÑ Try Again
               </button>
               <button
                  onClick={() => setPhase('intro')}
                  className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold transition-all"
               >
                  ‚û°Ô∏è Continue
               </button>
            </div>
         </div>
      );

      // PLAY PHASE
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white overflow-hidden">
            {/* Info Modal */}
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-emerald-400 mb-3">{infoTopics[infoTopic].title}</h3>
                     <p className="text-slate-200 mb-4">{infoTopics[infoTopic].content}</p>
                     <div className="bg-black/30 rounded-lg p-3 mb-4">
                        <p className="text-xs text-teal-400 font-bold mb-1">EXAMPLE:</p>
                        <p className="text-sm text-slate-300">{infoTopics[infoTopic].example}</p>
                     </div>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="w-full py-2 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold transition-all">
                        Got it! üëç
                     </button>
                  </div>
               </div>
            )}

            {/* Transaction Result Modal */}
            {showTransactionResult && currentTransaction && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setShowTransactionResult(false)}>
                  <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                     <div className="text-center mb-4">
                        <span className="text-4xl">{transactions.find(t => t.id === currentTransaction)?.icon}</span>
                        <h3 className="text-lg font-bold text-emerald-400 mt-2">
                           {transactions.find(t => t.id === currentTransaction)?.shortName}
                        </h3>
                     </div>
                     <div className="bg-green-900/30 rounded-lg p-4 mb-4 border border-green-500/30">
                        <p className="text-green-400 font-medium">{lastTransactionEffect}</p>
                     </div>
                     <div className="bg-black/30 rounded-lg p-3 mb-4">
                        <p className="text-xs text-teal-400 font-bold mb-1">WHY IT BALANCES:</p>
                        <p className="text-sm text-slate-300">
                           {transactions.find(t => t.id === currentTransaction)?.explanation}
                        </p>
                     </div>
                     <button onClick={() => setShowTransactionResult(false)} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold transition-all">
                        Continue ‚û°Ô∏è
                     </button>
                  </div>
               </div>
            )}

            {/* Header */}
            <div className="p-3 bg-black/30 border-b border-emerald-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-lg">‚öñÔ∏è Accounting Equation</span>
                  <div className="flex items-center gap-2">
                     <span className="text-xs bg-emerald-600/50 px-2 py-1 rounded-full">
                        {transactionHistory.length} transactions
                     </span>
                     <button onClick={() => { setInfoTopic('equation'); setShowInfo(true); }} className="w-7 h-7 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-sm transition-all">
                        ‚ÑπÔ∏è
                     </button>
                  </div>
               </div>
            </div>

            {/* Main Content */}
            <div className="flex-1 p-4 overflow-y-auto">
               {/* Balance Visualization */}
               <div className="bg-black/30 rounded-xl p-4 mb-4">
                  {/* The Equation Display */}
                  <div className="flex items-center justify-center gap-3 mb-4">
                     <div className="text-center flex-1">
                        <div className="flex items-center justify-center gap-1">
                           <span className="text-xs text-emerald-400 font-bold">ASSETS</span>
                           <button onClick={() => { setInfoTopic('assets'); setShowInfo(true); }} className="text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="text-2xl font-bold text-emerald-400">${totalAssets.toLocaleString()}</div>
                     </div>
                     <div className="text-2xl font-bold text-white">=</div>
                     <div className="text-center flex-1">
                        <div className="flex items-center justify-center gap-1">
                           <span className="text-xs text-amber-400 font-bold">LIABILITIES</span>
                           <button onClick={() => { setInfoTopic('liabilities'); setShowInfo(true); }} className="text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="text-2xl font-bold text-amber-400">${totalLiabilities.toLocaleString()}</div>
                     </div>
                     <div className="text-2xl font-bold text-white">+</div>
                     <div className="text-center flex-1">
                        <div className="flex items-center justify-center gap-1">
                           <span className="text-xs text-cyan-400 font-bold">EQUITY</span>
                           <button onClick={() => { setInfoTopic('equity'); setShowInfo(true); }} className="text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="text-2xl font-bold text-cyan-400">${totalEquity.toLocaleString()}</div>
                     </div>
                  </div>

                  {/* Balance Scale Visual */}
                  <div className="relative h-16 flex items-center justify-center">
                     <div className="absolute inset-x-0 top-1/2 h-1 bg-slate-600 rounded-full"></div>
                     <div className="absolute left-1/2 top-0 bottom-0 w-1 bg-slate-500 -translate-x-1/2"></div>
                     <div className={`absolute inset-x-8 h-2 rounded-full transition-all duration-500 ${isBalanced ? 'bg-green-500 top-1/2 -translate-y-1/2' : 'bg-red-500 rotate-6'}`}></div>
                     <div className="absolute left-8 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-emerald-400 border-2 border-emerald-300 shadow-lg"></div>
                     <div className="absolute right-8 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-cyan-400 border-2 border-cyan-300 shadow-lg"></div>
                  </div>

                  {/* Balance Status */}
                  <div className="text-center mt-2">
                     <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold ${isBalanced ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                        {isBalanced ? '‚úì BALANCED' : '‚úó UNBALANCED'}
                     </span>
                  </div>
               </div>

               {/* Detailed Breakdown */}
               <div className="grid grid-cols-3 gap-2 mb-4">
                  {/* Assets Detail */}
                  <div className="bg-emerald-900/30 rounded-lg p-2 border border-emerald-500/20">
                     <p className="text-xs font-bold text-emerald-400 mb-2 text-center">ASSETS</p>
                     <div className="space-y-1 text-xs">
                        <div className="flex justify-between"><span className="text-slate-400">Cash</span><span className="text-emerald-300">${assets.cash.toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-400">AR</span><span className="text-emerald-300">${assets.accountsReceivable.toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-400">Inventory</span><span className="text-emerald-300">${assets.inventory.toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-400">Equipment</span><span className="text-emerald-300">${assets.equipment.toLocaleString()}</span></div>
                     </div>
                  </div>

                  {/* Liabilities Detail */}
                  <div className="bg-amber-900/30 rounded-lg p-2 border border-amber-500/20">
                     <p className="text-xs font-bold text-amber-400 mb-2 text-center">LIABILITIES</p>
                     <div className="space-y-1 text-xs">
                        <div className="flex justify-between"><span className="text-slate-400">AP</span><span className="text-amber-300">${liabilities.accountsPayable.toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-400">Loans</span><span className="text-amber-300">${liabilities.loansPayable.toLocaleString()}</span></div>
                     </div>
                  </div>

                  {/* Equity Detail */}
                  <div className="bg-cyan-900/30 rounded-lg p-2 border border-cyan-500/20">
                     <p className="text-xs font-bold text-cyan-400 mb-2 text-center">EQUITY</p>
                     <div className="space-y-1 text-xs">
                        <div className="flex justify-between"><span className="text-slate-400">Capital</span><span className="text-cyan-300">${equity.ownerCapital.toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-400">Retained</span><span className="text-cyan-300">${equity.retainedEarnings.toLocaleString()}</span></div>
                     </div>
                  </div>
               </div>

               {/* Guidance Message */}
               {guidanceMessage && (
                  <div className="bg-indigo-900/30 rounded-lg p-3 mb-4 border border-indigo-500/30">
                     <div className="flex items-start gap-2">
                        <span className="text-lg">üí¨</span>
                        <p className="text-sm text-indigo-200">{guidanceMessage}</p>
                     </div>
                  </div>
               )}

               {/* Transaction Buttons */}
               <div className="mb-4">
                  <div className="flex items-center justify-between mb-3">
                     <h3 className="font-bold text-teal-300 flex items-center gap-2">
                        <span>üìù</span> Click a Transaction
                     </h3>
                     <button onClick={() => { setInfoTopic('doubleEntry'); setShowInfo(true); }} className="text-xs text-teal-400 hover:text-teal-300">
                        ‚ÑπÔ∏è How it works
                     </button>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                     {transactions.map(t => (
                        <button
                           key={t.id}
                           onClick={() => executeTransaction(t.id)}
                           className="p-3 bg-black/30 hover:bg-emerald-600/30 rounded-xl text-left transition-all border border-transparent hover:border-emerald-500/50 group"
                        >
                           <div className="flex items-center gap-2 mb-1">
                              <span className="text-lg">{t.icon}</span>
                              <span className="font-medium text-sm text-white group-hover:text-emerald-300">{t.shortName}</span>
                           </div>
                           <p className="text-xs text-slate-400">{t.description}</p>
                        </button>
                     ))}
                  </div>
               </div>

               {/* Transaction History */}
               {transactionHistory.length > 0 && (
                  <div className="bg-black/20 rounded-lg p-3">
                     <h4 className="text-xs font-bold text-slate-400 mb-2">TRANSACTION HISTORY</h4>
                     <div className="flex flex-wrap gap-1">
                        {transactionHistory.map((t, i) => (
                           <span key={i} className="px-2 py-1 bg-emerald-600/30 rounded text-xs text-emerald-300">
                              {i + 1}. {t.name}
                           </span>
                        ))}
                     </div>
                  </div>
               )}
            </div>

            {/* Footer Actions */}
            <div className="p-3 bg-black/30 border-t border-emerald-500/30 flex gap-2">
               <button onClick={resetSimulation} className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-all">
                  üîÑ Reset
               </button>
               <button onClick={() => { setInfoTopic('balanceSheet'); setShowInfo(true); }} className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-all">
                  ‚ÑπÔ∏è Learn More
               </button>
               <button
                  onClick={finishSession}
                  disabled={transactionHistory.length < 2}
                  className="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-600 disabled:opacity-50 rounded-lg font-bold transition-all"
               >
                  {transactionHistory.length < 2 ? `Try ${2 - transactionHistory.length} more...` : 'Finish & See Insights ‚Üí'}
               </button>
            </div>
         </div>
      );
   };

   // ============================================================================
   // DOUBLE-ENTRY BOOKKEEPING INTERACTIVE SIMULATION
   // Every transaction affects at least two accounts - debits and credits
   // Features: Drag-and-drop T-accounts, progressive levels, coaching, AI sync
   // ============================================================================
   const DoubleEntryBookkeepingRenderer = () => {
      // ============================================================
      // PHASE & UI STATE
      // ============================================================
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);

      // ============================================================
      // GAME STATE
      // ============================================================
      const [currentLevel, setCurrentLevel] = useState(0);
      const [currentScenario, setCurrentScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [streak, setStreak] = useState(0);
      const [bestStreak, setBestStreak] = useState(0);
      const [totalAttempts, setTotalAttempts] = useState(0);
      const [correctAttempts, setCorrectAttempts] = useState(0);

      // ============================================================
      // DRAG AND DROP STATE
      // ============================================================
      const [draggedItem, setDraggedItem] = useState<{type: 'increase' | 'decrease'; amount: number} | null>(null);
      const [placements, setPlacements] = useState<{
         account1Debit: number | null;
         account1Credit: number | null;
         account2Debit: number | null;
         account2Credit: number | null;
      }>({ account1Debit: null, account1Credit: null, account2Debit: null, account2Credit: null });
      const [showResult, setShowResult] = useState(false);
      const [isCorrect, setIsCorrect] = useState(false);

      // ============================================================
      // RUNNING TOTALS FOR BALANCE CHECK
      // ============================================================
      const [runningDebits, setRunningDebits] = useState(0);
      const [runningCredits, setRunningCredits] = useState(0);

      // ============================================================
      // COACHING STATE
      // ============================================================
      const [coachMessage, setCoachMessage] = useState<string>('');
      const [showHint, setShowHint] = useState(false);

      // ============================================================
      // AI COACH SYNC - GAME LOG
      // ============================================================
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptsLearned, setConceptsLearned] = useState<string[]>([]);
      const [mistakePatterns, setMistakePatterns] = useState<string[]>([]);

      // ============================================================
      // ACCOUNT TYPES REFERENCE
      // ============================================================
      type AccountType = 'asset' | 'liability' | 'equity' | 'revenue' | 'expense';

      interface Account {
         name: string;
         type: AccountType;
         normalBalance: 'debit' | 'credit';
      }

      // ============================================================
      // SCENARIO DEFINITIONS - PROGRESSIVE DIFFICULTY
      // ============================================================
      const levels = [
         { name: 'Level 1: Asset Exchanges', description: 'Simple swaps between asset accounts' },
         { name: 'Level 2: Revenue Transactions', description: 'Earning money for services' },
         { name: 'Level 3: Expense Transactions', description: 'Paying for business costs' },
         { name: 'Level 4: Liability Transactions', description: 'Borrowing and paying back' },
         { name: 'Level 5: Complex Transactions', description: 'Multi-step real-world scenarios' }
      ];

      const scenarios = [
         // LEVEL 1: Asset Exchanges
         [
            {
               id: 1,
               description: 'Bought office supplies for $500 cash',
               account1: { name: 'Office Supplies', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 500,
               correctAnswer: { account1Debit: 500, account1Credit: null, account2Debit: null, account2Credit: 500 },
               explanation: 'Office Supplies (asset) increases ‚Üí DEBIT. Cash (asset) decreases ‚Üí CREDIT. Both are assets, but one goes up and one goes down.',
               whyItBalances: 'Debit $500 = Credit $500. You traded one asset for another.',
               realWorld: 'Every time you buy something with cash, this exact entry happens in the books.'
            },
            {
               id: 2,
               description: 'Purchased equipment for $3,000 cash',
               account1: { name: 'Equipment', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 3000,
               correctAnswer: { account1Debit: 3000, account1Credit: null, account2Debit: null, account2Credit: 3000 },
               explanation: 'Equipment (asset) increases ‚Üí DEBIT. Cash (asset) decreases ‚Üí CREDIT. You converted cash into a long-term asset.',
               whyItBalances: 'Debit $3,000 = Credit $3,000. Total assets unchanged, just the form changed.',
               realWorld: 'Buying a computer, desk, or machinery all follow this pattern.'
            },
            {
               id: 3,
               description: 'Deposited $2,000 from petty cash into the bank',
               account1: { name: 'Bank Account', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Petty Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 2000,
               correctAnswer: { account1Debit: 2000, account1Credit: null, account2Debit: null, account2Credit: 2000 },
               explanation: 'Bank Account (asset) increases ‚Üí DEBIT. Petty Cash (asset) decreases ‚Üí CREDIT. Moving money between accounts.',
               whyItBalances: 'Debit $2,000 = Credit $2,000. Just moving cash from one place to another.',
               realWorld: 'Moving money between checking and savings follows this same logic.'
            }
         ],
         // LEVEL 2: Revenue Transactions
         [
            {
               id: 4,
               description: 'Received $1,500 cash for consulting services',
               account1: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Service Revenue', type: 'revenue' as AccountType, normalBalance: 'credit' as const },
               amount: 1500,
               correctAnswer: { account1Debit: 1500, account1Credit: null, account2Debit: null, account2Credit: 1500 },
               explanation: 'Cash (asset) increases ‚Üí DEBIT. Service Revenue increases ‚Üí CREDIT. Revenue has a credit normal balance!',
               whyItBalances: 'Debit $1,500 = Credit $1,500. You got cash and recorded the earning.',
               realWorld: 'Every sale you make creates this entry - cash in, revenue recorded.'
            },
            {
               id: 5,
               description: 'Earned $800 for web design, client will pay later',
               account1: { name: 'Accounts Receivable', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Service Revenue', type: 'revenue' as AccountType, normalBalance: 'credit' as const },
               amount: 800,
               correctAnswer: { account1Debit: 800, account1Credit: null, account2Debit: null, account2Credit: 800 },
               explanation: 'Accounts Receivable (asset) increases ‚Üí DEBIT. Revenue increases ‚Üí CREDIT. You earned it even though cash hasnt arrived.',
               whyItBalances: 'Debit $800 = Credit $800. Revenue is recorded when EARNED, not when paid.',
               realWorld: 'This is accrual accounting - recording revenue when the work is done, not when you get paid.'
            },
            {
               id: 6,
               description: 'Sold products for $2,200 cash',
               account1: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Sales Revenue', type: 'revenue' as AccountType, normalBalance: 'credit' as const },
               amount: 2200,
               correctAnswer: { account1Debit: 2200, account1Credit: null, account2Debit: null, account2Credit: 2200 },
               explanation: 'Cash (asset) increases ‚Üí DEBIT. Sales Revenue increases ‚Üí CREDIT. Simple cash sale.',
               whyItBalances: 'Debit $2,200 = Credit $2,200. Cash in, revenue recorded.',
               realWorld: 'Every retail transaction at a store creates this exact entry.'
            }
         ],
         // LEVEL 3: Expense Transactions
         [
            {
               id: 7,
               description: 'Paid $1,200 rent for the month',
               account1: { name: 'Rent Expense', type: 'expense' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 1200,
               correctAnswer: { account1Debit: 1200, account1Credit: null, account2Debit: null, account2Credit: 1200 },
               explanation: 'Rent Expense increases ‚Üí DEBIT (expenses have debit normal balance). Cash decreases ‚Üí CREDIT.',
               whyItBalances: 'Debit $1,200 = Credit $1,200. You spent cash on an expense.',
               realWorld: 'Every monthly bill payment - rent, utilities, insurance - follows this pattern.'
            },
            {
               id: 8,
               description: 'Paid employees $4,500 in wages',
               account1: { name: 'Wages Expense', type: 'expense' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 4500,
               correctAnswer: { account1Debit: 4500, account1Credit: null, account2Debit: null, account2Credit: 4500 },
               explanation: 'Wages Expense increases ‚Üí DEBIT. Cash decreases ‚Üí CREDIT. Paying for labor.',
               whyItBalances: 'Debit $4,500 = Credit $4,500. Cash out, expense recorded.',
               realWorld: 'Payroll is usually the biggest expense for most businesses.'
            },
            {
               id: 9,
               description: 'Paid $350 for advertising',
               account1: { name: 'Advertising Expense', type: 'expense' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 350,
               correctAnswer: { account1Debit: 350, account1Credit: null, account2Debit: null, account2Credit: 350 },
               explanation: 'Advertising Expense increases ‚Üí DEBIT. Cash decreases ‚Üí CREDIT.',
               whyItBalances: 'Debit $350 = Credit $350. Marketing spend recorded.',
               realWorld: 'Every Facebook ad, Google ad, or billboard creates this entry.'
            }
         ],
         // LEVEL 4: Liability Transactions
         [
            {
               id: 10,
               description: 'Borrowed $10,000 from the bank',
               account1: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Bank Loan Payable', type: 'liability' as AccountType, normalBalance: 'credit' as const },
               amount: 10000,
               correctAnswer: { account1Debit: 10000, account1Credit: null, account2Debit: null, account2Credit: 10000 },
               explanation: 'Cash (asset) increases ‚Üí DEBIT. Bank Loan (liability) increases ‚Üí CREDIT. Liabilities increase with credits!',
               whyItBalances: 'Debit $10,000 = Credit $10,000. You got cash but now owe money.',
               realWorld: 'Every business loan, mortgage, or line of credit works this way.'
            },
            {
               id: 11,
               description: 'Paid $2,000 on the bank loan',
               account1: { name: 'Bank Loan Payable', type: 'liability' as AccountType, normalBalance: 'credit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 2000,
               correctAnswer: { account1Debit: 2000, account1Credit: null, account2Debit: null, account2Credit: 2000 },
               explanation: 'Bank Loan (liability) decreases ‚Üí DEBIT (opposite of normal). Cash decreases ‚Üí CREDIT.',
               whyItBalances: 'Debit $2,000 = Credit $2,000. You reduced what you owe.',
               realWorld: 'Every loan payment you make reduces your liability this way.'
            },
            {
               id: 12,
               description: 'Received $5,000 from an investor for company stock',
               account1: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Common Stock', type: 'equity' as AccountType, normalBalance: 'credit' as const },
               amount: 5000,
               correctAnswer: { account1Debit: 5000, account1Credit: null, account2Debit: null, account2Credit: 5000 },
               explanation: 'Cash (asset) increases ‚Üí DEBIT. Common Stock (equity) increases ‚Üí CREDIT. Equity grows with credits!',
               whyItBalances: 'Debit $5,000 = Credit $5,000. Cash in, ownership stake recorded.',
               realWorld: 'This is how startups record investment rounds.'
            }
         ],
         // LEVEL 5: Complex Transactions
         [
            {
               id: 13,
               description: 'Purchased $3,000 of inventory on credit (will pay later)',
               account1: { name: 'Inventory', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Accounts Payable', type: 'liability' as AccountType, normalBalance: 'credit' as const },
               amount: 3000,
               correctAnswer: { account1Debit: 3000, account1Credit: null, account2Debit: null, account2Credit: 3000 },
               explanation: 'Inventory (asset) increases ‚Üí DEBIT. Accounts Payable (liability) increases ‚Üí CREDIT. You got goods but owe for them.',
               whyItBalances: 'Debit $3,000 = Credit $3,000. Asset up, liability up by same amount.',
               realWorld: 'Most businesses buy inventory on credit terms (net 30, net 60).'
            },
            {
               id: 14,
               description: 'Paid off $1,500 of accounts payable',
               account1: { name: 'Accounts Payable', type: 'liability' as AccountType, normalBalance: 'credit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 1500,
               correctAnswer: { account1Debit: 1500, account1Credit: null, account2Debit: null, account2Credit: 1500 },
               explanation: 'Accounts Payable (liability) decreases ‚Üí DEBIT. Cash decreases ‚Üí CREDIT.',
               whyItBalances: 'Debit $1,500 = Credit $1,500. Paid what you owed.',
               realWorld: 'Paying vendor invoices is one of the most common transactions.'
            },
            {
               id: 15,
               description: 'Owner withdrew $2,000 for personal use',
               account1: { name: 'Owner Drawings', type: 'equity' as AccountType, normalBalance: 'debit' as const },
               account2: { name: 'Cash', type: 'asset' as AccountType, normalBalance: 'debit' as const },
               amount: 2000,
               correctAnswer: { account1Debit: 2000, account1Credit: null, account2Debit: null, account2Credit: 2000 },
               explanation: 'Owner Drawings (reduces equity) ‚Üí DEBIT. Cash decreases ‚Üí CREDIT. Drawings reduce the owners stake.',
               whyItBalances: 'Debit $2,000 = Credit $2,000. Owner took money out.',
               realWorld: 'In sole proprietorships, owners often take draws instead of salary.'
            }
         ]
      ];

      // ============================================================
      // INFO TOPICS - COMPREHENSIVE EXPLANATIONS
      // ============================================================
      const infoTopics: Record<string, { title: string; content: string; example: string; whyItMatters: string }> = {
         debit: {
            title: 'What is a DEBIT?',
            content: 'A debit is an entry on the LEFT side of a T-account. For assets and expenses, a debit means INCREASE. For liabilities, equity, and revenue, a debit means DECREASE.',
            example: 'When you receive $1,000 cash, you DEBIT the Cash account because cash (an asset) is increasing.',
            whyItMatters: 'Understanding debits is essential for recording any transaction correctly. Remember: Assets & Expenses increase with debits.'
         },
         credit: {
            title: 'What is a CREDIT?',
            content: 'A credit is an entry on the RIGHT side of a T-account. For liabilities, equity, and revenue, a credit means INCREASE. For assets and expenses, a credit means DECREASE.',
            example: 'When you earn $1,000 in revenue, you CREDIT the Revenue account because revenue increases with credits.',
            whyItMatters: 'Credits balance out debits. Every transaction must have equal debits and credits - this is the foundation of accounting accuracy.'
         },
         tAccount: {
            title: 'What is a T-Account?',
            content: 'A T-account is a visual representation of a ledger account. It looks like the letter "T" with the account name on top, debits on the left, and credits on the right.',
            example: 'The Cash T-account shows all increases (debits) on the left and all decreases (credits) on the right.',
            whyItMatters: 'T-accounts help visualize how transactions flow through accounts. They are the building blocks of the general ledger.'
         },
         normalBalance: {
            title: 'What is Normal Balance?',
            content: 'Each account type has a "normal" side where increases are recorded. Assets & Expenses: Debit normal. Liabilities, Equity & Revenue: Credit normal.',
            example: 'Cash has a debit normal balance, so increases go on the left. Revenue has a credit normal balance, so increases go on the right.',
            whyItMatters: 'Knowing normal balances tells you instantly which side to use for increases vs decreases.'
         },
         assets: {
            title: 'Asset Accounts',
            content: 'Assets are resources owned by the business that have future value. Examples: Cash, Accounts Receivable, Inventory, Equipment, Buildings.',
            example: 'When you buy equipment for $5,000 cash, Equipment (asset) increases with a DEBIT and Cash (asset) decreases with a CREDIT.',
            whyItMatters: 'Assets appear on the balance sheet and show what the company owns. They increase with debits.'
         },
         liabilities: {
            title: 'Liability Accounts',
            content: 'Liabilities are obligations the business owes to others. Examples: Accounts Payable, Loans Payable, Wages Payable, Unearned Revenue.',
            example: 'When you borrow $10,000, Cash increases (debit) and Loans Payable increases (credit).',
            whyItMatters: 'Liabilities show what the company owes. They increase with credits - opposite of assets!'
         },
         equity: {
            title: 'Equity Accounts',
            content: 'Equity represents the owners claim on assets after liabilities are paid. Examples: Common Stock, Retained Earnings, Owner Capital.',
            example: 'When an owner invests $5,000, Cash increases (debit) and Owner Capital increases (credit).',
            whyItMatters: 'Equity = Assets - Liabilities. It grows when the business is profitable and shrinks with losses or withdrawals.'
         },
         revenue: {
            title: 'Revenue Accounts',
            content: 'Revenue is income earned from business operations. Examples: Sales Revenue, Service Revenue, Interest Revenue.',
            example: 'When you earn $1,000 for services, Cash increases (debit) and Service Revenue increases (credit).',
            whyItMatters: 'Revenue increases equity through retained earnings. More revenue = higher profits = more owner value.'
         },
         expenses: {
            title: 'Expense Accounts',
            content: 'Expenses are costs incurred to generate revenue. Examples: Rent Expense, Wages Expense, Utilities Expense, Advertising Expense.',
            example: 'When you pay $500 rent, Rent Expense increases (debit) and Cash decreases (credit).',
            whyItMatters: 'Expenses reduce equity through retained earnings. Controlling expenses is key to profitability.'
         },
         balance: {
            title: 'Why Must Debits = Credits?',
            content: 'The double-entry system requires every transaction to have equal debits and credits. This ensures the accounting equation (Assets = Liabilities + Equity) always stays balanced.',
            example: 'If you record a $1,000 debit without a matching credit, your trial balance wont balance - signaling an error.',
            whyItMatters: 'This is how accountants catch errors and fraud. If debits dont equal credits, something is wrong.'
         }
      };

      // ============================================================
      // HELPER FUNCTIONS
      // ============================================================
      const getCurrentScenarioData = () => {
         return scenarios[currentLevel]?.[currentScenario];
      };

      const checkAnswer = () => {
         const scenario = getCurrentScenarioData();
         if (!scenario) return;

         const correct = scenario.correctAnswer;
         const isAnswerCorrect =
            placements.account1Debit === correct.account1Debit &&
            placements.account1Credit === correct.account1Credit &&
            placements.account2Debit === correct.account2Debit &&
            placements.account2Credit === correct.account2Credit;

         setIsCorrect(isAnswerCorrect);
         setShowResult(true);
         setTotalAttempts(prev => prev + 1);

         if (isAnswerCorrect) {
            setCorrectAttempts(prev => prev + 1);
            setScore(prev => prev + 100 + (streak * 10));
            setStreak(prev => prev + 1);
            if (streak + 1 > bestStreak) setBestStreak(streak + 1);
            setRunningDebits(prev => prev + scenario.amount);
            setRunningCredits(prev => prev + scenario.amount);
            setCoachMessage(`Excellent! ${scenario.explanation}`);

            // Log success
            setGameLog(prev => [...prev,
               `[CORRECT] ${scenario.description}`,
               `[ENTRY] DR ${scenario.account1.name} $${scenario.amount} | CR ${scenario.account2.name} $${scenario.amount}`
            ]);

            // Track concepts learned
            if (!conceptsLearned.includes(scenario.account1.type)) {
               setConceptsLearned(prev => [...prev, scenario.account1.type]);
            }
            if (!conceptsLearned.includes(scenario.account2.type)) {
               setConceptsLearned(prev => [...prev, scenario.account2.type]);
            }
         } else {
            setStreak(0);
            setCoachMessage(`Not quite. ${scenario.explanation}`);

            // Track mistakes
            setGameLog(prev => [...prev,
               `[INCORRECT] ${scenario.description}`,
               `[USER PLACED] DR1:${placements.account1Debit} CR1:${placements.account1Credit} DR2:${placements.account2Debit} CR2:${placements.account2Credit}`,
               `[CORRECT WAS] DR1:${correct.account1Debit} CR1:${correct.account1Credit} DR2:${correct.account2Debit} CR2:${correct.account2Credit}`
            ]);

            // Pattern detection for mistakes
            const scenario_data = getCurrentScenarioData();
            if (scenario_data) {
               const accountTypes = [scenario_data.account1.type, scenario_data.account2.type];
               accountTypes.forEach(type => {
                  if (!mistakePatterns.includes(type)) {
                     setMistakePatterns(prev => [...prev, type]);
                  }
               });
            }
         }
      };

      const nextScenario = () => {
         setShowResult(false);
         setPlacements({ account1Debit: null, account1Credit: null, account2Debit: null, account2Credit: null });
         setShowHint(false);

         if (currentScenario < scenarios[currentLevel].length - 1) {
            setCurrentScenario(prev => prev + 1);
         } else if (currentLevel < levels.length - 1) {
            setCurrentLevel(prev => prev + 1);
            setCurrentScenario(0);
            setCoachMessage(`Level Up! Welcome to ${levels[currentLevel + 1].name}`);
         } else {
            // Completed all levels
            setGameLog(prev => [...prev,
               `[SESSION COMPLETE]`,
               `[FINAL SCORE] ${score}`,
               `[ACCURACY] ${Math.round((correctAttempts / totalAttempts) * 100)}%`,
               `[BEST STREAK] ${bestStreak}`,
               `[CONCEPTS LEARNED] ${conceptsLearned.join(', ')}`,
               `[STRUGGLED WITH] ${mistakePatterns.join(', ')}`
            ]);
            setPhase('result');
         }
      };

      const resetPlacements = () => {
         setPlacements({ account1Debit: null, account1Credit: null, account2Debit: null, account2Credit: null });
      };

      const handleDrop = (zone: 'account1Debit' | 'account1Credit' | 'account2Debit' | 'account2Credit') => {
         if (!draggedItem) return;
         const scenario = getCurrentScenarioData();
         if (!scenario) return;

         setPlacements(prev => ({
            ...prev,
            [zone]: scenario.amount
         }));
         setDraggedItem(null);
      };

      const startGame = () => {
         setPhase('tutorial');
         setTutorialStep(0);
         setGameLog(['[SESSION START] Double-Entry Bookkeeping Simulation']);
      };

      const startPlaying = () => {
         setPhase('play');
         setCoachMessage(`Let's practice! ${levels[0].description}. Drag the amounts to the correct T-account sides.`);
      };

      const finishSession = () => {
         setGameLog(prev => [...prev,
            `[SESSION COMPLETE]`,
            `[FINAL SCORE] ${score}`,
            `[ACCURACY] ${totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0}%`,
            `[BEST STREAK] ${bestStreak}`,
            `[LEVELS COMPLETED] ${currentLevel + 1}/${levels.length}`,
            `[CONCEPTS MASTERED] ${conceptsLearned.join(', ')}`,
            `[AREAS FOR REVIEW] ${mistakePatterns.join(', ')}`
         ]);
         setPhase('result');
      };

      // ============================================================
      // TUTORIAL STEPS
      // ============================================================
      const tutorialSteps = [
         {
            title: 'Welcome to Double-Entry Bookkeeping!',
            content: 'Every financial transaction affects at least TWO accounts. This 500-year-old system is how every business in the world tracks money.',
            visual: 'intro'
         },
         {
            title: 'The T-Account',
            content: 'Each account looks like a "T". The LEFT side is called DEBIT. The RIGHT side is called CREDIT. These are just positions - not good or bad!',
            visual: 'tAccount'
         },
         {
            title: 'The Golden Rules',
            content: 'Assets & Expenses: Increase with DEBIT (left)\nLiabilities, Equity & Revenue: Increase with CREDIT (right)\n\nTo decrease, use the opposite side!',
            visual: 'rules'
         },
         {
            title: 'The Balance Requirement',
            content: 'EVERY transaction must have equal Debits and Credits. This is why the books always "balance" - and how we catch errors!',
            visual: 'balance'
         },
         {
            title: 'How to Play',
            content: 'You\'ll see a transaction and two T-accounts. Drag the increase/decrease amounts to the correct sides. Match the correct pattern to score points!',
            visual: 'play'
         }
      ];

      // ============================================================
      // RENDER: INTRO PHASE
      // ============================================================
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  {/* Header */}
                  <div className="text-center mb-6">
                     <div className="text-5xl mb-3">üìí</div>
                     <h1 className="text-2xl font-black mb-2">DOUBLE-ENTRY BOOKKEEPING</h1>
                     <p className="text-xl font-bold text-blue-300">Master the Foundation of All Accounting</p>
                  </div>

                  {/* Core Concept */}
                  <div className="bg-black/30 rounded-2xl p-5 mb-6 border border-blue-500/30">
                     <p className="text-lg text-center leading-relaxed">
                        Every transaction affects <span className="text-blue-400 font-bold">TWO accounts</span> ‚Äî
                        one <span className="text-green-400 font-bold">DEBIT</span> and
                        one <span className="text-amber-400 font-bold">CREDIT</span>.
                        This is why the books always balance!
                     </p>
                  </div>

                  {/* Why It Matters */}
                  <div className="bg-gradient-to-r from-blue-800/50 to-purple-800/50 rounded-xl p-4 mb-6">
                     <h2 className="font-bold text-blue-300 mb-2 flex items-center gap-2">
                        <span>üéØ</span> WHY THIS MATTERS
                     </h2>
                     <p className="text-slate-200">
                        This 500-year-old system is how EVERY business in the world tracks money.
                        Understanding debits and credits helps you catch errors, prevent fraud, and read any financial statement.
                     </p>
                  </div>

                  {/* What You'll Learn */}
                  <div className="bg-black/20 rounded-xl p-4 mb-6 border border-indigo-500/30">
                     <h2 className="font-bold text-indigo-300 mb-3 flex items-center gap-2">
                        <span>üìö</span> WHAT YOU'LL LEARN
                     </h2>
                     <ul className="text-slate-200 space-y-2">
                        <li className="flex items-start gap-2">
                           <span className="text-green-400">‚úì</span>
                           <span>How to record debits and credits correctly</span>
                        </li>
                        <li className="flex items-start gap-2">
                           <span className="text-green-400">‚úì</span>
                           <span>Why every transaction affects two accounts</span>
                        </li>
                        <li className="flex items-start gap-2">
                           <span className="text-green-400">‚úì</span>
                           <span>The rules for different account types</span>
                        </li>
                        <li className="flex items-start gap-2">
                           <span className="text-green-400">‚úì</span>
                           <span>How to verify your books are balanced</span>
                        </li>
                     </ul>
                  </div>

                  {/* Level Preview */}
                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <h3 className="font-bold text-purple-300 mb-3">üéÆ 5 PROGRESSIVE LEVELS</h3>
                     <div className="space-y-2">
                        {levels.map((level, idx) => (
                           <div key={idx} className="flex items-center gap-3 text-sm">
                              <span className="w-6 h-6 rounded-full bg-purple-600/50 flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                              <span className="text-slate-300">{level.name}</span>
                           </div>
                        ))}
                     </div>
                  </div>
               </div>

               {/* Action Button */}
               <div className="p-4 bg-black/30 border-t border-blue-500/30">
                  <button
                     onClick={startGame}
                     className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold text-lg transition-all transform hover:scale-[1.02] shadow-lg"
                  >
                     ‚ñ∂Ô∏è START LEARNING
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: TUTORIAL PHASE
      // ============================================================
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">
               {/* Progress Bar */}
               <div className="p-3 bg-black/30 border-b border-blue-500/30">
                  <div className="flex items-center justify-between mb-2">
                     <span className="text-sm text-blue-300">Tutorial</span>
                     <span className="text-sm text-slate-400">{tutorialStep + 1} of {tutorialSteps.length}</span>
                  </div>
                  <div className="h-2 bg-black/30 rounded-full overflow-hidden">
                     <div
                        className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300"
                        style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}
                     />
                  </div>
               </div>

               <div className="flex-1 p-6 overflow-y-auto">
                  {/* Step Title */}
                  <div className="text-center mb-6">
                     <h2 className="text-xl font-bold text-blue-300 mb-4">{step.title}</h2>
                  </div>

                  {/* Visual Content Based on Step */}
                  {step.visual === 'intro' && (
                     <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-blue-500/30">
                        <div className="text-6xl text-center mb-4">üìí ‚ÜîÔ∏è üìä</div>
                        <p className="text-center text-lg text-slate-200">{step.content}</p>
                     </div>
                  )}

                  {step.visual === 'tAccount' && (
                     <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-blue-500/30">
                        <div className="flex justify-center mb-4">
                           <div className="w-64 border-2 border-blue-400 rounded-lg overflow-hidden">
                              <div className="bg-blue-600/50 text-center py-2 font-bold">CASH</div>
                              <div className="flex">
                                 <div className="flex-1 border-r border-blue-400 p-4 text-center">
                                    <div className="text-green-400 font-bold mb-2">DEBIT</div>
                                    <div className="text-sm text-slate-300">(Left Side)</div>
                                    <div className="text-xs text-slate-400 mt-2">Increases for Assets</div>
                                 </div>
                                 <div className="flex-1 p-4 text-center">
                                    <div className="text-amber-400 font-bold mb-2">CREDIT</div>
                                    <div className="text-sm text-slate-300">(Right Side)</div>
                                    <div className="text-xs text-slate-400 mt-2">Decreases for Assets</div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <p className="text-center text-slate-200">{step.content}</p>
                     </div>
                  )}

                  {step.visual === 'rules' && (
                     <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-blue-500/30">
                        <div className="grid grid-cols-2 gap-4 mb-4">
                           <div className="bg-green-900/30 rounded-lg p-4 border border-green-500/30">
                              <h4 className="font-bold text-green-400 mb-2">DEBIT to Increase</h4>
                              <ul className="text-sm text-slate-300 space-y-1">
                                 <li>‚Ä¢ Assets</li>
                                 <li>‚Ä¢ Expenses</li>
                              </ul>
                           </div>
                           <div className="bg-amber-900/30 rounded-lg p-4 border border-amber-500/30">
                              <h4 className="font-bold text-amber-400 mb-2">CREDIT to Increase</h4>
                              <ul className="text-sm text-slate-300 space-y-1">
                                 <li>‚Ä¢ Liabilities</li>
                                 <li>‚Ä¢ Equity</li>
                                 <li>‚Ä¢ Revenue</li>
                              </ul>
                           </div>
                        </div>
                        <p className="text-center text-slate-200 whitespace-pre-line">{step.content}</p>
                     </div>
                  )}

                  {step.visual === 'balance' && (
                     <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-blue-500/30">
                        <div className="flex justify-center items-center gap-4 mb-4">
                           <div className="bg-green-900/50 rounded-lg p-4 text-center">
                              <div className="text-2xl font-bold text-green-400">$1,000</div>
                              <div className="text-sm text-slate-300">Total Debits</div>
                           </div>
                           <div className="text-3xl font-bold text-blue-400">=</div>
                           <div className="bg-amber-900/50 rounded-lg p-4 text-center">
                              <div className="text-2xl font-bold text-amber-400">$1,000</div>
                              <div className="text-sm text-slate-300">Total Credits</div>
                           </div>
                        </div>
                        <div className="text-center">
                           <span className="inline-flex items-center gap-2 px-4 py-2 bg-green-500/20 rounded-full text-green-400 font-bold">
                              ‚úì BALANCED
                           </span>
                        </div>
                        <p className="text-center text-slate-200 mt-4">{step.content}</p>
                     </div>
                  )}

                  {step.visual === 'play' && (
                     <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-blue-500/30">
                        <div className="text-4xl text-center mb-4">üéÆ</div>
                        <div className="bg-indigo-900/30 rounded-lg p-4 mb-4">
                           <p className="text-center text-indigo-200 font-medium">
                              "Bought supplies for $500 cash"
                           </p>
                        </div>
                        <div className="flex justify-center gap-2 mb-4">
                           <div className="px-4 py-2 bg-blue-600/50 rounded-lg cursor-move">
                              üí∞ $500 ‚Üë
                           </div>
                           <div className="px-4 py-2 bg-blue-600/50 rounded-lg cursor-move">
                              üí∞ $500 ‚Üì
                           </div>
                        </div>
                        <p className="text-center text-slate-200">{step.content}</p>
                     </div>
                  )}
               </div>

               {/* Navigation */}
               <div className="p-4 bg-black/30 border-t border-blue-500/30 flex gap-3">
                  {tutorialStep > 0 && (
                     <button
                        onClick={() => setTutorialStep(prev => prev - 1)}
                        className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all"
                     >
                        ‚Üê Back
                     </button>
                  )}
                  <button
                     onClick={() => {
                        if (tutorialStep < tutorialSteps.length - 1) {
                           setTutorialStep(prev => prev + 1);
                        } else {
                           startPlaying();
                        }
                     }}
                     className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold transition-all"
                  >
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Playing! üéÆ'}
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: PLAY PHASE
      // ============================================================
      if (phase === 'play') {
         const scenario = getCurrentScenarioData();

         if (!scenario) {
            return <div className="p-4 text-white">Loading...</div>;
         }

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">
               {/* Info Modal */}
               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-blue-400 mb-3">{infoTopics[infoTopic].title}</h3>
                        <p className="text-slate-200 mb-4">{infoTopics[infoTopic].content}</p>
                        <div className="bg-black/30 rounded-lg p-3 mb-3">
                           <p className="text-xs text-indigo-400 font-bold mb-1">EXAMPLE:</p>
                           <p className="text-sm text-slate-300">{infoTopics[infoTopic].example}</p>
                        </div>
                        <div className="bg-purple-900/30 rounded-lg p-3 mb-4 border border-purple-500/30">
                           <p className="text-xs text-purple-400 font-bold mb-1">WHY IT MATTERS:</p>
                           <p className="text-sm text-slate-300">{infoTopics[infoTopic].whyItMatters}</p>
                        </div>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-all">
                           Got it! üëç
                        </button>
                     </div>
                  </div>
               )}

               {/* Result Modal */}
               {showResult && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md w-full">
                        <div className="text-center mb-4">
                           <span className={`text-5xl ${isCorrect ? '' : ''}`}>{isCorrect ? '‚úÖ' : '‚ùå'}</span>
                           <h3 className={`text-xl font-bold mt-2 ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                              {isCorrect ? 'Correct!' : 'Not Quite'}
                           </h3>
                           {isCorrect && streak > 1 && (
                              <p className="text-amber-400 text-sm mt-1">üî• {streak} streak!</p>
                           )}
                        </div>

                        <div className={`rounded-lg p-4 mb-4 border ${isCorrect ? 'bg-green-900/30 border-green-500/30' : 'bg-red-900/30 border-red-500/30'}`}>
                           <p className="text-slate-200">{scenario.explanation}</p>
                        </div>

                        <div className="bg-black/30 rounded-lg p-3 mb-4">
                           <p className="text-xs text-blue-400 font-bold mb-1">WHY IT BALANCES:</p>
                           <p className="text-sm text-slate-300">{scenario.whyItBalances}</p>
                        </div>

                        <div className="bg-indigo-900/30 rounded-lg p-3 mb-4 border border-indigo-500/30">
                           <p className="text-xs text-indigo-400 font-bold mb-1">üåç REAL-WORLD:</p>
                           <p className="text-sm text-slate-300">{scenario.realWorld}</p>
                        </div>

                        <button
                           onClick={nextScenario}
                           className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-all"
                        >
                           {currentScenario < scenarios[currentLevel].length - 1
                              ? 'Next Transaction ‚Üí'
                              : currentLevel < levels.length - 1
                                 ? 'Next Level! üéâ'
                                 : 'See Results üìä'}
                        </button>
                     </div>
                  </div>
               )}

               {/* Header */}
               <div className="p-3 bg-black/30 border-b border-blue-500/30">
                  <div className="flex justify-between items-center mb-2">
                     <span className="font-bold text-blue-300">{levels[currentLevel].name}</span>
                     <div className="flex items-center gap-3">
                        <span className="text-xs bg-purple-600/50 px-2 py-1 rounded-full">
                           Score: {score}
                        </span>
                        {streak > 0 && (
                           <span className="text-xs bg-amber-600/50 px-2 py-1 rounded-full">
                              üî• {streak}
                           </span>
                        )}
                     </div>
                  </div>
                  <div className="flex gap-1">
                     {scenarios[currentLevel].map((_, idx) => (
                        <div
                           key={idx}
                           className={`flex-1 h-1 rounded-full ${
                              idx < currentScenario ? 'bg-green-500' :
                              idx === currentScenario ? 'bg-blue-500' : 'bg-slate-600'
                           }`}
                        />
                     ))}
                  </div>
               </div>

               {/* Main Content */}
               <div className="flex-1 p-4 overflow-y-auto">
                  {/* Transaction Description */}
                  <div className="bg-indigo-900/30 rounded-xl p-4 mb-4 border border-indigo-500/30">
                     <div className="flex items-center justify-between mb-2">
                        <span className="text-xs text-indigo-400 font-bold">TRANSACTION:</span>
                        <button
                           onClick={() => setShowHint(!showHint)}
                           className="text-xs text-indigo-400 hover:text-indigo-300 underline"
                        >
                           {showHint ? 'Hide Hint' : 'Show Hint'}
                        </button>
                     </div>
                     <p className="text-lg font-medium text-white">{scenario.description}</p>
                     {showHint && (
                        <div className="mt-3 p-3 bg-black/30 rounded-lg">
                           <p className="text-sm text-amber-300">
                              üí° {scenario.account1.name} is a {scenario.account1.type} account.
                              {scenario.account2.name} is a {scenario.account2.type} account.
                              {scenario.account1.type === 'asset' || scenario.account1.type === 'expense'
                                 ? ' Assets & Expenses increase with DEBIT.'
                                 : ' Liabilities, Equity & Revenue increase with CREDIT.'}
                           </p>
                        </div>
                     )}
                  </div>

                  {/* T-Accounts */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                     {/* Account 1 */}
                     <div className="bg-black/30 rounded-xl overflow-hidden border border-blue-500/30">
                        <div className="bg-blue-600/50 px-3 py-2 flex items-center justify-between">
                           <span className="font-bold text-sm">{scenario.account1.name}</span>
                           <button
                              onClick={() => { setInfoTopic(scenario.account1.type + 's'); setShowInfo(true); }}
                              className="text-xs opacity-70 hover:opacity-100"
                           >
                              ‚ÑπÔ∏è
                           </button>
                        </div>
                        <div className="text-xs text-center py-1 text-slate-400 bg-black/20">
                           ({scenario.account1.type.charAt(0).toUpperCase() + scenario.account1.type.slice(1)} Account)
                        </div>
                        <div className="flex divide-x divide-blue-500/30">
                           {/* Debit Side */}
                           <div
                              className={`flex-1 p-3 min-h-[80px] flex flex-col items-center justify-center transition-all ${
                                 placements.account1Debit ? 'bg-green-900/30' : 'hover:bg-blue-800/30'
                              }`}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop('account1Debit')}
                           >
                              <div className="text-xs text-green-400 font-bold mb-1 flex items-center gap-1">
                                 DEBIT
                                 <button onClick={() => { setInfoTopic('debit'); setShowInfo(true); }} className="opacity-60 hover:opacity-100">‚ÑπÔ∏è</button>
                              </div>
                              {placements.account1Debit ? (
                                 <div className="text-lg font-bold text-green-400">${placements.account1Debit.toLocaleString()}</div>
                              ) : (
                                 <div className="text-xs text-slate-500 text-center">Drop here</div>
                              )}
                           </div>
                           {/* Credit Side */}
                           <div
                              className={`flex-1 p-3 min-h-[80px] flex flex-col items-center justify-center transition-all ${
                                 placements.account1Credit ? 'bg-amber-900/30' : 'hover:bg-blue-800/30'
                              }`}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop('account1Credit')}
                           >
                              <div className="text-xs text-amber-400 font-bold mb-1 flex items-center gap-1">
                                 CREDIT
                                 <button onClick={() => { setInfoTopic('credit'); setShowInfo(true); }} className="opacity-60 hover:opacity-100">‚ÑπÔ∏è</button>
                              </div>
                              {placements.account1Credit ? (
                                 <div className="text-lg font-bold text-amber-400">${placements.account1Credit.toLocaleString()}</div>
                              ) : (
                                 <div className="text-xs text-slate-500 text-center">Drop here</div>
                              )}
                           </div>
                        </div>
                     </div>

                     {/* Account 2 */}
                     <div className="bg-black/30 rounded-xl overflow-hidden border border-blue-500/30">
                        <div className="bg-blue-600/50 px-3 py-2 flex items-center justify-between">
                           <span className="font-bold text-sm">{scenario.account2.name}</span>
                           <button
                              onClick={() => { setInfoTopic(scenario.account2.type + 's'); setShowInfo(true); }}
                              className="text-xs opacity-70 hover:opacity-100"
                           >
                              ‚ÑπÔ∏è
                           </button>
                        </div>
                        <div className="text-xs text-center py-1 text-slate-400 bg-black/20">
                           ({scenario.account2.type.charAt(0).toUpperCase() + scenario.account2.type.slice(1)} Account)
                        </div>
                        <div className="flex divide-x divide-blue-500/30">
                           {/* Debit Side */}
                           <div
                              className={`flex-1 p-3 min-h-[80px] flex flex-col items-center justify-center transition-all ${
                                 placements.account2Debit ? 'bg-green-900/30' : 'hover:bg-blue-800/30'
                              }`}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop('account2Debit')}
                           >
                              <div className="text-xs text-green-400 font-bold mb-1">DEBIT</div>
                              {placements.account2Debit ? (
                                 <div className="text-lg font-bold text-green-400">${placements.account2Debit.toLocaleString()}</div>
                              ) : (
                                 <div className="text-xs text-slate-500 text-center">Drop here</div>
                              )}
                           </div>
                           {/* Credit Side */}
                           <div
                              className={`flex-1 p-3 min-h-[80px] flex flex-col items-center justify-center transition-all ${
                                 placements.account2Credit ? 'bg-amber-900/30' : 'hover:bg-blue-800/30'
                              }`}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop('account2Credit')}
                           >
                              <div className="text-xs text-amber-400 font-bold mb-1">CREDIT</div>
                              {placements.account2Credit ? (
                                 <div className="text-lg font-bold text-amber-400">${placements.account2Credit.toLocaleString()}</div>
                              ) : (
                                 <div className="text-xs text-slate-500 text-center">Drop here</div>
                              )}
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Draggable Items */}
                  <div className="bg-black/30 rounded-xl p-4 mb-4 border border-purple-500/30">
                     <p className="text-xs text-purple-400 font-bold mb-3 text-center">DRAG TO THE CORRECT SIDE:</p>
                     <div className="flex justify-center gap-4">
                        <div
                           draggable
                           onDragStart={() => setDraggedItem({ type: 'increase', amount: scenario.amount })}
                           onDragEnd={() => setDraggedItem(null)}
                           className="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl cursor-move hover:scale-105 transition-transform shadow-lg"
                        >
                           <div className="flex items-center gap-2">
                              <span className="text-lg">üí∞</span>
                              <span className="font-bold">${scenario.amount.toLocaleString()}</span>
                              <span className="text-green-200">‚Üë</span>
                           </div>
                           <div className="text-xs text-green-200 text-center">(Increase)</div>
                        </div>
                        <div
                           draggable
                           onDragStart={() => setDraggedItem({ type: 'decrease', amount: scenario.amount })}
                           onDragEnd={() => setDraggedItem(null)}
                           className="px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 rounded-xl cursor-move hover:scale-105 transition-transform shadow-lg"
                        >
                           <div className="flex items-center gap-2">
                              <span className="text-lg">üí∞</span>
                              <span className="font-bold">${scenario.amount.toLocaleString()}</span>
                              <span className="text-amber-200">‚Üì</span>
                           </div>
                           <div className="text-xs text-amber-200 text-center">(Decrease)</div>
                        </div>
                     </div>
                  </div>

                  {/* Balance Check */}
                  <div className="bg-black/30 rounded-xl p-3 mb-4">
                     <div className="flex items-center justify-between">
                        <div className="text-center flex-1">
                           <div className="text-xs text-green-400 font-bold">Total Debits</div>
                           <div className="text-lg font-bold text-green-400">
                              ${((placements.account1Debit || 0) + (placements.account2Debit || 0) + runningDebits).toLocaleString()}
                           </div>
                        </div>
                        <div className="px-4">
                           {(placements.account1Debit || 0) + (placements.account2Debit || 0) ===
                            (placements.account1Credit || 0) + (placements.account2Credit || 0) &&
                            ((placements.account1Debit || 0) + (placements.account2Debit || 0)) > 0 ? (
                              <span className="text-2xl text-green-400">=</span>
                           ) : (placements.account1Debit || placements.account1Credit || placements.account2Debit || placements.account2Credit) ? (
                              <span className="text-2xl text-red-400">‚â†</span>
                           ) : (
                              <span className="text-2xl text-slate-500">=</span>
                           )}
                        </div>
                        <div className="text-center flex-1">
                           <div className="text-xs text-amber-400 font-bold">Total Credits</div>
                           <div className="text-lg font-bold text-amber-400">
                              ${((placements.account1Credit || 0) + (placements.account2Credit || 0) + runningCredits).toLocaleString()}
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Coach Message */}
                  {coachMessage && (
                     <div className="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/30">
                        <div className="flex items-start gap-2">
                           <span className="text-lg">üí¨</span>
                           <p className="text-sm text-indigo-200">{coachMessage}</p>
                        </div>
                     </div>
                  )}
               </div>

               {/* Footer Actions */}
               <div className="p-3 bg-black/30 border-t border-blue-500/30 flex gap-2">
                  <button
                     onClick={resetPlacements}
                     className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-all"
                  >
                     üîÑ Reset
                  </button>
                  <button
                     onClick={() => { setInfoTopic('balance'); setShowInfo(true); }}
                     className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-all"
                  >
                     ‚ÑπÔ∏è Rules
                  </button>
                  <button
                     onClick={checkAnswer}
                     disabled={!placements.account1Debit && !placements.account1Credit && !placements.account2Debit && !placements.account2Credit}
                     className="flex-1 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:opacity-50 rounded-lg font-bold transition-all"
                  >
                     Check Answer ‚úì
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: RESULT PHASE
      // ============================================================
      if (phase === 'result') {
         const accuracy = totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0;

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  {/* Success Header */}
                  <div className="text-center mb-6">
                     <div className="text-6xl mb-3">üéì</div>
                     <h1 className="text-2xl font-black mb-2">SESSION COMPLETE!</h1>
                     <p className="text-blue-300">You've practiced double-entry bookkeeping</p>
                  </div>

                  {/* Score Card */}
                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <div className="grid grid-cols-3 gap-3 text-center">
                        <div className="bg-purple-900/50 rounded-lg p-3">
                           <p className="text-2xl font-bold text-purple-400">{score}</p>
                           <p className="text-xs text-slate-300">SCORE</p>
                        </div>
                        <div className="bg-green-900/50 rounded-lg p-3">
                           <p className="text-2xl font-bold text-green-400">{accuracy}%</p>
                           <p className="text-xs text-slate-300">ACCURACY</p>
                        </div>
                        <div className="bg-amber-900/50 rounded-lg p-3">
                           <p className="text-2xl font-bold text-amber-400">{bestStreak}</p>
                           <p className="text-xs text-slate-300">BEST STREAK</p>
                        </div>
                     </div>
                  </div>

                  {/* Key Insight */}
                  <div className="bg-gradient-to-r from-purple-900/50 to-indigo-900/50 rounded-xl p-5 mb-6 border border-purple-500/30">
                     <h3 className="font-bold text-purple-300 mb-3 flex items-center gap-2">
                        <span className="text-xl">üí°</span> KEY INSIGHT
                     </h3>
                     <p className="text-lg text-white mb-4 leading-relaxed">
                        Debits and credits are NOT good or bad‚Äîthey're just <span className="text-green-400 font-bold">LEFT</span> and <span className="text-amber-400 font-bold">RIGHT</span>.
                        The trick is knowing which side increases each account type.
                     </p>
                     <div className="grid grid-cols-2 gap-3 text-sm">
                        <div className="bg-green-900/30 rounded-lg p-3">
                           <p className="font-bold text-green-400 mb-1">DEBIT to Increase:</p>
                           <p className="text-slate-300">Assets & Expenses</p>
                        </div>
                        <div className="bg-amber-900/30 rounded-lg p-3">
                           <p className="font-bold text-amber-400 mb-1">CREDIT to Increase:</p>
                           <p className="text-slate-300">Liabilities, Equity, Revenue</p>
                        </div>
                     </div>
                  </div>

                  {/* Concepts Learned */}
                  {conceptsLearned.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-green-300 mb-3">‚úÖ Concepts You Practiced</h3>
                        <div className="flex flex-wrap gap-2">
                           {conceptsLearned.map((concept, idx) => (
                              <span key={idx} className="px-3 py-1 bg-green-600/30 rounded-full text-sm text-green-300 capitalize">
                                 {concept} Accounts
                              </span>
                           ))}
                        </div>
                     </div>
                  )}

                  {/* Areas for Review */}
                  {mistakePatterns.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-amber-300 mb-3">üìö Review These Areas</h3>
                        <div className="flex flex-wrap gap-2">
                           {mistakePatterns.map((pattern, idx) => (
                              <span key={idx} className="px-3 py-1 bg-amber-600/30 rounded-full text-sm text-amber-300 capitalize">
                                 {pattern} Accounts
                              </span>
                           ))}
                        </div>
                     </div>
                  )}

                  {/* Real-World Application */}
                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <h3 className="font-bold text-blue-300 mb-2 flex items-center gap-2">
                        <span>üåç</span> REAL-WORLD APPLICATION
                     </h3>
                     <p className="text-slate-200">
                        If your books don't balance (debits ‚â† credits), you've made an error.
                        This is how accountants catch mistakes‚Äîand how auditors catch fraud.
                        Every transaction in every company follows these exact rules.
                     </p>
                  </div>

                  {/* AI Coach Sync */}
                  <div className="bg-indigo-900/30 rounded-xl p-4 border border-indigo-500/30">
                     <h3 className="font-bold text-indigo-300 mb-2 flex items-center gap-2">
                        <span>ü§ñ</span> Session Synced with AI Coach
                     </h3>
                     <p className="text-sm text-slate-300">
                        Your learning session has been logged. Ask your AI coach to review your performance,
                        explain any concepts you found tricky, or give you more practice scenarios.
                     </p>
                  </div>
               </div>

               {/* Action Buttons */}
               <div className="p-4 bg-black/30 border-t border-blue-500/30 flex gap-3">
                  <button
                     onClick={() => {
                        setPhase('intro');
                        setCurrentLevel(0);
                        setCurrentScenario(0);
                        setScore(0);
                        setStreak(0);
                        setCorrectAttempts(0);
                        setTotalAttempts(0);
                        setRunningDebits(0);
                        setRunningCredits(0);
                        setConceptsLearned([]);
                        setMistakePatterns([]);
                        setGameLog([]);
                     }}
                     className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all"
                  >
                     üîÑ Play Again
                  </button>
                  <button
                     onClick={() => setPhase('intro')}
                     className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-all"
                  >
                     ‚û°Ô∏è Continue
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   // ============================================================================
   // GAAP COMPLIANCE CHECKER INTERACTIVE SIMULATION
   // Generally Accepted Accounting Principles - The Rules of Financial Reporting
   // Features: Scenario-based decisions, principle reference, coaching, AI sync
   // ============================================================================
   const GAAPComplianceRenderer = () => {
      // ============================================================
      // PHASE & UI STATE
      // ============================================================
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);

      // ============================================================
      // GAME STATE
      // ============================================================
      const [currentScenario, setCurrentScenario] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<'compliant' | 'violation' | null>(null);
      const [showResult, setShowResult] = useState(false);
      const [score, setScore] = useState(0);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);
      const [streak, setStreak] = useState(0);

      // ============================================================
      // LEARNING TRACKING
      // ============================================================
      const [principlesMastered, setPrinciplesMastered] = useState<string[]>([]);
      const [principlesStruggled, setPrinciplesStruggled] = useState<string[]>([]);
      const [showPrincipleReference, setShowPrincipleReference] = useState(false);

      // ============================================================
      // COACHING STATE
      // ============================================================
      const [coachMessage, setCoachMessage] = useState<string>('');

      // ============================================================
      // AI COACH SYNC - GAME LOG
      // ============================================================
      const [gameLog, setGameLog] = useState<string[]>([]);

      // ============================================================
      // GAAP PRINCIPLES REFERENCE
      // ============================================================
      const gaapPrinciples: Record<string, { name: string; description: string; example: string; whyItMatters: string; icon: string }> = {
         revenue_recognition: {
            name: 'Revenue Recognition',
            description: 'Revenue should be recognized when it is EARNED and REALIZABLE, not necessarily when cash is received. For services, this means when the service is performed.',
            example: 'A gym sells a 12-month membership for $1,200 upfront. They should recognize $100/month over 12 months, not $1,200 immediately.',
            whyItMatters: 'Prevents companies from inflating current revenue by recording future earnings now. This was a major issue in the Enron scandal.',
            icon: 'üìà'
         },
         matching_principle: {
            name: 'Matching Principle',
            description: 'Expenses should be recorded in the SAME PERIOD as the revenues they helped generate. This connects costs to the benefits they produce.',
            example: 'If you pay $12,000 for a year of insurance in January, you expense $1,000/month - matching the cost to each months protection.',
            whyItMatters: 'Ensures profit calculations are meaningful by matching what you earned with what it cost to earn it.',
            icon: '‚öñÔ∏è'
         },
         historical_cost: {
            name: 'Historical Cost',
            description: 'Assets are recorded at their ORIGINAL purchase price, not current market value. This provides objectivity and verifiability.',
            example: 'Land bought for $100,000 in 1990 is still recorded at $100,000, even if its now worth $500,000.',
            whyItMatters: 'Market values are subjective and fluctuate. Historical cost provides a reliable, verifiable number.',
            icon: 'üè∑Ô∏è'
         },
         full_disclosure: {
            name: 'Full Disclosure',
            description: 'Financial statements must include ALL information that would affect a users understanding. Material information cannot be hidden.',
            example: 'A pending lawsuit that could cost millions must be disclosed in the notes, even if not yet resolved.',
            whyItMatters: 'Investors and creditors need complete information to make decisions. Hidden risks can cause massive losses.',
            icon: 'üìã'
         },
         consistency: {
            name: 'Consistency',
            description: 'Companies must use the SAME accounting methods from period to period. Changes require disclosure and justification.',
            example: 'If you use FIFO for inventory this year, you cant switch to LIFO next year just because it looks better.',
            whyItMatters: 'Allows meaningful comparison of financial statements over time. Prevents manipulation by switching methods.',
            icon: 'üîÑ'
         },
         conservatism: {
            name: 'Conservatism',
            description: 'When uncertain, choose the option that UNDERSTATES assets/income or OVERSTATES liabilities/expenses. Be cautious, not optimistic.',
            example: 'If inventory might be worth $100K or $80K, record it at $80K.',
            whyItMatters: 'Protects users from overly optimistic financial statements.',
            icon: 'üõ°Ô∏è'
         },
         materiality: {
            name: 'Materiality',
            description: 'Only information that would influence decisions needs strict treatment. Immaterial amounts can be simplified.',
            example: 'A $50 stapler can be expensed immediately rather than depreciated over 5 years.',
            whyItMatters: 'Allows practical application of rules. Not everything needs to be tracked to the penny.',
            icon: 'üìä'
         },
         going_concern: {
            name: 'Going Concern',
            description: 'Financial statements assume the company will continue operating indefinitely, not liquidate soon.',
            example: 'Assets are valued at what theyll generate over time, not fire sale prices.',
            whyItMatters: 'If a company is about to fail, all valuations change dramatically.',
            icon: 'üèÉ'
         }
      };

      // ============================================================
      // SCENARIOS - REAL-WORLD GAAP COMPLIANCE DECISIONS
      // ============================================================
      const scenarios = [
         {
            id: 1, title: 'The Subscription Dilemma',
            context: 'TechCorp sold a 2-year software subscription for $24,000 upfront in January. Their accountant recorded the full $24,000 as revenue in Year 1.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'revenue_recognition',
            explanation: 'This VIOLATES Revenue Recognition. Revenue should be recognized when EARNED. TechCorp should recognize $12,000 per year as the service is delivered.',
            realWorld: 'This exact issue caused major problems for software companies in the 1990s.',
            impact: 'Recording all revenue upfront would overstate Year 1 profits by $12,000.'
         },
         {
            id: 2, title: 'The Insurance Expense',
            context: 'A company paid $36,000 on January 1st for a 3-year insurance policy. They recorded the entire $36,000 as an expense in Year 1.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'matching_principle',
            explanation: 'This VIOLATES Matching. The insurance provides benefit over 3 years, so expense should be spread: $12,000 per year.',
            realWorld: 'Prepaid expenses like insurance, rent must be allocated over their useful periods.',
            impact: 'Expensing everything now would understate Year 1 profits by $24,000.'
         },
         {
            id: 3, title: 'The Appreciated Land',
            context: 'A company bought land for $500,000 in 2010. In 2024, an appraisal shows its worth $2,000,000. They updated the balance sheet to $2,000,000.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'historical_cost',
            explanation: 'This VIOLATES Historical Cost under US GAAP. Assets must remain at original purchase price. The land should stay at $500,000.',
            realWorld: 'Note: IFRS allows revaluation. This is a key GAAP vs IFRS difference.',
            impact: 'Recording appreciation would overstate assets by $1.5M.'
         },
         {
            id: 4, title: 'The Hidden Lawsuit',
            context: 'A company is being sued for $5 million. Lawyers say 60% chance theyll lose. They decided not to mention this in financial statements.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'full_disclosure',
            explanation: 'This VIOLATES Full Disclosure. A probable loss of this size is MATERIAL and must be disclosed, plus they should record a liability.',
            realWorld: 'Hiding material litigation has led to massive securities fraud cases.',
            impact: 'Investors might buy stock not knowing about a $5M potential liability.'
         },
         {
            id: 5, title: 'The Method Switch',
            context: 'A company used FIFO for inventory for 10 years. This year, they switched to LIFO without any disclosure because it reduces taxes.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'consistency',
            explanation: 'This VIOLATES Consistency. Changing methods requires justification, full disclosure, and restatement of prior periods.',
            realWorld: 'Companies must disclose method changes in footnotes.',
            impact: 'Silent method changes make financial statements incomparable.'
         },
         {
            id: 6, title: 'The Optimistic Valuation',
            context: 'Inventory cost $100,000. Market suggests it might sell for $80,000 or maybe $110,000. They recorded it at $110,000.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'conservatism',
            explanation: 'This VIOLATES Conservatism. When uncertain, use the LOWER value. Inventory should be at $80,000 or kept at cost.',
            realWorld: 'Lower of Cost or Market rule requires writedowns when market drops below cost.',
            impact: 'Overstating inventory overstates assets and net income.'
         },
         {
            id: 7, title: 'The Proper Depreciation',
            context: 'A company bought a delivery truck for $50,000 with 5-year useful life. Each year, they record $10,000 in depreciation expense.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'matching_principle',
            explanation: 'This IS GAAP compliant! Straight-line depreciation ($50,000 √∑ 5 years) properly matches expense to revenue periods.',
            realWorld: 'Several depreciation methods are acceptable if consistently applied.',
            impact: 'Proper depreciation ensures each year bears its fair share of asset cost.'
         },
         {
            id: 8, title: 'The Deferred Revenue',
            context: 'A magazine publisher received $120 for 12-month subscription. They recorded it as Unearned Revenue, then recognize $10 each month.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'revenue_recognition',
            explanation: 'This IS GAAP compliant! Revenue is recognized as EARNED (when magazines delivered), not when cash received.',
            realWorld: 'Netflix, Spotify, all subscription companies use this exact treatment.',
            impact: 'This provides accurate monthly revenue reflecting actual delivery.'
         },
         {
            id: 9, title: 'The Contingent Liability',
            context: 'A pending lawsuit has 40% chance of $2M loss. The company disclosed it in footnotes but did not record a liability.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'conservatism',
            explanation: 'This IS GAAP compliant! For contingent liabilities: if PROBABLE (>50%), record it. At 40%, footnote disclosure is correct.',
            realWorld: 'This is from ASC 450 - probability assessment is critical.',
            impact: 'Proper treatment balances disclosure with avoiding premature liability recognition.'
         },
         {
            id: 10, title: 'The Related Party Loan',
            context: 'The CEO borrowed $500,000 from the company at 0% interest. This was not disclosed anywhere in financial statements.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'full_disclosure',
            explanation: 'This VIOLATES Full Disclosure. Related party transactions MUST be disclosed. A 0% loan to executive is especially material.',
            realWorld: 'Hidden related party transactions were central to Enron and WorldCom frauds.',
            impact: 'Shareholders deserve to know if company assets benefit executives personally.'
         },
         {
            id: 11, title: 'The Going Concern Warning',
            context: 'A company lost money for 3 years and may not survive. Auditors added a "going concern" warning and management disclosed the risks.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'going_concern',
            explanation: 'This IS GAAP compliant! When substantial doubt exists about continuing operations, this MUST be disclosed.',
            realWorld: 'Going concern warnings often precede bankruptcies - crucial warning signals.',
            impact: 'This disclosure allows investors to make informed decisions about risk.'
         },
         {
            id: 12, title: 'The Immaterial Error',
            context: 'A $10 billion company found a $500 error from last year. Rather than restating, they adjusted it in current year.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'materiality',
            explanation: 'This IS GAAP compliant! $500 in a $10B company (0.000005%) is clearly immaterial. Current correction is acceptable.',
            realWorld: 'Materiality thresholds are typically 1-5% of relevant metrics.',
            impact: 'Requiring restatement for immaterial amounts would waste resources.'
         },
         {
            id: 13, title: 'The Premature Revenue',
            context: 'A construction company signed a $10M contract in December. Work begins March. They recorded full $10M as revenue in December.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'revenue_recognition',
            explanation: 'This VIOLATES Revenue Recognition. For long-term contracts, revenue is recognized as work performed. Signed contract alone = zero revenue.',
            realWorld: 'Construction firms must use percentage-of-completion or completed-contract methods.',
            impact: 'This would massively overstate current year revenue.'
         },
         {
            id: 14, title: 'The Wage Accrual',
            context: 'Employees earned $50,000 in wages last week of December, paid January 5th. Company recorded Wages Payable and Expense in December.',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'compliant' as const, principle: 'matching_principle',
            explanation: 'This IS GAAP compliant! Matching requires recording expenses when incurred. Work was in December, so expense belongs there.',
            realWorld: 'Year-end accruals for wages, utilities, interest are standard practice.',
            impact: 'Without this accrual, December expenses would be understated.'
         },
         {
            id: 15, title: 'The Revalued Building',
            context: 'A US GAAP company had an appraiser value their building at $5M above book value. They increased it on balance sheet with "Revaluation Surplus."',
            question: 'Is this GAAP compliant?',
            correctAnswer: 'violation' as const, principle: 'historical_cost',
            explanation: 'This VIOLATES US GAAP Historical Cost. Upward revaluation is NOT permitted under US GAAP (though allowed under IFRS).',
            realWorld: 'This is a major GAAP vs IFRS difference.',
            impact: 'Revaluation would overstate assets and equity based on subjective appraisals.'
         }
      ];

      const getCurrentScenario = () => scenarios[currentScenario];

      const checkAnswer = () => {
         const scenario = getCurrentScenario();
         if (!selectedAnswer) return;
         const isCorrect = selectedAnswer === scenario.correctAnswer;
         setShowResult(true);
         setTotalAnswered(prev => prev + 1);
         if (isCorrect) {
            setCorrectAnswers(prev => prev + 1);
            setScore(prev => prev + 100 + (streak * 20));
            setStreak(prev => prev + 1);
            if (!principlesMastered.includes(scenario.principle)) {
               setPrinciplesMastered(prev => [...prev, scenario.principle]);
            }
            setPrinciplesStruggled(prev => prev.filter(p => p !== scenario.principle));
            setGameLog(prev => [...prev, `[CORRECT] ${scenario.title} - ${scenario.principle}`]);
         } else {
            setStreak(0);
            if (!principlesStruggled.includes(scenario.principle)) {
               setPrinciplesStruggled(prev => [...prev, scenario.principle]);
            }
            setGameLog(prev => [...prev, `[INCORRECT] ${scenario.title} - User: ${selectedAnswer}, Correct: ${scenario.correctAnswer}`]);
         }
      };

      const nextScenario = () => {
         setShowResult(false);
         setSelectedAnswer(null);
         if (currentScenario < scenarios.length - 1) {
            setCurrentScenario(prev => prev + 1);
         } else {
            setGameLog(prev => [...prev, `[SESSION COMPLETE] Score: ${score}, Accuracy: ${Math.round((correctAnswers / totalAnswered) * 100)}%`]);
            setPhase('result');
         }
      };

      const startGame = () => { setPhase('tutorial'); setTutorialStep(0); setGameLog(['[SESSION START] GAAP Compliance Checker']); };
      const startPlaying = () => { setPhase('play'); setCoachMessage('Read each scenario carefully. Decide if GAAP compliant or violation.'); };

      const tutorialSteps = [
         { title: 'What is GAAP?', content: 'GAAP (Generally Accepted Accounting Principles) is the set of rules ALL US companies must follow when preparing financial statements.', visual: 'intro' },
         { title: 'Why GAAP Matters', content: 'Without GAAP, companies could report finances however they wanted. GAAP ensures consistency, reliability, and comparability.', visual: 'why' },
         { title: 'Core Principles', content: 'Key principles: Revenue Recognition, Matching, Historical Cost, Full Disclosure, Consistency, Conservatism.', visual: 'principles' },
         { title: 'How to Play', content: 'Review real-world scenarios. Decide if each is GAAP COMPLIANT or VIOLATION. Use the principle reference anytime!', visual: 'play' }
      ];

      // INTRO PHASE
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-900 via-zinc-900 to-neutral-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  <div className="text-center mb-6">
                     <div className="text-5xl mb-3">üìã</div>
                     <h1 className="text-2xl font-black mb-2">GAAP COMPLIANCE CHECKER</h1>
                     <p className="text-xl font-bold text-amber-400">Master the Rules of Financial Reporting</p>
                  </div>
                  <div className="bg-black/30 rounded-2xl p-5 mb-6 border border-amber-500/30">
                     <p className="text-lg text-center leading-relaxed">
                        <span className="text-amber-400 font-bold">GAAP</span> ensures all companies report finances
                        <span className="text-green-400 font-bold"> the same way</span> ‚Äî making it possible to compare Apple to Microsoft.
                     </p>
                  </div>
                  <div className="bg-gradient-to-r from-amber-800/30 to-orange-800/30 rounded-xl p-4 mb-6">
                     <h2 className="font-bold text-amber-300 mb-2">üéØ WHY THIS MATTERS</h2>
                     <p className="text-slate-200">Without GAAP, companies could manipulate their finances. GAAP creates a "common language" that prevents manipulation.</p>
                  </div>
                  <div className="bg-black/20 rounded-xl p-4 mb-6 border border-slate-500/30">
                     <h2 className="font-bold text-slate-300 mb-3">üìö KEY PRINCIPLES</h2>
                     <div className="grid grid-cols-2 gap-2">
                        {Object.entries(gaapPrinciples).slice(0, 6).map(([key, p]) => (
                           <div key={key} className="flex items-center gap-2 text-sm bg-black/30 rounded-lg p-2">
                              <span>{p.icon}</span><span className="text-slate-300">{p.name}</span>
                           </div>
                        ))}
                     </div>
                  </div>
               </div>
               <div className="p-4 bg-black/30 border-t border-amber-500/30">
                  <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 rounded-xl font-bold text-lg transition-all">
                     ‚ñ∂Ô∏è START LEARNING
                  </button>
               </div>
            </div>
         );
      }

      // TUTORIAL PHASE
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-900 via-zinc-900 to-neutral-900 text-white overflow-hidden">
               <div className="p-3 bg-black/30 border-b border-amber-500/30">
                  <div className="flex items-center justify-between mb-2">
                     <span className="text-sm text-amber-300">Understanding GAAP</span>
                     <span className="text-sm text-slate-400">{tutorialStep + 1} of {tutorialSteps.length}</span>
                  </div>
                  <div className="h-2 bg-black/30 rounded-full overflow-hidden">
                     <div className="h-full bg-gradient-to-r from-amber-500 to-orange-500 transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} />
                  </div>
               </div>
               <div className="flex-1 p-6 overflow-y-auto">
                  <h2 className="text-xl font-bold text-amber-300 mb-4 text-center">{step.title}</h2>
                  <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-amber-500/30">
                     {step.visual === 'intro' && <div className="text-6xl text-center mb-4">üìã üìä üèõÔ∏è</div>}
                     {step.visual === 'why' && <div className="flex justify-center gap-4 mb-4"><div className="p-4 bg-blue-900/30 rounded-lg text-center"><div className="text-3xl">üçé</div><div className="text-sm text-blue-300">Apple</div></div><div className="text-3xl flex items-center">‚öñÔ∏è</div><div className="p-4 bg-green-900/30 rounded-lg text-center"><div className="text-3xl">ü™ü</div><div className="text-sm text-green-300">Microsoft</div></div></div>}
                     {step.visual === 'principles' && <div className="grid grid-cols-2 gap-3 mb-4">{['üìà Revenue', '‚öñÔ∏è Matching', 'üè∑Ô∏è Cost', 'üìã Disclosure'].map((p, i) => <div key={i} className="bg-amber-900/30 rounded-lg p-3 text-center text-sm text-amber-300">{p}</div>)}</div>}
                     {step.visual === 'play' && <div className="flex justify-center gap-4 mb-4"><div className="px-6 py-3 bg-green-600/50 rounded-lg font-bold">‚úì COMPLIANT</div><div className="px-6 py-3 bg-red-600/50 rounded-lg font-bold">‚úó VIOLATION</div></div>}
                     <p className="text-center text-slate-200">{step.content}</p>
                  </div>
               </div>
               <div className="p-4 bg-black/30 border-t border-amber-500/30 flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(prev => prev - 1)} className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">‚Üê Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(prev => prev + 1) : startPlaying()} className="flex-1 py-3 bg-gradient-to-r from-amber-600 to-orange-600 rounded-xl font-bold">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Checking! üîç'}
                  </button>
               </div>
            </div>
         );
      }

      // PLAY PHASE
      if (phase === 'play') {
         const scenario = getCurrentScenario();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-900 via-zinc-900 to-neutral-900 text-white overflow-hidden">
               {/* Info Modal */}
               {showInfo && infoTopic && gaapPrinciples[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-3 mb-3">
                           <span className="text-3xl">{gaapPrinciples[infoTopic].icon}</span>
                           <h3 className="text-lg font-bold text-amber-400">{gaapPrinciples[infoTopic].name}</h3>
                        </div>
                        <p className="text-slate-200 mb-4">{gaapPrinciples[infoTopic].description}</p>
                        <div className="bg-black/30 rounded-lg p-3 mb-3">
                           <p className="text-xs text-amber-400 font-bold mb-1">EXAMPLE:</p>
                           <p className="text-sm text-slate-300">{gaapPrinciples[infoTopic].example}</p>
                        </div>
                        <div className="bg-amber-900/30 rounded-lg p-3 mb-4 border border-amber-500/30">
                           <p className="text-xs text-amber-400 font-bold mb-1">WHY IT MATTERS:</p>
                           <p className="text-sm text-slate-300">{gaapPrinciples[infoTopic].whyItMatters}</p>
                        </div>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="w-full py-2 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold">Got it! üëç</button>
                     </div>
                  </div>
               )}

               {/* Principle Reference Panel */}
               {showPrincipleReference && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setShowPrincipleReference(false)}>
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-lg max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-amber-400 mb-4">üìö GAAP Principles Reference</h3>
                        <div className="space-y-3">
                           {Object.entries(gaapPrinciples).map(([key, p]) => (
                              <button key={key} onClick={() => { setInfoTopic(key); setShowInfo(true); setShowPrincipleReference(false); }} className="w-full text-left p-3 bg-black/30 hover:bg-amber-900/30 rounded-lg">
                                 <div className="flex items-center gap-3">
                                    <span className="text-2xl">{p.icon}</span>
                                    <div><div className="font-bold text-amber-300">{p.name}</div><div className="text-xs text-slate-400 line-clamp-1">{p.description.substring(0, 50)}...</div></div>
                                 </div>
                              </button>
                           ))}
                        </div>
                        <button onClick={() => setShowPrincipleReference(false)} className="mt-4 w-full py-2 bg-white/10 hover:bg-white/20 rounded-xl font-bold">Close</button>
                     </div>
                  </div>
               )}

               {/* Result Modal */}
               {showResult && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="text-center mb-4">
                           <span className="text-5xl">{selectedAnswer === scenario.correctAnswer ? '‚úÖ' : '‚ùå'}</span>
                           <h3 className={`text-xl font-bold mt-2 ${selectedAnswer === scenario.correctAnswer ? 'text-green-400' : 'text-red-400'}`}>
                              {selectedAnswer === scenario.correctAnswer ? 'Correct!' : 'Not Quite'}
                           </h3>
                           {selectedAnswer === scenario.correctAnswer && streak > 1 && <p className="text-amber-400 text-sm">üî• {streak} streak!</p>}
                        </div>
                        <div className="flex justify-center mb-4">
                           <span className={`px-4 py-2 rounded-full font-bold ${scenario.correctAnswer === 'compliant' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                              {scenario.correctAnswer === 'compliant' ? '‚úì GAAP COMPLIANT' : '‚úó GAAP VIOLATION'}
                           </span>
                        </div>
                        <div className="bg-amber-900/30 rounded-lg p-3 mb-4 border border-amber-500/30">
                           <div className="flex items-center gap-2 mb-2">
                              <span className="text-xl">{gaapPrinciples[scenario.principle].icon}</span>
                              <span className="font-bold text-amber-400">{gaapPrinciples[scenario.principle].name}</span>
                              <button onClick={() => { setInfoTopic(scenario.principle); setShowInfo(true); }} className="ml-auto text-xs text-amber-400">‚ÑπÔ∏è</button>
                           </div>
                        </div>
                        <div className="bg-slate-700/50 rounded-lg p-4 mb-4 border border-slate-500/30">
                           <p className="text-slate-200">{scenario.explanation}</p>
                        </div>
                        <div className="bg-black/30 rounded-lg p-3 mb-4">
                           <p className="text-xs text-blue-400 font-bold mb-1">üåç REAL-WORLD:</p>
                           <p className="text-sm text-slate-300">{scenario.realWorld}</p>
                        </div>
                        <div className="bg-purple-900/30 rounded-lg p-3 mb-4 border border-purple-500/30">
                           <p className="text-xs text-purple-400 font-bold mb-1">üìä IMPACT:</p>
                           <p className="text-sm text-slate-300">{scenario.impact}</p>
                        </div>
                        <button onClick={nextScenario} className="w-full py-3 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold">
                           {currentScenario < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'See Results üìä'}
                        </button>
                     </div>
                  </div>
               )}

               {/* Header */}
               <div className="p-3 bg-black/30 border-b border-amber-500/30">
                  <div className="flex justify-between items-center mb-2">
                     <span className="font-bold text-amber-300">GAAP Compliance Check</span>
                     <div className="flex items-center gap-3">
                        <span className="text-xs bg-amber-600/50 px-2 py-1 rounded-full">Score: {score}</span>
                        {streak > 0 && <span className="text-xs bg-orange-600/50 px-2 py-1 rounded-full">üî• {streak}</span>}
                     </div>
                  </div>
                  <div className="flex gap-1">
                     {scenarios.map((_, idx) => (
                        <div key={idx} className={`flex-1 h-1 rounded-full ${idx < currentScenario ? 'bg-green-500' : idx === currentScenario ? 'bg-amber-500' : 'bg-slate-600'}`} />
                     ))}
                  </div>
                  <div className="text-xs text-slate-400 mt-1 text-center">Scenario {currentScenario + 1} of {scenarios.length}</div>
               </div>

               {/* Main Content */}
               <div className="flex-1 p-4 overflow-y-auto">
                  <div className="bg-black/30 rounded-xl p-4 mb-4 border border-slate-500/30">
                     <div className="flex items-center justify-between mb-3">
                        <h3 className="font-bold text-lg text-white">{scenario.title}</h3>
                        <button onClick={() => setShowPrincipleReference(true)} className="text-xs text-amber-400 hover:text-amber-300 underline">üìö Reference</button>
                     </div>
                     <div className="bg-slate-800/50 rounded-lg p-4 mb-4">
                        <p className="text-slate-200 leading-relaxed">{scenario.context}</p>
                     </div>
                     <div className="bg-amber-900/20 rounded-lg p-3 border border-amber-500/30">
                        <p className="text-amber-300 font-medium text-center">{scenario.question}</p>
                     </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <button onClick={() => setSelectedAnswer('compliant')} className={`p-4 rounded-xl font-bold transition-all border-2 ${selectedAnswer === 'compliant' ? 'bg-green-600 border-green-400 scale-105' : 'bg-green-900/30 border-green-500/30 hover:bg-green-900/50'}`}>
                        <div className="text-2xl mb-1">‚úì</div>
                        <div className="text-green-300">COMPLIANT</div>
                        <div className="text-xs text-green-400/70">Follows GAAP</div>
                     </button>
                     <button onClick={() => setSelectedAnswer('violation')} className={`p-4 rounded-xl font-bold transition-all border-2 ${selectedAnswer === 'violation' ? 'bg-red-600 border-red-400 scale-105' : 'bg-red-900/30 border-red-500/30 hover:bg-red-900/50'}`}>
                        <div className="text-2xl mb-1">‚úó</div>
                        <div className="text-red-300">VIOLATION</div>
                        <div className="text-xs text-red-400/70">Breaks GAAP</div>
                     </button>
                  </div>

                  <div className="bg-black/20 rounded-xl p-3">
                     <p className="text-xs text-slate-400 font-bold mb-2">QUICK REFERENCE:</p>
                     <div className="flex flex-wrap gap-2">
                        {Object.entries(gaapPrinciples).slice(0, 6).map(([key, p]) => (
                           <button key={key} onClick={() => { setInfoTopic(key); setShowInfo(true); }} className="px-2 py-1 bg-slate-700/50 hover:bg-amber-900/30 rounded text-xs text-slate-300 flex items-center gap-1">
                              <span>{p.icon}</span><span>{p.name}</span>
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="p-3 bg-black/30 border-t border-amber-500/30 flex gap-2">
                  <button onClick={() => setShowPrincipleReference(true)} className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium">üìö Principles</button>
                  <button onClick={checkAnswer} disabled={!selectedAnswer} className="flex-1 py-2 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-600 disabled:opacity-50 rounded-lg font-bold">Submit Answer ‚úì</button>
               </div>
            </div>
         );
      }

      // RESULT PHASE
      if (phase === 'result') {
         const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-slate-900 via-zinc-900 to-neutral-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  <div className="text-center mb-6">
                     <div className="text-6xl mb-3">üéì</div>
                     <h1 className="text-2xl font-black mb-2">SESSION COMPLETE!</h1>
                     <p className="text-amber-300">GAAP Compliance Checker Complete</p>
                  </div>
                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <div className="grid grid-cols-3 gap-3 text-center">
                        <div className="bg-amber-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-amber-400">{score}</p><p className="text-xs text-slate-300">SCORE</p></div>
                        <div className="bg-green-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-green-400">{accuracy}%</p><p className="text-xs text-slate-300">ACCURACY</p></div>
                        <div className="bg-purple-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-purple-400">{correctAnswers}/{totalAnswered}</p><p className="text-xs text-slate-300">CORRECT</p></div>
                     </div>
                  </div>
                  <div className="bg-gradient-to-r from-amber-900/50 to-orange-900/50 rounded-xl p-5 mb-6 border border-amber-500/30">
                     <h3 className="font-bold text-amber-300 mb-3">üí° KEY INSIGHT</h3>
                     <p className="text-lg text-white mb-4">GAAP exists to <span className="text-amber-400 font-bold">prevent manipulation</span> and <span className="text-green-400 font-bold">enable comparison</span>.</p>
                     <div className="space-y-2 text-sm text-slate-200">
                        <p>‚ñ∏ Revenue Recognition: Record when EARNED</p>
                        <p>‚ñ∏ Matching: Connect expenses to revenues</p>
                        <p>‚ñ∏ Conservatism: When uncertain, be cautious</p>
                     </div>
                  </div>
                  {principlesMastered.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-green-300 mb-3">‚úÖ Principles Mastered</h3>
                        <div className="flex flex-wrap gap-2">
                           {principlesMastered.map((p, i) => <span key={i} className="px-3 py-1 bg-green-600/30 rounded-full text-sm text-green-300">{gaapPrinciples[p]?.icon} {gaapPrinciples[p]?.name}</span>)}
                        </div>
                     </div>
                  )}
                  {principlesStruggled.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-amber-300 mb-3">üìö Review These</h3>
                        <div className="flex flex-wrap gap-2">
                           {principlesStruggled.map((p, i) => <button key={i} onClick={() => { setInfoTopic(p); setShowInfo(true); }} className="px-3 py-1 bg-amber-600/30 hover:bg-amber-600/50 rounded-full text-sm text-amber-300">{gaapPrinciples[p]?.icon} {gaapPrinciples[p]?.name}</button>)}
                        </div>
                     </div>
                  )}
                  <div className="bg-indigo-900/30 rounded-xl p-4 border border-indigo-500/30">
                     <h3 className="font-bold text-indigo-300 mb-2">ü§ñ Session Synced with AI Coach</h3>
                     <p className="text-sm text-slate-300">Ask your AI coach to review specific principles or test you on advanced cases.</p>
                  </div>
               </div>

               {showInfo && infoTopic && gaapPrinciples[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-3 mb-3">
                           <span className="text-3xl">{gaapPrinciples[infoTopic].icon}</span>
                           <h3 className="text-lg font-bold text-amber-400">{gaapPrinciples[infoTopic].name}</h3>
                        </div>
                        <p className="text-slate-200 mb-4">{gaapPrinciples[infoTopic].description}</p>
                        <div className="bg-black/30 rounded-lg p-3 mb-3">
                           <p className="text-xs text-amber-400 font-bold mb-1">EXAMPLE:</p>
                           <p className="text-sm text-slate-300">{gaapPrinciples[infoTopic].example}</p>
                        </div>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="w-full py-2 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold">Got it! üëç</button>
                     </div>
                  </div>
               )}

               <div className="p-4 bg-black/30 border-t border-amber-500/30 flex gap-3">
                  <button onClick={() => { setPhase('intro'); setCurrentScenario(0); setScore(0); setCorrectAnswers(0); setTotalAnswered(0); setStreak(0); setPrinciplesMastered([]); setPrinciplesStruggled([]); setGameLog([]); setSelectedAnswer(null); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Play Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold">‚û°Ô∏è Continue</button>
               </div>
            </div>
         );
      }

      return null;
   };

   // ============================================================================
   // GAAP vs IFRS COMPARISON INTERACTIVE SIMULATION
   // Understanding the differences between US GAAP and International Standards
   // Features: Side-by-side comparison, impact analysis, prediction challenges
   // ============================================================================
   const GAAPvsIFRSRenderer = () => {
      // ============================================================
      // PHASE & UI STATE
      // ============================================================
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);

      // ============================================================
      // GAME STATE
      // ============================================================
      const [currentTopic, setCurrentTopic] = useState(0);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [showResult, setShowResult] = useState(false);
      const [score, setScore] = useState(0);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);

      // ============================================================
      // LEARNING TRACKING
      // ============================================================
      const [topicsExplored, setTopicsExplored] = useState<string[]>([]);
      const [conceptsStruggled, setConceptsStruggled] = useState<string[]>([]);

      // ============================================================
      // AI COACH SYNC
      // ============================================================
      const [gameLog, setGameLog] = useState<string[]>([]);

      // ============================================================
      // KEY DIFFERENCES DATA
      // ============================================================
      const differences = [
         {
            id: 'inventory',
            topic: 'Inventory Valuation',
            icon: 'üì¶',
            gaap: {
               rule: 'LIFO Allowed',
               description: 'US GAAP allows LIFO (Last-In, First-Out), FIFO, and weighted average methods.',
               example: 'During inflation, LIFO shows lower profits and lower taxes.'
            },
            ifrs: {
               rule: 'LIFO NOT Allowed',
               description: 'IFRS prohibits LIFO. Only FIFO and weighted average are permitted.',
               example: 'Companies must use FIFO or average, often showing higher profits during inflation.'
            },
            impact: {
               scenario: 'A company has inventory purchased at $80, $90, and $100. They sell one unit for $150.',
               gaapResult: { inventory: 170, cogs: 100, profit: 50 },
               ifrsResult: { inventory: 190, cogs: 80, profit: 70 },
               explanation: 'Under GAAP with LIFO, the $100 item (last in) is sold first. Under IFRS with FIFO, the $80 item (first in) is sold first.'
            },
            whyDifferent: 'The US allows LIFO for tax benefits during inflation. Most other countries prioritize showing the actual flow of goods.',
            realWorld: 'US companies like Caterpillar and Exxon use LIFO to reduce taxes. If they switched to IFRS, their reported profits would increase significantly.'
         },
         {
            id: 'development',
            topic: 'R&D Costs',
            icon: 'üî¨',
            gaap: {
               rule: 'Expense All R&D',
               description: 'Research AND development costs must be expensed immediately (with limited software exceptions).',
               example: 'A pharma company spends $50M on drug development - all expensed in current year.'
            },
            ifrs: {
               rule: 'Capitalize Development',
               description: 'Research costs are expensed, but development costs CAN be capitalized if criteria are met.',
               example: 'Same pharma company can capitalize $30M of development costs as an asset.'
            },
            impact: {
               scenario: 'TechCorp spent $10M on research and $20M on development for a new product.',
               gaapResult: { assets: 0, expense: 30, profit: -30 },
               ifrsResult: { assets: 20, expense: 10, profit: -10 },
               explanation: 'GAAP expenses everything. IFRS can capitalize development costs that meet feasibility criteria.'
            },
            whyDifferent: 'GAAP emphasizes conservatism and reliability. IFRS aims to better match costs with future revenues from the developed product.',
            realWorld: 'Tech and pharma companies operating internationally often show very different profits depending on which standard they use.'
         },
         {
            id: 'revaluation',
            topic: 'Asset Revaluation',
            icon: 'üè¢',
            gaap: {
               rule: 'Historical Cost Only',
               description: 'Property, plant & equipment must stay at historical cost minus depreciation. No upward revaluation.',
               example: 'Building bought for $1M in 2000 stays at book value even if worth $5M today.'
            },
            ifrs: {
               rule: 'Revaluation Allowed',
               description: 'Companies can choose to revalue assets to fair market value periodically.',
               example: 'Same building can be revalued to $5M, with gain going to equity.'
            },
            impact: {
               scenario: 'A company owns a building: Cost $2M, Current Value $5M, Accumulated Depreciation $500K.',
               gaapResult: { bookValue: 1.5, equity: 0, assets: 1.5 },
               ifrsResult: { bookValue: 5.0, equity: 3.5, assets: 5.0 },
               explanation: 'GAAP shows $1.5M (cost minus depreciation). IFRS can show $5M with $3.5M revaluation surplus in equity.'
            },
            whyDifferent: 'GAAP prioritizes objectivity and verifiability. IFRS believes fair value provides more relevant information.',
            realWorld: 'Real estate companies in Europe often show much higher asset values than US counterparts due to revaluation.'
         },
         {
            id: 'impairment',
            topic: 'Impairment Reversal',
            icon: 'üìâ',
            gaap: {
               rule: 'No Reversal Allowed',
               description: 'Once an asset is written down for impairment, the writedown is permanent. Cannot be reversed.',
               example: 'Equipment impaired by $100K stays impaired even if value recovers.'
            },
            ifrs: {
               rule: 'Reversal Allowed',
               description: 'Impairment losses can be reversed (except for goodwill) if conditions improve.',
               example: 'If equipment value recovers, the impairment can be reversed up to original cost.'
            },
            impact: {
               scenario: 'Equipment cost $500K, impaired to $300K last year. This year, value recovered to $450K.',
               gaapResult: { bookValue: 300, currentYearGain: 0 },
               ifrsResult: { bookValue: 450, currentYearGain: 150 },
               explanation: 'GAAP keeps it at $300K. IFRS can reverse up to $150K, increasing assets and income.'
            },
            whyDifferent: 'GAAP is more conservative - once written down, stay down. IFRS allows reflection of improved conditions.',
            realWorld: 'During economic recoveries, IFRS companies can show significant gains from impairment reversals that GAAP companies cannot.'
         },
         {
            id: 'leases',
            topic: 'Lease Classification',
            icon: 'üîë',
            gaap: {
               rule: 'Finance vs Operating',
               description: 'Leases classified as Finance or Operating based on specific bright-line tests (>75% life, >90% value, etc.).',
               example: 'A 7-year lease on 10-year equipment (70%) might be Operating under GAAP.'
            },
            ifrs: {
               rule: 'Single Model (Mostly)',
               description: 'Nearly all leases go on balance sheet. Less distinction between types. Principles-based.',
               example: 'Same 7-year lease would likely go on balance sheet under IFRS 16.'
            },
            impact: {
               scenario: 'Company leases equipment: 7-year term, 10-year asset life, $100K annual payments.',
               gaapResult: { onBalance: 'Maybe', debtRatio: 'Lower if Operating' },
               ifrsResult: { onBalance: 'Yes', debtRatio: 'Higher (more liabilities shown)' },
               explanation: 'IFRS puts more leases on the balance sheet, increasing both assets and liabilities.'
            },
            whyDifferent: 'GAAP has more specific rules allowing some leases to stay off-balance-sheet. IFRS 16 requires most leases on balance sheet.',
            realWorld: 'Airlines and retailers with many leases often show very different debt ratios under GAAP vs IFRS.'
         },
         {
            id: 'revenue',
            topic: 'Revenue Recognition',
            icon: 'üí∞',
            gaap: {
               rule: 'ASC 606 (Detailed)',
               description: 'Very detailed industry-specific guidance with many rules and interpretations.',
               example: 'Specific rules for software, construction, franchises, etc.'
            },
            ifrs: {
               rule: 'IFRS 15 (Principles)',
               description: 'Same 5-step model as GAAP but more principles-based with less detailed guidance.',
               example: 'More judgment required, fewer specific industry rules.'
            },
            impact: {
               scenario: 'Software company sells license + 2 years support for $120K bundled.',
               gaapResult: { approach: 'Detailed allocation rules per ASC 606', notes: 'Specific guidance available' },
               ifrsResult: { approach: 'Principles-based allocation', notes: 'More judgment required' },
               explanation: 'Both use 5-step model but GAAP has more prescriptive guidance for specific situations.'
            },
            whyDifferent: 'These standards have converged significantly, but GAAP retains more industry-specific rules from legacy standards.',
            realWorld: 'Revenue recognition is now largely converged, but differences remain in specific applications.'
         }
      ];

      // ============================================================
      // QUIZ QUESTIONS FOR EACH TOPIC
      // ============================================================
      const quizQuestions = [
         // Inventory
         {
            topicId: 'inventory',
            question: 'During high inflation, which standard typically shows HIGHER reported profits?',
            options: ['US GAAP (with LIFO)', 'IFRS (without LIFO)', 'They show the same', 'Depends on the company'],
            correct: 1,
            explanation: 'IFRS requires FIFO or average cost. During inflation, older (cheaper) inventory is sold first, resulting in lower COGS and higher profits. GAAP companies using LIFO sell newer (expensive) inventory first, showing lower profits.'
         },
         {
            topicId: 'inventory',
            question: 'A US company using LIFO wants to list on the London Stock Exchange (IFRS required). What must they do?',
            options: ['Keep using LIFO', 'Switch to FIFO or weighted average', 'Use LIFO but disclose it', 'Apply for an exemption'],
            correct: 1,
            explanation: 'IFRS prohibits LIFO entirely. The company must switch to an allowed method, which will likely increase their reported inventory value and profits.'
         },
         // Development costs
         {
            topicId: 'development',
            question: 'A tech company spent $5M on research and $15M on development. Under IFRS, what could appear as an asset?',
            options: ['$0', '$5M', '$15M (if criteria met)', '$20M'],
            correct: 2,
            explanation: 'Under IFRS, research is always expensed, but development costs CAN be capitalized if specific criteria are met (technical feasibility, intent to complete, etc.). Up to $15M could be an asset.'
         },
         {
            topicId: 'development',
            question: 'Why does GAAP require expensing all R&D immediately?',
            options: ['To match international standards', 'For tax benefits', 'Due to uncertainty about future benefits', 'To increase reported profits'],
            correct: 2,
            explanation: 'GAAP takes a conservative approach - since future benefits from R&D are uncertain, it requires immediate expensing. This prevents overstating assets based on uncertain outcomes.'
         },
         // Asset revaluation
         {
            topicId: 'revaluation',
            question: 'A European company (IFRS) and US company (GAAP) own identical buildings bought for $10M, now worth $25M. Which shows higher total assets?',
            options: ['US company (GAAP)', 'European company (IFRS)', 'Same assets', 'Cannot determine'],
            correct: 1,
            explanation: 'The IFRS company can revalue the building to $25M. The GAAP company must keep it at historical cost minus depreciation. The IFRS company will show significantly higher assets.'
         },
         {
            topicId: 'revaluation',
            question: 'Where does the revaluation gain go under IFRS when an asset is written up?',
            options: ['Income Statement as revenue', 'Directly to Retained Earnings', 'Revaluation Surplus in Equity', 'Reduce Liabilities'],
            correct: 2,
            explanation: 'Revaluation gains go to "Revaluation Surplus" in the equity section of the balance sheet, not through the income statement (unless reversing a previous impairment loss).'
         },
         // Impairment
         {
            topicId: 'impairment',
            question: 'Equipment was impaired from $500K to $300K. Later it recovered to $450K. What does GAAP show?',
            options: ['$300K (no reversal allowed)', '$450K (partial reversal)', '$500K (full reversal)', '$400K (average)'],
            correct: 0,
            explanation: 'US GAAP prohibits reversal of impairment losses. Once written down to $300K, it stays at $300K regardless of recovery. Only IFRS allows reversal.'
         },
         {
            topicId: 'impairment',
            question: 'Which type of asset can NEVER have impairment reversed under IFRS?',
            options: ['Equipment', 'Buildings', 'Goodwill', 'Inventory'],
            correct: 2,
            explanation: 'Under IFRS, goodwill impairment can never be reversed. This is one area where IFRS and GAAP agree - goodwill writedowns are permanent under both standards.'
         },
         // Leases
         {
            topicId: 'leases',
            question: 'After IFRS 16, what happens to most operating leases?',
            options: ['Remain off-balance sheet', 'Go on the balance sheet', 'Become finance leases', 'Are eliminated'],
            correct: 1,
            explanation: 'IFRS 16 requires nearly all leases (except short-term and low-value) to be recognized on the balance sheet, increasing both assets and liabilities for lessees.'
         },
         {
            topicId: 'leases',
            question: 'Which financial ratio is most affected by putting leases on balance sheet?',
            options: ['Gross Margin', 'Debt-to-Equity Ratio', 'Revenue Growth', 'Tax Rate'],
            correct: 1,
            explanation: 'When leases go on the balance sheet, both assets (right-of-use) and liabilities (lease liability) increase. This increases the debt-to-equity ratio significantly.'
         },
         // Revenue
         {
            topicId: 'revenue',
            question: 'What is the main difference between ASC 606 (GAAP) and IFRS 15 in revenue recognition?',
            options: ['Completely different models', 'GAAP is more principles-based', 'GAAP has more detailed guidance', 'IFRS requires faster recognition'],
            correct: 2,
            explanation: 'Both use the same 5-step model and are largely converged. However, GAAP (ASC 606) has more detailed, industry-specific guidance, while IFRS 15 is more principles-based.'
         },
         {
            topicId: 'revenue',
            question: 'The 5-step revenue recognition model is used by:',
            options: ['Only US GAAP', 'Only IFRS', 'Both GAAP and IFRS', 'Neither - they use different models'],
            correct: 2,
            explanation: 'Revenue recognition is one area where GAAP and IFRS have largely converged. Both use the same 5-step model: identify contract, identify obligations, determine price, allocate price, recognize revenue.'
         }
      ];

      // ============================================================
      // HELPER FUNCTIONS
      // ============================================================
      const getCurrentDifference = () => differences[currentTopic];
      const getQuestionsForTopic = (topicId: string) => quizQuestions.filter(q => q.topicId === topicId);
      const getCurrentQuestionData = () => {
         const topicQuestions = getQuestionsForTopic(differences[currentTopic].id);
         return topicQuestions[currentQuestion];
      };

      const checkAnswer = () => {
         const question = getCurrentQuestionData();
         if (selectedAnswer === null) return;

         const isCorrect = selectedAnswer === question.correct;
         setShowResult(true);
         setTotalAnswered(prev => prev + 1);

         if (isCorrect) {
            setCorrectAnswers(prev => prev + 1);
            setScore(prev => prev + 100);
            setGameLog(prev => [...prev, `[CORRECT] ${question.question.substring(0, 50)}...`]);
         } else {
            if (!conceptsStruggled.includes(differences[currentTopic].id)) {
               setConceptsStruggled(prev => [...prev, differences[currentTopic].id]);
            }
            setGameLog(prev => [...prev, `[INCORRECT] ${question.question.substring(0, 50)}... User: ${selectedAnswer}, Correct: ${question.correct}`]);
         }
      };

      const nextQuestion = () => {
         setShowResult(false);
         setSelectedAnswer(null);

         const topicQuestions = getQuestionsForTopic(differences[currentTopic].id);

         if (currentQuestion < topicQuestions.length - 1) {
            setCurrentQuestion(prev => prev + 1);
         } else if (currentTopic < differences.length - 1) {
            // Move to next topic
            if (!topicsExplored.includes(differences[currentTopic].id)) {
               setTopicsExplored(prev => [...prev, differences[currentTopic].id]);
            }
            setCurrentTopic(prev => prev + 1);
            setCurrentQuestion(0);
         } else {
            // Completed all
            setTopicsExplored(prev => [...prev, differences[currentTopic].id]);
            setGameLog(prev => [...prev, `[SESSION COMPLETE] Score: ${score}, Topics: ${topicsExplored.length + 1}`]);
            setPhase('result');
         }
      };

      const selectTopic = (index: number) => {
         setCurrentTopic(index);
         setCurrentQuestion(0);
         setPhase('play');
      };

      const startGame = () => {
         setPhase('tutorial');
         setTutorialStep(0);
         setGameLog(['[SESSION START] GAAP vs IFRS Comparison']);
      };

      const startPlaying = () => {
         setPhase('play');
      };

      const tutorialSteps = [
         { title: 'Two Accounting Languages', content: 'US companies use GAAP. Most other countries (140+) use IFRS. Same transaction, potentially different numbers!', visual: 'intro' },
         { title: 'Why They Differ', content: 'GAAP is more rules-based (specific guidance). IFRS is more principles-based (judgment required). Neither is "wrong."', visual: 'why' },
         { title: 'Key Differences', content: 'Major differences in: Inventory (LIFO), R&D costs, Asset revaluation, Impairment reversal, and Lease accounting.', visual: 'differences' },
         { title: 'How to Play', content: 'Explore each difference side-by-side. See the financial impact. Answer questions to test your understanding!', visual: 'play' }
      ];

      // ============================================================
      // INFO TOPICS
      // ============================================================
      const infoTopics: Record<string, { title: string; content: string; example: string }> = {
         gaap: { title: 'US GAAP', content: 'Generally Accepted Accounting Principles used by US public companies. More rules-based with specific guidance.', example: 'SEC requires US-listed companies to use GAAP.' },
         ifrs: { title: 'IFRS', content: 'International Financial Reporting Standards used by 140+ countries. More principles-based with room for judgment.', example: 'EU, Australia, Canada, and most of Asia use IFRS.' },
         convergence: { title: 'Convergence Efforts', content: 'FASB and IASB have worked to align standards, achieving convergence in revenue recognition and leases.', example: 'ASC 606 and IFRS 15 are nearly identical 5-step models.' }
      };

      // ============================================================
      // RENDER: INTRO PHASE
      // ============================================================
      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  <div className="text-center mb-6">
                     <div className="text-5xl mb-3">üåç</div>
                     <h1 className="text-2xl font-black mb-2">GAAP vs IFRS</h1>
                     <p className="text-xl font-bold text-sky-300">Same Company, Different Numbers</p>
                  </div>

                  <div className="bg-black/30 rounded-2xl p-5 mb-6 border border-sky-500/30">
                     <div className="flex justify-center items-center gap-4 mb-4">
                        <div className="text-center p-3 bg-blue-900/50 rounded-lg">
                           <div className="text-2xl">üá∫üá∏</div>
                           <div className="text-sm text-blue-300 font-bold">US GAAP</div>
                        </div>
                        <div className="text-2xl">‚â†</div>
                        <div className="text-center p-3 bg-green-900/50 rounded-lg">
                           <div className="text-2xl">üåç</div>
                           <div className="text-sm text-green-300 font-bold">IFRS</div>
                        </div>
                     </div>
                     <p className="text-lg text-center leading-relaxed">
                        The <span className="text-blue-400 font-bold">same company</span> can report
                        <span className="text-amber-400 font-bold"> different profits</span> depending on which standard they use!
                     </p>
                  </div>

                  <div className="bg-gradient-to-r from-sky-800/30 to-blue-800/30 rounded-xl p-4 mb-6">
                     <h2 className="font-bold text-sky-300 mb-2">üéØ WHY THIS MATTERS</h2>
                     <p className="text-slate-200">When comparing international companies, you must understand these differences or you might think one is more profitable when they're actually equal.</p>
                  </div>

                  <div className="bg-black/20 rounded-xl p-4 mb-6 border border-indigo-500/30">
                     <h2 className="font-bold text-indigo-300 mb-3">üìö KEY DIFFERENCES YOU'LL LEARN</h2>
                     <div className="grid grid-cols-2 gap-2">
                        {differences.slice(0, 6).map((d) => (
                           <div key={d.id} className="flex items-center gap-2 text-sm bg-black/30 rounded-lg p-2">
                              <span>{d.icon}</span><span className="text-slate-300">{d.topic}</span>
                           </div>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="p-4 bg-black/30 border-t border-sky-500/30">
                  <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 rounded-xl font-bold text-lg transition-all">
                     ‚ñ∂Ô∏è START LEARNING
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: TUTORIAL PHASE
      // ============================================================
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white overflow-hidden">
               <div className="p-3 bg-black/30 border-b border-sky-500/30">
                  <div className="flex items-center justify-between mb-2">
                     <span className="text-sm text-sky-300">Understanding the Differences</span>
                     <span className="text-sm text-slate-400">{tutorialStep + 1} of {tutorialSteps.length}</span>
                  </div>
                  <div className="h-2 bg-black/30 rounded-full overflow-hidden">
                     <div className="h-full bg-gradient-to-r from-sky-500 to-blue-500 transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} />
                  </div>
               </div>

               <div className="flex-1 p-6 overflow-y-auto">
                  <h2 className="text-xl font-bold text-sky-300 mb-4 text-center">{step.title}</h2>
                  <div className="bg-black/30 rounded-2xl p-6 mb-6 border border-sky-500/30">
                     {step.visual === 'intro' && (
                        <div className="flex justify-center gap-6 mb-4">
                           <div className="text-center p-4 bg-blue-900/50 rounded-lg"><div className="text-4xl mb-2">üá∫üá∏</div><div className="text-blue-300 font-bold">1 Country</div></div>
                           <div className="text-center p-4 bg-green-900/50 rounded-lg"><div className="text-4xl mb-2">üåç</div><div className="text-green-300 font-bold">140+ Countries</div></div>
                        </div>
                     )}
                     {step.visual === 'why' && (
                        <div className="grid grid-cols-2 gap-4 mb-4">
                           <div className="bg-blue-900/30 rounded-lg p-3 text-center"><div className="font-bold text-blue-300 mb-1">GAAP</div><div className="text-xs text-slate-300">Rules-Based</div><div className="text-xs text-slate-400">Specific guidance</div></div>
                           <div className="bg-green-900/30 rounded-lg p-3 text-center"><div className="font-bold text-green-300 mb-1">IFRS</div><div className="text-xs text-slate-300">Principles-Based</div><div className="text-xs text-slate-400">More judgment</div></div>
                        </div>
                     )}
                     {step.visual === 'differences' && (
                        <div className="flex flex-wrap justify-center gap-2 mb-4">
                           {['üì¶ Inventory', 'üî¨ R&D', 'üè¢ Revaluation', 'üìâ Impairment', 'üîë Leases'].map((d, i) => (
                              <span key={i} className="px-3 py-1 bg-sky-900/50 rounded-full text-sm">{d}</span>
                           ))}
                        </div>
                     )}
                     {step.visual === 'play' && (
                        <div className="text-center mb-4">
                           <div className="text-4xl mb-2">üéÆ</div>
                           <div className="flex justify-center gap-2">
                              <span className="px-3 py-1 bg-blue-600/50 rounded-lg text-sm">Explore</span>
                              <span className="px-3 py-1 bg-green-600/50 rounded-lg text-sm">Compare</span>
                              <span className="px-3 py-1 bg-purple-600/50 rounded-lg text-sm">Test</span>
                           </div>
                        </div>
                     )}
                     <p className="text-center text-slate-200">{step.content}</p>
                  </div>
               </div>

               <div className="p-4 bg-black/30 border-t border-sky-500/30 flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(prev => prev - 1)} className="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">‚Üê Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(prev => prev + 1) : startPlaying()} className="flex-1 py-3 bg-gradient-to-r from-sky-600 to-blue-600 rounded-xl font-bold">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Exploring! üîç'}
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: PLAY PHASE
      // ============================================================
      if (phase === 'play') {
         const diff = getCurrentDifference();
         const question = getCurrentQuestionData();
         const topicQuestions = getQuestionsForTopic(diff.id);

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white overflow-hidden">
               {/* Info Modal */}
               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-sky-400 mb-3">{infoTopics[infoTopic].title}</h3>
                        <p className="text-slate-200 mb-4">{infoTopics[infoTopic].content}</p>
                        <div className="bg-black/30 rounded-lg p-3 mb-4">
                           <p className="text-xs text-sky-400 font-bold mb-1">EXAMPLE:</p>
                           <p className="text-sm text-slate-300">{infoTopics[infoTopic].example}</p>
                        </div>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="w-full py-2 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold">Got it!</button>
                     </div>
                  </div>
               )}

               {/* Result Modal */}
               {showResult && question && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                     <div className="bg-slate-800 rounded-2xl p-5 max-w-md w-full">
                        <div className="text-center mb-4">
                           <span className="text-5xl">{selectedAnswer === question.correct ? '‚úÖ' : '‚ùå'}</span>
                           <h3 className={`text-xl font-bold mt-2 ${selectedAnswer === question.correct ? 'text-green-400' : 'text-red-400'}`}>
                              {selectedAnswer === question.correct ? 'Correct!' : 'Not Quite'}
                           </h3>
                        </div>
                        <div className="bg-sky-900/30 rounded-lg p-4 mb-4 border border-sky-500/30">
                           <p className="text-slate-200">{question.explanation}</p>
                        </div>
                        <button onClick={nextQuestion} className="w-full py-3 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold">
                           {currentQuestion < topicQuestions.length - 1 ? 'Next Question ‚Üí' : currentTopic < differences.length - 1 ? 'Next Topic ‚Üí' : 'See Results üìä'}
                        </button>
                     </div>
                  </div>
               )}

               {/* Header */}
               <div className="p-3 bg-black/30 border-b border-sky-500/30">
                  <div className="flex justify-between items-center mb-2">
                     <div className="flex items-center gap-2">
                        <span className="text-xl">{diff.icon}</span>
                        <span className="font-bold text-sky-300">{diff.topic}</span>
                     </div>
                     <span className="text-xs bg-sky-600/50 px-2 py-1 rounded-full">Score: {score}</span>
                  </div>
                  <div className="flex gap-1">
                     {differences.map((_, idx) => (
                        <div key={idx} className={`flex-1 h-1 rounded-full ${idx < currentTopic ? 'bg-green-500' : idx === currentTopic ? 'bg-sky-500' : 'bg-slate-600'}`} />
                     ))}
                  </div>
               </div>

               <div className="flex-1 p-4 overflow-y-auto">
                  {/* Side-by-Side Comparison */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <div className="bg-blue-900/30 rounded-xl p-3 border border-blue-500/30">
                        <div className="flex items-center gap-2 mb-2">
                           <span>üá∫üá∏</span>
                           <span className="font-bold text-blue-300">US GAAP</span>
                           <button onClick={() => { setInfoTopic('gaap'); setShowInfo(true); }} className="ml-auto text-xs opacity-70 hover:opacity-100">‚ÑπÔ∏è</button>
                        </div>
                        <div className="bg-blue-800/30 rounded-lg p-2 mb-2">
                           <p className="text-sm font-bold text-blue-200">{diff.gaap.rule}</p>
                        </div>
                        <p className="text-xs text-slate-300">{diff.gaap.description}</p>
                     </div>
                     <div className="bg-green-900/30 rounded-xl p-3 border border-green-500/30">
                        <div className="flex items-center gap-2 mb-2">
                           <span>üåç</span>
                           <span className="font-bold text-green-300">IFRS</span>
                           <button onClick={() => { setInfoTopic('ifrs'); setShowInfo(true); }} className="ml-auto text-xs opacity-70 hover:opacity-100">‚ÑπÔ∏è</button>
                        </div>
                        <div className="bg-green-800/30 rounded-lg p-2 mb-2">
                           <p className="text-sm font-bold text-green-200">{diff.ifrs.rule}</p>
                        </div>
                        <p className="text-xs text-slate-300">{diff.ifrs.description}</p>
                     </div>
                  </div>

                  {/* Impact Visualization */}
                  <div className="bg-black/30 rounded-xl p-4 mb-4 border border-purple-500/30">
                     <h4 className="font-bold text-purple-300 mb-2 text-sm">üìä FINANCIAL IMPACT</h4>
                     <p className="text-xs text-slate-400 mb-3">{diff.impact.scenario}</p>
                     <div className="grid grid-cols-2 gap-2 text-center">
                        <div className="bg-blue-900/30 rounded-lg p-2">
                           <div className="text-xs text-blue-400 mb-1">GAAP Result</div>
                           {diff.impact.gaapResult.profit !== undefined && (
                              <div className="text-lg font-bold text-blue-300">Profit: ${diff.impact.gaapResult.profit}K</div>
                           )}
                           {diff.impact.gaapResult.bookValue !== undefined && (
                              <div className="text-lg font-bold text-blue-300">Book: ${diff.impact.gaapResult.bookValue}M</div>
                           )}
                        </div>
                        <div className="bg-green-900/30 rounded-lg p-2">
                           <div className="text-xs text-green-400 mb-1">IFRS Result</div>
                           {diff.impact.ifrsResult.profit !== undefined && (
                              <div className="text-lg font-bold text-green-300">Profit: ${diff.impact.ifrsResult.profit}K</div>
                           )}
                           {diff.impact.ifrsResult.bookValue !== undefined && (
                              <div className="text-lg font-bold text-green-300">Book: ${diff.impact.ifrsResult.bookValue}M</div>
                           )}
                        </div>
                     </div>
                     <p className="text-xs text-slate-400 mt-2">{diff.impact.explanation}</p>
                  </div>

                  {/* Quiz Question */}
                  {question && (
                     <div className="bg-black/30 rounded-xl p-4 border border-amber-500/30">
                        <div className="flex items-center justify-between mb-3">
                           <span className="text-xs text-amber-400 font-bold">TEST YOUR UNDERSTANDING</span>
                           <span className="text-xs text-slate-400">Q{currentQuestion + 1}/{topicQuestions.length}</span>
                        </div>
                        <p className="text-sm text-white mb-3">{question.question}</p>
                        <div className="space-y-2">
                           {question.options.map((opt, idx) => (
                              <button
                                 key={idx}
                                 onClick={() => setSelectedAnswer(idx)}
                                 className={`w-full text-left p-3 rounded-lg text-sm transition-all ${
                                    selectedAnswer === idx
                                       ? 'bg-amber-600 border-amber-400 border-2'
                                       : 'bg-slate-700/50 hover:bg-slate-600/50 border border-slate-500/30'
                                 }`}
                              >
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                  )}
               </div>

               {/* Footer */}
               <div className="p-3 bg-black/30 border-t border-sky-500/30 flex gap-2">
                  <button
                     onClick={checkAnswer}
                     disabled={selectedAnswer === null}
                     className="flex-1 py-2 bg-sky-600 hover:bg-sky-500 disabled:bg-slate-600 disabled:opacity-50 rounded-lg font-bold"
                  >
                     Check Answer ‚úì
                  </button>
               </div>
            </div>
         );
      }

      // ============================================================
      // RENDER: RESULT PHASE
      // ============================================================
      if (phase === 'result') {
         const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;

         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-sky-900 via-blue-900 to-indigo-900 text-white overflow-hidden">
               <div className="flex-1 p-6 overflow-y-auto">
                  <div className="text-center mb-6">
                     <div className="text-6xl mb-3">üéì</div>
                     <h1 className="text-2xl font-black mb-2">SESSION COMPLETE!</h1>
                     <p className="text-sky-300">GAAP vs IFRS Comparison Complete</p>
                  </div>

                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <div className="grid grid-cols-3 gap-3 text-center">
                        <div className="bg-sky-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-sky-400">{score}</p><p className="text-xs text-slate-300">SCORE</p></div>
                        <div className="bg-green-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-green-400">{accuracy}%</p><p className="text-xs text-slate-300">ACCURACY</p></div>
                        <div className="bg-purple-900/50 rounded-lg p-3"><p className="text-2xl font-bold text-purple-400">{topicsExplored.length}/{differences.length}</p><p className="text-xs text-slate-300">TOPICS</p></div>
                     </div>
                  </div>

                  <div className="bg-gradient-to-r from-sky-900/50 to-blue-900/50 rounded-xl p-5 mb-6 border border-sky-500/30">
                     <h3 className="font-bold text-sky-300 mb-3">üí° KEY INSIGHT</h3>
                     <p className="text-lg text-white mb-4">
                        The <span className="text-blue-400 font-bold">SAME company</span> can report
                        <span className="text-amber-400 font-bold"> DIFFERENT profits</span> under GAAP vs IFRS.
                        Neither is wrong‚Äîthey're different rule sets.
                     </p>
                     <div className="space-y-2 text-sm text-slate-200">
                        <p>‚ñ∏ LIFO: Allowed in GAAP, prohibited in IFRS</p>
                        <p>‚ñ∏ R&D: GAAP expenses all, IFRS can capitalize development</p>
                        <p>‚ñ∏ Revaluation: GAAP prohibits, IFRS allows upward</p>
                     </div>
                  </div>

                  {topicsExplored.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-green-300 mb-3">‚úÖ Topics Explored</h3>
                        <div className="flex flex-wrap gap-2">
                           {topicsExplored.map((t, i) => {
                              const d = differences.find(x => x.id === t);
                              return <span key={i} className="px-3 py-1 bg-green-600/30 rounded-full text-sm text-green-300">{d?.icon} {d?.topic}</span>;
                           })}
                        </div>
                     </div>
                  )}

                  {conceptsStruggled.length > 0 && (
                     <div className="bg-black/30 rounded-xl p-4 mb-6">
                        <h3 className="font-bold text-amber-300 mb-3">üìö Review These</h3>
                        <div className="flex flex-wrap gap-2">
                           {conceptsStruggled.map((c, i) => {
                              const d = differences.find(x => x.id === c);
                              return <span key={i} className="px-3 py-1 bg-amber-600/30 rounded-full text-sm text-amber-300">{d?.icon} {d?.topic}</span>;
                           })}
                        </div>
                     </div>
                  )}

                  <div className="bg-black/30 rounded-xl p-4 mb-6">
                     <h3 className="font-bold text-blue-300 mb-2">üåç REAL-WORLD APPLICATION</h3>
                     <p className="text-slate-200 text-sm">When comparing a US company (GAAP) to a European company (IFRS), adjust for these differences, or you might think one is more profitable when they're actually equal.</p>
                  </div>

                  <div className="bg-indigo-900/30 rounded-xl p-4 border border-indigo-500/30">
                     <h3 className="font-bold text-indigo-300 mb-2">ü§ñ Session Synced with AI Coach</h3>
                     <p className="text-sm text-slate-300">Ask your AI coach about specific GAAP vs IFRS differences or for help comparing international companies.</p>
                  </div>
               </div>

               <div className="p-4 bg-black/30 border-t border-sky-500/30 flex gap-3">
                  <button onClick={() => { setPhase('intro'); setCurrentTopic(0); setCurrentQuestion(0); setScore(0); setCorrectAnswers(0); setTotalAnswered(0); setTopicsExplored([]); setConceptsStruggled([]); setGameLog([]); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Play Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold">‚û°Ô∏è Continue</button>
               </div>
            </div>
         );
      }

      return null;
   };

   // TOPIC 5: Chart of Accounts Setup - Interactive Educational Game
   const ChartOfAccountsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'subcategory' | 'numbering' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState<{title: string; content: string} | null>(null);
      const [currentLevel, setCurrentLevel] = useState(0);
      const [score, setScore] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [draggedAccount, setDraggedAccount] = useState<string | null>(null);
      const [placedAccounts, setPlacedAccounts] = useState<{[key: string]: string[]}>({
         assets: [], liabilities: [], equity: [], revenue: [], expenses: []
      });
      const [currentAccounts, setCurrentAccounts] = useState<string[]>([]);
      const [feedback, setFeedback] = useState<{show: boolean; correct: boolean; message: string}>({show: false, correct: false, message: ''});
      const [subCategoryPlaced, setSubCategoryPlaced] = useState<{[key: string]: string[]}>({});
      const [numberingAnswers, setNumberingAnswers] = useState<{[key: string]: string}>({});
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptsStruggled, setConceptsStruggled] = useState<string[]>([]);
      const [showHint, setShowHint] = useState(false);

      // Account categories with detailed info
      const categories = {
         assets: {
            name: 'Assets',
            color: 'from-emerald-500 to-green-600',
            bgColor: 'bg-emerald-500/20',
            borderColor: 'border-emerald-500',
            description: 'What the business OWNS - resources with economic value',
            subCategories: ['Current Assets', 'Fixed Assets', 'Intangible Assets'],
            examples: ['Cash', 'Accounts Receivable', 'Inventory', 'Equipment', 'Buildings', 'Patents'],
            numberRange: '1000-1999',
            info: 'Assets are resources controlled by a company that provide future economic benefits. They appear on the left side of the balance sheet and follow the liquidity order - most liquid (cash) first, least liquid (property) last.'
         },
         liabilities: {
            name: 'Liabilities',
            color: 'from-rose-500 to-red-600',
            bgColor: 'bg-rose-500/20',
            borderColor: 'border-rose-500',
            description: 'What the business OWES - obligations to others',
            subCategories: ['Current Liabilities', 'Long-term Liabilities'],
            examples: ['Accounts Payable', 'Loans Payable', 'Wages Payable', 'Bonds Payable'],
            numberRange: '2000-2999',
            info: 'Liabilities are obligations that require the company to transfer assets or provide services in the future. They are listed by maturity - current (due within 1 year) first, then long-term obligations.'
         },
         equity: {
            name: 'Equity',
            color: 'from-violet-500 to-purple-600',
            bgColor: 'bg-violet-500/20',
            borderColor: 'border-violet-500',
            description: "Owner's claim - what's left after liabilities",
            subCategories: ['Contributed Capital', 'Retained Earnings'],
            examples: ['Common Stock', 'Retained Earnings', 'Additional Paid-in Capital', 'Treasury Stock'],
            numberRange: '3000-3999',
            info: 'Equity represents the residual interest in assets after deducting liabilities. It shows how much of the company truly belongs to the owners. The accounting equation: Assets = Liabilities + Equity.'
         },
         revenue: {
            name: 'Revenue',
            color: 'from-sky-500 to-blue-600',
            bgColor: 'bg-sky-500/20',
            borderColor: 'border-sky-500',
            description: 'Money EARNED from business operations',
            subCategories: ['Operating Revenue', 'Non-operating Revenue'],
            examples: ['Sales Revenue', 'Service Revenue', 'Interest Income', 'Rental Income'],
            numberRange: '4000-4999',
            info: 'Revenue is income earned from normal business operations. It increases equity through the income statement. Revenue is recognized when earned (accrual basis), not necessarily when cash is received.'
         },
         expenses: {
            name: 'Expenses',
            color: 'from-amber-500 to-orange-600',
            bgColor: 'bg-amber-500/20',
            borderColor: 'border-amber-500',
            description: 'Costs INCURRED to generate revenue',
            subCategories: ['Operating Expenses', 'Cost of Goods Sold', 'Non-operating Expenses'],
            examples: ['Rent Expense', 'Salaries Expense', 'Utilities Expense', 'Depreciation Expense', 'Interest Expense'],
            numberRange: '5000-9999',
            info: 'Expenses are costs incurred to generate revenue. They decrease equity through the income statement. Expenses are matched to the revenue they help generate (matching principle).'
         }
      };

      // Accounts to categorize at each level
      const levels = [
         {
            name: 'Basic Accounts',
            accounts: [
               { name: 'Cash', category: 'assets', hint: 'Money in hand or bank' },
               { name: 'Accounts Payable', category: 'liabilities', hint: 'Money owed to suppliers' },
               { name: 'Common Stock', category: 'equity', hint: 'Investment by shareholders' },
               { name: 'Sales Revenue', category: 'revenue', hint: 'Income from selling products' },
               { name: 'Rent Expense', category: 'expenses', hint: 'Cost of leasing space' }
            ]
         },
         {
            name: 'Common Business Accounts',
            accounts: [
               { name: 'Accounts Receivable', category: 'assets', hint: 'Money customers owe you' },
               { name: 'Inventory', category: 'assets', hint: 'Products held for sale' },
               { name: 'Wages Payable', category: 'liabilities', hint: 'Salaries owed to employees' },
               { name: 'Retained Earnings', category: 'equity', hint: 'Accumulated profits kept in business' },
               { name: 'Service Revenue', category: 'revenue', hint: 'Income from providing services' },
               { name: 'Utilities Expense', category: 'expenses', hint: 'Cost of electricity, water, etc.' }
            ]
         },
         {
            name: 'Advanced Accounts',
            accounts: [
               { name: 'Prepaid Insurance', category: 'assets', hint: 'Insurance paid in advance' },
               { name: 'Equipment', category: 'assets', hint: 'Machinery used in operations' },
               { name: 'Notes Payable', category: 'liabilities', hint: 'Formal written promise to pay' },
               { name: 'Unearned Revenue', category: 'liabilities', hint: 'Payment received before service delivered' },
               { name: 'Interest Income', category: 'revenue', hint: 'Earnings from lending money' },
               { name: 'Depreciation Expense', category: 'expenses', hint: 'Allocation of asset cost over time' },
               { name: 'Cost of Goods Sold', category: 'expenses', hint: 'Direct cost of products sold' }
            ]
         },
         {
            name: 'Complex Accounts',
            accounts: [
               { name: 'Accumulated Depreciation', category: 'assets', hint: 'Contra-asset reducing equipment value' },
               { name: 'Goodwill', category: 'assets', hint: 'Premium paid for acquired company' },
               { name: 'Bonds Payable', category: 'liabilities', hint: 'Long-term debt securities issued' },
               { name: 'Treasury Stock', category: 'equity', hint: 'Company\'s own repurchased shares' },
               { name: 'Dividend Revenue', category: 'revenue', hint: 'Income from stock investments' },
               { name: 'Amortization Expense', category: 'expenses', hint: 'Spreading intangible asset costs' },
               { name: 'Bad Debt Expense', category: 'expenses', hint: 'Uncollectible customer accounts' }
            ]
         }
      ];

      // Sub-category challenge
      const subCategoryChallenge = {
         assets: [
            { account: 'Cash', subCategory: 'Current Assets', hint: 'Highly liquid, available now' },
            { account: 'Accounts Receivable', subCategory: 'Current Assets', hint: 'Collected within a year' },
            { account: 'Inventory', subCategory: 'Current Assets', hint: 'Sold within normal cycle' },
            { account: 'Equipment', subCategory: 'Fixed Assets', hint: 'Long-term physical asset' },
            { account: 'Buildings', subCategory: 'Fixed Assets', hint: 'Property held for use' },
            { account: 'Patents', subCategory: 'Intangible Assets', hint: 'Non-physical legal right' },
            { account: 'Goodwill', subCategory: 'Intangible Assets', hint: 'Value beyond physical assets' }
         ]
      };

      // Numbering quiz
      const numberingQuiz = [
         { account: 'Cash', correctNumber: '1010', category: 'assets', options: ['1010', '2010', '4010', '5010'] },
         { account: 'Accounts Payable', correctNumber: '2010', category: 'liabilities', options: ['1020', '2010', '3010', '5020'] },
         { account: 'Common Stock', correctNumber: '3010', category: 'equity', options: ['1030', '2030', '3010', '4030'] },
         { account: 'Sales Revenue', correctNumber: '4010', category: 'revenue', options: ['1010', '3010', '4010', '5010'] },
         { account: 'Rent Expense', correctNumber: '5010', category: 'expenses', options: ['2010', '3010', '4010', '5010'] },
         { account: 'Equipment', correctNumber: '1500', category: 'assets', options: ['1500', '2500', '3500', '5500'] },
         { account: 'Bonds Payable', correctNumber: '2500', category: 'liabilities', options: ['1500', '2500', '4500', '5500'] },
         { account: 'Interest Income', correctNumber: '4500', category: 'revenue', options: ['1500', '2500', '4500', '5500'] }
      ];

      const tutorialSteps = [
         {
            title: 'Welcome to Chart of Accounts Setup!',
            content: "The Chart of Accounts is your business's financial filing system. Every transaction gets categorized here, and it determines how your financial statements are generated.",
            highlight: 'overview'
         },
         {
            title: 'The Five Account Categories',
            content: 'Every account falls into one of five categories: Assets (what you own), Liabilities (what you owe), Equity (owner\'s stake), Revenue (money earned), and Expenses (costs incurred).',
            highlight: 'categories'
         },
         {
            title: 'Assets - What You OWN',
            content: 'Assets are resources with economic value. They include cash, receivables, inventory, equipment, and buildings. Assets are numbered 1000-1999 and appear on the Balance Sheet.',
            highlight: 'assets'
         },
         {
            title: 'Liabilities - What You OWE',
            content: 'Liabilities are obligations to pay others. They include accounts payable, loans, and wages owed. Liabilities are numbered 2000-2999 and appear on the Balance Sheet.',
            highlight: 'liabilities'
         },
         {
            title: 'Equity - Owner\'s Stake',
            content: 'Equity is what remains after subtracting liabilities from assets. It includes invested capital and retained earnings. Equity is numbered 3000-3999.',
            highlight: 'equity'
         },
         {
            title: 'Revenue - Money Earned',
            content: 'Revenue is income from business operations - sales, services, interest. It increases equity and appears on the Income Statement. Revenue is numbered 4000-4999.',
            highlight: 'revenue'
         },
         {
            title: 'Expenses - Costs Incurred',
            content: 'Expenses are costs to generate revenue - rent, salaries, utilities. They decrease equity and appear on the Income Statement. Expenses are numbered 5000-9999.',
            highlight: 'expenses'
         },
         {
            title: 'The Numbering System',
            content: 'Account numbers organize your chart: 1000s=Assets, 2000s=Liabilities, 3000s=Equity, 4000s=Revenue, 5000-9000s=Expenses. This makes finding accounts and generating reports easy!',
            highlight: 'numbering'
         },
         {
            title: 'Let\'s Practice!',
            content: 'Now you\'ll categorize accounts by dragging them to the correct category. Start with basic accounts and progress to more complex ones. Use the hint button if you need help!',
            highlight: 'game'
         }
      ];

      const showInfoModal = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const initLevel = (level: number) => {
         const accounts = levels[level].accounts.map(a => a.name);
         setCurrentAccounts(shuffleArray([...accounts]));
         setPlacedAccounts({ assets: [], liabilities: [], equity: [], revenue: [], expenses: [] });
         setFeedback({ show: false, correct: false, message: '' });
      };

      const shuffleArray = (array: string[]) => {
         const shuffled = [...array];
         for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
         }
         return shuffled;
      };

      const handleDrop = (category: string) => {
         if (!draggedAccount) return;

         const accountInfo = levels[currentLevel].accounts.find(a => a.name === draggedAccount);
         if (!accountInfo) return;

         const isCorrect = accountInfo.category === category;

         if (isCorrect) {
            setPlacedAccounts(prev => ({
               ...prev,
               [category]: [...prev[category], draggedAccount]
            }));
            setCurrentAccounts(prev => prev.filter(a => a !== draggedAccount));
            setScore(prev => prev + 10);
            setCorrectAnswers(prev => prev + 1);
            setFeedback({ show: true, correct: true, message: `Correct! ${draggedAccount} is an ${categories[category as keyof typeof categories].name.slice(0, -1)}.` });
            setGameLog(prev => [...prev, `‚úì Correctly placed ${draggedAccount} in ${category}`]);
         } else {
            setFeedback({
               show: true,
               correct: false,
               message: `Not quite. ${draggedAccount} is actually a ${categories[accountInfo.category as keyof typeof categories].name.slice(0, -1)}. ${accountInfo.hint}`
            });
            if (!conceptsStruggled.includes(accountInfo.category)) {
               setConceptsStruggled(prev => [...prev, accountInfo.category]);
            }
            setGameLog(prev => [...prev, `‚úó Incorrectly placed ${draggedAccount} in ${category} (should be ${accountInfo.category})`]);
         }

         setTotalAnswered(prev => prev + 1);
         setDraggedAccount(null);
         setShowHint(false);

         // Check if level complete
         setTimeout(() => {
            if (currentAccounts.length === 1 && isCorrect) {
               if (currentLevel < levels.length - 1) {
                  setCurrentLevel(prev => prev + 1);
                  initLevel(currentLevel + 1);
                  setGameLog(prev => [...prev, `Completed Level ${currentLevel + 1}: ${levels[currentLevel].name}`]);
               } else {
                  setPhase('subcategory');
                  setGameLog(prev => [...prev, 'Moving to Sub-category Challenge']);
               }
            }
            setFeedback({ show: false, correct: false, message: '' });
         }, 1500);
      };

      const handleNumberingAnswer = (account: string, answer: string) => {
         const quiz = numberingQuiz.find(q => q.account === account);
         if (!quiz) return;

         setNumberingAnswers(prev => ({ ...prev, [account]: answer }));
         const isCorrect = answer === quiz.correctNumber;

         if (isCorrect) {
            setScore(prev => prev + 15);
            setCorrectAnswers(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì Correct number for ${account}: ${answer}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó Wrong number for ${account}: ${answer} (correct: ${quiz.correctNumber})`]);
         }
         setTotalAnswered(prev => prev + 1);
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold mb-3">üìä Chart of Accounts Setup</h2>
                  <p className="text-lg text-white/80">Master the foundation of financial organization</p>
               </div>

               <div className="bg-white/10 backdrop-blur rounded-xl p-6 mb-6">
                  <div className="flex items-start gap-3 mb-4">
                     <span className="text-3xl">üí°</span>
                     <div>
                        <h3 className="font-bold text-xl mb-2">Key Insight</h3>
                        <p className="text-white/90">The Chart of Accounts is your business's filing system for money‚Äîorganized correctly, it makes reporting easy; organized poorly, it creates chaos.</p>
                     </div>
                  </div>
               </div>

               <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                        üéØ What You'll Learn
                        <button onClick={() => showInfoModal('Learning Objectives', 'By the end of this module, you\'ll understand how to categorize any business account, organize sub-categories, and use the standard numbering system that accountants use worldwide.')} className="text-sky-400 hover:text-sky-300">‚ÑπÔ∏è</button>
                     </h3>
                     <ul className="space-y-2 text-white/80">
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Five account categories and their purposes</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> How to classify any business account</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Sub-category organization (current vs. fixed)</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Standard numbering system (1000s-9000s)</li>
                     </ul>
                  </div>
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                        üéÆ Game Structure
                        <button onClick={() => showInfoModal('How This Works', 'You\'ll progress through 4 levels of account categorization, then tackle sub-category organization, and finally master the numbering system. Each correct answer earns points!')} className="text-sky-400 hover:text-sky-300">‚ÑπÔ∏è</button>
                     </h3>
                     <ul className="space-y-2 text-white/80">
                        <li className="flex items-center gap-2"><span className="text-emerald-400">1</span> Interactive tutorial</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">2</span> Drag-and-drop categorization (4 levels)</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">3</span> Sub-category challenge</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">4</span> Account numbering quiz</li>
                     </ul>
                  </div>
               </div>

               <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 rounded-xl p-4 mb-6">
                  <h3 className="font-bold mb-2">üìã The Standard Number System</h3>
                  <div className="grid grid-cols-5 gap-2 text-center text-sm">
                     <div className="bg-emerald-500/30 rounded p-2">
                        <div className="font-bold">1000s</div>
                        <div className="text-xs text-white/70">Assets</div>
                     </div>
                     <div className="bg-rose-500/30 rounded p-2">
                        <div className="font-bold">2000s</div>
                        <div className="text-xs text-white/70">Liabilities</div>
                     </div>
                     <div className="bg-violet-500/30 rounded p-2">
                        <div className="font-bold">3000s</div>
                        <div className="text-xs text-white/70">Equity</div>
                     </div>
                     <div className="bg-sky-500/30 rounded p-2">
                        <div className="font-bold">4000s</div>
                        <div className="text-xs text-white/70">Revenue</div>
                     </div>
                     <div className="bg-amber-500/30 rounded p-2">
                        <div className="font-bold">5000-9000</div>
                        <div className="text-xs text-white/70">Expenses</div>
                     </div>
                  </div>
               </div>

               <button
                  onClick={() => setPhase('tutorial')}
                  className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold text-lg transition-all"
               >
                  Start Learning ‚Üí
               </button>

               {showInfo && infoContent && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl p-6 max-w-md">
                        <h3 className="text-xl font-bold mb-3">{infoContent.title}</h3>
                        <p className="text-white/80 mb-4">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold">üìö Tutorial</h2>
                  <div className="text-white/60">Step {tutorialStep + 1} of {tutorialSteps.length}</div>
               </div>

               <div className="w-full bg-white/10 rounded-full h-2 mb-6">
                  <div
                     className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all"
                     style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}
                  />
               </div>

               <div className="bg-white/10 backdrop-blur rounded-xl p-6 mb-6">
                  <h3 className="text-xl font-bold mb-4">{step.title}</h3>
                  <p className="text-lg text-white/90 mb-6">{step.content}</p>

                  {step.highlight === 'categories' && (
                     <div className="grid grid-cols-5 gap-2">
                        {Object.entries(categories).map(([key, cat]) => (
                           <div key={key} className={`${cat.bgColor} rounded-lg p-3 text-center`}>
                              <div className="font-bold text-sm">{cat.name}</div>
                              <div className="text-xs text-white/70 mt-1">{cat.description.split(' ').slice(0, 3).join(' ')}</div>
                           </div>
                        ))}
                     </div>
                  )}

                  {['assets', 'liabilities', 'equity', 'revenue', 'expenses'].includes(step.highlight) && (
                     <div className={`${categories[step.highlight as keyof typeof categories].bgColor} rounded-lg p-4`}>
                        <div className="flex justify-between items-start mb-3">
                           <div>
                              <div className="font-bold text-lg">{categories[step.highlight as keyof typeof categories].name}</div>
                              <div className="text-white/70">{categories[step.highlight as keyof typeof categories].description}</div>
                           </div>
                           <div className="text-right">
                              <div className="font-mono bg-white/20 px-2 py-1 rounded text-sm">
                                 {categories[step.highlight as keyof typeof categories].numberRange}
                              </div>
                           </div>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-3">
                           {categories[step.highlight as keyof typeof categories].examples.slice(0, 4).map((ex, i) => (
                              <span key={i} className="bg-white/20 px-2 py-1 rounded text-sm">{ex}</span>
                           ))}
                        </div>
                     </div>
                  )}

                  {step.highlight === 'numbering' && (
                     <div className="space-y-2">
                        {Object.entries(categories).map(([key, cat]) => (
                           <div key={key} className={`${cat.bgColor} rounded-lg p-3 flex justify-between items-center`}>
                              <span className="font-bold">{cat.name}</span>
                              <span className="font-mono bg-white/20 px-3 py-1 rounded">{cat.numberRange}</span>
                           </div>
                        ))}
                     </div>
                  )}
               </div>

               <div className="flex gap-3">
                  {tutorialStep > 0 && (
                     <button
                        onClick={() => setTutorialStep(prev => prev - 1)}
                        className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold"
                     >
                        ‚Üê Back
                     </button>
                  )}
                  <button
                     onClick={() => {
                        if (tutorialStep < tutorialSteps.length - 1) {
                           setTutorialStep(prev => prev + 1);
                        } else {
                           setPhase('play');
                           initLevel(0);
                           setGameLog(['Started Chart of Accounts game']);
                        }
                     }}
                     className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold"
                  >
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Game ‚Üí'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase - Drag and Drop Categorization
      if (phase === 'play') {
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="text-xl font-bold">Level {currentLevel + 1}: {levels[currentLevel].name}</h2>
                     <p className="text-white/60 text-sm">Drag each account to the correct category</p>
                  </div>
                  <div className="flex items-center gap-4">
                     <div className="bg-white/10 rounded-lg px-3 py-1">
                        <span className="text-white/60 text-sm">Score:</span>
                        <span className="font-bold ml-2">{score}</span>
                     </div>
                     <button onClick={() => showInfoModal('Categories Reference', Object.entries(categories).map(([k, v]) => `${v.name} (${v.numberRange}): ${v.description}`).join('\n\n'))} className="text-sky-400 hover:text-sky-300 text-xl">‚ÑπÔ∏è</button>
                  </div>
               </div>

               {/* Progress bar */}
               <div className="w-full bg-white/10 rounded-full h-2 mb-6">
                  <div
                     className="bg-gradient-to-r from-emerald-500 to-green-500 h-2 rounded-full transition-all"
                     style={{ width: `${((levels[currentLevel].accounts.length - currentAccounts.length) / levels[currentLevel].accounts.length) * 100}%` }}
                  />
               </div>

               {/* Accounts to categorize */}
               <div className="bg-white/5 rounded-xl p-4 mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <h3 className="font-bold">Accounts to Categorize ({currentAccounts.length} remaining)</h3>
                     <button
                        onClick={() => setShowHint(!showHint)}
                        className="text-sm bg-amber-500/30 hover:bg-amber-500/40 px-3 py-1 rounded-lg"
                     >
                        üí° {showHint ? 'Hide' : 'Show'} Hints
                     </button>
                  </div>
                  <div className="flex flex-wrap gap-2">
                     {currentAccounts.map(account => {
                        const accountInfo = levels[currentLevel].accounts.find(a => a.name === account);
                        return (
                           <div
                              key={account}
                              draggable
                              onDragStart={() => setDraggedAccount(account)}
                              onDragEnd={() => setDraggedAccount(null)}
                              className={`px-4 py-2 bg-gradient-to-r from-slate-600 to-slate-700 rounded-lg cursor-grab hover:from-slate-500 hover:to-slate-600 transition-all ${draggedAccount === account ? 'opacity-50 scale-95' : ''}`}
                           >
                              <div className="font-medium">{account}</div>
                              {showHint && accountInfo && (
                                 <div className="text-xs text-white/60 mt-1">{accountInfo.hint}</div>
                              )}
                           </div>
                        );
                     })}
                  </div>
               </div>

               {/* Drop zones */}
               <div className="grid grid-cols-5 gap-2 mb-4">
                  {Object.entries(categories).map(([key, cat]) => (
                     <div
                        key={key}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={() => handleDrop(key)}
                        className={`${cat.bgColor} border-2 ${cat.borderColor} border-dashed rounded-xl p-3 min-h-[180px] transition-all ${draggedAccount ? 'hover:border-solid hover:bg-opacity-40' : ''}`}
                     >
                        <div className="flex justify-between items-center mb-2">
                           <h4 className="font-bold text-sm">{cat.name}</h4>
                           <button onClick={() => showInfoModal(cat.name, cat.info)} className="text-white/60 hover:text-white text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <div className="text-xs text-white/50 mb-2">{cat.numberRange}</div>
                        <div className="space-y-1">
                           {placedAccounts[key].map((account, i) => (
                              <div key={i} className="bg-white/20 rounded px-2 py-1 text-xs">
                                 {account}
                              </div>
                           ))}
                        </div>
                     </div>
                  ))}
               </div>

               {/* Feedback */}
               {feedback.show && (
                  <div className={`p-4 rounded-xl ${feedback.correct ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}>
                     <div className="flex items-center gap-2">
                        <span className="text-xl">{feedback.correct ? '‚úì' : '‚úó'}</span>
                        <span>{feedback.message}</span>
                     </div>
                  </div>
               )}

               {showInfo && infoContent && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl p-6 max-w-md">
                        <h3 className="text-xl font-bold mb-3">{infoContent.title}</h3>
                        <p className="text-white/80 mb-4 whitespace-pre-line">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Sub-category Phase
      if (phase === 'subcategory') {
         const [subItems] = useState(shuffleArray([...subCategoryChallenge.assets]));
         const [currentSubIndex, setCurrentSubIndex] = useState(0);
         const [subPlaced, setSubPlaced] = useState<{[key: string]: string[]}>({
            'Current Assets': [], 'Fixed Assets': [], 'Intangible Assets': []
         });
         const [subFeedback, setSubFeedback] = useState<{show: boolean; correct: boolean; message: string}>({show: false, correct: false, message: ''});

         const handleSubDrop = (subCategory: string) => {
            if (currentSubIndex >= subItems.length) return;

            const item = subItems[currentSubIndex];
            const isCorrect = item.subCategory === subCategory;

            if (isCorrect) {
               setSubPlaced(prev => ({
                  ...prev,
                  [subCategory]: [...prev[subCategory], item.account]
               }));
               setScore(prev => prev + 15);
               setCorrectAnswers(prev => prev + 1);
               setSubFeedback({ show: true, correct: true, message: `Correct! ${item.account} is a ${subCategory}.` });
               setGameLog(prev => [...prev, `‚úì Correctly placed ${item.account} in ${subCategory}`]);
            } else {
               setSubFeedback({
                  show: true,
                  correct: false,
                  message: `Not quite. ${item.account} is actually a ${item.subCategory}. ${item.hint}`
               });
               setGameLog(prev => [...prev, `‚úó Incorrectly placed ${item.account} in ${subCategory}`]);
            }

            setTotalAnswered(prev => prev + 1);

            setTimeout(() => {
               setSubFeedback({ show: false, correct: false, message: '' });
               if (currentSubIndex < subItems.length - 1) {
                  setCurrentSubIndex(prev => prev + 1);
               } else {
                  setPhase('numbering');
                  setGameLog(prev => [...prev, 'Moving to Account Numbering Quiz']);
               }
            }, 1500);
         };

         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="text-xl font-bold">Sub-Category Challenge</h2>
                     <p className="text-white/60 text-sm">Organize assets into sub-categories</p>
                  </div>
                  <div className="bg-white/10 rounded-lg px-3 py-1">
                     <span className="text-white/60 text-sm">Score:</span>
                     <span className="font-bold ml-2">{score}</span>
                  </div>
               </div>

               <div className="w-full bg-white/10 rounded-full h-2 mb-6">
                  <div
                     className="bg-gradient-to-r from-violet-500 to-purple-500 h-2 rounded-full transition-all"
                     style={{ width: `${((currentSubIndex + 1) / subItems.length) * 100}%` }}
                  />
               </div>

               {currentSubIndex < subItems.length && (
                  <div className="bg-white/10 rounded-xl p-6 mb-4 text-center">
                     <div className="text-lg text-white/60 mb-2">Categorize this asset:</div>
                     <div className="text-2xl font-bold">{subItems[currentSubIndex].account}</div>
                     <div className="text-sm text-white/50 mt-2">Hint: {subItems[currentSubIndex].hint}</div>
                  </div>
               )}

               <div className="grid grid-cols-3 gap-4 mb-4">
                  {['Current Assets', 'Fixed Assets', 'Intangible Assets'].map(subCat => (
                     <button
                        key={subCat}
                        onClick={() => handleSubDrop(subCat)}
                        className="bg-emerald-500/20 border-2 border-emerald-500/50 hover:border-emerald-500 rounded-xl p-4 min-h-[150px] transition-all"
                     >
                        <div className="flex justify-between items-center mb-2">
                           <h4 className="font-bold">{subCat}</h4>
                           <button onClick={(e) => { e.stopPropagation(); showInfoModal(subCat, subCat === 'Current Assets' ? 'Assets expected to be converted to cash or used within one year. Examples: Cash, Accounts Receivable, Inventory, Prepaid Expenses.' : subCat === 'Fixed Assets' ? 'Long-term tangible assets used in operations. Also called Property, Plant & Equipment (PP&E). Examples: Land, Buildings, Equipment, Vehicles.' : 'Non-physical assets with value. Examples: Patents, Trademarks, Copyrights, Goodwill, Software.'); }} className="text-white/60 hover:text-white">‚ÑπÔ∏è</button>
                        </div>
                        <div className="space-y-1 text-left">
                           {subPlaced[subCat].map((item, i) => (
                              <div key={i} className="bg-white/20 rounded px-2 py-1 text-sm">{item}</div>
                           ))}
                        </div>
                     </button>
                  ))}
               </div>

               {subFeedback.show && (
                  <div className={`p-4 rounded-xl ${subFeedback.correct ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}>
                     <div className="flex items-center gap-2">
                        <span className="text-xl">{subFeedback.correct ? '‚úì' : '‚úó'}</span>
                        <span>{subFeedback.message}</span>
                     </div>
                  </div>
               )}

               {showInfo && infoContent && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl p-6 max-w-md">
                        <h3 className="text-xl font-bold mb-3">{infoContent.title}</h3>
                        <p className="text-white/80 mb-4">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Numbering Phase
      if (phase === 'numbering') {
         const [currentNumIndex, setCurrentNumIndex] = useState(0);
         const [numFeedback, setNumFeedback] = useState<{show: boolean; correct: boolean; message: string}>({show: false, correct: false, message: ''});

         const handleNumberSelect = (answer: string) => {
            const quiz = numberingQuiz[currentNumIndex];
            const isCorrect = answer === quiz.correctNumber;

            handleNumberingAnswer(quiz.account, answer);

            if (isCorrect) {
               setNumFeedback({ show: true, correct: true, message: `Correct! ${quiz.account} is account ${quiz.correctNumber} (${categories[quiz.category as keyof typeof categories].name} range: ${categories[quiz.category as keyof typeof categories].numberRange}).` });
            } else {
               setNumFeedback({
                  show: true,
                  correct: false,
                  message: `Not quite. ${quiz.account} should be ${quiz.correctNumber}. It's a ${categories[quiz.category as keyof typeof categories].name} account (${categories[quiz.category as keyof typeof categories].numberRange}).`
               });
            }

            setTimeout(() => {
               setNumFeedback({ show: false, correct: false, message: '' });
               if (currentNumIndex < numberingQuiz.length - 1) {
                  setCurrentNumIndex(prev => prev + 1);
               } else {
                  setPhase('result');
                  setGameLog(prev => [...prev, `Game completed! Final score: ${score}`]);
               }
            }, 2000);
         };

         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="text-xl font-bold">Account Numbering Quiz</h2>
                     <p className="text-white/60 text-sm">Select the correct account number</p>
                  </div>
                  <div className="bg-white/10 rounded-lg px-3 py-1">
                     <span className="text-white/60 text-sm">Score:</span>
                     <span className="font-bold ml-2">{score}</span>
                  </div>
               </div>

               <div className="w-full bg-white/10 rounded-full h-2 mb-6">
                  <div
                     className="bg-gradient-to-r from-amber-500 to-orange-500 h-2 rounded-full transition-all"
                     style={{ width: `${((currentNumIndex + 1) / numberingQuiz.length) * 100}%` }}
                  />
               </div>

               <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 rounded-xl p-4 mb-6">
                  <div className="grid grid-cols-5 gap-2 text-center text-sm">
                     {Object.entries(categories).map(([key, cat]) => (
                        <div key={key} className={`${cat.bgColor} rounded p-2`}>
                           <div className="font-bold">{cat.numberRange.split('-')[0]}</div>
                           <div className="text-xs text-white/70">{cat.name}</div>
                        </div>
                     ))}
                  </div>
               </div>

               {currentNumIndex < numberingQuiz.length && (
                  <div className="bg-white/10 rounded-xl p-6 mb-4">
                     <div className="text-lg text-white/60 mb-2">Question {currentNumIndex + 1} of {numberingQuiz.length}</div>
                     <div className="text-xl font-bold mb-4">What account number would you assign to: <span className="text-amber-400">{numberingQuiz[currentNumIndex].account}</span>?</div>

                     <div className="grid grid-cols-2 gap-3">
                        {numberingQuiz[currentNumIndex].options.map(option => (
                           <button
                              key={option}
                              onClick={() => handleNumberSelect(option)}
                              disabled={numFeedback.show}
                              className={`py-3 px-4 rounded-xl font-mono text-lg font-bold transition-all ${
                                 numFeedback.show && option === numberingQuiz[currentNumIndex].correctNumber
                                    ? 'bg-emerald-500 text-white'
                                    : numFeedback.show && numberingAnswers[numberingQuiz[currentNumIndex].account] === option && option !== numberingQuiz[currentNumIndex].correctNumber
                                    ? 'bg-rose-500 text-white'
                                    : 'bg-white/10 hover:bg-white/20'
                              }`}
                           >
                              {option}
                           </button>
                        ))}
                     </div>
                  </div>
               )}

               {numFeedback.show && (
                  <div className={`p-4 rounded-xl ${numFeedback.correct ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}>
                     <div className="flex items-center gap-2">
                        <span className="text-xl">{numFeedback.correct ? '‚úì' : '‚úó'}</span>
                        <span>{numFeedback.message}</span>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
         const grade = accuracy >= 90 ? 'A' : accuracy >= 80 ? 'B' : accuracy >= 70 ? 'C' : accuracy >= 60 ? 'D' : 'F';

         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-6">
                  <div className="text-6xl mb-4">üéâ</div>
                  <h2 className="text-3xl font-bold mb-2">Chart of Accounts Mastered!</h2>
                  <p className="text-white/60">You've completed all challenges</p>
               </div>

               <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-white/10 rounded-xl p-4 text-center">
                     <div className="text-3xl font-bold text-amber-400">{score}</div>
                     <div className="text-white/60">Total Points</div>
                  </div>
                  <div className="bg-white/10 rounded-xl p-4 text-center">
                     <div className="text-3xl font-bold text-emerald-400">{accuracy}%</div>
                     <div className="text-white/60">Accuracy</div>
                  </div>
                  <div className="bg-white/10 rounded-xl p-4 text-center">
                     <div className={`text-3xl font-bold ${grade === 'A' ? 'text-emerald-400' : grade === 'B' ? 'text-sky-400' : grade === 'C' ? 'text-amber-400' : 'text-rose-400'}`}>{grade}</div>
                     <div className="text-white/60">Grade</div>
                  </div>
               </div>

               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                     üí° Key Takeaways
                     <button onClick={() => showInfoModal('Why This Matters', 'A well-organized Chart of Accounts is the foundation of accurate financial reporting. It enables quick transaction categorization, consistent financial statements, and easy auditing.')} className="text-sky-400 hover:text-sky-300 text-sm">‚ÑπÔ∏è</button>
                  </h3>
                  <ul className="space-y-3">
                     <li className="flex items-start gap-3">
                        <span className="text-emerald-400">‚úì</span>
                        <span><strong>5 Categories:</strong> Assets (own), Liabilities (owe), Equity (owner's stake), Revenue (earned), Expenses (costs)</span>
                     </li>
                     <li className="flex items-start gap-3">
                        <span className="text-emerald-400">‚úì</span>
                        <span><strong>Numbering System:</strong> 1000s=Assets, 2000s=Liabilities, 3000s=Equity, 4000s=Revenue, 5000-9000s=Expenses</span>
                     </li>
                     <li className="flex items-start gap-3">
                        <span className="text-emerald-400">‚úì</span>
                        <span><strong>Sub-categories:</strong> Current vs Fixed Assets, Current vs Long-term Liabilities matter for liquidity analysis</span>
                     </li>
                     <li className="flex items-start gap-3">
                        <span className="text-emerald-400">‚úì</span>
                        <span><strong>Real-world Impact:</strong> Proper setup enables automatic financial statement generation</span>
                     </li>
                  </ul>
               </div>

               {conceptsStruggled.length > 0 && (
                  <div className="bg-amber-500/20 border border-amber-500/50 rounded-xl p-4 mb-6">
                     <h3 className="font-bold mb-2">üìö Areas to Review</h3>
                     <p className="text-white/80">You had some difficulty with: {conceptsStruggled.map(c => categories[c as keyof typeof categories].name).join(', ')}. Consider reviewing these categories.</p>
                  </div>
               )}

               <div className="bg-white/5 rounded-xl p-4 mb-6">
                  <h3 className="font-bold mb-2">ü§ñ AI Coach Summary</h3>
                  <p className="text-white/70 text-sm">Session data synced for personalized follow-up. Your coach can reference your performance in future sessions.</p>
                  <div className="mt-2 max-h-24 overflow-y-auto text-xs text-white/50">
                     {gameLog.slice(-5).map((log, i) => <div key={i}>{log}</div>)}
                  </div>
               </div>

               <div className="flex gap-3">
                  <button onClick={() => { setPhase('intro'); setCurrentLevel(0); setScore(0); setTotalAnswered(0); setCorrectAnswers(0); setConceptsStruggled([]); setGameLog([]); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Play Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-bold">‚úì Done</button>
               </div>

               {showInfo && infoContent && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl p-6 max-w-md">
                        <h3 className="text-xl font-bold mb-3">{infoContent.title}</h3>
                        <p className="text-white/80 mb-4">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      return null;
   };

   // TOPIC 6: General Ledger Management - Interactive Educational Game
   const GeneralLedgerRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'explore' | 'audit' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState<{title: string; content: string} | null>(null);
      const [selectedAccount, setSelectedAccount] = useState<string | null>(null);
      const [selectedTransaction, setSelectedTransaction] = useState<number | null>(null);
      const [filterAccount, setFilterAccount] = useState<string>('all');
      const [filterDateRange, setFilterDateRange] = useState<string>('all');
      const [score, setScore] = useState(0);
      const [currentChallenge, setCurrentChallenge] = useState(0);
      const [traceAnswer, setTraceAnswer] = useState<string | null>(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackCorrect, setFeedbackCorrect] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);

      const transactions = [
         { id: 1, date: '2024-01-03', description: 'Received payment from Customer A', debitAccount: 'Cash', creditAccount: 'Accounts Receivable', amount: 5000, source: 'Cash Receipts Journal', docRef: 'CR-001' },
         { id: 2, date: '2024-01-05', description: 'Purchased office supplies', debitAccount: 'Office Supplies', creditAccount: 'Cash', amount: 350, source: 'Cash Disbursements Journal', docRef: 'CD-001' },
         { id: 3, date: '2024-01-08', description: 'Sold merchandise on credit', debitAccount: 'Accounts Receivable', creditAccount: 'Sales Revenue', amount: 8500, source: 'Sales Journal', docRef: 'SJ-001' },
         { id: 4, date: '2024-01-10', description: 'Paid monthly rent', debitAccount: 'Rent Expense', creditAccount: 'Cash', amount: 2500, source: 'Cash Disbursements Journal', docRef: 'CD-002' },
         { id: 5, date: '2024-01-12', description: 'Received utility bill', debitAccount: 'Utilities Expense', creditAccount: 'Accounts Payable', amount: 480, source: 'General Journal', docRef: 'GJ-001' },
         { id: 6, date: '2024-01-15', description: 'Paid employee salaries', debitAccount: 'Salaries Expense', creditAccount: 'Cash', amount: 6200, source: 'Cash Disbursements Journal', docRef: 'CD-003' },
         { id: 7, date: '2024-01-18', description: 'Purchased inventory on credit', debitAccount: 'Inventory', creditAccount: 'Accounts Payable', amount: 4200, source: 'Purchases Journal', docRef: 'PJ-001' },
         { id: 8, date: '2024-01-20', description: 'Customer B paid invoice', debitAccount: 'Cash', creditAccount: 'Accounts Receivable', amount: 3200, source: 'Cash Receipts Journal', docRef: 'CR-002' },
         { id: 9, date: '2024-01-22', description: 'Recorded depreciation', debitAccount: 'Depreciation Expense', creditAccount: 'Accumulated Depreciation', amount: 750, source: 'General Journal', docRef: 'GJ-002' },
         { id: 10, date: '2024-01-25', description: 'Paid supplier invoice', debitAccount: 'Accounts Payable', creditAccount: 'Cash', amount: 3500, source: 'Cash Disbursements Journal', docRef: 'CD-004' },
         { id: 11, date: '2024-01-28', description: 'Cash sale', debitAccount: 'Cash', creditAccount: 'Sales Revenue', amount: 1200, source: 'Cash Receipts Journal', docRef: 'CR-003' },
         { id: 12, date: '2024-01-30', description: 'Interest on loan', debitAccount: 'Interest Expense', creditAccount: 'Interest Payable', amount: 320, source: 'General Journal', docRef: 'GJ-003' }
      ];

      const accounts: {[key: string]: {type: string; normalBalance: string; info: string}} = {
         'Cash': { type: 'Asset', normalBalance: 'Debit', info: 'Money on hand and in bank. Increases with debits.' },
         'Accounts Receivable': { type: 'Asset', normalBalance: 'Debit', info: 'Money owed by customers. Increases when selling on credit.' },
         'Inventory': { type: 'Asset', normalBalance: 'Debit', info: 'Goods held for sale.' },
         'Office Supplies': { type: 'Asset', normalBalance: 'Debit', info: 'Supplies for office use.' },
         'Accumulated Depreciation': { type: 'Contra-Asset', normalBalance: 'Credit', info: 'Total depreciation. Reduces fixed asset value.' },
         'Accounts Payable': { type: 'Liability', normalBalance: 'Credit', info: 'Money owed to suppliers.' },
         'Interest Payable': { type: 'Liability', normalBalance: 'Credit', info: 'Accrued interest not yet paid.' },
         'Sales Revenue': { type: 'Revenue', normalBalance: 'Credit', info: 'Income from sales. Increases equity.' },
         'Rent Expense': { type: 'Expense', normalBalance: 'Debit', info: 'Cost of renting space.' },
         'Utilities Expense': { type: 'Expense', normalBalance: 'Debit', info: 'Cost of utilities.' },
         'Salaries Expense': { type: 'Expense', normalBalance: 'Debit', info: 'Employee compensation.' },
         'Depreciation Expense': { type: 'Expense', normalBalance: 'Debit', info: 'Asset cost allocation.' },
         'Interest Expense': { type: 'Expense', normalBalance: 'Debit', info: 'Cost of borrowing.' }
      };

      const traceChallenges = [
         { question: 'An auditor asks: "Where did the $5,000 cash receipt on January 3rd come from?" Trace to source.', transactionId: 1, correctAnswer: 'Cash Receipts Journal', options: ['Cash Receipts Journal', 'Sales Journal', 'General Journal', 'Cash Disbursements Journal'], explanation: 'Cash receipts from customers are recorded in the Cash Receipts Journal.' },
         { question: 'The CFO wants to verify the $8,500 sales entry. Which journal has the original?', transactionId: 3, correctAnswer: 'Sales Journal', options: ['Cash Receipts Journal', 'Sales Journal', 'Purchases Journal', 'General Journal'], explanation: 'Credit sales are in the Sales Journal. Cash sales go to Cash Receipts.' },
         { question: 'An auditor questions the $750 depreciation. What document reference?', transactionId: 9, correctAnswer: 'GJ-002', options: ['CD-003', 'GJ-002', 'CR-002', 'PJ-001'], explanation: 'Adjusting entries like depreciation use GJ (General Journal) references.' },
         { question: 'Which account shows a CREDIT of $8,500 after January 8th sale?', transactionId: 3, correctAnswer: 'Sales Revenue', options: ['Cash', 'Accounts Receivable', 'Sales Revenue', 'Inventory'], explanation: 'Revenue has credit normal balance. Sales credits Revenue, debits AR.' },
         { question: 'After paying rent on January 10th, which statement is affected?', transactionId: 4, correctAnswer: 'Both statements', options: ['Only Balance Sheet', 'Only Income Statement', 'Both statements', 'Neither'], explanation: 'Rent Expense hits Income Statement. Cash reduction hits Balance Sheet.' },
         { question: 'The $4,200 inventory purchase created a liability. When will it affect cash?', transactionId: 7, correctAnswer: 'When invoice is paid', options: ['Immediately', 'When sold', 'When invoice is paid', 'At month end'], explanation: 'Credit purchases create AP. Cash affected only when paid.' }
      ];

      const tutorialSteps = [
         { title: 'Welcome to General Ledger Management!', content: 'The General Ledger is the "master record" of all transactions. Every journal entry flows here.', highlight: 'overview' },
         { title: 'What is a General Ledger?', content: 'Think of it as the central hub where transactions are organized by account. Each has a ledger card.', highlight: 'ledger' },
         { title: 'Transaction Flow', content: 'Source Docs ‚Üí Journals ‚Üí General Ledger ‚Üí Trial Balance ‚Üí Financial Statements', highlight: 'flow' },
         { title: 'Account Ledger Cards', content: 'Each account shows: Date, Description, Debit, Credit, and Running Balance.', highlight: 'cards' },
         { title: 'Filtering & Searching', content: 'Filter by account, date, or amount. Essential for reporting and analysis.', highlight: 'filter' },
         { title: 'The Audit Trail', content: 'Every entry references its source journal and document. Creates traceable path.', highlight: 'audit' },
         { title: "Let's Explore!", content: "Explore the GL, filter transactions, view ledger cards, then face audit challenges!", highlight: 'game' }
      ];

      const showInfoModal = (title: string, content: string) => { setInfoContent({ title, content }); setShowInfo(true); };

      const getAccountTransactions = (acct: string) => transactions.filter(t => t.debitAccount === acct || t.creditAccount === acct);

      const calculateBalance = (acct: string) => {
         const info = accounts[acct];
         let bal = 0;
         transactions.forEach(t => {
            if (t.debitAccount === acct) bal += info?.normalBalance === 'Debit' ? t.amount : -t.amount;
            if (t.creditAccount === acct) bal += info?.normalBalance === 'Credit' ? t.amount : -t.amount;
         });
         return bal;
      };

      const getFiltered = () => {
         let f = [...transactions];
         if (filterAccount !== 'all') f = f.filter(t => t.debitAccount === filterAccount || t.creditAccount === filterAccount);
         if (filterDateRange === 'week1') f = f.filter(t => parseInt(t.date.split('-')[2]) <= 7);
         else if (filterDateRange === 'week2') f = f.filter(t => { const d = parseInt(t.date.split('-')[2]); return d > 7 && d <= 14; });
         else if (filterDateRange === 'week3') f = f.filter(t => { const d = parseInt(t.date.split('-')[2]); return d > 14 && d <= 21; });
         else if (filterDateRange === 'week4') f = f.filter(t => parseInt(t.date.split('-')[2]) > 21);
         return f;
      };

      const handleAnswer = (ans: string) => {
         const ch = traceChallenges[currentChallenge];
         const correct = ans === ch.correctAnswer;
         setTraceAnswer(ans); setShowFeedback(true); setFeedbackCorrect(correct); setTotalAnswered(p => p + 1);
         if (correct) { setScore(p => p + 20); setCorrectAnswers(p => p + 1); setGameLog(p => [...p, `‚úì ${ch.question.substring(0, 40)}...`]); }
         else setGameLog(p => [...p, `‚úó ${ch.question.substring(0, 40)}...`]);
         setTimeout(() => {
            setShowFeedback(false); setTraceAnswer(null);
            if (currentChallenge < traceChallenges.length - 1) setCurrentChallenge(p => p + 1);
            else { setPhase('result'); setGameLog(p => [...p, `Completed! Score: ${score + (correct ? 20 : 0)}`]); }
         }, 2500);
      };

      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold mb-3">üìí General Ledger Management</h2>
                  <p className="text-lg text-white/80">Master the central hub of financial records</p>
               </div>
               <div className="bg-white/10 backdrop-blur rounded-xl p-6 mb-6">
                  <div className="flex items-start gap-3"><span className="text-3xl">üí°</span>
                     <div><h3 className="font-bold text-xl mb-2">Key Insight</h3>
                        <p className="text-white/90">The General Ledger is the master record of all transactions. Every journal entry flows here‚Äîit's the complete financial story.</p>
                     </div>
                  </div>
               </div>
               <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3 flex items-center gap-2">üéØ What You'll Learn <button onClick={() => showInfoModal('Objectives', 'Master GL navigation, account ledger cards, filtering, and audit trail tracing.')} className="text-sky-400">‚ÑπÔ∏è</button></h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Transaction flow to GL</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Reading ledger cards</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Filtering records</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Audit trail tracing</li>
                     </ul>
                  </div>
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3">üéÆ Game Structure</h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-emerald-400">1</span> Tutorial</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">2</span> Explore GL</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">3</span> View ledger cards</li>
                        <li className="flex items-center gap-2"><span className="text-emerald-400">4</span> Audit challenges</li>
                     </ul>
                  </div>
               </div>
               <div className="bg-gradient-to-r from-emerald-500/20 to-teal-500/20 rounded-xl p-4 mb-6">
                  <h3 className="font-bold mb-2">üìä Transaction Flow</h3>
                  <div className="flex items-center justify-between text-xs">
                     {['Source Docs', 'Journals', 'General Ledger', 'Trial Balance', 'Statements'].map((item, i) => (
                        <div key={i} className="flex items-center">
                           <div className={`rounded p-2 text-center ${item === 'General Ledger' ? 'bg-emerald-500/40 border border-emerald-400' : 'bg-white/20'}`}><div className="font-bold">{item}</div></div>
                           {i < 4 && <span className="mx-1 text-white/40">‚Üí</span>}
                        </div>
                     ))}
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 rounded-xl font-bold text-lg">Start Learning ‚Üí</button>
               {showInfo && infoContent && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 rounded-xl p-6 max-w-md"><h3 className="text-xl font-bold mb-3">{infoContent.title}</h3><p className="text-white/80 mb-4">{infoContent.content}</p><button onClick={() => setShowInfo(false)} className="w-full py-2 bg-emerald-600 rounded-lg">Got it!</button></div></div>)}
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">üìö Tutorial</h2><div className="text-white/60">Step {tutorialStep + 1}/{tutorialSteps.length}</div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-emerald-500 to-teal-500 h-2 rounded-full" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="text-xl font-bold mb-4">{step.title}</h3>
                  <p className="text-lg text-white/90 mb-6">{step.content}</p>
                  {step.highlight === 'flow' && (
                     <div className="flex items-center justify-between text-xs bg-white/5 rounded-lg p-3">
                        {['Source Docs', 'Journals', 'General Ledger', 'Trial Balance', 'Statements'].map((item, i) => (
                           <div key={i} className="flex items-center">
                              <div className={`rounded p-2 ${item === 'General Ledger' ? 'bg-emerald-500/40 border border-emerald-400' : 'bg-white/20'}`}><div className="font-bold">{item}</div></div>
                              {i < 4 && <span className="mx-1 text-white/40">‚Üí</span>}
                           </div>
                        ))}
                     </div>
                  )}
                  {step.highlight === 'cards' && (
                     <div className="bg-white/10 rounded-lg p-3">
                        <div className="text-center font-bold mb-2 text-emerald-400">Sample Ledger Card</div>
                        <div className="grid grid-cols-5 gap-2 text-xs font-bold border-b border-white/20 pb-1 mb-1"><div>Date</div><div>Desc</div><div className="text-right">Debit</div><div className="text-right">Credit</div><div className="text-right">Balance</div></div>
                        <div className="grid grid-cols-5 gap-2 text-xs"><div>Jan 3</div><div>Payment</div><div className="text-right text-emerald-400">$5,000</div><div className="text-right">-</div><div className="text-right">$5,000</div></div>
                     </div>
                  )}
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(p => p - 1)} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">‚Üê Back</button>}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(p => p + 1); else { setPhase('explore'); setGameLog(['Started GL exploration']); } }} className="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl font-bold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Explore ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'explore') {
         const filtered = getFiltered();
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div><h2 className="text-xl font-bold">üìí General Ledger Explorer</h2><p className="text-white/60 text-sm">Click transactions or accounts to explore</p></div>
                  <button onClick={() => showInfoModal('Help', 'Filter by account/date. Click rows for details. Click account names for ledger cards.')} className="text-sky-400 text-xl">‚ÑπÔ∏è</button>
               </div>
               <div className="flex gap-4 mb-4">
                  <div className="flex-1"><label className="text-xs text-white/60 block mb-1">Account</label>
                     <select value={filterAccount} onChange={(e) => setFilterAccount(e.target.value)} className="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm">
                        <option value="all">All Accounts</option>
                        {Object.keys(accounts).map(a => <option key={a} value={a}>{a}</option>)}
                     </select>
                  </div>
                  <div className="flex-1"><label className="text-xs text-white/60 block mb-1">Date Range</label>
                     <select value={filterDateRange} onChange={(e) => setFilterDateRange(e.target.value)} className="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm">
                        <option value="all">All Dates</option><option value="week1">Week 1</option><option value="week2">Week 2</option><option value="week3">Week 3</option><option value="week4">Week 4</option>
                     </select>
                  </div>
               </div>
               <div className="bg-white/5 rounded-xl overflow-hidden mb-4">
                  <div className="grid grid-cols-12 gap-1 p-2 bg-white/10 text-xs font-bold"><div className="col-span-1">Date</div><div className="col-span-3">Description</div><div className="col-span-2">Debit</div><div className="col-span-2">Credit</div><div className="col-span-2 text-right">Amount</div><div className="col-span-2">Ref</div></div>
                  <div className="max-h-[200px] overflow-y-auto">
                     {filtered.map(t => (
                        <div key={t.id} onClick={() => setSelectedTransaction(selectedTransaction === t.id ? null : t.id)} className={`grid grid-cols-12 gap-1 p-2 text-xs border-b border-white/5 cursor-pointer hover:bg-white/10 ${selectedTransaction === t.id ? 'bg-emerald-500/20' : ''}`}>
                           <div className="col-span-1">{t.date.slice(5)}</div>
                           <div className="col-span-3 truncate">{t.description}</div>
                           <div className="col-span-2"><button onClick={(e) => { e.stopPropagation(); setSelectedAccount(t.debitAccount); }} className="text-emerald-400 hover:underline">{t.debitAccount}</button></div>
                           <div className="col-span-2"><button onClick={(e) => { e.stopPropagation(); setSelectedAccount(t.creditAccount); }} className="text-rose-400 hover:underline">{t.creditAccount}</button></div>
                           <div className="col-span-2 text-right font-mono">${t.amount.toLocaleString()}</div>
                           <div className="col-span-2 text-white/60">{t.docRef}</div>
                        </div>
                     ))}
                  </div>
               </div>
               {selectedTransaction && (() => { const t = transactions.find(tr => tr.id === selectedTransaction); return t ? (
                  <div className="bg-white/10 rounded-xl p-4 mb-4">
                     <div className="flex justify-between mb-2"><h3 className="font-bold">Transaction Details</h3><button onClick={() => setSelectedTransaction(null)} className="text-white/60">‚úï</button></div>
                     <div className="text-sm space-y-1"><div><span className="text-white/60">Date:</span> {t.date}</div><div><span className="text-white/60">Source:</span> <span className="text-amber-400">{t.source}</span></div><div><span className="text-white/60">Ref:</span> {t.docRef}</div></div>
                     <div className="grid grid-cols-2 gap-4 mt-3">
                        <div className="bg-emerald-500/20 rounded p-2"><div className="text-xs text-white/60">DEBIT</div><div className="font-bold">{t.debitAccount}</div><div className="font-mono">${t.amount.toLocaleString()}</div></div>
                        <div className="bg-rose-500/20 rounded p-2"><div className="text-xs text-white/60">CREDIT</div><div className="font-bold">{t.creditAccount}</div><div className="font-mono">${t.amount.toLocaleString()}</div></div>
                     </div>
                  </div>
               ) : null; })()}
               {selectedAccount && (
                  <div className="bg-white/10 rounded-xl p-4 mb-4">
                     <div className="flex justify-between mb-2"><div><h3 className="font-bold">{selectedAccount}</h3><div className="text-xs text-white/60">{accounts[selectedAccount]?.type} ‚Ä¢ {accounts[selectedAccount]?.normalBalance} <button onClick={() => showInfoModal(selectedAccount, accounts[selectedAccount]?.info || '')} className="text-sky-400 ml-1">‚ÑπÔ∏è</button></div></div><button onClick={() => setSelectedAccount(null)} className="text-white/60">‚úï</button></div>
                     <div className="grid grid-cols-5 gap-1 text-xs font-bold border-b border-white/20 pb-1 mb-1"><div>Date</div><div>Desc</div><div className="text-right">DR</div><div className="text-right">CR</div><div className="text-right">Bal</div></div>
                     {(() => { let bal = 0; const info = accounts[selectedAccount]; return getAccountTransactions(selectedAccount).map(t => { const isDr = t.debitAccount === selectedAccount; if (isDr) bal += info?.normalBalance === 'Debit' ? t.amount : -t.amount; else bal += info?.normalBalance === 'Credit' ? t.amount : -t.amount; return (<div key={t.id} className="grid grid-cols-5 gap-1 text-xs py-1 border-b border-white/5"><div>{t.date.slice(5)}</div><div className="truncate">{t.description}</div><div className="text-right text-emerald-400">{isDr ? `$${t.amount.toLocaleString()}` : '-'}</div><div className="text-right text-rose-400">{!isDr ? `$${t.amount.toLocaleString()}` : '-'}</div><div className="text-right font-mono">${bal.toLocaleString()}</div></div>); }); })()}
                     <div className="mt-2 pt-2 border-t border-white/20 text-sm flex justify-between"><span className="font-bold">Balance:</span><span className="font-mono font-bold">${calculateBalance(selectedAccount).toLocaleString()}</span></div>
                  </div>
               )}
               <button onClick={() => { setPhase('audit'); setGameLog(p => [...p, 'Started audit challenges']); }} className="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl font-bold">Start Audit Challenges ‚Üí</button>
               {showInfo && infoContent && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 rounded-xl p-6 max-w-md"><h3 className="text-xl font-bold mb-3">{infoContent.title}</h3><p className="text-white/80 mb-4">{infoContent.content}</p><button onClick={() => setShowInfo(false)} className="w-full py-2 bg-emerald-600 rounded-lg">Got it!</button></div></div>)}
            </div>
         );
      }

      if (phase === 'audit') {
         const ch = traceChallenges[currentChallenge];
         const t = transactions.find(tr => tr.id === ch.transactionId);
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4"><div><h2 className="text-xl font-bold">üîç Audit Trace</h2><p className="text-white/60 text-sm">Q{currentChallenge + 1}/{traceChallenges.length}</p></div><div className="bg-white/10 rounded-lg px-3 py-1">Score: <span className="font-bold">{score}</span></div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-amber-500 to-orange-500 h-2 rounded-full" style={{ width: `${((currentChallenge + 1) / traceChallenges.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-4">
                  <p className="text-lg mb-4">{ch.question}</p>
                  {t && (<div className="bg-white/5 rounded-lg p-3 mb-4 text-sm"><div className="text-white/60 mb-1">Transaction:</div><div className="grid grid-cols-2 gap-1"><div>Date: {t.date}</div><div>Amt: ${t.amount.toLocaleString()}</div><div>DR: <span className="text-emerald-400">{t.debitAccount}</span></div><div>CR: <span className="text-rose-400">{t.creditAccount}</span></div></div></div>)}
                  <div className="grid grid-cols-2 gap-3">{ch.options.map(o => (<button key={o} onClick={() => !showFeedback && handleAnswer(o)} disabled={showFeedback} className={`py-3 px-4 rounded-xl font-medium transition-all ${showFeedback && o === ch.correctAnswer ? 'bg-emerald-500' : showFeedback && traceAnswer === o && o !== ch.correctAnswer ? 'bg-rose-500' : 'bg-white/10 hover:bg-white/20'}`}>{o}</button>))}</div>
               </div>
               {showFeedback && (<div className={`p-4 rounded-xl ${feedbackCorrect ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}><div className="flex items-start gap-2"><span className="text-xl">{feedbackCorrect ? '‚úì' : '‚úó'}</span><div><div className="font-bold mb-1">{feedbackCorrect ? 'Correct!' : 'Not quite'}</div><div className="text-sm text-white/80">{ch.explanation}</div></div></div></div>)}
            </div>
         );
      }

      if (phase === 'result') {
         const acc = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
         const grade = acc >= 90 ? 'A' : acc >= 80 ? 'B' : acc >= 70 ? 'C' : acc >= 60 ? 'D' : 'F';
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-6"><div className="text-6xl mb-4">üìí</div><h2 className="text-3xl font-bold mb-2">General Ledger Mastered!</h2></div>
               <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-3xl font-bold text-amber-400">{score}</div><div className="text-white/60">Points</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-3xl font-bold text-emerald-400">{acc}%</div><div className="text-white/60">Accuracy</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className={`text-3xl font-bold ${grade === 'A' ? 'text-emerald-400' : 'text-sky-400'}`}>{grade}</div><div className="text-white/60">Grade</div></div>
               </div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="font-bold text-lg mb-4">üí° Key Takeaways</h3>
                  <ul className="space-y-2 text-sm">
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Master Record:</strong> GL contains all transactions by account</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Audit Trail:</strong> Every entry traces to source journals</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Ledger Cards:</strong> Show running balances and history</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Statements:</strong> Built from GL account balances</span></li>
                  </ul>
               </div>
               <div className="flex gap-3">
                  <button onClick={() => { setPhase('intro'); setScore(0); setCurrentChallenge(0); setCorrectAnswers(0); setTotalAnswered(0); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl font-bold">‚úì Done</button>
               </div>
            </div>
         );
      }

      return null;
   };

   // TOPIC 7: Accounts Payable Automation - Interactive Educational Game
   const AccountsPayableRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'workflow' | 'discount' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState<{title: string; content: string} | null>(null);
      const [score, setScore] = useState(0);
      const [currentInvoice, setCurrentInvoice] = useState(0);
      const [processedInvoices, setProcessedInvoices] = useState<{id: number; action: string; timing: string}[]>([]);
      const [cashBalance, setCashBalance] = useState(50000);
      const [discountQuiz, setDiscountQuiz] = useState(0);
      const [quizAnswer, setQuizAnswer] = useState<string | null>(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackCorrect, setFeedbackCorrect] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);

      const invoices = [
         { id: 1, vendor: 'Office Supplies Inc', amount: 2500, terms: '2/10 net 30', dueDate: '2024-02-15', received: '2024-01-16', po: 'PO-1001', status: 'pending', category: 'Supplies' },
         { id: 2, vendor: 'Tech Hardware Co', amount: 8500, terms: 'net 30', dueDate: '2024-02-20', received: '2024-01-21', po: 'PO-1002', status: 'pending', category: 'Equipment' },
         { id: 3, vendor: 'Utility Company', amount: 1200, terms: 'net 15', dueDate: '2024-02-01', received: '2024-01-17', po: null, status: 'pending', category: 'Utilities' },
         { id: 4, vendor: 'Marketing Agency', amount: 5000, terms: '1/15 net 45', dueDate: '2024-03-01', received: '2024-01-15', po: 'PO-1003', status: 'pending', category: 'Marketing' },
         { id: 5, vendor: 'Raw Materials Ltd', amount: 15000, terms: '2/10 net 30', dueDate: '2024-02-10', received: '2024-01-11', po: 'PO-1004', status: 'pending', category: 'Inventory' },
         { id: 6, vendor: 'Cleaning Services', amount: 800, terms: 'net 30', dueDate: '2024-02-25', received: '2024-01-26', po: null, status: 'pending', category: 'Services' }
      ];

      const discountQuizzes = [
         { question: 'Invoice: $10,000 with terms "2/10 net 30". If paid in 8 days, how much do you pay?', correctAnswer: '$9,800', options: ['$10,000', '$9,800', '$9,900', '$9,700'], explanation: '2% discount on $10,000 = $200 off. Pay $9,800. The discount is earned by paying within 10 days.' },
         { question: 'What is the annualized return on taking a 2/10 net 30 discount?', correctAnswer: '36.7%', options: ['2%', '24%', '36.7%', '12%'], explanation: '2% for 20 days early = 2% √ó (365/20) = 36.7% annualized. This is why companies prioritize early payment discounts!' },
         { question: 'Terms are "1/15 net 45". The discount period is how many days?', correctAnswer: '15 days', options: ['1 day', '15 days', '45 days', '30 days'], explanation: '1/15 net 45 means: 1% discount if paid within 15 days, otherwise full amount due in 45 days.' },
         { question: 'You have $5,000 cash. Invoice A: $3,000 (2/10 net 30, day 5). Invoice B: $4,000 (net 30, day 25). Which to pay first?', correctAnswer: 'Invoice A - take the discount', options: ['Invoice A - take the discount', 'Invoice B - older first', 'Pay both partially', 'Wait for more cash'], explanation: 'Always prioritize discount-eligible invoices when cash allows. The 2% discount on $3,000 = $60 saved, equivalent to 36%+ annualized return.' },
         { question: 'Supplier offers "3/10 net 60". What does the 60 mean?', correctAnswer: 'Full payment due in 60 days', options: ['60% discount', 'Pay in 60 installments', 'Full payment due in 60 days', '60 days to dispute'], explanation: 'Net 60 means the full invoice amount is due 60 days from invoice date if discount is not taken.' },
         { question: 'AP aging shows $50K in 0-30 days, $20K in 31-60 days, $10K in 61-90 days. Which is most concerning?', correctAnswer: '61-90 days bucket', options: ['0-30 days bucket', '31-60 days bucket', '61-90 days bucket', 'All equally concerning'], explanation: 'Invoices 61-90 days old are significantly overdue and may damage vendor relationships or credit terms.' }
      ];

      const tutorialSteps = [
         { title: 'Welcome to Accounts Payable!', content: 'AP is what you OWE others. Automating it means paying the right amount, to the right vendor, at the right time‚Äîwithout errors.', highlight: 'overview' },
         { title: 'The AP Workflow', content: 'Receive Invoice ‚Üí Match to PO ‚Üí Approve ‚Üí Schedule Payment ‚Üí Process ‚Üí Reconcile. Each step prevents errors and fraud.', highlight: 'workflow' },
         { title: 'Three-Way Matching', content: 'Match: 1) Invoice 2) Purchase Order 3) Receiving Report. All three must agree before payment. This prevents paying for goods not received.', highlight: 'matching' },
         { title: 'Payment Terms', content: '"2/10 net 30" means: 2% discount if paid in 10 days, otherwise full amount due in 30 days. Taking discounts = free money!', highlight: 'terms' },
         { title: 'The Discount Math', content: '2% for paying 20 days early = 36.7% annualized return! Companies with good cash flow always take early payment discounts.', highlight: 'discount' },
         { title: 'Cash Flow Management', content: "Don't pay too early (lose cash flexibility) or too late (damage relationships). Schedule payments strategically.", highlight: 'cashflow' },
         { title: "Let's Practice!", content: "Process invoices, decide when to pay, and calculate discount savings. Watch your cash flow!", highlight: 'game' }
      ];

      const showInfoModal = (title: string, content: string) => { setInfoContent({ title, content }); setShowInfo(true); };

      const calculateDiscount = (amount: number, terms: string) => {
         const match = terms.match(/(\d+)\/(\d+)/);
         if (match) return { percent: parseInt(match[1]), days: parseInt(match[2]), savings: amount * (parseInt(match[1]) / 100) };
         return null;
      };

      const getDaysUntilDue = (dueDate: string) => {
         const due = new Date(dueDate);
         const today = new Date('2024-01-20');
         return Math.ceil((due.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
      };

      const processInvoice = (action: 'payNow' | 'payOnDue' | 'schedule') => {
         const inv = invoices[currentInvoice];
         const discount = calculateDiscount(inv.amount, inv.terms);
         let timing = '';
         let payment = inv.amount;

         if (action === 'payNow' && discount) {
            payment = inv.amount - discount.savings;
            timing = `Paid early, saved $${discount.savings.toFixed(0)}`;
            setScore(p => p + 25);
            setCorrectAnswers(p => p + 1);
            setGameLog(p => [...p, `‚úì Took ${discount.percent}% discount on ${inv.vendor}: saved $${discount.savings.toFixed(0)}`]);
         } else if (action === 'payNow' && !discount) {
            timing = 'Paid immediately (no discount available)';
            setScore(p => p + 10);
            setGameLog(p => [...p, `Paid ${inv.vendor} immediately (no discount terms)`]);
         } else if (action === 'payOnDue') {
            timing = `Scheduled for due date: ${inv.dueDate}`;
            if (discount) {
               setGameLog(p => [...p, `‚ö† Missed ${discount.percent}% discount on ${inv.vendor}`]);
               setScore(p => p + 5);
            } else {
               setScore(p => p + 15);
               setGameLog(p => [...p, `Scheduled ${inv.vendor} for due date`]);
            }
         } else {
            timing = 'Held for review';
            setGameLog(p => [...p, `Held ${inv.vendor} invoice for review`]);
         }

         setCashBalance(p => action === 'payNow' ? p - payment : p);
         setProcessedInvoices(p => [...p, { id: inv.id, action, timing }]);
         setTotalAnswered(p => p + 1);

         if (currentInvoice < invoices.length - 1) {
            setCurrentInvoice(p => p + 1);
         } else {
            setPhase('discount');
            setGameLog(p => [...p, 'Moving to discount calculation quiz']);
         }
      };

      const handleQuizAnswer = (ans: string) => {
         const q = discountQuizzes[discountQuiz];
         const correct = ans === q.correctAnswer;
         setQuizAnswer(ans); setShowFeedback(true); setFeedbackCorrect(correct); setTotalAnswered(p => p + 1);
         if (correct) { setScore(p => p + 20); setCorrectAnswers(p => p + 1); setGameLog(p => [...p, `‚úì ${q.question.substring(0, 40)}...`]); }
         else setGameLog(p => [...p, `‚úó ${q.question.substring(0, 40)}...`]);
         setTimeout(() => {
            setShowFeedback(false); setQuizAnswer(null);
            if (discountQuiz < discountQuizzes.length - 1) setDiscountQuiz(p => p + 1);
            else { setPhase('result'); setGameLog(p => [...p, `Completed! Score: ${score + (correct ? 20 : 0)}`]); }
         }, 2500);
      };

      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold mb-3">üí≥ Accounts Payable Automation</h2>
                  <p className="text-lg text-white/80">Master what you OWE and when to pay</p>
               </div>
               <div className="bg-white/10 backdrop-blur rounded-xl p-6 mb-6">
                  <div className="flex items-start gap-3"><span className="text-3xl">üí°</span>
                     <div><h3 className="font-bold text-xl mb-2">Key Insight</h3>
                        <p className="text-white/90">"2/10 net 30" means: Take 2% off if you pay within 10 days. That 2% equals a 36% annualized return on early payment!</p>
                     </div>
                  </div>
               </div>
               <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3 flex items-center gap-2">üéØ What You'll Learn <button onClick={() => showInfoModal('Objectives', 'Master AP workflow, three-way matching, payment terms, discount calculations, and cash flow optimization.')} className="text-sky-400">‚ÑπÔ∏è</button></h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Invoice processing workflow</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Payment terms (2/10 net 30)</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Discount calculations</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Cash flow optimization</li>
                     </ul>
                  </div>
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3">üéÆ Game Structure</h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-rose-400">1</span> Tutorial</li>
                        <li className="flex items-center gap-2"><span className="text-rose-400">2</span> Process invoices</li>
                        <li className="flex items-center gap-2"><span className="text-rose-400">3</span> Payment decisions</li>
                        <li className="flex items-center gap-2"><span className="text-rose-400">4</span> Discount quiz</li>
                     </ul>
                  </div>
               </div>
               <div className="bg-gradient-to-r from-rose-500/20 to-pink-500/20 rounded-xl p-4 mb-6">
                  <h3 className="font-bold mb-2">üìä AP Workflow</h3>
                  <div className="flex items-center justify-between text-xs">
                     {['Receive', 'Match PO', 'Approve', 'Schedule', 'Pay', 'Reconcile'].map((item, i) => (
                        <div key={i} className="flex items-center">
                           <div className="bg-white/20 rounded p-2 text-center"><div className="font-bold">{item}</div></div>
                           {i < 5 && <span className="mx-1 text-white/40">‚Üí</span>}
                        </div>
                     ))}
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-4 bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 rounded-xl font-bold text-lg">Start Learning ‚Üí</button>
               {showInfo && infoContent && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 rounded-xl p-6 max-w-md"><h3 className="text-xl font-bold mb-3">{infoContent.title}</h3><p className="text-white/80 mb-4">{infoContent.content}</p><button onClick={() => setShowInfo(false)} className="w-full py-2 bg-rose-600 rounded-lg">Got it!</button></div></div>)}
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">üìö Tutorial</h2><div className="text-white/60">Step {tutorialStep + 1}/{tutorialSteps.length}</div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-rose-500 to-pink-500 h-2 rounded-full" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="text-xl font-bold mb-4">{step.title}</h3>
                  <p className="text-lg text-white/90 mb-6">{step.content}</p>
                  {step.highlight === 'terms' && (
                     <div className="bg-white/10 rounded-lg p-4">
                        <div className="font-bold text-center mb-3 text-rose-400">Payment Terms Decoded</div>
                        <div className="grid grid-cols-3 gap-3 text-sm">
                           <div className="bg-white/10 rounded p-2"><div className="font-bold">2/10 net 30</div><div className="text-xs text-white/60">2% off if paid in 10 days</div></div>
                           <div className="bg-white/10 rounded p-2"><div className="font-bold">1/15 net 45</div><div className="text-xs text-white/60">1% off if paid in 15 days</div></div>
                           <div className="bg-white/10 rounded p-2"><div className="font-bold">net 30</div><div className="text-xs text-white/60">Full amount due in 30 days</div></div>
                        </div>
                     </div>
                  )}
                  {step.highlight === 'discount' && (
                     <div className="bg-emerald-500/20 border border-emerald-500/50 rounded-lg p-4">
                        <div className="font-bold mb-2">üí∞ The Math That Matters</div>
                        <div className="text-sm">2% discount for paying 20 days early = <span className="text-emerald-400 font-bold">36.7% annualized return</span></div>
                        <div className="text-xs text-white/60 mt-2">Formula: Discount% √ó (365 √∑ Days Early) = 2% √ó (365 √∑ 20) = 36.5%</div>
                     </div>
                  )}
                  {step.highlight === 'matching' && (
                     <div className="flex justify-center gap-4 text-sm">
                        <div className="bg-sky-500/20 rounded p-3 text-center"><div className="text-2xl mb-1">üìÑ</div><div className="font-bold">Invoice</div></div>
                        <div className="text-white/40 self-center">=</div>
                        <div className="bg-violet-500/20 rounded p-3 text-center"><div className="text-2xl mb-1">üìã</div><div className="font-bold">PO</div></div>
                        <div className="text-white/40 self-center">=</div>
                        <div className="bg-emerald-500/20 rounded p-3 text-center"><div className="text-2xl mb-1">üì¶</div><div className="font-bold">Receipt</div></div>
                     </div>
                  )}
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(p => p - 1)} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">‚Üê Back</button>}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(p => p + 1); else { setPhase('workflow'); setGameLog(['Started AP invoice processing']); } }} className="flex-1 py-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl font-bold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Process Invoices ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'workflow') {
         const inv = invoices[currentInvoice];
         const discount = calculateDiscount(inv.amount, inv.terms);
         const daysUntilDue = getDaysUntilDue(inv.dueDate);
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div><h2 className="text-xl font-bold">üìã Invoice Processing</h2><p className="text-white/60 text-sm">Invoice {currentInvoice + 1} of {invoices.length}</p></div>
                  <div className="text-right">
                     <div className="text-xs text-white/60">Cash Balance</div>
                     <div className="font-mono font-bold text-lg text-emerald-400">${cashBalance.toLocaleString()}</div>
                  </div>
               </div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-rose-500 to-pink-500 h-2 rounded-full" style={{ width: `${((currentInvoice + 1) / invoices.length) * 100}%` }} /></div>

               <div className="bg-white/10 rounded-xl p-5 mb-4">
                  <div className="flex justify-between items-start mb-4">
                     <div>
                        <div className="text-xl font-bold">{inv.vendor}</div>
                        <div className="text-white/60 text-sm">{inv.category}</div>
                     </div>
                     <div className="text-right">
                        <div className="text-2xl font-bold font-mono">${inv.amount.toLocaleString()}</div>
                        <div className="text-sm text-white/60">{inv.terms}</div>
                     </div>
                  </div>
                  <div className="grid grid-cols-3 gap-3 text-sm mb-4">
                     <div className="bg-white/5 rounded p-2"><span className="text-white/60">Received:</span> {inv.received}</div>
                     <div className="bg-white/5 rounded p-2"><span className="text-white/60">Due:</span> {inv.dueDate}</div>
                     <div className="bg-white/5 rounded p-2"><span className="text-white/60">PO:</span> {inv.po || 'N/A'}</div>
                  </div>
                  {discount && (
                     <div className="bg-emerald-500/20 border border-emerald-500/50 rounded-lg p-3 mb-4">
                        <div className="flex justify-between items-center">
                           <div><span className="font-bold text-emerald-400">{discount.percent}% Discount Available!</span><div className="text-xs text-white/60">Pay within {discount.days} days</div></div>
                           <div className="text-right"><div className="font-mono font-bold">Save ${discount.savings.toFixed(0)}</div><div className="text-xs text-white/60">Pay ${(inv.amount - discount.savings).toLocaleString()}</div></div>
                        </div>
                     </div>
                  )}
                  <div className="flex items-center gap-2 text-sm">
                     <span className={`px-2 py-1 rounded ${daysUntilDue <= 7 ? 'bg-rose-500/30 text-rose-300' : daysUntilDue <= 14 ? 'bg-amber-500/30 text-amber-300' : 'bg-emerald-500/30 text-emerald-300'}`}>
                        {daysUntilDue} days until due
                     </span>
                     {inv.po && <span className="px-2 py-1 rounded bg-sky-500/30 text-sky-300">PO Matched</span>}
                  </div>
               </div>

               <div className="text-sm text-white/60 mb-3 flex items-center gap-2">
                  Choose action: <button onClick={() => showInfoModal('Payment Strategy', 'Take discounts when cash allows - the annualized return is excellent. Pay on due date if no discount. Never pay late unless absolutely necessary.')} className="text-sky-400">‚ÑπÔ∏è</button>
               </div>
               <div className="grid grid-cols-3 gap-3">
                  <button onClick={() => processInvoice('payNow')} disabled={cashBalance < (discount ? inv.amount - discount.savings : inv.amount)} className={`py-4 rounded-xl font-bold transition-all ${cashBalance >= (discount ? inv.amount - discount.savings : inv.amount) ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-white/10 opacity-50 cursor-not-allowed'}`}>
                     <div>Pay Now</div>
                     {discount && <div className="text-xs font-normal">Save ${discount.savings.toFixed(0)}</div>}
                  </button>
                  <button onClick={() => processInvoice('payOnDue')} className="py-4 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold">
                     <div>Pay on Due Date</div>
                     <div className="text-xs font-normal">{inv.dueDate}</div>
                  </button>
                  <button onClick={() => processInvoice('schedule')} className="py-4 bg-white/10 hover:bg-white/20 rounded-xl font-bold">
                     <div>Hold for Review</div>
                     <div className="text-xs font-normal">Investigate</div>
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'discount') {
         const q = discountQuizzes[discountQuiz];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4"><div><h2 className="text-xl font-bold">üßÆ Discount Calculations</h2><p className="text-white/60 text-sm">Q{discountQuiz + 1}/{discountQuizzes.length}</p></div><div className="bg-white/10 rounded-lg px-3 py-1">Score: <span className="font-bold">{score}</span></div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-amber-500 to-orange-500 h-2 rounded-full" style={{ width: `${((discountQuiz + 1) / discountQuizzes.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-4">
                  <p className="text-lg mb-6">{q.question}</p>
                  <div className="grid grid-cols-2 gap-3">{q.options.map(o => (<button key={o} onClick={() => !showFeedback && handleQuizAnswer(o)} disabled={showFeedback} className={`py-3 px-4 rounded-xl font-medium transition-all ${showFeedback && o === q.correctAnswer ? 'bg-emerald-500' : showFeedback && quizAnswer === o && o !== q.correctAnswer ? 'bg-rose-500' : 'bg-white/10 hover:bg-white/20'}`}>{o}</button>))}</div>
               </div>
               {showFeedback && (<div className={`p-4 rounded-xl ${feedbackCorrect ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}><div className="flex items-start gap-2"><span className="text-xl">{feedbackCorrect ? '‚úì' : '‚úó'}</span><div><div className="font-bold mb-1">{feedbackCorrect ? 'Correct!' : 'Not quite'}</div><div className="text-sm text-white/80">{q.explanation}</div></div></div></div>)}
            </div>
         );
      }

      if (phase === 'result') {
         const acc = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
         const grade = acc >= 90 ? 'A' : acc >= 80 ? 'B' : acc >= 70 ? 'C' : acc >= 60 ? 'D' : 'F';
         const totalSaved = processedInvoices.filter(p => p.timing.includes('saved')).reduce((sum, p) => { const match = p.timing.match(/\$(\d+)/); return sum + (match ? parseInt(match[1]) : 0); }, 0);
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-rose-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-6"><div className="text-6xl mb-4">üí≥</div><h2 className="text-3xl font-bold mb-2">AP Automation Mastered!</h2></div>
               <div className="grid grid-cols-4 gap-3 mb-6">
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-amber-400">{score}</div><div className="text-white/60 text-sm">Points</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-emerald-400">{acc}%</div><div className="text-white/60 text-sm">Accuracy</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className={`text-2xl font-bold ${grade === 'A' ? 'text-emerald-400' : 'text-sky-400'}`}>{grade}</div><div className="text-white/60 text-sm">Grade</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-green-400">${totalSaved}</div><div className="text-white/60 text-sm">Saved</div></div>
               </div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="font-bold text-lg mb-4">üí° Key Takeaways</h3>
                  <ul className="space-y-2 text-sm">
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Take Discounts:</strong> 2/10 net 30 = 36% annualized return</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Three-Way Match:</strong> Invoice + PO + Receipt before paying</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Cash Flow:</strong> Balance early payment savings vs cash needs</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Never Late:</strong> Protect vendor relationships and credit terms</span></li>
                  </ul>
               </div>
               <div className="flex gap-3">
                  <button onClick={() => { setPhase('intro'); setScore(0); setCurrentInvoice(0); setDiscountQuiz(0); setProcessedInvoices([]); setCashBalance(50000); setCorrectAnswers(0); setTotalAnswered(0); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-gradient-to-r from-rose-600 to-pink-600 rounded-xl font-bold">‚úì Done</button>
               </div>
            </div>
         );
      }

      return null;
   };

   // TOPIC 8: Accounts Receivable & Collections - Interactive Educational Game
   const AccountsReceivableRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'aging' | 'collect' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState<{title: string; content: string} | null>(null);
      const [score, setScore] = useState(0);
      const [selectedCustomer, setSelectedCustomer] = useState<number | null>(null);
      const [collectionActions, setCollectionActions] = useState<{id: number; action: string; result: string}[]>([]);
      const [currentScenario, setCurrentScenario] = useState(0);
      const [scenarioAnswer, setScenarioAnswer] = useState<string | null>(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackCorrect, setFeedbackCorrect] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [correctAnswers, setCorrectAnswers] = useState(0);
      const [totalAnswered, setTotalAnswered] = useState(0);
      const [totalCollected, setTotalCollected] = useState(0);

      const customers = [
         { id: 1, name: 'Acme Corp', current: 5000, days30: 0, days60: 0, days90: 0, total: 5000, creditLimit: 20000, paymentHistory: 'Excellent', contact: 'John Smith' },
         { id: 2, name: 'Beta LLC', current: 0, days30: 3000, days60: 0, days90: 0, total: 3000, creditLimit: 10000, paymentHistory: 'Good', contact: 'Jane Doe' },
         { id: 3, name: 'Gamma Inc', current: 0, days30: 0, days60: 8000, days90: 0, total: 8000, creditLimit: 15000, paymentHistory: 'Fair', contact: 'Bob Wilson' },
         { id: 4, name: 'Delta Co', current: 0, days30: 0, days60: 0, days90: 12000, total: 12000, creditLimit: 25000, paymentHistory: 'Poor', contact: 'Mary Johnson' },
         { id: 5, name: 'Epsilon Ltd', current: 2000, days30: 1500, days60: 3000, days90: 0, total: 6500, creditLimit: 12000, paymentHistory: 'Good', contact: 'Tom Brown' },
         { id: 6, name: 'Zeta Systems', current: 0, days30: 0, days60: 0, days90: 5000, total: 5000, creditLimit: 8000, paymentHistory: 'Poor', contact: 'Sue Davis' }
      ];

      const collectionStrategies = [
         { id: 'reminder', name: 'üìß Send Reminder', description: 'Friendly email reminder', effectiveness: { current: 90, days30: 70, days60: 40, days90: 20 }, cost: 0 },
         { id: 'call', name: 'üìû Phone Call', description: 'Personal follow-up call', effectiveness: { current: 95, days30: 80, days60: 60, days90: 40 }, cost: 0 },
         { id: 'discount', name: 'üí∏ Offer Discount', description: '5% discount for immediate payment', effectiveness: { current: 80, days30: 85, days60: 75, days90: 60 }, cost: 5 },
         { id: 'payment_plan', name: 'üìÖ Payment Plan', description: 'Structured installment schedule', effectiveness: { current: 50, days30: 60, days60: 70, days90: 75 }, cost: 0 },
         { id: 'collections', name: '‚öñÔ∏è Send to Collections', description: 'Third-party collection agency', effectiveness: { current: 20, days30: 30, days60: 50, days90: 65 }, cost: 25 },
         { id: 'writeoff', name: '‚ùå Write Off', description: 'Record as bad debt expense', effectiveness: { current: 0, days30: 0, days60: 0, days90: 0 }, cost: 100 }
      ];

      const scenarios = [
         { question: 'Customer has $10,000 outstanding for 45 days. They claim they never received the invoice. Best action?', correctAnswer: 'Resend invoice and call to confirm receipt', options: ['Resend invoice and call to confirm receipt', 'Send to collections immediately', 'Write off as bad debt', 'Offer 50% discount'], explanation: 'Always verify the customer received the invoice first. Many "late" payments are simply communication issues.' },
         { question: 'Long-time customer (5 years, always paid on time) is suddenly 60 days late. What do you do first?', correctAnswer: 'Call to understand their situation', options: ['Send to collections', 'Call to understand their situation', 'Stop all future orders', 'Write off immediately'], explanation: 'Good customers deserve the benefit of the doubt. A call may reveal temporary issues and preserve the relationship.' },
         { question: 'Customer owes $5,000 for 90+ days. They offer to pay $3,000 immediately to settle. Accept?', correctAnswer: 'Accept - 60% recovery beats collections risk', options: ['Refuse - demand full amount', 'Accept - 60% recovery beats collections risk', 'Send to collections for full amount', 'Offer 50% instead'], explanation: 'At 90+ days, recovery rates drop significantly. Accepting $3,000 (60%) now is often better than risking $0 or paying 25%+ to collections.' },
         { question: 'Your AR aging shows: Current $50K, 30-day $20K, 60-day $10K, 90+ day $10K. DSO is 45 days. Is this healthy?', correctAnswer: 'Concerning - too much in 60+ day buckets', options: ['Excellent - most is current', 'Concerning - too much in 60+ day buckets', 'Terrible - DSO should be 15 days', 'Cannot determine without more info'], explanation: 'While 55% is current, having 22% in 60+ buckets signals collection issues. Industry benchmark for DSO varies but 45 days with this aging pattern warrants attention.' },
         { question: 'What does "Allowance for Doubtful Accounts" represent?', correctAnswer: 'Estimated uncollectible receivables', options: ['Cash reserve for bad debts', 'Estimated uncollectible receivables', 'Interest charged on late payments', 'Discount for early payment'], explanation: 'The Allowance is a contra-asset that reduces AR on the balance sheet. It estimates what portion of AR will never be collected.' },
         { question: 'Customer with poor payment history wants to place a $15,000 order. Their credit limit is $10,000. Best approach?', correctAnswer: 'Require prepayment or reduce order size', options: ['Approve it anyway', 'Require prepayment or reduce order size', 'Refuse the order entirely', 'Double their credit limit'], explanation: 'Protecting cash flow means enforcing credit policies. Options: prepayment, COD, or order within credit limit.' }
      ];

      const tutorialSteps = [
         { title: 'Welcome to Accounts Receivable!', content: 'AR is what others OWE YOU. The faster you collect, the better your cash flow. Late AR = cash stuck that could be working for you.', highlight: 'overview' },
         { title: 'The AR Aging Report', content: 'Aging buckets show how long invoices are outstanding: Current (0-30), 31-60 days, 61-90 days, 90+ days. Older = harder to collect.', highlight: 'aging' },
         { title: 'Days Sales Outstanding (DSO)', content: 'DSO = (AR √∑ Revenue) √ó Days. It measures average collection time. Lower DSO = faster cash conversion. Industry benchmarks vary.', highlight: 'dso' },
         { title: 'Collection Strategies', content: 'Match strategy to situation: Reminders for recent, calls for relationships, payment plans for struggling customers, collections for non-responsive.', highlight: 'strategies' },
         { title: 'Bad Debt & Allowance', content: 'Some AR will never be collected. The Allowance for Doubtful Accounts estimates this. When certain, write off against the allowance.', highlight: 'baddebt' },
         { title: 'Credit Policy', content: 'Prevention > Collection. Set credit limits, check credit history, require deposits for risky customers. Balance sales vs. risk.', highlight: 'credit' },
         { title: "Let's Practice!", content: "Analyze an AR aging report, choose collection strategies, and test your knowledge with real scenarios!", highlight: 'game' }
      ];

      const showInfoModal = (title: string, content: string) => { setInfoContent({ title, content }); setShowInfo(true); };

      const getTotalAR = () => customers.reduce((sum, c) => sum + c.total, 0);
      const getAgingTotals = () => ({
         current: customers.reduce((sum, c) => sum + c.current, 0),
         days30: customers.reduce((sum, c) => sum + c.days30, 0),
         days60: customers.reduce((sum, c) => sum + c.days60, 0),
         days90: customers.reduce((sum, c) => sum + c.days90, 0)
      });

      const getAgingBucket = (customer: typeof customers[0]) => {
         if (customer.days90 > 0) return '90+';
         if (customer.days60 > 0) return '60';
         if (customer.days30 > 0) return '30';
         return 'current';
      };

      const handleCollectionAction = (customerId: number, strategyId: string) => {
         const customer = customers.find(c => c.id === customerId);
         const strategy = collectionStrategies.find(s => s.id === strategyId);
         if (!customer || !strategy) return;

         const bucket = getAgingBucket(customer);
         const effectivenessKey = bucket === '90+' ? 'days90' : bucket === '60' ? 'days60' : bucket === '30' ? 'days30' : 'current';
         const successRate = strategy.effectiveness[effectivenessKey];
         const success = Math.random() * 100 < successRate;

         let result = '';
         let collected = 0;
         let points = 0;

         if (strategyId === 'writeoff') {
            result = `Bad debt expense recorded: $${customer.total.toLocaleString()}`;
            points = 5;
         } else if (success) {
            collected = Math.round(customer.total * (1 - strategy.cost / 100));
            result = `Collected $${collected.toLocaleString()}${strategy.cost > 0 ? ` (after ${strategy.cost}% cost)` : ''}`;
            points = 20 + (bucket === '90+' ? 10 : bucket === '60' ? 5 : 0);
            setTotalCollected(p => p + collected);
         } else {
            result = `No response yet. Try different approach or escalate.`;
            points = 5;
         }

         setCollectionActions(p => [...p, { id: customerId, action: strategy.name, result }]);
         setScore(p => p + points);
         setTotalAnswered(p => p + 1);
         if (success || strategyId === 'writeoff') setCorrectAnswers(p => p + 1);
         setGameLog(p => [...p, `${strategy.name} on ${customer.name}: ${result}`]);
         setSelectedCustomer(null);

         if (collectionActions.length >= 5) {
            setTimeout(() => { setPhase('collect'); setGameLog(p => [...p, 'Moving to scenario questions']); }, 1000);
         }
      };

      const handleScenarioAnswer = (ans: string) => {
         const s = scenarios[currentScenario];
         const correct = ans === s.correctAnswer;
         setScenarioAnswer(ans); setShowFeedback(true); setFeedbackCorrect(correct); setTotalAnswered(p => p + 1);
         if (correct) { setScore(p => p + 25); setCorrectAnswers(p => p + 1); setGameLog(p => [...p, `‚úì ${s.question.substring(0, 40)}...`]); }
         else setGameLog(p => [...p, `‚úó ${s.question.substring(0, 40)}...`]);
         setTimeout(() => {
            setShowFeedback(false); setScenarioAnswer(null);
            if (currentScenario < scenarios.length - 1) setCurrentScenario(p => p + 1);
            else { setPhase('result'); setGameLog(p => [...p, `Completed! Score: ${score + (correct ? 25 : 0)}`]); }
         }, 2500);
      };

      if (phase === 'intro') {
         const aging = getAgingTotals();
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-sky-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-8">
                  <h2 className="text-3xl font-bold mb-3">üí∞ Accounts Receivable & Collections</h2>
                  <p className="text-lg text-white/80">Master what others OWE YOU</p>
               </div>
               <div className="bg-white/10 backdrop-blur rounded-xl p-6 mb-6">
                  <div className="flex items-start gap-3"><span className="text-3xl">üí°</span>
                     <div><h3 className="font-bold text-xl mb-2">Key Insight</h3>
                        <p className="text-white/90">AR is what others owe you. The faster you collect, the better your cash flow. Aging reports show who's late‚Äîolder buckets are harder to collect.</p>
                     </div>
                  </div>
               </div>
               <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3 flex items-center gap-2">üéØ What You'll Learn <button onClick={() => showInfoModal('Objectives', 'Master AR aging analysis, collection strategies, DSO calculation, bad debt management, and credit policy.')} className="text-sky-400">‚ÑπÔ∏è</button></h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Reading AR aging reports</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Collection strategies by situation</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Days Sales Outstanding (DSO)</li>
                        <li className="flex items-center gap-2"><span className="text-green-400">‚úì</span> Bad debt & allowance</li>
                     </ul>
                  </div>
                  <div className="bg-white/5 rounded-xl p-4">
                     <h3 className="font-bold mb-3">üéÆ Game Structure</h3>
                     <ul className="space-y-2 text-white/80 text-sm">
                        <li className="flex items-center gap-2"><span className="text-sky-400">1</span> Tutorial</li>
                        <li className="flex items-center gap-2"><span className="text-sky-400">2</span> Analyze aging report</li>
                        <li className="flex items-center gap-2"><span className="text-sky-400">3</span> Choose collection actions</li>
                        <li className="flex items-center gap-2"><span className="text-sky-400">4</span> Scenario challenges</li>
                     </ul>
                  </div>
               </div>
               <div className="bg-gradient-to-r from-sky-500/20 to-blue-500/20 rounded-xl p-4 mb-6">
                  <h3 className="font-bold mb-3">üìä Sample AR Aging</h3>
                  <div className="grid grid-cols-5 gap-2 text-center text-sm">
                     <div className="bg-emerald-500/30 rounded p-2"><div className="font-bold">${aging.current.toLocaleString()}</div><div className="text-xs">Current</div></div>
                     <div className="bg-amber-500/30 rounded p-2"><div className="font-bold">${aging.days30.toLocaleString()}</div><div className="text-xs">1-30 Days</div></div>
                     <div className="bg-orange-500/30 rounded p-2"><div className="font-bold">${aging.days60.toLocaleString()}</div><div className="text-xs">31-60 Days</div></div>
                     <div className="bg-rose-500/30 rounded p-2"><div className="font-bold">${aging.days90.toLocaleString()}</div><div className="text-xs">61-90+ Days</div></div>
                     <div className="bg-white/20 rounded p-2"><div className="font-bold">${getTotalAR().toLocaleString()}</div><div className="text-xs">Total AR</div></div>
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-4 bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 rounded-xl font-bold text-lg">Start Learning ‚Üí</button>
               {showInfo && infoContent && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 rounded-xl p-6 max-w-md"><h3 className="text-xl font-bold mb-3">{infoContent.title}</h3><p className="text-white/80 mb-4">{infoContent.content}</p><button onClick={() => setShowInfo(false)} className="w-full py-2 bg-sky-600 rounded-lg">Got it!</button></div></div>)}
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-sky-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">üìö Tutorial</h2><div className="text-white/60">Step {tutorialStep + 1}/{tutorialSteps.length}</div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-sky-500 to-blue-500 h-2 rounded-full" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="text-xl font-bold mb-4">{step.title}</h3>
                  <p className="text-lg text-white/90 mb-6">{step.content}</p>
                  {step.highlight === 'aging' && (
                     <div className="bg-white/10 rounded-lg p-4">
                        <div className="font-bold text-center mb-3 text-sky-400">AR Aging Buckets</div>
                        <div className="grid grid-cols-4 gap-2 text-sm">
                           <div className="bg-emerald-500/30 rounded p-2 text-center"><div className="font-bold">Current</div><div className="text-xs">0-30 days</div><div className="text-xs text-white/60">~95% collectible</div></div>
                           <div className="bg-amber-500/30 rounded p-2 text-center"><div className="font-bold">31-60</div><div className="text-xs">Past due</div><div className="text-xs text-white/60">~85% collectible</div></div>
                           <div className="bg-orange-500/30 rounded p-2 text-center"><div className="font-bold">61-90</div><div className="text-xs">Overdue</div><div className="text-xs text-white/60">~70% collectible</div></div>
                           <div className="bg-rose-500/30 rounded p-2 text-center"><div className="font-bold">90+</div><div className="text-xs">Delinquent</div><div className="text-xs text-white/60">~50% collectible</div></div>
                        </div>
                     </div>
                  )}
                  {step.highlight === 'dso' && (
                     <div className="bg-sky-500/20 border border-sky-500/50 rounded-lg p-4">
                        <div className="font-bold mb-2">üìê DSO Formula</div>
                        <div className="font-mono text-center text-lg mb-2">DSO = (AR √∑ Revenue) √ó Days</div>
                        <div className="text-sm text-white/70">Example: $100K AR √∑ $300K quarterly revenue √ó 90 days = <span className="text-sky-400 font-bold">30 days DSO</span></div>
                     </div>
                  )}
                  {step.highlight === 'strategies' && (
                     <div className="grid grid-cols-3 gap-2 text-sm">
                        <div className="bg-emerald-500/20 rounded p-2"><div className="font-bold">üìß Reminder</div><div className="text-xs">Current/30 days</div></div>
                        <div className="bg-amber-500/20 rounded p-2"><div className="font-bold">üìû Call</div><div className="text-xs">30-60 days</div></div>
                        <div className="bg-rose-500/20 rounded p-2"><div className="font-bold">‚öñÔ∏è Collections</div><div className="text-xs">90+ days</div></div>
                     </div>
                  )}
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(p => p - 1)} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">‚Üê Back</button>}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(p => p + 1); else { setPhase('aging'); setGameLog(['Started AR aging analysis']); } }} className="flex-1 py-3 bg-gradient-to-r from-sky-600 to-blue-600 rounded-xl font-bold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Analyze Aging ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'aging') {
         const aging = getAgingTotals();
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-sky-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4">
                  <div><h2 className="text-xl font-bold">üìä AR Aging Report</h2><p className="text-white/60 text-sm">Select customers to take collection action</p></div>
                  <div className="text-right"><div className="text-xs text-white/60">Collected</div><div className="font-mono font-bold text-emerald-400">${totalCollected.toLocaleString()}</div></div>
               </div>
               <div className="grid grid-cols-5 gap-2 mb-4 text-center text-sm">
                  <div className="bg-emerald-500/30 rounded p-2"><div className="font-bold">${aging.current.toLocaleString()}</div><div className="text-xs">Current</div></div>
                  <div className="bg-amber-500/30 rounded p-2"><div className="font-bold">${aging.days30.toLocaleString()}</div><div className="text-xs">1-30</div></div>
                  <div className="bg-orange-500/30 rounded p-2"><div className="font-bold">${aging.days60.toLocaleString()}</div><div className="text-xs">31-60</div></div>
                  <div className="bg-rose-500/30 rounded p-2"><div className="font-bold">${aging.days90.toLocaleString()}</div><div className="text-xs">61-90+</div></div>
                  <div className="bg-white/20 rounded p-2"><div className="font-bold">${getTotalAR().toLocaleString()}</div><div className="text-xs">Total</div></div>
               </div>
               <div className="bg-white/5 rounded-xl overflow-hidden mb-4">
                  <div className="grid grid-cols-12 gap-1 p-2 bg-white/10 text-xs font-bold">
                     <div className="col-span-2">Customer</div>
                     <div className="col-span-2 text-right">Current</div>
                     <div className="col-span-2 text-right">1-30</div>
                     <div className="col-span-2 text-right">31-60</div>
                     <div className="col-span-2 text-right">61-90+</div>
                     <div className="col-span-2 text-right">Total</div>
                  </div>
                  {customers.map(c => (
                     <div key={c.id} onClick={() => setSelectedCustomer(selectedCustomer === c.id ? null : c.id)} className={`grid grid-cols-12 gap-1 p-2 text-xs border-b border-white/5 cursor-pointer hover:bg-white/10 ${selectedCustomer === c.id ? 'bg-sky-500/20' : ''}`}>
                        <div className="col-span-2 flex items-center gap-1">{c.name} {c.days90 > 0 && <span className="text-rose-400">‚ö†Ô∏è</span>}</div>
                        <div className="col-span-2 text-right font-mono">{c.current > 0 ? `$${c.current.toLocaleString()}` : '-'}</div>
                        <div className="col-span-2 text-right font-mono text-amber-400">{c.days30 > 0 ? `$${c.days30.toLocaleString()}` : '-'}</div>
                        <div className="col-span-2 text-right font-mono text-orange-400">{c.days60 > 0 ? `$${c.days60.toLocaleString()}` : '-'}</div>
                        <div className="col-span-2 text-right font-mono text-rose-400">{c.days90 > 0 ? `$${c.days90.toLocaleString()}` : '-'}</div>
                        <div className="col-span-2 text-right font-mono font-bold">${c.total.toLocaleString()}</div>
                     </div>
                  ))}
               </div>
               {selectedCustomer && (() => { const c = customers.find(cu => cu.id === selectedCustomer); return c ? (
                  <div className="bg-white/10 rounded-xl p-4 mb-4">
                     <div className="flex justify-between items-start mb-3">
                        <div><h3 className="font-bold">{c.name}</h3><div className="text-xs text-white/60">Contact: {c.contact} | History: <span className={c.paymentHistory === 'Excellent' ? 'text-emerald-400' : c.paymentHistory === 'Good' ? 'text-sky-400' : c.paymentHistory === 'Fair' ? 'text-amber-400' : 'text-rose-400'}>{c.paymentHistory}</span></div></div>
                        <button onClick={() => setSelectedCustomer(null)} className="text-white/60">‚úï</button>
                     </div>
                     <div className="text-sm mb-3">Credit Limit: ${c.creditLimit.toLocaleString()} | Outstanding: ${c.total.toLocaleString()} ({Math.round(c.total/c.creditLimit*100)}% utilized)</div>
                     <div className="text-xs text-white/60 mb-2">Choose collection action:</div>
                     <div className="grid grid-cols-3 gap-2">
                        {collectionStrategies.map(s => (
                           <button key={s.id} onClick={() => handleCollectionAction(c.id, s.id)} className="bg-white/10 hover:bg-white/20 rounded-lg p-2 text-left">
                              <div className="font-bold text-sm">{s.name}</div>
                              <div className="text-xs text-white/60">{s.description}</div>
                           </button>
                        ))}
                     </div>
                  </div>
               ) : null; })()}
               {collectionActions.length > 0 && (
                  <div className="bg-white/5 rounded-xl p-3 mb-4 max-h-24 overflow-y-auto">
                     <div className="text-xs font-bold mb-1">Recent Actions:</div>
                     {collectionActions.slice(-3).map((a, i) => (<div key={i} className="text-xs text-white/70">{a.action}: {a.result}</div>))}
                  </div>
               )}
               <button onClick={() => { setPhase('collect'); setGameLog(p => [...p, 'Moving to scenario questions']); }} className="w-full py-3 bg-gradient-to-r from-sky-600 to-blue-600 rounded-xl font-bold">Continue to Scenarios ‚Üí</button>
            </div>
         );
      }

      if (phase === 'collect') {
         const s = scenarios[currentScenario];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-sky-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="flex justify-between items-center mb-4"><div><h2 className="text-xl font-bold">üéØ Collection Scenarios</h2><p className="text-white/60 text-sm">Q{currentScenario + 1}/{scenarios.length}</p></div><div className="bg-white/10 rounded-lg px-3 py-1">Score: <span className="font-bold">{score}</span></div></div>
               <div className="w-full bg-white/10 rounded-full h-2 mb-6"><div className="bg-gradient-to-r from-amber-500 to-orange-500 h-2 rounded-full" style={{ width: `${((currentScenario + 1) / scenarios.length) * 100}%` }} /></div>
               <div className="bg-white/10 rounded-xl p-6 mb-4">
                  <p className="text-lg mb-6">{s.question}</p>
                  <div className="space-y-2">{s.options.map(o => (<button key={o} onClick={() => !showFeedback && handleScenarioAnswer(o)} disabled={showFeedback} className={`w-full py-3 px-4 rounded-xl font-medium text-left transition-all ${showFeedback && o === s.correctAnswer ? 'bg-emerald-500' : showFeedback && scenarioAnswer === o && o !== s.correctAnswer ? 'bg-rose-500' : 'bg-white/10 hover:bg-white/20'}`}>{o}</button>))}</div>
               </div>
               {showFeedback && (<div className={`p-4 rounded-xl ${feedbackCorrect ? 'bg-emerald-500/30 border border-emerald-500' : 'bg-rose-500/30 border border-rose-500'}`}><div className="flex items-start gap-2"><span className="text-xl">{feedbackCorrect ? '‚úì' : '‚úó'}</span><div><div className="font-bold mb-1">{feedbackCorrect ? 'Correct!' : 'Not quite'}</div><div className="text-sm text-white/80">{s.explanation}</div></div></div></div>)}
            </div>
         );
      }

      if (phase === 'result') {
         const acc = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
         const grade = acc >= 90 ? 'A' : acc >= 80 ? 'B' : acc >= 70 ? 'C' : acc >= 60 ? 'D' : 'F';
         return (
            <div className="p-6 bg-gradient-to-br from-slate-900 via-sky-900 to-slate-900 rounded-2xl text-white min-h-[600px]">
               <div className="text-center mb-6"><div className="text-6xl mb-4">üí∞</div><h2 className="text-3xl font-bold mb-2">AR & Collections Mastered!</h2></div>
               <div className="grid grid-cols-4 gap-3 mb-6">
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-amber-400">{score}</div><div className="text-white/60 text-sm">Points</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-emerald-400">{acc}%</div><div className="text-white/60 text-sm">Accuracy</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className={`text-2xl font-bold ${grade === 'A' ? 'text-emerald-400' : 'text-sky-400'}`}>{grade}</div><div className="text-white/60 text-sm">Grade</div></div>
                  <div className="bg-white/10 rounded-xl p-4 text-center"><div className="text-2xl font-bold text-green-400">${totalCollected.toLocaleString()}</div><div className="text-white/60 text-sm">Collected</div></div>
               </div>
               <div className="bg-white/10 rounded-xl p-6 mb-6">
                  <h3 className="font-bold text-lg mb-4">üí° Key Takeaways</h3>
                  <ul className="space-y-2 text-sm">
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Aging Analysis:</strong> Older buckets = higher risk, lower collectibility</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Match Strategy:</strong> Reminders for recent, calls for relationships, collections for 90+</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>DSO Matters:</strong> Lower DSO = faster cash conversion</span></li>
                     <li className="flex items-start gap-2"><span className="text-emerald-400">‚úì</span><span><strong>Prevention:</strong> Credit policies prevent bad debt</span></li>
                  </ul>
               </div>
               <div className="flex gap-3">
                  <button onClick={() => { setPhase('intro'); setScore(0); setCurrentScenario(0); setCollectionActions([]); setTotalCollected(0); setCorrectAnswers(0); setTotalAnswered(0); }} className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold">üîÑ Again</button>
                  <button onClick={() => setPhase('intro')} className="flex-1 py-3 bg-gradient-to-r from-sky-600 to-blue-600 rounded-xl font-bold">‚úì Done</button>
               </div>
            </div>
         );
      }

      return null;
   };

   const BankReconciliationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [reconciledItems, setReconciledItems] = useState<number[]>([]);
      const [adjustments, setAdjustments] = useState<{[key: number]: 'book' | 'bank' | null}>({});
      const [showReconciliation, setShowReconciliation] = useState(false);

      const tutorials = [
         { title: "Why Reconcile?", content: "Bank reconciliation catches errors, fraud, and timing differences between your records and the bank's records.", icon: "üéØ" },
         { title: "Bank Statement Balance", content: "Starting point: The ending balance from your bank statement. This is what the bank says you have.", icon: "üè¶" },
         { title: "Book Balance", content: "Your internal records (accounting system). This is what YOU think you have.", icon: "üìí" },
         { title: "Deposits in Transit", content: "Money you've recorded as deposited but hasn't cleared the bank yet. Add to bank balance.", icon: "üì•" },
         { title: "Outstanding Checks", content: "Checks you've written and recorded but haven't been cashed yet. Subtract from bank balance.", icon: "‚úâÔ∏è" },
         { title: "Bank Charges & Interest", content: "Fees or interest the bank recorded but you haven't yet. Adjust book balance.", icon: "üí≥" },
         { title: "Goal: Balances Match!", content: "After adjustments, adjusted book balance must equal adjusted bank balance. Differences = errors!", icon: "‚úÖ" }
      ];

      const infoTopics: {[key: string]: string} = {
         deposit_in_transit: "Deposits in transit occur when you deposit money near month-end. You've recorded it, but the bank processes it the next business day. Common with Friday deposits!",
         outstanding_check: "Outstanding checks are written and mailed but not yet cashed. A check written Dec 28 might not be cashed until January. The bank doesn't know about it yet!",
         bank_charge: "Bank charges include monthly fees, wire transfer fees, overdraft fees, and check printing charges. Banks often deduct these without notice!",
         nsf_check: "NSF (Non-Sufficient Funds) checks are customer checks that bounced. The bank initially credited you, then reversed it when the check bounced. You need to reverse your entry too!",
         bank_error: "Banks make mistakes too! If they posted a deposit to wrong account or miscounted cash, you note the error but THEY fix their records, not you.",
         book_error: "Book errors are YOUR mistakes - transposed digits (writing $96 instead of $69), wrong amounts, or missed entries. These require correcting journal entries."
      };

      const levels = [
         {
            name: "Basic Reconciliation",
            bankBalance: 15420.00,
            bookBalance: 14850.00,
            items: [
               { id: 1, desc: "Check #1045 to ABC Supply", amount: -350.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Check written Dec 28, not yet cashed by vendor" },
               { id: 2, desc: "Dec 31 customer deposit", amount: 520.00, type: 'deposit_in_transit', side: 'bank' as const, explanation: "Deposited Friday PM, clears Monday" },
               { id: 3, desc: "Monthly service charge", amount: -25.00, type: 'bank_charge', side: 'book' as const, explanation: "Bank deducted fee, you didn't know yet" },
               { id: 4, desc: "Interest earned", amount: 15.00, type: 'interest', side: 'book' as const, explanation: "Bank credited interest you need to record" },
               { id: 5, desc: "Check #1042 to vendor", amount: -280.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Mailed last week, still not cashed" }
            ],
            targetBankAdjusted: 15310.00,
            targetBookAdjusted: 14840.00
         },
         {
            name: "NSF Check Challenge",
            bankBalance: 28750.00,
            bookBalance: 29180.00,
            items: [
               { id: 1, desc: "Customer check returned NSF", amount: -450.00, type: 'nsf_check', side: 'book' as const, explanation: "Customer's check bounced - bank reversed the deposit" },
               { id: 2, desc: "Deposit in transit", amount: 1200.00, type: 'deposit_in_transit', side: 'bank' as const, explanation: "Friday deposit, won't clear until Monday" },
               { id: 3, desc: "Outstanding check #2105", amount: -890.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Large check to supplier not yet cashed" },
               { id: 4, desc: "Bank wire fee", amount: -30.00, type: 'bank_charge', side: 'book' as const, explanation: "Fee for incoming wire transfer" },
               { id: 5, desc: "Outstanding check #2108", amount: -320.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Rent check, landlord slow to deposit" },
               { id: 6, desc: "Collection by bank", amount: 260.00, type: 'collection', side: 'book' as const, explanation: "Bank collected note receivable for you" }
            ],
            targetBankAdjusted: 28740.00,
            targetBookAdjusted: 28960.00
         },
         {
            name: "Error Detection",
            bankBalance: 45320.00,
            bookBalance: 44780.00,
            items: [
               { id: 1, desc: "Check #3055 recorded as $540 (actual $450)", amount: 90.00, type: 'book_error', side: 'book' as const, explanation: "You recorded check for $540 but wrote it for $450. Add $90 back!" },
               { id: 2, desc: "Bank error - deposit credited to wrong acct", amount: 800.00, type: 'bank_error', side: 'bank' as const, explanation: "Bank put your $800 in someone else's account" },
               { id: 3, desc: "Outstanding checks total", amount: -1250.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Three checks totaling $1,250 not yet cashed" },
               { id: 4, desc: "Deposits in transit", amount: 650.00, type: 'deposit_in_transit', side: 'bank' as const, explanation: "End of month deposits not yet cleared" },
               { id: 5, desc: "Bank charges", amount: -45.00, type: 'bank_charge', side: 'book' as const, explanation: "Monthly fees and check printing" },
               { id: 6, desc: "NSF check from customer", amount: -225.00, type: 'nsf_check', side: 'book' as const, explanation: "Customer payment bounced" }
            ],
            targetBankAdjusted: 45520.00,
            targetBookAdjusted: 44600.00
         },
         {
            name: "Complex Month-End",
            bankBalance: 87450.00,
            bookBalance: 86280.00,
            items: [
               { id: 1, desc: "Deposits in transit (3 deposits)", amount: 2340.00, type: 'deposit_in_transit', side: 'bank' as const, explanation: "Three customer deposits made Dec 30-31" },
               { id: 2, desc: "Outstanding checks (7 checks)", amount: -3180.00, type: 'outstanding_check', side: 'bank' as const, explanation: "Year-end vendor payments not yet cleared" },
               { id: 3, desc: "Check #4521 transposed digits $860‚Üí$680", amount: 180.00, type: 'book_error', side: 'book' as const, explanation: "Wrote check for $680, recorded as $860" },
               { id: 4, desc: "NSF checks (2 customers)", amount: -720.00, type: 'nsf_check', side: 'book' as const, explanation: "Two customer checks bounced" },
               { id: 5, desc: "Bank loan payment auto-debit", amount: -1500.00, type: 'auto_debit', side: 'book' as const, explanation: "Automatic loan payment you forgot to record" },
               { id: 6, desc: "Interest income", amount: 85.00, type: 'interest', side: 'book' as const, explanation: "Monthly interest earned on account" },
               { id: 7, desc: "Wire transfer fee", amount: -45.00, type: 'bank_charge', side: 'book' as const, explanation: "Fees for outgoing wire" },
               { id: 8, desc: "Customer direct deposit", amount: 950.00, type: 'eft', side: 'book' as const, explanation: "Customer paid via ACH, bank credited but you didn't record" }
            ],
            targetBankAdjusted: 86610.00,
            targetBookAdjusted: 85230.00
         }
      ];

      const currentLevel = levels[level];

      const calculateAdjustedBalances = () => {
         let adjBank = currentLevel.bankBalance;
         let adjBook = currentLevel.bookBalance;

         currentLevel.items.forEach((item, idx) => {
            if (adjustments[item.id] === item.side) {
               if (item.side === 'bank') {
                  adjBank += item.amount;
               } else {
                  adjBook += item.amount;
               }
            }
         });

         return { adjBank, adjBook };
      };

      const handleAdjustment = (itemId: number, side: 'book' | 'bank') => {
         const item = currentLevel.items.find(i => i.id === itemId);
         if (!item) return;

         const currentAdj = adjustments[itemId];
         if (currentAdj === side) {
            // Toggle off
            setAdjustments(prev => ({ ...prev, [itemId]: null }));
         } else {
            setAdjustments(prev => ({ ...prev, [itemId]: side }));

            if (side === item.side && !reconciledItems.includes(itemId)) {
               setReconciledItems(prev => [...prev, itemId]);
               setScore(prev => prev + 10);
               setGameLog(prev => [...prev, `Correctly identified: ${item.desc} adjusts ${side} balance`]);
            } else if (side !== item.side) {
               setGameLog(prev => [...prev, `Incorrect: ${item.desc} should adjust ${item.side}, not ${side}`]);
            }
         }
      };

      const checkReconciliation = () => {
         setShowReconciliation(true);
         const { adjBank, adjBook } = calculateAdjustedBalances();
         const allCorrect = currentLevel.items.every(item => adjustments[item.id] === item.side);

         if (allCorrect) {
            setScore(prev => prev + 50);
            setGameLog(prev => [...prev, `Level ${level + 1} complete! Bank: $${adjBank.toFixed(2)}, Book: $${adjBook.toFixed(2)}`]);
         }
      };

      const nextLevel = () => {
         if (level < levels.length - 1) {
            setLevel(prev => prev + 1);
            setAdjustments({});
            setReconciledItems([]);
            setShowReconciliation(false);
         } else {
            setPhase('result');
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-teal-50 to-cyan-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üè¶</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Bank Reconciliation</h1>
                  <p className="text-gray-600 mb-6">Master the art of matching your books to the bank statement. Find timing differences, catch errors, and ensure every dollar is accounted for!</p>
                  <div className="bg-teal-50 rounded-lg p-4 mb-6 text-left">
                     <p className="text-sm text-teal-800">
                        <strong>Why this matters:</strong> A $500 error caught through reconciliation once saved a company from a $50,000 fraud. The thief was writing small checks hoping they'd go unnoticed!
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-teal-500 text-white rounded-xl font-semibold hover:bg-teal-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-teal-50 to-cyan-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-teal-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-teal-500 text-white rounded-xl font-semibold hover:bg-teal-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Start Reconciling!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const { adjBank, adjBook } = calculateAdjustedBalances();
         const allCorrect = currentLevel.items.every(item => adjustments[item.id] === item.side);

         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-teal-50 to-cyan-100 p-4">
               {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Level {level + 1}: {currentLevel.name}</h2>
                     <p className="text-sm text-gray-600">Match each item to the correct side</p>
                  </div>
                  <div className="text-right">
                     <span className="text-xl font-bold text-teal-600">{score} pts</span>
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                     <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-semibold text-blue-700">üè¶ Bank Statement</span>
                     </div>
                     <div className="text-lg font-bold text-blue-800">${currentLevel.bankBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                     <div className="text-xs text-blue-600 mt-1">+ Deposits in Transit</div>
                     <div className="text-xs text-blue-600">- Outstanding Checks</div>
                     <div className="border-t border-blue-300 mt-2 pt-2">
                        <div className="text-sm font-bold text-blue-800">Adjusted: ${adjBank.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                     </div>
                  </div>
                  <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                     <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-semibold text-green-700">üìí Book Balance</span>
                     </div>
                     <div className="text-lg font-bold text-green-800">${currentLevel.bookBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                     <div className="text-xs text-green-600 mt-1">+ Interest/Collections</div>
                     <div className="text-xs text-green-600">- Bank Charges/NSF</div>
                     <div className="border-t border-green-300 mt-2 pt-2">
                        <div className="text-sm font-bold text-green-800">Adjusted: ${adjBook.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                     </div>
                  </div>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                  <h3 className="font-semibold text-gray-700 mb-3">Reconciling Items - Click to assign:</h3>
                  <div className="space-y-2">
                     {currentLevel.items.map(item => (
                        <div key={item.id} className="border rounded-lg p-3 bg-gray-50">
                           <div className="flex items-center justify-between">
                              <div className="flex-1">
                                 <div className="flex items-center gap-2">
                                    <span className="font-medium text-gray-800">{item.desc}</span>
                                    <button
                                       onClick={() => { setInfoTopic(item.type); setShowInfo(true); }}
                                       className="text-blue-500 hover:text-blue-700"
                                    >‚ÑπÔ∏è</button>
                                 </div>
                                 <span className={`text-sm font-semibold ${item.amount >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {item.amount >= 0 ? '+' : ''}{item.amount.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}
                                 </span>
                                 {adjustments[item.id] && adjustments[item.id] === item.side && (
                                    <span className="ml-2 text-xs text-green-600">‚úì Correct!</span>
                                 )}
                                 {adjustments[item.id] && adjustments[item.id] !== item.side && (
                                    <span className="ml-2 text-xs text-red-600">‚úó Wrong side</span>
                                 )}
                              </div>
                              <div className="flex gap-2">
                                 <button
                                    onClick={() => handleAdjustment(item.id, 'bank')}
                                    className={`px-3 py-1 rounded text-sm font-medium transition-all ${adjustments[item.id] === 'bank' ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`}
                                 >Bank</button>
                                 <button
                                    onClick={() => handleAdjustment(item.id, 'book')}
                                    className={`px-3 py-1 rounded text-sm font-medium transition-all ${adjustments[item.id] === 'book' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                                 >Book</button>
                              </div>
                           </div>
                           {showReconciliation && (
                              <div className="mt-2 text-xs text-gray-600 bg-yellow-50 p-2 rounded">
                                 üí° {item.explanation}
                              </div>
                           )}
                        </div>
                     ))}
                  </div>
               </div>

               <div className="mt-4 flex gap-3">
                  {!showReconciliation ? (
                     <button
                        onClick={checkReconciliation}
                        disabled={Object.keys(adjustments).length < currentLevel.items.length}
                        className={`flex-1 py-3 rounded-xl font-semibold transition-all ${Object.keys(adjustments).length >= currentLevel.items.length ? 'bg-teal-500 text-white hover:bg-teal-600' : 'bg-gray-200 text-gray-400'}`}
                     >
                        Check Reconciliation
                     </button>
                  ) : (
                     <button
                        onClick={nextLevel}
                        className="flex-1 py-3 bg-teal-500 text-white rounded-xl font-semibold hover:bg-teal-600"
                     >
                        {allCorrect ? (level < levels.length - 1 ? 'Next Level ‚Üí' : 'See Results') : 'Try Again'}
                     </button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = levels.reduce((sum, l) => sum + l.items.length * 10 + 50, 0);
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-teal-50 to-cyan-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Reconciliation Complete!</h1>
                  <div className="text-4xl font-bold text-teal-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-teal-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Deposits in Transit & Outstanding Checks</strong> adjust the BANK balance</li>
                        <li>‚Ä¢ <strong>Bank Charges, NSF Checks & Interest</strong> adjust YOUR BOOK balance</li>
                        <li>‚Ä¢ <strong>Errors</strong> are fixed on whichever side made the mistake</li>
                        <li>‚Ä¢ Goal: Adjusted Bank = Adjusted Book (differences = problems!)</li>
                     </ul>
                  </div>

                  <div className="bg-teal-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-teal-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-teal-700">
                        Reconcile monthly, within 5 days of statement date. The longer you wait, the harder to find errors. Many frauds are caught because reconciliation revealed unauthorized transactions!
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAdjustments({}); setReconciledItems([]); setShowReconciliation(false); setGameLog([]); }} className="w-full py-3 bg-teal-500 text-white rounded-xl font-semibold hover:bg-teal-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const BalanceSheetRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [placements, setPlacements] = useState<{[key: string]: string}>({});
      const [showFeedback, setShowFeedback] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "The Balance Sheet Equation", content: "Assets = Liabilities + Equity. This MUST always balance! If it doesn't, something is wrong.", icon: "‚öñÔ∏è" },
         { title: "Assets", content: "What the company OWNS. Split into Current (cash within 1 year) and Non-Current (long-term like buildings, equipment).", icon: "üí∞" },
         { title: "Liabilities", content: "What the company OWES. Current (due within 1 year) and Long-term (mortgages, bonds).", icon: "üìã" },
         { title: "Equity", content: "What's left for OWNERS after paying all debts. Includes invested capital and retained earnings.", icon: "üë•" },
         { title: "Liquidity Order", content: "Assets listed most liquid first (cash) to least liquid (property). This shows how quickly assets convert to cash.", icon: "üîÑ" },
         { title: "Point in Time", content: "Balance sheet is a SNAPSHOT at a specific date, not over a period. 'As of December 31, 2024' not 'For the year 2024'.", icon: "üì∏" },
         { title: "Working Capital", content: "Current Assets - Current Liabilities = Working Capital. Positive means company can pay short-term bills!", icon: "üìä" }
      ];

      const infoTopics: {[key: string]: string} = {
         current_assets: "Current assets are expected to convert to cash within one year: Cash, Accounts Receivable, Inventory, Prepaid Expenses.",
         non_current_assets: "Non-current (fixed) assets provide value for more than one year: Property, Plant & Equipment (PP&E), Intangible Assets, Long-term Investments.",
         current_liabilities: "Current liabilities are due within one year: Accounts Payable, Short-term Debt, Accrued Expenses, Current portion of Long-term Debt.",
         long_term_liabilities: "Long-term liabilities are due beyond one year: Bonds Payable, Long-term Loans, Lease Obligations, Pension Liabilities.",
         equity: "Shareholders' equity includes: Common Stock (invested capital), Retained Earnings (accumulated profits), Additional Paid-in Capital, Treasury Stock.",
         working_capital: "Working Capital = Current Assets - Current Liabilities. Positive working capital means the company can meet short-term obligations. Negative could signal liquidity problems."
      };

      const levels = [
         {
            name: "Classify Balance Sheet Items",
            items: [
               { id: 'cash', name: 'Cash & Equivalents', correct: 'current_assets', hint: 'Most liquid asset' },
               { id: 'ar', name: 'Accounts Receivable', correct: 'current_assets', hint: 'Money owed by customers' },
               { id: 'inventory', name: 'Inventory', correct: 'current_assets', hint: 'Goods for sale' },
               { id: 'ppe', name: 'Property, Plant & Equipment', correct: 'non_current_assets', hint: 'Physical long-term assets' },
               { id: 'ap', name: 'Accounts Payable', correct: 'current_liabilities', hint: 'Money owed to suppliers' },
               { id: 'wages', name: 'Wages Payable', correct: 'current_liabilities', hint: 'Owed to employees' },
               { id: 'mortgage', name: 'Mortgage Payable', correct: 'long_term_liabilities', hint: 'Long-term building loan' },
               { id: 'common', name: 'Common Stock', correct: 'equity', hint: 'Invested by shareholders' },
               { id: 'retained', name: 'Retained Earnings', correct: 'equity', hint: 'Accumulated profits' }
            ],
            categories: ['current_assets', 'non_current_assets', 'current_liabilities', 'long_term_liabilities', 'equity']
         },
         {
            name: "Build a Balanced Sheet",
            scenario: {
               totalAssets: 500000,
               currentAssets: 180000,
               nonCurrentAssets: 320000,
               totalLiabilities: 200000,
               currentLiabilities: 80000,
               longTermLiabilities: 120000,
               equity: 300000
            },
            questions: [
               { q: "If Total Assets = $500,000 and Total Liabilities = $200,000, what is Equity?", a: 300000, explain: "A = L + E, so E = A - L = $500,000 - $200,000 = $300,000" },
               { q: "Current Assets = $180,000, Current Liabilities = $80,000. What's Working Capital?", a: 100000, explain: "Working Capital = CA - CL = $180,000 - $80,000 = $100,000" },
               { q: "If Equity increases by $50,000 and Liabilities stay same, what happens to Assets?", a: 50000, explain: "A = L + E. If E goes up $50K and L unchanged, A must go up $50K to stay balanced!" }
            ]
         }
      ];

      const categories = [
         { id: 'current_assets', label: 'Current Assets', color: 'bg-green-100 border-green-400' },
         { id: 'non_current_assets', label: 'Non-Current Assets', color: 'bg-green-200 border-green-500' },
         { id: 'current_liabilities', label: 'Current Liabilities', color: 'bg-red-100 border-red-400' },
         { id: 'long_term_liabilities', label: 'Long-Term Liabilities', color: 'bg-red-200 border-red-500' },
         { id: 'equity', label: "Shareholders' Equity", color: 'bg-blue-100 border-blue-400' }
      ];

      const handlePlacement = (itemId: string, categoryId: string) => {
         const item = levels[0].items.find(i => i.id === itemId);
         if (!item) return;

         setPlacements(prev => ({ ...prev, [itemId]: categoryId }));

         if (categoryId === item.correct) {
            setScore(prev => prev + 10);
            setGameLog(prev => [...prev, `Correct: ${item.name} is a ${categoryId.replace(/_/g, ' ')}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect: ${item.name} belongs in ${item.correct.replace(/_/g, ' ')}, not ${categoryId.replace(/_/g, ' ')}`]);
         }
      };

      const checkLevel = () => {
         setShowFeedback(true);
         const correctCount = levels[0].items.filter(item => placements[item.id] === item.correct).length;
         if (correctCount === levels[0].items.length) {
            setScore(prev => prev + 50);
            setGameLog(prev => [...prev, 'All items classified correctly!']);
         }
      };

      const quizzes = [
         { q: "Which appears FIRST on a balance sheet?", opts: ["Accounts Receivable", "Cash", "Inventory", "Equipment"], correct: 1, explain: "Cash is the most liquid asset and appears first in liquidity order." },
         { q: "A company has $100K assets, $40K liabilities. What's owner equity?", opts: ["$140,000", "$40,000", "$60,000", "$100,000"], correct: 2, explain: "A = L + E ‚Üí $100K = $40K + E ‚Üí E = $60K" },
         { q: "Working capital of -$20,000 indicates:", opts: ["Company is profitable", "Company may have trouble paying short-term debts", "Company has too much cash", "Company should expand"], correct: 1, explain: "Negative working capital means current liabilities exceed current assets - a liquidity concern." },
         { q: "Retained earnings belong in:", opts: ["Assets", "Current Liabilities", "Long-term Liabilities", "Shareholders' Equity"], correct: 3, explain: "Retained earnings are accumulated profits kept in the business, part of equity." },
         { q: "A 10-year loan taken today appears as:", opts: ["Current Asset", "Non-Current Asset", "Current Liability only", "Both Current and Long-term Liability"], correct: 3, explain: "The portion due within 1 year is current liability; remaining is long-term. 10-year loans split across both." },
         { q: "Balance sheet is dated 'As of Dec 31'. This means:", opts: ["For the entire year", "A snapshot on that specific date", "Projected for next year", "Average for December"], correct: 1, explain: "Balance sheets capture a point in time, unlike income statements which cover a period." }
      ];

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         } else {
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Incorrect. ${quizzes[quizIndex].explain}`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-indigo-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">‚öñÔ∏è</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">The Balance Sheet</h1>
                  <p className="text-gray-600 mb-6">Master the fundamental accounting equation. Learn to read what a company owns, owes, and what's left for shareholders.</p>
                  <div className="bg-indigo-50 rounded-lg p-4 mb-6">
                     <p className="text-2xl font-bold text-indigo-700 mb-2">Assets = Liabilities + Equity</p>
                     <p className="text-sm text-indigo-600">This equation MUST always balance!</p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-indigo-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-indigo-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Start Classifying!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const allPlaced = Object.keys(placements).length === levels[0].items.length;
         const inQuizMode = level === 1;

         if (!inQuizMode) {
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-indigo-50 to-purple-100 p-4">
                  {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">Classify Balance Sheet Items</h2>
                        <p className="text-sm text-gray-600">Select the correct category for each item</p>
                     </div>
                     <span className="text-xl font-bold text-indigo-600">{score} pts</span>
                  </div>

                  <div className="grid grid-cols-5 gap-2 mb-4">
                     {categories.map(cat => (
                        <div key={cat.id} className="text-center">
                           <button
                              onClick={() => { setInfoTopic(cat.id); setShowInfo(true); }}
                              className={`w-full py-2 px-1 rounded-lg text-xs font-semibold ${cat.color} border-2 hover:opacity-80`}
                           >
                              {cat.label} ‚ÑπÔ∏è
                           </button>
                        </div>
                     ))}
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                     <div className="space-y-3">
                        {levels[0].items.map(item => (
                           <div key={item.id} className="border rounded-lg p-3 bg-gray-50">
                              <div className="flex items-center justify-between mb-2">
                                 <div>
                                    <span className="font-medium text-gray-800">{item.name}</span>
                                    <span className="text-xs text-gray-500 ml-2">({item.hint})</span>
                                 </div>
                                 {showFeedback && (
                                    <span className={`text-sm ${placements[item.id] === item.correct ? 'text-green-600' : 'text-red-600'}`}>
                                       {placements[item.id] === item.correct ? '‚úì' : `‚Üí ${item.correct.replace(/_/g, ' ')}`}
                                    </span>
                                 )}
                              </div>
                              <div className="flex flex-wrap gap-1">
                                 {categories.map(cat => (
                                    <button
                                       key={cat.id}
                                       onClick={() => !showFeedback && handlePlacement(item.id, cat.id)}
                                       disabled={showFeedback}
                                       className={`px-2 py-1 rounded text-xs font-medium transition-all ${placements[item.id] === cat.id ? 'ring-2 ring-indigo-500 ' + cat.color : 'bg-gray-100 hover:bg-gray-200'}`}
                                    >
                                       {cat.label.split(' ')[0]}
                                    </button>
                                 ))}
                              </div>
                           </div>
                        ))}
                     </div>
                  </div>

                  <div className="mt-4">
                     {!showFeedback ? (
                        <button
                           onClick={checkLevel}
                           disabled={!allPlaced}
                           className={`w-full py-3 rounded-xl font-semibold transition-all ${allPlaced ? 'bg-indigo-500 text-white hover:bg-indigo-600' : 'bg-gray-200 text-gray-400'}`}
                        >
                           Check Classifications
                        </button>
                     ) : (
                        <button
                           onClick={() => setLevel(1)}
                           className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600"
                        >
                           Continue to Quiz ‚Üí
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         // Quiz mode
         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-indigo-50 to-purple-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Balance Sheet Quiz</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-indigo-600">{score} pts</span>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button
                           key={idx}
                           onClick={() => handleQuizAnswer(idx)}
                           disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered
                              ? idx === quiz.correct
                                 ? 'bg-green-100 border-2 border-green-500 text-green-800'
                                 : 'bg-gray-100 text-gray-500'
                              : 'bg-gray-50 hover:bg-indigo-50 border-2 border-transparent hover:border-indigo-300'
                           }`}
                        >
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && (
                     <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                        <p className="text-sm text-yellow-800">üí° {quiz.explain}</p>
                     </div>
                  )}
               </div>

               <div className="mt-4">
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = 90 + 50 + 90; // 9 items + bonus + 6 quizzes
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-indigo-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Balance Sheet Mastered!</h1>
                  <div className="text-4xl font-bold text-indigo-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-indigo-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Assets = Liabilities + Equity</strong> must ALWAYS balance</li>
                        <li>‚Ä¢ Current items convert/due within <strong>1 year</strong></li>
                        <li>‚Ä¢ Listed in <strong>liquidity order</strong> (cash first)</li>
                        <li>‚Ä¢ Balance sheet = <strong>snapshot</strong> at a specific date</li>
                     </ul>
                  </div>

                  <div className="bg-indigo-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-indigo-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-indigo-700">
                        The balance sheet reveals financial health: High current ratio (CA/CL {">"} 2) suggests stability. High debt-to-equity warns of risk. Compare over time to spot trends!
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setPlacements({}); setShowFeedback(false); setQuizIndex(0); setQuizAnswered(false); setGameLog([]); }} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const IncomeStatementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "The Income Statement", content: "Also called P&L (Profit & Loss). Shows revenues and expenses over a PERIOD of time (month, quarter, year).", icon: "üìà" },
         { title: "Revenue (Top Line)", content: "Money earned from selling products/services. This is the 'top line' because it appears first.", icon: "üíµ" },
         { title: "Cost of Goods Sold (COGS)", content: "Direct costs to produce what you sold: materials, direct labor, manufacturing. Not overhead!", icon: "üì¶" },
         { title: "Gross Profit", content: "Revenue - COGS = Gross Profit. Shows how much you make BEFORE operating expenses.", icon: "üí∞" },
         { title: "Operating Expenses", content: "Costs to run the business: rent, salaries, marketing, R&D. Not directly tied to production.", icon: "üè¢" },
         { title: "Operating Income (EBIT)", content: "Gross Profit - Operating Expenses. Earnings Before Interest & Taxes. Core business profitability.", icon: "üìä" },
         { title: "Net Income (Bottom Line)", content: "What's left after ALL expenses including interest and taxes. The 'bottom line' - actual profit!", icon: "üéØ" }
      ];

      const infoTopics: {[key: string]: string} = {
         revenue: "Revenue is recognized when earned, not necessarily when cash is received. A $1M contract signed today but paid over 12 months still books revenue based on delivery.",
         cogs: "COGS includes only DIRECT costs: raw materials, direct labor, manufacturing overhead. It does NOT include sales salaries, marketing, or administrative costs.",
         gross_margin: "Gross Margin = Gross Profit / Revenue. A 40% gross margin means for every $1 sold, $0.40 remains after direct costs. Higher is usually better.",
         operating_expenses: "OpEx includes SG&A (Selling, General & Administrative), R&D, and other costs not directly tied to production. These are 'period costs' expensed when incurred.",
         ebitda: "EBITDA = Earnings Before Interest, Taxes, Depreciation & Amortization. Often used to compare companies since it removes financing and accounting differences.",
         net_margin: "Net Margin = Net Income / Revenue. A 10% net margin means $0.10 profit per $1 of revenue. This is the ultimate profitability metric."
      };

      const buildScenarios = [
         {
            name: "Tech Startup P&L",
            revenue: 1000000,
            cogs: 200000,
            operating_expenses: 600000,
            interest: 20000,
            taxes: 36000,
            steps: ['gross_profit', 'operating_income', 'net_income']
         },
         {
            name: "Retail Store P&L",
            revenue: 500000,
            cogs: 300000,
            operating_expenses: 150000,
            interest: 10000,
            taxes: 8000,
            steps: ['gross_profit', 'operating_income', 'net_income']
         }
      ];

      const calculateCorrectAnswers = (scenario: typeof buildScenarios[0]) => ({
         gross_profit: scenario.revenue - scenario.cogs,
         operating_income: scenario.revenue - scenario.cogs - scenario.operating_expenses,
         net_income: scenario.revenue - scenario.cogs - scenario.operating_expenses - scenario.interest - scenario.taxes
      });

      const quizzes = [
         { q: "Revenue appears on which financial statement?", opts: ["Balance Sheet only", "Income Statement only", "Cash Flow Statement only", "All three"], correct: 1, explain: "Revenue is an income statement item. The balance sheet shows assets/liabilities, not revenues." },
         { q: "A company has $800K revenue, $300K COGS, $200K OpEx. What's gross profit?", opts: ["$500,000", "$300,000", "$200,000", "$800,000"], correct: 0, explain: "Gross Profit = Revenue - COGS = $800K - $300K = $500K. Operating expenses come after!" },
         { q: "Which is NOT included in COGS?", opts: ["Raw materials", "Factory rent", "Sales team salaries", "Direct labor"], correct: 2, explain: "Sales salaries are operating expenses (SG&A), not COGS. COGS is only direct production costs." },
         { q: "Operating income is also called:", opts: ["Gross Profit", "EBIT", "Net Income", "Revenue"], correct: 1, explain: "Operating Income = EBIT (Earnings Before Interest and Taxes). It measures core business profitability." },
         { q: "A company with high gross margin but low net margin likely has:", opts: ["Low COGS", "High operating expenses", "Low revenue", "No taxes"], correct: 1, explain: "If gross margin is high but net margin is low, operating expenses are eating into profits significantly." },
         { q: "Income statement covers:", opts: ["A single point in time", "A period of time", "Only cash transactions", "Only credit transactions"], correct: 1, explain: "Unlike balance sheet (point in time), income statement covers a period: 'For the year ended Dec 31, 2024'." }
      ];

      const handleAnswer = (step: string, value: number) => {
         setAnswers(prev => ({ ...prev, [step]: value }));
      };

      const checkAnswers = () => {
         setShowResults(true);
         const correct = calculateCorrectAnswers(buildScenarios[level]);
         let points = 0;
         buildScenarios[level].steps.forEach(step => {
            if (answers[step] === correct[step as keyof typeof correct]) {
               points += 25;
               setGameLog(prev => [...prev, `Correct: ${step.replace(/_/g, ' ')} = $${correct[step as keyof typeof correct].toLocaleString()}`]);
            }
         });
         setScore(prev => prev + points);
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-emerald-50 to-green-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üìà</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Income Statement (P&L)</h1>
                  <p className="text-gray-600 mb-6">Learn to read the Profit & Loss statement - from revenue at the top to net income at the bottom. Understand how every dollar flows!</p>
                  <div className="bg-emerald-50 rounded-lg p-4 mb-6 text-left">
                     <p className="text-sm text-emerald-800 font-mono">
                        Revenue (Top Line)<br/>
                        - COGS<br/>
                        = Gross Profit<br/>
                        - Operating Expenses<br/>
                        = Operating Income<br/>
                        - Interest & Taxes<br/>
                        = <strong>Net Income (Bottom Line)</strong>
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-emerald-50 to-green-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-emerald-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Build a P&L!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const scenario = buildScenarios[level];
         const correct = calculateCorrectAnswers(scenario);
         const inQuizMode = level >= buildScenarios.length;

         if (!inQuizMode) {
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-emerald-50 to-green-100 p-4">
                  {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">{scenario.name}</h2>
                        <p className="text-sm text-gray-600">Calculate the missing values</p>
                     </div>
                     <span className="text-xl font-bold text-emerald-600">{score} pts</span>
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                     <div className="space-y-3 font-mono text-sm">
                        <div className="flex justify-between items-center py-2 border-b">
                           <span className="flex items-center gap-2">
                              Revenue <button onClick={() => { setInfoTopic('revenue'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className="font-bold text-green-600">${scenario.revenue.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b">
                           <span className="flex items-center gap-2">
                              - COGS <button onClick={() => { setInfoTopic('cogs'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className="text-red-600">({scenario.cogs.toLocaleString()})</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b bg-yellow-50 px-2 rounded">
                           <span className="flex items-center gap-2 font-semibold">
                              = Gross Profit <button onClick={() => { setInfoTopic('gross_margin'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           {!showResults ? (
                              <input
                                 type="number"
                                 placeholder="Calculate..."
                                 value={answers.gross_profit || ''}
                                 onChange={(e) => handleAnswer('gross_profit', Number(e.target.value))}
                                 className="w-32 px-2 py-1 border rounded text-right"
                              />
                           ) : (
                              <span className={answers.gross_profit === correct.gross_profit ? 'text-green-600 font-bold' : 'text-red-600'}>
                                 ${correct.gross_profit.toLocaleString()} {answers.gross_profit === correct.gross_profit ? '‚úì' : `(you: ${answers.gross_profit?.toLocaleString()})`}
                              </span>
                           )}
                        </div>
                        <div className="flex justify-between items-center py-2 border-b">
                           <span className="flex items-center gap-2">
                              - Operating Expenses <button onClick={() => { setInfoTopic('operating_expenses'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className="text-red-600">({scenario.operating_expenses.toLocaleString()})</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b bg-yellow-50 px-2 rounded">
                           <span className="flex items-center gap-2 font-semibold">
                              = Operating Income <button onClick={() => { setInfoTopic('ebitda'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           {!showResults ? (
                              <input
                                 type="number"
                                 placeholder="Calculate..."
                                 value={answers.operating_income || ''}
                                 onChange={(e) => handleAnswer('operating_income', Number(e.target.value))}
                                 className="w-32 px-2 py-1 border rounded text-right"
                              />
                           ) : (
                              <span className={answers.operating_income === correct.operating_income ? 'text-green-600 font-bold' : 'text-red-600'}>
                                 ${correct.operating_income.toLocaleString()} {answers.operating_income === correct.operating_income ? '‚úì' : `(you: ${answers.operating_income?.toLocaleString()})`}
                              </span>
                           )}
                        </div>
                        <div className="flex justify-between items-center py-2 border-b">
                           <span>- Interest Expense</span>
                           <span className="text-red-600">({scenario.interest.toLocaleString()})</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b">
                           <span>- Income Taxes</span>
                           <span className="text-red-600">({scenario.taxes.toLocaleString()})</span>
                        </div>
                        <div className="flex justify-between items-center py-3 bg-emerald-50 px-2 rounded border-2 border-emerald-300">
                           <span className="flex items-center gap-2 font-bold text-lg">
                              = Net Income <button onClick={() => { setInfoTopic('net_margin'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           {!showResults ? (
                              <input
                                 type="number"
                                 placeholder="Calculate..."
                                 value={answers.net_income || ''}
                                 onChange={(e) => handleAnswer('net_income', Number(e.target.value))}
                                 className="w-32 px-2 py-1 border rounded text-right"
                              />
                           ) : (
                              <span className={answers.net_income === correct.net_income ? 'text-green-600 font-bold text-lg' : 'text-red-600'}>
                                 ${correct.net_income.toLocaleString()} {answers.net_income === correct.net_income ? '‚úì' : `(you: ${answers.net_income?.toLocaleString()})`}
                              </span>
                           )}
                        </div>
                     </div>

                     {showResults && (
                        <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                           <p className="text-sm text-gray-700">
                              <strong>Margins:</strong><br/>
                              Gross Margin: {((correct.gross_profit / scenario.revenue) * 100).toFixed(1)}%<br/>
                              Net Margin: {((correct.net_income / scenario.revenue) * 100).toFixed(1)}%
                           </p>
                        </div>
                     )}
                  </div>

                  <div className="mt-4">
                     {!showResults ? (
                        <button
                           onClick={checkAnswers}
                           disabled={Object.keys(answers).length < 3}
                           className={`w-full py-3 rounded-xl font-semibold ${Object.keys(answers).length >= 3 ? 'bg-emerald-500 text-white hover:bg-emerald-600' : 'bg-gray-200 text-gray-400'}`}
                        >
                           Check Answers
                        </button>
                     ) : (
                        <button
                           onClick={() => {
                              if (level < buildScenarios.length - 1) {
                                 setLevel(prev => prev + 1);
                                 setAnswers({});
                                 setShowResults(false);
                              } else {
                                 setLevel(buildScenarios.length);
                              }
                           }}
                           className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600"
                        >
                           {level < buildScenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Continue to Quiz ‚Üí'}
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-emerald-50 to-green-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">P&L Knowledge Check</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-emerald-600">{score} pts</span>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button
                           key={idx}
                           onClick={() => handleQuizAnswer(idx)}
                           disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered
                              ? idx === quiz.correct
                                 ? 'bg-green-100 border-2 border-green-500 text-green-800'
                                 : 'bg-gray-100 text-gray-500'
                              : 'bg-gray-50 hover:bg-emerald-50 border-2 border-transparent hover:border-emerald-300'
                           }`}
                        >
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && (
                     <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                        <p className="text-sm text-yellow-800">üí° {quiz.explain}</p>
                     </div>
                  )}
               </div>

               {quizAnswered && (
                  <div className="mt-4">
                     <button onClick={nextQuiz} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = (buildScenarios.length * 75) + (quizzes.length * 15);
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-emerald-50 to-green-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">P&L Master!</h1>
                  <div className="text-4xl font-bold text-emerald-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-emerald-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Revenue - COGS = Gross Profit</strong></li>
                        <li>‚Ä¢ <strong>Gross Profit - OpEx = Operating Income</strong></li>
                        <li>‚Ä¢ <strong>Net Income</strong> is after ALL expenses (interest, taxes)</li>
                        <li>‚Ä¢ Income statement covers a <strong>period of time</strong></li>
                     </ul>
                  </div>

                  <div className="bg-emerald-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-emerald-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-emerald-700">
                        Compare P&L over time: Is revenue growing? Are margins improving or declining? Rising revenue with shrinking margins might signal pricing or cost problems.
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); setGameLog([]); }} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const CashFlowStatementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [classifications, setClassifications] = useState<{[key: string]: string}>({});
      const [showFeedback, setShowFeedback] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "Cash is King", content: "The Cash Flow Statement tracks actual cash moving in and out. Unlike P&L, it shows REAL money movement, not accounting entries.", icon: "üíµ" },
         { title: "Operating Activities", content: "Cash from running the business: customer payments IN, supplier/employee payments OUT. The core engine of cash generation.", icon: "‚öôÔ∏è" },
         { title: "Investing Activities", content: "Cash for long-term assets: buying equipment (OUT), selling property (IN), acquiring companies (OUT).", icon: "üèóÔ∏è" },
         { title: "Financing Activities", content: "Cash from capital structure: loans received (IN), debt repaid (OUT), dividends paid (OUT), stock issued (IN).", icon: "üè¶" },
         { title: "Direct vs Indirect Method", content: "Direct: Shows actual cash receipts/payments. Indirect: Starts with net income, adjusts for non-cash items. Most companies use indirect.", icon: "üîÑ" },
         { title: "Free Cash Flow", content: "Operating Cash Flow - Capital Expenditures = Free Cash Flow. The cash truly available after maintaining the business.", icon: "üÜì" },
         { title: "The Cash Reconciliation", content: "Beginning Cash + Net Change in Cash = Ending Cash. Must tie to the balance sheet!", icon: "‚úÖ" }
      ];

      const infoTopics: {[key: string]: string} = {
         operating: "Operating activities include: receipts from customers, payments to suppliers, employee wages, interest paid, taxes paid. It's the cash generated by the core business.",
         investing: "Investing activities: purchases/sales of PP&E, acquisitions, investments in securities. These are long-term asset transactions, not day-to-day operations.",
         financing: "Financing activities show how the company raises capital: issuing stock (IN), borrowing (IN), repaying debt (OUT), paying dividends (OUT), buying back shares (OUT).",
         indirect_method: "Indirect method starts with Net Income and adjusts: Add back depreciation (non-cash expense), subtract increase in AR (revenue recognized but not collected), add increase in AP (expense recognized but not paid).",
         fcf: "Free Cash Flow = Operating CF - CapEx. It's what's left to pay debt, dividends, or reinvest. Negative FCF means the company needs external funding.",
         working_capital: "Working capital changes affect operating cash: If AR increases, cash decreases (sold but not collected). If AP increases, cash increases (bought but not paid yet)."
      };

      const cashFlowItems = [
         { id: 'customer_receipts', name: 'Cash received from customers', category: 'operating', amount: 950000 },
         { id: 'supplier_payments', name: 'Payments to suppliers', category: 'operating', amount: -420000 },
         { id: 'employee_wages', name: 'Wages paid to employees', category: 'operating', amount: -280000 },
         { id: 'interest_paid', name: 'Interest paid on loans', category: 'operating', amount: -35000 },
         { id: 'taxes_paid', name: 'Income taxes paid', category: 'operating', amount: -55000 },
         { id: 'equipment_purchase', name: 'Purchased new equipment', category: 'investing', amount: -180000 },
         { id: 'building_sale', name: 'Sold old warehouse', category: 'investing', amount: 250000 },
         { id: 'stock_issued', name: 'Issued common stock', category: 'financing', amount: 150000 },
         { id: 'loan_repayment', name: 'Repaid bank loan', category: 'financing', amount: -100000 },
         { id: 'dividends', name: 'Paid dividends to shareholders', category: 'financing', amount: -40000 }
      ];

      const categories = [
         { id: 'operating', label: 'Operating', color: 'bg-blue-100 border-blue-400', icon: '‚öôÔ∏è' },
         { id: 'investing', label: 'Investing', color: 'bg-green-100 border-green-400', icon: 'üèóÔ∏è' },
         { id: 'financing', label: 'Financing', color: 'bg-purple-100 border-purple-400', icon: 'üè¶' }
      ];

      const handleClassify = (itemId: string, categoryId: string) => {
         const item = cashFlowItems.find(i => i.id === itemId);
         if (!item || showFeedback) return;

         setClassifications(prev => ({ ...prev, [itemId]: categoryId }));

         if (categoryId === item.category) {
            setScore(prev => prev + 10);
            setGameLog(prev => [...prev, `Correct: ${item.name} is an ${categoryId} activity`]);
         }
      };

      const checkClassifications = () => {
         setShowFeedback(true);
         const correct = cashFlowItems.filter(item => classifications[item.id] === item.category).length;
         if (correct === cashFlowItems.length) {
            setScore(prev => prev + 50);
         }
      };

      const calculateTotals = () => {
         const operating = cashFlowItems.filter(i => i.category === 'operating').reduce((sum, i) => sum + i.amount, 0);
         const investing = cashFlowItems.filter(i => i.category === 'investing').reduce((sum, i) => sum + i.amount, 0);
         const financing = cashFlowItems.filter(i => i.category === 'financing').reduce((sum, i) => sum + i.amount, 0);
         return { operating, investing, financing, total: operating + investing + financing };
      };

      const quizzes = [
         { q: "A company pays its employees. This is which cash flow activity?", opts: ["Operating", "Investing", "Financing", "None of these"], correct: 0, explain: "Employee wages are operating activities - they're part of running the day-to-day business." },
         { q: "Company buys a new factory. Which section?", opts: ["Operating", "Investing", "Financing", "Depends on size"], correct: 1, explain: "Purchasing long-term assets (PP&E) is always an investing activity, regardless of size." },
         { q: "Company issues new shares to raise capital. Which section?", opts: ["Operating", "Investing", "Financing", "Revenue"], correct: 2, explain: "Issuing stock is a financing activity - it's how the company raises capital from investors." },
         { q: "Depreciation appears on cash flow statement as:", opts: ["Cash outflow", "Added back to net income", "Subtracted from net income", "Not on cash flow statement"], correct: 1, explain: "In indirect method, depreciation is added back because it's a non-cash expense. It reduced net income but didn't use cash." },
         { q: "If Accounts Receivable INCREASES, cash flow from operations:", opts: ["Increases", "Decreases", "Stays the same", "Becomes negative"], correct: 1, explain: "‚ÜëAR means you made sales but haven't collected cash yet. Subtract from net income to get actual cash." },
         { q: "Free Cash Flow is:", opts: ["Total Cash Flow", "Operating CF - CapEx", "Net Income - Dividends", "Financing CF only"], correct: 1, explain: "FCF = Operating CF - CapEx. It shows cash available after maintaining/growing the business." }
      ];

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-cyan-50 to-blue-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üíµ</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Cash Flow Statement</h1>
                  <p className="text-gray-600 mb-6">Follow the money! Learn where cash comes from and where it goes. Profitable companies can still run out of cash - this statement shows why.</p>
                  <div className="bg-cyan-50 rounded-lg p-4 mb-6 text-left">
                     <p className="text-sm text-cyan-800">
                        <strong>The Three Sections:</strong><br/>
                        ‚öôÔ∏è Operating - Running the business<br/>
                        üèóÔ∏è Investing - Buying/selling long-term assets<br/>
                        üè¶ Financing - Raising/repaying capital
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-cyan-50 to-blue-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-cyan-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Classify Cash Flows!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const allClassified = Object.keys(classifications).length === cashFlowItems.length;
         const totals = calculateTotals();
         const inQuizMode = level === 1;

         if (!inQuizMode) {
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-cyan-50 to-blue-100 p-4">
                  {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">Classify Cash Flow Items</h2>
                        <p className="text-sm text-gray-600">Assign each item to the correct category</p>
                     </div>
                     <span className="text-xl font-bold text-cyan-600">{score} pts</span>
                  </div>

                  <div className="grid grid-cols-3 gap-2 mb-4">
                     {categories.map(cat => (
                        <button
                           key={cat.id}
                           onClick={() => { setInfoTopic(cat.id); setShowInfo(true); }}
                           className={`py-2 px-3 rounded-lg text-sm font-semibold ${cat.color} border-2 hover:opacity-80 flex items-center justify-center gap-1`}
                        >
                           {cat.icon} {cat.label} ‚ÑπÔ∏è
                        </button>
                     ))}
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                     <div className="space-y-2">
                        {cashFlowItems.map(item => (
                           <div key={item.id} className="border rounded-lg p-3 bg-gray-50">
                              <div className="flex items-center justify-between mb-2">
                                 <div className="flex-1">
                                    <span className="font-medium text-gray-800">{item.name}</span>
                                    <span className={`ml-2 text-sm font-semibold ${item.amount >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                       {item.amount >= 0 ? '+' : ''}{item.amount.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}
                                    </span>
                                 </div>
                                 {showFeedback && (
                                    <span className={`text-sm ${classifications[item.id] === item.category ? 'text-green-600' : 'text-red-600'}`}>
                                       {classifications[item.id] === item.category ? '‚úì' : `‚Üí ${item.category}`}
                                    </span>
                                 )}
                              </div>
                              <div className="flex gap-2">
                                 {categories.map(cat => (
                                    <button
                                       key={cat.id}
                                       onClick={() => handleClassify(item.id, cat.id)}
                                       disabled={showFeedback}
                                       className={`flex-1 py-1 rounded text-xs font-medium transition-all ${classifications[item.id] === cat.id ? 'ring-2 ring-cyan-500 ' + cat.color : 'bg-gray-100 hover:bg-gray-200'}`}
                                    >
                                       {cat.icon} {cat.label}
                                    </button>
                                 ))}
                              </div>
                           </div>
                        ))}
                     </div>

                     {showFeedback && (
                        <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                           <h4 className="font-semibold text-gray-800 mb-2">Cash Flow Summary:</h4>
                           <div className="space-y-1 text-sm">
                              <div className="flex justify-between"><span>‚öôÔ∏è Operating:</span><span className={totals.operating >= 0 ? 'text-green-600' : 'text-red-600'}>${totals.operating.toLocaleString()}</span></div>
                              <div className="flex justify-between"><span>üèóÔ∏è Investing:</span><span className={totals.investing >= 0 ? 'text-green-600' : 'text-red-600'}>${totals.investing.toLocaleString()}</span></div>
                              <div className="flex justify-between"><span>üè¶ Financing:</span><span className={totals.financing >= 0 ? 'text-green-600' : 'text-red-600'}>${totals.financing.toLocaleString()}</span></div>
                              <div className="flex justify-between border-t pt-1 font-bold"><span>Net Change:</span><span className={totals.total >= 0 ? 'text-green-600' : 'text-red-600'}>${totals.total.toLocaleString()}</span></div>
                           </div>
                        </div>
                     )}
                  </div>

                  <div className="mt-4">
                     {!showFeedback ? (
                        <button
                           onClick={checkClassifications}
                           disabled={!allClassified}
                           className={`w-full py-3 rounded-xl font-semibold ${allClassified ? 'bg-cyan-500 text-white hover:bg-cyan-600' : 'bg-gray-200 text-gray-400'}`}
                        >
                           Check Classifications
                        </button>
                     ) : (
                        <button
                           onClick={() => setLevel(1)}
                           className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600"
                        >
                           Continue to Quiz ‚Üí
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-cyan-50 to-blue-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Cash Flow Quiz</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-cyan-600">{score} pts</span>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button
                           key={idx}
                           onClick={() => handleQuizAnswer(idx)}
                           disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered
                              ? idx === quiz.correct
                                 ? 'bg-green-100 border-2 border-green-500 text-green-800'
                                 : 'bg-gray-100 text-gray-500'
                              : 'bg-gray-50 hover:bg-cyan-50 border-2 border-transparent hover:border-cyan-300'
                           }`}
                        >
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && (
                     <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                        <p className="text-sm text-yellow-800">üí° {quiz.explain}</p>
                     </div>
                  )}
               </div>

               {quizAnswered && (
                  <div className="mt-4">
                     <button onClick={nextQuiz} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = 100 + 50 + 90; // 10 items + bonus + 6 quizzes
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-cyan-50 to-blue-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Cash Flow Expert!</h1>
                  <div className="text-4xl font-bold text-cyan-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-cyan-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Operating</strong>: Core business cash (customers, suppliers, wages)</li>
                        <li>‚Ä¢ <strong>Investing</strong>: Long-term assets (equipment, property, acquisitions)</li>
                        <li>‚Ä¢ <strong>Financing</strong>: Capital structure (debt, equity, dividends)</li>
                        <li>‚Ä¢ <strong>Free Cash Flow</strong> = Operating CF - CapEx</li>
                     </ul>
                  </div>

                  <div className="bg-cyan-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-cyan-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-cyan-700">
                        Positive operating cash flow with negative investing CF is healthy - the business generates cash and invests in growth. Negative operating CF is a red flag regardless of profitability!
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setClassifications({}); setShowFeedback(false); setQuizIndex(0); setQuizAnswered(false); setGameLog([]); }} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const RetainedEarningsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "What Are Retained Earnings?", content: "Accumulated profits kept in the business instead of paid out as dividends. It's the company's savings account of profits over its entire life.", icon: "üè¶" },
         { title: "The Formula", content: "Beginning RE + Net Income - Dividends = Ending RE. Simple but powerful - shows how profits flow to owners.", icon: "üìê" },
         { title: "Beginning Retained Earnings", content: "What you started the period with. This is last period's ending balance.", icon: "üìÖ" },
         { title: "Add: Net Income (or Subtract Loss)", content: "Profit from the income statement flows here. If there's a loss, it reduces retained earnings.", icon: "‚ûï" },
         { title: "Subtract: Dividends", content: "Cash or stock paid to shareholders. This is profit distribution, not an expense.", icon: "üí∏" },
         { title: "Links All Statements", content: "Net Income comes from Income Statement. Ending RE goes to Balance Sheet equity. It's the bridge!", icon: "üîó" },
         { title: "Negative Retained Earnings", content: "Called 'Accumulated Deficit'. Means lifetime losses exceed lifetime profits. Common in startups but a warning sign for mature companies.", icon: "‚ö†Ô∏è" }
      ];

      const infoTopics: {[key: string]: string} = {
         retained_earnings: "Retained earnings represent cumulative profits kept in the business. They fund growth, pay down debt, or save for future needs instead of going to shareholders.",
         dividends: "Dividends reduce retained earnings but aren't expenses. They're distributions of profit to owners. Board declares dividends based on profitability and cash availability.",
         net_income: "Net income from the income statement flows to retained earnings. It's the link between the two statements - profits that weren't distributed become retained.",
         accumulated_deficit: "When cumulative losses exceed cumulative profits, retained earnings go negative (accumulated deficit). Amazon had a deficit for years before becoming profitable.",
         prior_period_adjustment: "Rare adjustments to beginning balance for error corrections or accounting policy changes. They bypass the income statement and directly adjust RE."
      };

      const scenarios = [
         {
            name: "Growing Startup",
            beginningRE: 50000,
            netIncome: 120000,
            dividends: 20000,
            endingRE: 150000
         },
         {
            name: "Dividend-Heavy Corporation",
            beginningRE: 500000,
            netIncome: 200000,
            dividends: 180000,
            endingRE: 520000
         },
         {
            name: "Recovery from Loss",
            beginningRE: -80000,
            netIncome: 150000,
            dividends: 0,
            endingRE: 70000
         }
      ];

      const quizzes = [
         { q: "Retained earnings is found on which statement?", opts: ["Income Statement", "Balance Sheet", "Cash Flow Statement", "Tax Return"], correct: 1, explain: "Retained earnings appears in the equity section of the Balance Sheet. It accumulates over time." },
         { q: "Beginning RE = $100K, Net Income = $50K, Dividends = $30K. Ending RE?", opts: ["$120,000", "$80,000", "$150,000", "$100,000"], correct: 0, explain: "$100K + $50K - $30K = $120K. Add income, subtract dividends." },
         { q: "A company reports net loss. What happens to retained earnings?", opts: ["Increases", "Decreases", "No change", "Becomes zero"], correct: 1, explain: "Net loss reduces retained earnings. RE = Beginning + Net Income (negative) - Dividends." },
         { q: "Dividends are:", opts: ["An expense on income statement", "A reduction of retained earnings", "An increase to assets", "Revenue"], correct: 1, explain: "Dividends aren't expenses! They're distributions of profit, reducing RE and cash." },
         { q: "A startup with negative retained earnings means:", opts: ["Bankruptcy", "Poor management", "Cumulative losses exceed cumulative profits", "No dividends ever"], correct: 2, explain: "Negative RE (accumulated deficit) means lifetime losses > lifetime profits. Common for growth companies investing in expansion." },
         { q: "Net Income 'flows' from which statement to retained earnings?", opts: ["Balance Sheet", "Cash Flow Statement", "Income Statement", "None"], correct: 2, explain: "Net Income from the Income Statement adds to Retained Earnings, which then appears on the Balance Sheet." }
      ];

      const handleAnswer = (field: string, value: number) => {
         setAnswers(prev => ({ ...prev, [field]: value }));
      };

      const checkAnswers = () => {
         setShowResults(true);
         const scenario = scenarios[level];
         let correct = 0;

         if (answers.ending === scenario.endingRE) {
            correct++;
            setScore(prev => prev + 30);
         }

         setGameLog(prev => [...prev, `Scenario ${level + 1}: ${correct > 0 ? 'Correct!' : 'Incorrect'} Ending RE = $${scenario.endingRE.toLocaleString()}`]);
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const nextScenario = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setLevel(scenarios.length);
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-violet-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üè¶</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Statement of Retained Earnings</h1>
                  <p className="text-gray-600 mb-6">Track how profits accumulate in the business. This statement bridges the Income Statement and Balance Sheet!</p>
                  <div className="bg-violet-50 rounded-lg p-4 mb-6 text-left font-mono text-sm">
                     <p className="text-violet-800">
                        Beginning Retained Earnings<br/>
                        <span className="text-green-600">+ Net Income</span><br/>
                        <span className="text-red-600">- Dividends Declared</span><br/>
                        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>
                        <strong>= Ending Retained Earnings</strong>
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-violet-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-violet-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Calculate RE!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const inQuizMode = level >= scenarios.length;

         if (!inQuizMode) {
            const scenario = scenarios[level];
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-violet-50 to-purple-100 p-4">
                  {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">{scenario.name}</h2>
                        <p className="text-sm text-gray-600">Calculate ending retained earnings</p>
                     </div>
                     <span className="text-xl font-bold text-violet-600">{score} pts</span>
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                     <div className="space-y-4 font-mono">
                        <div className="flex justify-between items-center py-3 border-b">
                           <span className="flex items-center gap-2">
                              Beginning Retained Earnings
                              <button onClick={() => { setInfoTopic('retained_earnings'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className={`font-bold ${scenario.beginningRE >= 0 ? 'text-gray-800' : 'text-red-600'}`}>
                              ${scenario.beginningRE.toLocaleString()}
                           </span>
                        </div>

                        <div className="flex justify-between items-center py-3 border-b">
                           <span className="flex items-center gap-2 text-green-600">
                              + Net Income
                              <button onClick={() => { setInfoTopic('net_income'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className="font-bold text-green-600">
                              +${scenario.netIncome.toLocaleString()}
                           </span>
                        </div>

                        <div className="flex justify-between items-center py-3 border-b">
                           <span className="flex items-center gap-2 text-red-600">
                              - Dividends Declared
                              <button onClick={() => { setInfoTopic('dividends'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </span>
                           <span className="font-bold text-red-600">
                              -${scenario.dividends.toLocaleString()}
                           </span>
                        </div>

                        <div className="border-t-2 border-violet-300 pt-4">
                           <div className="flex justify-between items-center">
                              <span className="font-bold text-lg">= Ending Retained Earnings</span>
                              {!showResults ? (
                                 <input
                                    type="number"
                                    placeholder="Calculate..."
                                    value={answers.ending || ''}
                                    onChange={(e) => handleAnswer('ending', Number(e.target.value))}
                                    className="w-40 px-3 py-2 border-2 border-violet-300 rounded-lg text-right font-bold"
                                 />
                              ) : (
                                 <span className={`text-xl font-bold ${answers.ending === scenario.endingRE ? 'text-green-600' : 'text-red-600'}`}>
                                    ${scenario.endingRE.toLocaleString()}
                                    {answers.ending === scenario.endingRE ? ' ‚úì' : ` (you: $${answers.ending?.toLocaleString()})`}
                                 </span>
                              )}
                           </div>
                        </div>

                        {showResults && (
                           <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                              <p className="text-sm text-gray-700">
                                 <strong>Calculation:</strong><br/>
                                 ${scenario.beginningRE.toLocaleString()} + ${scenario.netIncome.toLocaleString()} - ${scenario.dividends.toLocaleString()} = ${scenario.endingRE.toLocaleString()}
                              </p>
                              {scenario.endingRE < 0 && (
                                 <p className="text-sm text-red-600 mt-2">
                                    ‚ö†Ô∏è Negative ending RE indicates an accumulated deficit
                                 </p>
                              )}
                           </div>
                        )}
                     </div>
                  </div>

                  <div className="mt-4">
                     {!showResults ? (
                        <button
                           onClick={checkAnswers}
                           disabled={answers.ending === undefined}
                           className={`w-full py-3 rounded-xl font-semibold ${answers.ending !== undefined ? 'bg-violet-500 text-white hover:bg-violet-600' : 'bg-gray-200 text-gray-400'}`}
                        >
                           Check Answer
                        </button>
                     ) : (
                        <button
                           onClick={nextScenario}
                           className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600"
                        >
                           {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Continue to Quiz ‚Üí'}
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-violet-50 to-purple-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Retained Earnings Quiz</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-violet-600">{score} pts</span>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button
                           key={idx}
                           onClick={() => handleQuizAnswer(idx)}
                           disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered
                              ? idx === quiz.correct
                                 ? 'bg-green-100 border-2 border-green-500 text-green-800'
                                 : 'bg-gray-100 text-gray-500'
                              : 'bg-gray-50 hover:bg-violet-50 border-2 border-transparent hover:border-violet-300'
                           }`}
                        >
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && (
                     <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                        <p className="text-sm text-yellow-800">üí° {quiz.explain}</p>
                     </div>
                  )}
               </div>

               {quizAnswered && (
                  <div className="mt-4">
                     <button onClick={nextQuiz} className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = (scenarios.length * 30) + (quizzes.length * 15);
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-violet-50 to-purple-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">RE Statement Expert!</h1>
                  <div className="text-4xl font-bold text-violet-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-violet-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>RE = Beginning RE + Net Income - Dividends</strong></li>
                        <li>‚Ä¢ Net Income flows FROM Income Statement</li>
                        <li>‚Ä¢ Ending RE flows TO Balance Sheet equity</li>
                        <li>‚Ä¢ Negative RE = Accumulated deficit (not always bad!)</li>
                     </ul>
                  </div>

                  <div className="bg-violet-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-violet-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-violet-700">
                        Watch the dividend payout ratio (Dividends / Net Income). High ratios leave less for growth. Low ratios may disappoint income-seeking investors. Balance is key!
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); setGameLog([]); }} className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const AccrualCashBasisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: string}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "Two Ways to Count", content: "Cash basis records when money moves. Accrual basis records when economic events occur. Same business, very different pictures!", icon: "üîÄ" },
         { title: "Cash Basis", content: "Revenue when you GET paid. Expense when you PAY. Simple but can distort reality - December sales collected in January don't show in December.", icon: "üíµ" },
         { title: "Accrual Basis", content: "Revenue when EARNED (delivered). Expense when INCURRED (used). Matches revenue with related expenses for true profitability.", icon: "üìä" },
         { title: "Matching Principle", content: "Accrual's superpower: match expenses TO the revenue they generate. Sold inventory in December? COGS in December, even if paid in January.", icon: "üéØ" },
         { title: "Revenue Recognition", content: "Accrual: Record revenue when earned (goods delivered, services performed). Cash: Record only when payment received.", icon: "üìù" },
         { title: "Who Uses What?", content: "Small businesses often use cash (simpler). GAAP requires accrual for public companies. IRS allows both for small businesses (<$26M revenue).", icon: "üè¢" },
         { title: "The Big Difference", content: "Cash shows liquidity (do we have money?). Accrual shows profitability (did we make money?). Both valuable, different purposes!", icon: "‚öñÔ∏è" }
      ];

      const infoTopics: {[key: string]: string} = {
         cash_basis: "Cash basis is simple: money in = revenue, money out = expense. Great for tracking bank balance but can hide financial problems (profitable on paper but broke in reality).",
         accrual_basis: "Accrual matches economic activity: sale made = revenue (even if not collected), expense incurred = recorded (even if not paid). Required by GAAP for larger companies.",
         matching_principle: "Match expenses to the revenue they help generate in the SAME period. If you sell something in December, record both revenue AND the cost of goods in December.",
         revenue_recognition: "Under accrual, recognize revenue when: (1) earned through delivery/performance, (2) measurable, (3) collectability reasonably assured. Not when cash received!",
         prepaid_expenses: "Prepaid expenses (like insurance) are paid upfront but expensed over time under accrual. Pay $12K for 12 months insurance ‚Üí expense $1K per month.",
         accrued_expenses: "Accrued expenses are incurred but not yet paid. Employees work in December but get paid in January ‚Üí expense in December, liability until paid."
      };

      const scenarios = [
         {
            name: "December Consulting Invoice",
            description: "You complete $10,000 consulting project in December. Client pays in January.",
            cash_december: 0,
            cash_january: 10000,
            accrual_december: 10000,
            accrual_january: 0,
            questions: [
               { field: 'dec_cash', q: "Cash basis - December revenue?", correct: '0' },
               { field: 'jan_cash', q: "Cash basis - January revenue?", correct: '10000' },
               { field: 'dec_accrual', q: "Accrual basis - December revenue?", correct: '10000' },
               { field: 'jan_accrual', q: "Accrual basis - January revenue?", correct: '0' }
            ]
         },
         {
            name: "Annual Insurance Premium",
            description: "Pay $6,000 on Jan 1 for 12-month insurance policy.",
            cash_january_expense: 6000,
            cash_monthly_expense: 0,
            accrual_january_expense: 500,
            accrual_monthly_expense: 500,
            questions: [
               { field: 'jan_cash', q: "Cash basis - January expense?", correct: '6000' },
               { field: 'feb_cash', q: "Cash basis - February expense?", correct: '0' },
               { field: 'jan_accrual', q: "Accrual basis - January expense?", correct: '500' },
               { field: 'feb_accrual', q: "Accrual basis - February expense?", correct: '500' }
            ]
         },
         {
            name: "December Wages",
            description: "Employees work Dec 26-31 ($5,000 wages). Paycheck issued Jan 5.",
            cash_december_expense: 0,
            cash_january_expense: 5000,
            accrual_december_expense: 5000,
            accrual_january_expense: 0,
            questions: [
               { field: 'dec_cash', q: "Cash basis - December wage expense?", correct: '0' },
               { field: 'jan_cash', q: "Cash basis - January wage expense?", correct: '5000' },
               { field: 'dec_accrual', q: "Accrual basis - December wage expense?", correct: '5000' },
               { field: 'jan_accrual', q: "Accrual basis - January wage expense?", correct: '0' }
            ]
         }
      ];

      const quizzes = [
         { q: "GAAP requires which accounting method for public companies?", opts: ["Cash basis", "Accrual basis", "Either one", "Hybrid"], correct: 1, explain: "GAAP requires accrual accounting for all but the smallest companies. It provides a more accurate picture of financial performance." },
         { q: "A company delivers goods Dec 15, receives payment Jan 10. When is revenue recognized under accrual?", opts: ["January 10", "December 15", "December 31", "January 1"], correct: 1, explain: "Under accrual, revenue is recognized when earned (goods delivered) - December 15." },
         { q: "Cash basis is better for tracking:", opts: ["Profitability", "Liquidity/cash flow", "Long-term trends", "Investor relations"], correct: 1, explain: "Cash basis directly tracks money movement - perfect for understanding actual cash position." },
         { q: "The matching principle requires:", opts: ["Matching debits and credits", "Matching expenses to related revenue", "Matching cash in and out", "Matching assets to liabilities"], correct: 1, explain: "Matching principle: recognize expenses in the same period as the revenue they helped generate." },
         { q: "Prepaid rent under accrual is initially recorded as:", opts: ["Expense", "Revenue", "Asset", "Liability"], correct: 2, explain: "Prepaid rent is an asset (prepaid expense) - you've paid for future benefit. It becomes expense as time passes." },
         { q: "Year-end: $50K sales made, $30K collected. Under accrual, revenue is:", opts: ["$30,000", "$50,000", "$20,000", "$80,000"], correct: 1, explain: "Under accrual, all $50K is revenue (earned). Collection doesn't matter for revenue recognition." }
      ];

      const currentScenario = scenarios[level];

      const checkAnswers = () => {
         setShowResults(true);
         let correct = 0;
         currentScenario.questions.forEach(q => {
            if (answers[q.field] === q.correct) {
               correct++;
               setScore(prev => prev + 15);
            }
         });
         setGameLog(prev => [...prev, `Scenario ${level + 1}: ${correct}/${currentScenario.questions.length} correct`]);
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const nextScenario = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setLevel(scenarios.length);
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-orange-50 to-amber-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üîÄ</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Accrual vs Cash Basis</h1>
                  <p className="text-gray-600 mb-6">Two different ways to record the same transactions. Same business, very different financial statements!</p>
                  <div className="grid grid-cols-2 gap-4 mb-6">
                     <div className="bg-blue-50 rounded-lg p-3 text-left">
                        <p className="font-bold text-blue-700">üíµ Cash Basis</p>
                        <p className="text-xs text-blue-600">Record when money moves</p>
                     </div>
                     <div className="bg-green-50 rounded-lg p-3 text-left">
                        <p className="font-bold text-green-700">üìä Accrual Basis</p>
                        <p className="text-xs text-green-600">Record when earned/incurred</p>
                     </div>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-orange-50 to-amber-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-orange-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Compare Methods!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const inQuizMode = level >= scenarios.length;

         if (!inQuizMode) {
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-orange-50 to-amber-100 p-4">
                  {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">{currentScenario.name}</h2>
                        <p className="text-sm text-gray-600">Determine amounts under each method</p>
                     </div>
                     <span className="text-xl font-bold text-orange-600">{score} pts</span>
                  </div>

                  <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                     <p className="text-gray-700">{currentScenario.description}</p>
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                     <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="p-3 rounded-lg bg-blue-50 border-2 border-blue-200">
                           <div className="flex items-center gap-2 mb-2">
                              <span className="font-bold text-blue-700">üíµ Cash Basis</span>
                              <button onClick={() => { setInfoTopic('cash_basis'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </div>
                           <p className="text-xs text-blue-600">When money changes hands</p>
                        </div>
                        <div className="p-3 rounded-lg bg-green-50 border-2 border-green-200">
                           <div className="flex items-center gap-2 mb-2">
                              <span className="font-bold text-green-700">üìä Accrual Basis</span>
                              <button onClick={() => { setInfoTopic('accrual_basis'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                           </div>
                           <p className="text-xs text-green-600">When earned or incurred</p>
                        </div>
                     </div>

                     <div className="space-y-3">
                        {currentScenario.questions.map((q, idx) => (
                           <div key={q.field} className={`p-3 rounded-lg ${q.field.includes('cash') ? 'bg-blue-50' : 'bg-green-50'}`}>
                              <label className="block text-sm font-medium text-gray-700 mb-2">{q.q}</label>
                              <div className="flex items-center gap-2">
                                 <span className="text-gray-500">$</span>
                                 <input
                                    type="number"
                                    value={answers[q.field] || ''}
                                    onChange={(e) => setAnswers(prev => ({ ...prev, [q.field]: e.target.value }))}
                                    disabled={showResults}
                                    className="flex-1 px-3 py-2 border rounded-lg"
                                    placeholder="Enter amount"
                                 />
                                 {showResults && (
                                    <span className={answers[q.field] === q.correct ? 'text-green-600 font-bold' : 'text-red-600'}>
                                       {answers[q.field] === q.correct ? '‚úì' : `‚Üí $${q.correct}`}
                                    </span>
                                 )}
                              </div>
                           </div>
                        ))}
                     </div>
                  </div>

                  <div className="mt-4">
                     {!showResults ? (
                        <button
                           onClick={checkAnswers}
                           disabled={Object.keys(answers).length < currentScenario.questions.length}
                           className={`w-full py-3 rounded-xl font-semibold ${Object.keys(answers).length >= currentScenario.questions.length ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-gray-200 text-gray-400'}`}
                        >
                           Check Answers
                        </button>
                     ) : (
                        <button
                           onClick={nextScenario}
                           className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600"
                        >
                           {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Continue to Quiz ‚Üí'}
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-orange-50 to-amber-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Accrual vs Cash Quiz</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-orange-600">{score} pts</span>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button
                           key={idx}
                           onClick={() => handleQuizAnswer(idx)}
                           disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered
                              ? idx === quiz.correct
                                 ? 'bg-green-100 border-2 border-green-500 text-green-800'
                                 : 'bg-gray-100 text-gray-500'
                              : 'bg-gray-50 hover:bg-orange-50 border-2 border-transparent hover:border-orange-300'
                           }`}
                        >
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && (
                     <div className="mt-4 p-4 bg-yellow-50 rounded-lg">
                        <p className="text-sm text-yellow-800">üí° {quiz.explain}</p>
                     </div>
                  )}
               </div>

               {quizAnswered && (
                  <div className="mt-4">
                     <button onClick={nextQuiz} className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = (scenarios.reduce((sum, s) => sum + s.questions.length * 15, 0)) + (quizzes.length * 15);
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-orange-50 to-amber-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Accounting Method Master!</h1>
                  <div className="text-4xl font-bold text-orange-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-orange-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Cash</strong>: Records when money moves (simple, tracks liquidity)</li>
                        <li>‚Ä¢ <strong>Accrual</strong>: Records when earned/incurred (GAAP required)</li>
                        <li>‚Ä¢ <strong>Matching principle</strong>: Expenses match related revenue</li>
                        <li>‚Ä¢ Same business can look very different under each method!</li>
                     </ul>
                  </div>

                  <div className="bg-orange-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-orange-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-orange-700">
                        Accrual shows economic reality (are we profitable?). Cash shows financial reality (can we pay bills?). Smart managers track both!
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); setGameLog([]); }} className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const DepreciationMethodsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [selectedMethod, setSelectedMethod] = useState<string | null>(null);
      const [calculations, setCalculations] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);

      const tutorials = [
         { title: "What is Depreciation?", content: "Allocating an asset's cost over its useful life. A $50,000 machine used for 10 years isn't a $50K expense in Year 1 - it's $5K/year.", icon: "üìâ" },
         { title: "Why Depreciate?", content: "Matching principle: Match expense to periods benefiting from the asset. Also provides tax benefits by reducing taxable income each year.", icon: "üéØ" },
         { title: "Straight-Line Method", content: "(Cost - Salvage) √∑ Useful Life = Annual Depreciation. Same amount every year. Simple and most common.", icon: "‚ûñ" },
         { title: "Double Declining Balance", content: "2 √ó Straight-Line Rate √ó Book Value. Faster depreciation early, slower later. Good for assets losing value quickly.", icon: "üìà" },
         { title: "Units of Production", content: "(Cost - Salvage) √∑ Total Units √ó Units This Period. Ties depreciation to usage. Great for machinery with variable use.", icon: "‚öôÔ∏è" },
         { title: "Sum of Years' Digits", content: "Remaining Life √∑ Sum of Years √ó Depreciable Base. Another accelerated method, declining each year.", icon: "üî¢" },
         { title: "Book Value & Salvage", content: "Book Value = Cost - Accumulated Depreciation. Never depreciate below salvage value (expected value at end of life).", icon: "üìö" }
      ];

      const infoTopics: {[key: string]: string} = {
         straight_line: "Straight-line: (Cost - Salvage) √∑ Life. A $10,000 asset with $1,000 salvage over 5 years = ($10,000 - $1,000) √∑ 5 = $1,800/year.",
         double_declining: "DDB: 2 √ó (1/Life) √ó Book Value. For 5-year asset: 2 √ó 20% = 40% rate. Year 1: 40% √ó $10,000 = $4,000. Year 2: 40% √ó $6,000 = $2,400.",
         units_production: "Units of Production: Per-unit rate √ó units used. $9,000 depreciable √∑ 100,000 units = $0.09/unit. Use 20,000 units? $1,800 depreciation.",
         sum_years_digits: "SYD for 5-year asset: Sum = 5+4+3+2+1 = 15. Year 1: 5/15, Year 2: 4/15, etc. Faster in early years like DDB.",
         accumulated_depreciation: "Accumulated depreciation is a contra-asset account. It increases over time, reducing the asset's book value on the balance sheet.",
         tax_vs_book: "Companies often use straight-line for financial reporting (smoother earnings) and accelerated for taxes (more deductions early). Two sets of books, both legal!"
      };

      const assets = [
         {
            name: "Delivery Truck",
            cost: 60000,
            salvage: 6000,
            life: 5,
            totalUnits: 150000,
            unitsYear1: 35000
         },
         {
            name: "Manufacturing Equipment",
            cost: 100000,
            salvage: 10000,
            life: 10,
            totalUnits: 500000,
            unitsYear1: 60000
         },
         {
            name: "Computer System",
            cost: 25000,
            salvage: 1000,
            life: 4,
            totalUnits: 20000,
            unitsYear1: 6000
         }
      ];

      const currentAsset = assets[level];

      const calculateDepreciation = (method: string) => {
         const { cost, salvage, life, totalUnits, unitsYear1 } = currentAsset;
         const depreciableBase = cost - salvage;

         switch (method) {
            case 'straight_line':
               return Math.round(depreciableBase / life);
            case 'double_declining':
               const rate = 2 / life;
               return Math.round(cost * rate);
            case 'units_production':
               return Math.round((depreciableBase / totalUnits) * unitsYear1);
            case 'sum_years_digits':
               const sumYears = (life * (life + 1)) / 2;
               return Math.round((life / sumYears) * depreciableBase);
            default:
               return 0;
         }
      };

      const methods = [
         { id: 'straight_line', name: 'Straight-Line', formula: '(Cost - Salvage) √∑ Life' },
         { id: 'double_declining', name: 'Double Declining', formula: '2 √ó (1/Life) √ó Cost' },
         { id: 'units_production', name: 'Units of Production', formula: '(Cost-Salvage)/Total Units √ó Year 1 Units' },
         { id: 'sum_years_digits', name: 'Sum of Years Digits', formula: '(Years Remaining/Sum) √ó (Cost-Salvage)' }
      ];

      const checkCalculation = () => {
         setShowResults(true);
         let correct = 0;
         methods.forEach(m => {
            const expected = calculateDepreciation(m.id);
            if (calculations[m.id] === expected) {
               correct++;
               setScore(prev => prev + 20);
            }
         });
         setGameLog(prev => [...prev, `Asset ${level + 1}: ${correct}/4 methods calculated correctly`]);
      };

      const nextAsset = () => {
         if (level < assets.length - 1) {
            setLevel(prev => prev + 1);
            setCalculations({});
            setShowResults(false);
         } else {
            setPhase('result');
         }
      };

      const InfoModal = ({ topic, onClose }: { topic: string; onClose: () => void }) => (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white rounded-xl p-6 max-w-md" onClick={e => e.stopPropagation()}>
               <h3 className="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è {topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
               <p className="text-gray-600">{infoTopics[topic]}</p>
               <button onClick={onClose} className="mt-4 w-full py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600">Got it!</button>
            </div>
         </div>
      );

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-rose-50 to-pink-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üìâ</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Depreciation Methods</h1>
                  <p className="text-gray-600 mb-6">Master the art of allocating asset costs over time. Different methods, different financial impacts!</p>
                  <div className="bg-rose-50 rounded-lg p-4 mb-6 text-left">
                     <p className="text-sm text-rose-800">
                        <strong>Four Methods:</strong><br/>
                        ‚ûñ Straight-Line (equal yearly)<br/>
                        üìà Double Declining (fast early)<br/>
                        ‚öôÔ∏è Units of Production (usage-based)<br/>
                        üî¢ Sum of Years' Digits (accelerated)
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-rose-500 text-white rounded-xl font-semibold hover:bg-rose-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-rose-50 to-pink-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-rose-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">
                           Back
                        </button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-rose-500 text-white rounded-xl font-semibold hover:bg-rose-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Calculate Depreciation!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-rose-50 to-pink-100 p-4">
               {showInfo && infoTopic && <InfoModal topic={infoTopic} onClose={() => setShowInfo(false)} />}

               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">{currentAsset.name}</h2>
                     <p className="text-sm text-gray-600">Calculate Year 1 depreciation for each method</p>
                  </div>
                  <span className="text-xl font-bold text-rose-600">{score} pts</span>
               </div>

               <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                  <div className="grid grid-cols-2 gap-3 text-sm">
                     <div><span className="text-gray-500">Cost:</span> <span className="font-bold">${currentAsset.cost.toLocaleString()}</span></div>
                     <div><span className="text-gray-500">Salvage:</span> <span className="font-bold">${currentAsset.salvage.toLocaleString()}</span></div>
                     <div><span className="text-gray-500">Useful Life:</span> <span className="font-bold">{currentAsset.life} years</span></div>
                     <div><span className="text-gray-500">Year 1 Units:</span> <span className="font-bold">{currentAsset.unitsYear1.toLocaleString()}</span></div>
                     <div className="col-span-2"><span className="text-gray-500">Total Units:</span> <span className="font-bold">{currentAsset.totalUnits.toLocaleString()}</span></div>
                  </div>
               </div>

               <div className="flex-1 bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                  <div className="space-y-4">
                     {methods.map(method => (
                        <div key={method.id} className="border rounded-lg p-3">
                           <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                 <span className="font-bold text-gray-800">{method.name}</span>
                                 <button onClick={() => { setInfoTopic(method.id); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button>
                              </div>
                           </div>
                           <p className="text-xs text-gray-500 mb-2">{method.formula}</p>
                           <div className="flex items-center gap-2">
                              <span className="text-gray-500">Year 1: $</span>
                              <input
                                 type="number"
                                 value={calculations[method.id] || ''}
                                 onChange={(e) => setCalculations(prev => ({ ...prev, [method.id]: Number(e.target.value) }))}
                                 disabled={showResults}
                                 className="flex-1 px-3 py-2 border rounded-lg"
                                 placeholder="Calculate..."
                              />
                              {showResults && (
                                 <span className={calculations[method.id] === calculateDepreciation(method.id) ? 'text-green-600 font-bold' : 'text-red-600'}>
                                    {calculations[method.id] === calculateDepreciation(method.id) ? '‚úì' : `‚Üí $${calculateDepreciation(method.id).toLocaleString()}`}
                                 </span>
                              )}
                           </div>
                        </div>
                     ))}
                  </div>
               </div>

               <div className="mt-4">
                  {!showResults ? (
                     <button
                        onClick={checkCalculation}
                        disabled={Object.keys(calculations).length < methods.length}
                        className={`w-full py-3 rounded-xl font-semibold ${Object.keys(calculations).length >= methods.length ? 'bg-rose-500 text-white hover:bg-rose-600' : 'bg-gray-200 text-gray-400'}`}
                     >
                        Check Calculations
                     </button>
                  ) : (
                     <button
                        onClick={nextAsset}
                        className="w-full py-3 bg-rose-500 text-white rounded-xl font-semibold hover:bg-rose-600"
                     >
                        {level < assets.length - 1 ? 'Next Asset ‚Üí' : 'See Results'}
                     </button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = assets.length * methods.length * 20;
         const percentage = Math.round((score / maxScore) * 100);

         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-rose-50 to-pink-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Depreciation Expert!</h1>
                  <div className="text-4xl font-bold text-rose-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-rose-500 h-3 rounded-full transition-all" style={{ width: `${percentage}%` }} />
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ <strong>Straight-line</strong>: Simplest, equal amounts</li>
                        <li>‚Ä¢ <strong>DDB & SYD</strong>: Accelerated, more early, less later</li>
                        <li>‚Ä¢ <strong>Units of Production</strong>: Ties to actual usage</li>
                        <li>‚Ä¢ Never depreciate below salvage value!</li>
                     </ul>
                  </div>

                  <div className="bg-rose-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-rose-800 mb-2">üí° Pro Insight:</h3>
                     <p className="text-sm text-rose-700">
                        Method choice affects reported profit! Accelerated methods reduce early profits but increase later profits. Use straight-line for stable earnings, accelerated for tax benefits.
                     </p>
                  </div>

                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setCalculations({}); setShowResults(false); setGameLog([]); }} className="w-full py-3 bg-rose-500 text-white rounded-xl font-semibold hover:bg-rose-600">
                     Practice Again
                  </button>
               </div>
            </div>
         );
      }

      return null;
   };

   const AmortizationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);

      const tutorials = [
         { title: "Amortization vs Depreciation", content: "Depreciation = tangible assets (equipment). Amortization = intangible assets (patents, copyrights). Same concept, different assets!", icon: "üìù" },
         { title: "Intangible Assets", content: "Assets you can't touch: patents, trademarks, copyrights, goodwill, customer lists, software licenses. Often more valuable than physical assets!", icon: "üí°" },
         { title: "Finite vs Indefinite Life", content: "Finite life intangibles (patents, licenses) are amortized. Indefinite life (trademarks, goodwill) are NOT amortized but tested for impairment.", icon: "‚ôæÔ∏è" },
         { title: "Straight-Line Amortization", content: "Most intangibles use straight-line: Cost √∑ Useful Life. A $100K patent with 10-year life = $10K/year amortization.", icon: "‚ûñ" },
         { title: "Legal vs Economic Life", content: "Use the SHORTER of legal life (patent = 20 years) or economic life (technology obsolete in 5 years). Be conservative!", icon: "‚öñÔ∏è" },
         { title: "Goodwill is Special", content: "Goodwill (premium paid in acquisition) is NOT amortized. Instead, it's tested annually for impairment and written down if value drops.", icon: "‚≠ê" },
         { title: "No Residual Value", content: "Unlike depreciation, amortization usually assumes $0 residual value. The entire cost is expensed over the useful life.", icon: "0Ô∏è‚É£" }
      ];

      const intangibles = [
         { name: "Software Patent", cost: 500000, life: 10, type: "Patent" },
         { name: "Customer List Acquisition", cost: 150000, life: 5, type: "Customer Intangible" },
         { name: "Franchise License", cost: 300000, life: 15, type: "License" }
      ];

      const currentIntangible = intangibles[level];

      const quizzes = [
         { q: "Which is amortized?", opts: ["Machinery", "Patent", "Building", "Land"], correct: 1, explain: "Patents (intangible, finite life) are amortized. Machinery/buildings are depreciated. Land is neither." },
         { q: "Goodwill acquired in a merger is:", opts: ["Amortized over 15 years", "Expensed immediately", "Tested for impairment annually", "Depreciated"], correct: 2, explain: "Goodwill is tested for impairment yearly. If value drops below carrying amount, it's written down." },
         { q: "A patent costs $60K with 20-year legal life but 5-year useful life. Annual amortization?", opts: ["$3,000", "$12,000", "$60,000", "$6,000"], correct: 1, explain: "Use shorter life: $60K √∑ 5 years = $12,000/year. Economic life often shorter than legal." },
         { q: "Amortization typically uses which method?", opts: ["Double declining", "Units of production", "Straight-line", "Sum of years' digits"], correct: 2, explain: "Intangibles almost always use straight-line amortization. The benefit is usually consumed evenly over time." },
         { q: "A trademark you've held for 50 years should be:", opts: ["Fully amortized by now", "Never amortized", "Written off", "Revalued annually"], correct: 1, explain: "Trademarks have indefinite life - they're not amortized. Only tested for impairment." },
         { q: "Intangible amortization expense appears on:", opts: ["Balance sheet only", "Income statement", "Cash flow statement only", "Statement of retained earnings"], correct: 1, explain: "Amortization is an expense on the income statement, reducing operating income." }
      ];

      const checkAnswer = () => {
         setShowResults(true);
         const expected = currentIntangible.cost / currentIntangible.life;
         if (answers.annual === expected) {
            setScore(prev => prev + 25);
            setGameLog(prev => [...prev, `Correct! Annual amortization = $${expected.toLocaleString()}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect. ${currentIntangible.name}: $${currentIntangible.cost.toLocaleString()} √∑ ${currentIntangible.life} years = $${expected.toLocaleString()}`]);
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 15);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const nextIntangible = () => {
         if (level < intangibles.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setLevel(intangibles.length);
         }
      };

      if (phase === 'intro') {
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-purple-50 to-violet-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">üìù</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-3">Amortization of Intangibles</h1>
                  <p className="text-gray-600 mb-6">Learn to allocate the cost of intangible assets - patents, copyrights, trademarks, and more!</p>
                  <div className="bg-purple-50 rounded-lg p-4 mb-6 text-left">
                     <p className="text-sm text-purple-800">
                        <strong>Key Intangibles:</strong><br/>
                        üí° Patents - Legal protection for inventions<br/>
                        ¬©Ô∏è Copyrights - Creative works protection<br/>
                        ‚Ñ¢Ô∏è Trademarks - Brand identity (indefinite)<br/>
                        ‚≠ê Goodwill - Acquisition premium (no amortization)
                     </p>
                  </div>
                  <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600 transition-all">
                     Start Learning
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const tut = tutorials[tutorialStep];
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-purple-50 to-violet-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
                  <div className="flex justify-between items-center mb-6">
                     <span className="text-sm text-gray-500">Step {tutorialStep + 1} of {tutorials.length}</span>
                     <div className="flex gap-1">
                        {tutorials.map((_, i) => (
                           <div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-purple-500' : 'bg-gray-200'}`} />
                        ))}
                     </div>
                  </div>
                  <div className="text-4xl mb-4 text-center">{tut.icon}</div>
                  <h2 className="text-xl font-bold text-gray-800 mb-3 text-center">{tut.title}</h2>
                  <p className="text-gray-600 text-center mb-8">{tut.content}</p>
                  <div className="flex gap-3">
                     {tutorialStep > 0 && (
                        <button onClick={() => setTutorialStep(prev => prev - 1)} className="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">Back</button>
                     )}
                     <button
                        onClick={() => tutorialStep < tutorials.length - 1 ? setTutorialStep(prev => prev + 1) : setPhase('play')}
                        className="flex-1 py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600"
                     >
                        {tutorialStep < tutorials.length - 1 ? 'Next' : 'Calculate Amortization!'}
                     </button>
                  </div>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const inQuizMode = level >= intangibles.length;

         if (!inQuizMode) {
            const expected = currentIntangible.cost / currentIntangible.life;
            return (
               <div className="flex flex-col min-h-full bg-gradient-to-br from-purple-50 to-violet-100 p-4">
                  <div className="flex justify-between items-center mb-4">
                     <div>
                        <h2 className="font-bold text-gray-800">{currentIntangible.name}</h2>
                        <p className="text-sm text-gray-600">Calculate annual amortization</p>
                     </div>
                     <span className="text-xl font-bold text-purple-600">{score} pts</span>
                  </div>

                  <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
                     <div className="text-center mb-4">
                        <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">{currentIntangible.type}</span>
                     </div>
                     <div className="grid grid-cols-2 gap-4 text-center">
                        <div className="bg-gray-50 rounded-lg p-4">
                           <p className="text-sm text-gray-500">Cost</p>
                           <p className="text-2xl font-bold text-gray-800">${currentIntangible.cost.toLocaleString()}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4">
                           <p className="text-sm text-gray-500">Useful Life</p>
                           <p className="text-2xl font-bold text-gray-800">{currentIntangible.life} years</p>
                        </div>
                     </div>
                  </div>

                  <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                     <div className="text-center mb-4">
                        <p className="text-lg font-semibold text-gray-800">Annual Amortization Expense</p>
                        <p className="text-sm text-gray-500">Cost √∑ Useful Life = ?</p>
                     </div>
                     <div className="flex items-center justify-center gap-2">
                        <span className="text-xl text-gray-600">$</span>
                        <input
                           type="number"
                           value={answers.annual || ''}
                           onChange={(e) => setAnswers({ annual: Number(e.target.value) })}
                           disabled={showResults}
                           className="w-40 px-4 py-3 text-xl text-center border-2 border-purple-300 rounded-xl"
                           placeholder="Calculate..."
                        />
                     </div>
                     {showResults && (
                        <div className={`mt-4 p-4 rounded-lg text-center ${answers.annual === expected ? 'bg-green-50' : 'bg-red-50'}`}>
                           <p className={`font-bold ${answers.annual === expected ? 'text-green-600' : 'text-red-600'}`}>
                              {answers.annual === expected ? '‚úì Correct!' : `Correct answer: $${expected.toLocaleString()}`}
                           </p>
                           <p className="text-sm text-gray-600 mt-1">${currentIntangible.cost.toLocaleString()} √∑ {currentIntangible.life} = ${expected.toLocaleString()}/year</p>
                        </div>
                     )}
                  </div>

                  <div className="mt-4">
                     {!showResults ? (
                        <button onClick={checkAnswer} disabled={!answers.annual} className={`w-full py-3 rounded-xl font-semibold ${answers.annual ? 'bg-purple-500 text-white hover:bg-purple-600' : 'bg-gray-200 text-gray-400'}`}>
                           Check Answer
                        </button>
                     ) : (
                        <button onClick={nextIntangible} className="w-full py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600">
                           {level < intangibles.length - 1 ? 'Next Intangible ‚Üí' : 'Continue to Quiz ‚Üí'}
                        </button>
                     )}
                  </div>
               </div>
            );
         }

         const quiz = quizzes[quizIndex];
         return (
            <div className="flex flex-col min-h-full bg-gradient-to-br from-purple-50 to-violet-100 p-4">
               <div className="flex justify-between items-center mb-4">
                  <div>
                     <h2 className="font-bold text-gray-800">Amortization Quiz</h2>
                     <p className="text-sm text-gray-600">Question {quizIndex + 1} of {quizzes.length}</p>
                  </div>
                  <span className="text-xl font-bold text-purple-600">{score} pts</span>
               </div>
               <div className="flex-1 bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-6">{quiz.q}</h3>
                  <div className="space-y-3">
                     {quiz.opts.map((opt, idx) => (
                        <button key={idx} onClick={() => handleQuizAnswer(idx)} disabled={quizAnswered}
                           className={`w-full p-4 rounded-lg text-left font-medium transition-all ${quizAnswered ? idx === quiz.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-100' : 'bg-gray-50 hover:bg-purple-50 border-2 border-transparent hover:border-purple-300'}`}>
                           {opt}
                        </button>
                     ))}
                  </div>
                  {quizAnswered && <div className="mt-4 p-4 bg-yellow-50 rounded-lg"><p className="text-sm text-yellow-800">üí° {quiz.explain}</p></div>}
               </div>
               {quizAnswered && (
                  <div className="mt-4">
                     <button onClick={nextQuiz} className="w-full py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Results'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const maxScore = (intangibles.length * 25) + (quizzes.length * 15);
         const percentage = Math.round((score / maxScore) * 100);
         return (
            <div className="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-purple-50 to-violet-100 p-6">
               <div className="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Amortization Expert!</h1>
                  <div className="text-4xl font-bold text-purple-600 mb-4">{score} / {maxScore}</div>
                  <div className="w-full bg-gray-200 rounded-full h-3 mb-6">
                     <div className="bg-purple-500 h-3 rounded-full" style={{ width: `${percentage}%` }} />
                  </div>
                  <div className="bg-gray-50 rounded-lg p-4 text-left mb-6">
                     <h3 className="font-semibold text-gray-800 mb-2">üéØ Key Takeaways:</h3>
                     <ul className="text-sm text-gray-600 space-y-2">
                        <li>‚Ä¢ Amortization = intangibles; Depreciation = tangibles</li>
                        <li>‚Ä¢ Use shorter of legal or economic life</li>
                        <li>‚Ä¢ Goodwill & trademarks: impairment test, no amortization</li>
                        <li>‚Ä¢ Usually straight-line, no salvage value</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const InventoryValuationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });

      const tutorials = [
         { title: 'Inventory Valuation Methods', content: 'Companies must choose a method to assign costs to inventory sold. The three main methods‚ÄîFIFO, LIFO, and Weighted Average‚Äîeach produce different COGS and ending inventory values.', icon: 'üì¶' },
         { title: 'FIFO - First In, First Out', content: 'Oldest inventory costs are assigned to COGS first. Ending inventory reflects most recent (typically higher) costs. Results in lower COGS and higher profits during inflation.', icon: '‚û°Ô∏è' },
         { title: 'LIFO - Last In, First Out', content: 'Most recent inventory costs are assigned to COGS first. Ending inventory reflects oldest (typically lower) costs. Results in higher COGS and lower profits (tax savings) during inflation.', icon: '‚¨ÖÔ∏è' },
         { title: 'Weighted Average', content: 'Average cost of all units available = Total Cost √∑ Total Units. Same cost applied to both COGS and ending inventory. Smooths out price fluctuations.', icon: '‚öñÔ∏è' },
         { title: 'Impact on Financial Statements', content: 'FIFO: Higher ending inventory, higher net income. LIFO: Lower ending inventory, lower net income (but tax savings). Weighted Average: Middle ground for both.', icon: 'üìä' },
         { title: 'When to Use Each Method', content: 'FIFO: Perishables, tech products. LIFO: Tax savings (US only, not allowed under IFRS). Weighted Average: Commodity-type products, simplicity.', icon: 'üéØ' },
         { title: 'The Scenario', content: 'You\'ll analyze inventory transactions and calculate COGS and ending inventory using each method. See how the same transactions produce different results!', icon: 'üéÆ' }
      ];

      const scenarios = [
         {
            title: 'Basic Electronics Store',
            description: 'Widget-Mart sells smartphones. Track the January inventory:',
            beginning: { units: 0, cost: 0 },
            transactions: [
               { type: 'purchase', date: 'Jan 5', units: 100, cost: 200, total: 20000 },
               { type: 'purchase', date: 'Jan 15', units: 80, cost: 220, total: 17600 },
               { type: 'sale', date: 'Jan 25', units: 120, price: 350 }
            ],
            available: { units: 180, cost: 37600 },
            fifo: { cogs: 28400, ending: 9200 },
            lifo: { cogs: 30000, ending: 7600 },
            avg: { cogs: 25067, ending: 12533 }
         },
         {
            title: 'Growing Retailer',
            description: 'Prices are rising. Fashion Depot tracks their premium handbags:',
            beginning: { units: 50, cost: 150 },
            transactions: [
               { type: 'purchase', date: 'Feb 1', units: 50, cost: 150, total: 7500 },
               { type: 'purchase', date: 'Feb 10', units: 60, cost: 175, total: 10500 },
               { type: 'purchase', date: 'Feb 20', units: 40, cost: 200, total: 8000 },
               { type: 'sale', date: 'Feb 28', units: 100, price: 300 }
            ],
            available: { units: 150, cost: 26000 },
            fifo: { cogs: 15750, ending: 10250 },
            lifo: { cogs: 18500, ending: 7500 },
            avg: { cogs: 17333, ending: 8667 }
         },
         {
            title: 'Complex Quarter',
            description: 'Multiple purchases at varying costs for Tech Supply Co:',
            beginning: { units: 200, cost: 50 },
            transactions: [
               { type: 'purchase', date: 'Mar 1', units: 200, cost: 50, total: 10000 },
               { type: 'sale', date: 'Mar 5', units: 150, price: 85 },
               { type: 'purchase', date: 'Mar 10', units: 300, cost: 55, total: 16500 },
               { type: 'purchase', date: 'Mar 20', units: 100, cost: 60, total: 6000 },
               { type: 'sale', date: 'Mar 28', units: 400, price: 90 }
            ],
            available: { units: 600, cost: 32500 },
            fifo: { cogs: 28750, ending: 3750 },
            lifo: { cogs: 30000, ending: 2500 },
            avg: { cogs: 29792, ending: 2708 }
         }
      ];

      const quizzes = [
         {
            question: 'During a period of rising prices, which method results in the HIGHEST net income?',
            options: ['FIFO', 'LIFO', 'Weighted Average', 'All methods produce same income'],
            correct: 0,
            explanation: 'FIFO assigns older (lower) costs to COGS, resulting in lower COGS and higher gross profit/net income during inflation.'
         },
         {
            question: 'Which inventory method is NOT allowed under IFRS?',
            options: ['FIFO', 'LIFO', 'Weighted Average', 'Specific Identification'],
            correct: 1,
            explanation: 'LIFO is prohibited under IFRS but allowed under US GAAP. This creates comparability issues for international investors.'
         },
         {
            question: 'A company wants to minimize income taxes during inflation. Which method should they use?',
            options: ['FIFO - lower taxes', 'LIFO - higher COGS reduces taxable income', 'Weighted Average - tax neutral', 'All methods result in same taxes'],
            correct: 1,
            explanation: 'LIFO assigns higher (recent) costs to COGS during inflation, reducing taxable income and thus tax liability.'
         },
         {
            question: 'If beginning inventory is 100 units @ $10 and you purchase 50 units @ $12, what is the weighted average cost per unit?',
            options: ['$10.00', '$10.67', '$11.00', '$12.00'],
            correct: 1,
            explanation: 'Weighted Avg = (100 √ó $10 + 50 √ó $12) √∑ 150 = $1,600 √∑ 150 = $10.67 per unit.'
         },
         {
            question: 'Which statement about FIFO is TRUE?',
            options: ['Ending inventory reflects oldest costs', 'COGS reflects most recent costs', 'Ending inventory reflects most recent costs', 'Not allowed under US GAAP'],
            correct: 2,
            explanation: 'Under FIFO, oldest costs go to COGS first, leaving the most recent (typically higher) costs in ending inventory.'
         },
         {
            question: 'A perishable goods company (dairy, produce) would most likely use:',
            options: ['LIFO - matches physical flow', 'FIFO - matches physical flow', 'Weighted Average - simplest calculation', 'Specific Identification - tracks each item'],
            correct: 1,
            explanation: 'Perishable goods are sold in order received (oldest first) to prevent spoilage. FIFO matches this physical flow.'
         }
      ];

      const current = scenarios[level];

      const handleAnswer = (method: string, value: number) => {
         setAnswers(prev => ({ ...prev, [method]: value }));
      };

      const checkAnswers = () => {
         let pts = 0;
         const tolerance = 100;

         if (Math.abs((answers['fifo_cogs'] || 0) - current.fifo.cogs) <= tolerance) pts++;
         if (Math.abs((answers['fifo_ending'] || 0) - current.fifo.ending) <= tolerance) pts++;
         if (Math.abs((answers['lifo_cogs'] || 0) - current.lifo.cogs) <= tolerance) pts++;
         if (Math.abs((answers['lifo_ending'] || 0) - current.lifo.ending) <= tolerance) pts++;
         if (Math.abs((answers['avg_cogs'] || 0) - current.avg.cogs) <= tolerance) pts++;
         if (Math.abs((answers['avg_ending'] || 0) - current.avg.ending) <= tolerance) pts++;

         setScore(prev => prev + pts);
         setGameLog(prev => [...prev, `Scenario ${level + 1}: Scored ${pts}/6 on ${current.title}`]);
         setShowResults(true);
      };

      const nextLevel = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setPhase('result');
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct! +2 points`]);
         } else {
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Incorrect`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const showInfoModal = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-orange-50 to-yellow-100">
               <div className="text-6xl mb-4">üì¶</div>
               <h1 className="text-2xl font-bold text-orange-800 mb-2">Inventory Valuation Methods</h1>
               <p className="text-orange-600 text-center mb-6 max-w-md">Master FIFO, LIFO, and Weighted Average to understand how inventory costing affects financial statements and taxes.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-orange-50 to-yellow-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-orange-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-orange-200 rounded-full">
                     <div className="h-full bg-orange-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-orange-800 mb-3">{t.title}</h2>
                  <p className="text-orange-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-orange-200 text-orange-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Next</button>
                  ) : (
                     <button onClick={() => setPhase('play')} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Practice ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const soldUnits = current.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.units, 0);
         const endingUnits = current.available.units - soldUnits;

         if (!showResults) {
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-orange-50 to-yellow-100 overflow-auto">
                  <div className="flex justify-between items-center mb-3">
                     <span className="text-sm font-medium text-orange-700">Scenario {level + 1}/{scenarios.length}</span>
                     <span className="text-sm font-semibold text-orange-800">Score: {score}</span>
                  </div>

                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <div className="flex items-center gap-2 mb-2">
                        <h3 className="font-bold text-orange-800">{current.title}</h3>
                        <button onClick={() => showInfoModal('Inventory Flow', 'Goods Available = Beginning Inventory + Purchases. COGS + Ending Inventory = Goods Available.')} className="text-orange-400 hover:text-orange-600">‚ÑπÔ∏è</button>
                     </div>
                     <p className="text-sm text-gray-600 mb-3">{current.description}</p>

                     <div className="bg-orange-50 rounded-lg p-3 text-xs">
                        <div className="font-semibold mb-2 text-orange-800">Transactions:</div>
                        {current.transactions.map((t, i) => (
                           <div key={i} className="flex justify-between py-1 border-b border-orange-100 last:border-0">
                              <span className="text-gray-600">{t.date}</span>
                              <span className={t.type === 'purchase' ? 'text-green-600' : 'text-red-600'}>
                                 {t.type === 'purchase' ? `+${t.units} @ $${t.cost}` : `Sold ${t.units} units`}
                              </span>
                              {t.type === 'purchase' && <span className="text-gray-500">${t.total?.toLocaleString()}</span>}
                           </div>
                        ))}
                        <div className="flex justify-between pt-2 font-semibold text-orange-800">
                           <span>Goods Available:</span>
                           <span>{current.available.units} units = ${current.available.cost.toLocaleString()}</span>
                        </div>
                        <div className="text-gray-600 text-center mt-1">Units Sold: {soldUnits} | Ending Units: {endingUnits}</div>
                     </div>
                  </div>

                  <div className="grid grid-cols-3 gap-2 mb-3">
                     <div className="bg-blue-50 rounded-lg p-2">
                        <div className="flex items-center gap-1 mb-1">
                           <span className="text-xs font-bold text-blue-800">FIFO</span>
                           <button onClick={() => showInfoModal('FIFO Method', 'First In, First Out: Oldest costs go to COGS first. Calculate COGS using earliest purchase prices, then remaining inventory at latest prices.')} className="text-blue-400 text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <input type="number" placeholder="COGS" value={answers['fifo_cogs'] || ''} onChange={(e) => handleAnswer('fifo_cogs', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded mb-1" />
                        <input type="number" placeholder="Ending Inv" value={answers['fifo_ending'] || ''} onChange={(e) => handleAnswer('fifo_ending', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded" />
                     </div>
                     <div className="bg-purple-50 rounded-lg p-2">
                        <div className="flex items-center gap-1 mb-1">
                           <span className="text-xs font-bold text-purple-800">LIFO</span>
                           <button onClick={() => showInfoModal('LIFO Method', 'Last In, First Out: Most recent costs go to COGS first. Calculate COGS using latest purchase prices, then remaining inventory at oldest prices.')} className="text-purple-400 text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <input type="number" placeholder="COGS" value={answers['lifo_cogs'] || ''} onChange={(e) => handleAnswer('lifo_cogs', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded mb-1" />
                        <input type="number" placeholder="Ending Inv" value={answers['lifo_ending'] || ''} onChange={(e) => handleAnswer('lifo_ending', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded" />
                     </div>
                     <div className="bg-green-50 rounded-lg p-2">
                        <div className="flex items-center gap-1 mb-1">
                           <span className="text-xs font-bold text-green-800">Weighted Avg</span>
                           <button onClick={() => showInfoModal('Weighted Average', `Avg Cost = Total Cost √∑ Total Units = $${current.available.cost.toLocaleString()} √∑ ${current.available.units} = $${(current.available.cost / current.available.units).toFixed(2)}/unit`)} className="text-green-400 text-xs">‚ÑπÔ∏è</button>
                        </div>
                        <input type="number" placeholder="COGS" value={answers['avg_cogs'] || ''} onChange={(e) => handleAnswer('avg_cogs', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded mb-1" />
                        <input type="number" placeholder="Ending Inv" value={answers['avg_ending'] || ''} onChange={(e) => handleAnswer('avg_ending', Number(e.target.value))} className="w-full px-2 py-1 text-xs border rounded" />
                     </div>
                  </div>

                  <button onClick={checkAnswers} className="w-full py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600">Check Answers</button>

                  {showInfo && (
                     <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-4 max-w-sm">
                           <h4 className="font-bold text-orange-800 mb-2">{infoContent.title}</h4>
                           <p className="text-sm text-gray-600 mb-3">{infoContent.content}</p>
                           <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-orange-500 text-white rounded-lg">Got it!</button>
                        </div>
                     </div>
                  )}
               </div>
            );
         }

         return (
            <div className="h-full flex flex-col p-4 bg-gradient-to-br from-orange-50 to-yellow-100 overflow-auto">
               <h3 className="font-bold text-orange-800 mb-3 text-center">Results: {current.title}</h3>

               <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                  <table className="w-full text-xs">
                     <thead>
                        <tr className="border-b">
                           <th className="text-left py-1">Method</th>
                           <th className="text-right py-1">Your COGS</th>
                           <th className="text-right py-1">Correct</th>
                           <th className="text-right py-1">Your End Inv</th>
                           <th className="text-right py-1">Correct</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr className="border-b">
                           <td className="py-1 font-medium text-blue-700">FIFO</td>
                           <td className={`text-right ${Math.abs((answers['fifo_cogs'] || 0) - current.fifo.cogs) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['fifo_cogs'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.fifo.cogs.toLocaleString()}</td>
                           <td className={`text-right ${Math.abs((answers['fifo_ending'] || 0) - current.fifo.ending) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['fifo_ending'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.fifo.ending.toLocaleString()}</td>
                        </tr>
                        <tr className="border-b">
                           <td className="py-1 font-medium text-purple-700">LIFO</td>
                           <td className={`text-right ${Math.abs((answers['lifo_cogs'] || 0) - current.lifo.cogs) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['lifo_cogs'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.lifo.cogs.toLocaleString()}</td>
                           <td className={`text-right ${Math.abs((answers['lifo_ending'] || 0) - current.lifo.ending) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['lifo_ending'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.lifo.ending.toLocaleString()}</td>
                        </tr>
                        <tr>
                           <td className="py-1 font-medium text-green-700">Wtd Avg</td>
                           <td className={`text-right ${Math.abs((answers['avg_cogs'] || 0) - current.avg.cogs) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['avg_cogs'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.avg.cogs.toLocaleString()}</td>
                           <td className={`text-right ${Math.abs((answers['avg_ending'] || 0) - current.avg.ending) <= 100 ? 'text-green-600' : 'text-red-600'}`}>${(answers['avg_ending'] || 0).toLocaleString()}</td>
                           <td className="text-right text-gray-600">${current.avg.ending.toLocaleString()}</td>
                        </tr>
                     </tbody>
                  </table>
               </div>

               <div className="bg-yellow-50 rounded-lg p-3 mb-3 text-xs">
                  <div className="font-semibold text-yellow-800 mb-1">üí° Key Insight:</div>
                  <p className="text-yellow-700">Notice how LIFO has highest COGS (${current.lifo.cogs.toLocaleString()}) and lowest ending inventory, while FIFO has lowest COGS (${current.fifo.cogs.toLocaleString()}) and highest ending inventory. Same transactions, different financial results!</p>
               </div>

               <button onClick={nextLevel} className="w-full py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600">
                  {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-orange-50 to-yellow-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-orange-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-orange-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-orange-50 border-2 border-transparent hover:border-orange-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = scenarios.length * 6 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-orange-50 to-yellow-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üì¶' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-orange-800 mb-2">Inventory Valuation Complete!</h2>
                  <p className="text-3xl font-bold text-orange-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-orange-700 mb-4">{pct}% Accuracy</p>
                  <div className="w-full max-w-xs h-3 bg-orange-200 rounded-full mb-4">
                     <div className="h-full bg-orange-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-orange-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ FIFO: Lower COGS ‚Üí Higher profit ‚Üí Higher taxes</li>
                        <li>‚Ä¢ LIFO: Higher COGS ‚Üí Lower profit ‚Üí Tax savings</li>
                        <li>‚Ä¢ Weighted Avg: Smooths fluctuations</li>
                        <li>‚Ä¢ LIFO not allowed under IFRS</li>
                        <li>‚Ä¢ Same inventory, different financial results!</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const COGSCalculationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });

      const tutorials = [
         { title: 'What is COGS?', content: 'Cost of Goods Sold (COGS) represents the direct costs of producing goods that were sold during a period. It\'s subtracted from revenue to calculate gross profit.', icon: 'üìä' },
         { title: 'The Basic COGS Formula', content: 'COGS = Beginning Inventory + Purchases ‚àí Ending Inventory. This formula tracks the cost of inventory that "flows through" to sales.', icon: 'üßÆ' },
         { title: 'Retail vs Manufacturing', content: 'Retailers: COGS = purchase cost of merchandise. Manufacturers: COGS includes raw materials, direct labor, and manufacturing overhead.', icon: 'üè≠' },
         { title: 'Cost of Goods Manufactured', content: 'For manufacturers: COGM = Beginning WIP + Manufacturing Costs (DM + DL + OH) ‚àí Ending WIP. This feeds into the COGS calculation.', icon: '‚öôÔ∏è' },
         { title: 'What\'s Included in COGS?', content: 'Included: Direct materials, direct labor, factory overhead. NOT included: Selling expenses, administrative costs, interest, income tax.', icon: '‚úÖ' },
         { title: 'COGS Impact on Profits', content: 'Higher COGS = Lower gross profit. Companies try to reduce COGS through efficiency, bulk purchasing, or automation while maintaining quality.', icon: 'üí∞' },
         { title: 'Your Challenge', content: 'Calculate COGS for different business types‚Äîfrom simple retail to complex manufacturing. Master the formulas that drive profitability!', icon: 'üéÆ' }
      ];

      const scenarios = [
         {
            type: 'retail',
            title: 'Simple Retail Store',
            description: 'Budget Books sells used textbooks. Calculate their January COGS:',
            data: {
               beginningInventory: 15000,
               purchases: 42000,
               purchaseReturns: 2000,
               freightIn: 1500,
               endingInventory: 18000
            },
            formula: 'COGS = Beginning Inv + Net Purchases ‚àí Ending Inv',
            steps: ['Net Purchases = Purchases ‚àí Returns + Freight In', 'Net Purchases = $42,000 ‚àí $2,000 + $1,500 = $41,500', 'COGS = $15,000 + $41,500 ‚àí $18,000 = $38,500'],
            answer: 38500
         },
         {
            type: 'retail_multi',
            title: 'Multi-Product Retailer',
            description: 'GadgetWorld tracks inventory by category. Calculate total COGS:',
            data: {
               electronics: { beginning: 50000, purchases: 120000, ending: 45000 },
               accessories: { beginning: 12000, purchases: 35000, ending: 15000 },
               services: { beginning: 0, purchases: 0, ending: 0 }
            },
            formula: 'Sum COGS across all product categories',
            steps: ['Electronics: $50K + $120K ‚àí $45K = $125,000', 'Accessories: $12K + $35K ‚àí $15K = $32,000', 'Total COGS = $125,000 + $32,000 = $157,000'],
            answer: 157000
         },
         {
            type: 'manufacturing',
            title: 'Manufacturing Company',
            description: 'FurnitureCraft makes custom tables. Calculate COGS for Q1:',
            data: {
               beginningFG: 25000,
               directMaterials: 85000,
               directLabor: 65000,
               manufacturingOH: 45000,
               beginningWIP: 10000,
               endingWIP: 15000,
               endingFG: 30000
            },
            formula: 'COGS = Beginning FG + COGM ‚àí Ending FG',
            steps: [
               'COGM = Beg WIP + (DM + DL + OH) ‚àí End WIP',
               'COGM = $10K + ($85K + $65K + $45K) ‚àí $15K = $190,000',
               'COGS = $25,000 + $190,000 ‚àí $30,000 = $185,000'
            ],
            answer: 185000
         },
         {
            type: 'complex',
            title: 'Complex Manufacturing',
            description: 'TechAssembly Inc. has detailed cost tracking. Find COGS:',
            data: {
               beginningRM: 20000,
               purchasesRM: 150000,
               endingRM: 25000,
               directLabor: 180000,
               factoryRent: 36000,
               utilities: 12000,
               depreciation: 24000,
               supervision: 48000,
               beginningWIP: 35000,
               endingWIP: 40000,
               beginningFG: 60000,
               endingFG: 55000
            },
            formula: 'Track costs through Raw Materials ‚Üí WIP ‚Üí Finished Goods',
            steps: [
               'DM Used = $20K + $150K ‚àí $25K = $145,000',
               'OH = $36K + $12K + $24K + $48K = $120,000',
               'Total Mfg = $145K + $180K + $120K = $445,000',
               'COGM = $35K + $445K ‚àí $40K = $440,000',
               'COGS = $60K + $440K ‚àí $55K = $445,000'
            ],
            answer: 445000
         }
      ];

      const quizzes = [
         {
            question: 'Which of the following is NOT included in COGS?',
            options: ['Direct materials used in production', 'Factory workers\' wages', 'Sales team commissions', 'Manufacturing equipment depreciation'],
            correct: 2,
            explanation: 'Sales commissions are a selling expense, not a production cost. COGS only includes costs directly tied to manufacturing/acquiring the goods sold.'
         },
         {
            question: 'If Beginning Inventory is $50K, Purchases are $200K, and Ending Inventory is $60K, what is COGS?',
            options: ['$190,000', '$210,000', '$250,000', '$310,000'],
            correct: 0,
            explanation: 'COGS = Beginning Inv + Purchases ‚àí Ending Inv = $50K + $200K ‚àí $60K = $190,000.'
         },
         {
            question: 'A company\'s COGS increased while sales remained flat. What happened to gross profit margin?',
            options: ['Increased', 'Decreased', 'Stayed the same', 'Cannot determine'],
            correct: 1,
            explanation: 'Gross Profit = Revenue ‚àí COGS. If COGS increases and revenue stays flat, gross profit decreases, reducing the gross profit margin.'
         },
         {
            question: 'In manufacturing, what does COGM stand for?',
            options: ['Cost of General Materials', 'Cost of Goods Manufactured', 'Calculation of Gross Margin', 'Cost of Goods Marketed'],
            correct: 1,
            explanation: 'COGM = Cost of Goods Manufactured, representing the total production cost of goods completed during the period.'
         },
         {
            question: 'Why might a service company have zero or minimal COGS?',
            options: ['They don\'t sell anything', 'Services don\'t involve physical inventory', 'COGS only applies to manufacturers', 'They expense everything immediately'],
            correct: 1,
            explanation: 'Service companies (consulting, software) primarily sell labor and expertise, not physical products. Their costs are typically categorized as operating expenses.'
         },
         {
            question: 'What happens to COGS when a company switches from FIFO to LIFO during inflation?',
            options: ['COGS decreases', 'COGS increases', 'COGS stays the same', 'COGS becomes unpredictable'],
            correct: 1,
            explanation: 'During inflation, LIFO assigns the most recent (higher) costs to COGS, increasing COGS compared to FIFO.'
         }
      ];

      const current = scenarios[level];

      const handleAnswer = (field: string, value: number) => {
         setAnswers(prev => ({ ...prev, [field]: value }));
      };

      const checkAnswer = () => {
         const userAnswer = answers['cogs'] || 0;
         const tolerance = current.answer * 0.02;
         const correct = Math.abs(userAnswer - current.answer) <= tolerance;

         if (correct) {
            setScore(prev => prev + 3);
            setGameLog(prev => [...prev, `Scenario ${level + 1}: Correctly calculated COGS as $${current.answer.toLocaleString()}`]);
         } else {
            setGameLog(prev => [...prev, `Scenario ${level + 1}: Incorrect - answered $${userAnswer.toLocaleString()}, correct was $${current.answer.toLocaleString()}`]);
         }
         setShowResults(true);
      };

      const nextLevel = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setPhase('result');
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct! +2 points`]);
         } else {
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Incorrect`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const showInfoModal = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-red-50 to-orange-100">
               <div className="text-6xl mb-4">üßÆ</div>
               <h1 className="text-2xl font-bold text-red-800 mb-2">Cost of Goods Sold (COGS)</h1>
               <p className="text-red-600 text-center mb-6 max-w-md">Master the COGS formula and understand how it impacts profitability for retail and manufacturing businesses.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-red-50 to-orange-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-red-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-red-200 rounded-full">
                     <div className="h-full bg-red-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-red-800 mb-3">{t.title}</h2>
                  <p className="text-red-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-red-200 text-red-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Next</button>
                  ) : (
                     <button onClick={() => setPhase('play')} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Practice ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         if (!showResults) {
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-red-50 to-orange-100 overflow-auto">
                  <div className="flex justify-between items-center mb-3">
                     <span className="text-sm font-medium text-red-700">Scenario {level + 1}/{scenarios.length}</span>
                     <span className="text-sm font-semibold text-red-800">Score: {score}</span>
                  </div>

                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <div className="flex items-center gap-2 mb-2">
                        <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium">{current.type === 'retail' || current.type === 'retail_multi' ? 'Retail' : 'Manufacturing'}</span>
                        <h3 className="font-bold text-red-800">{current.title}</h3>
                        <button onClick={() => showInfoModal('COGS Formula', current.formula)} className="text-red-400 hover:text-red-600">‚ÑπÔ∏è</button>
                     </div>
                     <p className="text-sm text-gray-600 mb-3">{current.description}</p>

                     <div className="bg-red-50 rounded-lg p-3 text-xs space-y-2">
                        {current.type === 'retail' && (
                           <>
                              <div className="flex justify-between"><span>Beginning Inventory:</span><span className="font-semibold">${current.data.beginningInventory?.toLocaleString()}</span></div>
                              <div className="flex justify-between"><span>Purchases:</span><span className="font-semibold">${current.data.purchases?.toLocaleString()}</span></div>
                              <div className="flex justify-between"><span>Purchase Returns:</span><span className="font-semibold text-red-600">‚àí${current.data.purchaseReturns?.toLocaleString()}</span></div>
                              <div className="flex justify-between"><span>Freight In:</span><span className="font-semibold">+${current.data.freightIn?.toLocaleString()}</span></div>
                              <div className="flex justify-between border-t pt-2"><span>Ending Inventory:</span><span className="font-semibold">${current.data.endingInventory?.toLocaleString()}</span></div>
                           </>
                        )}
                        {current.type === 'retail_multi' && (
                           <>
                              <div className="font-semibold text-red-800 mb-1">Electronics:</div>
                              <div className="flex justify-between pl-2"><span>Beg: ${current.data.electronics?.beginning?.toLocaleString()}</span><span>Purch: ${current.data.electronics?.purchases?.toLocaleString()}</span><span>End: ${current.data.electronics?.ending?.toLocaleString()}</span></div>
                              <div className="font-semibold text-red-800 mt-2 mb-1">Accessories:</div>
                              <div className="flex justify-between pl-2"><span>Beg: ${current.data.accessories?.beginning?.toLocaleString()}</span><span>Purch: ${current.data.accessories?.purchases?.toLocaleString()}</span><span>End: ${current.data.accessories?.ending?.toLocaleString()}</span></div>
                           </>
                        )}
                        {current.type === 'manufacturing' && (
                           <>
                              <div className="font-semibold text-red-800">Finished Goods:</div>
                              <div className="flex justify-between pl-2"><span>Beginning FG:</span><span>${current.data.beginningFG?.toLocaleString()}</span></div>
                              <div className="flex justify-between pl-2"><span>Ending FG:</span><span>${current.data.endingFG?.toLocaleString()}</span></div>
                              <div className="font-semibold text-red-800 mt-2">Manufacturing Costs:</div>
                              <div className="flex justify-between pl-2"><span>Direct Materials:</span><span>${current.data.directMaterials?.toLocaleString()}</span></div>
                              <div className="flex justify-between pl-2"><span>Direct Labor:</span><span>${current.data.directLabor?.toLocaleString()}</span></div>
                              <div className="flex justify-between pl-2"><span>Manufacturing OH:</span><span>${current.data.manufacturingOH?.toLocaleString()}</span></div>
                              <div className="font-semibold text-red-800 mt-2">Work in Progress:</div>
                              <div className="flex justify-between pl-2"><span>Beginning WIP:</span><span>${current.data.beginningWIP?.toLocaleString()}</span></div>
                              <div className="flex justify-between pl-2"><span>Ending WIP:</span><span>${current.data.endingWIP?.toLocaleString()}</span></div>
                           </>
                        )}
                        {current.type === 'complex' && (
                           <>
                              <div className="font-semibold text-red-800">Raw Materials:</div>
                              <div className="flex justify-between pl-2 text-xs"><span>Beg RM: ${current.data.beginningRM?.toLocaleString()}</span><span>Purch: ${current.data.purchasesRM?.toLocaleString()}</span><span>End RM: ${current.data.endingRM?.toLocaleString()}</span></div>
                              <div className="font-semibold text-red-800 mt-2">Direct Labor: <span className="font-normal">${current.data.directLabor?.toLocaleString()}</span></div>
                              <div className="font-semibold text-red-800 mt-2">Factory Overhead:</div>
                              <div className="grid grid-cols-2 gap-1 pl-2 text-xs">
                                 <span>Rent: ${current.data.factoryRent?.toLocaleString()}</span>
                                 <span>Utilities: ${current.data.utilities?.toLocaleString()}</span>
                                 <span>Depreciation: ${current.data.depreciation?.toLocaleString()}</span>
                                 <span>Supervision: ${current.data.supervision?.toLocaleString()}</span>
                              </div>
                              <div className="font-semibold text-red-800 mt-2">WIP & FG:</div>
                              <div className="flex justify-between pl-2"><span>Beg WIP: ${current.data.beginningWIP?.toLocaleString()}</span><span>End WIP: ${current.data.endingWIP?.toLocaleString()}</span></div>
                              <div className="flex justify-between pl-2"><span>Beg FG: ${current.data.beginningFG?.toLocaleString()}</span><span>End FG: ${current.data.endingFG?.toLocaleString()}</span></div>
                           </>
                        )}
                     </div>
                  </div>

                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <label className="block text-sm font-medium text-gray-700 mb-2">Your COGS Calculation:</label>
                     <div className="flex items-center gap-2">
                        <span className="text-lg text-gray-500">$</span>
                        <input type="number" value={answers['cogs'] || ''} onChange={(e) => handleAnswer('cogs', Number(e.target.value))} placeholder="Enter COGS amount" className="flex-1 px-3 py-2 border-2 border-red-200 rounded-lg focus:border-red-500 focus:outline-none text-lg" />
                     </div>
                  </div>

                  <button onClick={checkAnswer} disabled={!answers['cogs']} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 disabled:opacity-50">Check Answer</button>

                  {showInfo && (
                     <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-4 max-w-sm">
                           <h4 className="font-bold text-red-800 mb-2">{infoContent.title}</h4>
                           <p className="text-sm text-gray-600 mb-3">{infoContent.content}</p>
                           <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-red-500 text-white rounded-lg">Got it!</button>
                        </div>
                     </div>
                  )}
               </div>
            );
         }

         const userAnswer = answers['cogs'] || 0;
         const isCorrect = Math.abs(userAnswer - current.answer) <= current.answer * 0.02;

         return (
            <div className="h-full flex flex-col p-4 bg-gradient-to-br from-red-50 to-orange-100 overflow-auto">
               <div className={`rounded-xl p-4 mb-3 ${isCorrect ? 'bg-green-100 border-2 border-green-500' : 'bg-red-100 border-2 border-red-400'}`}>
                  <div className="flex items-center gap-2 mb-2">
                     <span className="text-2xl">{isCorrect ? '‚úÖ' : '‚ùå'}</span>
                     <span className="font-bold text-lg">{isCorrect ? 'Correct!' : 'Not quite right'}</span>
                  </div>
                  <div className="text-sm">
                     <p>Your answer: <span className="font-semibold">${userAnswer.toLocaleString()}</span></p>
                     <p>Correct answer: <span className="font-semibold text-green-700">${current.answer.toLocaleString()}</span></p>
                  </div>
               </div>

               <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                  <h4 className="font-bold text-red-800 mb-2">Step-by-Step Solution:</h4>
                  <div className="space-y-2 text-sm">
                     {current.steps.map((step, i) => (
                        <div key={i} className="flex items-start gap-2">
                           <span className="w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center flex-shrink-0">{i + 1}</span>
                           <span className="text-gray-700">{step}</span>
                        </div>
                     ))}
                  </div>
               </div>

               <button onClick={nextLevel} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">
                  {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-red-50 to-orange-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-red-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-red-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-red-50 border-2 border-transparent hover:border-red-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = scenarios.length * 3 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-red-50 to-orange-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üßÆ' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-red-800 mb-2">COGS Mastery Complete!</h2>
                  <p className="text-3xl font-bold text-red-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-red-700 mb-4">{pct}% Accuracy</p>
                  <div className="w-full max-w-xs h-3 bg-red-200 rounded-full mb-4">
                     <div className="h-full bg-red-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-red-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ COGS = Beg Inv + Purchases ‚àí End Inv</li>
                        <li>‚Ä¢ Manufacturing adds: DM + DL + OH</li>
                        <li>‚Ä¢ COGM feeds into COGS for manufacturers</li>
                        <li>‚Ä¢ Only production costs in COGS, not admin/selling</li>
                        <li>‚Ä¢ Higher COGS = Lower gross profit margin</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const ProfitMarginRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [answers, setAnswers] = useState<{[key: string]: number}>({});
      const [showResults, setShowResults] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });

      const tutorials = [
         { title: 'Understanding Profit Margins', content: 'Profit margins measure how much profit a company keeps from each dollar of revenue. They\'re essential for evaluating business efficiency and comparing companies.', icon: 'üìà' },
         { title: 'Gross Profit Margin', content: 'Gross Profit Margin = (Revenue ‚àí COGS) √∑ Revenue √ó 100%. Measures profitability after direct production costs. Higher margin = better production efficiency.', icon: 'üè≠' },
         { title: 'Operating Profit Margin', content: 'Operating Margin = Operating Income √∑ Revenue √ó 100%. After COGS AND operating expenses (rent, salaries, marketing). Shows core business profitability.', icon: '‚öôÔ∏è' },
         { title: 'Net Profit Margin', content: 'Net Profit Margin = Net Income √∑ Revenue √ó 100%. The "bottom line" after ALL expenses including taxes and interest. Shows overall profitability.', icon: 'üí∞' },
         { title: 'What Affects Each Margin?', content: 'Gross: COGS, pricing, suppliers. Operating: Rent, labor, efficiency. Net: Interest rates, tax strategy, one-time items. Each tells a different story!', icon: 'üîç' },
         { title: 'Industry Comparisons', content: 'Software: High gross margins (80%+). Retail: Low gross margins (25-40%). Restaurants: Medium gross, low net (3-9%). Always compare within industries!', icon: 'üìä' },
         { title: 'Your Challenge', content: 'Analyze real company scenarios, calculate all three margins, and identify what\'s driving profitability‚Äîor killing it!', icon: 'üéÆ' }
      ];

      const scenarios = [
         {
            title: 'SaaS Startup',
            description: 'CloudTech offers subscription software. Q1 financials:',
            data: {
               revenue: 500000,
               cogs: 75000,
               operatingExpenses: 325000,
               interestExpense: 10000,
               taxes: 18000
            },
            grossProfit: 425000,
            operatingIncome: 100000,
            netIncome: 72000,
            grossMargin: 85,
            operatingMargin: 20,
            netMargin: 14.4,
            insight: 'Excellent gross margin typical for SaaS! But high OpEx (sales, R&D) eats into operating profit. Net margin is healthy but watch the spending.'
         },
         {
            title: 'Retail Chain',
            description: 'ValueMart operates 50 discount stores. Annual results:',
            data: {
               revenue: 12000000,
               cogs: 8400000,
               operatingExpenses: 3000000,
               interestExpense: 150000,
               taxes: 90000
            },
            grossProfit: 3600000,
            operatingIncome: 600000,
            netIncome: 360000,
            grossMargin: 30,
            operatingMargin: 5,
            netMargin: 3,
            insight: 'Thin margins typical for discount retail. Volume is key‚Äîthey need to sell a lot to make money. A 1% improvement in margins = $120K more profit!'
         },
         {
            title: 'Restaurant Group',
            description: 'FreshBites owns 5 fast-casual restaurants:',
            data: {
               revenue: 2500000,
               cogs: 875000,
               operatingExpenses: 1500000,
               interestExpense: 25000,
               taxes: 20000
            },
            grossProfit: 1625000,
            operatingIncome: 125000,
            netIncome: 80000,
            grossMargin: 65,
            operatingMargin: 5,
            netMargin: 3.2,
            insight: 'Great gross margin (food costs controlled), but high labor and rent (OpEx) crush operating margins. This is the restaurant industry challenge!'
         },
         {
            title: 'Manufacturing Company',
            description: 'PrecisionParts makes industrial components:',
            data: {
               revenue: 8000000,
               cogs: 5200000,
               operatingExpenses: 1600000,
               interestExpense: 200000,
               taxes: 200000
            },
            grossProfit: 2800000,
            operatingIncome: 1200000,
            netIncome: 800000,
            grossMargin: 35,
            operatingMargin: 15,
            netMargin: 10,
            insight: 'Solid manufacturing margins. High interest suggests debt financing for equipment. Strong conversion from gross to net‚Äîefficient operations!'
         }
      ];

      const quizzes = [
         {
            question: 'A company has Revenue of $1M, COGS of $600K, and Net Income of $80K. What is the gross profit margin?',
            options: ['8%', '40%', '60%', '80%'],
            correct: 1,
            explanation: 'Gross Profit = $1M - $600K = $400K. Gross Margin = $400K √∑ $1M = 40%.'
         },
         {
            question: 'Which margin is most affected by changes in raw material costs?',
            options: ['Gross profit margin', 'Operating profit margin', 'Net profit margin', 'All equally affected'],
            correct: 0,
            explanation: 'Raw materials are part of COGS, which directly affects gross profit. While it flows through to other margins, gross margin sees the first and largest impact.'
         },
         {
            question: 'Company A has 80% gross margin but 5% net margin. Company B has 30% gross margin but 15% net margin. What can you conclude?',
            options: ['Company A is more profitable', 'Company B is more efficient at converting revenue to profit', 'Company A has lower COGS', 'Companies cannot be compared'],
            correct: 1,
            explanation: 'Company B keeps more of each revenue dollar as final profit. Company A\'s high gross margin is eroded by high operating expenses or other costs.'
         },
         {
            question: 'Which expense would impact operating margin but NOT gross margin?',
            options: ['Raw materials', 'Factory wages', 'Sales team salaries', 'Shipping costs to customers'],
            correct: 2,
            explanation: 'Sales salaries are operating expenses (SG&A), not part of COGS. They reduce operating income but don\'t affect gross profit.'
         },
         {
            question: 'A software company reports 85% gross margin. Why might this be expected?',
            options: ['Software has no costs', 'Once developed, marginal cost of each sale is very low', 'Software companies don\'t report COGS', 'This is unusually high for any industry'],
            correct: 1,
            explanation: 'Software has high upfront development costs but very low marginal cost per user (just hosting/support), resulting in high gross margins.'
         },
         {
            question: 'If gross margin stays flat but net margin drops significantly, what might have happened?',
            options: ['COGS increased', 'Operating expenses or interest/taxes increased', 'Revenue decreased', 'Nothing‚Äîthis is impossible'],
            correct: 1,
            explanation: 'Flat gross margin means COGS is stable relative to revenue. The margin compression must come from increased OpEx, interest, or taxes.'
         }
      ];

      const current = scenarios[level];

      const handleAnswer = (field: string, value: number) => {
         setAnswers(prev => ({ ...prev, [field]: value }));
      };

      const checkAnswers = () => {
         let pts = 0;
         const tolerance = 1;

         if (Math.abs((answers['gross'] || 0) - current.grossMargin) <= tolerance) pts += 2;
         if (Math.abs((answers['operating'] || 0) - current.operatingMargin) <= tolerance) pts += 2;
         if (Math.abs((answers['net'] || 0) - current.netMargin) <= tolerance) pts += 2;

         setScore(prev => prev + pts);
         setGameLog(prev => [...prev, `${current.title}: Scored ${pts}/6 points`]);
         setShowResults(true);
      };

      const nextLevel = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            setAnswers({});
            setShowResults(false);
         } else {
            setPhase('result');
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         } else {
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Incorrect`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const showInfoModal = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-50 to-teal-100">
               <div className="text-6xl mb-4">üìà</div>
               <h1 className="text-2xl font-bold text-emerald-800 mb-2">Profit Margin Analysis</h1>
               <p className="text-emerald-600 text-center mb-6 max-w-md">Master gross, operating, and net profit margins to understand what really drives business profitability.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-emerald-50 to-teal-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-emerald-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-emerald-200 rounded-full">
                     <div className="h-full bg-emerald-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-emerald-800 mb-3">{t.title}</h2>
                  <p className="text-emerald-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-emerald-200 text-emerald-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">Next</button>
                  ) : (
                     <button onClick={() => setPhase('play')} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Practice ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         if (!showResults) {
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-emerald-50 to-teal-100 overflow-auto">
                  <div className="flex justify-between items-center mb-3">
                     <span className="text-sm font-medium text-emerald-700">Scenario {level + 1}/{scenarios.length}</span>
                     <span className="text-sm font-semibold text-emerald-800">Score: {score}</span>
                  </div>

                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <h3 className="font-bold text-emerald-800 mb-1">{current.title}</h3>
                     <p className="text-sm text-gray-600 mb-3">{current.description}</p>

                     <div className="bg-emerald-50 rounded-lg p-3 text-xs space-y-1">
                        <div className="flex justify-between font-semibold text-emerald-800 border-b pb-1">
                           <span>Revenue</span>
                           <span>${current.data.revenue.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span>Cost of Goods Sold</span>
                           <span className="text-red-600">‚àí${current.data.cogs.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between font-medium text-emerald-700 border-b pb-1">
                           <span>Gross Profit</span>
                           <span>${current.grossProfit.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span>Operating Expenses</span>
                           <span className="text-red-600">‚àí${current.data.operatingExpenses.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between font-medium text-emerald-700 border-b pb-1">
                           <span>Operating Income</span>
                           <span>${current.operatingIncome.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span>Interest Expense</span>
                           <span className="text-red-600">‚àí${current.data.interestExpense.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between">
                           <span>Taxes</span>
                           <span className="text-red-600">‚àí${current.data.taxes.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between font-semibold text-emerald-800 border-t pt-1">
                           <span>Net Income</span>
                           <span>${current.netIncome.toLocaleString()}</span>
                        </div>
                     </div>
                  </div>

                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <div className="flex items-center gap-2 mb-3">
                        <span className="font-semibold text-gray-700">Calculate the Margins (%):</span>
                        <button onClick={() => showInfoModal('Margin Formulas', 'Gross = Gross Profit √∑ Revenue √ó 100\nOperating = Operating Income √∑ Revenue √ó 100\nNet = Net Income √∑ Revenue √ó 100')} className="text-emerald-400 hover:text-emerald-600">‚ÑπÔ∏è</button>
                     </div>
                     <div className="grid grid-cols-3 gap-2">
                        <div>
                           <label className="text-xs font-medium text-gray-600 block mb-1">Gross Margin</label>
                           <div className="flex items-center">
                              <input type="number" value={answers['gross'] || ''} onChange={(e) => handleAnswer('gross', Number(e.target.value))} placeholder="%" className="w-full px-2 py-2 border-2 border-emerald-200 rounded-lg focus:border-emerald-500 focus:outline-none" />
                              <span className="ml-1 text-gray-500">%</span>
                           </div>
                        </div>
                        <div>
                           <label className="text-xs font-medium text-gray-600 block mb-1">Operating Margin</label>
                           <div className="flex items-center">
                              <input type="number" value={answers['operating'] || ''} onChange={(e) => handleAnswer('operating', Number(e.target.value))} placeholder="%" className="w-full px-2 py-2 border-2 border-emerald-200 rounded-lg focus:border-emerald-500 focus:outline-none" />
                              <span className="ml-1 text-gray-500">%</span>
                           </div>
                        </div>
                        <div>
                           <label className="text-xs font-medium text-gray-600 block mb-1">Net Margin</label>
                           <div className="flex items-center">
                              <input type="number" step="0.1" value={answers['net'] || ''} onChange={(e) => handleAnswer('net', Number(e.target.value))} placeholder="%" className="w-full px-2 py-2 border-2 border-emerald-200 rounded-lg focus:border-emerald-500 focus:outline-none" />
                              <span className="ml-1 text-gray-500">%</span>
                           </div>
                        </div>
                     </div>
                  </div>

                  <button onClick={checkAnswers} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">Check Answers</button>

                  {showInfo && (
                     <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-4 max-w-sm">
                           <h4 className="font-bold text-emerald-800 mb-2">{infoContent.title}</h4>
                           <p className="text-sm text-gray-600 mb-3 whitespace-pre-line">{infoContent.content}</p>
                           <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-emerald-500 text-white rounded-lg">Got it!</button>
                        </div>
                     </div>
                  )}
               </div>
            );
         }

         return (
            <div className="h-full flex flex-col p-4 bg-gradient-to-br from-emerald-50 to-teal-100 overflow-auto">
               <h3 className="font-bold text-emerald-800 mb-3 text-center">{current.title} - Results</h3>

               <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                  <div className="grid grid-cols-3 gap-3 text-center mb-3">
                     <div className={`p-2 rounded-lg ${Math.abs((answers['gross'] || 0) - current.grossMargin) <= 1 ? 'bg-green-100' : 'bg-red-100'}`}>
                        <div className="text-xs text-gray-600">Gross Margin</div>
                        <div className="font-bold">{current.grossMargin}%</div>
                        <div className="text-xs text-gray-500">You: {answers['gross'] || 0}%</div>
                     </div>
                     <div className={`p-2 rounded-lg ${Math.abs((answers['operating'] || 0) - current.operatingMargin) <= 1 ? 'bg-green-100' : 'bg-red-100'}`}>
                        <div className="text-xs text-gray-600">Operating Margin</div>
                        <div className="font-bold">{current.operatingMargin}%</div>
                        <div className="text-xs text-gray-500">You: {answers['operating'] || 0}%</div>
                     </div>
                     <div className={`p-2 rounded-lg ${Math.abs((answers['net'] || 0) - current.netMargin) <= 1 ? 'bg-green-100' : 'bg-red-100'}`}>
                        <div className="text-xs text-gray-600">Net Margin</div>
                        <div className="font-bold">{current.netMargin}%</div>
                        <div className="text-xs text-gray-500">You: {answers['net'] || 0}%</div>
                     </div>
                  </div>

                  <div className="bg-emerald-50 rounded-lg p-3">
                     <div className="text-xs font-semibold text-emerald-800 mb-1">üí° Analysis:</div>
                     <p className="text-xs text-emerald-700">{current.insight}</p>
                  </div>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="text-xs font-semibold text-gray-700 mb-2">Margin Waterfall:</div>
                  <div className="space-y-1">
                     <div className="flex items-center gap-2">
                        <div className="w-20 text-xs text-gray-600">Gross</div>
                        <div className="flex-1 bg-gray-200 rounded-full h-4">
                           <div className="bg-green-500 h-full rounded-full" style={{ width: `${current.grossMargin}%` }}></div>
                        </div>
                        <span className="text-xs font-semibold w-10 text-right">{current.grossMargin}%</span>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-20 text-xs text-gray-600">Operating</div>
                        <div className="flex-1 bg-gray-200 rounded-full h-4">
                           <div className="bg-blue-500 h-full rounded-full" style={{ width: `${current.operatingMargin}%` }}></div>
                        </div>
                        <span className="text-xs font-semibold w-10 text-right">{current.operatingMargin}%</span>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-20 text-xs text-gray-600">Net</div>
                        <div className="flex-1 bg-gray-200 rounded-full h-4">
                           <div className="bg-purple-500 h-full rounded-full" style={{ width: `${current.netMargin * 3}%` }}></div>
                        </div>
                        <span className="text-xs font-semibold w-10 text-right">{current.netMargin}%</span>
                     </div>
                  </div>
               </div>

               <button onClick={nextLevel} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                  {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-emerald-50 to-teal-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-emerald-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-emerald-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-emerald-50 border-2 border-transparent hover:border-emerald-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = scenarios.length * 6 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-emerald-50 to-teal-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üìà' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-emerald-800 mb-2">Profit Margin Mastery!</h2>
                  <p className="text-3xl font-bold text-emerald-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-emerald-700 mb-4">{pct}% Accuracy</p>
                  <div className="w-full max-w-xs h-3 bg-emerald-200 rounded-full mb-4">
                     <div className="h-full bg-emerald-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-emerald-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ Gross Margin = (Revenue ‚àí COGS) √∑ Revenue</li>
                        <li>‚Ä¢ Operating Margin = Operating Income √∑ Revenue</li>
                        <li>‚Ä¢ Net Margin = Net Income √∑ Revenue</li>
                        <li>‚Ä¢ Compare margins within same industry</li>
                        <li>‚Ä¢ Watch the "margin waterfall" to find problems</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnswers({}); setShowResults(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const FinancialRatioAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [selectedCategory, setSelectedCategory] = useState<string>('liquidity');
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [analysisComplete, setAnalysisComplete] = useState<{[key: string]: boolean}>({});

      const tutorials = [
         { title: 'What Are Financial Ratios?', content: 'Ratios turn financial statements into diagnostic tools. By comparing numbers, we reveal insights about liquidity, efficiency, profitability, and risk that raw numbers alone cannot show.', icon: 'üìä' },
         { title: 'Liquidity Ratios', content: 'Can the company pay its bills? Current Ratio = Current Assets √∑ Current Liabilities. Quick Ratio excludes inventory (harder to liquidate). Higher is safer!', icon: 'üíß' },
         { title: 'Profitability Ratios', content: 'Is the company making money efficiently? ROE = Net Income √∑ Equity (return to owners). ROA = Net Income √∑ Assets (return on all resources). Higher is better!', icon: 'üí∞' },
         { title: 'Leverage Ratios', content: 'How much debt? Debt-to-Equity = Liabilities √∑ Equity. Interest Coverage = EBIT √∑ Interest. High leverage = higher risk but potential higher returns.', icon: '‚öñÔ∏è' },
         { title: 'Efficiency Ratios', content: 'How well are assets used? Inventory Turnover = COGS √∑ Avg Inventory. Receivables Turnover = Sales √∑ Avg AR. Higher turnover = more efficient.', icon: '‚ö°' },
         { title: 'Benchmarking Matters', content: 'Ratios mean nothing in isolation. Compare to: industry averages, competitors, and the company\'s own history. A "good" ratio depends on context.', icon: 'üìà' },
         { title: 'Your Dashboard', content: 'You\'ll analyze real companies using a Financial Health Dashboard. Calculate ratios, interpret the gauges, and diagnose each company\'s financial health!', icon: 'üéÆ' }
      ];

      const companies = [
         {
            name: 'TechStart Inc.',
            industry: 'Software (SaaS)',
            description: 'A growing software company with strong revenue but heavy investment in growth.',
            financials: {
               currentAssets: 500000, inventory: 0, currentLiabilities: 200000,
               totalAssets: 1200000, totalLiabilities: 400000, equity: 800000,
               revenue: 2000000, netIncome: 200000, ebit: 280000, interestExpense: 20000,
               cogs: 400000, avgInventory: 0, avgReceivables: 250000
            },
            ratios: {
               currentRatio: 2.5, quickRatio: 2.5, roe: 25, roa: 16.7,
               debtToEquity: 0.5, interestCoverage: 14, inventoryTurnover: 0, receivablesTurnover: 8
            },
            diagnosis: 'Excellent liquidity, strong profitability, low leverage. Classic healthy SaaS metrics!'
         },
         {
            name: 'RetailMart Corp.',
            industry: 'Retail',
            description: 'A discount retailer with thin margins and heavy inventory investment.',
            financials: {
               currentAssets: 800000, inventory: 500000, currentLiabilities: 600000,
               totalAssets: 2000000, totalLiabilities: 1200000, equity: 800000,
               revenue: 5000000, netIncome: 100000, ebit: 180000, interestExpense: 60000,
               cogs: 3500000, avgInventory: 480000, avgReceivables: 50000
            },
            ratios: {
               currentRatio: 1.33, quickRatio: 0.5, roe: 12.5, roa: 5,
               debtToEquity: 1.5, interestCoverage: 3, inventoryTurnover: 7.3, receivablesTurnover: 100
            },
            diagnosis: 'Tight liquidity (low quick ratio), moderate profitability, high leverage. Typical retail profile - volume dependent!'
         },
         {
            name: 'BuildCo Construction',
            industry: 'Construction',
            description: 'A construction firm with project-based revenue and equipment financing.',
            financials: {
               currentAssets: 400000, inventory: 100000, currentLiabilities: 500000,
               totalAssets: 3000000, totalLiabilities: 2000000, equity: 1000000,
               revenue: 4000000, netIncome: 120000, ebit: 300000, interestExpense: 150000,
               cogs: 3200000, avgInventory: 120000, avgReceivables: 600000
            },
            ratios: {
               currentRatio: 0.8, quickRatio: 0.6, roe: 12, roa: 4,
               debtToEquity: 2.0, interestCoverage: 2, inventoryTurnover: 26.7, receivablesTurnover: 6.7
            },
            diagnosis: 'Liquidity concerns (current ratio < 1), high leverage from equipment debt, slow receivables collection. Monitor cash flow closely!'
         },
         {
            name: 'PharmaCure Labs',
            industry: 'Pharmaceuticals',
            description: 'A biotech firm with high R&D spending and strong cash reserves.',
            financials: {
               currentAssets: 2000000, inventory: 200000, currentLiabilities: 300000,
               totalAssets: 5000000, totalLiabilities: 500000, equity: 4500000,
               revenue: 3000000, netIncome: 450000, ebit: 600000, interestExpense: 10000,
               cogs: 600000, avgInventory: 180000, avgReceivables: 400000
            },
            ratios: {
               currentRatio: 6.67, quickRatio: 6.0, roe: 10, roa: 9,
               debtToEquity: 0.11, interestCoverage: 60, inventoryTurnover: 3.3, receivablesTurnover: 7.5
            },
            diagnosis: 'Fortress balance sheet! Extremely high liquidity, very low debt. Lower ROE due to large equity base - typical for cash-rich pharma.'
         }
      ];

      const quizzes = [
         {
            question: 'A company has a current ratio of 0.8. What does this indicate?',
            options: ['Strong liquidity position', 'Current liabilities exceed current assets', 'High profitability', 'Low debt levels'],
            correct: 1,
            explanation: 'Current ratio < 1 means current liabilities exceed current assets. The company may struggle to pay short-term obligations.'
         },
         {
            question: 'Company A has ROE of 25% and Company B has ROE of 15%. Which is definitely better?',
            options: ['Company A - higher ROE means better', 'Company B - lower is safer', 'Cannot determine without knowing leverage', 'Both are equally good'],
            correct: 2,
            explanation: 'High ROE can come from high debt (leverage amplifies returns). Company A might be riskier. Always check debt levels alongside ROE.'
         },
         {
            question: 'A debt-to-equity ratio of 2.0 means:',
            options: ['Equity is twice the debt', 'Debt is twice the equity', 'The company has no debt', 'The company is bankrupt'],
            correct: 1,
            explanation: 'D/E of 2.0 means total debt is 2x shareholders\' equity. For every $1 of equity, there is $2 of debt - this is moderately high leverage.'
         },
         {
            question: 'Why might a software company have a quick ratio equal to its current ratio?',
            options: ['It has no current assets', 'It has no inventory', 'It has excessive debt', 'It has negative equity'],
            correct: 1,
            explanation: 'Quick Ratio = (Current Assets - Inventory) √∑ Current Liabilities. Software companies typically have no physical inventory, so both ratios are equal.'
         },
         {
            question: 'An interest coverage ratio of 1.2 is concerning because:',
            options: ['The company is too profitable', 'EBIT barely covers interest payments', 'The company has too much cash', 'Debt is too low'],
            correct: 1,
            explanation: 'Interest coverage of 1.2 means EBIT is only 20% more than interest expense. Any small decline in earnings could make interest payments difficult.'
         },
         {
            question: 'Which ratio would be MOST important for a bank evaluating a loan application?',
            options: ['ROE - profitability for owners', 'Inventory turnover - efficiency', 'Interest coverage - ability to pay debt', 'Receivables turnover - collection speed'],
            correct: 2,
            explanation: 'Banks care most about getting repaid. Interest coverage shows if the company can handle debt payments. A bank wants to see coverage well above 1.5x.'
         }
      ];

      const current = companies[level];

      const getRatioStatus = (ratio: string, value: number): { color: string; status: string } => {
         switch (ratio) {
            case 'currentRatio':
               if (value < 1) return { color: 'red', status: 'DANGER' };
               if (value < 1.5) return { color: 'yellow', status: 'CAUTION' };
               return { color: 'green', status: 'HEALTHY' };
            case 'quickRatio':
               if (value < 0.5) return { color: 'red', status: 'DANGER' };
               if (value < 1) return { color: 'yellow', status: 'CAUTION' };
               return { color: 'green', status: 'HEALTHY' };
            case 'roe':
               if (value < 10) return { color: 'yellow', status: 'BELOW AVG' };
               if (value < 20) return { color: 'green', status: 'SOLID' };
               return { color: 'green', status: 'EXCELLENT' };
            case 'roa':
               if (value < 5) return { color: 'yellow', status: 'LOW' };
               if (value < 10) return { color: 'green', status: 'GOOD' };
               return { color: 'green', status: 'EXCELLENT' };
            case 'debtToEquity':
               if (value > 2) return { color: 'red', status: 'HIGH RISK' };
               if (value > 1) return { color: 'yellow', status: 'MODERATE' };
               return { color: 'green', status: 'CONSERVATIVE' };
            case 'interestCoverage':
               if (value < 1.5) return { color: 'red', status: 'DANGER' };
               if (value < 3) return { color: 'yellow', status: 'TIGHT' };
               return { color: 'green', status: 'SAFE' };
            default:
               return { color: 'gray', status: 'N/A' };
         }
      };

      const Gauge = ({ label, value, ratio, formula }: { label: string; value: number; ratio: string; formula: string }) => {
         const status = getRatioStatus(ratio, value);
         const colorClass = status.color === 'green' ? 'bg-green-500' : status.color === 'yellow' ? 'bg-yellow-500' : status.color === 'red' ? 'bg-red-500' : 'bg-gray-400';
         const textColor = status.color === 'green' ? 'text-green-700' : status.color === 'yellow' ? 'text-yellow-700' : status.color === 'red' ? 'text-red-700' : 'text-gray-600';

         return (
            <div className="bg-white rounded-lg p-3 shadow-sm border">
               <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-medium text-gray-600">{label}</span>
                  <button onClick={() => { setInfoContent({ title: label, content: formula }); setShowInfo(true); }} className="text-blue-400 hover:text-blue-600 text-xs">‚ÑπÔ∏è</button>
               </div>
               <div className="text-2xl font-bold text-gray-800">{typeof value === 'number' ? (ratio === 'roe' || ratio === 'roa' ? `${value.toFixed(1)}%` : value.toFixed(2)) : 'N/A'}</div>
               <div className="flex items-center gap-2 mt-2">
                  <div className={`w-3 h-3 rounded-full ${colorClass}`}></div>
                  <span className={`text-xs font-medium ${textColor}`}>{status.status}</span>
               </div>
               <div className="w-full h-2 bg-gray-200 rounded-full mt-2">
                  <div className={`h-full rounded-full ${colorClass}`} style={{ width: `${Math.min(100, (value / (ratio === 'debtToEquity' ? 3 : ratio === 'interestCoverage' ? 20 : ratio === 'roe' || ratio === 'roa' ? 30 : 5)) * 100)}%` }}></div>
               </div>
            </div>
         );
      };

      const handleCategoryComplete = (category: string) => {
         if (!analysisComplete[category]) {
            setAnalysisComplete(prev => ({ ...prev, [category]: true }));
            setScore(prev => prev + 3);
            setGameLog(prev => [...prev, `${current.name}: Analyzed ${category} ratios +3 points`]);
         }
      };

      const nextCompany = () => {
         if (level < companies.length - 1) {
            setLevel(prev => prev + 1);
            setAnalysisComplete({});
            setSelectedCategory('liquidity');
         } else {
            setPhase('result');
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-blue-100">
               <div className="text-6xl mb-4">üìä</div>
               <h1 className="text-2xl font-bold text-indigo-800 mb-2">Financial Ratio Analysis</h1>
               <p className="text-indigo-600 text-center mb-6 max-w-md">Master the diagnostic tools that turn financial statements into actionable insights about company health.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-indigo-50 to-blue-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-indigo-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-indigo-200 rounded-full">
                     <div className="h-full bg-indigo-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-indigo-800 mb-3">{t.title}</h2>
                  <p className="text-indigo-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-indigo-200 text-indigo-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Next</button>
                  ) : (
                     <button onClick={() => setPhase('play')} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Analysis ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const allCategoriesComplete = analysisComplete['liquidity'] && analysisComplete['profitability'] && analysisComplete['leverage'];

         return (
            <div className="h-full flex flex-col p-3 bg-gradient-to-br from-indigo-50 to-blue-100 overflow-auto">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-indigo-700">Company {level + 1}/{companies.length}</span>
                  <span className="text-sm font-semibold text-indigo-800">Score: {score}</span>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="flex items-center gap-2 mb-1">
                     <h3 className="font-bold text-indigo-800">{current.name}</h3>
                     <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">{current.industry}</span>
                  </div>
                  <p className="text-xs text-gray-600">{current.description}</p>
               </div>

               <div className="flex gap-1 mb-3">
                  {['liquidity', 'profitability', 'leverage'].map(cat => (
                     <button key={cat} onClick={() => { setSelectedCategory(cat); handleCategoryComplete(cat); }} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${selectedCategory === cat ? 'bg-indigo-500 text-white' : analysisComplete[cat] ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-gray-100 text-gray-600'}`}>
                        {analysisComplete[cat] && '‚úì '}{cat.charAt(0).toUpperCase() + cat.slice(1)}
                     </button>
                  ))}
               </div>

               {selectedCategory === 'liquidity' && (
                  <div className="grid grid-cols-2 gap-2 mb-3">
                     <Gauge label="Current Ratio" value={current.ratios.currentRatio} ratio="currentRatio" formula="Current Assets √∑ Current Liabilities = Can you pay bills due within 1 year?" />
                     <Gauge label="Quick Ratio" value={current.ratios.quickRatio} ratio="quickRatio" formula="(Current Assets - Inventory) √∑ Current Liabilities = Liquid assets only, excludes hard-to-sell inventory" />
                  </div>
               )}

               {selectedCategory === 'profitability' && (
                  <div className="grid grid-cols-2 gap-2 mb-3">
                     <Gauge label="Return on Equity" value={current.ratios.roe} ratio="roe" formula="Net Income √∑ Shareholders' Equity √ó 100 = Return generated on owners' investment" />
                     <Gauge label="Return on Assets" value={current.ratios.roa} ratio="roa" formula="Net Income √∑ Total Assets √ó 100 = How efficiently are ALL resources generating profit?" />
                  </div>
               )}

               {selectedCategory === 'leverage' && (
                  <div className="grid grid-cols-2 gap-2 mb-3">
                     <Gauge label="Debt-to-Equity" value={current.ratios.debtToEquity} ratio="debtToEquity" formula="Total Liabilities √∑ Shareholders' Equity = How much debt per dollar of equity?" />
                     <Gauge label="Interest Coverage" value={current.ratios.interestCoverage} ratio="interestCoverage" formula="EBIT √∑ Interest Expense = How many times can earnings cover interest payments?" />
                  </div>
               )}

               {allCategoriesComplete && (
                  <div className="bg-indigo-50 rounded-xl p-3 mb-3 border border-indigo-200">
                     <div className="flex items-center gap-2 mb-2">
                        <span className="text-lg">üîç</span>
                        <span className="font-semibold text-indigo-800">Diagnosis:</span>
                     </div>
                     <p className="text-sm text-indigo-700">{current.diagnosis}</p>
                  </div>
               )}

               <button onClick={nextCompany} disabled={!allCategoriesComplete} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                  {!allCategoriesComplete ? 'Analyze all categories to continue' : level < companies.length - 1 ? 'Next Company ‚Üí' : 'Take Quiz ‚Üí'}
               </button>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-white rounded-xl p-4 max-w-sm">
                        <h4 className="font-bold text-indigo-800 mb-2">{infoContent.title}</h4>
                        <p className="text-sm text-gray-600 mb-3">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-indigo-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-indigo-50 to-blue-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-indigo-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-indigo-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-indigo-50 border-2 border-transparent hover:border-indigo-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = companies.length * 9 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-indigo-50 to-blue-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üìä' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-indigo-800 mb-2">Ratio Analysis Complete!</h2>
                  <p className="text-3xl font-bold text-indigo-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-indigo-700 mb-4">{pct}% Mastery</p>
                  <div className="w-full max-w-xs h-3 bg-indigo-200 rounded-full mb-4">
                     <div className="h-full bg-indigo-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-indigo-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ Liquidity: Current & Quick ratios show bill-paying ability</li>
                        <li>‚Ä¢ Profitability: ROE & ROA measure return efficiency</li>
                        <li>‚Ä¢ Leverage: D/E & Interest Coverage show debt risk</li>
                        <li>‚Ä¢ Always compare to industry benchmarks</li>
                        <li>‚Ä¢ High ROE with high debt = amplified risk</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setAnalysisComplete({}); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const WorkingCapitalManagementRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [level, setLevel] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [dio, setDio] = useState(30);
      const [dso, setDso] = useState(45);
      const [dpo, setDpo] = useState(30);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [optimized, setOptimized] = useState(false);

      const tutorials = [
         { title: 'What is Working Capital?', content: 'Working Capital = Current Assets ‚àí Current Liabilities. It\'s the money available for day-to-day operations. Too little = can\'t pay bills. Too much = money sitting idle.', icon: 'üíµ' },
         { title: 'The Cash Conversion Cycle', content: 'CCC measures how long cash is tied up in operations. It tracks the journey: Buy Inventory ‚Üí Sell Product ‚Üí Collect Cash. Shorter cycle = faster cash recovery!', icon: 'üîÑ' },
         { title: 'Days Inventory Outstanding (DIO)', content: 'DIO = (Avg Inventory √∑ COGS) √ó 365. How many days inventory sits before selling. Lower is better‚Äîbut not so low you run out of stock!', icon: 'üì¶' },
         { title: 'Days Sales Outstanding (DSO)', content: 'DSO = (Avg Receivables √∑ Revenue) √ó 365. How long customers take to pay you. Lower DSO = faster cash collection. Watch for slow-paying customers!', icon: 'üìã' },
         { title: 'Days Payables Outstanding (DPO)', content: 'DPO = (Avg Payables √∑ COGS) √ó 365. How long YOU take to pay suppliers. Higher DPO = you keep cash longer. But don\'t damage supplier relationships!', icon: 'üìù' },
         { title: 'The CCC Formula', content: 'Cash Conversion Cycle = DIO + DSO ‚àí DPO. Positive CCC = you fund the gap. Negative CCC = suppliers fund your operations (the Amazon model!).', icon: 'üßÆ' },
         { title: 'Your Challenge', content: 'Optimize working capital for different businesses. Adjust DIO, DSO, and DPO to minimize CCC while avoiding operational problems!', icon: 'üéÆ' }
      ];

      const scenarios = [
         {
            name: 'Traditional Retailer',
            industry: 'Retail',
            description: 'MidTown Goods has typical retail metrics. Can you improve their cash cycle?',
            initial: { dio: 45, dso: 5, dpo: 30 },
            target: { ccc: 10 },
            constraints: { minDio: 20, maxDpo: 45, maxDso: 10 },
            revenue: 5000000,
            insight: 'Retail has low DSO (customers pay at purchase) but must balance inventory levels against stockouts.'
         },
         {
            name: 'B2B Manufacturer',
            industry: 'Manufacturing',
            description: 'IndustrialParts sells to businesses on 60-day terms. Long receivables are the challenge.',
            initial: { dio: 60, dso: 60, dpo: 45 },
            target: { ccc: 45 },
            constraints: { minDio: 30, maxDpo: 60, minDso: 30 },
            revenue: 10000000,
            insight: 'B2B companies face long DSO. Offering early payment discounts (2/10 net 30) can accelerate collections.'
         },
         {
            name: 'Tech Startup (SaaS)',
            industry: 'Software',
            description: 'CloudApp bills annually upfront. No inventory, fast collections. What\'s their advantage?',
            initial: { dio: 0, dso: 15, dpo: 30 },
            target: { ccc: -20 },
            constraints: { maxDio: 5, maxDso: 20, minDpo: 25 },
            revenue: 2000000,
            insight: 'SaaS with annual prepayment has negative CCC! Customers pay before you deliver the full service‚Äîyou\'re funded by customers.'
         },
         {
            name: 'Amazon-Style Marketplace',
            industry: 'E-commerce',
            description: 'FastShip wants to replicate Amazon\'s negative CCC. How do they do it?',
            initial: { dio: 25, dso: 2, dpo: 45 },
            target: { ccc: -30 },
            constraints: { minDio: 15, maxDso: 5, minDpo: 40 },
            revenue: 50000000,
            insight: 'Amazon\'s secret: Fast inventory turnover + instant customer payment + slow supplier payment = negative CCC. Suppliers fund Amazon\'s growth!'
         }
      ];

      const quizzes = [
         {
            question: 'A company has DIO of 30, DSO of 45, and DPO of 60. What is their Cash Conversion Cycle?',
            options: ['135 days', '75 days', '15 days', '-15 days'],
            correct: 2,
            explanation: 'CCC = DIO + DSO ‚àí DPO = 30 + 45 ‚àí 60 = 15 days. Cash is tied up for only 15 days!'
         },
         {
            question: 'Why is a negative Cash Conversion Cycle considered advantageous?',
            options: ['It means the company is losing money', 'Suppliers are funding operations before payment is received', 'The company collects cash before paying suppliers', 'It indicates high debt levels'],
            correct: 2,
            explanation: 'Negative CCC means you collect from customers BEFORE paying suppliers. You\'re using supplier money to fund operations‚Äîfree financing!'
         },
         {
            question: 'Which action would INCREASE (worsen) the Cash Conversion Cycle?',
            options: ['Paying suppliers faster', 'Collecting from customers faster', 'Selling inventory faster', 'Reducing inventory levels'],
            correct: 0,
            explanation: 'Paying suppliers faster reduces DPO, which INCREASES CCC. You want to hold onto cash longer (higher DPO) to improve CCC.'
         },
         {
            question: 'A retailer has $500K in current assets and $300K in current liabilities. What is their working capital?',
            options: ['$800,000', '$500,000', '$300,000', '$200,000'],
            correct: 3,
            explanation: 'Working Capital = Current Assets ‚àí Current Liabilities = $500K ‚àí $300K = $200,000. This is the cushion for daily operations.'
         },
         {
            question: 'Why might a company NOT want to maximize DPO (delay supplier payments)?',
            options: ['It reduces the CCC too much', 'It could damage supplier relationships and pricing', 'It increases inventory levels', 'It speeds up customer collections'],
            correct: 1,
            explanation: 'While high DPO improves CCC, paying too slowly can damage supplier relationships, lead to worse terms, or suppliers refusing to do business.'
         },
         {
            question: 'A company offers "2/10 net 30" terms. What does this mean and why offer it?',
            options: ['2% discount if paid in 10 days, otherwise due in 30', '2% interest charged after 10 days', '10% discount if paid in 2 days', '30% markup for late payment'],
            correct: 0,
            explanation: '2/10 net 30 = 2% discount for paying in 10 days, full amount due in 30 days. Companies offer this to reduce DSO and get cash faster.'
         }
      ];

      const current = scenarios[level];
      const ccc = dio + dso - dpo;
      const workingCapitalNeeded = Math.round((current.revenue / 365) * Math.max(0, ccc));

      const handleOptimize = () => {
         const targetMet = ccc <= current.target.ccc;
         const constraintsMet = dio >= current.constraints.minDio &&
                               dpo <= current.constraints.maxDpo &&
                               (current.constraints.minDso ? dso >= current.constraints.minDso : true) &&
                               (current.constraints.maxDso ? dso <= current.constraints.maxDso : true);

         if (targetMet && constraintsMet) {
            setScore(prev => prev + 5);
            setGameLog(prev => [...prev, `${current.name}: Optimized CCC to ${ccc} days! +5 points`]);
         } else if (targetMet) {
            setScore(prev => prev + 3);
            setGameLog(prev => [...prev, `${current.name}: CCC target met but constraints violated. +3 points`]);
         } else {
            setGameLog(prev => [...prev, `${current.name}: CCC ${ccc} days, target was ${current.target.ccc} days`]);
         }
         setOptimized(true);
      };

      const nextScenario = () => {
         if (level < scenarios.length - 1) {
            setLevel(prev => prev + 1);
            const next = scenarios[level + 1];
            setDio(next.initial.dio);
            setDso(next.initial.dso);
            setDpo(next.initial.dpo);
            setOptimized(false);
         } else {
            setPhase('result');
         }
      };

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const showInfoModal = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-cyan-50 to-blue-100">
               <div className="text-6xl mb-4">üîÑ</div>
               <h1 className="text-2xl font-bold text-cyan-800 mb-2">Working Capital Management</h1>
               <p className="text-cyan-600 text-center mb-6 max-w-md">Master the Cash Conversion Cycle and learn how companies like Amazon use negative working capital to fund growth.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-cyan-50 to-blue-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-cyan-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-cyan-200 rounded-full">
                     <div className="h-full bg-cyan-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-cyan-800 mb-3">{t.title}</h2>
                  <p className="text-cyan-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-cyan-200 text-cyan-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">Next</button>
                  ) : (
                     <button onClick={() => { setPhase('play'); setDio(scenarios[0].initial.dio); setDso(scenarios[0].initial.dso); setDpo(scenarios[0].initial.dpo); }} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Optimizing ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         return (
            <div className="h-full flex flex-col p-3 bg-gradient-to-br from-cyan-50 to-blue-100 overflow-auto">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-cyan-700">Scenario {level + 1}/{scenarios.length}</span>
                  <span className="text-sm font-semibold text-cyan-800">Score: {score}</span>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="flex items-center gap-2 mb-1">
                     <h3 className="font-bold text-cyan-800">{current.name}</h3>
                     <span className="px-2 py-0.5 bg-cyan-100 text-cyan-700 rounded text-xs">{current.industry}</span>
                  </div>
                  <p className="text-xs text-gray-600 mb-2">{current.description}</p>
                  <div className="text-xs text-cyan-700 font-medium">Target CCC: ‚â§ {current.target.ccc} days</div>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="text-center mb-3">
                     <div className="text-xs text-gray-500 mb-1">Cash Conversion Cycle</div>
                     <div className={`text-3xl font-bold ${ccc < 0 ? 'text-green-600' : ccc <= current.target.ccc ? 'text-cyan-600' : 'text-orange-600'}`}>
                        {ccc} days
                     </div>
                     <div className="text-xs text-gray-500 mt-1">
                        {ccc < 0 ? 'üéâ Negative CCC! Suppliers fund you!' : ccc <= current.target.ccc ? '‚úì Target achieved!' : '‚Üì Reduce to meet target'}
                     </div>
                  </div>

                  <div className="bg-cyan-50 rounded-lg p-2 mb-3">
                     <div className="flex justify-center items-center text-xs font-mono">
                        <span className="px-2 py-1 bg-blue-200 rounded">{dio}</span>
                        <span className="mx-1">+</span>
                        <span className="px-2 py-1 bg-purple-200 rounded">{dso}</span>
                        <span className="mx-1">‚àí</span>
                        <span className="px-2 py-1 bg-green-200 rounded">{dpo}</span>
                        <span className="mx-1">=</span>
                        <span className={`px-2 py-1 rounded font-bold ${ccc < 0 ? 'bg-green-300' : 'bg-orange-200'}`}>{ccc}</span>
                     </div>
                     <div className="flex justify-center text-xs text-gray-500 mt-1">
                        <span className="px-2">DIO</span>
                        <span className="px-2">DSO</span>
                        <span className="px-2">DPO</span>
                        <span className="px-2">CCC</span>
                     </div>
                  </div>

                  <div className="space-y-3">
                     <div>
                        <div className="flex justify-between items-center mb-1">
                           <div className="flex items-center gap-1">
                              <span className="text-xs font-medium text-gray-700">üì¶ Days Inventory (DIO)</span>
                              <button onClick={() => showInfoModal('DIO', 'How long inventory sits before selling. Lower = faster turnover. Min for this scenario: ' + current.constraints.minDio + ' days')} className="text-cyan-400 text-xs">‚ÑπÔ∏è</button>
                           </div>
                           <span className="text-sm font-semibold text-blue-600">{dio} days</span>
                        </div>
                        <input type="range" min={current.constraints.minDio || 0} max="90" value={dio} onChange={(e) => setDio(Number(e.target.value))} disabled={optimized} className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" />
                     </div>

                     <div>
                        <div className="flex justify-between items-center mb-1">
                           <div className="flex items-center gap-1">
                              <span className="text-xs font-medium text-gray-700">üìã Days Sales Outstanding (DSO)</span>
                              <button onClick={() => showInfoModal('DSO', 'How long customers take to pay. Lower = faster cash. Range: ' + (current.constraints.minDso || 0) + '-' + (current.constraints.maxDso || 90) + ' days')} className="text-cyan-400 text-xs">‚ÑπÔ∏è</button>
                           </div>
                           <span className="text-sm font-semibold text-purple-600">{dso} days</span>
                        </div>
                        <input type="range" min={current.constraints.minDso || 0} max={current.constraints.maxDso || 90} value={dso} onChange={(e) => setDso(Number(e.target.value))} disabled={optimized} className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer" />
                     </div>

                     <div>
                        <div className="flex justify-between items-center mb-1">
                           <div className="flex items-center gap-1">
                              <span className="text-xs font-medium text-gray-700">üìù Days Payables (DPO)</span>
                              <button onClick={() => showInfoModal('DPO', 'How long you take to pay suppliers. Higher = keep cash longer. Max for this scenario: ' + current.constraints.maxDpo + ' days')} className="text-cyan-400 text-xs">‚ÑπÔ∏è</button>
                           </div>
                           <span className="text-sm font-semibold text-green-600">{dpo} days</span>
                        </div>
                        <input type="range" min={current.constraints.minDpo || 0} max={current.constraints.maxDpo || 90} value={dpo} onChange={(e) => setDpo(Number(e.target.value))} disabled={optimized} className="w-full h-2 bg-green-200 rounded-lg appearance-none cursor-pointer" />
                     </div>
                  </div>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="flex justify-between text-xs">
                     <span className="text-gray-600">Working Capital Needed:</span>
                     <span className="font-semibold text-cyan-700">${workingCapitalNeeded.toLocaleString()}</span>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">Based on ${current.revenue.toLocaleString()} annual revenue</div>
               </div>

               {optimized && (
                  <div className="bg-cyan-50 rounded-xl p-3 mb-3 border border-cyan-200">
                     <div className="text-xs font-semibold text-cyan-800 mb-1">üí° Industry Insight:</div>
                     <p className="text-xs text-cyan-700">{current.insight}</p>
                  </div>
               )}

               {!optimized ? (
                  <button onClick={handleOptimize} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">Lock In Optimization</button>
               ) : (
                  <button onClick={nextScenario} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">
                     {level < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}
                  </button>
               )}

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-white rounded-xl p-4 max-w-sm">
                        <h4 className="font-bold text-cyan-800 mb-2">{infoContent.title}</h4>
                        <p className="text-sm text-gray-600 mb-3">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-cyan-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-cyan-50 to-blue-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-cyan-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-cyan-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-cyan-50 border-2 border-transparent hover:border-cyan-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = scenarios.length * 5 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-cyan-50 to-blue-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üîÑ' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-cyan-800 mb-2">Working Capital Mastery!</h2>
                  <p className="text-3xl font-bold text-cyan-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-cyan-700 mb-4">{pct}% Accuracy</p>
                  <div className="w-full max-w-xs h-3 bg-cyan-200 rounded-full mb-4">
                     <div className="h-full bg-cyan-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-cyan-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ CCC = DIO + DSO ‚àí DPO</li>
                        <li>‚Ä¢ Negative CCC = suppliers fund your operations</li>
                        <li>‚Ä¢ Lower DIO & DSO improve cash cycle</li>
                        <li>‚Ä¢ Higher DPO helps, but respect supplier relationships</li>
                        <li>‚Ä¢ Amazon's secret: Negative CCC funds growth!</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setLevel(0); setOptimized(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   const BudgetForecastRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [currentMonth, setCurrentMonth] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [userPrediction, setUserPrediction] = useState<number | null>(null);
      const [predictionSubmitted, setPredictionSubmitted] = useState(false);

      const tutorials = [
         { title: 'Budget vs. Forecast', content: 'A BUDGET is your financial plan‚Äîwhat you intend to spend and earn. A FORECAST is your prediction of what will actually happen based on current trends. Both are essential!', icon: 'üìä' },
         { title: 'The Budget (Your Plan)', content: 'Budgets are set at the start of a period and typically stay fixed. They represent targets and commitments. "We plan to spend $100K on marketing this quarter."', icon: 'üìã' },
         { title: 'The Forecast (Your Prediction)', content: 'Forecasts update as new information arrives. They predict likely outcomes. "Based on Q1 results, we now expect $95K in marketing spend this quarter."', icon: 'üîÆ' },
         { title: 'Actual Results (Reality)', content: 'Actuals are what really happened. Comparing Budget vs. Forecast vs. Actual reveals planning accuracy and helps improve future estimates.', icon: '‚úÖ' },
         { title: 'Why Both Matter', content: 'Budgets set accountability and targets. Forecasts help you react to changes. A company with only budgets can\'t adapt. A company with only forecasts lacks discipline.', icon: '‚öñÔ∏è' },
         { title: 'Rolling Forecasts', content: 'Many companies use "rolling forecasts" that always look 12-18 months ahead, updating monthly. This replaces rigid annual budgets with continuous planning.', icon: 'üîÑ' },
         { title: 'Your Challenge', content: 'Watch how budgets, forecasts, and actuals diverge over time. Predict where the company will land and understand why forecasts must adjust!', icon: 'üéÆ' }
      ];

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];

      const scenarios = [
         {
            name: 'SaaS Startup - Revenue Growth',
            metric: 'Monthly Revenue',
            budget: [100000, 100000, 100000, 100000, 100000, 100000],
            actuals: [98000, 95000, 92000, 88000, 85000, 82000],
            forecasts: [100000, 97000, 93000, 89000, 86000, 83000],
            insight: 'The budget assumed steady $100K/month, but customer churn increased. Forecasts adjusted down each month as the trend became clear. Budget stayed fixed‚Äîthat was the original plan.',
            question: 'What will June actual revenue be based on the trend?',
            tolerance: 5000
         },
         {
            name: 'Retail Store - Seasonal Sales',
            metric: 'Monthly Sales',
            budget: [80000, 85000, 90000, 100000, 120000, 150000],
            actuals: [82000, 88000, 95000, 108000, 130000, 160000],
            forecasts: [80000, 84000, 92000, 105000, 128000, 155000],
            insight: 'Actual sales exceeded budget every month! This retailer had a strong season. The forecast adjusted upward as the pattern emerged, but the original budget was conservative.',
            question: 'What will June actual sales be based on the trend?',
            tolerance: 8000
         },
         {
            name: 'Manufacturing - Cost Control',
            metric: 'Monthly Expenses',
            budget: [200000, 200000, 200000, 200000, 200000, 200000],
            actuals: [210000, 225000, 240000, 250000, 255000, 258000],
            forecasts: [200000, 215000, 235000, 248000, 254000, 257000],
            insight: 'Costs spiraled above budget due to supply chain issues. Each month the forecast adjusted to reflect reality, while the budget stayed at the original $200K target. This gap signals a problem!',
            question: 'What will June actual expenses be based on the trend?',
            tolerance: 6000
         }
      ];

      const currentScenario = scenarios[Math.min(Math.floor(currentMonth / 6), scenarios.length - 1)];
      const scenarioMonth = currentMonth % 6;

      const handlePrediction = () => {
         if (userPrediction === null) return;

         const actual = currentScenario.actuals[5];
         const diff = Math.abs(userPrediction - actual);

         if (diff <= currentScenario.tolerance) {
            setScore(prev => prev + 5);
            setGameLog(prev => [...prev, `${currentScenario.name}: Excellent prediction! Within $${diff.toLocaleString()} of actual.`]);
         } else if (diff <= currentScenario.tolerance * 2) {
            setScore(prev => prev + 3);
            setGameLog(prev => [...prev, `${currentScenario.name}: Good prediction! Off by $${diff.toLocaleString()}.`]);
         } else {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `${currentScenario.name}: Prediction was $${diff.toLocaleString()} off from actual.`]);
         }
         setPredictionSubmitted(true);
      };

      const nextScenario = () => {
         if (currentMonth < (scenarios.length * 6) - 1) {
            setCurrentMonth(prev => Math.floor(prev / 6) * 6 + 6);
            setUserPrediction(null);
            setPredictionSubmitted(false);
         } else {
            setPhase('result');
         }
      };

      const quizzes = [
         {
            question: 'What is the key difference between a budget and a forecast?',
            options: ['Budgets are for expenses, forecasts are for revenue', 'Budgets are fixed plans, forecasts adjust to reality', 'Budgets are monthly, forecasts are annual', 'There is no difference'],
            correct: 1,
            explanation: 'Budgets are set plans that typically stay fixed. Forecasts are predictions that update as new information becomes available.'
         },
         {
            question: 'A company budgeted $50K for marketing but the forecast now shows $60K. What does this indicate?',
            options: ['The budget was wrong', 'Spending is trending higher than planned', 'Marketing is failing', 'The forecast is always more accurate'],
            correct: 1,
            explanation: 'The forecast adjusting upward indicates actual spending is trending above the original plan. This is a signal to investigate why and decide if action is needed.'
         },
         {
            question: 'Why might a company use "rolling forecasts" instead of annual budgets?',
            options: ['They\'re easier to create', 'They provide continuous visibility into the future', 'They eliminate the need for planning', 'They\'re required by accounting standards'],
            correct: 1,
            explanation: 'Rolling forecasts always look 12-18 months ahead and update regularly, providing continuous forward visibility rather than a once-a-year planning exercise.'
         },
         {
            question: 'If actual results consistently beat the budget, what might this suggest?',
            options: ['The team is performing well', 'The budget was too conservative', 'Forecasting is unnecessary', 'Both A and B could be true'],
            correct: 3,
            explanation: 'Consistently beating budget could mean strong performance OR that the budget was set too low. Good analysis considers both possibilities.'
         },
         {
            question: 'When should you revise a budget mid-year?',
            options: ['Never - budgets are fixed', 'Whenever actuals differ from budget', 'Only for major business changes', 'Monthly, like a forecast'],
            correct: 2,
            explanation: 'Budgets typically stay fixed to maintain accountability. However, major changes (acquisitions, market shifts) may warrant a formal budget revision.'
         },
         {
            question: 'A forecast shows revenue declining but the budget shows growth. What should management do?',
            options: ['Ignore the forecast and trust the budget', 'Investigate the gap and take corrective action', 'Replace the budget with the forecast', 'Wait until year-end to assess'],
            correct: 1,
            explanation: 'The gap between forecast and budget is a warning signal. Management should investigate why reality differs from plan and take action if needed.'
         }
      ];

      const handleQuizAnswer = (idx: number) => {
         if (quizAnswered) return;
         setQuizAnswered(true);
         if (idx === quizzes[quizIndex].correct) {
            setScore(prev => prev + 2);
            setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: Correct!`]);
         }
      };

      const nextQuiz = () => {
         if (quizIndex < quizzes.length - 1) {
            setQuizIndex(prev => prev + 1);
            setQuizAnswered(false);
         } else {
            setPhase('result');
         }
      };

      if (phase === 'intro') {
         return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-violet-50 to-purple-100">
               <div className="text-6xl mb-4">üìä</div>
               <h1 className="text-2xl font-bold text-violet-800 mb-2">Budgeting vs. Forecasting</h1>
               <p className="text-violet-600 text-center mb-6 max-w-md">Learn the difference between financial plans and predictions, and why successful companies need both.</p>
               <button onClick={() => setPhase('tutorial')} className="px-8 py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600 transition-all">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const t = tutorials[tutorialStep];
         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-violet-50 to-purple-100">
               <div className="flex justify-between items-center mb-4">
                  <span className="text-sm text-violet-600">Tutorial {tutorialStep + 1}/{tutorials.length}</span>
                  <div className="w-32 h-2 bg-violet-200 rounded-full">
                     <div className="h-full bg-violet-500 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorials.length) * 100}%` }}></div>
                  </div>
               </div>
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{t.icon}</div>
                  <h2 className="text-xl font-bold text-violet-800 mb-3">{t.title}</h2>
                  <p className="text-violet-700 text-center max-w-md leading-relaxed">{t.content}</p>
               </div>
               <div className="flex justify-between">
                  <button onClick={() => setTutorialStep(prev => Math.max(0, prev - 1))} disabled={tutorialStep === 0} className="px-4 py-2 bg-violet-200 text-violet-700 rounded-lg disabled:opacity-50">Back</button>
                  {tutorialStep < tutorials.length - 1 ? (
                     <button onClick={() => setTutorialStep(prev => prev + 1)} className="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600">Next</button>
                  ) : (
                     <button onClick={() => setPhase('play')} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Start Simulation ‚Üí</button>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const scenarioIndex = Math.floor(currentMonth / 6);

         return (
            <div className="h-full flex flex-col p-3 bg-gradient-to-br from-violet-50 to-purple-100 overflow-auto">
               <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-violet-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span>
                  <span className="text-sm font-semibold text-violet-800">Score: {score}</span>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <h3 className="font-bold text-violet-800 mb-1">{currentScenario.name}</h3>
                  <p className="text-xs text-gray-600">Tracking: {currentScenario.metric}</p>
               </div>

               <div className="bg-white rounded-xl p-3 mb-3 shadow-sm">
                  <div className="flex items-center gap-4 mb-3 text-xs">
                     <div className="flex items-center gap-1">
                        <div className="w-3 h-3 bg-blue-500 rounded"></div>
                        <span>Budget (Plan)</span>
                     </div>
                     <div className="flex items-center gap-1">
                        <div className="w-3 h-3 bg-amber-500 rounded"></div>
                        <span>Forecast</span>
                     </div>
                     <div className="flex items-center gap-1">
                        <div className="w-3 h-3 bg-green-500 rounded"></div>
                        <span>Actual</span>
                     </div>
                  </div>

                  <div className="overflow-x-auto">
                     <table className="w-full text-xs">
                        <thead>
                           <tr className="border-b">
                              <th className="text-left py-1 px-2">Month</th>
                              {months.map((m, i) => (
                                 <th key={m} className={`text-center py-1 px-2 ${i === 5 && !predictionSubmitted ? 'bg-violet-100' : ''}`}>{m}</th>
                              ))}
                           </tr>
                        </thead>
                        <tbody>
                           <tr className="border-b">
                              <td className="py-1 px-2 font-medium text-blue-700">Budget</td>
                              {currentScenario.budget.map((val, i) => (
                                 <td key={i} className="text-center py-1 px-2">${(val/1000).toFixed(0)}K</td>
                              ))}
                           </tr>
                           <tr className="border-b">
                              <td className="py-1 px-2 font-medium text-amber-700">Forecast</td>
                              {currentScenario.forecasts.map((val, i) => (
                                 <td key={i} className={`text-center py-1 px-2 ${i === 5 && !predictionSubmitted ? 'bg-amber-50' : ''}`}>
                                    {i < 5 || predictionSubmitted ? `$${(val/1000).toFixed(0)}K` : '?'}
                                 </td>
                              ))}
                           </tr>
                           <tr>
                              <td className="py-1 px-2 font-medium text-green-700">Actual</td>
                              {currentScenario.actuals.map((val, i) => (
                                 <td key={i} className={`text-center py-1 px-2 ${i === 5 && !predictionSubmitted ? 'bg-green-50' : ''}`}>
                                    {i < 5 || predictionSubmitted ? `$${(val/1000).toFixed(0)}K` : '?'}
                                 </td>
                              ))}
                           </tr>
                        </tbody>
                     </table>
                  </div>

                  <div className="mt-3 pt-3 border-t">
                     <div className="flex justify-between text-xs mb-1">
                        <span className="text-gray-600">Budget Total:</span>
                        <span className="font-semibold text-blue-700">${(currentScenario.budget.reduce((a,b) => a+b, 0)/1000).toFixed(0)}K</span>
                     </div>
                     {predictionSubmitted && (
                        <>
                           <div className="flex justify-between text-xs mb-1">
                              <span className="text-gray-600">Forecast Total:</span>
                              <span className="font-semibold text-amber-700">${(currentScenario.forecasts.reduce((a,b) => a+b, 0)/1000).toFixed(0)}K</span>
                           </div>
                           <div className="flex justify-between text-xs">
                              <span className="text-gray-600">Actual Total:</span>
                              <span className="font-semibold text-green-700">${(currentScenario.actuals.reduce((a,b) => a+b, 0)/1000).toFixed(0)}K</span>
                           </div>
                        </>
                     )}
                  </div>
               </div>

               {!predictionSubmitted ? (
                  <div className="bg-white rounded-xl p-4 mb-3 shadow-sm">
                     <p className="text-sm font-medium text-gray-700 mb-3">{currentScenario.question}</p>
                     <div className="flex items-center gap-2 mb-3">
                        <span className="text-gray-500">$</span>
                        <input
                           type="number"
                           value={userPrediction || ''}
                           onChange={(e) => setUserPrediction(Number(e.target.value))}
                           placeholder="Your prediction"
                           className="flex-1 px-3 py-2 border-2 border-violet-200 rounded-lg focus:border-violet-500 focus:outline-none"
                        />
                     </div>
                     <button onClick={handlePrediction} disabled={!userPrediction} className="w-full py-2 bg-violet-500 text-white rounded-lg font-semibold hover:bg-violet-600 disabled:opacity-50">
                        Submit Prediction
                     </button>
                  </div>
               ) : (
                  <div className="bg-violet-50 rounded-xl p-3 mb-3 border border-violet-200">
                     <div className="flex items-center gap-2 mb-2">
                        <span className="text-lg">üí°</span>
                        <span className="font-semibold text-violet-800">Insight:</span>
                     </div>
                     <p className="text-xs text-violet-700">{currentScenario.insight}</p>
                     <div className="mt-2 pt-2 border-t border-violet-200 text-xs">
                        <span className="text-gray-600">Your prediction: </span>
                        <span className="font-semibold">${userPrediction?.toLocaleString()}</span>
                        <span className="text-gray-600"> | Actual: </span>
                        <span className="font-semibold text-green-700">${currentScenario.actuals[5].toLocaleString()}</span>
                     </div>
                  </div>
               )}

               {predictionSubmitted && (
                  <button onClick={nextScenario} className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600">
                     {scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}
                  </button>
               )}

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                     <div className="bg-white rounded-xl p-4 max-w-sm">
                        <h4 className="font-bold text-violet-800 mb-2">{infoContent.title}</h4>
                        <p className="text-sm text-gray-600 mb-3">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="w-full py-2 bg-violet-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizzes.length) {
            const q = quizzes[quizIndex];
            return (
               <div className="h-full flex flex-col p-4 bg-gradient-to-br from-violet-50 to-purple-100">
                  <div className="flex justify-between items-center mb-4">
                     <span className="text-sm text-violet-600">Quiz {quizIndex + 1}/{quizzes.length}</span>
                     <span className="text-sm font-semibold text-violet-800">Score: {score}</span>
                  </div>
                  <div className="flex-1">
                     <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <p className="font-medium text-gray-800 mb-4">{q.question}</p>
                        <div className="space-y-2">
                           {q.options.map((opt, i) => (
                              <button key={i} onClick={() => handleQuizAnswer(i)} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left text-sm transition-all ${quizAnswered ? (i === q.correct ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-50 opacity-60') : 'bg-gray-50 hover:bg-violet-50 border-2 border-transparent hover:border-violet-300'}`}>
                                 {opt}
                              </button>
                           ))}
                        </div>
                     </div>
                     {quizAnswered && (
                        <div className="bg-blue-50 rounded-lg p-3 mb-4">
                           <p className="text-sm text-blue-800">{q.explanation}</p>
                        </div>
                     )}
                  </div>
                  {quizAnswered && (
                     <button onClick={nextQuiz} className="w-full py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600">
                        {quizIndex < quizzes.length - 1 ? 'Next Question ‚Üí' : 'See Final Results ‚Üí'}
                     </button>
                  )}
               </div>
            );
         }

         const maxScore = scenarios.length * 5 + quizzes.length * 2;
         const pct = Math.round((score / maxScore) * 100);

         return (
            <div className="h-full flex flex-col p-6 bg-gradient-to-br from-violet-50 to-purple-100">
               <div className="flex-1 flex flex-col items-center justify-center">
                  <div className="text-5xl mb-4">{pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üìä' : 'üìö'}</div>
                  <h2 className="text-xl font-bold text-violet-800 mb-2">Budget & Forecast Mastery!</h2>
                  <p className="text-3xl font-bold text-violet-600 mb-2">{score}/{maxScore} points</p>
                  <p className="text-violet-700 mb-4">{pct}% Accuracy</p>
                  <div className="w-full max-w-xs h-3 bg-violet-200 rounded-full mb-4">
                     <div className="h-full bg-violet-500 rounded-full transition-all" style={{ width: `${pct}%` }}></div>
                  </div>
                  <div className="bg-white rounded-xl p-4 w-full max-w-md text-sm">
                     <h4 className="font-semibold text-violet-800 mb-2">Key Takeaways:</h4>
                     <ul className="text-gray-600 space-y-1">
                        <li>‚Ä¢ Budget = Fixed plan, sets accountability</li>
                        <li>‚Ä¢ Forecast = Dynamic prediction, adapts to reality</li>
                        <li>‚Ä¢ Compare both to actual for full picture</li>
                        <li>‚Ä¢ Gaps signal need for investigation</li>
                        <li>‚Ä¢ Rolling forecasts provide continuous visibility</li>
                     </ul>
                  </div>
                  <button onClick={() => { setPhase('intro'); setScore(0); setCurrentMonth(0); setUserPrediction(null); setPredictionSubmitted(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full max-w-md mt-4 py-3 bg-violet-500 text-white rounded-xl font-semibold hover:bg-violet-600">Practice Again</button>
               </div>
            </div>
         );
      }
      return null;
   };

   // Topic 23: Variance Analysis - Analyzing Budget vs Actual Differences
   const VarianceAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedVariance, setSelectedVariance] = useState<string | null>(null);
      const [varianceExplained, setVarianceExplained] = useState(false);
      const [rootCauseSelected, setRootCauseSelected] = useState<string | null>(null);

      const tutorialSteps = [
         { title: 'Welcome to Variance Analysis!', content: 'Learn to analyze differences between budgeted and actual performance to identify issues and opportunities.' },
         { title: 'What is Variance?', content: 'Variance = Actual - Budget. Positive variance means you exceeded budget (good for revenue, bad for costs). Negative means you fell short.' },
         { title: 'Favorable vs Unfavorable', content: 'Favorable: Benefits the company (higher revenue OR lower costs). Unfavorable: Hurts the company (lower revenue OR higher costs).' },
         { title: 'Types of Variances', content: 'Price Variance: Difference in cost per unit. Quantity Variance: Difference in volume used. Both help isolate root causes.' },
         { title: 'Price Variance Formula', content: 'Price Variance = (Actual Price - Budget Price) √ó Actual Quantity. Shows impact of price changes on costs.' },
         { title: 'Quantity Variance Formula', content: 'Quantity Variance = (Actual Qty - Budget Qty) √ó Budget Price. Shows impact of usage efficiency.' },
         { title: 'Ready to Analyze!', content: 'You\'ll examine real business scenarios, calculate variances, and identify root causes. Let\'s find those hidden insights!' }
      ];

      const scenarios = [
         {
            title: 'Manufacturing Materials Variance',
            company: 'SteelWorks Industries',
            category: 'Direct Materials',
            budget: { price: 50, quantity: 10000, total: 500000 },
            actual: { price: 55, quantity: 10800, total: 594000 },
            totalVariance: 94000,
            favorability: 'Unfavorable',
            priceVariance: { value: 59400, formula: '($55 - $50) √ó 10,800 = $59,400 U' },
            quantityVariance: { value: 40000, formula: '(10,800 - 10,000) √ó $50 = $40,000 U' },
            rootCauses: [
               { id: 'supplier', text: 'Supplier raised prices due to steel shortage', correct: true },
               { id: 'waste', text: 'Production inefficiency caused excess material waste', correct: true },
               { id: 'demand', text: 'Customer demand decreased unexpectedly', correct: false },
               { id: 'labor', text: 'Labor costs increased', correct: false }
            ],
            insight: 'Both price and quantity variances are unfavorable. The $55/unit actual price vs $50 budget shows supplier cost pressure, while 10,800 vs 10,000 units used indicates production inefficiency or waste.'
         },
         {
            title: 'Sales Revenue Variance',
            company: 'TechGadgets Direct',
            category: 'Revenue',
            budget: { price: 200, quantity: 5000, total: 1000000 },
            actual: { price: 185, quantity: 5800, total: 1073000 },
            totalVariance: 73000,
            favorability: 'Favorable',
            priceVariance: { value: -87000, formula: '($185 - $200) √ó 5,800 = -$87,000 U' },
            quantityVariance: { value: 160000, formula: '(5,800 - 5,000) √ó $200 = $160,000 F' },
            rootCauses: [
               { id: 'promo', text: 'Promotional pricing drove higher volume', correct: true },
               { id: 'competition', text: 'Competitor pricing forced price reduction', correct: true },
               { id: 'quality', text: 'Product quality issues reduced demand', correct: false },
               { id: 'inventory', text: 'Inventory shortage limited sales', correct: false }
            ],
            insight: 'Price decrease hurt revenue by $87K, but volume increase added $160K. Net favorable $73K! The price-volume tradeoff worked - lower prices drove enough additional sales to more than compensate.'
         },
         {
            title: 'Labor Cost Variance',
            company: 'AssemblePro Manufacturing',
            category: 'Direct Labor',
            budget: { price: 25, quantity: 8000, total: 200000 },
            actual: { price: 28, quantity: 7200, total: 201600 },
            totalVariance: 1600,
            favorability: 'Unfavorable',
            priceVariance: { value: 21600, formula: '($28 - $25) √ó 7,200 = $21,600 U' },
            quantityVariance: { value: -20000, formula: '(7,200 - 8,000) √ó $25 = -$20,000 F' },
            rootCauses: [
               { id: 'overtime', text: 'Overtime pay increased average hourly rate', correct: true },
               { id: 'efficiency', text: 'New equipment improved labor efficiency', correct: true },
               { id: 'turnover', text: 'High turnover caused training delays', correct: false },
               { id: 'demand', text: 'Customer demand exceeded forecasts', correct: false }
            ],
            insight: 'Interesting tradeoff: Higher wages ($21.6K unfavorable) but fewer hours needed ($20K favorable). New equipment investment paid off - workers cost more per hour but finished faster!'
         },
         {
            title: 'Overhead Cost Variance',
            company: 'DataCenter Operations',
            category: 'Fixed Overhead',
            budget: { price: 100, quantity: 1000, total: 100000 },
            actual: { price: 100, quantity: 1200, total: 120000 },
            totalVariance: 20000,
            favorability: 'Unfavorable',
            priceVariance: { value: 0, formula: '($100 - $100) √ó 1,200 = $0' },
            quantityVariance: { value: 20000, formula: '(1,200 - 1,000) √ó $100 = $20,000 U' },
            rootCauses: [
               { id: 'expansion', text: 'Business growth required additional capacity', correct: true },
               { id: 'inefficiency', text: 'Energy inefficiency in older equipment', correct: true },
               { id: 'pricing', text: 'Utility company reduced rates', correct: false },
               { id: 'automation', text: 'Automation reduced overhead needs', correct: false }
            ],
            insight: 'Price per unit stayed on budget, but volume increased 20%. This could be growth (good) or inefficiency (bad). The root cause determines whether this variance signals success or a problem to fix.'
         }
      ];

      const quizQuestions = [
         { q: 'Revenue came in at $90K vs budget of $100K. This variance is:', options: ['Favorable', 'Unfavorable', 'Neutral', 'Cannot determine'], correct: 1 },
         { q: 'Cost of materials was $45K vs budget of $50K. This variance is:', options: ['Favorable', 'Unfavorable', 'Neutral', 'Cannot determine'], correct: 0 },
         { q: 'Price Variance isolates the impact of:', options: ['Volume changes', 'Cost per unit changes', 'Both price and volume', 'Fixed cost changes'], correct: 1 },
         { q: 'If Actual Qty > Budget Qty for a cost item, the quantity variance is:', options: ['Always favorable', 'Always unfavorable', 'Depends on the price', 'Cannot calculate'], correct: 1 },
         { q: 'Total Variance = Price Variance + Quantity Variance. True or False?', options: ['True (always)', 'True (approximately)', 'False', 'Only for revenue'], correct: 1 },
         { q: 'A flexible budget adjusts for:', options: ['Inflation only', 'Actual activity levels', 'Management preferences', 'Prior year results'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleRootCauseSelect = (causeId: string) => {
         setRootCauseSelected(causeId);
         const scenario = scenarios[scenarioIndex];
         const cause = scenario.rootCauses.find(c => c.id === causeId);
         if (cause?.correct) {
            setScore(s => s + 15);
            setGameLog(prev => [...prev, `Correct root cause identified for ${scenario.company}!`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect root cause - review the variance patterns.`]);
         }
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedVariance(null);
            setVarianceExplained(false);
            setRootCauseSelected(null);
         } else {
            setPhase('result');
         }
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-red-800 mb-4 flex items-center gap-2">
                  üìä Variance Analysis Detective
                  <button onClick={() => openInfo('What is Variance Analysis?', 'Variance analysis compares planned (budgeted) results to actual results to understand performance and identify areas needing attention. It answers: Did we hit our targets? If not, why?')} className="text-red-500 hover:text-red-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Master the art of analyzing budget vs. actual differences!</p>
                  <div className="grid grid-cols-2 gap-4 mb-4">
                     <div className="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                        <div className="font-semibold text-green-800">Favorable ‚úì</div>
                        <div className="text-sm text-green-600">Benefits the company</div>
                     </div>
                     <div className="bg-red-50 p-3 rounded-lg border-l-4 border-red-500">
                        <div className="font-semibold text-red-800">Unfavorable ‚úó</div>
                        <div className="text-sm text-red-600">Hurts the company</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> Price variance, Quantity variance, Root cause analysis, Management decision-making
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-red-800">Tutorial</h2>
                  <span className="text-sm text-red-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 1 && (
                     <div className="mt-4 p-4 bg-gray-100 rounded-lg">
                        <div className="font-mono text-center text-lg">
                           <span className="text-blue-600">Variance</span> = <span className="text-green-600">Actual</span> - <span className="text-purple-600">Budget</span>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 4 && (
                     <div className="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <div className="font-mono text-sm">
                           <div className="text-amber-800 font-bold mb-2">Price Variance:</div>
                           <div>(Actual Price - Budget Price) √ó Actual Qty</div>
                           <div className="text-xs text-gray-500 mt-1">Example: ($55 - $50) √ó 1,000 = $5,000 U</div>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 5 && (
                     <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="font-mono text-sm">
                           <div className="text-blue-800 font-bold mb-2">Quantity Variance:</div>
                           <div>(Actual Qty - Budget Qty) √ó Budget Price</div>
                           <div className="text-xs text-gray-500 mt-1">Example: (1,100 - 1,000) √ó $50 = $5,000 U</div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-red-500 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Analysis!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         return (
            <div className="p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-red-800">{scenario.company}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-red-100 px-3 py-1 rounded-full text-red-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Case {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <h3 className="font-bold text-gray-800">{scenario.title}</h3>
                     <span className={`px-2 py-1 rounded text-xs font-medium ${scenario.favorability === 'Favorable' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                        {scenario.favorability}
                     </span>
                  </div>

                  {/* Budget vs Actual Table */}
                  <div className="overflow-x-auto mb-4">
                     <table className="w-full text-sm">
                        <thead>
                           <tr className="bg-gray-100">
                              <th className="p-2 text-left">{scenario.category}</th>
                              <th className="p-2 text-right">Budget</th>
                              <th className="p-2 text-right">Actual</th>
                              <th className="p-2 text-right">Variance</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr>
                              <td className="p-2">Price/Unit</td>
                              <td className="p-2 text-right">${scenario.budget.price}</td>
                              <td className="p-2 text-right">${scenario.actual.price}</td>
                              <td className={`p-2 text-right ${scenario.actual.price > scenario.budget.price ? (scenario.category === 'Revenue' ? 'text-green-600' : 'text-red-600') : (scenario.category === 'Revenue' ? 'text-red-600' : 'text-green-600')}`}>
                                 ${Math.abs(scenario.actual.price - scenario.budget.price)}
                              </td>
                           </tr>
                           <tr className="bg-gray-50">
                              <td className="p-2">Quantity</td>
                              <td className="p-2 text-right">{scenario.budget.quantity.toLocaleString()}</td>
                              <td className="p-2 text-right">{scenario.actual.quantity.toLocaleString()}</td>
                              <td className={`p-2 text-right ${scenario.actual.quantity > scenario.budget.quantity ? (scenario.category === 'Revenue' ? 'text-green-600' : 'text-red-600') : (scenario.category === 'Revenue' ? 'text-red-600' : 'text-green-600')}`}>
                                 {Math.abs(scenario.actual.quantity - scenario.budget.quantity).toLocaleString()}
                              </td>
                           </tr>
                           <tr className="font-bold border-t-2">
                              <td className="p-2">Total</td>
                              <td className="p-2 text-right">${scenario.budget.total.toLocaleString()}</td>
                              <td className="p-2 text-right">${scenario.actual.total.toLocaleString()}</td>
                              <td className={`p-2 text-right ${scenario.favorability === 'Favorable' ? 'text-green-600' : 'text-red-600'}`}>
                                 ${scenario.totalVariance.toLocaleString()} {scenario.favorability === 'Favorable' ? 'F' : 'U'}
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>

                  {/* Variance Breakdown */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <button
                        onClick={() => { setSelectedVariance('price'); setScore(s => s + 5); }}
                        className={`p-3 rounded-lg border-2 text-left transition-all ${selectedVariance === 'price' ? 'border-amber-500 bg-amber-50' : 'border-gray-200 hover:border-amber-300'}`}
                     >
                        <div className="font-semibold text-amber-800">Price Variance</div>
                        <div className="text-sm text-gray-600 font-mono">{scenario.priceVariance.formula}</div>
                     </button>
                     <button
                        onClick={() => { setSelectedVariance('quantity'); setScore(s => s + 5); }}
                        className={`p-3 rounded-lg border-2 text-left transition-all ${selectedVariance === 'quantity' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}`}
                     >
                        <div className="font-semibold text-blue-800">Quantity Variance</div>
                        <div className="text-sm text-gray-600 font-mono">{scenario.quantityVariance.formula}</div>
                     </button>
                  </div>

                  {/* Insight Display */}
                  {selectedVariance && !varianceExplained && (
                     <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
                        <div className="font-semibold text-amber-800 mb-2">üí° Analysis Insight</div>
                        <p className="text-sm text-gray-700">{scenario.insight}</p>
                        <button onClick={() => setVarianceExplained(true)} className="mt-2 text-amber-600 text-sm hover:underline">Continue to Root Cause ‚Üí</button>
                     </div>
                  )}

                  {/* Root Cause Selection */}
                  {varianceExplained && !rootCauseSelected && (
                     <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div className="font-semibold text-purple-800 mb-3">üîç Identify Root Causes</div>
                        <p className="text-sm text-gray-600 mb-3">Select the most likely root cause(s) for this variance:</p>
                        <div className="grid gap-2">
                           {scenario.rootCauses.map(cause => (
                              <button
                                 key={cause.id}
                                 onClick={() => handleRootCauseSelect(cause.id)}
                                 className="p-3 bg-white rounded-lg border border-purple-200 text-left hover:border-purple-400 hover:bg-purple-50 transition-all"
                              >
                                 {cause.text}
                              </button>
                           ))}
                        </div>
                     </div>
                  )}

                  {/* Root Cause Result */}
                  {rootCauseSelected && (
                     <div className={`p-4 rounded-lg border ${scenario.rootCauses.find(c => c.id === rootCauseSelected)?.correct ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}`}>
                        <div className="font-semibold mb-2">
                           {scenario.rootCauses.find(c => c.id === rootCauseSelected)?.correct ? '‚úÖ Correct!' : '‚ùå Not quite'}
                        </div>
                        <p className="text-sm text-gray-700">
                           <strong>Valid causes:</strong> {scenario.rootCauses.filter(c => c.correct).map(c => c.text).join('; ')}
                        </p>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                           {scenarioIndex < scenarios.length - 1 ? 'Next Case ‚Üí' : 'Complete Analysis'}
                        </button>
                     </div>
                  )}
               </div>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 25) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-red-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-red-800 mb-4">üéâ Analysis Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-red-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Variance Master!' : percentage >= 70 ? 'üìä Strong Analyst' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Learning'}
                     </div>
                  </div>
                  <div className="bg-red-50 p-4 rounded-lg">
                     <h3 className="font-bold text-red-800 mb-2">Key Takeaways:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Break total variance into Price and Quantity components</li>
                        <li>‚Ä¢ Favorable for revenue = higher than budget</li>
                        <li>‚Ä¢ Favorable for costs = lower than budget</li>
                        <li>‚Ä¢ Always investigate root causes before acting</li>
                        <li>‚Ä¢ Variance analysis drives continuous improvement</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedVariance(null); setVarianceExplained(false); setRootCauseSelected(null); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 24: Zero-Based Budgeting - Building Budgets from Scratch
   const ZeroBasedBudgetRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [allocations, setAllocations] = useState<Record<string, number>>({});
      const [justifications, setJustifications] = useState<Record<string, string>>({});
      const [submitted, setSubmitted] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to Zero-Based Budgeting!', content: 'Learn to build budgets from scratch, justifying every dollar spent rather than just adjusting last year\'s numbers.' },
         { title: 'Traditional vs ZBB', content: 'Traditional: Start with last year + inflation. ZBB: Start at $0, justify every expense. ZBB forces critical thinking about resource allocation.' },
         { title: 'The ZBB Process', content: 'Step 1: Define decision units (departments). Step 2: Create decision packages (activities). Step 3: Rank priorities. Step 4: Allocate resources.' },
         { title: 'Decision Packages', content: 'Each activity is packaged with: Cost, Benefits, Consequences of not funding, Alternative levels of service (minimum, current, enhanced).' },
         { title: 'Priority Ranking', content: 'All packages are ranked across the organization. High-impact, essential items get funded first. Forces trade-offs between competing needs.' },
         { title: 'Benefits of ZBB', content: 'Eliminates wasteful spending, aligns resources with strategy, increases transparency, encourages innovation in cost reduction.' },
         { title: 'Ready to Budget!', content: 'You\'ll allocate budgets for departments by justifying each expense from zero. Let\'s eliminate waste and fund what matters!' }
      ];

      const scenarios = [
         {
            title: 'Tech Startup Budget Allocation',
            company: 'InnovateTech Inc.',
            totalBudget: 1000000,
            departments: [
               { id: 'engineering', name: 'Engineering', lastYear: 400000, essential: 300000, description: 'Product development, infrastructure', priority: 1 },
               { id: 'sales', name: 'Sales & Marketing', lastYear: 300000, essential: 150000, description: 'Customer acquisition, brand awareness', priority: 2 },
               { id: 'operations', name: 'Operations', lastYear: 150000, essential: 100000, description: 'Office, admin, legal, HR', priority: 3 },
               { id: 'rnd', name: 'R&D Innovation', lastYear: 100000, essential: 50000, description: 'Future product exploration', priority: 4 },
               { id: 'training', name: 'Training & Development', lastYear: 50000, essential: 20000, description: 'Employee skills, certifications', priority: 5 }
            ],
            justificationOptions: [
               { id: 'growth', text: 'Critical for growth targets', weight: 3 },
               { id: 'retention', text: 'Required for customer retention', weight: 2 },
               { id: 'compliance', text: 'Regulatory/legal requirement', weight: 3 },
               { id: 'efficiency', text: 'Improves operational efficiency', weight: 2 },
               { id: 'nice', text: 'Nice to have, not essential', weight: 0 }
            ]
         },
         {
            title: 'Non-Profit Organization Budget',
            company: 'Community Helpers Foundation',
            totalBudget: 500000,
            departments: [
               { id: 'programs', name: 'Program Services', lastYear: 250000, essential: 200000, description: 'Direct community services', priority: 1 },
               { id: 'fundraising', name: 'Fundraising', lastYear: 100000, essential: 60000, description: 'Donor relations, events, grants', priority: 2 },
               { id: 'admin', name: 'Administration', lastYear: 80000, essential: 50000, description: 'Executive, finance, HR', priority: 3 },
               { id: 'outreach', name: 'Community Outreach', lastYear: 50000, essential: 30000, description: 'Awareness, volunteer coordination', priority: 4 },
               { id: 'tech', name: 'Technology', lastYear: 20000, essential: 15000, description: 'Systems, website, databases', priority: 5 }
            ],
            justificationOptions: [
               { id: 'mission', text: 'Directly supports mission', weight: 3 },
               { id: 'revenue', text: 'Generates future donations', weight: 2 },
               { id: 'required', text: 'Legally required', weight: 3 },
               { id: 'efficiency', text: 'Reduces operational costs', weight: 2 },
               { id: 'optional', text: 'Optional enhancement', weight: 0 }
            ]
         },
         {
            title: 'Manufacturing Cost Center',
            company: 'PrecisionParts Manufacturing',
            totalBudget: 2000000,
            departments: [
               { id: 'production', name: 'Production', lastYear: 1000000, essential: 800000, description: 'Direct manufacturing costs', priority: 1 },
               { id: 'quality', name: 'Quality Control', lastYear: 300000, essential: 200000, description: 'Inspection, testing, compliance', priority: 2 },
               { id: 'maintenance', name: 'Maintenance', lastYear: 250000, essential: 180000, description: 'Equipment upkeep, preventive maintenance', priority: 3 },
               { id: 'logistics', name: 'Logistics', lastYear: 300000, essential: 200000, description: 'Warehousing, shipping, receiving', priority: 4 },
               { id: 'safety', name: 'Safety & Environment', lastYear: 150000, essential: 100000, description: 'OSHA compliance, environmental', priority: 5 }
            ],
            justificationOptions: [
               { id: 'production', text: 'Required for production output', weight: 3 },
               { id: 'quality', text: 'Ensures product quality', weight: 2 },
               { id: 'safety', text: 'Safety/regulatory requirement', weight: 3 },
               { id: 'cost', text: 'Reduces long-term costs', weight: 2 },
               { id: 'optional', text: 'Performance enhancement', weight: 0 }
            ]
         }
      ];

      const quizQuestions = [
         { q: 'Zero-Based Budgeting requires you to:', options: ['Start from last year\'s budget', 'Justify every expense from zero', 'Only cut costs', 'Increase all budgets equally'], correct: 1 },
         { q: 'A "decision package" in ZBB includes:', options: ['Only the cost amount', 'Cost, benefits, and alternatives', 'Historical spending data', 'Executive preferences'], correct: 1 },
         { q: 'The main advantage of ZBB over traditional budgeting is:', options: ['It\'s faster to prepare', 'It eliminates wasteful spending', 'It requires less documentation', 'It always reduces total costs'], correct: 1 },
         { q: 'In ZBB, priorities are ranked by:', options: ['Department seniority', 'Last year\'s allocation', 'Strategic value and necessity', 'Alphabetical order'], correct: 2 },
         { q: 'ZBB is most useful when:', options: ['Budgets are unlimited', 'Resources are scarce and trade-offs needed', 'All costs are fixed', 'No changes are expected'], correct: 1 },
         { q: 'A challenge of ZBB is:', options: ['Too simple to implement', 'Time-consuming justification process', 'Ignores strategic priorities', 'Cannot handle variable costs'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleAllocation = (deptId: string, amount: number) => {
         setAllocations(prev => ({ ...prev, [deptId]: amount }));
      };

      const handleJustification = (deptId: string, justId: string) => {
         setJustifications(prev => ({ ...prev, [deptId]: justId }));
      };

      const calculateScore = () => {
         const scenario = scenarios[scenarioIndex];
         let points = 0;

         scenario.departments.forEach(dept => {
            const allocation = allocations[dept.id] || 0;
            const justification = justifications[dept.id];
            const justWeight = scenario.justificationOptions.find(j => j.id === justification)?.weight || 0;

            // Points for meeting essential minimum
            if (allocation >= dept.essential) points += 10;
            // Points for strong justification
            points += justWeight * 5;
            // Points for not over-allocating low priority items
            if (dept.priority >= 4 && allocation <= dept.essential * 1.2) points += 5;
         });

         return points;
      };

      const handleSubmit = () => {
         const earnedPoints = calculateScore();
         setScore(s => s + earnedPoints);
         setSubmitted(true);
         setGameLog(prev => [...prev, `${scenarios[scenarioIndex].company}: Earned ${earnedPoints} points`]);
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setAllocations({});
            setJustifications({});
            setSubmitted(false);
         } else {
            setPhase('result');
         }
      };

      const getTotalAllocated = () => {
         return Object.values(allocations).reduce((sum, val) => sum + val, 0);
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-emerald-800 mb-4 flex items-center gap-2">
                  üéØ Zero-Based Budgeting
                  <button onClick={() => openInfo('What is ZBB?', 'Zero-Based Budgeting (ZBB) requires managers to justify all expenses from scratch for each new period, rather than simply adjusting the previous year\'s budget. Every dollar must be justified.')} className="text-emerald-500 hover:text-emerald-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Start from zero. Justify every expense. Allocate strategically.</p>
                  <div className="grid grid-cols-2 gap-4 mb-4">
                     <div className="bg-gray-100 p-3 rounded-lg">
                        <div className="font-semibold text-gray-700">Traditional Budget</div>
                        <div className="text-sm text-gray-500">Last Year + Adjustments</div>
                        <div className="text-xs text-red-500 mt-1">‚ùå Perpetuates waste</div>
                     </div>
                     <div className="bg-emerald-100 p-3 rounded-lg">
                        <div className="font-semibold text-emerald-700">Zero-Based Budget</div>
                        <div className="text-sm text-emerald-600">$0 Base + Justifications</div>
                        <div className="text-xs text-emerald-500 mt-1">‚úÖ Every $ justified</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> Decision packages, Priority ranking, Resource allocation, Strategic trade-offs
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-emerald-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-emerald-800">Tutorial</h2>
                  <span className="text-sm text-emerald-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 1 && (
                     <div className="mt-4 grid grid-cols-2 gap-4">
                        <div className="p-3 bg-gray-100 rounded-lg text-center">
                           <div className="text-2xl mb-1">üìä</div>
                           <div className="font-semibold text-gray-700">Traditional</div>
                           <div className="text-xs text-gray-500">$100K ‚Üí $103K (+3%)</div>
                        </div>
                        <div className="p-3 bg-emerald-100 rounded-lg text-center">
                           <div className="text-2xl mb-1">üéØ</div>
                           <div className="font-semibold text-emerald-700">ZBB</div>
                           <div className="text-xs text-emerald-600">$0 ‚Üí Justified Amount</div>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 3 && (
                     <div className="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <div className="text-sm font-semibold text-amber-800 mb-2">Decision Package Example:</div>
                        <ul className="text-sm text-gray-600 space-y-1">
                           <li>üì¶ <strong>Activity:</strong> Customer Support Team</li>
                           <li>üí∞ <strong>Cost:</strong> $150,000/year</li>
                           <li>‚úÖ <strong>Benefit:</strong> 95% satisfaction rate</li>
                           <li>‚ö†Ô∏è <strong>If not funded:</strong> Customer churn +20%</li>
                        </ul>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-emerald-500 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Budgeting!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         const totalAllocated = getTotalAllocated();
         const remaining = scenario.totalBudget - totalAllocated;

         return (
            <div className="p-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-emerald-800">{scenario.company}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-emerald-100 px-3 py-1 rounded-full text-emerald-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Org {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               {/* Budget Summary Bar */}
               <div className="bg-white/90 p-4 rounded-xl mb-4">
                  <div className="flex justify-between text-sm mb-2">
                     <span>Total Budget: ${scenario.totalBudget.toLocaleString()}</span>
                     <span className={remaining < 0 ? 'text-red-600 font-bold' : 'text-emerald-600'}>
                        Remaining: ${remaining.toLocaleString()}
                     </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                     <div
                        className={`h-3 rounded-full transition-all ${remaining < 0 ? 'bg-red-500' : 'bg-emerald-500'}`}
                        style={{ width: `${Math.min((totalAllocated / scenario.totalBudget) * 100, 100)}%` }}
                     ></div>
                  </div>
               </div>

               {/* Department Allocations */}
               <div className="space-y-3 mb-4">
                  {scenario.departments.map((dept, idx) => (
                     <div key={dept.id} className={`bg-white/90 p-4 rounded-xl border-2 ${submitted ? 'border-gray-200' : 'border-emerald-200'}`}>
                        <div className="flex justify-between items-start mb-2">
                           <div>
                              <div className="flex items-center gap-2">
                                 <span className="bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5 rounded">P{dept.priority}</span>
                                 <span className="font-semibold text-gray-800">{dept.name}</span>
                              </div>
                              <div className="text-xs text-gray-500">{dept.description}</div>
                           </div>
                           <div className="text-right text-xs">
                              <div className="text-gray-400">Last Year: ${dept.lastYear.toLocaleString()}</div>
                              <div className="text-emerald-600">Essential: ${dept.essential.toLocaleString()}</div>
                           </div>
                        </div>

                        {!submitted ? (
                           <>
                              <div className="flex items-center gap-2 mb-2">
                                 <span className="text-sm text-gray-600">Allocate: $</span>
                                 <input
                                    type="number"
                                    value={allocations[dept.id] || ''}
                                    onChange={(e) => handleAllocation(dept.id, Number(e.target.value))}
                                    className="flex-1 p-2 border rounded-lg text-right"
                                    placeholder="0"
                                    step="10000"
                                 />
                              </div>
                              <div className="flex flex-wrap gap-1">
                                 {scenario.justificationOptions.map(just => (
                                    <button
                                       key={just.id}
                                       onClick={() => handleJustification(dept.id, just.id)}
                                       className={`text-xs px-2 py-1 rounded-full transition-all ${justifications[dept.id] === just.id ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                    >
                                       {just.text}
                                    </button>
                                 ))}
                              </div>
                           </>
                        ) : (
                           <div className="flex justify-between items-center">
                              <span className="text-emerald-700 font-semibold">${(allocations[dept.id] || 0).toLocaleString()}</span>
                              <span className={`text-xs px-2 py-1 rounded ${(allocations[dept.id] || 0) >= dept.essential ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                 {(allocations[dept.id] || 0) >= dept.essential ? '‚úì Essential met' : '‚úó Below essential'}
                              </span>
                           </div>
                        )}
                     </div>
                  ))}
               </div>

               {!submitted ? (
                  <button
                     onClick={handleSubmit}
                     disabled={remaining < 0}
                     className={`w-full py-3 rounded-xl font-semibold transition-all ${remaining < 0 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600'}`}
                  >
                     {remaining < 0 ? 'Over Budget!' : 'Submit Budget Allocation'}
                  </button>
               ) : (
                  <button onClick={nextScenario} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                     {scenarioIndex < scenarios.length - 1 ? 'Next Organization ‚Üí' : 'Complete ZBB Challenge'}
                  </button>
               )}

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-emerald-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 75) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-emerald-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-emerald-800 mb-4">üéâ ZBB Challenge Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-emerald-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Budget Master!' : percentage >= 70 ? 'üìä Strategic Allocator' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Practicing'}
                     </div>
                  </div>
                  <div className="bg-emerald-50 p-4 rounded-lg">
                     <h3 className="font-bold text-emerald-800 mb-2">ZBB Best Practices:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Start every budget cycle at zero</li>
                        <li>‚Ä¢ Require justification for every expense</li>
                        <li>‚Ä¢ Create decision packages with alternatives</li>
                        <li>‚Ä¢ Rank all activities by strategic value</li>
                        <li>‚Ä¢ Force trade-offs rather than across-the-board cuts</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setAllocations({}); setJustifications({}); setSubmitted(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-emerald-500 text-white rounded-xl font-semibold hover:bg-emerald-600">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 25: CapEx vs OpEx - Understanding Capital vs Operating Expenses
   const CapExOpExRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedClassification, setSelectedClassification] = useState<'capex' | 'opex' | null>(null);
      const [answered, setAnswered] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to CapEx vs OpEx!', content: 'Learn to classify business expenses correctly - a critical skill for financial reporting, tax planning, and investment analysis.' },
         { title: 'What is CapEx?', content: 'Capital Expenditure (CapEx): Long-term investments in assets. Appears on Balance Sheet, then depreciated over useful life. Examples: buildings, equipment, vehicles.' },
         { title: 'What is OpEx?', content: 'Operating Expense (OpEx): Day-to-day costs of running the business. Fully expensed in the current period on Income Statement. Examples: rent, utilities, salaries.' },
         { title: 'The Key Difference', content: 'CapEx: Benefit extends beyond 1 year ‚Üí Capitalize & Depreciate. OpEx: Benefit consumed in current period ‚Üí Expense immediately.' },
         { title: 'Impact on Financials', content: 'CapEx: Lower initial expense, higher assets, spreads cost over years. OpEx: Full expense hit now, no asset recorded, immediate tax deduction.' },
         { title: 'The Capitalization Threshold', content: 'Companies set thresholds (e.g., $5,000). Items below = OpEx regardless of life. Items above + lasting benefit = CapEx.' },
         { title: 'Ready to Classify!', content: 'You\'ll analyze real business purchases and classify them correctly. Consider useful life, benefit period, and company policy!' }
      ];

      const scenarios = [
         { item: 'New Manufacturing Equipment', cost: 250000, life: '10 years', description: 'CNC machine for production line expansion', correct: 'capex', reason: 'Long useful life, major asset, will be depreciated over 10 years' },
         { item: 'Office Supplies', cost: 500, life: 'Immediate', description: 'Printer paper, pens, staplers for the month', correct: 'opex', reason: 'Low cost, consumed immediately, no lasting benefit beyond current period' },
         { item: 'Software License (Annual)', cost: 12000, life: '1 year', description: 'Annual SaaS subscription for CRM system', correct: 'opex', reason: 'Subscription = no asset ownership, expense as incurred over the year' },
         { item: 'Building Renovation', cost: 500000, life: '15 years', description: 'Major HVAC system replacement', correct: 'capex', reason: 'Extends building useful life, significant cost, capitalize and depreciate' },
         { item: 'Employee Training', cost: 25000, life: 'Ongoing', description: 'Sales team certification program', correct: 'opex', reason: 'While valuable, no tangible asset created - expense in current period' },
         { item: 'Delivery Vehicle', cost: 45000, life: '5 years', description: 'New truck for distribution fleet', correct: 'capex', reason: 'Depreciable asset with multi-year useful life' },
         { item: 'Website Redesign', cost: 75000, life: '3 years', description: 'Complete overhaul of company website', correct: 'capex', reason: 'Significant cost, creates lasting digital asset, amortize over useful life' },
         { item: 'Monthly Cloud Hosting', cost: 2000, life: '1 month', description: 'AWS infrastructure costs for the month', correct: 'opex', reason: 'Pay-as-you-go service, no asset, expense when incurred' },
         { item: 'Office Furniture', cost: 3500, life: '7 years', description: 'New desk and chair set', correct: 'opex', reason: 'Below typical $5,000 capitalization threshold, expense immediately' },
         { item: 'Patent Application', cost: 50000, life: '20 years', description: 'Legal fees for new patent filing', correct: 'capex', reason: 'Creates intangible asset (IP), amortize over patent life' }
      ];

      const quizQuestions = [
         { q: 'CapEx appears on which financial statement initially?', options: ['Income Statement', 'Balance Sheet', 'Cash Flow only', 'None'], correct: 1 },
         { q: 'OpEx is fully recognized in:', options: ['The asset\'s useful life', 'The current period', 'Over 5 years', 'When sold'], correct: 1 },
         { q: 'A $3,000 laptop with 4-year life is typically:', options: ['Always CapEx', 'Always OpEx', 'Depends on capitalization threshold', 'Ignored'], correct: 2 },
         { q: 'SaaS subscriptions are usually classified as:', options: ['CapEx', 'OpEx', 'Both', 'Neither'], correct: 1 },
         { q: 'Which provides immediate tax benefit?', options: ['CapEx', 'OpEx', 'Both equally', 'Neither'], correct: 1 },
         { q: 'Depreciation is associated with:', options: ['OpEx items', 'CapEx items', 'Both', 'Revenue only'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleClassification = (classification: 'capex' | 'opex') => {
         if (answered) return;
         setSelectedClassification(classification);
         setAnswered(true);
         const scenario = scenarios[scenarioIndex];
         if (classification === scenario.correct) {
            setScore(s => s + 10);
            setGameLog(prev => [...prev, `Correct: ${scenario.item} is ${classification.toUpperCase()}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect: ${scenario.item} should be ${scenario.correct.toUpperCase()}`]);
         }
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedClassification(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-cyan-50 to-sky-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-cyan-800 mb-4 flex items-center gap-2">
                  üí∞ CapEx vs OpEx Classifier
                  <button onClick={() => openInfo('Why does it matter?', 'Misclassifying expenses can distort financial statements, affect tax liability, mislead investors, and even trigger audit findings. Getting it right is critical!')} className="text-cyan-500 hover:text-cyan-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Master the art of classifying business expenses!</p>
                  <div className="grid grid-cols-2 gap-4 mb-4">
                     <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div className="font-bold text-blue-800">CapEx</div>
                        <div className="text-sm text-blue-600">Capital Expenditure</div>
                        <div className="text-xs text-gray-500 mt-2">‚Üí Balance Sheet</div>
                        <div className="text-xs text-gray-500">‚Üí Depreciated over time</div>
                     </div>
                     <div className="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
                        <div className="font-bold text-orange-800">OpEx</div>
                        <div className="text-sm text-orange-600">Operating Expense</div>
                        <div className="text-xs text-gray-500 mt-2">‚Üí Income Statement</div>
                        <div className="text-xs text-gray-500">‚Üí Expensed immediately</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> Classification rules, Capitalization thresholds, Financial impact, Tax implications
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-cyan-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-cyan-50 to-sky-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-cyan-800">Tutorial</h2>
                  <span className="text-sm text-cyan-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 1 && (
                     <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="font-semibold text-blue-800 mb-2">CapEx Examples:</div>
                        <div className="grid grid-cols-3 gap-2 text-xs text-blue-700">
                           <span>üè≠ Machinery</span>
                           <span>üè¢ Buildings</span>
                           <span>üöö Vehicles</span>
                           <span>üíª Major IT systems</span>
                           <span>üîß Equipment</span>
                           <span>üìú Patents</span>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 2 && (
                     <div className="mt-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div className="font-semibold text-orange-800 mb-2">OpEx Examples:</div>
                        <div className="grid grid-cols-3 gap-2 text-xs text-orange-700">
                           <span>üè† Rent</span>
                           <span>üí° Utilities</span>
                           <span>üë• Salaries</span>
                           <span>üìã Insurance</span>
                           <span>üîß Repairs</span>
                           <span>üìä Subscriptions</span>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 4 && (
                     <div className="mt-4 grid grid-cols-2 gap-4">
                        <div className="p-3 bg-blue-50 rounded-lg text-center">
                           <div className="text-2xl mb-1">üìä</div>
                           <div className="font-semibold text-blue-700 text-sm">CapEx: $100K machine</div>
                           <div className="text-xs text-gray-500">Year 1: $10K expense</div>
                           <div className="text-xs text-gray-500">(depreciation)</div>
                        </div>
                        <div className="p-3 bg-orange-50 rounded-lg text-center">
                           <div className="text-2xl mb-1">üí∏</div>
                           <div className="font-semibold text-orange-700 text-sm">OpEx: $100K rent</div>
                           <div className="text-xs text-gray-500">Year 1: $100K expense</div>
                           <div className="text-xs text-gray-500">(full deduction)</div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-cyan-500 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Classifying!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         return (
            <div className="p-6 bg-gradient-to-br from-cyan-50 to-sky-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-cyan-800">Classify the Expense</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-cyan-100 px-3 py-1 rounded-full text-cyan-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Item {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <div className="text-center mb-4">
                     <h3 className="text-xl font-bold text-gray-800">{scenario.item}</h3>
                     <p className="text-gray-600 text-sm mt-1">{scenario.description}</p>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                     <div className="bg-gray-50 p-3 rounded-lg text-center">
                        <div className="text-xs text-gray-500">Cost</div>
                        <div className="font-bold text-lg text-gray-800">${scenario.cost.toLocaleString()}</div>
                     </div>
                     <div className="bg-gray-50 p-3 rounded-lg text-center">
                        <div className="text-xs text-gray-500">Useful Life</div>
                        <div className="font-bold text-lg text-gray-800">{scenario.life}</div>
                     </div>
                  </div>

                  {!answered ? (
                     <div className="grid grid-cols-2 gap-4">
                        <button
                           onClick={() => handleClassification('capex')}
                           className="p-4 bg-blue-50 border-2 border-blue-200 rounded-xl hover:border-blue-500 hover:bg-blue-100 transition-all"
                        >
                           <div className="text-2xl mb-1">üìä</div>
                           <div className="font-bold text-blue-800">CapEx</div>
                           <div className="text-xs text-blue-600">Capitalize & Depreciate</div>
                        </button>
                        <button
                           onClick={() => handleClassification('opex')}
                           className="p-4 bg-orange-50 border-2 border-orange-200 rounded-xl hover:border-orange-500 hover:bg-orange-100 transition-all"
                        >
                           <div className="text-2xl mb-1">üí∏</div>
                           <div className="font-bold text-orange-800">OpEx</div>
                           <div className="text-xs text-orange-600">Expense Immediately</div>
                        </button>
                     </div>
                  ) : (
                     <div className={`p-4 rounded-xl ${selectedClassification === scenario.correct ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}`}>
                        <div className="font-bold mb-2">
                           {selectedClassification === scenario.correct ? '‚úÖ Correct!' : '‚ùå Incorrect'}
                        </div>
                        <div className="text-sm text-gray-700">
                           <strong>Answer:</strong> {scenario.correct.toUpperCase()}
                        </div>
                        <div className="text-sm text-gray-600 mt-1">
                           <strong>Why:</strong> {scenario.reason}
                        </div>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">
                           {scenarioIndex < scenarios.length - 1 ? 'Next Item ‚Üí' : 'Complete Challenge'}
                        </button>
                     </div>
                  )}
               </div>

               {/* Decision Helper */}
               <div className="bg-white/60 p-3 rounded-lg">
                  <div className="text-xs font-semibold text-gray-600 mb-2">üí° Decision Checklist:</div>
                  <div className="grid grid-cols-2 gap-2 text-xs">
                     <div className="text-blue-700">CapEx if: Life {'>'} 1 year, Major cost, Creates asset</div>
                     <div className="text-orange-700">OpEx if: Consumed now, Below threshold, No lasting asset</div>
                  </div>
               </div>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-cyan-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 10) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-cyan-50 to-sky-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-cyan-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-cyan-50 to-sky-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-cyan-800 mb-4">üéâ Classification Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-cyan-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Classification Expert!' : percentage >= 70 ? 'üìä Strong Understanding' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Practicing'}
                     </div>
                  </div>
                  <div className="bg-cyan-50 p-4 rounded-lg">
                     <h3 className="font-bold text-cyan-800 mb-2">Key Takeaways:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ CapEx: Long-term assets, capitalize, depreciate over life</li>
                        <li>‚Ä¢ OpEx: Current period costs, expense immediately</li>
                        <li>‚Ä¢ Check capitalization threshold (often $5,000)</li>
                        <li>‚Ä¢ Subscriptions/rentals are typically OpEx</li>
                        <li>‚Ä¢ Classification affects both financials and taxes</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedClassification(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-cyan-500 text-white rounded-xl font-semibold hover:bg-cyan-600">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 26: Fixed vs Variable Costs - Understanding Cost Behavior
   const FixedVariableCostsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedType, setSelectedType] = useState<'fixed' | 'variable' | 'mixed' | null>(null);
      const [answered, setAnswered] = useState(false);
      const [productionLevel, setProductionLevel] = useState(1000);

      const tutorialSteps = [
         { title: 'Welcome to Cost Behavior!', content: 'Understanding how costs change with activity levels is fundamental to pricing, budgeting, and profitability analysis.' },
         { title: 'Fixed Costs', content: 'Fixed costs stay the same regardless of production volume. Examples: rent, salaries, insurance, depreciation. $10,000 rent stays $10,000 whether you make 1 unit or 10,000 units.' },
         { title: 'Variable Costs', content: 'Variable costs change in direct proportion to activity. Examples: raw materials, direct labor, shipping, sales commissions. More units = more cost.' },
         { title: 'Mixed Costs', content: 'Some costs have both fixed and variable components. Example: Utilities have a base charge (fixed) plus usage (variable). Phone plans with base + overage.' },
         { title: 'Per-Unit Behavior', content: 'Key insight: Fixed costs per unit DECREASE as volume increases (spreading overhead). Variable costs per unit stay CONSTANT.' },
         { title: 'Operating Leverage', content: 'High fixed costs = High operating leverage = Bigger profit swings. Small revenue changes create large profit changes. Risky but rewarding at high volumes!' },
         { title: 'Ready to Classify!', content: 'You\'ll identify cost types and see how they behave as production changes. Master this to make better business decisions!' }
      ];

      const costItems = [
         { name: 'Factory Rent', amount: 15000, type: 'fixed', description: 'Monthly lease payment for manufacturing facility', perUnit: false },
         { name: 'Raw Materials', amount: 25, type: 'variable', description: 'Steel and components per unit produced', perUnit: true },
         { name: 'CEO Salary', amount: 20000, type: 'fixed', description: 'Monthly executive compensation', perUnit: false },
         { name: 'Sales Commission', amount: 50, type: 'variable', description: '5% commission on each $1,000 sale', perUnit: true },
         { name: 'Electricity', amount: 3000, type: 'mixed', description: 'Base charge $1,000 + $2 per machine hour', perUnit: false },
         { name: 'Packaging Materials', amount: 5, type: 'variable', description: 'Boxes and wrapping per unit shipped', perUnit: true },
         { name: 'Equipment Depreciation', amount: 8000, type: 'fixed', description: 'Monthly depreciation on machinery', perUnit: false },
         { name: 'Shipping Costs', amount: 15, type: 'variable', description: 'Freight cost per unit delivered', perUnit: true },
         { name: 'Property Insurance', amount: 2500, type: 'fixed', description: 'Annual premium paid monthly', perUnit: false },
         { name: 'Phone/Internet', amount: 500, type: 'mixed', description: 'Base service $300 + usage charges', perUnit: false },
         { name: 'Direct Labor', amount: 35, type: 'variable', description: 'Hourly wages for production workers', perUnit: true },
         { name: 'Quality Inspection', amount: 3, type: 'variable', description: 'Testing cost per unit produced', perUnit: true }
      ];

      const quizQuestions = [
         { q: 'As production volume doubles, total fixed costs:', options: ['Double', 'Stay the same', 'Cut in half', 'Increase slightly'], correct: 1 },
         { q: 'As production volume doubles, fixed cost PER UNIT:', options: ['Doubles', 'Stays the same', 'Cuts in half', 'Increases slightly'], correct: 2 },
         { q: 'Variable costs per unit typically:', options: ['Decrease with volume', 'Stay constant', 'Increase with volume', 'Become fixed'], correct: 1 },
         { q: 'High fixed costs create:', options: ['Low operating leverage', 'High operating leverage', 'No leverage effect', 'Variable leverage'], correct: 1 },
         { q: 'A cost with both fixed and variable components is called:', options: ['Semi-fixed', 'Mixed/Semi-variable', 'Hybrid fixed', 'Dual cost'], correct: 1 },
         { q: 'Which business model has highest operating leverage?', options: ['Consulting firm (mostly labor)', 'Software company (mostly fixed)', 'Retail store (mixed)', 'Food truck (mostly variable)'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleClassification = (type: 'fixed' | 'variable' | 'mixed') => {
         if (answered) return;
         setSelectedType(type);
         setAnswered(true);
         const item = costItems[scenarioIndex];
         if (type === item.type) {
            setScore(s => s + 10);
            setGameLog(prev => [...prev, `Correct: ${item.name} is ${type}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect: ${item.name} is ${item.type}, not ${type}`]);
         }
      };

      const nextScenario = () => {
         if (scenarioIndex < costItems.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedType(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const calculateCosts = (units: number) => {
         const fixed = 45500; // Sum of fixed costs
         const variablePerUnit = 133; // Sum of variable per-unit costs
         const totalVariable = variablePerUnit * units;
         const totalCost = fixed + totalVariable;
         const costPerUnit = totalCost / units;
         return { fixed, totalVariable, totalCost, costPerUnit, variablePerUnit };
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-amber-800 mb-4 flex items-center gap-2">
                  üìä Fixed vs Variable Costs
                  <button onClick={() => openInfo('Why Cost Behavior Matters', 'Understanding how costs behave helps you: Set profitable prices, Create accurate budgets, Make break-even decisions, Evaluate business risk, Choose between business models.')} className="text-amber-500 hover:text-amber-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Master how costs behave as business activity changes!</p>
                  <div className="grid grid-cols-3 gap-3 mb-4">
                     <div className="bg-blue-50 p-3 rounded-lg text-center border-t-4 border-blue-500">
                        <div className="text-2xl mb-1">üè¢</div>
                        <div className="font-bold text-blue-800 text-sm">Fixed</div>
                        <div className="text-xs text-blue-600">Same total regardless of volume</div>
                     </div>
                     <div className="bg-green-50 p-3 rounded-lg text-center border-t-4 border-green-500">
                        <div className="text-2xl mb-1">üì¶</div>
                        <div className="font-bold text-green-800 text-sm">Variable</div>
                        <div className="text-xs text-green-600">Changes with each unit</div>
                     </div>
                     <div className="bg-purple-50 p-3 rounded-lg text-center border-t-4 border-purple-500">
                        <div className="text-2xl mb-1">‚ö°</div>
                        <div className="font-bold text-purple-800 text-sm">Mixed</div>
                        <div className="text-xs text-purple-600">Has both components</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> Cost classification, Per-unit behavior, Operating leverage, Break-even impact
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-amber-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-amber-800">Tutorial</h2>
                  <span className="text-sm text-amber-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 1 && (
                     <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="font-semibold text-blue-800 mb-2">Fixed Cost Examples:</div>
                        <div className="grid grid-cols-2 gap-2 text-sm text-blue-700">
                           <span>üè† Rent/Lease</span>
                           <span>üëî Salaries</span>
                           <span>üìã Insurance</span>
                           <span>üè≠ Depreciation</span>
                        </div>
                        <div className="mt-2 text-xs text-gray-500">100 units or 10,000 units ‚Üí Same total cost</div>
                     </div>
                  )}

                  {tutorialStep === 2 && (
                     <div className="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div className="font-semibold text-green-800 mb-2">Variable Cost Examples:</div>
                        <div className="grid grid-cols-2 gap-2 text-sm text-green-700">
                           <span>üî© Raw Materials</span>
                           <span>üì¶ Packaging</span>
                           <span>üöö Shipping</span>
                           <span>üí∞ Commissions</span>
                        </div>
                        <div className="mt-2 text-xs text-gray-500">2x units ‚Üí 2x total variable cost</div>
                     </div>
                  )}

                  {tutorialStep === 4 && (
                     <div className="mt-4">
                        <div className="grid grid-cols-2 gap-4">
                           <div className="p-3 bg-blue-50 rounded-lg">
                              <div className="text-sm font-semibold text-blue-800">Fixed: $10,000 rent</div>
                              <div className="text-xs text-gray-600 mt-1">1,000 units ‚Üí $10/unit</div>
                              <div className="text-xs text-gray-600">10,000 units ‚Üí $1/unit</div>
                              <div className="text-xs text-green-600 mt-1">‚Üì Per unit as volume ‚Üë</div>
                           </div>
                           <div className="p-3 bg-green-50 rounded-lg">
                              <div className="text-sm font-semibold text-green-800">Variable: $5/unit</div>
                              <div className="text-xs text-gray-600 mt-1">1,000 units ‚Üí $5/unit</div>
                              <div className="text-xs text-gray-600">10,000 units ‚Üí $5/unit</div>
                              <div className="text-xs text-amber-600 mt-1">‚Üí Per unit stays same</div>
                           </div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-amber-500 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Classifying!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const item = costItems[scenarioIndex];
         const costs = calculateCosts(productionLevel);

         return (
            <div className="p-6 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-amber-800">Classify the Cost</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-amber-100 px-3 py-1 rounded-full text-amber-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Item {scenarioIndex + 1}/{costItems.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <div className="text-center mb-4">
                     <h3 className="text-xl font-bold text-gray-800">{item.name}</h3>
                     <p className="text-gray-600 text-sm mt-1">{item.description}</p>
                     <div className="mt-2 text-lg font-semibold text-amber-700">
                        ${item.amount.toLocaleString()}{item.perUnit ? ' per unit' : ' per month'}
                     </div>
                  </div>

                  {!answered ? (
                     <div className="grid grid-cols-3 gap-3">
                        <button
                           onClick={() => handleClassification('fixed')}
                           className="p-4 bg-blue-50 border-2 border-blue-200 rounded-xl hover:border-blue-500 hover:bg-blue-100 transition-all"
                        >
                           <div className="text-2xl mb-1">üè¢</div>
                           <div className="font-bold text-blue-800">Fixed</div>
                           <div className="text-xs text-blue-600">Same total</div>
                        </button>
                        <button
                           onClick={() => handleClassification('variable')}
                           className="p-4 bg-green-50 border-2 border-green-200 rounded-xl hover:border-green-500 hover:bg-green-100 transition-all"
                        >
                           <div className="text-2xl mb-1">üì¶</div>
                           <div className="font-bold text-green-800">Variable</div>
                           <div className="text-xs text-green-600">Per unit</div>
                        </button>
                        <button
                           onClick={() => handleClassification('mixed')}
                           className="p-4 bg-purple-50 border-2 border-purple-200 rounded-xl hover:border-purple-500 hover:bg-purple-100 transition-all"
                        >
                           <div className="text-2xl mb-1">‚ö°</div>
                           <div className="font-bold text-purple-800">Mixed</div>
                           <div className="text-xs text-purple-600">Both parts</div>
                        </button>
                     </div>
                  ) : (
                     <div className={`p-4 rounded-xl ${selectedType === item.type ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}`}>
                        <div className="font-bold mb-2">
                           {selectedType === item.type ? '‚úÖ Correct!' : '‚ùå Incorrect'}
                        </div>
                        <div className="text-sm text-gray-700">
                           <strong>{item.name}</strong> is a <strong className="capitalize">{item.type}</strong> cost.
                        </div>
                        <div className="text-sm text-gray-600 mt-1">
                           {item.type === 'fixed' && 'This cost stays the same regardless of how many units are produced.'}
                           {item.type === 'variable' && 'This cost increases proportionally with each unit produced.'}
                           {item.type === 'mixed' && 'This cost has a fixed base plus a variable component based on usage.'}
                        </div>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                           {scenarioIndex < costItems.length - 1 ? 'Next Cost ‚Üí' : 'See Cost Behavior'}
                        </button>
                     </div>
                  )}
               </div>

               {/* Cost Behavior Visualization */}
               <div className="bg-white/70 p-4 rounded-xl">
                  <div className="flex justify-between items-center mb-2">
                     <span className="text-sm font-semibold text-gray-700">Cost Behavior at Different Volumes</span>
                     <button onClick={() => openInfo('Operating Leverage', 'Companies with high fixed costs have high operating leverage. This means profits are more sensitive to sales changes - they lose more when sales drop but gain more when sales rise.')} className="text-amber-500">‚ÑπÔ∏è</button>
                  </div>
                  <div className="mb-2">
                     <input
                        type="range"
                        min="500"
                        max="5000"
                        step="500"
                        value={productionLevel}
                        onChange={(e) => setProductionLevel(Number(e.target.value))}
                        className="w-full"
                     />
                     <div className="flex justify-between text-xs text-gray-500">
                        <span>500 units</span>
                        <span className="font-semibold text-amber-700">{productionLevel.toLocaleString()} units</span>
                        <span>5,000 units</span>
                     </div>
                  </div>
                  <div className="grid grid-cols-4 gap-2 text-center text-xs">
                     <div className="bg-blue-50 p-2 rounded">
                        <div className="text-blue-600">Fixed Total</div>
                        <div className="font-bold text-blue-800">${costs.fixed.toLocaleString()}</div>
                     </div>
                     <div className="bg-green-50 p-2 rounded">
                        <div className="text-green-600">Variable Total</div>
                        <div className="font-bold text-green-800">${costs.totalVariable.toLocaleString()}</div>
                     </div>
                     <div className="bg-amber-50 p-2 rounded">
                        <div className="text-amber-600">Total Cost</div>
                        <div className="font-bold text-amber-800">${costs.totalCost.toLocaleString()}</div>
                     </div>
                     <div className="bg-purple-50 p-2 rounded">
                        <div className="text-purple-600">Cost/Unit</div>
                        <div className="font-bold text-purple-800">${costs.costPerUnit.toFixed(2)}</div>
                     </div>
                  </div>
               </div>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-amber-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (costItems.length * 10) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-amber-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-amber-800 mb-4">üéâ Cost Analysis Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-amber-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Cost Behavior Expert!' : percentage >= 70 ? 'üìä Strong Understanding' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Practicing'}
                     </div>
                  </div>
                  <div className="bg-amber-50 p-4 rounded-lg">
                     <h3 className="font-bold text-amber-800 mb-2">Key Takeaways:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Fixed costs: Same total regardless of volume</li>
                        <li>‚Ä¢ Variable costs: Change with each unit produced</li>
                        <li>‚Ä¢ Fixed cost per unit decreases as volume increases</li>
                        <li>‚Ä¢ Variable cost per unit stays constant</li>
                        <li>‚Ä¢ High fixed costs = High operating leverage = Higher risk/reward</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedType(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setProductionLevel(1000); }} className="w-full py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 27: Break-Even Analysis - Finding the Profit Point
   const BreakEvenAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [userAnswer, setUserAnswer] = useState('');
      const [answered, setAnswered] = useState(false);
      const [price, setPrice] = useState(100);
      const [variableCost, setVariableCost] = useState(60);
      const [fixedCosts, setFixedCosts] = useState(40000);

      const tutorialSteps = [
         { title: 'Welcome to Break-Even Analysis!', content: 'Learn to calculate the exact point where your business covers all costs - no profit, no loss. Essential for pricing, planning, and risk assessment.' },
         { title: 'The Break-Even Concept', content: 'Break-Even Point (BEP) is where Total Revenue = Total Costs. Below BEP = Loss. Above BEP = Profit. Every unit sold above BEP adds to profit!' },
         { title: 'Contribution Margin', content: 'Contribution Margin = Price - Variable Cost per Unit. It\'s what each unit "contributes" toward covering fixed costs and then generating profit.' },
         { title: 'The BEP Formula', content: 'Break-Even Units = Fixed Costs √∑ Contribution Margin. Example: $40,000 fixed √∑ ($100 price - $60 variable) = 1,000 units to break even.' },
         { title: 'Break-Even in Dollars', content: 'BEP in $ = BEP Units √ó Price. Or use: Fixed Costs √∑ CM Ratio. CM Ratio = CM √∑ Price = $40 √∑ $100 = 40%. BEP$ = $40K √∑ 0.4 = $100K' },
         { title: 'Margin of Safety', content: 'How much sales can drop before you lose money. Margin of Safety = Current Sales - Break-Even Sales. Higher is safer!' },
         { title: 'Ready to Calculate!', content: 'You\'ll analyze real business scenarios, calculate break-even points, and explore what-if scenarios. Master this critical business tool!' }
      ];

      const scenarios = [
         {
            company: 'CoffeeCart Mobile',
            description: 'Food truck selling premium coffee',
            fixedCosts: 3000,
            variableCost: 2,
            price: 5,
            currentSales: 1500,
            question: 'How many cups must CoffeeCart sell monthly to break even?',
            correctAnswer: 1000,
            unit: 'cups'
         },
         {
            company: 'TechGadget Pro',
            description: 'Electronics manufacturer',
            fixedCosts: 500000,
            variableCost: 150,
            price: 250,
            currentSales: 6000,
            question: 'How many units must TechGadget sell to break even?',
            correctAnswer: 5000,
            unit: 'units'
         },
         {
            company: 'FitClass Studio',
            description: 'Boutique fitness studio',
            fixedCosts: 8000,
            variableCost: 5,
            price: 25,
            currentSales: 500,
            question: 'How many class passes must FitClass sell monthly?',
            correctAnswer: 400,
            unit: 'passes'
         },
         {
            company: 'PrintShop Express',
            description: 'Custom printing services',
            fixedCosts: 12000,
            variableCost: 8,
            price: 20,
            currentSales: 1200,
            question: 'How many print jobs needed to break even?',
            correctAnswer: 1000,
            unit: 'jobs'
         }
      ];

      const quizQuestions = [
         { q: 'Contribution Margin equals:', options: ['Price + Variable Cost', 'Price - Variable Cost', 'Fixed Cost √∑ Price', 'Total Revenue - Fixed Cost'], correct: 1 },
         { q: 'At the break-even point, profit equals:', options: ['Revenue', 'Fixed costs', 'Zero', 'Contribution margin'], correct: 2 },
         { q: 'If fixed costs increase, break-even point:', options: ['Decreases', 'Increases', 'Stays same', 'Becomes negative'], correct: 1 },
         { q: 'If selling price increases (costs unchanged), BEP:', options: ['Increases', 'Decreases', 'Stays same', 'Cannot determine'], correct: 1 },
         { q: 'Margin of Safety measures:', options: ['Profit per unit', 'Buffer above break-even', 'Total fixed costs', 'Variable cost ratio'], correct: 1 },
         { q: 'CM Ratio of 40% means for every $1 of sales:', options: ['$0.40 covers fixed costs/profit', '$0.60 covers fixed costs/profit', '$0.40 is variable cost', 'Break-even is at 40%'], correct: 0 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const checkAnswer = () => {
         const scenario = scenarios[scenarioIndex];
         const userNum = parseInt(userAnswer);
         const isCorrect = Math.abs(userNum - scenario.correctAnswer) <= scenario.correctAnswer * 0.05; // 5% tolerance

         if (isCorrect) {
            setScore(s => s + 20);
            setGameLog(prev => [...prev, `Correct! ${scenario.company} BEP = ${scenario.correctAnswer} ${scenario.unit}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect. ${scenario.company} BEP = ${scenario.correctAnswer} ${scenario.unit}`]);
         }
         setAnswered(true);
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setUserAnswer('');
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      const calculateBEP = () => {
         const cm = price - variableCost;
         const bepUnits = cm > 0 ? Math.ceil(fixedCosts / cm) : 0;
         const bepDollars = bepUnits * price;
         const cmRatio = price > 0 ? (cm / price) * 100 : 0;
         return { cm, bepUnits, bepDollars, cmRatio };
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-indigo-800 mb-4 flex items-center gap-2">
                  üìà Break-Even Analysis
                  <button onClick={() => openInfo('Why Break-Even Matters', 'Knowing your break-even helps you: Set minimum sales targets, Price products correctly, Evaluate new ventures, Understand business risk, Make go/no-go decisions.')} className="text-indigo-500 hover:text-indigo-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Find the magic number where costs meet revenue!</p>
                  <div className="bg-gradient-to-r from-red-100 via-yellow-100 to-green-100 p-4 rounded-lg mb-4">
                     <div className="flex justify-between items-center text-sm">
                        <div className="text-center">
                           <div className="text-red-600 font-bold">LOSS</div>
                           <div className="text-xs text-gray-500">Below BEP</div>
                        </div>
                        <div className="text-center border-2 border-yellow-500 px-4 py-2 rounded-lg bg-yellow-50">
                           <div className="text-yellow-700 font-bold">BREAK-EVEN</div>
                           <div className="text-xs text-gray-500">Revenue = Costs</div>
                        </div>
                        <div className="text-center">
                           <div className="text-green-600 font-bold">PROFIT</div>
                           <div className="text-xs text-gray-500">Above BEP</div>
                        </div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> BEP formulas, Contribution margin, What-if analysis, Margin of safety
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-indigo-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         const calc = calculateBEP();

         return (
            <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-indigo-800">Tutorial</h2>
                  <span className="text-sm text-indigo-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 2 && (
                     <div className="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <div className="font-mono text-center text-lg">
                           <span className="text-indigo-700">CM</span> = <span className="text-green-600">$100</span> - <span className="text-red-600">$60</span> = <span className="text-indigo-800 font-bold">$40</span>
                        </div>
                        <div className="text-xs text-center text-gray-500 mt-2">Each unit contributes $40 toward fixed costs and profit</div>
                     </div>
                  )}

                  {tutorialStep === 3 && (
                     <div className="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div className="font-mono text-center">
                           <div className="text-lg">BEP Units = <span className="text-indigo-700">Fixed Costs</span> √∑ <span className="text-green-700">CM</span></div>
                           <div className="text-xl mt-2 font-bold text-green-800">$40,000 √∑ $40 = 1,000 units</div>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 4 && (
                     <div className="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div className="grid grid-cols-2 gap-4 text-center">
                           <div>
                              <div className="text-sm text-purple-600">BEP in Units</div>
                              <div className="font-bold text-purple-800">1,000 units</div>
                           </div>
                           <div>
                              <div className="text-sm text-purple-600">BEP in Dollars</div>
                              <div className="font-bold text-purple-800">$100,000</div>
                           </div>
                        </div>
                        <div className="text-xs text-center text-gray-500 mt-2">1,000 units √ó $100 = $100,000 revenue needed</div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-indigo-500 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Calculating!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         const cm = scenario.price - scenario.variableCost;
         const marginOfSafety = scenario.currentSales - scenario.correctAnswer;
         const mosPercent = (marginOfSafety / scenario.currentSales) * 100;

         return (
            <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-indigo-800">{scenario.company}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-indigo-100 px-3 py-1 rounded-full text-indigo-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Case {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <p className="text-gray-600 text-sm mb-4">{scenario.description}</p>

                  {/* Cost Structure Display */}
                  <div className="grid grid-cols-3 gap-3 mb-4">
                     <div className="bg-blue-50 p-3 rounded-lg text-center">
                        <div className="text-xs text-blue-600">Fixed Costs</div>
                        <div className="font-bold text-blue-800">${scenario.fixedCosts.toLocaleString()}</div>
                     </div>
                     <div className="bg-red-50 p-3 rounded-lg text-center">
                        <div className="text-xs text-red-600">Variable/Unit</div>
                        <div className="font-bold text-red-800">${scenario.variableCost}</div>
                     </div>
                     <div className="bg-green-50 p-3 rounded-lg text-center">
                        <div className="text-xs text-green-600">Price/Unit</div>
                        <div className="font-bold text-green-800">${scenario.price}</div>
                     </div>
                  </div>

                  {/* Contribution Margin */}
                  <div className="bg-indigo-50 p-3 rounded-lg mb-4 text-center">
                     <div className="text-sm text-indigo-600">Contribution Margin = ${scenario.price} - ${scenario.variableCost} = <strong className="text-indigo-800">${cm}</strong> per unit</div>
                  </div>

                  {/* Question */}
                  <div className="mb-4">
                     <p className="font-semibold text-gray-800 mb-2">{scenario.question}</p>
                     <div className="flex gap-2">
                        <input
                           type="number"
                           value={userAnswer}
                           onChange={(e) => setUserAnswer(e.target.value)}
                           placeholder="Enter break-even quantity"
                           className="flex-1 p-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 outline-none"
                           disabled={answered}
                        />
                        {!answered && (
                           <button onClick={checkAnswer} className="px-6 py-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                              Check
                           </button>
                        )}
                     </div>
                  </div>

                  {/* Result Display */}
                  {answered && (
                     <div className={`p-4 rounded-xl ${Math.abs(parseInt(userAnswer) - scenario.correctAnswer) <= scenario.correctAnswer * 0.05 ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}`}>
                        <div className="font-bold mb-2">
                           {Math.abs(parseInt(userAnswer) - scenario.correctAnswer) <= scenario.correctAnswer * 0.05 ? '‚úÖ Correct!' : '‚ùå Not quite'}
                        </div>
                        <div className="text-sm text-gray-700 space-y-1">
                           <div><strong>Break-Even:</strong> {scenario.correctAnswer.toLocaleString()} {scenario.unit}</div>
                           <div><strong>Formula:</strong> ${scenario.fixedCosts.toLocaleString()} √∑ ${cm} = {scenario.correctAnswer.toLocaleString()}</div>
                           <div><strong>Current Sales:</strong> {scenario.currentSales.toLocaleString()} {scenario.unit}</div>
                           <div><strong>Margin of Safety:</strong> {marginOfSafety.toLocaleString()} {scenario.unit} ({mosPercent.toFixed(1)}%)</div>
                        </div>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                           {scenarioIndex < scenarios.length - 1 ? 'Next Business ‚Üí' : 'Complete Analysis'}
                        </button>
                     </div>
                  )}
               </div>

               {/* Interactive What-If Calculator */}
               <div className="bg-white/70 p-4 rounded-xl">
                  <div className="text-sm font-semibold text-gray-700 mb-3">üîß What-If Calculator</div>
                  <div className="grid grid-cols-3 gap-3 text-sm mb-3">
                     <div>
                        <label className="text-xs text-gray-500">Price ($)</label>
                        <input type="number" value={price} onChange={(e) => setPrice(Number(e.target.value))} className="w-full p-2 border rounded" />
                     </div>
                     <div>
                        <label className="text-xs text-gray-500">Variable ($)</label>
                        <input type="number" value={variableCost} onChange={(e) => setVariableCost(Number(e.target.value))} className="w-full p-2 border rounded" />
                     </div>
                     <div>
                        <label className="text-xs text-gray-500">Fixed ($)</label>
                        <input type="number" value={fixedCosts} onChange={(e) => setFixedCosts(Number(e.target.value))} className="w-full p-2 border rounded" />
                     </div>
                  </div>
                  <div className="grid grid-cols-3 gap-2 text-center text-xs">
                     <div className="bg-indigo-50 p-2 rounded">
                        <div className="text-indigo-600">CM</div>
                        <div className="font-bold text-indigo-800">${calculateBEP().cm}</div>
                     </div>
                     <div className="bg-green-50 p-2 rounded">
                        <div className="text-green-600">BEP Units</div>
                        <div className="font-bold text-green-800">{calculateBEP().bepUnits.toLocaleString()}</div>
                     </div>
                     <div className="bg-purple-50 p-2 rounded">
                        <div className="text-purple-600">BEP $</div>
                        <div className="font-bold text-purple-800">${calculateBEP().bepDollars.toLocaleString()}</div>
                     </div>
                  </div>
               </div>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-indigo-500 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 20) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-indigo-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-indigo-800 mb-4">üéâ Break-Even Mastery!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-indigo-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Break-Even Expert!' : percentage >= 70 ? 'üìä Strong Analyst' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Practicing'}
                     </div>
                  </div>
                  <div className="bg-indigo-50 p-4 rounded-lg">
                     <h3 className="font-bold text-indigo-800 mb-2">Key Formulas:</h3>
                     <ul className="text-sm text-gray-700 space-y-1 font-mono">
                        <li>‚Ä¢ CM = Price - Variable Cost</li>
                        <li>‚Ä¢ BEP Units = Fixed Costs √∑ CM</li>
                        <li>‚Ä¢ BEP $ = BEP Units √ó Price</li>
                        <li>‚Ä¢ MoS = Current Sales - BEP</li>
                        <li>‚Ä¢ CM Ratio = CM √∑ Price</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setUserAnswer(''); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-semibold hover:bg-indigo-600">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 28: Internal Controls - Protecting Business Assets
   const InternalControlsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedControl, setSelectedControl] = useState<string | null>(null);
      const [answered, setAnswered] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to Internal Controls!', content: 'Learn to design and evaluate controls that protect assets, ensure accurate records, and prevent fraud. Essential for any business!' },
         { title: 'What Are Internal Controls?', content: 'Policies and procedures that: Safeguard assets, Ensure reliable financial reporting, Promote operational efficiency, Encourage compliance with laws.' },
         { title: 'Preventive Controls', content: 'Stop problems BEFORE they happen. Examples: Segregation of duties, Authorization requirements, Access controls, Training programs.' },
         { title: 'Detective Controls', content: 'Find problems AFTER they occur. Examples: Reconciliations, Audits, Exception reports, Variance analysis, Inventory counts.' },
         { title: 'Corrective Controls', content: 'Fix problems once detected. Examples: Backup/recovery procedures, Disciplinary actions, Process improvements, Error correction workflows.' },
         { title: 'Segregation of Duties', content: 'No single person should control all aspects of a transaction. Separate: Authorization, Custody, Recording. This prevents fraud and errors.' },
         { title: 'Ready to Protect!', content: 'You\'ll identify control weaknesses, recommend fixes, and design control frameworks. Become a guardian of business integrity!' }
      ];

      const scenarios = [
         {
            title: 'Cash Handling Risk',
            company: 'QuickMart Retail',
            situation: 'The same employee opens mail, records customer payments, makes bank deposits, and reconciles the bank statement.',
            weakness: 'No segregation of duties - one person controls entire cash cycle',
            controlType: 'preventive',
            bestControl: 'segregation',
            options: [
               { id: 'segregation', text: 'Separate duties among different employees', correct: true },
               { id: 'camera', text: 'Install security cameras', correct: false },
               { id: 'audit', text: 'Conduct surprise cash audits', correct: false },
               { id: 'training', text: 'Provide ethics training', correct: false }
            ],
            explanation: 'Segregation of duties is the primary preventive control. Different people should handle receiving, recording, depositing, and reconciling.'
         },
         {
            title: 'Inventory Shrinkage',
            company: 'TechWare Distribution',
            situation: 'Warehouse staff report inventory shortages, but no one knows when or how items went missing. There\'s no tracking of who accesses the warehouse.',
            weakness: 'No detective controls to identify inventory discrepancies',
            controlType: 'detective',
            bestControl: 'reconciliation',
            options: [
               { id: 'reconciliation', text: 'Implement regular cycle counts and reconciliations', correct: true },
               { id: 'lock', text: 'Add more locks to warehouse', correct: false },
               { id: 'hire', text: 'Hire more warehouse staff', correct: false },
               { id: 'insurance', text: 'Increase insurance coverage', correct: false }
            ],
            explanation: 'Regular cycle counts and reconciliation of physical inventory to records is a detective control that identifies when and where shrinkage occurs.'
         },
         {
            title: 'Unauthorized Purchases',
            company: 'GrowthStart Inc.',
            situation: 'Any employee can create purchase orders without approval. Last month, someone ordered $50,000 of equipment that wasn\'t needed.',
            weakness: 'No authorization controls on purchasing',
            controlType: 'preventive',
            bestControl: 'authorization',
            options: [
               { id: 'authorization', text: 'Require manager approval for purchases over $1,000', correct: true },
               { id: 'review', text: 'Review all purchases monthly', correct: false },
               { id: 'budget', text: 'Create a purchase budget', correct: false },
               { id: 'vendor', text: 'Limit approved vendors', correct: false }
            ],
            explanation: 'Authorization limits are preventive controls that stop unauthorized purchases before they happen. Approval thresholds based on amount are common.'
         },
         {
            title: 'Data Breach Risk',
            company: 'HealthData Systems',
            situation: 'All employees have access to the entire customer database including sensitive health information. There are no access logs.',
            weakness: 'No access controls or monitoring',
            controlType: 'preventive',
            bestControl: 'access',
            options: [
               { id: 'access', text: 'Implement role-based access controls with audit logs', correct: true },
               { id: 'encrypt', text: 'Encrypt all data at rest', correct: false },
               { id: 'firewall', text: 'Upgrade the firewall', correct: false },
               { id: 'training', text: 'Security awareness training', correct: false }
            ],
            explanation: 'Role-based access control (RBAC) limits data access to only what employees need. Audit logs provide detective capability to track who accessed what.'
         },
         {
            title: 'Financial Reporting Errors',
            company: 'AccuBooks Accounting',
            situation: 'The company discovered that last quarter\'s financial statements had material errors. Journal entries were posted without review.',
            weakness: 'No review controls over financial entries',
            controlType: 'preventive',
            bestControl: 'review',
            options: [
               { id: 'review', text: 'Require supervisor review of all journal entries', correct: true },
               { id: 'software', text: 'Upgrade accounting software', correct: false },
               { id: 'restate', text: 'Restate prior financials', correct: false },
               { id: 'outsource', text: 'Outsource bookkeeping', correct: false }
            ],
            explanation: 'Supervisory review of journal entries is a preventive control that catches errors before they affect financial statements. This is a key control for SOX compliance.'
         },
         {
            title: 'Payroll Fraud',
            company: 'ServicePro Solutions',
            situation: 'The HR manager who sets up new employees in the system also approves payroll and has access to change direct deposit information.',
            weakness: 'Lack of segregation in payroll processing',
            controlType: 'preventive',
            bestControl: 'segregation',
            options: [
               { id: 'segregation', text: 'Separate employee setup from payroll approval', correct: true },
               { id: 'audit', text: 'Annual payroll audit', correct: false },
               { id: 'verify', text: 'Verify new hire documents', correct: false },
               { id: 'limit', text: 'Limit pay rate changes', correct: false }
            ],
            explanation: 'In payroll, separate: 1) Adding/modifying employees, 2) Approving timesheets, 3) Processing payments, 4) Reconciling payroll. No single person should control multiple steps.'
         }
      ];

      const quizQuestions = [
         { q: 'Which control type PREVENTS problems before they occur?', options: ['Detective', 'Corrective', 'Preventive', 'Reactive'], correct: 2 },
         { q: 'Bank reconciliation is an example of a:', options: ['Preventive control', 'Detective control', 'Corrective control', 'Physical control'], correct: 1 },
         { q: 'Segregation of duties means:', options: ['Multiple approvals required', 'No single person controls entire process', 'Annual rotation of duties', 'Documented procedures'], correct: 1 },
         { q: 'Which is NOT a component of the COSO framework?', options: ['Control Environment', 'Risk Assessment', 'Profit Maximization', 'Monitoring Activities'], correct: 2 },
         { q: 'Access controls are primarily:', options: ['Detective', 'Corrective', 'Preventive', 'Compensating'], correct: 2 },
         { q: 'A surprise cash count is a:', options: ['Preventive control', 'Detective control', 'Corrective control', 'IT control'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleControlSelect = (controlId: string) => {
         if (answered) return;
         setSelectedControl(controlId);
         setAnswered(true);
         const scenario = scenarios[scenarioIndex];
         const isCorrect = scenario.options.find(o => o.id === controlId)?.correct;
         if (isCorrect) {
            setScore(s => s + 15);
            setGameLog(prev => [...prev, `Correct control identified for ${scenario.company}`]);
         } else {
            setGameLog(prev => [...prev, `Incorrect - review ${scenario.controlType} controls`]);
         }
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedControl(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                  üõ°Ô∏è Internal Controls
                  <button onClick={() => openInfo('Why Internal Controls Matter', 'Strong internal controls: Prevent fraud and theft, Ensure accurate financial reporting, Maintain regulatory compliance, Protect company reputation, Reduce operational risks.')} className="text-slate-500 hover:text-slate-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Design controls that protect assets and ensure integrity!</p>
                  <div className="grid grid-cols-3 gap-3 mb-4">
                     <div className="bg-blue-50 p-3 rounded-lg text-center border-t-4 border-blue-500">
                        <div className="text-2xl mb-1">üö´</div>
                        <div className="font-bold text-blue-800 text-sm">Preventive</div>
                        <div className="text-xs text-blue-600">Stop before it happens</div>
                     </div>
                     <div className="bg-amber-50 p-3 rounded-lg text-center border-t-4 border-amber-500">
                        <div className="text-2xl mb-1">üîç</div>
                        <div className="font-bold text-amber-800 text-sm">Detective</div>
                        <div className="text-xs text-amber-600">Find after it occurs</div>
                     </div>
                     <div className="bg-green-50 p-3 rounded-lg text-center border-t-4 border-green-500">
                        <div className="text-2xl mb-1">üîß</div>
                        <div className="font-bold text-green-800 text-sm">Corrective</div>
                        <div className="text-xs text-green-600">Fix the problem</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> Control types, Segregation of duties, Risk assessment, Control design
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-slate-700 text-white rounded-xl font-semibold hover:bg-slate-800 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-slate-700 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-slate-800">Tutorial</h2>
                  <span className="text-sm text-slate-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>

                  {tutorialStep === 2 && (
                     <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="font-semibold text-blue-800 mb-2">üö´ Preventive Control Examples:</div>
                        <div className="grid grid-cols-2 gap-2 text-sm text-blue-700">
                           <span>‚Ä¢ Segregation of duties</span>
                           <span>‚Ä¢ Password requirements</span>
                           <span>‚Ä¢ Approval workflows</span>
                           <span>‚Ä¢ Access restrictions</span>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 3 && (
                     <div className="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <div className="font-semibold text-amber-800 mb-2">üîç Detective Control Examples:</div>
                        <div className="grid grid-cols-2 gap-2 text-sm text-amber-700">
                           <span>‚Ä¢ Bank reconciliations</span>
                           <span>‚Ä¢ Variance reports</span>
                           <span>‚Ä¢ Physical inventory counts</span>
                           <span>‚Ä¢ Internal audits</span>
                        </div>
                     </div>
                  )}

                  {tutorialStep === 5 && (
                     <div className="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div className="font-semibold text-purple-800 mb-2">Segregation of Duties Triangle:</div>
                        <div className="flex justify-center items-center gap-4 mt-2">
                           <div className="text-center p-2 bg-white rounded-lg">
                              <div className="text-xl">‚úçÔ∏è</div>
                              <div className="text-xs text-purple-700">Authorization</div>
                           </div>
                           <div className="text-center p-2 bg-white rounded-lg">
                              <div className="text-xl">üîê</div>
                              <div className="text-xs text-purple-700">Custody</div>
                           </div>
                           <div className="text-center p-2 bg-white rounded-lg">
                              <div className="text-xl">üìù</div>
                              <div className="text-xs text-purple-700">Recording</div>
                           </div>
                        </div>
                        <div className="text-xs text-center text-gray-500 mt-2">Each function should be performed by different people</div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-slate-700 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Assessment!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         return (
            <div className="p-6 bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-slate-800">{scenario.company}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-slate-200 px-3 py-1 rounded-full text-slate-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Case {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <h3 className="font-bold text-gray-800 mb-2">{scenario.title}</h3>

                  {/* Situation */}
                  <div className="bg-red-50 p-4 rounded-lg mb-4 border-l-4 border-red-400">
                     <div className="text-sm font-semibold text-red-800 mb-1">‚ö†Ô∏è Situation:</div>
                     <p className="text-sm text-gray-700">{scenario.situation}</p>
                  </div>

                  {/* Weakness Identified */}
                  <div className="bg-amber-50 p-3 rounded-lg mb-4">
                     <div className="text-sm text-amber-800">
                        <strong>Control Weakness:</strong> {scenario.weakness}
                     </div>
                     <div className="text-xs text-amber-600 mt-1">
                        Recommended: <span className="capitalize font-semibold">{scenario.controlType}</span> control
                     </div>
                  </div>

                  {/* Control Options */}
                  <div className="mb-4">
                     <p className="font-semibold text-gray-800 mb-3">Select the best control to address this weakness:</p>
                     <div className="grid gap-2">
                        {scenario.options.map(option => (
                           <button
                              key={option.id}
                              onClick={() => handleControlSelect(option.id)}
                              disabled={answered}
                              className={`p-3 rounded-lg text-left transition-all border-2 ${
                                 answered
                                    ? option.correct
                                       ? 'bg-green-50 border-green-500'
                                       : selectedControl === option.id
                                          ? 'bg-red-50 border-red-500'
                                          : 'bg-gray-50 border-gray-200'
                                    : 'bg-gray-50 border-gray-200 hover:border-slate-400 hover:bg-slate-50'
                              }`}
                           >
                              <span className="text-sm">{option.text}</span>
                           </button>
                        ))}
                     </div>
                  </div>

                  {/* Explanation */}
                  {answered && (
                     <div className={`p-4 rounded-xl ${scenarios[scenarioIndex].options.find(o => o.id === selectedControl)?.correct ? 'bg-green-50 border-2 border-green-300' : 'bg-amber-50 border-2 border-amber-300'}`}>
                        <div className="font-bold mb-2">
                           {scenarios[scenarioIndex].options.find(o => o.id === selectedControl)?.correct ? '‚úÖ Excellent!' : 'üìö Learning Opportunity'}
                        </div>
                        <p className="text-sm text-gray-700">{scenario.explanation}</p>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800">
                           {scenarioIndex < scenarios.length - 1 ? 'Next Case ‚Üí' : 'Complete Assessment'}
                        </button>
                     </div>
                  )}
               </div>

               {/* Control Type Legend */}
               <div className="bg-white/60 p-3 rounded-lg">
                  <div className="grid grid-cols-3 gap-2 text-xs text-center">
                     <div className={`p-2 rounded ${scenario.controlType === 'preventive' ? 'bg-blue-100 ring-2 ring-blue-400' : 'bg-blue-50'}`}>
                        <span className="text-blue-700">üö´ Preventive</span>
                     </div>
                     <div className={`p-2 rounded ${scenario.controlType === 'detective' ? 'bg-amber-100 ring-2 ring-amber-400' : 'bg-amber-50'}`}>
                        <span className="text-amber-700">üîç Detective</span>
                     </div>
                     <div className={`p-2 rounded ${scenario.controlType === 'corrective' ? 'bg-green-100 ring-2 ring-green-400' : 'bg-green-50'}`}>
                        <span className="text-green-700">üîß Corrective</span>
                     </div>
                  </div>
               </div>

               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-slate-700 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 15) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-slate-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => {
                                 if (!quizAnswered) {
                                    if (i === quiz.correct) setScore(s => s + 10);
                                    setQuizAnswered(true);
                                    setGameLog(prev => [...prev, `Quiz ${quizIndex + 1}: ${i === quiz.correct ? 'Correct!' : 'Incorrect'}`]);
                                 }
                              }}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-slate-700 text-white rounded-xl font-semibold hover:bg-slate-800">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-slate-800 mb-4">üéâ Controls Assessment Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-slate-700 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Control Expert!' : percentage >= 70 ? 'üõ°Ô∏è Strong Guardian' : percentage >= 50 ? 'üìà Good Progress' : 'üìö Keep Learning'}
                     </div>
                  </div>
                  <div className="bg-slate-100 p-4 rounded-lg">
                     <h3 className="font-bold text-slate-800 mb-2">Key Control Principles:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Preventive controls stop problems before they happen</li>
                        <li>‚Ä¢ Detective controls find problems after they occur</li>
                        <li>‚Ä¢ Segregate authorization, custody, and recording</li>
                        <li>‚Ä¢ Layer controls for defense in depth</li>
                        <li>‚Ä¢ Monitor and test controls regularly</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedControl(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-slate-700 text-white rounded-xl font-semibold hover:bg-slate-800">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 29: Audit Preparation - Getting Ready for Auditors
   const AuditPrepRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [checklist, setChecklist] = useState<Record<string, boolean>>({});
      const [submitted, setSubmitted] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to Audit Preparation!', content: 'Learn to prepare for financial audits efficiently. Good preparation reduces audit time, costs, and stress while building auditor confidence.' },
         { title: 'Types of Audits', content: 'External Audit: Independent CPA reviews financials. Internal Audit: Company\'s own review of controls. Tax Audit: IRS/state review of tax returns. SOX Audit: Public company control testing.' },
         { title: 'The Audit Timeline', content: 'Planning (2-4 weeks before): Gather documents, reconcile accounts. Fieldwork (1-4 weeks): Auditors test transactions. Wrap-up: Review findings, issue opinion.' },
         { title: 'Key Documents Needed', content: 'Bank statements & reconciliations, General ledger & trial balance, Supporting invoices/receipts, Contracts & agreements, Board minutes, Prior year audit reports.' },
         { title: 'Account Reconciliations', content: 'Reconcile ALL balance sheet accounts monthly. Investigate and clear old reconciling items. Document explanations for unusual items. Sign-off by preparer and reviewer.' },
         { title: 'Common Audit Requests', content: 'Auditors will ask for: Confirmations (bank, AR, AP), Cutoff testing support, Inventory count sheets, Fixed asset schedules, Debt agreements, Revenue contracts.' },
         { title: 'Ready to Prepare!', content: 'You\'ll organize audit workpapers, prioritize tasks, and ensure nothing is missed. A well-prepared audit is a successful audit!' }
      ];

      const scenarios = [
         {
            title: 'Year-End Close Checklist',
            company: 'GrowthTech Solutions',
            auditType: 'External Financial Audit',
            daysUntilAudit: 14,
            tasks: [
               { id: 'bank_rec', name: 'Complete bank reconciliations', priority: 'critical', category: 'reconciliation' },
               { id: 'ar_aging', name: 'Review AR aging and allowance', priority: 'critical', category: 'reconciliation' },
               { id: 'inventory', name: 'Complete physical inventory count', priority: 'critical', category: 'verification' },
               { id: 'accruals', name: 'Record all accrued expenses', priority: 'high', category: 'adjustments' },
               { id: 'prepaid', name: 'Update prepaid expense schedules', priority: 'medium', category: 'reconciliation' },
               { id: 'fixed_assets', name: 'Reconcile fixed asset register', priority: 'high', category: 'reconciliation' },
               { id: 'debt', name: 'Confirm debt balances and covenants', priority: 'high', category: 'confirmation' },
               { id: 'revenue', name: 'Test revenue cutoff (last 5 days)', priority: 'critical', category: 'cutoff' }
            ],
            criticalCount: 4
         },
         {
            title: 'PBC List Organization',
            company: 'MediCare Supplies',
            auditType: 'First-Year Audit',
            daysUntilAudit: 21,
            tasks: [
               { id: 'gl', name: 'Export complete general ledger', priority: 'critical', category: 'documentation' },
               { id: 'trial', name: 'Prepare trial balance with lead sheets', priority: 'critical', category: 'documentation' },
               { id: 'contracts', name: 'Gather all significant contracts', priority: 'high', category: 'documentation' },
               { id: 'minutes', name: 'Compile board meeting minutes', priority: 'medium', category: 'governance' },
               { id: 'org_chart', name: 'Update organizational chart', priority: 'low', category: 'documentation' },
               { id: 'policies', name: 'Document accounting policies', priority: 'high', category: 'documentation' },
               { id: 'related', name: 'Identify related party transactions', priority: 'critical', category: 'disclosure' },
               { id: 'subsequent', name: 'List subsequent events', priority: 'critical', category: 'disclosure' }
            ],
            criticalCount: 4
         },
         {
            title: 'Internal Control Documentation',
            company: 'SecureFinance Corp',
            auditType: 'SOX 404 Audit',
            daysUntilAudit: 30,
            tasks: [
               { id: 'narratives', name: 'Update process narratives', priority: 'critical', category: 'controls' },
               { id: 'flowcharts', name: 'Review and update flowcharts', priority: 'high', category: 'controls' },
               { id: 'risk_matrix', name: 'Complete risk control matrix', priority: 'critical', category: 'controls' },
               { id: 'testing', name: 'Perform control self-testing', priority: 'critical', category: 'testing' },
               { id: 'remediation', name: 'Document remediation of deficiencies', priority: 'critical', category: 'controls' },
               { id: 'access', name: 'Review user access reports', priority: 'high', category: 'it_controls' },
               { id: 'segregation', name: 'Verify segregation of duties', priority: 'high', category: 'controls' },
               { id: 'management', name: 'Prepare management representation letter', priority: 'medium', category: 'governance' }
            ],
            criticalCount: 4
         }
      ];

      const quizQuestions = [
         { q: 'The "PBC list" stands for:', options: ['Preliminary Balance Check', 'Provided By Client', 'Pre-Audit Business Checklist', 'Post-Balance Confirmation'], correct: 1 },
         { q: 'Bank confirmations are sent to:', options: ['The client', 'The auditor directly', 'Both client and auditor', 'The bank\'s auditor'], correct: 1 },
         { q: 'Revenue cutoff testing verifies:', options: ['Total revenue is correct', 'Revenue is recorded in the right period', 'All customers paid', 'Prices are accurate'], correct: 1 },
         { q: 'Which document is NOT typically needed for audit?', options: ['Bank reconciliations', 'Employee vacation schedules', 'Debt agreements', 'Board minutes'], correct: 1 },
         { q: 'The management representation letter is signed by:', options: ['The auditor', 'Company management/CEO/CFO', 'The board of directors', 'External legal counsel'], correct: 1 },
         { q: 'Subsequent events are transactions that occur:', options: ['Before year-end', 'After year-end but before audit completion', 'After audit completion', 'During the audit only'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const toggleTask = (taskId: string) => {
         if (submitted) return;
         setChecklist(prev => ({ ...prev, [taskId]: !prev[taskId] }));
      };

      const calculateScore = () => {
         const scenario = scenarios[scenarioIndex];
         let points = 0;
         const criticalTasks = scenario.tasks.filter(t => t.priority === 'critical');
         const completedCritical = criticalTasks.filter(t => checklist[t.id]).length;
         points += completedCritical * 10;
         const highTasks = scenario.tasks.filter(t => t.priority === 'high');
         const completedHigh = highTasks.filter(t => checklist[t.id]).length;
         points += completedHigh * 5;
         if (completedCritical === criticalTasks.length) points += 20; // Bonus for all critical
         return points;
      };

      const handleSubmit = () => {
         const earnedPoints = calculateScore();
         setScore(s => s + earnedPoints);
         setSubmitted(true);
         setGameLog(prev => [...prev, `${scenarios[scenarioIndex].company}: Earned ${earnedPoints} points`]);
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setChecklist({});
            setSubmitted(false);
         } else {
            setPhase('result');
         }
      };

      // Intro Phase
      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                  üìã Audit Preparation
                  <button onClick={() => openInfo('Why Audit Prep Matters', 'Good preparation: Reduces audit fees (less auditor time), Minimizes disruptions to operations, Demonstrates strong controls, Builds creditor/investor confidence, Avoids last-minute scrambles.')} className="text-blue-500 hover:text-blue-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Master the art of audit readiness!</p>
                  <div className="grid grid-cols-4 gap-2 mb-4">
                     <div className="bg-blue-50 p-2 rounded-lg text-center">
                        <div className="text-xl mb-1">üìä</div>
                        <div className="text-xs text-blue-700">Reconcile</div>
                     </div>
                     <div className="bg-green-50 p-2 rounded-lg text-center">
                        <div className="text-xl mb-1">üìÅ</div>
                        <div className="text-xs text-green-700">Document</div>
                     </div>
                     <div className="bg-amber-50 p-2 rounded-lg text-center">
                        <div className="text-xl mb-1">‚úÖ</div>
                        <div className="text-xs text-amber-700">Verify</div>
                     </div>
                     <div className="bg-purple-50 p-2 rounded-lg text-center">
                        <div className="text-xl mb-1">üîç</div>
                        <div className="text-xs text-purple-700">Review</div>
                     </div>
                  </div>
                  <div className="text-sm text-gray-600">
                     <strong>You'll learn:</strong> PBC list management, Reconciliation priorities, Control documentation, Audit timeline
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      // Tutorial Phase
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-blue-800">Tutorial</h2>
                  <span className="text-sm text-blue-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>
                  {tutorialStep === 2 && (
                     <div className="mt-4 flex gap-2">
                        <div className="flex-1 bg-blue-50 p-3 rounded-lg text-center">
                           <div className="text-xs text-blue-600">Planning</div>
                           <div className="font-bold text-blue-800">2-4 weeks</div>
                        </div>
                        <div className="flex-1 bg-amber-50 p-3 rounded-lg text-center">
                           <div className="text-xs text-amber-600">Fieldwork</div>
                           <div className="font-bold text-amber-800">1-4 weeks</div>
                        </div>
                        <div className="flex-1 bg-green-50 p-3 rounded-lg text-center">
                           <div className="text-xs text-green-600">Wrap-up</div>
                           <div className="font-bold text-green-800">1-2 weeks</div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-blue-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Preparing!'}
                  </button>
               </div>
            </div>
         );
      }

      // Play Phase
      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         const completedCount = Object.values(checklist).filter(Boolean).length;
         return (
            <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-blue-800">{scenario.company}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-blue-100 px-3 py-1 rounded-full text-blue-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Audit {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-4 rounded-xl mb-4">
                  <div className="flex justify-between items-center mb-3">
                     <div>
                        <div className="font-semibold text-gray-800">{scenario.title}</div>
                        <div className="text-sm text-gray-500">{scenario.auditType}</div>
                     </div>
                     <div className="bg-amber-100 px-3 py-1 rounded-full">
                        <span className="text-amber-700 text-sm font-semibold">{scenario.daysUntilAudit} days until audit</span>
                     </div>
                  </div>

                  <div className="text-sm text-gray-600 mb-3">Select all critical and high-priority items to complete:</div>

                  <div className="space-y-2 max-h-64 overflow-y-auto">
                     {scenario.tasks.map(task => (
                        <button
                           key={task.id}
                           onClick={() => toggleTask(task.id)}
                           disabled={submitted}
                           className={`w-full p-3 rounded-lg text-left flex items-center gap-3 transition-all ${
                              checklist[task.id]
                                 ? 'bg-green-50 border-2 border-green-400'
                                 : 'bg-gray-50 border-2 border-gray-200 hover:border-blue-300'
                           }`}
                        >
                           <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                              checklist[task.id] ? 'bg-green-500 border-green-500' : 'border-gray-300'
                           }`}>
                              {checklist[task.id] && <span className="text-white text-xs">‚úì</span>}
                           </div>
                           <div className="flex-1">
                              <span className="text-sm">{task.name}</span>
                           </div>
                           <span className={`text-xs px-2 py-0.5 rounded ${
                              task.priority === 'critical' ? 'bg-red-100 text-red-700' :
                              task.priority === 'high' ? 'bg-amber-100 text-amber-700' :
                              task.priority === 'medium' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-600'
                           }`}>
                              {task.priority}
                           </span>
                        </button>
                     ))}
                  </div>

                  <div className="mt-3 flex justify-between text-sm">
                     <span className="text-gray-500">Completed: {completedCount}/{scenario.tasks.length}</span>
                     <span className="text-red-600">Critical items: {scenario.criticalCount}</span>
                  </div>
               </div>

               {!submitted ? (
                  <button onClick={handleSubmit} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
                     Submit Preparation Checklist
                  </button>
               ) : (
                  <div className="bg-green-50 p-4 rounded-xl border-2 border-green-300 mb-4">
                     <div className="font-bold text-green-800 mb-2">Checklist Reviewed!</div>
                     <div className="text-sm text-gray-700">
                        Critical items completed: {scenario.tasks.filter(t => t.priority === 'critical' && checklist[t.id]).length}/{scenario.criticalCount}
                     </div>
                     <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        {scenarioIndex < scenarios.length - 1 ? 'Next Audit ‚Üí' : 'Complete Training'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      // Result Phase
      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = 180 + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-blue-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button
                              key={i}
                              onClick={() => { if (!quizAnswered) { if (i === quiz.correct) setScore(s => s + 10); setQuizAnswered(true); }}}
                              disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >
                              {opt}
                           </button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && (
                     <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
                        {quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}
                     </button>
                  )}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-blue-800 mb-4">üéâ Audit Prep Complete!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-blue-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                     <div className="text-lg font-semibold mt-2">
                        {percentage >= 90 ? 'üèÜ Audit Ready!' : percentage >= 70 ? 'üìã Well Prepared' : percentage >= 50 ? 'üìà Good Start' : 'üìö Keep Practicing'}
                     </div>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-lg">
                     <h3 className="font-bold text-blue-800 mb-2">Audit Prep Checklist:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Prioritize critical reconciliations first</li>
                        <li>‚Ä¢ Prepare PBC items before auditors arrive</li>
                        <li>‚Ä¢ Document all significant judgments</li>
                        <li>‚Ä¢ Clear old reconciling items</li>
                        <li>‚Ä¢ Test controls before external testing</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setChecklist({}); setSubmitted(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 30: Tax Structures - Understanding Business Entity Taxation
   const TaxStructuresRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedEntity, setSelectedEntity] = useState<string | null>(null);
      const [answered, setAnswered] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to Tax Structures!', content: 'Learn how different business entities are taxed. Choosing the right structure can save thousands in taxes and provide liability protection.' },
         { title: 'Sole Proprietorship', content: 'Simplest structure. No separate tax return - income flows to personal Form 1040 Schedule C. Self-employment tax applies (15.3%). No liability protection.' },
         { title: 'Partnership / LLC', content: 'Pass-through taxation: No entity-level tax. Partners report their share on personal returns (K-1). Flexibility in profit/loss allocation. LLC adds liability protection.' },
         { title: 'S Corporation', content: 'Pass-through taxation like partnership. Key benefit: Only "reasonable salary" subject to payroll tax. Remaining profits avoid self-employment tax. Limited to 100 shareholders.' },
         { title: 'C Corporation', content: 'Separate taxable entity (21% federal rate). Profits taxed at corporate level, then dividends taxed again = "Double Taxation." Best for reinvesting profits or going public.' },
         { title: 'Tax Planning Strategies', content: 'Choose based on: Income level, Need for liability protection, Plans for investors, Exit strategy. Many businesses start as LLC, convert to S-Corp as income grows.' },
         { title: 'Ready to Advise!', content: 'You\'ll recommend entity structures for different business scenarios. Consider taxes, liability, and growth plans!' }
      ];

      const scenarios = [
         {
            business: 'Sarah\'s Consulting',
            description: 'Solo marketing consultant earning $150K/year. No employees, no plans for investors. Wants liability protection.',
            income: 150000,
            factors: ['Solo owner', 'High income', 'Liability concern', 'No investors'],
            bestEntity: 's_corp',
            options: [
               { id: 'sole_prop', name: 'Sole Proprietorship', taxSavings: 0 },
               { id: 'llc', name: 'Single-Member LLC', taxSavings: 0 },
               { id: 's_corp', name: 'S Corporation', taxSavings: 12000 },
               { id: 'c_corp', name: 'C Corporation', taxSavings: -5000 }
            ],
            explanation: 'S-Corp allows Sarah to pay herself a reasonable salary (~$80K) and take remaining $70K as distributions, saving ~$10K in self-employment tax.'
         },
         {
            business: 'TechVenture Startup',
            description: 'Tech startup seeking VC funding. Plans to issue stock options to employees and eventually go public.',
            income: 500000,
            factors: ['VC funding needed', 'Stock options', 'IPO plans', 'Multiple share classes'],
            bestEntity: 'c_corp',
            options: [
               { id: 'sole_prop', name: 'Sole Proprietorship', taxSavings: 0 },
               { id: 'llc', name: 'LLC', taxSavings: 0 },
               { id: 's_corp', name: 'S Corporation', taxSavings: 0 },
               { id: 'c_corp', name: 'C Corporation (Delaware)', taxSavings: 0 }
            ],
            explanation: 'VCs require C-Corp structure. Allows multiple share classes, easy stock option plans, and standard IPO path. Delaware is preferred for investor-friendly laws.'
         },
         {
            business: 'Downtown Deli Partners',
            description: 'Three friends opening a restaurant. Each investing different amounts, want flexible profit sharing based on involvement.',
            income: 200000,
            factors: ['Multiple owners', 'Flexible allocation', 'Active involvement', 'Moderate income'],
            bestEntity: 'llc',
            options: [
               { id: 'sole_prop', name: 'Sole Proprietorship', taxSavings: 0 },
               { id: 'llc', name: 'LLC (Partnership)', taxSavings: 8000 },
               { id: 's_corp', name: 'S Corporation', taxSavings: 5000 },
               { id: 'c_corp', name: 'C Corporation', taxSavings: -10000 }
            ],
            explanation: 'LLC taxed as partnership offers maximum flexibility. Partners can allocate profits/losses based on involvement, not just ownership percentage. Liability protection included.'
         },
         {
            business: 'QuickFix Plumbing',
            description: 'Established plumbing business, $80K/year profit. Owner handles all work, occasionally hires helpers.',
            income: 80000,
            factors: ['Modest income', 'Solo operation', 'Simple needs', 'Minimal admin preferred'],
            bestEntity: 'llc',
            options: [
               { id: 'sole_prop', name: 'Sole Proprietorship', taxSavings: 0 },
               { id: 'llc', name: 'Single-Member LLC', taxSavings: 0 },
               { id: 's_corp', name: 'S Corporation', taxSavings: 2000 },
               { id: 'c_corp', name: 'C Corporation', taxSavings: -8000 }
            ],
            explanation: 'At $80K, S-Corp savings don\'t justify extra compliance costs. LLC provides liability protection with minimal paperwork. As income grows, reconsider S-Corp.'
         }
      ];

      const quizQuestions = [
         { q: 'Which entity type has "double taxation"?', options: ['LLC', 'S Corporation', 'C Corporation', 'Sole Proprietorship'], correct: 2 },
         { q: 'Pass-through taxation means:', options: ['Taxes are paid twice', 'Profits flow to owners\' personal returns', 'No taxes are owed', 'State taxes pass to federal'], correct: 1 },
         { q: 'Self-employment tax is approximately:', options: ['7.65%', '15.3%', '21%', '37%'], correct: 1 },
         { q: 'S Corporations are limited to:', options: ['10 shareholders', '50 shareholders', '100 shareholders', 'Unlimited shareholders'], correct: 2 },
         { q: 'VCs typically require which structure?', options: ['LLC', 'S Corporation', 'C Corporation', 'Partnership'], correct: 2 },
         { q: 'The main benefit of S-Corp over LLC is:', options: ['Liability protection', 'Simpler filing', 'Self-employment tax savings', 'Unlimited owners'], correct: 2 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const handleEntitySelect = (entityId: string) => {
         if (answered) return;
         setSelectedEntity(entityId);
         setAnswered(true);
         const scenario = scenarios[scenarioIndex];
         if (entityId === scenario.bestEntity) {
            setScore(s => s + 20);
            setGameLog(prev => [...prev, `Correct recommendation for ${scenario.business}`]);
         }
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedEntity(null);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-green-800 mb-4 flex items-center gap-2">
                  üèõÔ∏è Tax Structures
                  <button onClick={() => openInfo('Entity Selection Impact', 'Wrong structure can cost 10-20% extra in taxes. Consider: Current income, Growth plans, Need for investors, Liability exposure, Administrative burden.')} className="text-green-500 hover:text-green-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Choose the right business entity for tax efficiency!</p>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <div className="bg-blue-50 p-3 rounded-lg">
                        <div className="font-bold text-blue-800 text-sm">Pass-Through</div>
                        <div className="text-xs text-blue-600">LLC, S-Corp, Partnership</div>
                        <div className="text-xs text-gray-500">One level of tax</div>
                     </div>
                     <div className="bg-purple-50 p-3 rounded-lg">
                        <div className="font-bold text-purple-800 text-sm">Double Tax</div>
                        <div className="text-xs text-purple-600">C Corporation</div>
                        <div className="text-xs text-gray-500">Corp + dividend tax</div>
                     </div>
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-green-800">Tutorial</h2>
                  <span className="text-sm text-green-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>
                  {tutorialStep === 3 && (
                     <div className="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <div className="text-sm font-semibold text-green-800 mb-2">S-Corp Tax Savings Example:</div>
                        <div className="text-xs text-gray-600 space-y-1">
                           <div>Income: $150,000</div>
                           <div>Reasonable Salary: $80,000 (subject to payroll tax)</div>
                           <div>Distribution: $70,000 (NO payroll tax)</div>
                           <div className="text-green-700 font-bold">Savings: ~$10,700 in self-employment tax</div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-green-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Advising!'}
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         return (
            <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-green-800">{scenario.business}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-green-100 px-3 py-1 rounded-full text-green-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Case {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-5 rounded-xl mb-4">
                  <p className="text-gray-700 mb-3">{scenario.description}</p>
                  <div className="flex flex-wrap gap-2 mb-4">
                     {scenario.factors.map((factor, i) => (
                        <span key={i} className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">{factor}</span>
                     ))}
                  </div>
                  <div className="bg-amber-50 p-3 rounded-lg mb-4">
                     <span className="text-amber-800 text-sm font-semibold">Annual Income: ${scenario.income.toLocaleString()}</span>
                  </div>

                  <p className="font-semibold text-gray-800 mb-3">Recommend the best entity structure:</p>
                  <div className="grid grid-cols-2 gap-3">
                     {scenario.options.map(option => (
                        <button
                           key={option.id}
                           onClick={() => handleEntitySelect(option.id)}
                           disabled={answered}
                           className={`p-4 rounded-lg text-center transition-all border-2 ${
                              answered
                                 ? option.id === scenario.bestEntity
                                    ? 'bg-green-50 border-green-500'
                                    : selectedEntity === option.id
                                       ? 'bg-red-50 border-red-400'
                                       : 'bg-gray-50 border-gray-200'
                                 : 'bg-gray-50 border-gray-200 hover:border-green-400'
                           }`}
                        >
                           <div className="font-semibold text-sm">{option.name}</div>
                        </button>
                     ))}
                  </div>

                  {answered && (
                     <div className={`mt-4 p-4 rounded-xl ${selectedEntity === scenario.bestEntity ? 'bg-green-50 border-2 border-green-300' : 'bg-amber-50 border-2 border-amber-300'}`}>
                        <div className="font-bold mb-2">{selectedEntity === scenario.bestEntity ? '‚úÖ Excellent Advice!' : 'üìö Consider This:'}</div>
                        <p className="text-sm text-gray-700">{scenario.explanation}</p>
                        <button onClick={nextScenario} className="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                           {scenarioIndex < scenarios.length - 1 ? 'Next Client ‚Üí' : 'Complete Training'}
                        </button>
                     </div>
                  )}
               </div>
            </div>
         );
      }

      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 20) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-green-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button key={i} onClick={() => { if (!quizAnswered) { if (i === quiz.correct) setScore(s => s + 10); setQuizAnswered(true); }}} disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >{opt}</button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">{quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}</button>}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-green-800 mb-4">üéâ Tax Structure Expert!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-green-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                     <h3 className="font-bold text-green-800 mb-2">Entity Selection Guide:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Simple/low income ‚Üí LLC</li>
                        <li>‚Ä¢ High income, solo ‚Üí S-Corp</li>
                        <li>‚Ä¢ Need investors/IPO ‚Üí C-Corp</li>
                        <li>‚Ä¢ Multiple owners, flexible ‚Üí LLC/Partnership</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedEntity(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   // Topic 31: Sales Tax Nexus - Understanding Multi-State Tax Obligations
   const SalesTaxNexusRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [score, setScore] = useState(0);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [infoContent, setInfoContent] = useState({ title: '', content: '' });
      const [selectedStates, setSelectedStates] = useState<string[]>([]);
      const [answered, setAnswered] = useState(false);

      const tutorialSteps = [
         { title: 'Welcome to Sales Tax Nexus!', content: 'Learn when your business must collect sales tax in different states. Post-Wayfair, this affects almost every online seller.' },
         { title: 'What is Nexus?', content: 'Nexus = sufficient connection to a state requiring tax collection. Traditional: Physical presence (office, warehouse, employees). Economic: Sales volume or transaction count.' },
         { title: 'The Wayfair Decision (2018)', content: 'Supreme Court ruled states can require tax collection based on economic activity alone. Most states adopted thresholds: typically $100K in sales OR 200 transactions.' },
         { title: 'Common Thresholds', content: 'Most states: $100K sales OR 200 transactions. Some variations: California $500K, Texas $500K, New York $500K + 100 transactions. Always check current state rules!' },
         { title: 'Physical Nexus Triggers', content: 'Creates nexus: Office or store, Warehouse/inventory, Employees working, Trade shows (sometimes), Affiliate relationships. Remote workers can create nexus in their state!' },
         { title: 'Compliance Requirements', content: 'Once nexus exists: Register for sales tax permit, Collect appropriate rate, File returns (monthly/quarterly/annual), Remit tax collected. Penalties for non-compliance are severe!' },
         { title: 'Ready to Analyze!', content: 'You\'ll evaluate business activities and determine which states have nexus. Protect your business from tax liability!' }
      ];

      const scenarios = [
         {
            business: 'CloudSoft SaaS',
            description: 'Software company based in Texas. Sells subscriptions online to customers in all 50 states.',
            homeState: 'Texas',
            activities: [
               { state: 'Texas', activity: 'Headquarters with 20 employees', sales: 500000, transactions: 1000 },
               { state: 'California', activity: 'Remote sales rep works from home', sales: 250000, transactions: 400 },
               { state: 'New York', activity: 'Online sales only, no presence', sales: 150000, transactions: 180 },
               { state: 'Florida', activity: 'Online sales only, no presence', sales: 80000, transactions: 150 },
               { state: 'Washington', activity: 'Online sales only, no presence', sales: 120000, transactions: 250 }
            ],
            nexusStates: ['Texas', 'California', 'Washington'],
            explanation: 'Texas: HQ. California: Remote employee creates physical nexus. Washington: Exceeds $100K threshold. NY and FL below thresholds.'
         },
         {
            business: 'Artisan Goods Co',
            description: 'Handmade products sold on Etsy and own website. Ships from Ohio warehouse.',
            homeState: 'Ohio',
            activities: [
               { state: 'Ohio', activity: 'Warehouse and shipping operations', sales: 200000, transactions: 800 },
               { state: 'Pennsylvania', activity: 'Attends 4 craft fairs per year', sales: 45000, transactions: 300 },
               { state: 'Michigan', activity: 'Online sales only', sales: 110000, transactions: 220 },
               { state: 'Indiana', activity: 'Online sales only', sales: 60000, transactions: 180 },
               { state: 'Kentucky', activity: 'Online sales only', sales: 25000, transactions: 90 }
            ],
            nexusStates: ['Ohio', 'Pennsylvania', 'Michigan'],
            explanation: 'Ohio: Warehouse. PA: Trade show presence creates nexus. Michigan: Exceeds both thresholds. IN/KY below thresholds.'
         },
         {
            business: 'TechParts Wholesale',
            description: 'B2B electronics distributor. Uses third-party fulfillment centers.',
            homeState: 'New Jersey',
            activities: [
               { state: 'New Jersey', activity: 'Corporate office', sales: 800000, transactions: 500 },
               { state: 'Nevada', activity: '3PL warehouse stores inventory', sales: 400000, transactions: 200 },
               { state: 'Georgia', activity: 'Online sales only', sales: 180000, transactions: 150 },
               { state: 'Texas', activity: 'Online sales only', sales: 600000, transactions: 300 },
               { state: 'Illinois', activity: 'Online sales only', sales: 95000, transactions: 180 }
            ],
            nexusStates: ['New Jersey', 'Nevada', 'Georgia', 'Texas'],
            explanation: 'NJ: HQ. Nevada: Inventory in 3PL = physical nexus. Georgia & Texas: Exceed $100K. Illinois just under threshold.'
         }
      ];

      const quizQuestions = [
         { q: 'The Wayfair decision allowed states to require tax collection based on:', options: ['Physical presence only', 'Economic activity', 'Population size', 'Time zone'], correct: 1 },
         { q: 'The most common economic nexus threshold is:', options: ['$50K or 100 transactions', '$100K or 200 transactions', '$500K or 500 transactions', '$1M or 1000 transactions'], correct: 1 },
         { q: 'A remote employee working from home creates nexus in:', options: ['Only the company HQ state', 'The employee\'s state', 'All states', 'No states'], correct: 1 },
         { q: 'Inventory stored at a 3PL warehouse creates:', options: ['No nexus', 'Physical nexus', 'Economic nexus only', 'Temporary nexus'], correct: 1 },
         { q: 'Which is NOT typically a nexus trigger?', options: ['Office location', 'Trade show attendance', 'Advertising in a state', 'Warehouse'], correct: 2 },
         { q: 'Marketplace facilitators (Amazon, Etsy) are responsible for:', options: ['Nothing', 'Collecting and remitting tax', 'Only collecting', 'Only reporting'], correct: 1 }
      ];

      const openInfo = (title: string, content: string) => {
         setInfoContent({ title, content });
         setShowInfo(true);
      };

      const toggleState = (state: string) => {
         if (answered) return;
         setSelectedStates(prev => prev.includes(state) ? prev.filter(s => s !== state) : [...prev, state]);
      };

      const checkAnswer = () => {
         const scenario = scenarios[scenarioIndex];
         const correct = scenario.nexusStates.sort().join(',') === selectedStates.sort().join(',');
         if (correct) {
            setScore(s => s + 25);
            setGameLog(prev => [...prev, `Perfect nexus analysis for ${scenario.business}`]);
         } else {
            const partialScore = selectedStates.filter(s => scenario.nexusStates.includes(s)).length * 5;
            setScore(s => s + partialScore);
         }
         setAnswered(true);
      };

      const nextScenario = () => {
         if (scenarioIndex < scenarios.length - 1) {
            setScenarioIndex(scenarioIndex + 1);
            setSelectedStates([]);
            setAnswered(false);
         } else {
            setPhase('result');
         }
      };

      if (phase === 'intro') {
         return (
            <div className="p-6 bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-orange-800 mb-4 flex items-center gap-2">
                  üó∫Ô∏è Sales Tax Nexus
                  <button onClick={() => openInfo('Nexus Penalties', 'Failing to collect required sales tax can result in: Back taxes owed, Interest charges, Penalties up to 25%, Personal liability for owners. States are actively auditing!')} className="text-orange-500 hover:text-orange-700">‚ÑπÔ∏è</button>
               </h2>
               <div className="bg-white/80 p-5 rounded-xl mb-6">
                  <p className="text-gray-700 mb-4">Determine where your business must collect sales tax!</p>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                     <div className="bg-blue-50 p-3 rounded-lg">
                        <div className="font-bold text-blue-800 text-sm">Physical Nexus</div>
                        <div className="text-xs text-blue-600">Office, warehouse, employees</div>
                     </div>
                     <div className="bg-green-50 p-3 rounded-lg">
                        <div className="font-bold text-green-800 text-sm">Economic Nexus</div>
                        <div className="text-xs text-green-600">$100K sales OR 200 transactions</div>
                     </div>
                  </div>
               </div>
               <button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700 transition-all">Start Learning</button>
               {showInfo && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowInfo(false)}>
                     <div className="bg-white p-6 rounded-xl max-w-md m-4" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-2">{infoContent.title}</h3>
                        <p className="text-gray-600">{infoContent.content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="p-6 bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-orange-800">Tutorial</h2>
                  <span className="text-sm text-orange-600">Step {tutorialStep + 1} of {tutorialSteps.length}</span>
               </div>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{step.title}</h3>
                  <p className="text-gray-600">{step.content}</p>
                  {tutorialStep === 3 && (
                     <div className="mt-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div className="text-sm font-semibold text-orange-800 mb-2">Common State Thresholds:</div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                           <div>Most states: $100K / 200 tx</div>
                           <div>California: $500K</div>
                           <div>Texas: $500K</div>
                           <div>New York: $500K + 100 tx</div>
                        </div>
                     </div>
                  )}
               </div>
               <div className="w-full bg-gray-200 rounded-full h-2 mb-4">
                  <div className="bg-orange-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }}></div>
               </div>
               <div className="flex gap-3">
                  {tutorialStep > 0 && <button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Back</button>}
                  <button onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(tutorialStep + 1) : setPhase('play')} className="flex-1 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                     {tutorialStep < tutorialSteps.length - 1 ? 'Next' : 'Start Analysis!'}
                  </button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const scenario = scenarios[scenarioIndex];
         return (
            <div className="p-6 bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl max-w-2xl mx-auto">
               <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-orange-800">{scenario.business}</h2>
                  <div className="flex items-center gap-3">
                     <span className="bg-orange-100 px-3 py-1 rounded-full text-orange-700 text-sm">Score: {score}</span>
                     <span className="text-sm text-gray-500">Case {scenarioIndex + 1}/{scenarios.length}</span>
                  </div>
               </div>

               <div className="bg-white/90 p-4 rounded-xl mb-4">
                  <p className="text-gray-700 mb-3">{scenario.description}</p>
                  <p className="font-semibold text-gray-800 mb-3">Select ALL states where nexus exists:</p>

                  <div className="space-y-2">
                     {scenario.activities.map(act => (
                        <button
                           key={act.state}
                           onClick={() => toggleState(act.state)}
                           disabled={answered}
                           className={`w-full p-3 rounded-lg text-left flex justify-between items-center transition-all border-2 ${
                              answered
                                 ? scenario.nexusStates.includes(act.state)
                                    ? 'bg-green-50 border-green-500'
                                    : selectedStates.includes(act.state)
                                       ? 'bg-red-50 border-red-400'
                                       : 'bg-gray-50 border-gray-200'
                                 : selectedStates.includes(act.state)
                                    ? 'bg-orange-100 border-orange-400'
                                    : 'bg-gray-50 border-gray-200 hover:border-orange-300'
                           }`}
                        >
                           <div>
                              <div className="font-semibold text-sm">{act.state}</div>
                              <div className="text-xs text-gray-500">{act.activity}</div>
                           </div>
                           <div className="text-right text-xs">
                              <div className="text-gray-600">${act.sales.toLocaleString()} sales</div>
                              <div className="text-gray-500">{act.transactions} transactions</div>
                           </div>
                        </button>
                     ))}
                  </div>
               </div>

               {!answered ? (
                  <button onClick={checkAnswer} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700">
                     Submit Nexus Analysis
                  </button>
               ) : (
                  <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-300">
                     <div className="font-bold mb-2">Nexus States: {scenario.nexusStates.join(', ')}</div>
                     <p className="text-sm text-gray-700 mb-3">{scenario.explanation}</p>
                     <button onClick={nextScenario} className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        {scenarioIndex < scenarios.length - 1 ? 'Next Business ‚Üí' : 'Complete Training'}
                     </button>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         const quiz = quizQuestions[quizIndex];
         const maxScore = (scenarios.length * 25) + (quizQuestions.length * 10);
         const percentage = Math.round((score / maxScore) * 100);

         if (quizIndex < quizQuestions.length) {
            return (
               <div className="p-6 bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl max-w-2xl mx-auto">
                  <h2 className="text-xl font-bold text-orange-800 mb-4">Knowledge Check</h2>
                  <div className="bg-white/90 p-5 rounded-xl mb-4">
                     <div className="text-sm text-gray-500 mb-2">Question {quizIndex + 1} of {quizQuestions.length}</div>
                     <p className="font-semibold text-gray-800 mb-4">{quiz.q}</p>
                     <div className="grid gap-2">
                        {quiz.options.map((opt, i) => (
                           <button key={i} onClick={() => { if (!quizAnswered) { if (i === quiz.correct) setScore(s => s + 10); setQuizAnswered(true); }}} disabled={quizAnswered}
                              className={`p-3 rounded-lg text-left transition-all ${quizAnswered ? (i === quiz.correct ? 'bg-green-100 border-green-500' : 'bg-gray-100') : 'bg-gray-50 hover:bg-gray-100'} border-2 ${quizAnswered && i === quiz.correct ? 'border-green-500' : 'border-transparent'}`}
                           >{opt}</button>
                        ))}
                     </div>
                  </div>
                  {quizAnswered && <button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700">{quizIndex < quizQuestions.length - 1 ? 'Next Question' : 'See Results'}</button>}
               </div>
            );
         }

         return (
            <div className="p-6 bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl max-w-2xl mx-auto">
               <h2 className="text-2xl font-bold text-orange-800 mb-4">üéâ Nexus Expert!</h2>
               <div className="bg-white/90 p-6 rounded-xl mb-6">
                  <div className="text-center mb-6">
                     <div className="text-5xl font-bold text-orange-600 mb-2">{percentage}%</div>
                     <div className="text-gray-600">Final Score: {score} / {maxScore}</div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-lg">
                     <h3 className="font-bold text-orange-800 mb-2">Nexus Checklist:</h3>
                     <ul className="text-sm text-gray-700 space-y-1">
                        <li>‚Ä¢ Monitor sales by state monthly</li>
                        <li>‚Ä¢ Track remote employee locations</li>
                        <li>‚Ä¢ Review 3PL and inventory locations</li>
                        <li>‚Ä¢ Register before threshold is crossed</li>
                        <li>‚Ä¢ Use automated tax software</li>
                     </ul>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedStates([]); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   const PayrollProcessingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedCalcs, setSelectedCalcs] = useState<{[key: string]: number}>({});
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         fica: { title: 'FICA Taxes', content: 'Federal Insurance Contributions Act taxes include Social Security (6.2% up to wage base) and Medicare (1.45% + 0.9% additional for high earners). Employers match the employee portion.' },
         federal_withholding: { title: 'Federal Income Tax Withholding', content: 'Based on W-4 form, filing status, allowances, and tax tables. Uses progressive tax brackets with marginal rates.' },
         state_withholding: { title: 'State Income Tax', content: 'Varies by state - some have flat rates, progressive brackets, or no income tax. Must withhold for work state and sometimes residence state.' },
         pretax_deductions: { title: 'Pre-Tax Deductions', content: '401(k) contributions, health insurance, HSA, FSA reduce taxable income before calculating withholding. Saves employees on taxes.' },
         posttax_deductions: { title: 'Post-Tax Deductions', content: 'Roth 401(k), garnishments, voluntary benefits taken after taxes. Dont reduce taxable income but must track separately.' },
         employer_taxes: { title: 'Employer Payroll Taxes', content: 'FUTA (6% on first $7,000, usually 0.6% after credit), SUTA (varies by state and experience rating), employer FICA match.' },
         pay_frequency: { title: 'Pay Frequency Considerations', content: 'Weekly, bi-weekly, semi-monthly, monthly affect withholding calculations. Annual salary √∑ pay periods. Overtime calculated weekly regardless.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Payroll Processing', content: 'Learn to calculate gross pay, withholdings, deductions, and employer taxes. Master the paycheck journey from gross to net.' },
         { title: 'Gross Pay Calculation', content: 'Start with base pay. For hourly: hours √ó rate. For salary: annual √∑ pay periods. Add overtime (1.5x after 40 hours weekly), bonuses, commissions.' },
         { title: 'Pre-Tax Deductions', content: 'Subtract 401(k), health insurance, HSA, FSA before calculating taxes. These reduce taxable income and save the employee money.' },
         { title: 'FICA Withholding', content: 'Calculate Social Security (6.2% up to $168,600 in 2024) and Medicare (1.45% + 0.9% above $200K). Apply to taxable wages after pre-tax deductions.' },
         { title: 'Income Tax Withholding', content: 'Use W-4 info, pay frequency, and tax tables. Federal uses progressive brackets. State varies - check specific rules.' },
         { title: 'Post-Tax Deductions', content: 'Subtract Roth contributions, garnishments, union dues after taxes. These dont reduce the tax burden but come out of net pay.' },
         { title: 'Employer Payroll Taxes', content: 'Employers pay matching FICA, plus FUTA and SUTA. Total employer cost exceeds gross pay by 7-10% typically.' }
      ];

      const scenarios = [
         {
            title: 'Standard Bi-Weekly Payroll',
            employee: { name: 'Sarah Martinez', salary: 75000, payFrequency: 'bi-weekly', filingStatus: 'single', state: 'CA' },
            deductions: { health: 200, dental: 25, vision: 10, retirement401k: 6 },
            grossPay: 2884.62,
            calculations: {
               preTaxDeductions: { value: 408.08, label: 'Pre-Tax Deductions', items: 'Health $200 + Dental $25 + Vision $10 + 401k 6% = $173.08' },
               taxableWages: { value: 2476.54, label: 'Taxable Wages', items: 'Gross - Pre-Tax' },
               socialSecurity: { value: 153.55, label: 'Social Security', items: '6.2% of taxable wages' },
               medicare: { value: 35.91, label: 'Medicare', items: '1.45% of taxable wages' },
               federalTax: { value: 289.00, label: 'Federal Withholding', items: 'Single, bi-weekly, using tax tables' },
               stateTax: { value: 86.30, label: 'CA State Tax', items: 'California progressive rates' },
               netPay: { value: 1911.78, label: 'Net Pay', items: 'Taxable - All Withholdings' }
            }
         },
         {
            title: 'Hourly with Overtime',
            employee: { name: 'Mike Thompson', hourlyRate: 28, hoursWorked: 48, payFrequency: 'weekly', filingStatus: 'married', state: 'TX' },
            deductions: { health: 150, retirement401k: 4 },
            grossPay: 1456.00,
            calculations: {
               regularPay: { value: 1120.00, label: 'Regular Pay', items: '40 hours √ó $28' },
               overtimePay: { value: 336.00, label: 'Overtime Pay', items: '8 hours √ó $42 (1.5√ó)' },
               preTaxDeductions: { value: 208.24, label: 'Pre-Tax Deductions', items: 'Health $150 + 401k 4% = $58.24' },
               taxableWages: { value: 1247.76, label: 'Taxable Wages', items: 'Gross - Pre-Tax' },
               socialSecurity: { value: 77.36, label: 'Social Security', items: '6.2% of taxable wages' },
               medicare: { value: 18.09, label: 'Medicare', items: '1.45% of taxable wages' },
               federalTax: { value: 98.00, label: 'Federal Withholding', items: 'MFJ, weekly tables' },
               netPay: { value: 1054.31, label: 'Net Pay', items: 'No state tax in Texas' }
            }
         },
         {
            title: 'High Earner with Additional Medicare',
            employee: { name: 'Jennifer Wu', salary: 280000, payFrequency: 'semi-monthly', filingStatus: 'single', state: 'NY' },
            deductions: { health: 400, hsa: 150, retirement401k: 10, roth401k: 5 },
            grossPay: 11666.67,
            calculations: {
               preTaxDeductions: { value: 1716.67, label: 'Pre-Tax Deductions', items: 'Health $400 + HSA $150 + 401k 10% = $1166.67' },
               taxableWages: { value: 9950.00, label: 'Taxable Wages', items: 'Gross - Pre-Tax' },
               socialSecurity: { value: 616.90, label: 'Social Security', items: '6.2% (not yet at wage base)' },
               medicare: { value: 144.28, label: 'Medicare', items: '1.45% base rate' },
               additionalMedicare: { value: 89.55, label: 'Additional Medicare', items: '0.9% (income > $200K)' },
               federalTax: { value: 2890.00, label: 'Federal Withholding', items: 'Single, 35% marginal bracket' },
               stateTax: { value: 685.00, label: 'NY State Tax', items: 'NY progressive + NYC tax' },
               rothDeduction: { value: 583.33, label: 'Roth 401k (Post-Tax)', items: '5% after-tax contribution' },
               netPay: { value: 4940.94, label: 'Net Pay', items: 'After all deductions' }
            }
         },
         {
            title: 'Employee with Garnishment',
            employee: { name: 'Robert Chen', salary: 52000, payFrequency: 'bi-weekly', filingStatus: 'single', state: 'FL' },
            deductions: { health: 175, retirement401k: 3, childSupport: 450 },
            grossPay: 2000.00,
            calculations: {
               preTaxDeductions: { value: 235.00, label: 'Pre-Tax Deductions', items: 'Health $175 + 401k 3% = $60' },
               taxableWages: { value: 1765.00, label: 'Taxable Wages', items: 'Gross - Pre-Tax' },
               socialSecurity: { value: 109.43, label: 'Social Security', items: '6.2% of taxable wages' },
               medicare: { value: 25.59, label: 'Medicare', items: '1.45% of taxable wages' },
               federalTax: { value: 158.00, label: 'Federal Withholding', items: 'Single, bi-weekly' },
               garnishment: { value: 450.00, label: 'Child Support', items: 'Court-ordered garnishment' },
               netPay: { value: 1022.98, label: 'Net Pay', items: 'FL has no state tax' }
            }
         }
      ];

      const quizQuestions = [
         { q: 'Pre-tax deductions reduce which amount?', options: ['Gross pay', 'Taxable wages for withholding', 'FUTA wages', 'Net pay'], correct: 1 },
         { q: 'When does the additional 0.9% Medicare tax apply?', options: ['All wages', 'Wages over $168,600', 'Wages over $200,000', 'Only self-employment'], correct: 2 },
         { q: 'Overtime is calculated based on what time period?', options: ['Daily hours over 8', 'Weekly hours over 40', 'Bi-weekly hours over 80', 'Monthly total'], correct: 1 },
         { q: 'Which is a post-tax deduction?', options: ['Health insurance premium', '401(k) contribution', 'Court-ordered garnishment', 'HSA contribution'], correct: 2 },
         { q: 'What does the employer pay that employees dont?', options: ['Social Security', 'Medicare', 'FUTA and SUTA', 'State income tax'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">üí∞</div>
                  <h2 className="text-2xl font-bold text-blue-800">Payroll Processing Master</h2>
                  <p className="text-gray-600 mt-2">Calculate paychecks from gross to net</p>
               </div>
               <div className="bg-blue-50 p-4 rounded-xl">
                  <h3 className="font-semibold text-blue-800 mb-2">What You'll Learn:</h3>
                  <ul className="space-y-1 text-sm text-gray-700">
                     <li>‚úì Gross pay calculations including overtime</li>
                     <li>‚úì Pre-tax and post-tax deduction handling</li>
                     <li>‚úì FICA tax calculations (Social Security & Medicare)</li>
                     <li>‚úì Federal and state withholding</li>
                     <li>‚úì Employer payroll tax obligations</li>
                  </ul>
               </div>
               <button onClick={() => { setPhase('tutorial'); setGameLog(['Started payroll processing tutorial']); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="space-y-6">
               <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-500">Tutorial {tutorialStep + 1} of {tutorialSteps.length}</span>
                  <div className="flex gap-1">
                     {tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-blue-600' : 'bg-gray-200'}`} />))}
                  </div>
               </div>
               <div className="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-blue-800 mb-3">{step.title}</h3>
                  <p className="text-gray-700">{step.content}</p>
               </div>
               <div className="flex gap-2">
                  {tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">‚Üê Back</button>)}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); setGameLog([...gameLog, 'Completed tutorial, starting scenarios']); } }} className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         const calcKeys = Object.keys(sc.calculations);
         const allCorrect = calcKeys.every(key => selectedCalcs[key] === (sc.calculations as any)[key].value);

         return (
            <div className="space-y-4">
               <div className="flex justify-between items-center">
                  <span className="text-sm font-medium text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span>
                  <span className="text-sm font-semibold text-green-600">Score: {score}</span>
               </div>
               <div className="bg-gradient-to-r from-green-50 to-emerald-100 p-4 rounded-xl">
                  <div className="flex justify-between items-start">
                     <h3 className="font-bold text-green-800">{sc.title}</h3>
                     <button onClick={() => { setShowInfo(true); setInfoTopic('pay_frequency'); }} className="text-green-600 hover:text-green-800">‚ÑπÔ∏è</button>
                  </div>
                  <div className="mt-2 text-sm text-gray-700 space-y-1">
                     <p><strong>Employee:</strong> {sc.employee.name}</p>
                     {'salary' in sc.employee && <p><strong>Salary:</strong> ${sc.employee.salary.toLocaleString()}/year ({sc.employee.payFrequency})</p>}
                     {'hourlyRate' in sc.employee && <p><strong>Rate:</strong> ${(sc.employee as any).hourlyRate}/hr | Hours: {(sc.employee as any).hoursWorked}</p>}
                     <p><strong>Filing Status:</strong> {sc.employee.filingStatus} | <strong>State:</strong> {sc.employee.state}</p>
                     <p><strong>Gross Pay This Period:</strong> ${sc.grossPay.toFixed(2)}</p>
                  </div>
               </div>

               <div className="space-y-3">
                  <h4 className="font-semibold text-gray-700">Match Each Calculation:</h4>
                  {calcKeys.map((key, i) => {
                     const calc = (sc.calculations as any)[key];
                     const isSelected = selectedCalcs[key] !== undefined;
                     const isCorrect = selectedCalcs[key] === calc.value;
                     return (
                        <div key={key} className={`p-3 rounded-lg border-2 ${isSelected ? (isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50') : 'border-gray-200 bg-white'}`}>
                           <div className="flex justify-between items-center">
                              <div className="flex items-center gap-2">
                                 <span className="font-medium">{calc.label}</span>
                                 <button onClick={() => { setShowInfo(true); setInfoTopic(key.includes('social') ? 'fica' : key.includes('federal') ? 'federal_withholding' : key.includes('state') ? 'state_withholding' : key.includes('pre') ? 'pretax_deductions' : 'posttax_deductions'); }} className="text-blue-500 text-sm">‚ÑπÔ∏è</button>
                              </div>
                              {!answered && (
                                 <select value={selectedCalcs[key] || ''} onChange={(e) => setSelectedCalcs({...selectedCalcs, [key]: parseFloat(e.target.value)})} className="p-1 border rounded text-sm">
                                    <option value="">Select...</option>
                                    {[...calcKeys.map(k => (sc.calculations as any)[k].value)].sort((a, b) => a - b).map(v => (<option key={v} value={v}>${v.toFixed(2)}</option>))}
                                 </select>
                              )}
                              {answered && <span className={`font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>${calc.value.toFixed(2)}</span>}
                           </div>
                           {answered && <p className="text-xs text-gray-600 mt-1">{calc.items}</p>}
                        </div>
                     );
                  })}
               </div>

               {!answered ? (
                  <button onClick={() => { setAnswered(true); const correct = calcKeys.filter(key => selectedCalcs[key] === (sc.calculations as any)[key].value).length; setScore(score + correct); setGameLog([...gameLog, `Scenario ${scenarioIndex + 1}: ${correct}/${calcKeys.length} correct`]); }} disabled={Object.keys(selectedCalcs).length < calcKeys.length} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 disabled:bg-gray-300">Check Calculations</button>
               ) : (
                  <div className="space-y-3">
                     <div className={`p-3 rounded-lg ${allCorrect ? 'bg-green-100 border border-green-300' : 'bg-yellow-100 border border-yellow-300'}`}>
                        <p className="font-semibold">{allCorrect ? '‚úÖ Perfect! All calculations correct!' : `üìä ${calcKeys.filter(key => selectedCalcs[key] === (sc.calculations as any)[key].value).length}/${calcKeys.length} correct. Review the items above.`}</p>
                     </div>
                     <button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedCalcs({}); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'See Results ‚Üí'}</button>
                  </div>
               )}

               {showInfo && infoTopic && infoContent[infoTopic] && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                     <div className="bg-white rounded-xl p-6 max-w-md">
                        <h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3>
                        <p className="text-gray-700">{infoContent[infoTopic].content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg">Got It</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (
               <div className="space-y-6">
                  <div className="text-center">
                     <h3 className="text-xl font-bold text-blue-800">Final Assessment</h3>
                     <p className="text-sm text-gray-500">Question {quizIndex + 1} of {quizQuestions.length}</p>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-xl">
                     <p className="font-medium text-gray-800">{q.q}</p>
                  </div>
                  <div className="space-y-2">
                     {q.options.map((opt, i) => (
                        <button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) { setQuizScore(quizScore + 1); setGameLog([...gameLog, `Quiz ${quizIndex + 1}: Correct`]); } else { setGameLog([...gameLog, `Quiz ${quizIndex + 1}: Incorrect`]); } } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 transition-all ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>
                     ))}
                  </div>
                  {quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Next Question ‚Üí</button>)}
               </div>
            );
         }

         const totalPossible = scenarios.reduce((acc, sc) => acc + Object.keys(sc.calculations).length, 0);
         const percentage = Math.round(((score + quizScore) / (totalPossible + quizQuestions.length)) * 100);
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h2 className="text-2xl font-bold text-blue-800">Payroll Complete!</h2>
               </div>
               <div className="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-xl">
                  <div className="grid grid-cols-2 gap-4 text-center">
                     <div>
                        <div className="text-3xl font-bold text-blue-600">{score}/{totalPossible}</div>
                        <div className="text-sm text-gray-600">Calculations</div>
                     </div>
                     <div>
                        <div className="text-3xl font-bold text-green-600">{quizScore}/{quizQuestions.length}</div>
                        <div className="text-sm text-gray-600">Quiz Score</div>
                     </div>
                  </div>
                  <div className="mt-4 text-center">
                     <div className="text-4xl font-bold text-indigo-600">{percentage}%</div>
                     <div className="text-sm text-gray-600">Overall Mastery</div>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedCalcs({}); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   const TimeValueMoneyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [calculatorMode, setCalculatorMode] = useState<'pv' | 'fv' | 'pmt'>('fv');
      const [calcInputs, setCalcInputs] = useState({ pv: 1000, fv: 0, rate: 5, periods: 10, pmt: 0 });
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         present_value: { title: 'Present Value (PV)', content: 'The current worth of a future sum of money. PV = FV / (1+r)^n. A dollar today is worth more than a dollar tomorrow because of earning potential.' },
         future_value: { title: 'Future Value (FV)', content: 'The value of money at a specified date in the future. FV = PV √ó (1+r)^n. Shows how investments grow over time with compound interest.' },
         discount_rate: { title: 'Discount Rate', content: 'The rate used to convert future values to present values. Reflects opportunity cost, risk, and inflation. Higher risk = higher discount rate.' },
         compounding: { title: 'Compounding', content: 'Interest earned on interest. More frequent compounding (monthly vs annual) yields higher returns. The Rule of 72: years to double ‚âà 72/rate.' },
         annuity: { title: 'Annuities', content: 'A series of equal payments over time. Ordinary annuity pays at end of period; Annuity due pays at beginning. Used for loans, leases, retirement.' },
         perpetuity: { title: 'Perpetuity', content: 'An infinite stream of equal payments. PV = Payment / Rate. Used to value preferred stock, endowments, and terminal values.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Time Value of Money', content: 'Master the fundamental concept that money available now is worth more than the same amount in the future due to its earning potential.' },
         { title: 'Present Value Concept', content: '$100 today vs $100 in 5 years? Today wins! You could invest that $100 and earn returns. PV helps us compare money across time.' },
         { title: 'Future Value Calculation', content: 'FV = PV √ó (1+r)^n. $1,000 at 8% for 10 years = $1,000 √ó (1.08)^10 = $2,159. Compound interest is the 8th wonder of the world!' },
         { title: 'Present Value Calculation', content: 'PV = FV / (1+r)^n. What is $2,159 in 10 years worth today at 8%? PV = $2,159 / (1.08)^10 = $1,000. We discount future cash.' },
         { title: 'Choosing Discount Rates', content: 'Higher risk = higher rate. Government bonds ~3%, Corporate bonds ~6%, Startups 20%+. The rate reflects opportunity cost and risk.' },
         { title: 'Annuities and Perpetuities', content: 'Equal payments over time. Mortgage payments, retirement withdrawals, dividend streams. Special formulas make these easier to calculate.' },
         { title: 'Real-World Applications', content: 'Compare investment options, value bonds, calculate loan payments, plan retirement. TVM is the foundation of all financial decisions.' }
      ];

      const scenarios = [
         {
            title: 'Investment Comparison',
            context: 'You can receive $10,000 today OR $15,000 in 5 years. Your alternative investments earn 8% annually.',
            question: 'Which option has higher present value?',
            options: [
               { text: '$10,000 today', value: 10000 },
               { text: '$15,000 in 5 years (PV: $10,209)', value: 10209 }
            ],
            correct: 1,
            explanation: 'PV of $15,000 at 8% for 5 years = $15,000 / (1.08)^5 = $10,209. This exceeds $10,000 today by $209!'
         },
         {
            title: 'Retirement Planning',
            context: 'You want $1,000,000 at retirement in 30 years. Expected return is 7% annually.',
            question: 'How much must you invest today (lump sum)?',
            options: [
               { text: '$131,367', value: 131367 },
               { text: '$333,333', value: 333333 },
               { text: '$500,000', value: 500000 },
               { text: '$761,225', value: 761225 }
            ],
            correct: 0,
            explanation: 'PV = $1,000,000 / (1.07)^30 = $131,367. The power of compound interest means you only need to invest 13% of your goal today!'
         },
         {
            title: 'Lottery Decision',
            context: 'Win $5M today OR $300,000/year for 25 years. Discount rate 6%.',
            question: 'Which has higher present value?',
            options: [
               { text: '$5M lump sum', value: 5000000 },
               { text: '$300K/year for 25 years (PV: $3.83M)', value: 3834000 }
            ],
            correct: 0,
            explanation: 'PV of annuity = $300K √ó [(1-(1.06)^-25)/0.06] = $3.83M. The lump sum ($5M) is worth more! Always run the numbers.'
         },
         {
            title: 'Bond Valuation',
            context: 'A bond pays $50 annually for 10 years plus $1,000 at maturity. Market rate is 6%.',
            question: 'What is the fair price of this bond?',
            options: [
               { text: '$926.40', value: 926 },
               { text: '$1,000.00', value: 1000 },
               { text: '$1,073.60', value: 1074 },
               { text: '$1,500.00', value: 1500 }
            ],
            correct: 0,
            explanation: 'PV of coupons ($368.00) + PV of principal ($558.39) = $926.40. Since coupon (5%) < market (6%), bond trades at discount.'
         }
      ];

      const quizQuestions = [
         { q: 'Which has a higher PV: $1,000 today or $1,000 in one year?', options: ['$1,000 today', '$1,000 in one year', 'They are equal', 'Depends on inflation'], correct: 0 },
         { q: 'What happens to PV as discount rate increases?', options: ['PV increases', 'PV decreases', 'PV stays the same', 'Cannot determine'], correct: 1 },
         { q: 'What is the PV of a $100 perpetuity at 5%?', options: ['$500', '$1,000', '$2,000', '$5,000'], correct: 2 },
         { q: 'Using Rule of 72, how long to double at 9%?', options: ['6 years', '8 years', '9 years', '12 years'], correct: 1 },
         { q: 'Which compounding frequency yields highest FV?', options: ['Annual', 'Semi-annual', 'Quarterly', 'Daily'], correct: 3 }
      ];

      const calculateFV = () => Math.round(calcInputs.pv * Math.pow(1 + calcInputs.rate / 100, calcInputs.periods) * 100) / 100;
      const calculatePV = () => Math.round(calcInputs.fv / Math.pow(1 + calcInputs.rate / 100, calcInputs.periods) * 100) / 100;

      if (phase === 'intro') {
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">‚è∞</div>
                  <h2 className="text-2xl font-bold text-indigo-800">Time Value of Money</h2>
                  <p className="text-gray-600 mt-2">Master the foundation of all finance</p>
               </div>
               <div className="bg-indigo-50 p-4 rounded-xl">
                  <h3 className="font-semibold text-indigo-800 mb-2">What You'll Learn:</h3>
                  <ul className="space-y-1 text-sm text-gray-700">
                     <li>‚úì Present Value and Future Value calculations</li>
                     <li>‚úì Discount rates and opportunity cost</li>
                     <li>‚úì Compound interest and the Rule of 72</li>
                     <li>‚úì Annuities and perpetuities</li>
                     <li>‚úì Real-world investment decisions</li>
                  </ul>
               </div>
               <button onClick={() => { setPhase('tutorial'); setGameLog(['Started TVM tutorial']); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="space-y-6">
               <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-500">Tutorial {tutorialStep + 1} of {tutorialSteps.length}</span>
                  <div className="flex gap-1">
                     {tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-indigo-600' : 'bg-gray-200'}`} />))}
                  </div>
               </div>
               <div className="bg-gradient-to-br from-indigo-50 to-purple-100 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-indigo-800 mb-3">{step.title}</h3>
                  <p className="text-gray-700">{step.content}</p>
               </div>
               {tutorialStep === 2 && (
                  <div className="bg-white border-2 border-indigo-200 p-4 rounded-xl">
                     <h4 className="font-semibold text-indigo-700 mb-2">Try the Calculator:</h4>
                     <div className="grid grid-cols-3 gap-2 text-sm">
                        <div><label className="text-gray-600">PV ($)</label><input type="number" value={calcInputs.pv} onChange={(e) => setCalcInputs({...calcInputs, pv: parseFloat(e.target.value) || 0})} className="w-full p-1 border rounded" /></div>
                        <div><label className="text-gray-600">Rate (%)</label><input type="number" value={calcInputs.rate} onChange={(e) => setCalcInputs({...calcInputs, rate: parseFloat(e.target.value) || 0})} className="w-full p-1 border rounded" /></div>
                        <div><label className="text-gray-600">Years</label><input type="number" value={calcInputs.periods} onChange={(e) => setCalcInputs({...calcInputs, periods: parseInt(e.target.value) || 0})} className="w-full p-1 border rounded" /></div>
                     </div>
                     <div className="mt-3 p-3 bg-indigo-100 rounded-lg text-center">
                        <span className="text-gray-600">Future Value = </span>
                        <span className="text-2xl font-bold text-indigo-700">${calculateFV().toLocaleString()}</span>
                     </div>
                  </div>
               )}
               <div className="flex gap-2">
                  {tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50">‚Üê Back</button>)}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); setGameLog([...gameLog, 'Completed tutorial']); } }} className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (
            <div className="space-y-4">
               <div className="flex justify-between items-center">
                  <span className="text-sm font-medium text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span>
                  <span className="text-sm font-semibold text-green-600">Score: {score}/{scenarioIndex}</span>
               </div>
               <div className="bg-gradient-to-r from-indigo-50 to-purple-100 p-4 rounded-xl">
                  <div className="flex justify-between items-start">
                     <h3 className="font-bold text-indigo-800">{sc.title}</h3>
                     <button onClick={() => { setShowInfo(true); setInfoTopic('present_value'); }} className="text-indigo-600 hover:text-indigo-800">‚ÑπÔ∏è</button>
                  </div>
                  <p className="mt-2 text-gray-700">{sc.context}</p>
                  <p className="mt-2 font-medium text-indigo-700">{sc.question}</p>
               </div>

               <div className="space-y-2">
                  {sc.options.map((opt, i) => (
                     <button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 transition-all ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-indigo-400'}`}>{opt.text}</button>
                  ))}
               </div>

               {!answered ? (
                  <button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Scenario ${scenarioIndex + 1}: Correct`]); } else { setGameLog([...gameLog, `Scenario ${scenarioIndex + 1}: Incorrect`]); } }} disabled={selectedAnswer === null} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 disabled:bg-gray-300">Check Answer</button>
               ) : (
                  <div className="space-y-3">
                     <div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100 border border-green-300' : 'bg-yellow-100 border border-yellow-300'}`}>
                        <p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p>
                        <p className="text-sm text-gray-700 mt-1">{sc.explanation}</p>
                     </div>
                     <button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'See Results ‚Üí'}</button>
                  </div>
               )}

               {showInfo && infoTopic && infoContent[infoTopic] && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                     <div className="bg-white rounded-xl p-6 max-w-md">
                        <h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3>
                        <p className="text-gray-700">{infoContent[infoTopic].content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-indigo-600 text-white rounded-lg">Got It</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (
               <div className="space-y-6">
                  <div className="text-center">
                     <h3 className="text-xl font-bold text-indigo-800">Final Assessment</h3>
                     <p className="text-sm text-gray-500">Question {quizIndex + 1} of {quizQuestions.length}</p>
                  </div>
                  <div className="bg-indigo-50 p-4 rounded-xl">
                     <p className="font-medium text-gray-800">{q.q}</p>
                  </div>
                  <div className="space-y-2">
                     {q.options.map((opt, i) => (
                        <button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) { setQuizScore(quizScore + 1); } } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-indigo-400'}`}>{opt}</button>
                     ))}
                  </div>
                  {quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">Next Question ‚Üí</button>)}
               </div>
            );
         }

         const percentage = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üí∞' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h2 className="text-2xl font-bold text-indigo-800">TVM Mastery Complete!</h2>
               </div>
               <div className="bg-gradient-to-br from-indigo-50 to-purple-100 p-6 rounded-xl">
                  <div className="grid grid-cols-2 gap-4 text-center">
                     <div>
                        <div className="text-3xl font-bold text-indigo-600">{score}/{scenarios.length}</div>
                        <div className="text-sm text-gray-600">Scenarios</div>
                     </div>
                     <div>
                        <div className="text-3xl font-bold text-purple-600">{quizScore}/{quizQuestions.length}</div>
                        <div className="text-sm text-gray-600">Quiz Score</div>
                     </div>
                  </div>
                  <div className="mt-4 text-center">
                     <div className="text-4xl font-bold text-indigo-700">{percentage}%</div>
                     <div className="text-sm text-gray-600">Overall Mastery</div>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   const NpvIrrRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         npv: { title: 'Net Present Value (NPV)', content: 'Sum of all cash flows discounted to present value. NPV > 0 means project adds value. Accept projects with positive NPV.' },
         irr: { title: 'Internal Rate of Return (IRR)', content: 'The discount rate that makes NPV = 0. If IRR > cost of capital, accept the project. Higher IRR = better return.' },
         wacc: { title: 'Weighted Average Cost of Capital', content: 'The blended cost of debt and equity financing. Used as discount rate for NPV. Represents minimum acceptable return.' },
         payback: { title: 'Payback Period', content: 'Time to recover initial investment. Ignores TVM. Quick & simple but doesnt measure profitability or cash flows after payback.' },
         profitability_index: { title: 'Profitability Index', content: 'PV of future cash flows / Initial Investment. PI > 1 means accept. Useful for capital rationing - ranking limited investment dollars.' },
         capital_budgeting: { title: 'Capital Budgeting', content: 'Process of evaluating major investments. Uses NPV, IRR, Payback to decide which projects to pursue. Long-term strategic decisions.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to NPV & IRR', content: 'Learn to evaluate investment projects using the most important capital budgeting tools. Should you build the factory? Acquire the competitor? Launch the product?' },
         { title: 'Net Present Value (NPV)', content: 'NPV = Sum of [Cash Flow / (1+r)^t] - Initial Investment. If NPV > 0, the project creates value. The gold standard of project evaluation.' },
         { title: 'Calculating NPV', content: 'Example: Invest $100K today, receive $40K for 4 years at 10% discount rate. NPV = -$100K + $40K/(1.1) + $40K/(1.1)¬≤ + $40K/(1.1)¬≥ + $40K/(1.1)‚Å¥ = $26,795' },
         { title: 'Internal Rate of Return', content: 'IRR is the discount rate where NPV = 0. If project IRR (15%) > hurdle rate (10%), accept. IRR shows the actual return percentage.' },
         { title: 'NPV vs IRR Conflict', content: 'Sometimes they disagree! NPV assumes reinvestment at WACC (realistic), IRR assumes reinvestment at IRR (optimistic). When in doubt, trust NPV.' },
         { title: 'Multiple Projects', content: 'Use NPV for mutually exclusive projects (pick highest NPV). Use IRR for independent projects (accept all IRR > hurdle). Use PI for capital rationing.' },
         { title: 'Real-World Application', content: 'CEOs use these daily: Should we expand? Buy equipment? Enter a market? NPV and IRR quantify the value creation of strategic decisions.' }
      ];

      const scenarios = [
         {
            title: 'Factory Expansion',
            context: 'Initial investment: $500,000. Expected cash flows: Year 1: $150K, Year 2: $180K, Year 3: $200K, Year 4: $220K. WACC: 12%.',
            cashFlows: [-500000, 150000, 180000, 200000, 220000],
            wacc: 12,
            npv: 57800,
            irr: 17.4,
            question: 'Should the company proceed with this expansion?',
            options: [
               { text: 'Yes - NPV is positive ($57,800) and IRR (17.4%) > WACC (12%)', correct: true },
               { text: 'No - The payback period is too long', correct: false },
               { text: 'No - We should wait for higher returns', correct: false },
               { text: 'Need more information about competitors', correct: false }
            ],
            correct: 0,
            explanation: 'NPV = $57,800 > 0 and IRR = 17.4% > 12% WACC. Both metrics agree: this project creates shareholder value!'
         },
         {
            title: 'Equipment vs Lease',
            context: 'Option A: Buy equipment for $200K, saves $60K/year for 5 years. Option B: Lease for $45K/year for 5 years. Discount rate: 8%.',
            question: 'Which option has lower total cost (higher NPV)?',
            options: [
               { text: 'Buy - NPV of savings is $39,600 after equipment cost', correct: true },
               { text: 'Lease - Lower upfront commitment', correct: false },
               { text: 'They are equivalent', correct: false },
               { text: 'Cannot compare without IRR', correct: false }
            ],
            correct: 0,
            explanation: 'Buy: PV of $60K savings √ó 5 years at 8% = $239,600 - $200K cost = $39,600. Lease: PV of $45K √ó 5 years = $179,700 cost. Buying saves $39,600 in present value!'
         },
         {
            title: 'Mutually Exclusive Projects',
            context: 'Project A: Invest $100K, NPV = $25K, IRR = 20%. Project B: Invest $200K, NPV = $35K, IRR = 15%. Only one can be chosen.',
            question: 'Which project should be selected?',
            options: [
               { text: 'Project A - Higher IRR (20% vs 15%)', correct: false },
               { text: 'Project B - Higher NPV ($35K vs $25K)', correct: true },
               { text: 'Project A - Lower investment required', correct: false },
               { text: 'Neither - Both IRRs are good', correct: false }
            ],
            correct: 1,
            explanation: 'For mutually exclusive projects, choose highest NPV! Project B adds $35K of value vs $25K. The extra $100K investment earns a 10% return, still above cost of capital.'
         },
         {
            title: 'Negative IRR Scenario',
            context: 'Project: Invest $50K, receive $20K in Year 1, $15K in Year 2, $10K in Year 3. Total cash = $45K. WACC = 10%.',
            question: 'What does the analysis reveal?',
            options: [
               { text: 'Accept - Positive total cash flow', correct: false },
               { text: 'Reject - NPV is negative (-$8,150), IRR < WACC', correct: true },
               { text: 'Need to calculate payback period first', correct: false },
               { text: 'Acceptable if IRR > 5%', correct: false }
            ],
            correct: 1,
            explanation: 'NPV at 10% = -$8,150 (negative!). Total cash ignores TVM. Even though you get $45K back on $50K, the TIME it takes destroys value at 10% opportunity cost.'
         }
      ];

      const quizQuestions = [
         { q: 'A project with NPV of $0 means:', options: ['Project loses money', 'Project earns exactly the cost of capital', 'Project is risk-free', 'IRR cannot be calculated'], correct: 1 },
         { q: 'If IRR > WACC, then NPV is:', options: ['Negative', 'Zero', 'Positive', 'Cannot determine'], correct: 2 },
         { q: 'Why might NPV and IRR give different rankings?', options: ['Different project scales', 'Different timing of cash flows', 'Reinvestment rate assumptions', 'All of the above'], correct: 3 },
         { q: 'What discount rate makes NPV = 0?', options: ['WACC', 'IRR', 'Risk-free rate', 'Inflation rate'], correct: 1 },
         { q: 'For capital rationing, which metric is best?', options: ['NPV', 'IRR', 'Profitability Index', 'Payback Period'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">üìà</div>
                  <h2 className="text-2xl font-bold text-emerald-800">NPV & IRR Analysis</h2>
                  <p className="text-gray-600 mt-2">Master capital budgeting decisions</p>
               </div>
               <div className="bg-emerald-50 p-4 rounded-xl">
                  <h3 className="font-semibold text-emerald-800 mb-2">What You'll Learn:</h3>
                  <ul className="space-y-1 text-sm text-gray-700">
                     <li>‚úì Net Present Value calculation & interpretation</li>
                     <li>‚úì Internal Rate of Return analysis</li>
                     <li>‚úì When NPV and IRR conflict</li>
                     <li>‚úì Project ranking and selection</li>
                     <li>‚úì Real-world investment decisions</li>
                  </ul>
               </div>
               <button onClick={() => { setPhase('tutorial'); setGameLog(['Started NPV/IRR tutorial']); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="space-y-6">
               <div className="flex justify-between items-center">
                  <span className="text-sm text-gray-500">Tutorial {tutorialStep + 1} of {tutorialSteps.length}</span>
                  <div className="flex gap-1">
                     {tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-emerald-600' : 'bg-gray-200'}`} />))}
                  </div>
               </div>
               <div className="bg-gradient-to-br from-emerald-50 to-teal-100 p-6 rounded-xl">
                  <h3 className="text-xl font-bold text-emerald-800 mb-3">{step.title}</h3>
                  <p className="text-gray-700">{step.content}</p>
               </div>
               {tutorialStep === 2 && (
                  <div className="bg-white border-2 border-emerald-200 p-4 rounded-xl">
                     <h4 className="font-semibold text-emerald-700 mb-2">NPV Breakdown:</h4>
                     <div className="text-sm space-y-1">
                        <div className="flex justify-between"><span>Initial Investment:</span><span className="text-red-600">-$100,000</span></div>
                        <div className="flex justify-between"><span>Year 1: $40K / 1.10 =</span><span className="text-green-600">+$36,364</span></div>
                        <div className="flex justify-between"><span>Year 2: $40K / 1.21 =</span><span className="text-green-600">+$33,058</span></div>
                        <div className="flex justify-between"><span>Year 3: $40K / 1.33 =</span><span className="text-green-600">+$30,053</span></div>
                        <div className="flex justify-between"><span>Year 4: $40K / 1.46 =</span><span className="text-green-600">+$27,320</span></div>
                        <div className="flex justify-between border-t pt-1 font-bold"><span>NPV =</span><span className="text-emerald-600">$26,795</span></div>
                     </div>
                  </div>
               )}
               <div className="flex gap-2">
                  {tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-emerald-600 text-emerald-600 rounded-lg hover:bg-emerald-50">‚Üê Back</button>)}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); setGameLog([...gameLog, 'Completed tutorial']); } }} className="flex-1 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (
            <div className="space-y-4">
               <div className="flex justify-between items-center">
                  <span className="text-sm font-medium text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span>
                  <span className="text-sm font-semibold text-green-600">Score: {score}/{scenarioIndex}</span>
               </div>
               <div className="bg-gradient-to-r from-emerald-50 to-teal-100 p-4 rounded-xl">
                  <div className="flex justify-between items-start">
                     <h3 className="font-bold text-emerald-800">{sc.title}</h3>
                     <button onClick={() => { setShowInfo(true); setInfoTopic('npv'); }} className="text-emerald-600 hover:text-emerald-800">‚ÑπÔ∏è</button>
                  </div>
                  <p className="mt-2 text-gray-700 text-sm">{sc.context}</p>
                  {'cashFlows' in sc && (
                     <div className="mt-2 flex gap-2 flex-wrap">
                        {sc.cashFlows.map((cf: number, i: number) => (<span key={i} className={`px-2 py-1 rounded text-xs font-medium ${cf < 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>Y{i}: ${(cf/1000).toFixed(0)}K</span>))}
                     </div>
                  )}
                  <p className="mt-3 font-medium text-emerald-700">{sc.question}</p>
               </div>

               <div className="space-y-2">
                  {sc.options.map((opt, i) => (
                     <button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm transition-all ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-400'}`}>{opt.text}</button>
                  ))}
               </div>

               {!answered ? (
                  <button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Scenario ${scenarioIndex + 1}: Correct`]); } else { setGameLog([...gameLog, `Scenario ${scenarioIndex + 1}: Incorrect`]); } }} disabled={selectedAnswer === null} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 disabled:bg-gray-300">Check Answer</button>
               ) : (
                  <div className="space-y-3">
                     <div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100 border border-green-300' : 'bg-yellow-100 border border-yellow-300'}`}>
                        <p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p>
                        <p className="text-sm text-gray-700 mt-1">{sc.explanation}</p>
                     </div>
                     <button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'See Results ‚Üí'}</button>
                  </div>
               )}

               {showInfo && infoTopic && infoContent[infoTopic] && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                     <div className="bg-white rounded-xl p-6 max-w-md">
                        <h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3>
                        <p className="text-gray-700">{infoContent[infoTopic].content}</p>
                        <button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-emerald-600 text-white rounded-lg">Got It</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (
               <div className="space-y-6">
                  <div className="text-center">
                     <h3 className="text-xl font-bold text-emerald-800">Final Assessment</h3>
                     <p className="text-sm text-gray-500">Question {quizIndex + 1} of {quizQuestions.length}</p>
                  </div>
                  <div className="bg-emerald-50 p-4 rounded-xl">
                     <p className="font-medium text-gray-800">{q.q}</p>
                  </div>
                  <div className="space-y-2">
                     {q.options.map((opt, i) => (
                        <button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) { setQuizScore(quizScore + 1); } } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-emerald-400'}`}>{opt}</button>
                     ))}
                  </div>
                  {quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700">Next Question ‚Üí</button>)}
               </div>
            );
         }

         const percentage = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (
            <div className="space-y-6">
               <div className="text-center">
                  <div className="text-6xl mb-4">{percentage >= 80 ? 'üìà' : percentage >= 60 ? 'üìä' : 'üìö'}</div>
                  <h2 className="text-2xl font-bold text-emerald-800">NPV/IRR Complete!</h2>
               </div>
               <div className="bg-gradient-to-br from-emerald-50 to-teal-100 p-6 rounded-xl">
                  <div className="grid grid-cols-2 gap-4 text-center">
                     <div>
                        <div className="text-3xl font-bold text-emerald-600">{score}/{scenarios.length}</div>
                        <div className="text-sm text-gray-600">Scenarios</div>
                     </div>
                     <div>
                        <div className="text-3xl font-bold text-teal-600">{quizScore}/{quizQuestions.length}</div>
                        <div className="text-sm text-gray-600">Quiz Score</div>
                     </div>
                  </div>
                  <div className="mt-4 text-center">
                     <div className="text-4xl font-bold text-emerald-700">{percentage}%</div>
                     <div className="text-sm text-gray-600">Overall Mastery</div>
                  </div>
               </div>
               <button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700">Practice Again</button>
            </div>
         );
      }
      return null;
   };

   const EquityDebtFinancingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         equity: { title: 'Equity Financing', content: 'Selling ownership stakes (stock) to raise capital. No repayment required, but dilutes ownership and shares future profits.' },
         debt: { title: 'Debt Financing', content: 'Borrowing money to be repaid with interest. Keeps ownership intact but creates fixed obligations. Interest is tax-deductible.' },
         dilution: { title: 'Ownership Dilution', content: 'When new shares are issued, existing owners percentage decreases. 100% of $1M vs 50% of $10M - dilution can create value.' },
         leverage: { title: 'Financial Leverage', content: 'Using borrowed money to amplify returns. Magnifies both gains and losses. High leverage = high risk.' }
      };

      const tutorialSteps = [
         { title: 'Equity vs Debt Decision', content: 'Every growing company faces this: sell ownership (equity) or borrow money (debt)? Each has trade-offs that shape your companys future.' },
         { title: 'Equity Financing Explained', content: 'Sell shares to investors. No repayment, no interest. But you give up ownership and control. VCs, angels, IPOs are equity sources.' },
         { title: 'Debt Financing Explained', content: 'Borrow from banks or issue bonds. Must repay principal + interest regardless of performance. But you keep 100% ownership.' },
         { title: 'The Tax Shield Advantage', content: 'Interest payments are tax-deductible! If you pay $100K interest at 25% tax rate, it really costs $75K. Dividends are NOT deductible.' },
         { title: 'Financial Leverage Effect', content: 'Borrow at 6%, invest for 15% return = 9% spread goes to equity holders. But if returns drop to 3%, you still owe 6%.' },
         { title: 'Choosing the Right Mix', content: 'Startups: more equity (unpredictable cash flows). Mature companies: more debt (stable cash flows). Industry norms matter.' },
         { title: 'Real-World Trade-offs', content: 'Tesla raised billions in equity. Apple issues debt despite $200B cash (tax efficiency). Every choice has strategic implications.' }
      ];

      const scenarios = [
         { title: 'Startup Funding Round', context: 'Your startup needs $2M. Option A: VC offers $2M for 25% equity. Option B: Bank loan at 8% interest, 5-year term.', question: 'Which financing makes more sense for an early-stage startup?', options: [{ text: 'Equity - Unpredictable cash flows make debt risky', correct: true }, { text: 'Debt - Keep full ownership', correct: false }, { text: 'Split 50/50', correct: false }, { text: 'Neither - Bootstrap instead', correct: false }], correct: 0, explanation: 'Early startups have unpredictable revenue. Missing loan payments = bankruptcy. VCs share the risk.' },
         { title: 'Profitable Company Expansion', context: 'Your $10M revenue company needs $3M. 20% profit margin, stable cash flows. Debt at 7% or sell 15% equity.', question: 'Which option maximizes shareholder value?', options: [{ text: 'Equity - Reduce financial risk', correct: false }, { text: 'Debt - Tax shield + retain ownership', correct: true }, { text: 'Lease equipment instead', correct: false }, { text: 'Delay expansion', correct: false }], correct: 1, explanation: 'Stable cash flows can service debt. At 25% tax rate, 7% debt costs 5.25% after tax.' },
         { title: 'High-Growth Tech Company', context: 'SaaS company growing 100% YoY, burning $1M/month. Need $20M runway. Debt at 12% or Series B.', question: 'What should the founder choose?', options: [{ text: 'Debt - Minimize dilution', correct: false }, { text: 'Equity - Cant service debt while burning cash', correct: true }, { text: 'Convertible note', correct: false }, { text: 'Cut burn rate', correct: false }], correct: 1, explanation: 'Negative cash flow = cant pay interest. High-growth companies trade dilution for runway.' },
         { title: 'Leveraged Buyout', context: 'PE firm acquiring stable manufacturing company for $50M. EBITDA $8M/year. Can get 5x debt ($40M) plus $10M equity.', question: 'Why use high leverage in this LBO?', options: [{ text: 'Amplify equity returns using stable cash flows', correct: true }, { text: 'Minimize total capital', correct: false }, { text: 'Tax benefits only', correct: false }, { text: 'Too risky', correct: false }], correct: 0, explanation: '$8M EBITDA covers $2.4M interest. After paying down debt, equity value explodes.' }
      ];

      const quizQuestions = [
         { q: 'Which financing has no required repayment?', options: ['Bank loan', 'Bonds', 'Common stock', 'Credit line'], correct: 2 },
         { q: 'Why is debt often cheaper than equity?', options: ['Lower risk', 'Tax deductibility', 'No covenants', 'Easier'], correct: 1 },
         { q: 'What happens in ownership dilution?', options: ['Value decreases', 'Shareholders % decreases', 'Debt increases', 'Dividends stop'], correct: 1 },
         { q: 'When is high leverage most appropriate?', options: ['Startups', 'Stable cash flows', 'Recessions', 'Equity is cheap'], correct: 1 },
         { q: 'What is a debt covenant?', options: ['Interest rate', 'Lender restriction', 'Conversion right', 'Tax benefit'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (
            <div className="space-y-6">
               <div className="text-center"><div className="text-6xl mb-4">‚öñÔ∏è</div><h2 className="text-2xl font-bold text-violet-800">Equity vs Debt Financing</h2><p className="text-gray-600 mt-2">Master the capital structure decision</p></div>
               <div className="bg-violet-50 p-4 rounded-xl"><h3 className="font-semibold text-violet-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì Equity vs debt trade-offs</li><li>‚úì Tax shield and leverage effects</li><li>‚úì When to use each financing type</li><li>‚úì Dilution and ownership implications</li></ul></div>
               <button onClick={() => { setPhase('tutorial'); setGameLog(['Started equity/debt tutorial']); }} className="w-full py-3 bg-violet-600 text-white rounded-xl font-semibold hover:bg-violet-700">Start Learning</button>
            </div>
         );
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (
            <div className="space-y-6">
               <div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-violet-600' : 'bg-gray-200'}`} />))}</div></div>
               <div className="bg-gradient-to-br from-violet-50 to-purple-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-violet-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>
               <div className="flex gap-2">
                  {tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-violet-600 text-violet-600 rounded-lg">‚Üê Back</button>)}
                  <button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-violet-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button>
               </div>
            </div>
         );
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (
            <div className="space-y-4">
               <div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div>
               <div className="bg-gradient-to-r from-violet-50 to-purple-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-violet-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('equity'); }} className="text-violet-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-violet-700">{sc.question}</p></div>
               <div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-violet-500 bg-violet-50' : 'border-gray-200 hover:border-violet-400'}`}>{opt.text}</button>))}</div>
               {!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-violet-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-violet-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}
               {showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-violet-600 text-white rounded-lg">Got It</button></div></div>)}
            </div>
         );
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-violet-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-violet-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-violet-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-violet-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? '‚öñÔ∏è' : 'üìä'}</div><h2 className="text-2xl font-bold text-violet-800">Complete!</h2></div><div className="bg-violet-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-violet-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-violet-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const WaccRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         wacc: { title: 'WACC Formula', content: 'WACC = (E/V √ó Re) + (D/V √ó Rd √ó (1-T)). Weighted average of equity cost and after-tax debt cost.' },
         cost_equity: { title: 'Cost of Equity', content: 'Return required by shareholders. Calculated via CAPM: Re = Rf + Œ≤(Rm - Rf).' },
         cost_debt: { title: 'Cost of Debt', content: 'Interest rate on borrowings. Tax-adjusted in WACC because interest is deductible.' },
         beta: { title: 'Beta (Œ≤)', content: 'Measures stock volatility vs market. Œ≤=1 is average risk. Œ≤>1 is riskier than market.' }
      };

      const tutorialSteps = [
         { title: 'What is WACC?', content: 'Weighted Average Cost of Capital - the blended cost of all your financing. Its the minimum return needed to satisfy investors.' },
         { title: 'Why WACC Matters', content: 'WACC is your hurdle rate. If a project returns 10% but WACC is 12%, youre destroying value.' },
         { title: 'The WACC Formula', content: 'WACC = (E/V √ó Re) + (D/V √ó Rd √ó (1-T)). E=equity, D=debt, V=total, Re=equity cost, Rd=debt cost, T=tax rate.' },
         { title: 'Cost of Equity (CAPM)', content: 'Re = Rf + Œ≤(Rm-Rf). Risk-free rate + Beta √ó Market risk premium. Higher beta = higher cost.' },
         { title: 'After-Tax Cost of Debt', content: 'Interest is tax-deductible! Rd √ó (1-T). 8% debt at 25% tax = 6% after-tax cost.' },
         { title: 'Capital Structure Weights', content: 'Use market values, not book values. Calculate % equity and % debt in total capital.' },
         { title: 'WACC in Practice', content: 'Tech: 8-12%. Utilities: 5-7%. Use WACC as discount rate for NPV calculations.' }
      ];

      const scenarios = [
         { title: 'Calculate Basic WACC', context: 'Company has $80M equity (cost 12%), $20M debt (cost 6%), tax rate 25%.', question: 'What is the WACC?', options: ['10.5%', '10.1%', '9.6%', '11.2%'], correct: 0, explanation: 'WACC = (80/100 √ó 12%) + (20/100 √ó 6% √ó 0.75) = 9.6% + 0.9% = 10.5%' },
         { title: 'More Debt Impact', context: 'Shift to $60M equity (cost 14%), $40M debt (cost 6%), tax 25%.', question: 'New WACC?', options: ['10.2%', '9.8%', '11.4%', '10.6%'], correct: 0, explanation: 'WACC = (0.6 √ó 14%) + (0.4 √ó 6% √ó 0.75) = 8.4% + 1.8% = 10.2%' },
         { title: 'High-Growth Tech WACC', context: 'Tech startup: 100% equity, Beta=1.8, Rf=3%, Market premium=6%.', question: 'Cost of equity (and WACC)?', options: ['12.6%', '13.8%', '14.4%', '10.8%'], correct: 1, explanation: 'Re = 3% + 1.8(6%) = 13.8%. With 100% equity, WACC = Re = 13.8%' },
         { title: 'Project Evaluation', context: 'WACC is 9%. Project A: IRR 11%. Project B: IRR 8%. Project C: IRR 9%.', question: 'Which projects accept?', options: ['Only A (IRR > WACC)', 'A and C', 'All three', 'None'], correct: 0, explanation: 'Only accept if IRR > WACC. A (11% > 9%) ‚úì. B (8% < 9%) ‚úó. C (9% = 9%) marginal.' }
      ];

      const quizQuestions = [
         { q: 'What does WACC represent?', options: ['Max borrowing rate', 'Minimum required return', 'Average stock return', 'Bond yield'], correct: 1 },
         { q: 'Why multiply debt cost by (1-T)?', options: ['Inflation', 'Risk adjustment', 'Interest is tax-deductible', 'Principal'], correct: 2 },
         { q: 'Higher beta means:', options: ['Lower equity cost', 'Higher equity cost', 'No WACC effect', 'Lower debt cost'], correct: 1 },
         { q: 'If WACC increases, NPVs:', options: ['Increase', 'Decrease', 'No change', 'Depends'], correct: 1 },
         { q: 'Use what weights in WACC?', options: ['Book values', 'Historical costs', 'Market values', 'Par values'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìê</div><h2 className="text-2xl font-bold text-cyan-800">WACC Calculator</h2><p className="text-gray-600 mt-2">Master the cost of capital</p></div><div className="bg-cyan-50 p-4 rounded-xl"><h3 className="font-semibold text-cyan-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì WACC formula and components</li><li>‚úì Cost of equity via CAPM</li><li>‚úì After-tax cost of debt</li><li>‚úì Using WACC as hurdle rate</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started WACC tutorial']); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold hover:bg-cyan-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-cyan-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-cyan-50 to-blue-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-cyan-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep === 2 && (<div className="bg-white border-2 border-cyan-200 p-4 rounded-xl text-center"><div className="text-lg font-mono bg-cyan-50 p-3 rounded-lg">WACC = <span className="text-blue-600">(E/V √ó Re)</span> + <span className="text-green-600">(D/V √ó Rd √ó (1-T))</span></div></div>)}<div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-cyan-600 text-cyan-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-cyan-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-cyan-50 to-blue-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-cyan-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('wacc'); }} className="text-cyan-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-cyan-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 font-medium ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-cyan-500 bg-cyan-50' : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-cyan-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-cyan-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-cyan-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üìê' : 'üìä'}</div><h2 className="text-2xl font-bold text-cyan-800">WACC Complete!</h2></div><div className="bg-cyan-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-cyan-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const StockOptionsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         iso: { title: 'Incentive Stock Options', content: 'Tax-advantaged options. No tax at exercise if held 1+ year after exercise and 2+ years after grant.' },
         nso: { title: 'Non-Qualified Options', content: 'Standard options taxed as ordinary income on the spread at exercise. More flexible but less tax-advantaged.' },
         vesting: { title: 'Vesting Schedule', content: 'Period before options are yours. Typical: 4-year vest with 1-year cliff. Leave before cliff = get nothing.' },
         strike: { title: 'Strike Price', content: 'The price you pay to buy shares. Set at fair market value on grant date. Profit = Current - Strike.' }
      };

      const tutorialSteps = [
         { title: 'What Are Stock Options?', content: 'Options give you the right to buy company shares at a fixed price. If the company grows, you profit from the difference.' },
         { title: 'How Options Work', content: 'You get options at $1 strike. Stock reaches $10. You exercise (buy at $1) and sell at $10 = $9 profit per share.' },
         { title: 'Vesting Explained', content: 'Typical: 4-year vesting with 1-year cliff. After 1 year, 25% vests. Then monthly. Leave early = lose unvested.' },
         { title: 'ISO vs NSO', content: 'ISOs: Tax-advantaged but complex. Hold 1yr after exercise + 2yr after grant. NSOs: Taxed as ordinary income at exercise.' },
         { title: 'The 409A Valuation', content: 'Private companies must set FMV for option pricing. 409A ensures IRS compliance. Usually lower than VC valuation.' },
         { title: 'Exercise Decisions', content: 'Exercise early (start capital gains clock) or wait (less cash risk). Consider AMT for ISOs.' },
         { title: 'Real-World Value', content: 'Startup options can be worth millions or nothing. Understand your grant, vesting, and taxes before joining.' }
      ];

      const scenarios = [
         { title: 'Evaluating an Offer', context: '10,000 options, $2 strike, 4yr vest. Company could reach $50/share.', question: 'Potential upside at $50/share?', options: ['$480,000 (10K √ó $48)', '$500,000', '$200,000', 'Cannot calculate'], correct: 0, explanation: 'Profit = 10,000 √ó ($50 - $2) = $480,000. But remember vesting, taxes, and risk!' },
         { title: 'Early Exercise', context: '10,000 ISOs at $1 strike. Current FMV is $1 (no spread). Can early exercise with 83(b).', question: 'Why early exercise?', options: ['Avoid paying', 'Start capital gains clock now', 'Get more shares', 'Avoid vesting'], correct: 1, explanation: 'Early exercise at FMV = no taxable spread. 83(b) starts holding period for long-term gains.' },
         { title: 'Leaving Company', context: 'After 2.5 years: 6,250 vested options. Strike $3, FMV $15. 90-day exercise window.', question: 'Cash needed to exercise?', options: ['$18,750 (6,250 √ó $3)', '$93,750', '$75,000', 'Nothing'], correct: 0, explanation: 'Exercise cost = 6,250 √ó $3 = $18,750. Plus taxes on $75K spread!' },
         { title: 'ISO vs NSO Tax', context: '1,000 shares exercised at $5, sold at $25. ISO held qualifying period vs NSO.', question: 'Tax difference?', options: ['ISO: ~$4K (20%). NSO: ~$7.4K (37%)', 'Same taxes', 'NSO has no tax', 'ISO higher taxes'], correct: 0, explanation: 'ISO with qualifying disposition saves ~$3,400 vs NSO ordinary income treatment.' }
      ];

      const quizQuestions = [
         { q: 'What is the "cliff" in vesting?', options: ['Options expire', 'No vesting until cliff date', 'Extra options', 'Price increase'], correct: 1 },
         { q: 'When are ISOs taxed favorably?', options: ['At grant', 'At exercise', 'If held 1yr + 2yr requirement', 'Never'], correct: 2 },
         { q: 'What is 409A valuation?', options: ['Tax form', 'IRS fair value for private stock', 'Exercise multiplier', 'Vesting schedule'], correct: 1 },
         { q: 'Unvested options if you leave?', options: ['Fully vest', 'Forfeited', 'Strike reduces', 'Convert to RSUs'], correct: 1 },
         { q: 'Standard exercise window after leaving?', options: ['30 days', '90 days', '1 year', 'Unlimited'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìà</div><h2 className="text-2xl font-bold text-amber-800">Stock Options Mastery</h2><p className="text-gray-600 mt-2">Understand equity compensation</p></div><div className="bg-amber-50 p-4 rounded-xl"><h3 className="font-semibold text-amber-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì How stock options work</li><li>‚úì Vesting schedules and cliffs</li><li>‚úì ISO vs NSO tax implications</li><li>‚úì Exercise strategies</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started options tutorial']); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold hover:bg-amber-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-amber-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-amber-50 to-orange-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-amber-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep === 2 && (<div className="bg-white border-2 border-amber-200 p-4 rounded-xl"><h4 className="font-semibold text-amber-700 mb-2">Vesting Timeline:</h4><div className="flex items-center justify-between text-sm"><div className="text-center"><div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs">0%</div><div className="text-xs mt-1">Start</div></div><div className="flex-1 h-1 bg-gray-200 mx-1"></div><div className="text-center"><div className="w-8 h-8 rounded-full bg-amber-500 text-white flex items-center justify-center text-xs">25%</div><div className="text-xs mt-1">1Y</div></div><div className="flex-1 h-1 bg-amber-200 mx-1"></div><div className="text-center"><div className="w-8 h-8 rounded-full bg-amber-600 text-white flex items-center justify-center text-xs">100%</div><div className="text-xs mt-1">4Y</div></div></div></div>)}<div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-amber-600 text-amber-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-amber-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-amber-50 to-orange-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-amber-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('vesting'); }} className="text-amber-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-amber-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-amber-500 bg-amber-50' : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-amber-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-amber-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-amber-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üìà' : 'üìä'}</div><h2 className="text-2xl font-bold text-amber-800">Options Complete!</h2></div><div className="bg-amber-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-amber-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const DividendPolicyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         dividend: { title: 'Cash Dividends', content: 'Regular cash payments to shareholders from profits. Signals financial health and commitment to returning value.' },
         buyback: { title: 'Share Buybacks', content: 'Company repurchases its own shares. Reduces share count, increases EPS. More tax-efficient than dividends for shareholders.' },
         payout_ratio: { title: 'Payout Ratio', content: 'Dividends / Net Income. Shows what % of earnings paid out. High ratio = less reinvestment, low ratio = growth focus.' },
         dividend_yield: { title: 'Dividend Yield', content: 'Annual dividend / Stock price. Compares dividend income across stocks. Utilities often 3-5%, tech often 0-1%.' }
      };

      const tutorialSteps = [
         { title: 'Dividend Policy Decisions', content: 'Should companies pay dividends, buy back shares, or reinvest profits? This fundamental decision shapes shareholder returns and company growth.' },
         { title: 'Cash Dividends', content: 'Regular cash payments to shareholders. Usually quarterly. Once started, hard to cut (signals trouble). Creates consistent income for investors.' },
         { title: 'Share Buybacks', content: 'Company buys its own shares in the market. Reduces shares outstanding, boosting EPS. More flexible than dividends - can stop anytime.' },
         { title: 'Dividend Irrelevance Theory', content: 'Modigliani-Miller: In perfect markets, dividend policy doesnt matter. Reality: taxes, signals, and investor preferences make it matter.' },
         { title: 'Signaling Effects', content: 'Dividend increases signal management confidence. Cuts signal trouble. Investors watch dividend announcements closely for hidden messages.' },
         { title: 'Tax Considerations', content: 'Dividends taxed as income when received. Buybacks defer taxes until sale. For taxable accounts, buybacks often more efficient.' },
         { title: 'Lifecycle Approach', content: 'Growth companies: reinvest everything. Mature companies: return cash. Microsoft paid no dividend for 28 years, now pays billions.' }
      ];

      const scenarios = [
         { title: 'Startup with $10M Cash', context: 'Fast-growing tech startup, 50% YoY growth, needs capital for expansion. Investors asking about dividends.', question: 'What dividend policy?', options: ['Pay 20% as dividends', 'No dividends - reinvest all', 'Share buyback program', 'Special one-time dividend'], correct: 1, explanation: 'Growth companies should reinvest. 50% growth rate means $1 reinvested could be worth $2.25 in 2 years. Dividends would slow growth.' },
         { title: 'Mature Utility Company', context: 'Stable regulated utility, 3% growth, $500M free cash flow, limited reinvestment opportunities.', question: 'Best capital return strategy?', options: ['Reinvest in new markets', 'High dividend payout (70-80%)', 'Aggressive buybacks only', 'Hold cash for acquisitions'], correct: 1, explanation: 'Utilities have stable cash flows and limited growth. High dividends attract income investors and match the business model.' },
         { title: 'Tech Giant with $100B Cash', context: 'Apple-like company: mature products, huge cash pile, 15% growth, strong stock price.', question: 'Optimal return policy?', options: ['All dividends', 'All buybacks', 'Mix of dividends and buybacks', 'No returns - save for M&A'], correct: 2, explanation: 'Combination works best: dividends for income investors, buybacks for tax efficiency and EPS boost. Apple does exactly this.' },
         { title: 'Company Facing Headwinds', context: 'Retail company, declining sales, currently pays $2/share dividend. Cash getting tight.', question: 'Should they cut the dividend?', options: ['Maintain - cutting signals weakness', 'Cut now before forced to', 'Suspend and do buybacks', 'Increase to show confidence'], correct: 1, explanation: 'Better to cut proactively than be forced. Maintain erodes cash, increase is reckless. Honest communication about the cut helps.' }
      ];

      const quizQuestions = [
         { q: 'Which is more tax-efficient for shareholders?', options: ['Cash dividends', 'Share buybacks', 'Equal efficiency', 'Depends on holding period'], correct: 1 },
         { q: 'Dividend payout ratio is:', options: ['Dividend / Stock Price', 'Dividend / Net Income', 'Dividend / Revenue', 'Dividend / Cash Flow'], correct: 1 },
         { q: 'A dividend cut typically signals:', options: ['Strong growth ahead', 'Financial difficulty', 'Tax optimization', 'Stock split coming'], correct: 1 },
         { q: 'Which company type typically has highest dividend yield?', options: ['Tech startups', 'Utilities', 'Biotech', 'Social media'], correct: 1 },
         { q: 'Share buybacks affect EPS by:', options: ['Increasing net income', 'Reducing shares outstanding', 'Both A and B', 'No EPS effect'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üíµ</div><h2 className="text-2xl font-bold text-green-800">Dividend Policy</h2><p className="text-gray-600 mt-2">Master shareholder return decisions</p></div><div className="bg-green-50 p-4 rounded-xl"><h3 className="font-semibold text-green-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì Dividends vs buybacks</li><li>‚úì Payout ratios and yields</li><li>‚úì Signaling effects</li><li>‚úì Tax considerations</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started dividend policy tutorial']); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-green-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-green-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-green-600 text-green-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-green-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-green-50 to-emerald-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-green-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('dividend'); }} className="text-green-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-green-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-green-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-green-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-green-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-green-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-green-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üíµ' : 'üìä'}</div><h2 className="text-2xl font-bold text-green-800">Complete!</h2></div><div className="bg-green-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-green-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const FinancialModelingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         three_statement: { title: '3-Statement Model', content: 'Links Income Statement, Balance Sheet, and Cash Flow. Changes flow through all statements. Foundation of all financial models.' },
         dcf: { title: 'DCF Model', content: 'Discounted Cash Flow: Project future cash flows, discount to present value. Intrinsic valuation method used in M&A and investing.' },
         sensitivity: { title: 'Sensitivity Analysis', content: 'Tests how outputs change with different inputs. Data tables show ranges. Identifies key value drivers and risks.' },
         scenarios: { title: 'Scenario Analysis', content: 'Base, upside, downside cases. Tests different assumptions together. More realistic than single-variable sensitivity.' }
      };

      const tutorialSteps = [
         { title: 'Financial Modeling Basics', content: 'Financial models translate business assumptions into numbers. Used for valuations, budgets, M&A, and strategic decisions.' },
         { title: 'The 3-Statement Model', content: 'Core of all models: Income Statement drives Balance Sheet changes, which drives Cash Flow Statement. All must balance and link properly.' },
         { title: 'Building a Revenue Model', content: 'Revenue = Units √ó Price or Users √ó ARPU. Build bottom-up from drivers. Historical trends inform growth assumptions.' },
         { title: 'Expense Projections', content: 'Fixed vs variable costs. Some scale with revenue (COGS), some step-function (hiring), some fixed (rent). Be realistic.' },
         { title: 'Working Capital Modeling', content: 'AR, AP, Inventory affect cash. Use days metrics: DSO, DPO, DIO. Changes in working capital hit cash flow.' },
         { title: 'DCF Valuation', content: 'Project free cash flows, calculate terminal value, discount at WACC. Sum of PVs = enterprise value. Most common valuation method.' },
         { title: 'Best Practices', content: 'Clear formatting, separate inputs/calculations/outputs, error checks, documentation. A model is only as good as its assumptions.' }
      ];

      const scenarios = [
         { title: 'Revenue Driver Selection', context: 'SaaS company model. Need to project revenue for next 5 years.', question: 'Best revenue driver approach?', options: ['Total revenue growth %', 'Customers √ó ARPU with churn', 'Industry market share', 'Analyst estimates'], correct: 1, explanation: 'Bottom-up (Customers √ó ARPU) captures business dynamics: new customer acquisition, churn, expansion revenue. More defensible than top-down.' },
         { title: 'Balance Sheet Check', context: 'Your model shows: Assets $100M, Liabilities $60M, Equity $35M.', question: 'Whats wrong?', options: ['Nothing - looks fine', 'Assets - Liabilities ‚â† Equity', 'Need more debt', 'Equity too low'], correct: 1, explanation: 'Assets ($100M) must equal Liabilities ($60M) + Equity ($35M = $95M). The $5M gap means an error in the model. Always check!' },
         { title: 'Terminal Value Method', context: 'DCF model, 5-year projection, stable mature business, 3% long-term growth expected.', question: 'Best terminal value approach?', options: ['Exit multiple only', 'Gordon Growth: FCF√ó(1+g)/(WACC-g)', '10√ó Year 5 revenue', 'Zero terminal value'], correct: 1, explanation: 'Gordon Growth suits stable businesses with predictable growth. Exit multiples work too but require comparable transactions. Use both as sanity check.' },
         { title: 'Sensitivity Table Setup', context: 'DCF shows $50/share value. Want to test revenue growth and WACC assumptions.', question: 'How to build sensitivity table?', options: ['One variable at a time only', 'Two-way table: growth vs WACC', 'Three variables minimum', 'Sensitivity not needed'], correct: 1, explanation: 'Two-way data table shows value at different growth/WACC combinations. Reveals which assumptions matter most and risk ranges.' }
      ];

      const quizQuestions = [
         { q: 'What links the 3 financial statements?', options: ['Revenue', 'Net Income and Cash', 'Only manual inputs', 'They dont link'], correct: 1 },
         { q: 'DCF terminal value typically represents:', options: ['10% of total value', '25% of total value', '50-80% of total value', 'No significant value'], correct: 2 },
         { q: 'Best practice for model inputs:', options: ['Hardcode everywhere', 'Separate input section, link cells', 'Hide assumptions', 'No documentation needed'], correct: 1 },
         { q: 'If WACC increases, DCF value:', options: ['Increases', 'Decreases', 'No change', 'Depends on growth'], correct: 1 },
         { q: 'Working capital increase means:', options: ['Cash inflow', 'Cash outflow', 'No cash impact', 'Higher profits'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìä</div><h2 className="text-2xl font-bold text-blue-800">Financial Modeling</h2><p className="text-gray-600 mt-2">Build models like an analyst</p></div><div className="bg-blue-50 p-4 rounded-xl"><h3 className="font-semibold text-blue-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì 3-Statement model structure</li><li>‚úì Revenue and expense drivers</li><li>‚úì DCF valuation</li><li>‚úì Sensitivity analysis</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started financial modeling tutorial']); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-blue-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-blue-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-blue-600 text-blue-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-blue-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-blue-50 to-indigo-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-blue-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('three_statement'); }} className="text-blue-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-blue-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-blue-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-blue-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üìä' : 'üìà'}</div><h2 className="text-2xl font-bold text-blue-800">Modeling Complete!</h2></div><div className="bg-blue-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-blue-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const CloudAccountingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         saas: { title: 'SaaS Accounting', content: 'Software as a Service. Subscription model with monthly/annual fees. No software ownership, always updated, accessible anywhere.' },
         integration: { title: 'API Integrations', content: 'Connect accounting to banks, payroll, POS, CRM. Automates data entry, reduces errors, real-time sync.' },
         automation: { title: 'Accounting Automation', content: 'Rules-based categorization, recurring transactions, bank feeds. Reduces manual entry by 80%+. Focus on analysis, not data entry.' },
         security: { title: 'Cloud Security', content: 'Encryption, SOC 2 compliance, regular backups, access controls. Often more secure than local systems. Multi-factor authentication.' }
      };

      const tutorialSteps = [
         { title: 'Cloud Accounting Revolution', content: 'Cloud accounting (QBO, Xero, FreshBooks) replaced desktop software. Access anywhere, real-time collaboration, automatic updates.' },
         { title: 'Key Benefits', content: 'Real-time data, bank feeds, mobile access, automatic backups, multi-user collaboration. No IT infrastructure needed.' },
         { title: 'Bank Feed Automation', content: 'Transactions import automatically from banks. Create rules to categorize recurring items. Review and approve instead of manual entry.' },
         { title: 'Integration Ecosystem', content: 'Connect payroll (Gusto), payments (Stripe), expenses (Expensify), inventory (DEAR). Data flows automatically between systems.' },
         { title: 'Real-Time Reporting', content: 'Dashboards show live P&L, cash position, AR aging. No waiting for month-end. Make decisions with current data.' },
         { title: 'Multi-Entity and Multi-Currency', content: 'Manage multiple companies, consolidate reports, handle foreign transactions. Built for modern global businesses.' },
         { title: 'Security Considerations', content: 'SOC 2 certification, encryption, role-based access, audit trails. Enable MFA, review user permissions regularly.' }
      ];

      const scenarios = [
         { title: 'Software Selection', context: 'Small business with 50 transactions/month, needs invoicing, expenses, and basic reports. Budget-conscious.', question: 'Best cloud accounting choice?', options: ['QuickBooks Enterprise', 'Wave (free) or QBO Simple Start', 'SAP Business One', 'Custom built solution'], correct: 1, explanation: 'For low volume, Wave (free) or QBO Simple Start ($30/mo) is perfect. Enterprise solutions are overkill and expensive.' },
         { title: 'Bank Reconciliation Issue', context: 'Bank feed shows $5,000 deposit not in accounting system. Customer claims they paid.', question: 'First troubleshooting step?', options: ['Delete and re-import bank feed', 'Check if payment matched to wrong invoice', 'Call the bank', 'Ignore - will sort itself out'], correct: 1, explanation: 'Unmatched deposits often matched to wrong invoice or recorded twice. Check matching rules before re-importing or calling bank.' },
         { title: 'Integration Strategy', context: 'E-commerce business: Shopify store, Stripe payments, shipping with ShipStation. Manual order entry taking hours.', question: 'Best integration approach?', options: ['Hire data entry staff', 'Connect Shopify ‚Üí Accounting directly', 'Use integration platform (A2X, Synder)', 'Export CSVs weekly'], correct: 2, explanation: 'Integration platforms handle e-commerce complexity: refunds, fees, multi-currency, and proper revenue recognition. Direct integrations often miss details.' },
         { title: 'Access Control', context: 'Growing team: CEO, CFO, bookkeeper, external accountant. Setting up permissions.', question: 'Best permission structure?', options: ['Everyone gets admin access', 'Role-based: Admin, Standard, Reports-only', 'One shared login', 'Bookkeeper only has access'], correct: 1, explanation: 'Role-based access: CEO/CFO as Admin, bookkeeper as Standard (no delete), accountant as Reports-only. Audit trail tracks who did what.' }
      ];

      const quizQuestions = [
         { q: 'Main advantage of cloud vs desktop accounting:', options: ['Lower cost always', 'Real-time access anywhere', 'More features', 'Better for large companies'], correct: 1 },
         { q: 'Bank feeds in cloud accounting:', options: ['Manual file upload only', 'Automatic daily import', 'Not available', 'Requires IT setup'], correct: 1 },
         { q: 'SOC 2 certification indicates:', options: ['Tax compliance', 'Security controls verified', 'GAAP compliance', 'Audit completion'], correct: 1 },
         { q: 'Best practice for cloud accounting security:', options: ['Share passwords for efficiency', 'Disable two-factor auth', 'Enable MFA, role-based access', 'Use personal email accounts'], correct: 2 },
         { q: 'Cloud accounting integrations reduce:', options: ['Reporting capabilities', 'Manual data entry', 'Security', 'Available features'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">‚òÅÔ∏è</div><h2 className="text-2xl font-bold text-sky-800">Cloud Accounting</h2><p className="text-gray-600 mt-2">Master modern accounting tools</p></div><div className="bg-sky-50 p-4 rounded-xl"><h3 className="font-semibold text-sky-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì Cloud vs desktop software</li><li>‚úì Bank feed automation</li><li>‚úì Integration ecosystem</li><li>‚úì Security best practices</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started cloud accounting tutorial']); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold hover:bg-sky-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-sky-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-sky-50 to-blue-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-sky-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-sky-600 text-sky-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-sky-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-sky-50 to-blue-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-sky-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('saas'); }} className="text-sky-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-sky-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-sky-500 bg-sky-50' : 'border-gray-200 hover:border-sky-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-sky-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-sky-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-sky-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-sky-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? '‚òÅÔ∏è' : 'üìä'}</div><h2 className="text-2xl font-bold text-sky-800">Cloud Complete!</h2></div><div className="bg-sky-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-sky-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const ErpBasicsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         erp: { title: 'ERP Systems', content: 'Enterprise Resource Planning: unified system for finance, HR, inventory, manufacturing, sales. Single source of truth for the organization.' },
         modules: { title: 'ERP Modules', content: 'Finance, HR, Supply Chain, Manufacturing, CRM, Projects. Each module integrates with others. Buy what you need.' },
         implementation: { title: 'ERP Implementation', content: 'Major project: 6-24 months. Requires process redesign, data migration, training. High failure rate if poorly planned.' },
         master_data: { title: 'Master Data', content: 'Core reference data: customers, vendors, products, GL accounts. Must be clean and consistent. Foundation of ERP success.' }
      };

      const tutorialSteps = [
         { title: 'What is ERP?', content: 'Enterprise Resource Planning systems (SAP, Oracle, NetSuite) integrate all business functions into one platform. Finance, HR, inventory, sales - all connected.' },
         { title: 'Why Companies Need ERP', content: 'Eliminate data silos, reduce manual work, improve visibility. One version of truth instead of conflicting spreadsheets.' },
         { title: 'Core ERP Modules', content: 'Finance/GL, Accounts Payable/Receivable, Inventory, Order Management, HR/Payroll, Manufacturing, CRM. Modules share common data.' },
         { title: 'The General Ledger Core', content: 'Chart of accounts, journal entries, financial reporting. All modules post to GL. The heart of financial ERP.' },
         { title: 'Procure-to-Pay Process', content: 'Requisition ‚Üí Purchase Order ‚Üí Goods Receipt ‚Üí Invoice ‚Üí Payment. ERP enforces controls and automates matching.' },
         { title: 'Order-to-Cash Process', content: 'Quote ‚Üí Sales Order ‚Üí Shipment ‚Üí Invoice ‚Üí Collection. ERP tracks entire customer lifecycle and revenue.' },
         { title: 'Implementation Challenges', content: 'Data migration, process changes, user adoption, customization vs configuration. Plan thoroughly, train extensively, expect bumps.' }
      ];

      const scenarios = [
         { title: 'ERP Selection', context: 'Mid-size manufacturer: $50M revenue, 200 employees, complex inventory, outgrowing QuickBooks.', question: 'Best ERP approach?', options: ['Stay with QuickBooks', 'NetSuite or Acumatica (cloud mid-market)', 'SAP S/4HANA (enterprise)', 'Build custom system'], correct: 1, explanation: 'Mid-market cloud ERP (NetSuite, Acumatica, Sage Intacct) fits the size and needs. SAP is overkill, QuickBooks is outgrown.' },
         { title: 'Three-Way Match Failure', context: 'AP trying to pay invoice. PO says 100 units at $10. Receipt shows 95 units. Invoice says 100 units at $10.', question: 'What should happen?', options: ['Pay full invoice amount', 'System blocks - quantity mismatch', 'Pay for 95 units only', 'Delete the PO'], correct: 1, explanation: 'Three-way match (PO, Receipt, Invoice) must agree. System should block payment until resolved: short shipment or receiving error?' },
         { title: 'Master Data Issue', context: 'Same customer exists twice: "ABC Corp" and "ABC Corporation". Different terms and credit limits each.', question: 'What problem does this cause?', options: ['No problem - more flexibility', 'Split credit exposure, wrong AR aging', 'Better for sales territories', 'Required for subsidiaries'], correct: 1, explanation: 'Duplicate master data creates chaos: credit exposure invisible, AR aging wrong, reporting unreliable. Data governance is critical.' },
         { title: 'Go-Live Decision', context: 'ERP implementation: finance module ready, inventory has bugs, users partially trained. Deadline pressure.', question: 'Best approach?', options: ['Go live on schedule anyway', 'Delay until 100% ready', 'Phased: finance now, inventory later', 'Cancel the project'], correct: 2, explanation: 'Phased rollout reduces risk. Get finance stable, fix inventory issues, complete training. Full cutover with bugs is dangerous.' }
      ];

      const quizQuestions = [
         { q: 'ERP stands for:', options: ['Enterprise Resource Planning', 'Electronic Record Processing', 'Efficient Reporting Platform', 'Extended Revenue Program'], correct: 0 },
         { q: 'Three-way match compares:', options: ['Three invoices', 'PO, Receipt, Invoice', 'Three vendors', 'Three GL accounts'], correct: 1 },
         { q: 'Master data includes:', options: ['Transaction history', 'Customer and product records', 'Financial statements', 'Audit reports'], correct: 1 },
         { q: 'Biggest ERP implementation risk:', options: ['Software cost', 'Hardware failure', 'Poor change management', 'Vendor bankruptcy'], correct: 2 },
         { q: 'Which is NOT typically an ERP module?', options: ['General Ledger', 'Accounts Payable', 'Social Media Marketing', 'Inventory Management'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üè¢</div><h2 className="text-2xl font-bold text-purple-800">ERP Basics</h2><p className="text-gray-600 mt-2">Understand enterprise systems</p></div><div className="bg-purple-50 p-4 rounded-xl"><h3 className="font-semibold text-purple-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì What ERP systems do</li><li>‚úì Core modules and processes</li><li>‚úì Implementation considerations</li><li>‚úì Master data management</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started ERP tutorial']); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-purple-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-purple-50 to-violet-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-purple-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-purple-600 text-purple-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-purple-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-purple-50 to-violet-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-purple-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('erp'); }} className="text-purple-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-purple-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-purple-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-purple-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-purple-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üè¢' : 'üìä'}</div><h2 className="text-2xl font-bold text-purple-800">ERP Complete!</h2></div><div className="bg-purple-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-purple-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const AuditTrailsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState(0);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: {[key: string]: { title: string; content: string }} = {
         audit_trail: { title: 'Audit Trail', content: 'Chronological record of all changes: who, what, when. Creates accountability and enables investigation of issues.' },
         sox: { title: 'SOX Compliance', content: 'Sarbanes-Oxley requires public companies to maintain internal controls including audit trails. Heavy penalties for non-compliance.' },
         immutability: { title: 'Immutability', content: 'Audit logs should not be editable or deletable. Prevents cover-ups. Write-once storage or blockchain approaches.' },
         retention: { title: 'Retention Policies', content: 'How long to keep audit logs. Legal requirements vary: tax records 7 years, SOX indefinitely. Storage costs vs compliance.' }
      };

      const tutorialSteps = [
         { title: 'What are Audit Trails?', content: 'Complete history of all changes to financial records. Every edit, delete, approval logged with user ID and timestamp. Critical for compliance.' },
         { title: 'Why Audit Trails Matter', content: 'Detect fraud, support investigations, prove compliance, enable debugging. If something goes wrong, you can trace exactly what happened.' },
         { title: 'Key Information Captured', content: 'User ID, timestamp, action type (create/edit/delete), before and after values, IP address, transaction reference. Complete picture.' },
         { title: 'SOX Requirements', content: 'Sarbanes-Oxley Section 404: maintain internal controls. Audit trails prove controls exist and work. Required for public companies.' },
         { title: 'Immutability Principle', content: 'Audit logs must be tamper-proof. No editing or deleting. Separate storage, restricted access, cryptographic verification.' },
         { title: 'Using Audit Trails', content: 'Investigate discrepancies, support auditors, track user activity, identify training needs. Proactive monitoring catches issues early.' },
         { title: 'Retention and Storage', content: 'Legal retention varies: 7 years typical for tax. SOX: indefinite for key records. Balance storage costs with compliance needs.' }
      ];

      const scenarios = [
         { title: 'Missing Invoice', context: 'Vendor claims they sent invoice 30 days ago. Your AP says they never received it. Invoice not in system.', question: 'How does audit trail help?', options: ['Cannot help - invoice not entered', 'Check if invoice was deleted and by whom', 'Automatically creates missing invoices', 'Emails the vendor'], correct: 1, explanation: 'Audit trail shows if invoice was entered then deleted. Who deleted it? When? This catches errors and potential fraud.' },
         { title: 'Unauthorized Change', context: 'Customer credit limit was $50K, now shows $500K. Customer placed $400K order that shipped.', question: 'First investigation step?', options: ['Approve the change retroactively', 'Check audit trail for who changed limit', 'Bill the customer immediately', 'Disable the customer account'], correct: 1, explanation: 'Audit trail reveals: Who made the change? When? Was proper approval obtained? This is either fraud or control failure - both serious.' },
         { title: 'Auditor Request', context: 'External auditors request evidence of journal entry approvals for all entries over $100K.', question: 'How to respond?', options: ['Manual review of all entries', 'Export audit trail filtered by amount', 'Tell them its not tracked', 'Provide GL balances only'], correct: 1, explanation: 'Audit trail export shows all entries with approver IDs and timestamps. Quick, complete, and auditor-friendly. This is why we have audit trails.' },
         { title: 'System Access Review', context: 'Annual access review required. Need to verify only appropriate users have sensitive access.', question: 'What audit trail feature helps?', options: ['Transaction logs only', 'User access and permission change logs', 'Financial statement exports', 'Vendor payment history'], correct: 1, explanation: 'Audit trails track permission changes: who granted access, when, what level. Compare current access to approved access. Catch orphan accounts.' }
      ];

      const quizQuestions = [
         { q: 'Audit trails should be:', options: ['Editable by admins', 'Immutable/tamper-proof', 'Deleted after 1 year', 'Optional for small companies'], correct: 1 },
         { q: 'SOX Section 404 requires:', options: ['External audits only', 'Internal controls documentation', 'Quarterly earnings calls', 'CEO signature on checks'], correct: 1 },
         { q: 'Minimum audit trail should capture:', options: ['User, timestamp, action', 'Only dollar amounts', 'Just the final value', 'Approver name only'], correct: 0 },
         { q: 'Typical financial record retention:', options: ['1 year', '3 years', '7 years', '30 days'], correct: 2 },
         { q: 'Audit trail helps detect:', options: ['Future transactions', 'Unauthorized changes', 'Market conditions', 'Vendor pricing'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üîç</div><h2 className="text-2xl font-bold text-rose-800">Audit Trails</h2><p className="text-gray-600 mt-2">Master compliance and controls</p></div><div className="bg-rose-50 p-4 rounded-xl"><h3 className="font-semibold text-rose-800 mb-2">What You'll Learn:</h3><ul className="space-y-1 text-sm text-gray-700"><li>‚úì What audit trails capture</li><li>‚úì SOX compliance requirements</li><li>‚úì Investigation techniques</li><li>‚úì Retention policies</li></ul></div><button onClick={() => { setPhase('tutorial'); setGameLog(['Started audit trails tutorial']); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold hover:bg-rose-700">Start Learning</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Tutorial {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full ${i <= tutorialStep ? 'bg-rose-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-gradient-to-br from-rose-50 to-pink-100 p-6 rounded-xl"><h3 className="text-xl font-bold text-rose-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex gap-2">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-2 border border-rose-600 text-rose-600 rounded-lg">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) { setTutorialStep(tutorialStep + 1); } else { setPhase('play'); } }} className="flex-1 py-2 bg-rose-600 text-white rounded-lg">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Practice ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm text-gray-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm font-semibold text-green-600">Score: {score}</span></div><div className="bg-gradient-to-r from-rose-50 to-pink-100 p-4 rounded-xl"><div className="flex justify-between"><h3 className="font-bold text-rose-800">{sc.title}</h3><button onClick={() => { setShowInfo(true); setInfoTopic('audit_trail'); }} className="text-rose-600">‚ÑπÔ∏è</button></div><p className="mt-2 text-gray-700 text-sm">{sc.context}</p><p className="mt-3 font-medium text-rose-700">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) setSelectedAnswer(i); }} disabled={answered} className={`w-full p-3 rounded-lg text-left border-2 text-sm ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : selectedAnswer === i ? 'border-red-500 bg-red-50' : 'border-gray-200') : selectedAnswer === i ? 'border-rose-500 bg-rose-50' : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{!answered ? (<button onClick={() => { setAnswered(true); if (selectedAnswer === sc.correct) setScore(score + 1); }} disabled={selectedAnswer === null} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold disabled:bg-gray-300">Check Answer</button>) : (<div className="space-y-3"><div className={`p-3 rounded-lg ${selectedAnswer === sc.correct ? 'bg-green-100' : 'bg-yellow-100'}`}><p className="font-semibold">{selectedAnswer === sc.correct ? '‚úÖ Correct!' : '‚ùå Not quite...'}</p><p className="text-sm text-gray-700 mt-1">{sc.explanation}</p></div><button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else { setPhase('result'); } }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'See Results ‚Üí'}</button></div>)}{showInfo && infoTopic && infoContent[infoTopic] && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-xl p-6 max-w-md"><h3 className="font-bold text-lg mb-2">{infoContent[infoTopic].title}</h3><p className="text-gray-700">{infoContent[infoTopic].content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-rose-600 text-white rounded-lg">Got It</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-rose-800">Final Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-rose-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üîç' : 'üìä'}</div><h2 className="text-2xl font-bold text-rose-800">Audit Trails Complete!</h2></div><div className="bg-rose-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-rose-700">{pct}%</div><div className="text-sm text-gray-600">Overall Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const ForensicAccountingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'fraud_triangle': { title: 'Fraud Triangle', content: 'Three elements: Pressure (financial need), Opportunity (weak controls), Rationalization (justifying the act). All three must be present for fraud.' },
         'benford_law': { title: "Benford's Law", content: 'Natural numbers follow predictable digit patterns. First digit is 1 about 30% of the time. Fraudsters create fake numbers that violate this.' },
         'red_flags': { title: 'Red Flags', content: 'Warning signs: living beyond means, refusing vacation, excessive control, unusual entries, round numbers, sequential duplicates.' },
         'skimming': { title: 'Skimming', content: 'Stealing cash before it enters books. Hard to detect since no record exists. Look for revenue anomalies vs industry benchmarks.' },
         'shell_companies': { title: 'Shell Companies', content: 'Fake vendors for kickbacks or embezzlement. Signs: PO boxes, no website, round invoices, address matching employee.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Forensic Accounting', desc: 'Learn to detect fraud, investigate irregularities, and follow the money trail.' },
         { title: 'The Fraud Triangle', desc: 'Every fraud has three elements: Pressure, Opportunity, and Rationalization.', icon: 'üî∫' },
         { title: 'Red Flag Detection', desc: 'Look for warning signs: unusual transactions, behavioral changes, control overrides.', icon: 'üö©' },
         { title: "Benford's Law Analysis", desc: 'Natural numbers follow predictable patterns. Fabricated data often violates these.', icon: 'üìä' },
         { title: 'Follow the Money', desc: 'Trace transactions through accounts, identify shell companies, document evidence.', icon: 'üí∞' },
         { title: 'Investigation Protocol', desc: 'Preserve evidence, maintain chain of custody, conduct interviews strategically.', icon: 'üîç' },
         { title: 'Start Investigating!', desc: 'Analyze suspicious activity and build your case.', icon: 'üïµÔ∏è' }
      ];

      const scenarios = [
         { title: 'The Overtime Scheme', situation: 'Payroll clerk processes overtime for 15 employees. Same 5 employees get overtime weekly, clerk refuses vacation, hours are always round (10, 20, 30).', question: 'What type of fraud is most likely?', options: ['Tax evasion', 'Ghost employee scheme', 'Overtime inflation/kickback scheme', 'Expense reimbursement fraud'], correct: 2, explanation: 'Classic overtime fraud: consistent beneficiaries, round numbers, clerk control with no vacation. Employees may be kickbacking part of inflated overtime.' },
         { title: "Benford's Law Violation", situation: 'Vendor payments show first digit 5 appears 28% (expected: 8%), most invoices $4,500-$5,500, approval threshold is $5,000.', question: 'What does this pattern suggest?', options: ['Normal variation', 'Seasonal patterns', 'Invoice splitting to avoid approval', 'Vendor pricing strategy'], correct: 2, explanation: "Threshold manipulation. Invoices clustered below $5,000 to avoid approval. Benford's violation confirms artificial numbers." },
         { title: 'Shell Company Detection', situation: 'New vendor "XYZ Consulting" receives $200K/year. PO Box address, no website, incorporated 1 month before first invoice, address matches employee spouse.', question: 'What is the most likely scheme?', options: ['Legitimate consulting', 'Billing scheme with fictitious vendor', 'Poor vendor vetting', 'Tax optimization'], correct: 1, explanation: 'Classic shell company fraud. Employee creates fake vendor, submits invoices, approves payments to themselves.' },
         { title: 'The Lifestyle Audit', situation: 'Manager earning $75K drives new BMW, bought $400K house. Bank reconciliations show small cash shortages monthly, manager insists on doing recs personally.', question: 'What investigation step is most appropriate?', options: ['Confront immediately', 'Surprise cash count and bank confirmation', 'Wait for more evidence', 'Report to external auditors only'], correct: 1, explanation: 'Lifestyle exceeding income with control over cash suggests lapping or skimming. Surprise procedures prevent evidence destruction.' }
      ];

      const quizQuestions = [
         { q: 'Which is NOT part of the fraud triangle?', options: ['Pressure', 'Opportunity', 'Rationalization', 'Documentation'], correct: 3 },
         { q: "Benford's Law predicts first digit 1 appears:", options: ['10% of time', '~30% of time', '50% of time', 'Evenly distributed'], correct: 1 },
         { q: '"Lapping" means:', options: ['Stealing petty cash', 'Using one payment to cover another theft', 'Creating fake vendors', 'Inflating expenses'], correct: 1 },
         { q: 'Fraudsters refuse vacation because:', options: ['Dedicated employees', 'Fear of discovery', 'Heavy workload', 'No policy'], correct: 1 },
         { q: 'Most common occupational fraud type:', options: ['Financial statement fraud', 'Asset misappropriation', 'Corruption', 'Cyber fraud'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üïµÔ∏è</div><h2 className="text-2xl font-bold text-slate-800">Forensic Accounting</h2><p className="text-gray-600 mt-2">Detect fraud and follow the money</p></div><div className="bg-slate-50 p-4 rounded-xl"><h3 className="font-semibold text-slate-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Fraud triangle analysis</li><li>‚Ä¢ Red flag identification</li><li>‚Ä¢ Benford's Law application</li><li>‚Ä¢ Investigation procedures</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-slate-600 text-white rounded-xl font-semibold hover:bg-slate-700">Begin Training ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-slate-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üïµÔ∏è'}</div><h3 className="text-xl font-bold text-slate-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Investigation started']); } }} className="flex-1 py-3 bg-slate-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start Cases ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-slate-600">Case {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-slate-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-slate-800">{sc.title}</h3><button onClick={() => { setInfoKey('red_flags'); setShowInfo(true); }} className="text-slate-500 hover:text-slate-700">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Solved: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-slate-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-slate-50 p-4 rounded-xl"><p className="text-sm text-slate-700"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-slate-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Case ‚Üí' : 'Final Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-slate-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-slate-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-slate-800">Certification Exam</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-slate-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-slate-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-slate-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üïµÔ∏è' : 'üìã'}</div><h2 className="text-2xl font-bold text-slate-800">Investigation Complete!</h2></div><div className="bg-slate-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-slate-700">{pct}%</div><div className="text-sm text-gray-600">Forensic Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-slate-600 text-white rounded-xl font-semibold">Investigate Again</button></div>);
      }
      return null;
   };

   const CvpAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'contribution_margin': { title: 'Contribution Margin', content: 'Sales price minus variable costs. This "contributes" to covering fixed costs and profit. CM = Price - Variable Cost.' },
         'break_even': { title: 'Break-Even Point', content: 'Where revenue equals total costs (profit = $0). BEP = Fixed Costs √∑ CM per Unit.' },
         'margin_of_safety': { title: 'Margin of Safety', content: 'How far sales can drop before break-even. MOS = (Current - Break-Even) √∑ Current Sales.' },
         'operating_leverage': { title: 'Operating Leverage', content: 'How sensitive profit is to sales changes. High fixed costs = high leverage = amplified swings.' },
         'target_profit': { title: 'Target Profit', content: 'Units for desired profit: (Fixed Costs + Target Profit) √∑ CM per Unit.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to CVP Analysis', desc: 'Master Cost-Volume-Profit relationships for better pricing and volume decisions.' },
         { title: 'Contribution Margin', desc: 'Price - Variable Cost = what each unit contributes to fixed costs and profit.', icon: 'üíµ' },
         { title: 'Break-Even Analysis', desc: 'Find where you neither profit nor lose. Fixed Costs √∑ CM = break-even units.', icon: '‚öñÔ∏è' },
         { title: 'Target Profit Planning', desc: 'Work backwards from profit goals to determine required sales volume.', icon: 'üéØ' },
         { title: 'Margin of Safety', desc: 'Measure your cushion - how far can sales fall before break-even?', icon: 'üõ°Ô∏è' },
         { title: 'Operating Leverage', desc: 'High fixed costs amplify profit changes. Understand your cost structure.', icon: '‚ö°' },
         { title: 'Start Analyzing!', desc: 'Apply CVP concepts to strategic decisions.', icon: 'üìà' }
      ];

      const scenarios = [
         { title: 'Coffee Shop Break-Even', situation: 'New coffee shop: Latte $5, Variable cost $1.50, Fixed costs $7,000/month.', question: 'How many lattes to break even monthly?', options: ['1,400', '2,000', '2,333', '4,667'], correct: 1, explanation: 'CM = $5 - $1.50 = $3.50. BEP = $7,000 √∑ $3.50 = 2,000 lattes. At 2,000 units, revenue covers all costs exactly.' },
         { title: 'Pricing Decision', situation: 'SaaS: $50/month, $10 variable, $200K fixed, 6,000 subscribers. Consider $40 price to gain 2,000 more.', question: 'Should they lower price?', options: ['Yes - more revenue', 'No - current profit higher', 'Need more info', 'Same profit'], correct: 1, explanation: 'Current: $40 CM √ó 6,000 = $240K - $200K = $40K profit. New: $30 √ó 8,000 = $240K - $200K = $40K. Same profit but more customers to serve.' },
         { title: 'Operating Leverage', situation: 'Company A: 80% fixed, 20% variable. Company B: 30% fixed, 70% variable. Same $1M revenue. Sales +10%.', question: 'Which sees larger profit increase?', options: ['Company A (high fixed)', 'Company B (high variable)', 'Same for both', 'Cannot determine'], correct: 0, explanation: 'Company A has 80% CM ratio - 10% sales adds $80K to profit. Company B has 30% CM - only $30K added. High fixed = amplified sensitivity.' },
         { title: 'Margin of Safety', situation: 'Factory: 10,000 units, Price $100, VC $60, FC $250,000. Current sales $1M.', question: 'What is margin of safety %?', options: ['25%', '37.5%', '50%', '62.5%'], correct: 1, explanation: 'CM = $40. BEP = $250K √∑ $40 = 6,250 units ($625K). MOS = ($1M - $625K) √∑ $1M = 37.5%.' }
      ];

      const quizQuestions = [
         { q: 'Contribution margin is:', options: ['Gross margin', 'Sales minus all costs', 'Sales minus variable costs', 'Net margin'], correct: 2 },
         { q: 'Break-even is where:', options: ['Revenue = Variable costs', 'Profit = Fixed costs', 'Revenue = Total costs', 'CM = 0'], correct: 2 },
         { q: 'High operating leverage means:', options: ['High variable costs', 'Low fixed costs', 'Profit sensitive to sales', 'Safe from losses'], correct: 2 },
         { q: 'Target profit formula adds to fixed costs:', options: ['Variable costs', 'Desired profit', 'Tax expense', 'Depreciation'], correct: 1 },
         { q: '50% margin of safety means:', options: ['50% profit margin', 'Sales can drop 50%', '50% costs fixed', 'Break-even at 50%'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìä</div><h2 className="text-2xl font-bold text-green-800">CVP Analysis</h2><p className="text-gray-600 mt-2">Cost-Volume-Profit relationships</p></div><div className="bg-green-50 p-4 rounded-xl"><h3 className="font-semibold text-green-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Contribution margin</li><li>‚Ä¢ Break-even analysis</li><li>‚Ä¢ Target profit planning</li><li>‚Ä¢ Operating leverage</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-green-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üìä'}</div><h3 className="text-xl font-bold text-green-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['CVP analysis started']); } }} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-green-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-green-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-green-800">{sc.title}</h3><button onClick={() => { setInfoKey('contribution_margin'); setShowInfo(true); }} className="text-green-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Solved: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-green-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-green-50 p-4 rounded-xl"><p className="text-sm text-green-800"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-green-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-green-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-green-800">Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-green-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-green-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üìà' : 'üìä'}</div><h2 className="text-2xl font-bold text-green-800">CVP Complete!</h2></div><div className="bg-green-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-green-700">{pct}%</div><div className="text-sm text-gray-600">CVP Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const ManagerialAccountingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'relevant_costs': { title: 'Relevant Costs', content: 'Costs that differ between alternatives. Sunk costs are NEVER relevant. Focus on future, differential costs.' },
         'variance_analysis': { title: 'Variance Analysis', content: 'Comparing actual to budget. Favorable = better than expected. Analyze to understand WHY.' },
         'make_or_buy': { title: 'Make or Buy', content: 'Compare variable + avoidable fixed costs vs purchase price. Consider quality and reliability.' },
         'cost_allocation': { title: 'Cost Allocation', content: 'Assigning indirect costs using allocation bases. Critical for pricing and profitability analysis.' },
         'transfer_pricing': { title: 'Transfer Pricing', content: 'Prices between divisions. Methods: market, cost-plus, negotiated. Affects performance measurement.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Managerial Accounting', desc: 'Use accounting for internal decision-making, planning, and control.' },
         { title: 'Relevant Costs', desc: 'Not all costs matter for every decision. Focus on costs that differ between alternatives.', icon: 'üéØ' },
         { title: 'Variance Analysis', desc: 'Compare actual to budget. Understand price, efficiency, and volume variances.', icon: 'üìä' },
         { title: 'Cost Allocation', desc: 'Assign overhead fairly using appropriate allocation bases.', icon: 'üîÑ' },
         { title: 'Make or Buy', desc: 'Produce internally or outsource? Consider all relevant costs.', icon: '‚öñÔ∏è' },
         { title: 'Special Orders', desc: 'Accept below-price orders? Focus on incremental costs and capacity.', icon: 'üì¶' },
         { title: 'Start Analyzing!', desc: 'Apply concepts to real business decisions.', icon: 'üíº' }
      ];

      const scenarios = [
         { title: 'Sunk Cost Trap', situation: 'Spent $500K developing product. Market shows only $300K lifetime revenue. Additional $100K needed to launch.', question: 'Should they launch?', options: ['No - lost $500K', 'No - total loss $300K', 'Yes - $300K covers $100K', 'Need more info'], correct: 2, explanation: 'The $500K is sunk - already spent regardless. Compare future: $100K cost vs $300K revenue = $200K net gain. Launch!' },
         { title: 'Make or Buy', situation: '10,000 units at $50 ($30 variable + $20 allocated fixed). Outsource offer: $40. Fixed costs continue.', question: 'Best decision?', options: ['Buy - saves $10', 'Make - saves $10', 'Indifferent', 'Buy - no overhead'], correct: 1, explanation: 'Make: $30 variable (fixed continues anyway). Buy: $40. Making saves $10/unit = $100K. Ignore allocated fixed!' },
         { title: 'Special Order', situation: 'Current: 80,000 at $100, cost $75 (variable $50, fixed $25). Capacity: 100,000. Order: 15,000 at $60.', question: 'Accept the order?', options: ['No - below cost', 'No - below price', 'Yes - 15,000 units', 'Accept 10,000 only'], correct: 3, explanation: 'Only 20,000 capacity. At $60 vs $50 variable = $10 each. Accept 10,000 (capacity limit) for $100K extra profit.' },
         { title: 'Variance Investigation', situation: 'Standard: 2 lbs √ó $5 = $10/unit. Actual: 2.3 lbs √ó $4.50 = $10.35. Produced 1,000 units.', question: 'Price and quantity variances?', options: ['$500F price, $650U qty', '$1,150F, $1,500U', '$1,000F, $1,350U', '$500U, $650F'], correct: 0, explanation: 'Price: ($5-$4.50) √ó 2,300 = $1,150F. Quantity: (2,000-2,300) √ó $5 = $1,500U. Net $350U matches actual variance.' }
      ];

      const quizQuestions = [
         { q: 'Sunk costs are:', options: ['Always relevant', 'Never relevant', 'Sometimes relevant', 'Variable costs'], correct: 1 },
         { q: 'Favorable variance means:', options: ['Higher than budget', 'Lower than budget', 'Better than expected', 'Worse than expected'], correct: 2 },
         { q: 'In make-or-buy, which costs matter?', options: ['All manufacturing', 'Only variable', 'Avoidable costs', 'Allocated overhead'], correct: 2 },
         { q: 'Special order price should exceed:', options: ['Full cost', 'Variable cost', 'Market price', 'Target profit'], correct: 1 },
         { q: 'Transfer pricing affects:', options: ['External only', 'Divisional performance', 'GAAP only', 'Variable costs'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìã</div><h2 className="text-2xl font-bold text-blue-800">Managerial Accounting</h2><p className="text-gray-600 mt-2">Decision-making, planning, control</p></div><div className="bg-blue-50 p-4 rounded-xl"><h3 className="font-semibold text-blue-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Relevant cost analysis</li><li>‚Ä¢ Variance analysis</li><li>‚Ä¢ Make vs buy decisions</li><li>‚Ä¢ Special order pricing</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-blue-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üìã'}</div><h3 className="text-xl font-bold text-blue-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Analysis started']); } }} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-blue-600">Decision {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-blue-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-blue-800">{sc.title}</h3><button onClick={() => { setInfoKey('relevant_costs'); setShowInfo(true); }} className="text-blue-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-blue-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-blue-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-blue-800">Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-blue-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üéØ' : 'üìã'}</div><h2 className="text-2xl font-bold text-blue-800">Complete!</h2></div><div className="bg-blue-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-blue-700">{pct}%</div><div className="text-sm text-gray-600">Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const FinancialStatementAuditingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'audit_opinion': { title: 'Audit Opinions', content: 'Unqualified: fairly presented. Qualified: except for issues. Adverse: misstated. Disclaimer: unable to form opinion.' },
         'materiality': { title: 'Materiality', content: 'Threshold where misstatements matter. Typically 0.5-5% of benchmark. Drives audit scope.' },
         'sampling': { title: 'Audit Sampling', content: 'Testing portion to draw conclusions. Statistical or judgmental methods available.' },
         'assertions': { title: 'Assertions', content: 'Claims about statements: Existence, Completeness, Valuation, Rights, Presentation.' },
         'internal_controls': { title: 'Internal Controls', content: 'Processes for reliable reporting. Strong controls = less testing needed.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Financial Auditing', desc: 'Learn how external auditors verify financial statement accuracy.' },
         { title: 'Materiality', desc: 'Set threshold for significance based on benchmarks like revenue or assets.', icon: 'üìè' },
         { title: 'Audit Risk Model', desc: 'Audit Risk = Inherent √ó Control √ó Detection Risk. Plan accordingly.', icon: '‚öñÔ∏è' },
         { title: 'Testing Approaches', desc: 'Tests of controls vs substantive tests. Different purposes.', icon: 'üîç' },
         { title: 'Audit Sampling', desc: 'Test samples to form conclusions about populations.', icon: 'üìä' },
         { title: 'Audit Opinions', desc: 'Express whether statements are fairly presented.', icon: 'üìù' },
         { title: 'Start Auditing!', desc: 'Apply procedures and form judgments.', icon: '‚úÖ' }
      ];

      const scenarios = [
         { title: 'Materiality Determination', situation: 'Client: $50M revenue, $2M income, $30M assets. Thin margins, prior adjustments.', question: 'Best materiality approach?', options: ['5% of income = $100K', '0.5% of revenue = $250K', '1% of assets = $300K', '10% of income = $200K'], correct: 1, explanation: 'Revenue-based for thin margins. Income too volatile. 0.5% revenue = stable, conservative benchmark.' },
         { title: 'Control Weakness', situation: 'Inventory: counts by warehouse only, no verification, perpetual rarely reconciled, shrinkage history.', question: 'Audit response?', options: ['Rely on controls', 'Adverse opinion', 'Expand inventory testing', 'Withdraw'], correct: 2, explanation: 'Weak controls = more substantive testing. Expand observation, cutoff tests, roll-forward procedures.' },
         { title: 'Sampling Decision', situation: 'AR confirmations: 500 accounts, $2M total, materiality $100K, expecting 2% misstatement.', question: 'Best sampling approach?', options: ['Confirm all 500', 'Random sample 50', 'Stratified - focus large balances', 'Skip confirmations'], correct: 2, explanation: 'Stratified sampling targets risk. Large balances get more coverage, small accounts sampled randomly.' },
         { title: 'Audit Report', situation: 'Found: $80K misstatement (materiality $100K), going concern disclosed, $50K scope limitation.', question: 'Appropriate opinion?', options: ['Unqualified', 'Unqualified + emphasis', 'Qualified', 'Adverse'], correct: 1, explanation: 'Misstatement below materiality. Going concern disclosed = emphasis paragraph. Scope limitation immaterial.' }
      ];

      const quizQuestions = [
         { q: 'Unqualified opinion means:', options: ['No errors found', 'Fairly presented', 'Won\'t fail', 'Strong controls'], correct: 1 },
         { q: 'Materiality based on:', options: ['Auditor preference', 'Benchmark %', 'Transaction count', 'Prior year only'], correct: 1 },
         { q: 'Tests of controls evaluate:', options: ['Balances', 'Control effectiveness', 'Materiality', 'Audit risk'], correct: 1 },
         { q: 'Qualified opinion indicates:', options: ['Perfect statements', 'Except for specific item', 'Cannot audit', 'Fraud found'], correct: 1 },
         { q: 'Audit sampling used because:', options: ['Too expensive to test all', 'More accurate', 'GAAS required', 'Weak controls'], correct: 0 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìë</div><h2 className="text-2xl font-bold text-purple-800">Financial Statement Auditing</h2><p className="text-gray-600 mt-2">Audit procedures and opinions</p></div><div className="bg-purple-50 p-4 rounded-xl"><h3 className="font-semibold text-purple-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Materiality determination</li><li>‚Ä¢ Sampling techniques</li><li>‚Ä¢ Control vs substantive tests</li><li>‚Ä¢ Audit opinion types</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700">Begin Training ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-purple-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üìë'}</div><h3 className="text-xl font-bold text-purple-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Audit started']); } }} className="flex-1 py-3 bg-purple-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-purple-600">Issue {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-purple-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-purple-800">{sc.title}</h3><button onClick={() => { setInfoKey('materiality'); setShowInfo(true); }} className="text-purple-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-purple-50 p-4 rounded-xl"><p className="text-sm text-purple-800"><strong>Guidance:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Exam ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-purple-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-purple-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-purple-800">CPA Prep</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-purple-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? '‚úÖ' : 'üìë'}</div><h2 className="text-2xl font-bold text-purple-800">Audit Complete!</h2></div><div className="bg-purple-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-purple-700">{pct}%</div><div className="text-sm text-gray-600">Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const EsgReportingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'scope_emissions': { title: 'Emission Scopes', content: 'Scope 1: Direct. Scope 2: Purchased energy. Scope 3: Supply chain, travel, products.' },
         'materiality_esg': { title: 'Double Materiality', content: 'Financial impact ON company + company impact ON society/environment. EU requires both.' },
         'frameworks': { title: 'ESG Frameworks', content: 'GRI: stakeholder focus. SASB: investor focus. TCFD: climate risk. ISSB: global baseline.' },
         'greenwashing': { title: 'Greenwashing', content: 'Misleading environmental claims. Red flags: vague terms, no proof, hidden tradeoffs.' },
         'carbon_accounting': { title: 'Carbon Accounting', content: 'Measuring GHG in CO2e. Methods: spend-based, activity-based, supplier-specific.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to ESG Reporting', desc: 'Measure and communicate Environmental, Social, and Governance performance.' },
         { title: 'The Three Pillars', desc: 'E: Carbon, water, waste. S: Labor, diversity, community. G: Board, ethics, pay.', icon: 'üåç' },
         { title: 'Carbon Accounting', desc: 'Measure emissions across Scope 1, 2, and 3. Foundation of climate disclosure.', icon: 'üí®' },
         { title: 'Frameworks', desc: 'GRI, SASB, TCFD, ISSB - know which apply and how they differ.', icon: 'üìä' },
         { title: 'Double Materiality', desc: 'Both financial impact and societal impact matter.', icon: '‚öñÔ∏è' },
         { title: 'Avoiding Greenwashing', desc: 'Claims must be specific, verifiable, meaningful.', icon: 'üö´' },
         { title: 'Start Reporting!', desc: 'Apply ESG concepts to real challenges.', icon: 'üìà' }
      ];

      const scenarios = [
         { title: 'Scope 3 Challenge', situation: 'Manufacturing: Scope 1 = 10K tons, Scope 2 = 5K tons, Suppliers = 50K, Product use = 200K.', question: 'What % is Scope 3?', options: ['15%', '50%', '75%', '94%'], correct: 3, explanation: 'Total = 265K. Scope 3 = 250K = 94%. Typical - Scope 3 dominates but hardest to measure.' },
         { title: 'Framework Selection', situation: 'Public oil company. Investors want climate disclosure. Operating in EU and US.', question: 'Best framework combo?', options: ['GRI only', 'SASB + TCFD', 'ISSB only', 'Proprietary'], correct: 1, explanation: 'SASB = industry-specific for investors. TCFD = climate risk focus. Together satisfy investor needs.' },
         { title: 'Greenwashing Detection', situation: '"Made with recycled materials" (5% recycled). "Carbon neutral" (cheap offsets). "Eco-friendly" (no specifics).', question: 'Which claim is defensible?', options: ['Recycled claim', 'Carbon neutral', 'Eco-friendly', 'None as stated'], correct: 3, explanation: 'All are greenwashing. Need specificity, verification, honest context.' },
         { title: 'Double Materiality', situation: 'Tech company: Water <0.1% of costs but data centers in water-stressed regions.', question: 'How treat water in reporting?', options: ['Exclude - immaterial', 'Include - impact materiality', 'Only if investors ask', 'Voluntary only'], correct: 1, explanation: 'Under double materiality, community impact makes it material despite low financial impact.' }
      ];

      const quizQuestions = [
         { q: 'Scope 2 emissions are from:', options: ['Company vehicles', 'Purchased electricity', 'Supply chain', 'Product use'], correct: 1 },
         { q: 'TCFD focuses on:', options: ['Labor practices', 'Climate financial risk', 'Board diversity', 'Water usage'], correct: 1 },
         { q: 'Double materiality considers:', options: ['Financial only', 'Environmental only', 'Both financial and impact', 'Neither'], correct: 2 },
         { q: 'Quality carbon offset requires:', options: ['Low cost', 'Additionality and permanence', 'Nearby location', 'Tree planting only'], correct: 1 },
         { q: 'ESG measures:', options: ['Environmental only', 'Financial performance', 'E, S, and G factors', 'Stock price'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üåç</div><h2 className="text-2xl font-bold text-teal-800">ESG Reporting</h2><p className="text-gray-600 mt-2">Sustainability and carbon accounting</p></div><div className="bg-teal-50 p-4 rounded-xl"><h3 className="font-semibold text-teal-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Carbon accounting (Scopes 1-3)</li><li>‚Ä¢ ESG frameworks</li><li>‚Ä¢ Double materiality</li><li>‚Ä¢ Greenwashing avoidance</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold hover:bg-teal-700">Begin Training ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-teal-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üåç'}</div><h3 className="text-xl font-bold text-teal-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['ESG assessment started']); } }} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-teal-600">Case {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-teal-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-teal-800">{sc.title}</h3><button onClick={() => { setInfoKey('scope_emissions'); setShowInfo(true); }} className="text-teal-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-teal-50 p-4 rounded-xl"><p className="text-sm text-teal-800"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-teal-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-teal-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-teal-800">ESG Certification</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-teal-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üå±' : 'üåç'}</div><h2 className="text-2xl font-bold text-teal-800">ESG Complete!</h2></div><div className="bg-teal-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-teal-700">{pct}%</div><div className="text-sm text-gray-600">ESG Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const CryptoAccountingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'cost_basis': { title: 'Cost Basis Methods', content: 'FIFO: First coins bought sold first. LIFO: Last coins sold first. Specific ID: Choose which coins to sell. HIFO: Highest cost first (minimizes gains).' },
         'fair_value': { title: 'Fair Value Measurement', content: 'Crypto typically valued at fair value. Use principal market price. Impairment losses recognized immediately under old rules; FASB now allows fair value gains too.' },
         'defi_yield': { title: 'DeFi Yield Accounting', content: 'Staking rewards: Income when received. Liquidity mining: Complex - may be income or cost basis adjustment. Airdrops: Income at FMV when dominion established.' },
         'nft_accounting': { title: 'NFT Accounting', content: 'NFTs are intangible assets. Cost includes gas fees. Royalties on secondary sales recognized when received. Impairment testing required.' },
         'wallet_tracking': { title: 'Wallet Tracking', content: 'Track across all wallets and exchanges. Each transfer needs documentation. Gas fees add to cost basis or are deductible expenses.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Crypto Accounting', desc: 'Navigate the complex world of cryptocurrency taxation and financial reporting.' },
         { title: 'Cost Basis Tracking', desc: 'Every purchase creates a tax lot. Track acquisition date, cost, and fees for each crypto unit.', icon: 'üìä' },
         { title: 'Taxable Events', desc: 'Selling, trading, spending crypto triggers gains/losses. Transferring between your wallets does not.', icon: 'üí∏' },
         { title: 'DeFi Complexities', desc: 'Staking, yield farming, liquidity pools each have unique tax implications.', icon: 'üîÑ' },
         { title: 'Fair Value Reporting', desc: 'GAAP requires fair value measurement. New FASB rules allow recognizing both gains and losses.', icon: 'üìà' },
         { title: 'Record Keeping', desc: 'Maintain detailed records of all transactions, wallets, and cost basis calculations.', icon: 'üìù' },
         { title: 'Start Trading!', desc: 'Apply crypto accounting to real scenarios.', icon: '‚Çø' }
      ];

      const scenarios = [
         { title: 'Cost Basis Selection', situation: 'Bought 1 BTC at $20K (Jan), 1 BTC at $40K (Mar), 1 BTC at $30K (Jun). Selling 1 BTC now at $50K. Want to minimize taxes.', question: 'Which cost basis method minimizes gain?', options: ['FIFO - $30K gain', 'LIFO - $20K gain', 'HIFO - $10K gain', 'Average - $20K gain'], correct: 2, explanation: 'HIFO (Highest In, First Out) uses $40K cost basis, creating only $10K gain. Specific identification lets you choose which lot to sell. FIFO would use $20K basis = $30K gain.' },
         { title: 'Staking Rewards Tax', situation: 'Staked 10 ETH, received 0.5 ETH in staking rewards over the year. ETH price was $2,000 when rewards received.', question: 'What is the tax treatment?', options: ['No tax until sold', '$1,000 ordinary income', '$1,000 capital gain', 'Depends on holding period'], correct: 1, explanation: 'Staking rewards are ordinary income when received, valued at FMV ($2,000 √ó 0.5 = $1,000). This becomes the cost basis. Future sale creates capital gain/loss from this basis.' },
         { title: 'NFT Creator Taxes', situation: 'Artist mints NFT (gas: $100), sells for 2 ETH ($4,000). Later receives 0.2 ETH ($400) royalty on secondary sale.', question: 'Total taxable income?', options: ['$4,000', '$4,300', '$3,900 + $400 = $4,300', '$4,400'], correct: 2, explanation: 'Primary sale: $4,000 - $100 gas = $3,900 income (or self-employment income). Royalty: $400 ordinary income when received. Total: $4,300. Gas is cost of goods sold.' },
         { title: 'Wrapped Token Swap', situation: 'Swap 1 ETH ($3,000 FMV, $1,000 basis) for 1 WETH. Later unwrap WETH back to ETH.', question: 'Tax treatment of wrapping/unwrapping?', options: ['Taxable - $2,000 gain on wrap', 'Non-taxable - like-kind exchange', 'IRS position unclear, conservative = taxable', 'Only taxable on unwrap'], correct: 2, explanation: 'IRS hasn\'t provided clear guidance. Conservative approach treats as taxable (like crypto-to-crypto trades). Some argue wrapping is non-taxable as economically equivalent. Document your position.' }
      ];

      const quizQuestions = [
         { q: 'Transferring crypto between your own wallets is:', options: ['Taxable event', 'Non-taxable', 'Capital gain', 'Ordinary income'], correct: 1 },
         { q: 'Crypto staking rewards are taxed as:', options: ['Capital gains', 'Ordinary income', 'Not taxable', 'Depends on amount'], correct: 1 },
         { q: 'HIFO method stands for:', options: ['High Income First Out', 'Highest In First Out', 'Historic Investment First Out', 'Holding Index First Out'], correct: 1 },
         { q: 'Gas fees paid to buy crypto:', options: ['Are lost', 'Add to cost basis', 'Are immediately deductible', 'Reduce sale price'], correct: 1 },
         { q: 'New FASB crypto rules allow:', options: ['Only impairment losses', 'Fair value gains and losses', 'No mark-to-market', 'Cost basis only'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">‚Çø</div><h2 className="text-2xl font-bold text-orange-800">Crypto Accounting</h2><p className="text-gray-600 mt-2">Cryptocurrency taxation and reporting</p></div><div className="bg-orange-50 p-4 rounded-xl"><h3 className="font-semibold text-orange-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Cost basis tracking methods</li><li>‚Ä¢ Taxable vs non-taxable events</li><li>‚Ä¢ DeFi and staking taxes</li><li>‚Ä¢ NFT accounting</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold hover:bg-orange-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-orange-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || '‚Çø'}</div><h3 className="text-xl font-bold text-orange-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Crypto accounting started']); } }} className="flex-1 py-3 bg-orange-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-orange-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-orange-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-orange-800">{sc.title}</h3><button onClick={() => { setInfoKey('cost_basis'); setShowInfo(true); }} className="text-orange-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-orange-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-orange-50 p-4 rounded-xl"><p className="text-sm text-orange-800"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-orange-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-orange-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-orange-800">Crypto Tax Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-orange-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-orange-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : '‚Çø'}</div><h2 className="text-2xl font-bold text-orange-800">Crypto Accounting Complete!</h2></div><div className="bg-orange-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-orange-700">{pct}%</div><div className="text-sm text-gray-600">Crypto Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const TaxCreditsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'rd_credit': { title: 'R&D Tax Credit', content: 'Credit for qualified research expenses. 20% of expenses over base amount, or 14% simplified method. Can offset payroll taxes for startups.' },
         'work_opportunity': { title: 'Work Opportunity Credit', content: 'Credit for hiring from targeted groups (veterans, ex-felons, SNAP recipients). Up to $9,600 per qualified employee.' },
         'investment_credits': { title: 'Investment Tax Credits', content: 'Credits for specific investments: solar (30% ITC), historic rehabilitation (20%), low-income housing, energy efficiency.' },
         'refundable_vs_non': { title: 'Refundable vs Non-Refundable', content: 'Refundable: Get cash even with no tax liability. Non-refundable: Only reduces tax to zero. Carryforward rules vary.' },
         'state_credits': { title: 'State Tax Credits', content: 'States offer additional credits: job creation, film production, enterprise zones, angel investment. Stack with federal credits.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Tax Credits', desc: 'Learn to identify and maximize valuable tax credits for businesses.' },
         { title: 'Credits vs Deductions', desc: 'Credits reduce tax dollar-for-dollar. Deductions only reduce taxable income. $1 credit = $1 savings!', icon: 'üíµ' },
         { title: 'R&D Tax Credit', desc: 'One of the most valuable credits. Covers wages, supplies, and contractor costs for qualified research.', icon: 'üî¨' },
         { title: 'Employment Credits', desc: 'Work Opportunity, Employee Retention, and other credits reward hiring and retention.', icon: 'üë•' },
         { title: 'Investment Credits', desc: 'Solar, historic rehabilitation, and energy credits incentivize specific investments.', icon: 'üèóÔ∏è' },
         { title: 'Credit Optimization', desc: 'Stack federal and state credits. Understand carryback/carryforward rules.', icon: 'üìä' },
         { title: 'Start Claiming!', desc: 'Apply tax credit strategies to maximize savings.', icon: '‚úÖ' }
      ];

      const scenarios = [
         { title: 'R&D Credit Qualification', situation: 'Software company spent: $200K developer salaries (new features), $50K bug fixes, $30K cloud hosting for dev, $20K third-party API licenses.', question: 'Which expenses qualify for R&D credit?', options: ['All $300K', '$200K salaries only', '$200K salaries + $30K cloud', '$250K (salaries + cloud + some fixes)'], correct: 2, explanation: 'Developer salaries for new features qualify. Cloud hosting for development qualifies. Bug fixes generally don\'t (not technological uncertainty). API licenses are supplies but may not qualify if not consumed in research.' },
         { title: 'Startup R&D Election', situation: 'Pre-revenue startup with $100K R&D credit but $0 income tax liability. Has $500K in payroll taxes annually.', question: 'How can they use the credit?', options: ['Carry forward only', 'Offset up to $250K payroll tax', 'Get cash refund', 'Credit is lost'], correct: 1, explanation: 'Qualified small businesses (< $5M revenue, < 5 years) can elect to apply R&D credit against payroll taxes. Up to $250K per year for up to 5 years. Huge benefit for startups!' },
         { title: 'Work Opportunity Credit', situation: 'Restaurant hires: 2 veterans (worked 500+ hours each), 1 SNAP recipient (worked 300 hours), 1 ex-felon (worked 150 hours).', question: 'Maximum WOTC credit available?', options: ['$4,800', '$9,600', '$14,400', '$19,200'], correct: 2, explanation: 'Veterans 500+ hrs: $2,400 each = $4,800. SNAP 300 hrs: partial credit ~$1,500. Ex-felon 150 hrs: below 120-hr minimum = $0. But max for disabled vets can be $9,600. Approx $14,400 total depending on wages.' },
         { title: 'Solar Investment Credit', situation: 'Company installs $1M solar system in 2024. Also received $200K state rebate. Placed in service December 2024.', question: 'What is the federal ITC?', options: ['$300K (30% of $1M)', '$240K (30% of net cost)', '$200K (20% rate)', '$260K (30% of $1M less half rebate)'], correct: 1, explanation: 'ITC basis must be reduced by government grants/rebates. $1M - $200K = $800K eligible basis. 30% √ó $800K = $240K credit. Timing matters - placed in service in 2024 gets 30% rate.' }
      ];

      const quizQuestions = [
         { q: 'Tax credits differ from deductions because credits:', options: ['Reduce taxable income', 'Reduce tax dollar-for-dollar', 'Are always refundable', 'Only apply to corporations'], correct: 1 },
         { q: 'Startups can apply R&D credits against:', options: ['Income tax only', 'Payroll taxes', 'Sales tax', 'Property tax'], correct: 1 },
         { q: 'Work Opportunity Credit requires minimum hours of:', options: ['40 hours', '120 hours', '400 hours', '1,000 hours'], correct: 1 },
         { q: 'The current solar ITC rate is:', options: ['10%', '20%', '26%', '30%'], correct: 3 },
         { q: 'Non-refundable credits can:', options: ['Generate cash refund', 'Only reduce tax to zero', 'Be sold to others', 'Never carry forward'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üí∞</div><h2 className="text-2xl font-bold text-emerald-800">Tax Credits</h2><p className="text-gray-600 mt-2">Maximize valuable business tax credits</p></div><div className="bg-emerald-50 p-4 rounded-xl"><h3 className="font-semibold text-emerald-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ R&D tax credit strategies</li><li>‚Ä¢ Employment-based credits</li><li>‚Ä¢ Investment tax credits</li><li>‚Ä¢ Credit optimization</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-emerald-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üí∞'}</div><h3 className="text-xl font-bold text-emerald-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Tax credit analysis started']); } }} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-emerald-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-emerald-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-emerald-800">{sc.title}</h3><button onClick={() => { setInfoKey('rd_credit'); setShowInfo(true); }} className="text-emerald-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-emerald-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-emerald-50 p-4 rounded-xl"><p className="text-sm text-emerald-800"><strong>Analysis:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next ‚Üí' : 'Quiz ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-emerald-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-emerald-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-emerald-800">Tax Credit Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-emerald-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-emerald-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üí∞'}</div><h2 className="text-2xl font-bold text-emerald-800">Tax Credits Complete!</h2></div><div className="bg-emerald-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-emerald-700">{pct}%</div><div className="text-sm text-gray-600">Tax Credit Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const FractionalCfoRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'fractional_model': { title: 'Fractional CFO Model', content: 'Part-time CFO services for companies that need strategic finance but can\'t justify full-time cost. Typically 10-20 hours/month.' },
         'cash_runway': { title: 'Cash Runway', content: 'Months of operation remaining at current burn rate. Runway = Cash Balance √∑ Monthly Burn. Critical metric for startups.' },
         'board_reporting': { title: 'Board Reporting', content: 'Monthly/quarterly financial packages for board. Include: P&L vs budget, cash position, KPIs, risks, and forward guidance.' },
         'fundraising': { title: 'Fundraising Support', content: 'Prepare data room, financial model, cap table. Support due diligence, negotiate terms, coordinate legal/accounting.' },
         'financial_systems': { title: 'Financial Systems', content: 'Implement accounting software, reporting dashboards, budgeting tools. Build scalable processes for growth.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Fractional CFO', desc: 'Learn to provide strategic finance leadership to growing companies.' },
         { title: 'The Fractional Model', desc: 'Provide CFO-level expertise part-time. Perfect for $1-20M revenue companies.', icon: 'üëî' },
         { title: 'Cash Management', desc: 'Monitor runway, forecast cash needs, optimize working capital. Survival first.', icon: 'üíµ' },
         { title: 'Strategic Planning', desc: 'Build financial models, set KPIs, guide pricing and growth strategy.', icon: 'üìä' },
         { title: 'Board & Investor Relations', desc: 'Prepare board packages, support fundraising, manage investor communications.', icon: 'ü§ù' },
         { title: 'Systems & Processes', desc: 'Implement scalable financial infrastructure, controls, and reporting.', icon: '‚öôÔ∏è' },
         { title: 'Start Advising!', desc: 'Apply fractional CFO skills to real client scenarios.', icon: 'üéØ' }
      ];

      const scenarios = [
         { title: 'Runway Crisis', situation: 'SaaS startup: $500K cash, $100K monthly burn, 8 months from profitability. Fundraising will take 4-6 months. Current runway: 5 months.', question: 'What is your immediate priority?', options: ['Start fundraising immediately', 'Cut burn to extend runway to 8+ months', 'Both - cut costs AND start fundraising', 'Focus on growth to hit profitability faster'], correct: 2, explanation: 'Need runway cushion for fundraising timeline. Cut burn to 8+ months immediately AND start fundraising. Can\'t rely on hitting profitability - too risky. Growth focus without runway is a death spiral.' },
         { title: 'Board Package Essentials', situation: 'First board meeting with new investors. CEO asks what to include in financial package.', question: 'What are the essential components?', options: ['Just P&L and balance sheet', 'P&L vs budget, cash forecast, KPIs, risks', 'Detailed transaction list', 'Only forward projections'], correct: 1, explanation: 'Board needs: actual vs budget variance analysis (P&L), cash position and forecast, key metrics/KPIs trending, risk register, and forward guidance. Historical detail less important than trends and outlook.' },
         { title: 'Pricing Strategy Review', situation: 'Client sells SaaS at $99/month. CAC is $800, LTV is $1,200 (12-month average lifetime). Gross margin 80%.', question: 'What is your pricing recommendation?', options: ['Price is fine - 1.5x LTV/CAC', 'Raise prices - LTV/CAC too low', 'Lower prices for volume', 'Focus on reducing CAC first'], correct: 1, explanation: 'LTV/CAC of 1.5x is below 3x target. With 80% margin, price increase flows to profit. Raising to $129 would boost LTV to ~$1,550. Also work on retention to extend lifetime. CAC reduction helps but pricing has immediate impact.' },
         { title: 'Due Diligence Prep', situation: 'Series A investor sends due diligence request list. Client has messy books, no data room, contracts scattered.', question: 'How do you prioritize the 2-week deadline?', options: ['Clean up all historical books first', 'Build data room with available docs, flag gaps', 'Ask for extension', 'Have client handle it directly'], correct: 1, explanation: 'Time is critical in fundraising. Build data room with what\'s available, clearly flag gaps and remediation timeline. Investors expect some messiness in early stage. Delays kill deals. Clean up in parallel, don\'t block.' }
      ];

      const quizQuestions = [
         { q: 'Fractional CFO typically works:', options: ['Full-time', '10-20 hours/month', 'Only during fundraising', 'Hourly as needed'], correct: 1 },
         { q: 'Target LTV/CAC ratio for SaaS is:', options: ['1:1', '2:1', '3:1 or higher', '5:1 minimum'], correct: 2 },
         { q: 'Cash runway calculation is:', options: ['Revenue √∑ Expenses', 'Cash √∑ Monthly Burn', 'Assets √∑ Liabilities', 'Profit √ó 12'], correct: 1 },
         { q: 'Board packages should emphasize:', options: ['Transaction details', 'Variance analysis and trends', 'Tax planning', 'Employee data'], correct: 1 },
         { q: 'First priority in cash crisis:', options: ['Raise prices', 'Cut costs to extend runway', 'Hire more sales', 'Wait and see'], correct: 1 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üëî</div><h2 className="text-2xl font-bold text-indigo-800">Fractional CFO</h2><p className="text-gray-600 mt-2">Strategic finance leadership for growing companies</p></div><div className="bg-indigo-50 p-4 rounded-xl"><h3 className="font-semibold text-indigo-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Cash runway management</li><li>‚Ä¢ Board and investor relations</li><li>‚Ä¢ Strategic financial planning</li><li>‚Ä¢ Fundraising support</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-indigo-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon || 'üëî'}</div><h3 className="text-xl font-bold text-indigo-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div><div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['CFO engagement started']); } }} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Start ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-indigo-600">Client {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-indigo-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-indigo-800">{sc.title}</h3><button onClick={() => { setInfoKey('cash_runway'); setShowInfo(true); }} className="text-indigo-500">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Advised: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-indigo-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-indigo-50 p-4 rounded-xl"><p className="text-sm text-indigo-800"><strong>Strategic Insight:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Client ‚Üí' : 'Final Assessment ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-indigo-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-indigo-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-indigo-800">CFO Assessment</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-indigo-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-indigo-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üéØ' : 'üëî'}</div><h2 className="text-2xl font-bold text-indigo-800">Fractional CFO Complete!</h2></div><div className="bg-indigo-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-indigo-700">{pct}%</div><div className="text-sm text-gray-600">CFO Mastery</div></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const AsoKeywordsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [platform, setPlatform] = useState<'ios' | 'android'>('ios');
      const [selectedKeywords, setSelectedKeywords] = useState<string[]>([]);
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'search_volume': { title: 'Search Volume', content: 'Number of times this term is searched monthly in the app store. Higher volume = more potential traffic, but usually more competition.' },
         'difficulty': { title: 'Keyword Difficulty', content: 'How hard it is to rank for this keyword. Based on competitor strength and number of apps targeting it. 1-10 scale, higher = harder.' },
         'chance': { title: 'Ranking Chance', content: 'Your probability of ranking in top 10 for this keyword, based on your current app authority and competition level.' },
         'ios_field': { title: 'iOS Keyword Field', content: 'Apple gives you 100 characters for keywords. Use commas to separate, no spaces after commas. Don\'t repeat words from your title - it wastes space.' },
         'android_keywords': { title: 'Android Keywords', content: 'Google extracts keywords from your title and description. Repeat important keywords 3-5 times naturally. Phrase matching is more forgiving than iOS.' },
         'long_tail': { title: 'Long-Tail Keywords', content: 'Longer, more specific phrases with lower volume but higher intent. "fitness app" is broad; "home workout for beginners" is long-tail with better conversion.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to ASO Keywords', desc: '65% of app installs come from search. Master keywords to get discovered by the right users.', icon: 'üîç' },
         { title: 'How Users Find Apps', desc: 'Users type search queries in the App Store. Your app appears if your keywords match their search. No match = invisible.', icon: 'üì±' },
         { title: 'The Keyword Tradeoff', desc: 'High volume keywords have more searches but fierce competition. Low difficulty keywords are easier to rank but fewer searches apply.', icon: '‚öñÔ∏è' },
         { title: 'iOS vs Android Differences', desc: 'iOS: 100-char keyword field, exact match. Android: Keywords in title/description, phrase matching. Different strategies required.', icon: 'üçé' },
         { title: 'The Sweet Spot', desc: 'Target keywords with decent volume AND achievable rankings. Ranking #5 for 10 terms beats ranking #50 for 2 popular terms.', icon: 'üéØ' },
         { title: 'Keyword Research Process', desc: 'Analyze competitors, check search volume, assess difficulty, test different combinations, and iterate based on ranking changes.', icon: 'üìä' },
         { title: 'Start Optimizing!', desc: 'Apply ASO keyword strategies to boost organic app discovery.', icon: 'üöÄ' }
      ];

      const keywordDatabase = [
         { keyword: 'fitness tracker', volume: 85, difficulty: 9, chance: 12 },
         { keyword: 'workout app', volume: 92, difficulty: 10, chance: 5 },
         { keyword: 'home workout', volume: 78, difficulty: 8, chance: 18 },
         { keyword: 'exercise log', volume: 45, difficulty: 5, chance: 45 },
         { keyword: 'gym tracker', volume: 52, difficulty: 6, chance: 38 },
         { keyword: 'calorie counter', volume: 88, difficulty: 9, chance: 8 },
         { keyword: 'step counter', volume: 65, difficulty: 7, chance: 22 },
         { keyword: 'weight loss', volume: 95, difficulty: 10, chance: 3 },
         { keyword: 'HIIT timer', volume: 28, difficulty: 4, chance: 62 },
         { keyword: 'workout planner', volume: 38, difficulty: 5, chance: 48 }
      ];

      const scenarios = [
         { title: 'New App Launch Strategy', situation: 'You\'re launching a new fitness app with zero existing authority. Your budget is limited. You need organic installs fast.', question: 'Which keyword strategy is best for a new app?', options: ['Target highest volume keywords like "fitness app"', 'Focus on low difficulty keywords you can actually rank for', 'Copy exact keywords from top competitor', 'Use only branded keywords'], correct: 1, explanation: 'New apps can\'t compete for high-volume keywords. Start with low-difficulty, medium-volume keywords where you can rank top 10. Build authority, then expand to harder keywords. Ranking #5 for "HIIT timer" beats ranking #150 for "fitness app".' },
         { title: 'iOS Character Limit', situation: 'iOS gives 100 characters for keywords. Your title is "FitPro - Workout Tracker". You\'ve drafted: "fitness tracker, workout app, exercise log, gym, health, fit, training, routine"', question: 'What\'s wrong with this keyword list?', options: ['Too many keywords', 'Keywords are too generic', '"Workout" and "tracker" waste space (already in title)', 'Should include competitor names'], correct: 2, explanation: 'Apple indexes your title separately. "Workout" and "tracker" are already covered - repeating them wastes 16 characters. Remove duplicates, add unique keywords. Also, single words like "gym" "health" "fit" are too broad and competitive.' },
         { title: 'Android Long Description', situation: 'Your Android app description needs keyword optimization. You want to rank for "home workout for beginners".', question: 'How should you incorporate this keyword?', options: ['Stuff it 20 times throughout the description', 'Use it naturally 3-5 times in context', 'Put it only in the first sentence', 'Don\'t use it - Google ignores descriptions'], correct: 1, explanation: 'Google reads your full description but penalizes keyword stuffing. Use target keywords 3-5 times naturally. Variations help: "home workouts", "beginner workout at home". First paragraph is weighted more heavily, so include primary keywords there.' },
         { title: 'Competitor Keyword Analysis', situation: 'Your top competitor ranks #1 for "daily workout reminder". They have 50K reviews, you have 500. The keyword has medium volume.', question: 'Should you target this keyword?', options: ['Yes - if they rank, you can too', 'Yes - but as secondary priority, not primary', 'No - you can\'t beat 50K reviews', 'No - competitor keywords are off-limits'], correct: 1, explanation: 'You CAN target competitor keywords, but prioritize realistically. With 500 vs 50K reviews, you won\'t rank #1 soon. Add it to your list but don\'t make it your primary focus. Target keywords where the gap is smaller while building authority.' }
      ];

      const quizQuestions = [
         { q: 'What percentage of app installs come from App Store search?', options: ['25%', '45%', '65%', '85%'], correct: 2 },
         { q: 'iOS keyword field character limit is:', options: ['50 characters', '100 characters', '200 characters', 'Unlimited'], correct: 1 },
         { q: 'The best keyword strategy targets:', options: ['Highest volume only', 'Lowest difficulty only', 'Balance of volume and achievable ranking', 'Competitor exact keywords'], correct: 2 },
         { q: 'On Android, Google extracts keywords from:', options: ['Hidden keyword field', 'Title and description', 'Only the title', 'User reviews'], correct: 1 },
         { q: 'Long-tail keywords are characterized by:', options: ['High volume, high competition', 'Low volume, higher intent', 'Only brand terms', 'Single words'], correct: 1 }
      ];

      const getCharCount = () => selectedKeywords.join(',').length;
      const maxChars = platform === 'ios' ? 100 : 500;

      const toggleKeyword = (kw: string) => {
         if (selectedKeywords.includes(kw)) {
            setSelectedKeywords(selectedKeywords.filter(k => k !== kw));
         } else if (getCharCount() + kw.length + 1 <= maxChars) {
            setSelectedKeywords([...selectedKeywords, kw]);
         }
      };

      const getProjectedInstalls = () => {
         return selectedKeywords.reduce((total, kw) => {
            const kwData = keywordDatabase.find(k => k.keyword === kw);
            if (kwData && kwData.chance > 30) return total + Math.floor(kwData.volume * 0.15);
            if (kwData && kwData.chance > 15) return total + Math.floor(kwData.volume * 0.05);
            return total + 5;
         }, 0);
      };

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üîç</div><h2 className="text-2xl font-bold text-blue-800">ASO Keywords</h2><p className="text-gray-600 mt-2">Master App Store Optimization to get discovered</p></div><div className="bg-blue-50 p-4 rounded-xl"><h3 className="font-semibold text-blue-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Keyword research and selection</li><li>‚Ä¢ iOS vs Android differences</li><li>‚Ä¢ Volume vs difficulty tradeoffs</li><li>‚Ä¢ Ranking strategy for new apps</li></ul></div><div className="bg-amber-50 p-3 rounded-lg border border-amber-200"><p className="text-sm text-amber-800"><strong>Why It Matters:</strong> 65% of installs come from search. Wrong keywords = invisible app.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-blue-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon}</div><h3 className="text-xl font-bold text-blue-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div>{tutorialStep === 1 && (<div className="bg-gray-100 p-4 rounded-xl text-sm"><div className="font-mono text-center">User types: "workout tracker"<br/>‚Üì<br/>App Store searches all keywords<br/>‚Üì<br/>Your app appears if keywords match</div></div>)}{tutorialStep === 2 && (<div className="bg-gray-100 p-4 rounded-xl"><div className="flex justify-between text-sm"><div className="text-center"><div className="font-bold text-red-600">High Volume</div><div>More searches</div><div>More competition</div><div>Harder to rank</div></div><div className="text-center"><div className="font-bold text-green-600">Low Difficulty</div><div>Fewer searches</div><div>Less competition</div><div>Easier to rank</div></div></div></div>)}<div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['ASO keyword optimization started']); } }} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Practice Keywords ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-blue-600">Scenario {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="flex gap-2 mb-2"><button onClick={() => setPlatform('ios')} className={`flex-1 py-2 rounded-lg text-sm font-medium ${platform === 'ios' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>üçé iOS</button><button onClick={() => setPlatform('android')} className={`flex-1 py-2 rounded-lg text-sm font-medium ${platform === 'android' ? 'bg-green-600 text-white' : 'bg-gray-200'}`}>ü§ñ Android</button></div><div className="bg-blue-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-blue-800">{sc.title}</h3><button onClick={() => { setInfoKey('search_volume'); setShowInfo(true); }} className="text-blue-500 hover:text-blue-700">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } else { setGameLog([...gameLog, `Review: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Key Insight:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Final Assessment ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-blue-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-blue-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-blue-800">ASO Knowledge Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-blue-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-blue-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üîç'}</div><h2 className="text-2xl font-bold text-blue-800">ASO Keywords Complete!</h2></div><div className="bg-blue-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-blue-700">{pct}%</div><div className="text-sm text-gray-600">ASO Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ 65% of installs come from search</li><li>‚Ä¢ Target achievable keywords first</li><li>‚Ä¢ iOS: 100 chars, exact match</li><li>‚Ä¢ Android: Title + description</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const AsoCreativeOptimizationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoKey, setInfoKey] = useState<string>('');
      const [testVariant, setTestVariant] = useState<'A' | 'B'>('A');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);

      const infoContent: Record<string, { title: string; content: string }> = {
         'conversion_rate': { title: 'Store Conversion Rate', content: 'Percentage of users who view your store listing and then install. Industry average is 25-35%. Improving from 25% to 35% means 40% more installs from same traffic.' },
         'icon_design': { title: 'Icon Best Practices', content: 'Icons appear at 60x60px in search. Use bold colors that stand out, avoid text (unreadable), ensure it\'s recognizable at thumbnail size.' },
         'screenshot_order': { title: 'Screenshot Strategy', content: 'First 2-3 screenshots get 80% of views. Lead with your best feature. Use large text captions readable without tapping. Show the app, not just graphics.' },
         'ab_testing': { title: 'A/B Testing', content: 'Test one element at a time (icon OR screenshots, not both). Run until statistically significant (95% confidence). Winner can improve conversion 10-40%.' },
         'statistical_significance': { title: 'Statistical Significance', content: 'Need enough data to be confident results aren\'t random. 95% confidence means 5% chance the winner was just luck. More traffic = faster results.' }
      };

      const tutorialSteps = [
         { title: 'Welcome to Creative Optimization', desc: 'Your icon and screenshots are your storefront. Users decide in 3 seconds whether to read more or scroll past.', icon: 'üé®' },
         { title: 'The 3-Second Decision', desc: 'Users scan hundreds of apps. Your visuals must instantly communicate what your app does and why it\'s worth installing.', icon: '‚è±Ô∏è' },
         { title: 'Icon Design Principles', desc: 'Stand out from competitors. Be visible at 60x60px. Don\'t use text. Use colors that pop against the store\'s white background.', icon: 'üì±' },
         { title: 'Screenshot Strategy', desc: 'First 2-3 screenshots matter most. Lead with your best feature. Use large captions. Show real app UI, not just marketing graphics.', icon: 'üñºÔ∏è' },
         { title: 'A/B Testing Basics', desc: 'Never guess - test! Run controlled experiments to find what converts better. A 20% improvement means 20% more installs forever.', icon: 'üî¨' },
         { title: 'Statistical Confidence', desc: 'Wait for 95% confidence before declaring a winner. Too little data = misleading results. Be patient with small traffic.', icon: 'üìä' },
         { title: 'Start Optimizing!', desc: 'Apply A/B testing principles to improve your store conversion.', icon: 'üöÄ' }
      ];

      const scenarios = [
         { title: 'Icon Color Test', situation: 'Your fitness app has a blue icon. Most competitor icons are also blue or white. Your store conversion is 22% (below 30% category average).', question: 'What should you test first?', options: ['Add text to the icon for clarity', 'Test a bold green or orange icon', 'Make the icon more detailed', 'Copy the top competitor\'s icon'], correct: 1, explanation: 'Stand out from the sea of blue! Green and orange icons pop against competitors and the white store background. Text is unreadable at small sizes. Copying competitors makes you blend in. Color differentiation often improves conversion 15-30%.' },
         { title: 'Screenshot Order', situation: 'Your app has these features: (A) Core workout tracking, (B) Social challenges, (C) AI coach, (D) Progress stats. Analytics show 70% of users only see first 2 screenshots.', question: 'How should you order your screenshots?', options: ['Alphabetically: AI, Challenges, Progress, Tracking', 'By development order: oldest to newest', 'By user priority: Tracking ‚Üí Progress ‚Üí AI ‚Üí Social', 'By visual appeal: prettiest screenshots first'], correct: 2, explanation: 'Lead with your core value proposition (workout tracking), then show results (progress), then differentiators (AI). Most users only see 2-3 screenshots - put your best selling points first. Visual appeal matters, but relevance matters more.' },
         { title: 'A/B Test Duration', situation: 'You\'re testing two icons. After 3 days: Variant A has 52% conversion (500 views), Variant B has 58% conversion (480 views). Statistical confidence is 72%.', question: 'What should you do?', options: ['Declare B the winner - 6% higher!', 'Wait for 95% confidence before deciding', 'End test - sample size is too small', 'Switch to testing screenshots instead'], correct: 1, explanation: '72% confidence means there\'s a 28% chance B\'s lead is random noise. The difference could disappear with more data. Wait for 95% confidence (only 5% chance of being wrong). Rushing to declare winners leads to bad decisions.' },
         { title: 'Conversion Impact Analysis', situation: 'Your app gets 50,000 store impressions monthly. Current conversion: 25%. You\'ve run a successful icon test that improved conversion to 32%.', question: 'What\'s the annual impact of this improvement?', options: ['3,500 extra installs/year', '42,000 extra installs/year', '7,000 extra installs/month', 'Can\'t calculate without CPI'], correct: 1, explanation: 'Monthly: 50,000 √ó 25% = 12,500 installs before. 50,000 √ó 32% = 16,000 installs after. Difference: 3,500/month. Annual: 3,500 √ó 12 = 42,000 extra installs/year - all from ONE icon test! This is "free" growth with no ad spend increase.' }
      ];

      const quizQuestions = [
         { q: 'Icon thumbnails in App Store search are approximately:', options: ['120x120 pixels', '60x60 pixels', '30x30 pixels', '200x200 pixels'], correct: 1 },
         { q: 'What percentage of users typically only view first 2-3 screenshots?', options: ['30%', '50%', '70-80%', '95%'], correct: 2 },
         { q: 'A/B tests should wait for what confidence level?', options: ['50%', '75%', '95%', '100%'], correct: 2 },
         { q: 'Improving conversion from 25% to 35% means how many more installs?', options: ['10% more', '25% more', '40% more', '35% more'], correct: 2 },
         { q: 'What should you NOT include in app icons?', options: ['Bold colors', 'Simple shapes', 'Text/words', 'Brand symbols'], correct: 2 }
      ];

      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üé®</div><h2 className="text-2xl font-bold text-purple-800">ASO Creative Optimization</h2><p className="text-gray-600 mt-2">A/B test icons and screenshots for higher conversion</p></div><div className="bg-purple-50 p-4 rounded-xl"><h3 className="font-semibold text-purple-700 mb-2">You'll Master:</h3><ul className="space-y-1 text-sm text-gray-600"><li>‚Ä¢ Icon design for conversion</li><li>‚Ä¢ Screenshot strategy and ordering</li><li>‚Ä¢ A/B testing methodology</li><li>‚Ä¢ Statistical significance</li></ul></div><div className="bg-amber-50 p-3 rounded-lg border border-amber-200"><p className="text-sm text-amber-800"><strong>Why It Matters:</strong> A 20% conversion improvement = 20% more installs forever, at zero cost.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700">Start Learning ‚Üí</button></div>);
      }

      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between text-sm text-gray-500 mb-2"><span>Tutorial</span><span>{tutorialStep + 1}/{tutorialSteps.length}</span></div><div className="w-full bg-gray-200 h-2 rounded-full"><div className="bg-purple-600 h-2 rounded-full transition-all" style={{ width: `${((tutorialStep + 1) / tutorialSteps.length) * 100}%` }} /></div><div className="text-center py-8"><div className="text-5xl mb-4">{step.icon}</div><h3 className="text-xl font-bold text-purple-800">{step.title}</h3><p className="text-gray-600 mt-3">{step.desc}</p></div>{tutorialStep === 2 && (<div className="bg-gray-100 p-4 rounded-xl"><div className="flex justify-around items-center"><div className="text-center"><div className="w-12 h-12 bg-blue-500 rounded-xl mx-auto mb-1"></div><div className="text-xs text-gray-500">Blends in</div></div><div className="text-center"><div className="w-12 h-12 bg-green-500 rounded-xl mx-auto mb-1"></div><div className="text-xs text-green-600 font-bold">Stands out!</div></div><div className="text-center"><div className="w-12 h-12 bg-blue-400 rounded-xl mx-auto mb-1"></div><div className="text-xs text-gray-500">Blends in</div></div></div></div>)}{tutorialStep === 4 && (<div className="bg-gray-100 p-4 rounded-xl text-sm"><div className="grid grid-cols-2 gap-4"><div className="text-center p-3 bg-white rounded-lg"><div className="font-bold">Variant A</div><div className="text-2xl my-2">üîµ</div><div className="text-gray-600">25% conversion</div></div><div className="text-center p-3 bg-green-50 rounded-lg border-2 border-green-400"><div className="font-bold">Variant B</div><div className="text-2xl my-2">üü¢</div><div className="text-gray-600">32% conversion</div><div className="text-green-600 text-xs">+28% winner!</div></div></div></div>)}<div className="flex gap-3">{tutorialStep > 0 && (<button onClick={() => setTutorialStep(tutorialStep - 1)} className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold">‚Üê Back</button>)}<button onClick={() => { if (tutorialStep < tutorialSteps.length - 1) setTutorialStep(tutorialStep + 1); else { setPhase('play'); setGameLog(['Creative optimization started']); } }} className="flex-1 py-3 bg-purple-600 text-white rounded-xl font-semibold">{tutorialStep < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Practice Testing ‚Üí'}</button></div></div>);
      }

      if (phase === 'play') {
         const sc = scenarios[scenarioIndex];
         return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-purple-600">Test {scenarioIndex + 1}/{scenarios.length}</span><span className="text-sm">Score: {score}/{scenarioIndex}</span></div><div className="bg-purple-100 p-4 rounded-xl"><div className="flex justify-between items-start"><h3 className="font-bold text-purple-800">{sc.title}</h3><button onClick={() => { setInfoKey('ab_testing'); setShowInfo(true); }} className="text-purple-500 hover:text-purple-700">‚ÑπÔ∏è</button></div><p className="text-sm text-gray-700 mt-2">{sc.situation}</p></div><div className="bg-amber-50 p-3 rounded-lg"><p className="font-medium text-amber-900">{sc.question}</p></div><div className="space-y-2">{sc.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === sc.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${sc.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === sc.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-400 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-purple-50 p-4 rounded-xl"><p className="text-sm text-purple-800"><strong>Key Insight:</strong> {sc.explanation}</p></div>)}{answered && (<button onClick={() => { if (scenarioIndex < scenarios.length - 1) { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); } else setPhase('result'); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Test ‚Üí' : 'Final Assessment ‚Üí'}</button>)}{showInfo && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl p-6 max-w-sm w-full"><h3 className="font-bold text-lg text-purple-800">{infoContent[infoKey]?.title}</h3><p className="text-gray-600 mt-2 text-sm">{infoContent[infoKey]?.content}</p><button onClick={() => setShowInfo(false)} className="mt-4 w-full py-2 bg-purple-600 text-white rounded-xl">Close</button></div></div>)}</div>);
      }

      if (phase === 'result') {
         if (quizIndex < quizQuestions.length) {
            const q = quizQuestions[quizIndex];
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-purple-800">Creative Testing Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-purple-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üé®'}</div><h2 className="text-2xl font-bold text-purple-800">Creative Optimization Complete!</h2></div><div className="bg-purple-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-purple-700">{pct}%</div><div className="text-sm text-gray-600">Creative Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Icon color differentiation matters</li><li>‚Ä¢ First 2-3 screenshots get 80% of views</li><li>‚Ä¢ Wait for 95% statistical confidence</li><li>‚Ä¢ 20% better conversion = 20% more installs</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const AppleSearchAdsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'asa': 'Apple Search Ads is Apple\'s native advertising platform that places your app at the top of App Store search results. It\'s unique because users have high intent - they\'re actively searching.', 'basic_vs_advanced': 'Basic: Pay per install, Apple handles targeting. Advanced: Pay per tap, you control keywords, bids, and audiences. Advanced gives more control but requires more expertise.', 'match_types': 'Broad Match: Shows for related terms. Exact Match: Only shows for that exact keyword. Search Match: Apple automatically matches to relevant searches.', 'cpt': 'Cost Per Tap is what you pay when someone taps your ad. Unlike installs, you pay even if they don\'t download. Optimize by improving conversion rate.', 'ttr': 'Tap-Through Rate = Taps √∑ Impressions. Higher TTR means your ad resonates with searchers. Typical TTR ranges from 5-15% for good campaigns.', 'audience': 'Target by: Device type, location, age, gender, customer type (new users, returning users, users of your other apps). Narrow targeting increases relevance.', 'attribution': 'Apple Search Ads Attribution API tells you which keywords drove installs. Use this data to optimize bids and find winning keywords.' };
      const tutorialSteps = [{ title: 'Welcome to Apple Search Ads', content: 'Apple Search Ads puts your app at the top of App Store search results. Users searching are already interested - this is high-intent traffic.' }, { title: 'Basic vs Advanced Campaigns', content: 'Basic: Set a budget, Apple does the rest (pay per install). Advanced: You control keywords, bids, and targeting (pay per tap). Start with Basic, graduate to Advanced.' }, { title: 'Keyword Match Types', content: 'Exact Match: "fitness app" only. Broad Match: "fitness app", "workout app", "exercise tracker". Search Match: Apple decides. Use Exact for control, Broad for discovery.' }, { title: 'Understanding CPT Bidding', content: 'You set max CPT (cost per tap). Actual CPT is often lower. Higher bids = more impressions but higher cost. Balance bid with conversion rate.' }, { title: 'Tap-Through Rate (TTR)', content: 'TTR = Taps √∑ Impressions. Good TTR (10%+) means your icon, title, and screenshots resonate. Poor TTR wastes impressions.' }, { title: 'Audience Targeting', content: 'Narrow by device, demographics, or customer type. "All Users" is broadest. "New Users Only" prevents paying for existing users.' }, { title: 'Attribution & Optimization', content: 'Track which keywords drive installs AND in-app actions. Shift budget to keywords with best LTV (lifetime value), not just lowest CPI.' }];
      const scenarios = [{ title: 'Campaign Type Selection', context: 'You\'re launching a new meditation app with a $500/month budget. Your team has no ASA experience. You want maximum reach with minimal management.', question: 'Which campaign type should you choose?', options: ['Advanced Campaign with broad match keywords', 'Basic Campaign (pay per install)', 'Advanced Campaign with exact match only', 'No Apple Search Ads - focus on organic'], correct: 1, explanation: 'Basic Campaign is perfect for beginners with limited budgets. Apple handles targeting, you only pay when someone installs, and there\'s no keyword management needed. Graduate to Advanced once you understand your metrics.' }, { title: 'Match Type Strategy', context: 'Your fitness app Advanced campaign data: Exact match "workout app" - $2 CPT, 20% conversion. Broad match "workout app" - $0.80 CPT, 5% conversion.', question: 'Which is more cost-effective for acquiring users?', options: ['Broad match - CPT is 60% cheaper', 'Exact match - CPI is lower', 'They\'re equal in value', 'Need more data to decide'], correct: 1, explanation: 'Calculate CPI: Exact = $2 √∑ 0.20 = $10/install. Broad = $0.80 √∑ 0.05 = $16/install. Exact match has higher CPT but LOWER CPI because conversion rate matters more than tap cost.' }, { title: 'Bid Optimization', context: 'Your keyword "budget planner" has: 1000 impressions, 80 taps (8% TTR), 12 installs. Your max CPT bid is $1.50, average CPT is $1.20.', question: 'Your TTR is below average (10%). What should you prioritize?', options: ['Lower your CPT bid to reduce costs', 'Improve your app store listing (icon, screenshots)', 'Pause the keyword - TTR is too low', 'Increase bid to get more impressions'], correct: 1, explanation: 'Low TTR means users see your ad but don\'t tap. The problem isn\'t bid strategy - it\'s relevance or appeal. Improve your creative assets first. Your 15% conversion rate (12/80) is actually strong, so the issue is pre-tap, not post-tap.' }, { title: 'Audience Targeting Decision', context: 'Your app has 50K existing users. You\'re running ASA targeting "All Users". Data shows 30% of installs are re-downloads by existing users.', question: 'How should you adjust targeting?', options: ['Keep targeting All Users for maximum reach', 'Switch to New Users Only to avoid waste', 'Create separate campaigns for new and returning users', 'This is normal - no change needed'], correct: 2, explanation: 'Paying to re-acquire existing users is often wasteful, but returning users might be high value (they chose to come back). Best practice: Separate campaigns let you bid differently for each audience and measure their true value.' }];
      const quizQuestions = [{ q: 'In Apple Search Ads, what\'s the key difference between Basic and Advanced campaigns?', options: ['Basic is cheaper per install', 'Advanced lets you control keywords and bidding', 'Basic has better targeting options', 'Advanced only works for games'], correct: 1 }, { q: 'If Broad match has $1 CPT with 5% conversion, and Exact match has $2 CPT with 15% conversion, which has lower CPI?', options: ['Broad match ($20 CPI)', 'Exact match ($13.33 CPI)', 'They are equal', 'Cannot calculate without impressions'], correct: 1 }, { q: 'What does a low TTR (Tap-Through Rate) primarily indicate?', options: ['Your bids are too low', 'Your app store listing isn\'t compelling', 'Your app has bugs', 'Apple is limiting your reach'], correct: 1 }, { q: 'Why might you want to target "New Users Only"?', options: ['New users convert better', 'Avoid paying to re-acquire existing users', 'Apple gives a discount for new users', 'Existing users can\'t see ads'], correct: 1 }, { q: 'What should you optimize for long-term success, beyond just CPI?', options: ['Impressions volume', 'Tap-through rate only', 'Keyword quantity', 'Lifetime value (LTV) per keyword'], correct: 3 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üçé</div><h2 className="text-2xl font-bold text-cyan-800">Apple Search Ads</h2><p className="text-gray-600">Master Apple\'s native app advertising platform</p></div><div className="bg-cyan-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Basic vs Advanced campaign strategies</li><li>‚Ä¢ Keyword match types and bidding</li><li>‚Ä¢ TTR optimization and audience targeting</li><li>‚Ä¢ Attribution and LTV-based optimization</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-cyan-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-cyan-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-cyan-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Apple Search Ads scenarios']); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-cyan-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('asa'); setShowInfo(true); }} className="text-cyan-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-cyan-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-cyan-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-cyan-200"><h3 className="font-bold text-cyan-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-cyan-50 p-4 rounded-xl text-sm"><p className="font-medium text-cyan-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-cyan-800">Apple Search Ads Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-cyan-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üçé'}</div><h2 className="text-2xl font-bold text-cyan-800">Apple Search Ads Complete!</h2></div><div className="bg-cyan-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-cyan-700">{pct}%</div><div className="text-sm text-gray-600">ASA Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Start Basic, graduate to Advanced</li><li>‚Ä¢ CPI matters more than CPT alone</li><li>‚Ä¢ Low TTR = improve your store listing</li><li>‚Ä¢ Optimize for LTV, not just installs</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const GoogleUacRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'uac': 'Google App Campaigns (formerly UAC) use machine learning to optimize ad delivery across Search, Play Store, YouTube, and Display Network automatically.', 'ml_optimization': 'Google\'s ML tests combinations of your assets, targeting, and placements to find what works. You provide assets; Google handles the rest.', 'campaign_goals': 'Install Volume: Get most installs. In-App Actions: Target users who will take specific actions. Value: Focus on users with highest predicted LTV.', 'assets': 'Provide 2-5 headlines (30 chars), 1-5 descriptions (90 chars), up to 20 images, up to 20 videos. More variety = better ML optimization.', 'tcpi_tcpa': 'tCPI (target CPI): What you want to pay per install. tCPA (target CPA): What you want to pay per in-app action. Set based on your unit economics.', 'learning': 'ML needs ~50-100 conversions to optimize. During learning (1-2 weeks), performance varies. Don\'t make big changes during learning.', 'conversion_tracking': 'Track installs AND post-install events (purchases, sign-ups). Firebase or third-party SDK required. Better data = better optimization.' };
      const tutorialSteps = [{ title: 'Welcome to Google App Campaigns', content: 'Google App Campaigns (formerly UAC) use machine learning to show your ads across Search, Play Store, YouTube, Gmail, and millions of sites - all from one campaign.' }, { title: 'Machine Learning Does the Work', content: 'Unlike traditional ads, you don\'t choose keywords or placements. You provide creative assets and goals; Google\'s ML figures out the best combinations and audiences.' }, { title: 'Three Campaign Goals', content: 'Install Volume: Maximize installs at target CPI. In-App Actions: Find users who\'ll complete specific events. Value: Focus on users with highest predicted lifetime value.' }, { title: 'Asset Requirements', content: 'Upload 2-5 headlines (30 chars), 1-5 descriptions (90 chars), images, and videos. The more variety you provide, the better ML can optimize.' }, { title: 'Target CPI/CPA Bidding', content: 'Set your target cost per install (tCPI) or target cost per action (tCPA). Google optimizes to hit this target while getting maximum volume.' }, { title: 'The Learning Period', content: 'New campaigns need 50-100 conversions to optimize. During learning (1-2 weeks), don\'t make major changes. Let the ML gather data.' }, { title: 'Conversion Tracking', content: 'Install Firebase or third-party SDK. Track not just installs but valuable in-app events. Better conversion data = smarter optimization.' }];
      const scenarios = [{ title: 'Campaign Goal Selection', context: 'Your freemium fitness app has: $10 average revenue per paying user, 5% of installs convert to paid, $50 avg LTV for payers. You have a $5K/month budget.', question: 'Which campaign goal should you choose?', options: ['Install Volume - get maximum users', 'In-App Actions - target users who subscribe', 'Value - focus on highest LTV users', 'Run all three simultaneously'], correct: 1, explanation: 'With 5% conversion to paid, Install Volume wastes 95% of budget on non-payers. In-App Actions (target: subscription) focuses budget on users likely to convert. Value works better with more data about LTV differences.' }, { title: 'Asset Strategy', context: 'Your campaign has: 2 text headlines, 1 description, 3 images, no videos. After 2 weeks, CPI is 40% above target.', question: 'What should you prioritize to improve performance?', options: ['Lower your target CPI bid', 'Add more diverse creative assets', 'Pause campaign and restart', 'Switch to manual targeting'], correct: 1, explanation: 'Limited assets = limited ML optimization. Google can\'t test combinations if you only provide minimum assets. Add headlines, descriptions, and especially video (which gets best reach on YouTube). More variety enables better optimization.' }, { title: 'Learning Period Management', context: 'New campaign launched 4 days ago. Results: 35 installs, $8 CPI (target: $5). Daily fluctuations are high.', question: 'What action should you take?', options: ['Immediately lower the bid to $5', 'Pause the campaign - it\'s failing', 'Wait - still in learning period', 'Double the budget to accelerate learning'], correct: 2, explanation: 'At 35 installs, you\'re still in learning (need ~50-100). CPI fluctuates during learning. Making changes now restarts learning. Be patient for 1-2 weeks unless performance is catastrophically bad.' }, { title: 'Budget Allocation', context: 'You run 2 campaigns: Install Volume ($3 CPI) and In-App Actions ($15 CPA for purchases, avg purchase = $30). Both hitting targets. Total budget: $10K/month.', question: 'How should you allocate budget for maximum ROI?', options: ['100% to Install Volume - lowest CPI', '100% to In-App Actions - positive ROI per action', 'Split 50/50 between campaigns', 'Shift more to In-App Actions based on ROI'], correct: 3, explanation: 'Install Volume: $3 CPI with unknown conversion. In-App Actions: $15 CPA for $30 purchase = 2x ROI. Unless Install Volume users have >$6 LTV, In-App Actions is more profitable. Shift budget toward proven ROI.' }];
      const quizQuestions = [{ q: 'What makes Google App Campaigns different from traditional ad campaigns?', options: ['Lower prices', 'ML handles targeting and placement automatically', 'Only runs on Google Search', 'Requires manual keyword selection'], correct: 1 }, { q: 'During the learning period, what should you avoid?', options: ['Adding more creative assets', 'Monitoring performance metrics', 'Making major bid or budget changes', 'Checking conversion tracking'], correct: 2 }, { q: 'If you only provide 2 headlines and 1 image, what happens?', options: ['Campaign runs perfectly', 'Google adds assets automatically', 'ML has limited optimization ability', 'The campaign cannot start'], correct: 2 }, { q: 'What\'s the recommended number of conversions before ML optimizes well?', options: ['10-20 conversions', '50-100 conversions', '500-1000 conversions', 'Conversions don\'t matter'], correct: 1 }, { q: 'For an app where only 2% of users make purchases, which goal is best?', options: ['Install Volume', 'In-App Actions (target: purchase)', 'Value optimization', 'None - don\'t use Google Ads'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üéØ</div><h2 className="text-2xl font-bold text-orange-800">Google App Campaigns</h2><p className="text-gray-600">Master ML-powered universal app advertising</p></div><div className="bg-orange-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ How ML optimization works</li><li>‚Ä¢ Campaign goals and bidding strategies</li><li>‚Ä¢ Asset requirements and best practices</li><li>‚Ä¢ Learning period management</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-orange-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-orange-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-orange-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Google UAC scenarios']); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-orange-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('uac'); setShowInfo(true); }} className="text-orange-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-orange-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-orange-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-orange-200"><h3 className="font-bold text-orange-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-orange-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-orange-50 p-4 rounded-xl text-sm"><p className="font-medium text-orange-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-orange-800">Google App Campaigns Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-orange-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-orange-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üéØ'}</div><h2 className="text-2xl font-bold text-orange-800">Google App Campaigns Complete!</h2></div><div className="bg-orange-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-orange-700">{pct}%</div><div className="text-sm text-gray-600">UAC Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Let ML optimize - provide diverse assets</li><li>‚Ä¢ Wait for learning period (50-100 conversions)</li><li>‚Ä¢ Match goals to your monetization model</li><li>‚Ä¢ Track in-app events, not just installs</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-orange-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const CpiModelRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'cpi': 'Cost Per Install = Total Ad Spend √∑ Number of Installs. It measures how much you pay to acquire one new app user through paid advertising.', 'benchmarks': 'CPI varies widely: Gaming $1-5, Finance $3-10, E-commerce $2-5, Social $1-3, Utilities $1-2. iOS typically 30-50% higher than Android.', 'ecpi': 'Effective CPI (eCPI) includes ALL acquisition costs divided by total installs (including organic). If paid CPI is $3 but you get equal organic installs, eCPI is $1.50.', 'ltv_cpi': 'The golden rule: LTV > CPI. If you spend $3 to acquire a user who generates $10, you profit $7. If CPI > LTV, you lose money on every install.', 'quality': 'Lower CPI isn\'t always better. $1 users who never open the app are worse than $3 users who make purchases. Quality matters more than cost.', 'factors': 'CPI depends on: Competition for your audience, geographic targeting, creative quality, app category, platform (iOS/Android), seasonality.', 'optimization': 'Lower CPI by: Improving creatives (better CTR), better targeting (higher conversion), testing channels, geographic expansion, timing campaigns.' };
      const tutorialSteps = [{ title: 'What is CPI?', content: 'Cost Per Install (CPI) = Total Ad Spend √∑ Number of Installs. If you spend $1,000 and get 500 installs, your CPI is $2. This is your core user acquisition metric.' }, { title: 'CPI Benchmarks', content: 'CPI varies by category: Gaming $1-5, Finance $3-10, E-commerce $2-5. iOS is typically 30-50% higher than Android. Geography matters: US $3-5, India $0.20-0.50.' }, { title: 'CPI vs eCPI', content: 'eCPI (effective CPI) = Total spend √∑ ALL installs (paid + organic). Organic installs effectively lower your acquisition cost. Strong brands have low eCPI.' }, { title: 'The LTV:CPI Ratio', content: 'The most important equation: LTV > CPI. If average user generates $10 (LTV) and CPI is $3, you profit $7 per user. LTV:CPI ratio of 3:1 or higher is healthy.' }, { title: 'Quality vs Cost Trade-off', content: 'Cheap installs aren\'t always good. $1 CPI users who never engage cost more than $5 users who make purchases. Look at CPI in context of user quality.' }, { title: 'Factors Affecting CPI', content: 'CPI depends on: audience competition, targeting precision, creative quality, app category, platform, geography, and seasonality (holidays = higher CPIs).' }, { title: 'CPI Optimization Levers', content: 'Lower CPI by: improving ad creatives (higher CTR), better targeting (higher conversion), testing new channels, expanding to cheaper geographies, timing campaigns.' }];
      const scenarios = [{ title: 'CPI Calculation', context: 'Your app campaign spent $15,000 last month. You got 3,000 paid installs and 2,000 organic installs from brand awareness.', question: 'What\'s your CPI and eCPI?', options: ['CPI: $5, eCPI: $5', 'CPI: $5, eCPI: $3', 'CPI: $3, eCPI: $5', 'CPI: $7.50, eCPI: $3'], correct: 1, explanation: 'CPI = $15,000 √∑ 3,000 paid installs = $5. eCPI = $15,000 √∑ 5,000 total installs = $3. Your paid campaigns are also driving organic awareness, making your effective cost lower.' }, { title: 'LTV:CPI Analysis', context: 'Your dating app data: CPI = $8, 30-day LTV = $3, 90-day LTV = $8, 365-day LTV = $25. Your investors want profitability within 6 months.', question: 'Is your CPI sustainable?', options: ['No - LTV never exceeds CPI', 'Yes - 90-day LTV equals CPI (break-even)', 'Borderline - you break even at 90 days, profit after', 'Need more data about retention'], correct: 2, explanation: 'At 90 days, LTV = CPI ($8 each), so you break even. After 90 days, you\'re profitable. For investors wanting 6-month profitability, this works - but barely. Ideally, LTV would exceed CPI sooner (30-60 days) for healthier cash flow.' }, { title: 'Quality vs Quantity', context: 'Two ad campaigns: Campaign A: CPI $2, Day 7 retention 5%, 0.1% make purchase. Campaign B: CPI $6, Day 7 retention 25%, 2% make purchase. Average purchase value: $20.', question: 'Which campaign delivers better ROI?', options: ['Campaign A - 3x cheaper CPI', 'Campaign B - despite higher CPI', 'They\'re equal', 'Cannot determine without LTV'], correct: 1, explanation: 'Calculate per 1000 installs: Campaign A: $2,000 cost, 1 purchaser ($20) = -$1,980. Campaign B: $6,000 cost, 20 purchasers ($400) = -$5,600 initially BUT much higher retention. Campaign B users are 20x more likely to pay and retain 5x better. Long-term, B wins.' }, { title: 'Geographic Expansion', context: 'Current US campaign: CPI $5, conversion 8%, LTV $30. You\'re considering India: estimated CPI $0.50, conversion 3%, estimated LTV $5.', question: 'Should you expand to India?', options: ['Yes - CPI is 90% lower', 'No - LTV:CPI ratio is worse in India', 'Yes - lower CPI means more users', 'Test with small budget first'], correct: 3, explanation: 'US: LTV:CPI = $30:$5 = 6:1. India: LTV:CPI = $5:$0.50 = 10:1. India actually has BETTER unit economics! But estimates may be wrong. Test with a small budget to validate before scaling. Lower absolute LTV doesn\'t mean worse ROI.' }];
      const quizQuestions = [{ q: 'If you spend $10,000 and get 2,500 installs, what\'s your CPI?', options: ['$2.50', '$4.00', '$25.00', '$0.25'], correct: 1 }, { q: 'What\'s eCPI designed to measure?', options: ['Only paid installs cost', 'Cost per engaged user', 'Total cost across all installs including organic', 'Effective cost per impression'], correct: 2 }, { q: 'A healthy LTV:CPI ratio is typically:', options: ['1:1 (break-even)', '2:1 or lower', '3:1 or higher', 'LTV doesn\'t relate to CPI'], correct: 2 }, { q: 'Why might iOS CPI be higher than Android?', options: ['Apple charges more for ads', 'iOS users have higher purchasing power (more valuable)', 'Android has more apps', 'iOS apps are lower quality'], correct: 1 }, { q: 'What\'s the main risk of optimizing only for lowest CPI?', options: ['Spending too much money', 'Getting low-quality users who don\'t engage', 'Running out of ad inventory', 'Violating platform policies'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üí∞</div><h2 className="text-2xl font-bold text-teal-800">CPI Model</h2><p className="text-gray-600">Master Cost Per Install economics</p></div><div className="bg-teal-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ CPI calculation and benchmarks</li><li>‚Ä¢ LTV:CPI ratio for profitability</li><li>‚Ä¢ Quality vs quantity trade-offs</li><li>‚Ä¢ CPI optimization strategies</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-teal-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-teal-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-teal-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started CPI Model scenarios']); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-teal-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('cpi'); setShowInfo(true); }} className="text-teal-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-teal-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-teal-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-teal-200"><h3 className="font-bold text-teal-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-teal-50 p-4 rounded-xl text-sm"><p className="font-medium text-teal-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-teal-800">CPI Model Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-teal-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üí∞'}</div><h2 className="text-2xl font-bold text-teal-800">CPI Model Complete!</h2></div><div className="bg-teal-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-teal-700">{pct}%</div><div className="text-sm text-gray-600">CPI Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ CPI = Ad Spend √∑ Installs</li><li>‚Ä¢ Always compare LTV:CPI (aim for 3:1+)</li><li>‚Ä¢ Cheap users aren\'t always valuable</li><li>‚Ä¢ eCPI captures full acquisition picture</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const SocialMediaAdsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'social': 'Social media ads reach users where they spend time. Each platform has unique demographics, ad formats, and targeting options.', 'meta': 'Meta (Facebook/Instagram) has the most sophisticated targeting and largest reach. Best for broad audiences and lookalike targeting.', 'tiktok': 'TikTok excels for Gen Z and younger millennials. Native, entertaining content outperforms polished ads. Lower CPIs but different user quality.', 'lookalike': 'Lookalike audiences find users similar to your best customers. Upload your high-LTV users, and the platform finds similar people to target.', 'att': 'iOS 14.5+ App Tracking Transparency reduced targeting precision. Many users opt out, limiting retargeting and attribution accuracy.', 'creative': 'Social ads need native feel. User-generated content style outperforms polished ads. First 3 seconds must hook attention.', 'retargeting': 'Show ads to people who\'ve engaged before: visited website, added to cart, used your app. Higher conversion but smaller audience.' };
      const tutorialSteps = [{ title: 'Social Media Advertising', content: 'Social platforms offer massive reach and powerful targeting. Meta (FB/IG), TikTok, Twitter/X, and Snapchat each serve different audiences and purposes.' }, { title: 'Meta (Facebook & Instagram)', content: 'Largest reach and most sophisticated targeting. Best for broad audiences, lookalike targeting, and retargeting. Higher CPIs but often higher quality users.' }, { title: 'TikTok Ads', content: 'Dominant for Gen Z. Native, entertaining content wins. Lower CPIs than Meta, but different user behavior. Great for viral potential but requires creative investment.' }, { title: 'Targeting Options', content: 'Interest targeting: based on behavior. Lookalike: find users similar to your best customers. Retargeting: reach people who already engaged. Custom audiences: upload your own lists.' }, { title: 'iOS 14.5+ Impact', content: 'App Tracking Transparency (ATT) reduced targeting precision. Many users opt out of tracking. Lookalike audiences are less accurate. Attribution is probabilistic, not deterministic.' }, { title: 'Creative Best Practices', content: 'Native content outperforms polished ads. Hook attention in first 3 seconds. UGC-style videos often beat professional production. Test multiple creatives aggressively.' }, { title: 'Measurement & Attribution', content: 'Use Mobile Measurement Partners (MMPs) like Adjust, AppsFlyer, Branch. Track view-through and click-through attribution. Account for iOS signal loss with modeling.' }];
      const scenarios = [{ title: 'Platform Selection', context: 'You\'re launching a budgeting app for Gen Z (18-24). Budget: $10K/month. Goal: maximize installs while finding users who engage.', question: 'Which platform should get the majority of budget?', options: ['Facebook - largest audience', 'Instagram - visual focus', 'TikTok - Gen Z dominance', 'Split evenly across all'], correct: 2, explanation: 'TikTok dominates Gen Z. For 18-24 year olds, TikTok often has 2-3x the engagement and lower CPIs than Meta. Start with TikTok majority (60-70%), use Instagram as secondary (20-30%), and test Facebook with remainder.' }, { title: 'Creative Strategy', context: 'Your TikTok campaign is underperforming. Current creative: Professional studio video with polished graphics and voiceover. CTR is 0.5% vs 2% benchmark.', question: 'What creative change would likely improve performance?', options: ['Add more professional graphics', 'Switch to UGC-style selfie video', 'Use longer format (60 seconds)', 'Add promotional discount overlay'], correct: 1, explanation: 'TikTok users skip content that feels like ads. UGC-style (user-generated content) selfie videos feel native and authentic. They often outperform polished production by 3-5x on TikTok because they match the platform\'s native content style.' }, { title: 'Post-ATT Strategy', context: 'Since iOS 14.5, your Meta lookalike audiences are performing 40% worse. Your retargeting pool has shrunk by 60%. CPIs are up significantly.', question: 'What\'s the best strategic response?', options: ['Increase bids to maintain volume', 'Shift budget to Android-only campaigns', 'Focus on broad targeting with strong creative', 'Pause all iOS campaigns'], correct: 2, explanation: 'Post-ATT, creative matters more than ever. Broad targeting with compelling creative often outperforms narrow targeting with weak creative. Meta\'s ML can still find good users, but your creative must do more work to qualify them. Strong hooks and clear value props help self-select the right audience.' }, { title: 'Budget Allocation', context: 'Current results: TikTok: $3 CPI, 15% D7 retention. Meta: $5 CPI, 35% D7 retention. Twitter: $4 CPI, 10% D7 retention. Monthly budget: $20K.', question: 'How should you reallocate for best LTV?', options: ['100% TikTok - lowest CPI', '70% Meta, 20% TikTok, 10% Twitter', '50% Meta, 50% TikTok', 'Cut Twitter, split rest evenly'], correct: 1, explanation: 'CPI isn\'t the only metric. Meta users have 2.3x better retention (35% vs 15%). If retention correlates with LTV, Meta users are worth more. Weighted allocation: Meta gets majority (70%) for quality, TikTok (20%) for volume and testing, Twitter (10%) for testing - its retention is worst.' }];
      const quizQuestions = [{ q: 'Which platform typically has the lowest CPIs but requires native-style creative?', options: ['Facebook', 'Instagram', 'TikTok', 'LinkedIn'], correct: 2 }, { q: 'What is a "lookalike audience"?', options: ['Duplicate of your current campaign', 'Users who look at competitors\' apps', 'Users similar to your best customers', 'Retargeting audience'], correct: 2 }, { q: 'How has iOS 14.5+ ATT affected social media advertising?', options: ['Made ads cheaper', 'Reduced targeting precision and attribution accuracy', 'Improved lookalike quality', 'No significant impact'], correct: 1 }, { q: 'What type of creative typically performs best on social platforms?', options: ['High-production studio videos', 'UGC-style native content', 'Static banner images', 'Long-form educational content'], correct: 1 }, { q: 'Why might higher CPI campaigns be more valuable than lower CPI campaigns?', options: ['Higher CPIs always mean premium users', 'Users from higher CPI channels may have better retention and LTV', 'Lower CPI means fraudulent installs', 'There\'s no relationship between CPI and user value'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üì±</div><h2 className="text-2xl font-bold text-rose-800">Social Media Ads</h2><p className="text-gray-600">Master paid social for app acquisition</p></div><div className="bg-rose-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Platform selection (Meta, TikTok, Twitter)</li><li>‚Ä¢ Targeting strategies and lookalikes</li><li>‚Ä¢ Post-iOS 14.5 best practices</li><li>‚Ä¢ Creative optimization for social</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-rose-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-rose-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-rose-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Social Media Ads scenarios']); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-rose-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('social'); setShowInfo(true); }} className="text-rose-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-rose-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-rose-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-rose-200"><h3 className="font-bold text-rose-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-rose-50 p-4 rounded-xl text-sm"><p className="font-medium text-rose-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-rose-800">Social Media Ads Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-rose-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üì±'}</div><h2 className="text-2xl font-bold text-rose-800">Social Media Ads Complete!</h2></div><div className="bg-rose-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-rose-700">{pct}%</div><div className="text-sm text-gray-600">Social Ads Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Match platform to target demographic</li><li>‚Ä¢ UGC-style beats polished production</li><li>‚Ä¢ Post-ATT: creative matters more than targeting</li><li>‚Ä¢ Optimize for retention, not just CPI</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const ViralLoopsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'viral': 'Viral loops are mechanisms where users bring more users who bring more users. If each user brings more than 1 new user (K>1), growth becomes exponential.', 'kfactor': 'K-factor = Invites sent √ó Conversion rate. If users send 5 invites and 30% convert, K = 1.5. K>1 means viral growth. K<1 means you still need paid acquisition.', 'cycletime': 'Cycle time is how fast the loop runs. If it takes 2 days from install to invite to new install, you complete 15 cycles/month. Faster cycles = faster growth.', 'types': 'Inherent: Product requires others (WhatsApp). Word of mouth: Great product people share (TikTok). Incentivized: Rewards for referrals (Dropbox). Each has different K-factors.', 'network': 'Network effects: Product gets better with more users (Facebook). Virality: Users spread the product (TikTok). Both drive growth but work differently.', 'optimize': 'Improve K-factor by: increasing invite touchpoints, reducing friction to invite, improving invite messaging, making sharing feel natural, adding incentives.', 'measure': 'Track: invites sent per user, invite conversion rate, cycle time, organic vs attributed growth. A/B test invite flows and messaging constantly.' };
      const tutorialSteps = [{ title: 'What is a Viral Loop?', content: 'A viral loop is when users bring new users who bring more new users. It\'s the growth engine behind apps like WhatsApp, TikTok, and Dropbox. When designed well, it creates exponential growth.' }, { title: 'The K-Factor', content: 'K-factor = Invites per user √ó Invite conversion rate. If each user sends 4 invites and 25% convert, K = 1.0. K>1 = exponential growth. K<1 = still helpful but needs paid support.' }, { title: 'Cycle Time', content: 'How long from install ‚Üí invite ‚Üí new install? If cycle time is 2 days, you complete 15 cycles per month. Shorter cycles accelerate growth dramatically - daily loops beat weekly loops 7x.' }, { title: 'Types of Viral Loops', content: 'Inherent: Product needs others to work (messaging). Word of mouth: People share what they love (TikTok). Incentivized: Rewards for referrals (Dropbox space). Inherent loops are strongest.' }, { title: 'Virality vs Network Effects', content: 'Virality: Users spread the product. Network effects: Product gets better with more users. Instagram has both - users share, AND more users = more content. Most powerful when combined.' }, { title: 'Optimizing Your Loop', content: 'Increase invites: Add natural share moments. Improve conversion: Better invite messaging. Reduce friction: One-tap sharing. Add incentives: Reward both sides. Test everything.' }, { title: 'Measuring Viral Growth', content: 'Track: organic/viral installs as % of total, invites per user, invite-to-install rate, cycle time, cohort K-factors. Separate inherent virality from paid-driven referrals.' }];
      const scenarios = [{ title: 'K-Factor Calculation', context: 'Your photo sharing app data: Average user sends 6 invites. 20% of invites result in installs. Current user base: 10,000.', question: 'What\'s your K-factor and what does it mean for growth?', options: ['K=1.2, exponential growth possible', 'K=0.3, need paid acquisition', 'K=6.0, very viral', 'K=1.0, break-even'], correct: 0, explanation: 'K = 6 invites √ó 20% conversion = 1.2. Since K>1, each generation of users produces more than itself. 10,000 users ‚Üí 12,000 new ‚Üí 14,400 newer. This compounds, but slowly. Improving either metric accelerates growth significantly.' }, { title: 'Loop Type Selection', context: 'You\'re building a fitness tracking app. Users typically exercise alone. You want to add viral mechanics.', question: 'Which viral loop type is most appropriate?', options: ['Inherent - require friends to use app', 'Incentivized - reward for referrals', 'Word of mouth - make it shareable', 'No viral loop - focus on paid'], correct: 1, explanation: 'Solo fitness apps don\'t have inherent virality (don\'t NEED others). Word of mouth is weak for utility apps. Incentivized referrals work well: "Get 1 month premium free when friends join." Combine with shareable achievements for word of mouth boost.' }, { title: 'Cycle Time Optimization', context: 'Your app\'s viral metrics: K-factor of 1.5 (good!), but cycle time is 14 days (user installs ‚Üí sends invites 14 days later). Monthly growth is only 30%.', question: 'What should you prioritize to accelerate growth?', options: ['Increase K-factor to 2.0', 'Reduce cycle time to 3 days', 'Both equally important', 'Focus on retention instead'], correct: 1, explanation: 'At K=1.5 with 14-day cycles: 2 cycles/month = 1.5¬≤ = 2.25x growth. With 3-day cycles: 10 cycles/month = 1.5^10 = 57x growth potential! Cycle time has exponential impact. Add invite prompts earlier in user journey.' }, { title: 'Viral vs Paid Balance', context: 'Current state: K-factor = 0.7 (below 1), Paid CPI = $3, LTV = $10. You\'re debating: invest in improving viral loop or scale paid?', question: 'What\'s the smarter strategy?', options: ['Scale paid - K<1 means viral won\'t work', 'Improve viral loop to K>1 first', 'Do both equally', 'K=0.7 is still valuable, scale paid but keep optimizing viral'], correct: 3, explanation: 'K=0.7 means every 10 paid users bring 7 free users, effectively reducing your CPI from $3 to $1.76 ($3/1.7). That\'s 41% cheaper! Keep optimizing viral (aim for K>1) while scaling paid. Even sub-1.0 K-factors create significant value.' }];
      const quizQuestions = [{ q: 'If K-factor is 0.8 and you acquire 1,000 paid users, approximately how many total users do you get?', options: ['1,000 (K<1 means no viral growth)', '1,800 (800 viral + 1000 paid)', '5,000 (geometric series)', '8,000 (multiply by K)'], correct: 2 }, { q: 'What makes "inherent" viral loops more powerful than incentivized ones?', options: ['They offer bigger rewards', 'Users MUST invite others to use the product', 'They\'re easier to implement', 'They work for all app types'], correct: 1 }, { q: 'If you double your cycle speed (from 7 days to 3.5 days), what happens to monthly growth?', options: ['Growth doubles', 'Growth roughly squares (much more than doubles)', 'No change - K-factor matters more', 'Growth halves (faster cycles = less time to invite)'], correct: 1 }, { q: 'What\'s the difference between virality and network effects?', options: ['They\'re the same thing', 'Virality = spreading; Network effects = product improves with users', 'Network effects = spreading; Virality = product improves', 'Virality is paid; Network effects are organic'], correct: 1 }, { q: 'How do you calculate K-factor?', options: ['Users √∑ Days', 'Invites sent √ó Invite conversion rate', 'Viral users √∑ Paid users', 'Retention rate √ó Engagement'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üîÑ</div><h2 className="text-2xl font-bold text-lime-800">Viral Loops</h2><p className="text-gray-600">Design exponential growth engines</p></div><div className="bg-lime-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ K-factor and cycle time</li><li>‚Ä¢ Types of viral loops</li><li>‚Ä¢ Virality vs network effects</li><li>‚Ä¢ Optimizing viral growth</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-lime-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-lime-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-lime-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Viral Loops scenarios']); }} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-lime-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('viral'); setShowInfo(true); }} className="text-lime-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-lime-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-lime-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-lime-200"><h3 className="font-bold text-lime-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-lime-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-lime-50 p-4 rounded-xl text-sm"><p className="font-medium text-lime-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-lime-800">Viral Loops Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-lime-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-lime-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üîÑ'}</div><h2 className="text-2xl font-bold text-lime-800">Viral Loops Complete!</h2></div><div className="bg-lime-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-lime-700">{pct}%</div><div className="text-sm text-gray-600">Viral Growth Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ K = Invites √ó Conversion (aim for K{'>'}1)</li><li>‚Ä¢ Cycle time has exponential impact</li><li>‚Ä¢ Even K{'<'}1 reduces effective CPI</li><li>‚Ä¢ Inherent loops are most powerful</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-lime-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const ReferralProgramsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'referral': 'Referral programs incentivize existing users to bring new users. Unlike organic word-of-mouth, they add structured rewards to increase sharing motivation.', 'double_sided': 'Both referrer and referee get rewards. "Give $10, Get $10" - the friend feels they\'re getting a gift, not just helping you. Higher conversion than single-sided.', 'single_sided': 'Only the referrer gets rewarded. Simpler to implement but lower conversion since the friend has no incentive. Works when product is inherently valuable.', 'reward_types': 'Cash: Most flexible. Credits: Good for marketplaces. Premium time: Great for subscriptions. Features: Unlocks for freemium. Match reward to user motivation.', 'timing': 'Immediate: Higher motivation to share. Delayed (after friend\'s first purchase): Reduces fraud but lower sharing. Hybrid: Small immediate + larger delayed.', 'fraud': 'Common fraud: fake accounts, self-referrals, referral farms. Prevent with: phone verification, device fingerprinting, delayed rewards, human review for high volume.', 'economics': 'Referral CPA should be < paid CPA. If paid CPI = $5, offer $3 per referral. Even if higher, referred users often have higher LTV (trust transfer).' };
      const tutorialSteps = [{ title: 'What is a Referral Program?', content: 'Referral programs add structured incentives to word-of-mouth. Instead of hoping users recommend your app, you reward them for doing so. Dropbox grew 3900% with referrals.' }, { title: 'Double-Sided vs Single-Sided', content: 'Double-sided: Both get rewards ("Give $10, Get $10"). Higher conversion because friend feels gifted. Single-sided: Only referrer rewarded. Simpler but lower conversion.' }, { title: 'Reward Types', content: 'Cash: Universal appeal. Credits/Currency: Good for marketplaces. Premium time: Perfect for subscriptions. Feature unlocks: Great for freemium. Match rewards to what users value.' }, { title: 'Timing of Rewards', content: 'Immediate: User shares, gets reward right away. Maximum motivation. Delayed: Reward after friend takes action (purchase, subscription). Reduces fraud. Best: Hybrid approach.' }, { title: 'Fraud Prevention', content: 'Risks: Self-referrals, fake accounts, referral farms. Defenses: Phone verification, device fingerprinting, delayed rewards, velocity limits, manual review for high-volume referrers.' }, { title: 'Referral Economics', content: 'Compare referral cost to paid CPI. If paid CPI = $5, a $3 referral reward is profitable. But referred users often have 25-50% higher LTV (trust transfer from friend).' }, { title: 'Program Optimization', content: 'Track: shares per user, share-to-install rate, referral conversion rate, fraud rate, referred user LTV. A/B test: reward amount, messaging, placement, reward type.' }];
      const scenarios = [{ title: 'Reward Structure Design', context: 'You\'re launching a referral program for a subscription meal planning app ($10/month). Your paid CPI is $8, and LTV is $60. Budget is limited.', question: 'What reward structure would you recommend?', options: ['$10 cash to referrer only (single-sided)', 'Give 1 month free, Get 1 month free (double-sided)', '$5 cash to each (double-sided cash)', 'No reward - just make sharing easy'], correct: 1, explanation: 'Double-sided subscription credit is ideal here. Cost: $20 in foregone revenue (not cash out). Friend gets immediate value. The $10/month √ó 2 = $20 "cost" is cheaper than $8 paid CPI (since you\'re giving subscription, not cash), and double-sided drives higher conversion.' }, { title: 'Fraud Detection', context: 'Your referral program launched. Data after 1 week: User A referred 47 people, 44 installed, 43 churned within 24 hours. Average for other users: 2 referrals, 60% install, 80% D7 retention.', question: 'What\'s the most likely issue and response?', options: ['Normal power user - give extra rewards', 'Fraud - fake accounts - ban and claw back rewards', 'Bad targeting - those users aren\'t a fit', 'Technical bug - investigate app issues'], correct: 1, explanation: 'Classic referral fraud pattern: abnormally high referral count, high conversion (easy to create fake accounts), immediate churn (bots/fake accounts don\'t engage). Action: Ban user, claw back rewards if possible, implement device fingerprinting and delayed rewards.' }, { title: 'Reward Amount Optimization', context: 'Current program: $5 give, $5 get. Results: 10% of users share, 20% of shares convert. You\'re considering increasing to $10 give, $10 get.', question: 'What analysis should guide this decision?', options: ['If more users share, it\'s worth it', 'Compare new referral cost to paid CPI', 'Always maximize rewards for maximum growth', 'Check if current referrers would share anyway'], correct: 1, explanation: 'Calculate: Current: $10 total reward √∑ (10% share √ó 20% convert) = $500 per 100 users = $5 referral CPI. If $20 reward increases to 15% share √ó 25% convert = $533 per 100 users = $5.33 CPI. Higher cost! Only increase if it beats paid CPI and maintains quality.' }, { title: 'Placement Strategy', context: 'Your referral program exists but only 3% of users ever see it (buried in settings). You want to increase visibility without annoying users.', question: 'What\'s the best placement strategy?', options: ['Pop-up on every app open', 'Add to onboarding flow for all new users', 'Trigger after positive moments (achievement, purchase)', 'Email campaign to all users'], correct: 2, explanation: 'Trigger referral prompts at "moments of delight" - after achievements, successful transactions, or positive feedback. Users are most likely to recommend when they just experienced value. Onboarding is too early (haven\'t experienced value). Pop-ups on open are annoying.' }];
      const quizQuestions = [{ q: 'Why do double-sided referral programs typically outperform single-sided?', options: ['They cost less to run', 'The friend feels they\'re receiving a gift, not just helping', 'Single-sided is illegal in most countries', 'Double-sided prevents fraud better'], correct: 1 }, { q: 'If your paid CPI is $6, what\'s a reasonable referral reward to offer?', options: ['$10 - bigger rewards drive more shares', '$4-5 - should be lower than paid CPI', '$1 - minimize costs', 'Matching paid CPI exactly ($6)'], correct: 1 }, { q: 'What\'s a red flag for referral fraud?', options: ['High conversion rate on referrals', 'Users referring more than 2 people', 'Referred users churning immediately after install', 'Referrals coming from social media shares'], correct: 2 }, { q: 'When is the best time to prompt users to refer friends?', options: ['During onboarding', 'After a positive experience or achievement', 'When they haven\'t opened the app in a week', 'On every app open'], correct: 1 }, { q: 'Why might referred users have higher LTV than paid users?', options: ['They get free rewards', 'Trust transfer from the person who referred them', 'They\'re more tech-savvy', 'Referral systems select for wealthy users'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üéÅ</div><h2 className="text-2xl font-bold text-amber-800">Referral Programs</h2><p className="text-gray-600">Design incentivized growth systems</p></div><div className="bg-amber-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Double-sided vs single-sided rewards</li><li>‚Ä¢ Reward types and timing</li><li>‚Ä¢ Fraud prevention strategies</li><li>‚Ä¢ Referral economics and optimization</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-amber-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-amber-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-amber-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Referral Programs scenarios']); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-amber-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('referral'); setShowInfo(true); }} className="text-amber-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-amber-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-amber-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-amber-200"><h3 className="font-bold text-amber-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-amber-50 p-4 rounded-xl text-sm"><p className="font-medium text-amber-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-amber-800">Referral Programs Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-amber-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üéÅ'}</div><h2 className="text-2xl font-bold text-amber-800">Referral Programs Complete!</h2></div><div className="bg-amber-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-amber-700">{pct}%</div><div className="text-sm text-gray-600">Referral Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Double-sided rewards drive higher conversion</li><li>‚Ä¢ Referral cost should beat paid CPI</li><li>‚Ä¢ Trigger at moments of delight</li><li>‚Ä¢ Watch for fraud patterns</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const PushNotificationsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'push': 'Push notifications are messages sent directly to a user\'s device. They can dramatically improve retention but abuse leads to uninstalls and opt-outs.', 'permission': 'iOS requires explicit permission. Android auto-enables but users can disable. Pre-permission priming (explaining value before asking) increases opt-in rates 2-3x.', 'types': 'Transactional: Order updates, receipts. Promotional: Sales, offers. Engagement: Reminders, streaks, social. Transactional has highest tolerance; promotional needs careful frequency.', 'timing': 'Send when users are likely to engage. Analyze your data for optimal times. Generally: avoid sleep hours, send during commute/lunch. Timezone-aware sending is essential.', 'frequency': 'Too many = uninstalls. Too few = forgotten. Sweet spot varies by app: news apps can send more than e-commerce. Test and watch uninstall/opt-out correlation.', 'personalization': 'Personalized notifications get 4x higher engagement. Use: name, past behavior, preferences, location. Generic blasts feel spammy; relevant messages feel helpful.', 'rich': 'Rich notifications include images, buttons, and actions. They increase engagement 25%+. Deep links take users to specific content, not just app home.' };
      const tutorialSteps = [{ title: 'Push Notification Basics', content: 'Push notifications are direct messages to user devices. When done right, they boost retention 3-10x. Done wrong, they cause uninstalls. Balance is key.' }, { title: 'Permission Strategy', content: 'iOS requires explicit opt-in (only ~50% allow). Use "pre-permission priming" - explain value before the system prompt. "Get notified when friends message you" then ask. Increases opt-in 2-3x.' }, { title: 'Notification Types', content: 'Transactional: Expected updates (order shipped). Promotional: Offers and sales. Engagement: Reminders, social activity. Users tolerate transactional most; be careful with promotional frequency.' }, { title: 'Timing Optimization', content: 'Send when users are likely to engage. Analyze YOUR data - every app differs. Generally: weekday commutes, lunch breaks, evenings. Always respect timezones. Never wake users up.' }, { title: 'Frequency Management', content: 'More isn\'t better. Track: opt-out rate, uninstall correlation, engagement per notification. Find the threshold where more notifications = fewer engaged users. Usually 2-5/week max.' }, { title: 'Personalization', content: 'Personalized notifications outperform generic 4x. Use: user\'s name, their interests, their behavior, their location. "Your saved item is on sale" beats "Big sale today!"' }, { title: 'Rich Notifications & Deep Links', content: 'Add images, action buttons, and deep links. Deep links open specific content (not just app home). "Reply" buttons increase response rates. Rich media increases tap-through 25%+.' }];
      const scenarios = [{ title: 'Permission Priming', context: 'Your iOS app currently asks for push permission immediately on first launch. Opt-in rate: 35%. Industry average with priming: 60%.', question: 'How should you improve the permission flow?', options: ['Ask multiple times until they accept', 'Show value proposition before system prompt', 'Remove notifications entirely', 'Only ask power users'], correct: 1, explanation: 'Pre-permission priming works. Before the system prompt, show a screen explaining value: "Get notified when friends like your posts" with a "Enable Notifications" button. This sets expectations and gives users a reason to opt in. Improves rates from 35% to 60%+.' }, { title: 'Frequency Optimization', context: 'Your e-commerce app sends 2 push notifications daily. Data shows: 15% open rate, but 8% of users disable notifications weekly, and uninstall rate correlates with push volume.', question: 'What should you do?', options: ['Increase to 3/day - more chances to engage', 'Reduce to 3-4/week and personalize more', 'Stop all notifications', 'Send only to users who opened previous ones'], correct: 1, explanation: 'High opt-out rate (8%/week) signals notification fatigue. Reduce frequency to 3-4/week, but make each one count with personalization. "Your wishlist item dropped 20%" beats "Daily deals inside!" Quality over quantity improves both engagement AND retention.' }, { title: 'Personalization Strategy', context: 'You send the same promotional notification to all users: "Check out our new arrivals!" Open rate: 3%. You have data on: browsing history, past purchases, location, and preferences.', question: 'How should you personalize?', options: ['Add user\'s first name to the message', 'Segment by behavior and customize message + product', 'Send at different times to different users', 'All of the above'], correct: 3, explanation: 'All personalization helps! Name adds personal touch. Behavior-based content ("New running shoes - you viewed Nike last week") dramatically increases relevance. Timezone-optimized timing ensures delivery when users are active. Combined, these can increase open rates from 3% to 12%+.' }, { title: 'Re-engagement Campaign', context: 'You have 10,000 users who haven\'t opened your app in 30 days. You want to send a re-engagement push notification.', question: 'What\'s the best approach?', options: ['Send "We miss you!" to everyone', 'Send personalized content based on their last activity', 'Don\'t send - they\'ve already churned', 'Send a discount code to everyone'], correct: 1, explanation: 'Generic "We miss you" has ~2% open rate. Personalized content based on last activity ("Your favorite artist released new music") can hit 8-12%. Reference what they actually cared about. Discount codes can work but train users to wait for discounts.' }];
      const quizQuestions = [{ q: 'What is "pre-permission priming" for push notifications?', options: ['Asking for permission multiple times', 'Explaining notification value before the system prompt', 'Sending notifications without permission', 'Priming notifications in advance'], correct: 1 }, { q: 'What typically happens when you send too many push notifications?', options: ['Higher engagement', 'Users opt-out or uninstall', 'Better retention', 'More app opens'], correct: 1 }, { q: 'Which notification type do users tolerate most?', options: ['Promotional (sales, offers)', 'Transactional (order updates, receipts)', 'Re-engagement (we miss you)', 'Generic broadcasts'], correct: 1 }, { q: 'How much can personalization improve push notification engagement?', options: ['10% improvement', '2x improvement', '4x improvement', 'No significant difference'], correct: 2 }, { q: 'What is a deep link in push notifications?', options: ['A link to your website', 'A link that opens specific in-app content', 'A link to the app store', 'A link that requires login'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üîî</div><h2 className="text-2xl font-bold text-sky-800">Push Notifications</h2><p className="text-gray-600">Master mobile engagement messaging</p></div><div className="bg-sky-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>What you\'ll learn:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Permission optimization strategies</li><li>‚Ä¢ Timing and frequency best practices</li><li>‚Ä¢ Personalization techniques</li><li>‚Ä¢ Rich notifications and deep links</li></ul></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Start Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Step {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-sky-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-sky-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-sky-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div>{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => setTutorialStep(tutorialStep + 1)} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Next ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Push Notifications scenarios']); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Start Practice ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-sky-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('push'); setShowInfo(true); }} className="text-sky-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-sky-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-sky-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-sky-200"><h3 className="font-bold text-sky-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title}`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-sky-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-sky-50 p-4 rounded-xl text-sm"><p className="font-medium text-sky-800">üí° {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Quiz ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-sky-800">Push Notifications Quiz</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-sky-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-sky-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üîî'}</div><h2 className="text-2xl font-bold text-sky-800">Push Notifications Complete!</h2></div><div className="bg-sky-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-sky-700">{pct}%</div><div className="text-sm text-gray-600">Push Mastery</div></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Key Takeaways:</p><ul className="space-y-1 text-gray-600"><li>‚Ä¢ Pre-permission priming doubles opt-in</li><li>‚Ä¢ Quality over quantity for frequency</li><li>‚Ä¢ Personalization improves engagement 4x</li><li>‚Ä¢ Deep links drive specific actions</li></ul></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); }} className="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const InAppMessagingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'iam': 'In-App Messages appear while users are actively using your app. Unlike push notifications, they require no permission and have near-100% visibility for active users.', 'types': 'Modal: Center overlay, high impact. Banner: Top/bottom bar, less intrusive. Tooltip: Points to UI elements for guidance. Full-screen: Maximum impact for major announcements. Carousel: Multiple slides for rich content.', 'triggers': 'Event-based: After specific actions (purchase, level complete). Time-based: After X seconds in app. Behavior-based: Based on usage patterns (inactive users, power users). Entry-based: On app open or screen visit.', 'targeting': 'Segment users by: behavior (purchasers vs free), attributes (new vs returning), app version, geography, custom properties. Right message to right user at right time.', 'frequency': 'Frequency capping prevents message fatigue. Rules: max 1 modal per session, max 3 per week, minimum 24h between same message. Too many = annoyance and churn.', 'personalization': 'Use user data: name, preferences, history. "John, your saved item is back in stock" beats "Check out our products." Dynamic content based on user properties.', 'measurement': 'Track: Impression rate, tap/click rate, dismissal rate, conversion rate, time to action. Compare variants. Measure downstream behavior changes.' };
      const tutorialSteps = [{ title: 'What is In-App Messaging?', content: 'In-App Messages (IAMs) appear inside your app while users are active. Unlike push notifications, they need no permission and guarantee visibility. They\'re perfect for onboarding, feature discovery, promotions, and contextual guidance.' }, { title: 'Message Types and When to Use Each', content: 'Modal: High-priority announcements, confirmations. Banner: Subtle alerts, ongoing promos. Tooltip: Feature discovery, UI guidance. Full-screen: Major updates, onboarding. Carousel: Product showcases, multi-step info. Match format to importance.' }, { title: 'Trigger Strategies', content: 'Event triggers: After purchase ("Thanks! Rate us?"), after feature use, on error. Time triggers: 30 seconds in app, 5 minutes idle. Behavior triggers: 3rd session (ask for review), churning user (offer help). Trigger at the RIGHT moment.' }, { title: 'Targeting and Segmentation', content: 'Don\'t blast everyone. Segment by: user type (free/paid), lifecycle stage (new/active/churning), behavior (feature usage), attributes (location, language). A "premium upgrade" message shouldn\'t show to premium users.' }, { title: 'Frequency Capping', content: 'Too many messages = annoyance. Set rules: max 1 modal per session, wait 24h before re-showing dismissed message, limit to 3-5 IAMs per week total. Respect user attention‚Äîscarcity increases impact.' }, { title: 'Personalization Techniques', content: 'Dynamic content using user properties: name, last action, preferences. "Welcome back, Sarah! Continue your workout?" dramatically outperforms "Open the app to continue." Make it feel 1:1, not broadcast.' }, { title: 'Measuring Effectiveness', content: 'Key metrics: View rate (how many saw it), Click-through rate (how many engaged), Dismissal rate (how many closed), Conversion rate (how many completed goal). A/B test everything. Track downstream behavior.' }];
      const scenarios = [{ title: 'Onboarding Message Design', context: 'New users complete signup but 60% never use core features. You want to guide them to value quickly without overwhelming them.', question: 'What\'s the best in-app messaging approach?', options: ['Show full-screen tutorial on first open', 'Progressive tooltips as they explore naturally', 'Modal popup explaining all features at once', 'No messages - let them figure it out'], correct: 1, explanation: 'Progressive tooltips work best for onboarding. They\'re contextual (appear when relevant), non-blocking (don\'t interrupt flow), and bite-sized (one concept at a time). Full-screen tutorials overwhelm and get dismissed. Let users explore, guide them contextually.' }, { title: 'Trigger Timing Optimization', context: 'Your rating prompt shows immediately after app open. Current response rate: 2%. Most users dismiss or give low ratings.', question: 'Why is this happening and how should you fix it?', options: ['Users hate rating prompts - remove it entirely', 'Trigger after a positive moment (completed task, achievement)', 'Make the prompt bigger and harder to dismiss', 'Show it more frequently until they respond'], correct: 1, explanation: 'Timing is everything. Users interrupted immediately are annoyed, not grateful. Trigger after "moments of delight" - completed workout, won game level, successful purchase. User is happy ‚Üí more likely to rate positively. Ask when they\'re primed to say yes.' }, { title: 'Segmentation Strategy', context: 'Your upgrade prompt shows to all free users. Conversion: 0.5%. Data shows: Power users (10+ sessions) convert at 3%, new users (<3 sessions) convert at 0.1% and often churn after seeing the prompt.', question: 'How should you segment this message?', options: ['Keep showing to everyone - more impressions = more conversions', 'Only show to power users (10+ sessions)', 'Only show to new users - catch them early', 'Show to users with 5-15 sessions (interested but not yet converted)'], correct: 3, explanation: 'Target the "consideration zone." New users haven\'t experienced value yet (showing upgrade = churn risk). Power users might already be satisfied with free tier. Users with 5-15 sessions have engaged enough to see value but haven\'t converted yet‚Äîthey\'re your best upgrade candidates.' }, { title: 'Frequency Capping Decision', context: 'Your marketing team wants to show 3 different promotional modals per day. Currently you show 1 per week. They argue more messages = more conversions.', question: 'What\'s the likely outcome of increasing to 3 modals/day?', options: ['3x more conversions - simple math', 'Short-term conversion boost, then increased churn and opt-outs', 'No change - users ignore after the first one', 'Users will appreciate more information'], correct: 1, explanation: 'Message fatigue is real. Initial boost likely (more chances to convert), but users will learn to instantly dismiss, develop negative association, or churn entirely. Sustainable approach: fewer, more targeted, more relevant messages. Quality beats quantity for long-term LTV.' }];
      const quizQuestions = [{ q: 'Why do in-app messages have higher visibility than push notifications?', options: ['They\'re bigger', 'Users are already active in the app when they appear', 'They require permission so users opted in', 'They\'re more colorful'], correct: 1 }, { q: 'When is the WORST time to show a rating request?', options: ['After completing a task successfully', 'Immediately when the app opens', 'After achieving a milestone', 'After a positive interaction'], correct: 1 }, { q: 'What would happen if you showed upgrade prompts to brand new users?', options: ['Higher conversion - catch them early', 'Risk of churn - they haven\'t experienced value yet', 'No effect - they\'ll decide based on features', 'Better targeting - they\'re the most likely to upgrade'], correct: 1 }, { q: 'Why is frequency capping important for in-app messages?', options: ['Saves server resources', 'Prevents message fatigue and negative user experience', 'Legal requirement', 'Messages cost money to send'], correct: 1 }, { q: 'What makes personalized in-app messages more effective?', options: ['They load faster', 'They feel relevant and 1:1 rather than broadcast', 'They\'re smaller file sizes', 'They bypass frequency caps'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üí¨</div><h2 className="text-2xl font-bold text-indigo-800">In-App Messaging</h2><p className="text-gray-600">Master contextual user engagement</p></div><div className="bg-indigo-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Understand message types and when to use each</li><li>‚Ä¢ Design effective trigger strategies</li><li>‚Ä¢ Apply segmentation for targeted messaging</li><li>‚Ä¢ Implement frequency capping best practices</li></ul></div><div className="bg-white p-4 rounded-xl border border-indigo-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> In-app messages have near-100% visibility for active users and need no permission. Mastering them means guiding users to value, increasing engagement, and driving conversions‚Äîwithout the limitations of push notifications.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-indigo-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-indigo-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-indigo-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'iam'); setShowInfo(!showInfo); }} className="text-indigo-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-indigo-200 text-sm"><p>{infoContent[infoTopic] || infoContent['iam']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started In-App Messaging scenarios']); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-indigo-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('iam'); setShowInfo(true); }} className="text-indigo-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-indigo-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-indigo-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-indigo-200"><h3 className="font-bold text-indigo-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-indigo-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-indigo-50 p-4 rounded-xl text-sm"><p className="font-medium text-indigo-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-indigo-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-indigo-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-indigo-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üí¨'}</div><h2 className="text-2xl font-bold text-indigo-800">In-App Messaging Complete!</h2></div><div className="bg-indigo-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-indigo-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-indigo-200"><p className="font-semibold text-indigo-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Timing matters:</strong> Trigger messages at moments of delight, not interruption</li><li>‚Ä¢ <strong>Segment wisely:</strong> Right message to right user at right stage</li><li>‚Ä¢ <strong>Less is more:</strong> Frequency capping prevents fatigue and churn</li><li>‚Ä¢ <strong>Personalize:</strong> 1:1 messages outperform broadcasts significantly</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Next time you design an in-app message, ask: "Is this the right user, right moment, and right message?" If any answer is no, refine before launching.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const EmailMarketingForAppsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'email_apps': 'Email marketing for mobile apps bridges the gap between in-app and out-of-app engagement. It\'s essential for re-engagement, lifecycle communication, and reaching users who haven\'t opened your app recently.', 'acquisition': 'Build your email list through: in-app signup prompts, value exchanges (get PDF, unlock feature), account creation flows, and website capture. Never buy lists‚Äîdeliverability tanks and it\'s often illegal (GDPR/CAN-SPAM).', 'campaigns': 'Types: Transactional (order confirmations, receipts), Marketing (promotions, announcements), Triggered (behavior-based), Lifecycle (onboarding series, re-engagement). Each serves different purposes and has different rules.', 'lifecycle': 'Welcome series (days 1-7), feature education (weeks 1-4), engagement nudges (based on activity), win-back campaigns (7+ days inactive), anniversary/milestone emails. Map emails to user journey stages.', 'personalization': 'Beyond "Hi {name}": behavioral triggers, dynamic content blocks, send-time optimization, product recommendations based on usage. Personalized emails get 6x higher transaction rates.', 'deliverability': 'Factors: sender reputation, authentication (SPF, DKIM, DMARC), list hygiene, engagement rates, spam complaints. Poor deliverability = emails go to spam. Monitor and maintain constantly.', 'metrics': 'Delivery rate, open rate (declining accuracy post-iOS15), click rate, conversion rate, unsubscribe rate, revenue per email. Track trends over time, not just individual campaigns.' };
      const tutorialSteps = [{ title: 'Why Email for Mobile Apps?', content: 'Email reaches users outside your app‚Äîcritical for re-engagement. Unlike push (which can be disabled), email reaches the inbox. It\'s perfect for: bringing lapsed users back, lifecycle communication, receipts/confirmations, and detailed content that won\'t fit in push.' }, { title: 'Building Your Email List', content: 'Acquisition methods: Require email at signup (friction vs data tradeoff), offer value exchange (exclusive content, discounts), progressive profiling (ask over time). Never buy lists‚Äîdestroys deliverability and violates laws. Quality over quantity always.' }, { title: 'Campaign Types', content: 'Transactional: Triggered by actions (purchase receipt, password reset). High open rates, legally required. Marketing: Promotional content, requires consent. Behavioral: Triggered by user actions (abandoned cart, feature unused). Lifecycle: Based on time since signup/last activity.' }, { title: 'Lifecycle Email Strategy', content: 'Day 0: Welcome + quick win. Days 1-3: Feature education. Week 1: Success stories/use cases. Week 2+: Based on engagement. 7 days inactive: Re-engagement series. 30+ days inactive: Win-back with incentive. Match content to where user is in journey.' }, { title: 'Personalization That Works', content: 'Basic: Name, location. Better: In-app behavior triggers (completed X, should try Y). Best: Predictive (users like you loved...). Dynamic content: Different blocks for different segments in same email. Send time optimization: When does THIS user check email?' }, { title: 'Deliverability Fundamentals', content: 'Your reputation matters: Set up SPF, DKIM, DMARC authentication. Warm up new IPs gradually. Remove bounces immediately. Suppress unengaged users (no opens in 90 days). Low complaint rate (<0.1%). ISPs watch everything‚Äîbad behavior = spam folder.' }, { title: 'Measuring Email Performance', content: 'Track: Delivery rate (should be >95%), Open rate (benchmark ~20%, less reliable now), Click rate (benchmark ~2-3%), Conversion rate (what matters most), Unsubscribe rate (>0.5% is concerning). Also track downstream: app opens, purchases attributed to email.' }];
      const scenarios = [{ title: 'List Building Strategy', context: 'Your app has 100K users but only 5K email addresses. Leadership wants to send marketing emails to drive a new feature launch.', question: 'What\'s the best approach to grow your email list quickly and sustainably?', options: ['Buy a list of 50K emails in your target demographic', 'Add email requirement to access the new feature', 'Offer exclusive early access to the new feature in exchange for email signup', 'Scrape emails from LinkedIn profiles of likely users'], correct: 2, explanation: 'Value exchange is the sustainable approach. Users willingly provide email for something valuable (early access). Buying lists destroys deliverability and violates privacy laws. Requiring email for basic features creates friction and resentment. Scraping is illegal in most jurisdictions.' }, { title: 'Re-engagement Campaign Design', context: 'You have 20K users who haven\'t opened the app in 30+ days. Open rates on previous "We miss you" emails: 8% (vs 22% average).', question: 'Why are re-engagement emails underperforming and how would you fix it?', options: ['Subject lines too generic‚Äîtest more compelling copy', 'These users are gone‚Äîremove them from list', 'Send more frequently until they re-engage', 'Segment by last activity and personalize the win-back offer'], correct: 3, explanation: 'One-size-fits-all re-engagement fails. A user inactive 30 days is different from 90 days. Segment by: recency, previous engagement level, what features they used. Personalize: "Your [specific feature] misses you" beats "We miss you." Different incentives for different value segments.' }, { title: 'Deliverability Crisis', context: 'Your email open rates dropped from 22% to 8% over 3 months. You\'ve been sending 3x more emails to hit revenue targets.', question: 'What\'s most likely happening and how do you fix it?', options: ['Users lost interest in your app‚Äîfocus on product improvements', 'You\'re likely being routed to spam‚Äîreduce volume and improve list hygiene', 'Open tracking is broken‚Äîcheck your email platform', 'Competition increased‚Äîmake subject lines more aggressive'], correct: 1, explanation: 'Classic deliverability death spiral. More emails ‚Üí lower engagement rates ‚Üí ISPs see low engagement ‚Üí route to spam ‚Üí even lower engagement ‚Üí panic send more. Fix: Immediately reduce volume, remove unengaged subscribers (no opens in 90 days), focus only on engaged segments while reputation recovers.' }, { title: 'Personalization Investment', context: 'Marketing wants to add dynamic product recommendations to emails based on user behavior. Engineering estimates 2 sprints of work.', question: 'How do you evaluate if this investment is worth it?', options: ['Skip it‚Äîpersonalization is overrated for mobile apps', 'Build it‚Äîpersonalization always improves performance', 'A/B test with manual personalization first, measure lift, then decide', 'Survey users to ask if they want personalized recommendations'], correct: 2, explanation: 'Test before you build. Create a manually personalized version for a small segment, compare to control. If you see significant lift (typically 10-30% for good personalization), the investment is justified. If minimal lift, save the engineering effort. Users say they want personalization but behavior tells the truth.' }];
      const quizQuestions = [{ q: 'Why should you never buy email lists for your app?', options: ['Too expensive', 'Destroys deliverability and often violates privacy laws', 'Users prefer organic signups', 'It\'s difficult to import'], correct: 1 }, { q: 'What causes the "deliverability death spiral"?', options: ['Too many images in emails', 'Sending more emails ‚Üí lower engagement ‚Üí spam folder ‚Üí even lower engagement', 'Using too many tracking pixels', 'Sending on weekends'], correct: 1 }, { q: 'Why has email open rate become less reliable as a metric?', options: ['Users don\'t open emails anymore', 'Apple Mail Privacy Protection pre-loads tracking pixels', 'Email clients block all tracking', 'Open rates were never accurate'], correct: 1 }, { q: 'What\'s the best approach for re-engaging inactive users?', options: ['Send the same "We miss you" email to everyone', 'Segment by inactivity duration and personalize the message', 'Remove them immediately from your list', 'Send more emails until they respond'], correct: 1 }, { q: 'Why is list hygiene important for email marketing?', options: ['Reduces email platform costs', 'Maintains sender reputation and deliverability', 'Legal requirement in all countries', 'Makes reports look better'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìß</div><h2 className="text-2xl font-bold text-teal-800">Email Marketing for Apps</h2><p className="text-gray-600">Master out-of-app engagement and lifecycle communication</p></div><div className="bg-teal-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Build email lists ethically and sustainably</li><li>‚Ä¢ Design lifecycle email strategies</li><li>‚Ä¢ Understand and maintain deliverability</li><li>‚Ä¢ Measure and optimize email performance</li></ul></div><div className="bg-white p-4 rounded-xl border border-teal-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> Email reaches users when they\'re not in your app‚Äîessential for re-engagement. Unlike push notifications, email can\'t be disabled at the OS level. It\'s your direct line for bringing lapsed users back and nurturing relationships over time.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-teal-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-teal-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-teal-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'email_apps'); setShowInfo(!showInfo); }} className="text-teal-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-teal-200 text-sm"><p>{infoContent[infoTopic] || infoContent['email_apps']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Email Marketing scenarios']); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-teal-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('email_apps'); setShowInfo(true); }} className="text-teal-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-teal-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-teal-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-teal-200"><h3 className="font-bold text-teal-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-teal-50 p-4 rounded-xl text-sm"><p className="font-medium text-teal-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-teal-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-teal-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-teal-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üìß'}</div><h2 className="text-2xl font-bold text-teal-800">Email Marketing Complete!</h2></div><div className="bg-teal-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-teal-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-teal-200"><p className="font-semibold text-teal-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Build lists ethically:</strong> Value exchange beats bought lists every time</li><li>‚Ä¢ <strong>Deliverability is fragile:</strong> Reputation takes months to build, days to destroy</li><li>‚Ä¢ <strong>Segment and personalize:</strong> One-size-fits-all emails underperform dramatically</li><li>‚Ä¢ <strong>Test before building:</strong> Validate personalization lift before engineering investment</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Audit your current email program: What\'s your deliverability rate? When did you last clean your list? Are you sending to unengaged users? Small hygiene improvements often yield big results.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-teal-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const RetentionMetricsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'retention': 'Retention measures what percentage of users return after their first use. It\'s the foundation of sustainable growth‚Äîwithout retention, acquisition is just filling a leaky bucket.', 'dau_mau': 'DAU (Daily Active Users) / MAU (Monthly Active Users) ratio measures stickiness. 50%+ is excellent (users open daily), 20% is average, <10% indicates sporadic usage. Context matters: games expect higher than productivity apps.', 'curves': 'Retention curves show % of users returning over time. Day 1: ~40% typical, Day 7: ~20%, Day 30: ~10%. The curve\'s shape matters: flat tail = stable core users, continued decline = underlying problems.', 'churn': 'Churn = users who stop using your app. Calculate: (Users at start - Users at end) / Users at start. Understand WHY: forced churn (credit card expired) vs voluntary churn (found alternative). Different causes need different solutions.', 'cohorts': 'Cohort analysis groups users by acquisition date to track retention over time. Compare Week 1 cohort to Week 4 cohort‚Äîare improvements working? Are seasonal patterns affecting retention?', 'stickiness': 'Stickiness = DAU/MAU. High stickiness (>25%) means users return frequently. Low stickiness means users try it, leave, and occasionally return. Different apps have different stickiness expectations.', 'ltv_link': 'Retention directly drives LTV. A user retained 2x longer isn\'t just 2x more valuable‚Äîthey\'re often 3-4x due to increased engagement, purchases, and referrals over time.' };
      const tutorialSteps = [{ title: 'What is Retention?', content: 'Retention measures how many users come back after their first experience. A user who downloads your app but never returns = 0 retention value. Retention is THE most important metric because it determines if your product delivers lasting value.' }, { title: 'DAU, MAU, and Stickiness', content: 'DAU = users active today. MAU = users active in last 30 days. DAU/MAU = stickiness ratio. Example: 10K DAU, 50K MAU = 20% stickiness (users open ~6 days/month on average). Higher stickiness = stronger habit formation.' }, { title: 'Retention Curves', content: 'Retention curves plot % of users returning over time. Day 1: Did they come back at all? Day 7: Are they forming a habit? Day 30: Are they a retained user? The curve\'s shape tells the story: steep early drop is normal, but the tail should flatten.' }, { title: 'Understanding Churn', content: 'Churn is the opposite of retention‚Äîusers who stopped using your app. Types: Active churn (user deletes app), Passive churn (stops opening), Revenue churn (stops paying). Each requires different intervention strategies.' }, { title: 'Cohort-Based Analysis', content: 'Group users by when they joined (cohorts). Compare: "How did January users retain vs February users?" This isolates product changes from external factors. If February cohort retains better, your improvements are working.' }, { title: 'Benchmarking Stickiness', content: 'Stickiness benchmarks vary by category: Social apps: 50%+ (daily habit), Games: 20-40%, Productivity: 15-25%, E-commerce: 10-20%. Know your category. A 15% stickiness is great for e-commerce but concerning for social.' }, { title: 'Retention\'s Impact on LTV', content: 'Retention compounds value: 2x retention ‚âà 3-4x LTV. Why? Retained users: buy more over time, refer friends, cost nothing to re-acquire, upgrade to paid tiers. Improving retention is often the highest-ROI investment.' }];
      const scenarios = [{ title: 'Interpreting Retention Data', context: 'Your app shows: Day 1 retention: 45%, Day 7: 22%, Day 30: 8%. Industry benchmark: Day 1: 40%, Day 7: 20%, Day 30: 10%.', question: 'What does this data tell you about your product?', options: ['Your retention is great‚Äîabove benchmark on Day 1 and Day 7', 'You have strong initial engagement but lose users faster than average long-term', 'The data is normal‚Äîno action needed', 'Focus on Day 1 since it\'s your strongest metric'], correct: 1, explanation: 'You beat benchmarks early (Day 1, Day 7) but underperform at Day 30 (8% vs 10% benchmark). This suggests: good first impression and initial habit formation, but users don\'t find lasting value. Focus on understanding why users drop between Week 1-4. What\'s missing in the core experience?' }, { title: 'Stickiness Diagnosis', context: 'Your productivity app has 100K MAU but only 8K DAU. Team thinks this is a problem.', question: 'What\'s your analysis of this 8% stickiness ratio?', options: ['Definitely a problem‚Äîneed to increase daily engagement', 'Need more context‚Äî8% might be normal for your app type', 'Very concerning‚Äîaim for 50% like social apps', 'DAU/MAU doesn\'t matter for productivity apps'], correct: 1, explanation: 'Stickiness depends on use case. Productivity apps typically see 15-25% stickiness‚Äîyou\'re below average. But some productivity apps are weekly-use (project planning), making lower DAU acceptable. Ask: What\'s the intended use frequency? If daily, 8% is concerning. If weekly, calculate WAU/MAU instead.' }, { title: 'Churn Investigation', context: 'Your subscription app has 5% monthly churn. 60% of churners cancel after seeing the renewal reminder, 40% just stop using without canceling.', question: 'How should you prioritize addressing these two churn types?', options: ['Focus on the 60% who actively cancel‚Äîthey\'re making a decision', 'Focus on the 40% passive churners‚Äîthey\'re easier to save', 'Address both equally‚Äîchurn is churn', 'Target the 60% with discounts to prevent cancellation'], correct: 0, explanation: 'The 60% active cancelers are making a conscious decision at a specific moment (renewal reminder). This is a clear intervention point. Understand WHY: too expensive, not using enough, found alternative? The 40% passive churners may already be mentally gone. Active churners give you a chance to address objections before they leave.' }, { title: 'Cohort Comparison', context: 'January cohort: 12% Day 30 retention. February cohort (after onboarding improvements): 14% Day 30 retention. March cohort: 11% Day 30 retention.', question: 'What conclusions can you draw?', options: ['Onboarding improvements worked‚Äîkeep them', 'Can\'t conclude anything‚Äîneed more data', 'March drop means improvements didn\'t work', 'February was an anomaly‚Äîignore it'], correct: 1, explanation: 'Three cohorts isn\'t enough to conclude. February\'s improvement could be: the onboarding change, seasonal effect, different acquisition source, or random variation. Need to: run longer, control for acquisition source, A/B test the onboarding change directly. Data-driven doesn\'t mean jumping to conclusions with small samples.' }];
      const quizQuestions = [{ q: 'Why is retention considered the most important mobile app metric?', options: ['It\'s easiest to measure', 'Without retention, acquisition spending is wasted‚Äîyou\'re filling a leaky bucket', 'Investors only care about retention', 'It\'s required for App Store ranking'], correct: 1 }, { q: 'What does a 25% DAU/MAU ratio tell you?', options: ['25% of users are paying customers', 'Users open the app about 7-8 days per month on average', 'The app is losing users', '25% of users will churn this month'], correct: 1 }, { q: 'Why should you analyze retention by cohort rather than overall?', options: ['Cohorts are easier to calculate', 'It isolates product changes from external factors and user mix shifts', 'Investors prefer cohort metrics', 'Overall retention is always misleading'], correct: 1 }, { q: 'What\'s the difference between active and passive churn?', options: ['Active churn is faster than passive churn', 'Active churners explicitly cancel; passive churners just stop using', 'Passive churn is more concerning than active churn', 'There is no meaningful difference'], correct: 1 }, { q: 'Why does 2x retention often result in 3-4x LTV?', options: ['Math error in the model', 'Retained users buy more, refer friends, and cost nothing to re-acquire', 'LTV calculations are inaccurate', 'It\'s just an approximation'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìà</div><h2 className="text-2xl font-bold text-purple-800">Retention Metrics</h2><p className="text-gray-600">Master the most important growth metric</p></div><div className="bg-purple-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Understand DAU, MAU, and stickiness ratios</li><li>‚Ä¢ Interpret retention curves effectively</li><li>‚Ä¢ Analyze churn and its causes</li><li>‚Ä¢ Apply cohort-based retention analysis</li></ul></div><div className="bg-white p-4 rounded-xl border border-purple-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> Retention is the foundation of sustainable growth. Without retention, you\'re filling a leaky bucket‚Äîno amount of acquisition spending will save you. Understanding retention metrics helps you identify problems early and measure the impact of improvements.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-purple-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-purple-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-purple-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'retention'); setShowInfo(!showInfo); }} className="text-purple-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-purple-200 text-sm"><p>{infoContent[infoTopic] || infoContent['retention']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Retention Metrics scenarios']); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-purple-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('retention'); setShowInfo(true); }} className="text-purple-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-purple-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-purple-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-purple-200"><h3 className="font-bold text-purple-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-purple-50 p-4 rounded-xl text-sm"><p className="font-medium text-purple-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-purple-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-purple-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-purple-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üìà'}</div><h2 className="text-2xl font-bold text-purple-800">Retention Metrics Complete!</h2></div><div className="bg-purple-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-purple-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-purple-200"><p className="font-semibold text-purple-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Context matters:</strong> Stickiness benchmarks vary dramatically by app type</li><li>‚Ä¢ <strong>Cohorts isolate causation:</strong> Compare cohorts to measure real impact</li><li>‚Ä¢ <strong>Retention compounds:</strong> Small retention improvements have outsized LTV impact</li><li>‚Ä¢ <strong>Understand churn types:</strong> Active vs passive churn require different solutions</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Calculate your current Day 1, Day 7, and Day 30 retention. Compare to category benchmarks. If you don\'t know these numbers, getting visibility should be priority #1.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const CohortAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'cohort': 'A cohort is a group of users who share a common characteristic, typically acquisition date. Analyzing by cohort reveals patterns hidden in aggregate data and shows how user behavior changes over time.', 'acquisition': 'Acquisition cohorts group users by when they joined (Week 1, Week 2, etc.). This is the most common cohort type and essential for measuring product improvements over time.', 'behavioral': 'Behavioral cohorts group users by actions: "users who completed onboarding" vs "users who skipped." Compare these cohorts to understand which behaviors predict retention and LTV.', 'matrix': 'A cohort retention matrix shows each cohort as a row, with columns showing retention at each time period. Reading across = one cohort over time. Reading down = all cohorts at same age.', 'triangles': 'Cohort charts are often triangular because recent cohorts haven\'t aged yet. Week 8 cohort can only show Week 1 data. This is normal‚Äîdon\'t compare incomplete cohorts.', 'seasonality': 'Users acquired in different seasons may behave differently. December holiday users might have different retention than March users. Control for seasonality when comparing cohorts.', 'ltv_cohort': 'LTV by cohort shows revenue generated by each group. If January cohort has 2x LTV of December, investigate: what changed? Different channel? Product update? Seasonality?' };
      const tutorialSteps = [{ title: 'What is Cohort Analysis?', content: 'Cohort analysis groups users by a shared characteristic (usually signup date) and tracks their behavior over time. Instead of asking "What\'s our retention?" ask "How does Week 1 cohort\'s retention compare to Week 4 cohort?" This reveals trends hidden in averages.' }, { title: 'Acquisition vs Behavioral Cohorts', content: 'Acquisition cohorts: grouped by when they joined. Use to measure product improvements. Behavioral cohorts: grouped by actions taken. Use to identify high-value behaviors. Both are essential‚Äîacquisition shows product evolution, behavioral shows what drives success.' }, { title: 'Reading a Cohort Matrix', content: 'Rows = cohorts (e.g., January signups). Columns = time periods (Day 1, Day 7, Day 30). Read across: How one cohort ages. Read down: How all cohorts perform at the same age. Down comparison shows if you\'re improving over time.' }, { title: 'Understanding Triangular Data', content: 'Cohort charts are triangular‚Äînew cohorts have less data. March cohort can\'t show Day 30 retention until April. Don\'t compare incomplete data. Wait for cohorts to "mature" before drawing conclusions.' }, { title: 'Controlling for Seasonality', content: 'Holiday users behave differently. Compare January 2024 cohort to January 2023, not to August 2024. Seasonal effects are real: back-to-school, holidays, tax season all affect acquisition quality and retention.' }, { title: 'LTV by Cohort', content: 'Track revenue per cohort over time. If Q2 cohort generates $50 LTV and Q3 generates $35, investigate. Did channel mix change? Did product worsen? Did pricing change? Cohort LTV is your early warning system.' }, { title: 'Actionable Cohort Insights', content: 'Use cohorts to: 1) Measure product improvements (compare pre/post feature launch), 2) Identify best channels (cohorts by acquisition source), 3) Find optimal timing (behavioral cohorts by onboarding completion time), 4) Detect regression early (declining cohort quality).' }];
      const scenarios = [{ title: 'Interpreting Cohort Trends', context: 'Your cohort matrix shows: January cohort Day 30: 12%, February: 14%, March: 15%, April: 13%. You launched an onboarding improvement in February.', question: 'What can you conclude about the onboarding change?', options: ['The improvement worked‚ÄîFebruary and March are higher than January', 'The improvement failed‚ÄîApril dropped from March', 'Can\'t conclude yet‚Äîneed more cohorts and to control for variables', 'The data shows clear improvement‚Äîroll it out further'], correct: 2, explanation: 'Four data points isn\'t enough. February/March improvement could be: the onboarding change, seasonal variation, different channel mix, or random noise. April\'s drop could be: regression, seasonality, or channel quality change. To prove causation: A/B test the onboarding, run longer, control for acquisition source.' }, { title: 'Behavioral Cohort Design', context: 'You want to understand which onboarding behaviors predict long-term retention. You can track: profile completion, first core action, tutorial completion, first purchase.', question: 'How should you design your behavioral cohorts?', options: ['Track all behaviors in one large cohort analysis', 'Create separate cohorts for each behavior: completed vs not completed', 'Only track users who did all behaviors', 'Focus on purchase behavior since it\'s the most valuable'], correct: 1, explanation: 'Create binary cohorts for each behavior: "completed profile vs not" and compare retention. This isolates each behavior\'s impact. Combining all behaviors loses granularity. Focusing only on purchase misses leading indicators. The goal: find which behaviors predict retention, then encourage those behaviors.' }, { title: 'Triangular Data Trap', context: 'CEO asks: "Our latest cohort has 40% Day 7 retention‚Äîbest ever! Should we do a press release?" The cohort is from last week. Historical average is 25%.', question: 'What\'s wrong with this conclusion?', options: ['Day 7 retention is too early to measure success', 'The cohort is too recent‚Äîwe only have Day 7 data, not Day 30+', 'One cohort is too small a sample size', 'Nothing wrong‚Äîcelebrate wins when you see them'], correct: 1, explanation: 'The cohort triangle trap: new cohorts look great because they haven\'t aged yet. Day 7 might look amazing while Day 30 reveals the true story. Wait for cohorts to mature before celebrating. Also, one exceptionally good cohort might be an outlier. Compare to multiple historical cohorts at the same maturity level.' }, { title: 'Channel Mix Cohort', context: 'February cohort has 2x the LTV of January cohort. The team is excited about the product improvements launched in February.', question: 'Before crediting the product improvements, what should you check?', options: ['Nothing‚Äîproduct improvements clearly worked', 'Check if channel mix changed (did February have more organic users?)', 'Wait 90 days for full LTV to mature', 'Compare to industry benchmarks'], correct: 1, explanation: 'Channel mix is the hidden variable. If January was 80% paid acquisition and February was 80% organic, the LTV difference might be entirely due to channel quality, not product. Organic users often have 2-3x LTV of paid users. Always segment cohorts by channel before attributing changes to product.' }];
      const quizQuestions = [{ q: 'Why is cohort analysis more valuable than aggregate metrics?', options: ['Cohorts are easier to calculate', 'Cohorts reveal trends hidden in averages and isolate causation', 'Investors prefer cohort reports', 'Aggregate metrics are always misleading'], correct: 1 }, { q: 'What does "reading down" a cohort matrix tell you?', options: ['How one cohort ages over time', 'How all cohorts perform at the same maturity age', 'Total users in each cohort', 'Revenue per cohort'], correct: 1 }, { q: 'Why are cohort charts typically triangular?', options: ['Design choice for readability', 'Recent cohorts haven\'t aged enough to show full retention data', 'Older cohorts have smaller sample sizes', 'It\'s an error in the visualization'], correct: 1 }, { q: 'When comparing cohorts, why must you control for acquisition channel?', options: ['Different channels have different costs', 'Channel mix affects LTV, confounding product impact measurement', 'Channels have different tracking accuracy', 'It\'s a regulatory requirement'], correct: 1 }, { q: 'What\'s the primary purpose of behavioral cohorts?', options: ['Track feature usage', 'Identify which actions predict long-term retention and LTV', 'Segment users for marketing', 'Reduce data storage costs'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üìä</div><h2 className="text-2xl font-bold text-cyan-800">Cohort Analysis</h2><p className="text-gray-600">Uncover hidden patterns in user behavior</p></div><div className="bg-cyan-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Understand acquisition vs behavioral cohorts</li><li>‚Ä¢ Read and interpret cohort retention matrices</li><li>‚Ä¢ Avoid common cohort analysis pitfalls</li><li>‚Ä¢ Use cohorts to measure product impact</li></ul></div><div className="bg-white p-4 rounded-xl border border-cyan-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> Aggregate metrics hide the truth. "20% retention" could mean a declining product (old cohorts at 30%, new at 10%) or an improving one (old at 10%, new at 30%). Cohort analysis reveals the real story and helps you measure what actually matters.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-cyan-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-cyan-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-cyan-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'cohort'); setShowInfo(!showInfo); }} className="text-cyan-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-cyan-200 text-sm"><p>{infoContent[infoTopic] || infoContent['cohort']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Cohort Analysis scenarios']); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-cyan-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('cohort'); setShowInfo(true); }} className="text-cyan-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-cyan-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-cyan-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-cyan-200"><h3 className="font-bold text-cyan-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-cyan-50 p-4 rounded-xl text-sm"><p className="font-medium text-cyan-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-cyan-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-cyan-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-cyan-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üìä'}</div><h2 className="text-2xl font-bold text-cyan-800">Cohort Analysis Complete!</h2></div><div className="bg-cyan-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-cyan-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-cyan-200"><p className="font-semibold text-cyan-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Cohorts reveal truth:</strong> Aggregates hide improving or declining trends</li><li>‚Ä¢ <strong>Control for variables:</strong> Channel, seasonality, and sample size all matter</li><li>‚Ä¢ <strong>Wait for maturity:</strong> Don\'t celebrate new cohorts until they\'ve aged</li><li>‚Ä¢ <strong>Use behavioral cohorts:</strong> Find which actions predict success</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Build a cohort retention matrix for your product. Compare your latest cohort to 3 months ago at the same maturity. Are you improving? If you don\'t have cohort analysis yet, make it your next analytics priority.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-cyan-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const MobileABTestingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'ab_testing': 'A/B testing compares two versions (A=control, B=variant) with real users to determine which performs better. It\'s the gold standard for data-driven product decisions because it isolates causation.', 'hypothesis': 'A good hypothesis states: what you\'re changing, what metric will improve, and why. "Changing button color from blue to green will increase clicks by 10% because green signals action."', 'sample_size': 'Sample size determines how long to run a test. Factors: baseline conversion rate, minimum detectable effect (MDE), statistical power (usually 80%), significance level (usually 95%). Small effects need bigger samples.', 'significance': 'Statistical significance (p-value <0.05) means there\'s <5% chance the result is random noise. But significance ‚â† importance. A 0.1% lift can be significant with large samples but practically meaningless.', 'pitfalls': 'Common mistakes: peeking at results too early (increases false positives), stopping when significant (confirmation bias), testing too many variants (multiple comparison problem), ignoring novelty effects.', 'mobile_specific': 'Mobile A/B testing challenges: app store review delays, users on old versions, smaller sample sizes per screen, platform differences (iOS vs Android). Server-side testing avoids app update delays.', 'guardrails': 'Guardrail metrics protect against unintended harm. If testing a checkout flow change, track conversion (primary) but also crashes, support tickets, and returns (guardrails). Don\'t ship a "win" that breaks something else.' };
      const tutorialSteps = [{ title: 'What is A/B Testing?', content: 'A/B testing randomly splits users into groups: Control (A) sees the existing version, Variant (B) sees the change. Compare outcomes. If B beats A with statistical confidence, roll out B. It\'s the scientific method applied to product decisions.' }, { title: 'Forming a Hypothesis', content: 'Don\'t just test‚Äîhypothesize. Bad: "Test red vs blue button." Good: "Red button will increase signups by 15% because red creates urgency and our button currently blends into the background." Hypotheses force you to think about WHY.' }, { title: 'Sample Size and Duration', content: 'Running a test too short = false positives. Use sample size calculators. Inputs: baseline rate (current conversion), MDE (minimum improvement worth detecting), power (80%), significance (95%). A 1% baseline with 10% MDE needs ~15K users per variant.' }, { title: 'Statistical Significance', content: 'p<0.05 means <5% probability the result is chance. But: 1) Significance requires planned sample size‚Äîpeeking early inflates false positives, 2) Significance ‚â† importance‚Äîtiny effects can be "significant" with big samples. Always consider practical significance.' }, { title: 'Common A/B Testing Mistakes', content: 'Peeking: Checking results daily and stopping when p<0.05. Multiple testing: Testing 10 variants increases false positive rate to ~40%. Novelty effect: Users react to "new" not "better." Duration: Run for full business cycles (at least 1-2 weeks).' }, { title: 'Mobile-Specific Challenges', content: 'App updates require store approval‚Äîcan\'t quickly iterate. Users on old versions skew results. Smaller screens = fewer elements to test. Solution: server-side feature flags, test critical flows first, plan for longer cycles.' }, { title: 'Guardrail Metrics', content: 'Primary metric: what you\'re trying to improve. Guardrails: what you must not break. Testing checkout? Primary: conversion. Guardrails: crash rate, customer support tickets, returns. A "win" that increases crashes isn\'t a win.' }];
      const scenarios = [{ title: 'Test Duration Decision', context: 'Your test has 5K users per variant after 3 days. Current p-value: 0.03. Variant shows +8% conversion. PM wants to ship immediately.', question: 'Should you ship the variant?', options: ['Yes‚Äîp<0.05 means it\'s statistically significant', 'No‚Äîrun until planned sample size, current result may be a false positive', 'Yes‚Äî8% lift is clearly meaningful', 'No‚Äîneed to wait for p<0.01 for confidence'], correct: 1, explanation: 'Peeking and stopping early massively inflates false positives. With multiple "peeks," your actual false positive rate can be 20-30%, not 5%. Always run to your pre-planned sample size or duration. The 0.03 p-value today might be 0.15 tomorrow as more data comes in.' }, { title: 'Multiple Variant Analysis', context: 'You tested 5 different button colors. One shows p=0.04 improvement. Team wants to ship it.', question: 'What\'s the problem with this conclusion?', options: ['p=0.04 is not significant enough', 'Testing 5 variants means ~23% chance of one false positive‚Äîneed Bonferroni correction', 'Button color tests are never reliable', 'Need 10K users per variant for color tests'], correct: 1, explanation: 'Multiple comparison problem: with 5 tests at Œ±=0.05, probability of at least one false positive is 1-(0.95^5) ‚âà 23%. Apply Bonferroni correction: divide Œ± by number of tests (0.05/5 = 0.01). Only results with p<0.01 are significant. The p=0.04 variant likely isn\'t a real winner.' }, { title: 'Guardrail Alert', context: 'Your new checkout flow shows +12% conversion (p<0.01). But crash rate increased from 0.1% to 0.3%, and support tickets about checkout are up 40%.', question: 'What should you do?', options: ['Ship it‚Äîconversion is the primary metric and 12% lift is huge', 'Don\'t ship‚Äîguardrail metrics indicate serious problems', 'Ship to 50% of users as a compromise', 'The crashes might be unrelated‚Äîship and monitor'], correct: 1, explanation: 'Guardrails exist to catch unintended consequences. 3x crash rate and 40% more support tickets signal something is broken. The conversion lift might come from users who didn\'t experience issues‚Äîor the test is measuring the wrong thing. Investigate the problems first, then re-test.' }, { title: 'Novelty Effect Detection', context: 'Week 1: Variant shows +15% engagement. Week 2: +8%. Week 3: +3%. Week 4: +1% (not significant).', question: 'What does this pattern indicate?', options: ['Test was successful in Week 1, should have shipped then', 'Novelty effect‚Äîusers reacted to "new" not "better"', 'Sample size was too small to detect the real effect', 'The variant degraded over time‚Äîcheck for bugs'], correct: 1, explanation: 'Classic novelty effect pattern: big initial lift that decays to near-zero. Users engaged because it was different, not because it was better. Long-term, no real improvement. This is why tests need to run for multiple weeks‚Äînovelty effects wash out. If you shipped at Week 1, you\'d have shipped a null result.' }];
      const quizQuestions = [{ q: 'Why is "peeking" at A/B test results problematic?', options: ['It slows down decision-making', 'It increases the false positive rate significantly', 'It violates user privacy', 'It uses too much computing power'], correct: 1 }, { q: 'What is the multiple comparison problem?', options: ['Comparing iOS to Android users', 'Testing many variants increases probability of at least one false positive', 'Running tests on multiple metrics', 'Having too many users in a test'], correct: 1 }, { q: 'What are guardrail metrics in A/B testing?', options: ['Metrics that should not get worse even if primary metric improves', 'Metrics used to secure the test', 'Backup metrics if primary fails', 'Metrics only for safety-critical apps'], correct: 0 }, { q: 'How do you know if an A/B test result is due to novelty effect?', options: ['The lift is very large initially', 'The lift decays over time as users get used to the change', 'The p-value fluctuates', 'More users engage in the first week'], correct: 1 }, { q: 'Why is a hypothesis important before running an A/B test?', options: ['Required by analytics platforms', 'Forces you to think about WHY a change might work, guiding interpretation', 'Makes the test run faster', 'Reduces sample size requirements'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üß™</div><h2 className="text-2xl font-bold text-amber-800">Mobile A/B Testing</h2><p className="text-gray-600">Master the science of product experimentation</p></div><div className="bg-amber-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Design valid A/B tests with proper hypotheses</li><li>‚Ä¢ Understand sample size and statistical significance</li><li>‚Ä¢ Avoid common testing mistakes</li><li>‚Ä¢ Use guardrail metrics for safe shipping</li></ul></div><div className="bg-white p-4 rounded-xl border border-amber-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> Intuition fails‚Äîmost ideas don\'t work. A/B testing lets you validate changes with real data before committing. Done wrong, it gives false confidence. Done right, it\'s your superpower for making better products.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-amber-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-amber-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-amber-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'ab_testing'); setShowInfo(!showInfo); }} className="text-amber-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-amber-200 text-sm"><p>{infoContent[infoTopic] || infoContent['ab_testing']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started Mobile A/B Testing scenarios']); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-amber-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('ab_testing'); setShowInfo(true); }} className="text-amber-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-amber-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-amber-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-amber-200"><h3 className="font-bold text-amber-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-amber-50 p-4 rounded-xl text-sm"><p className="font-medium text-amber-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-amber-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-amber-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-amber-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üß™'}</div><h2 className="text-2xl font-bold text-amber-800">Mobile A/B Testing Complete!</h2></div><div className="bg-amber-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-amber-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-amber-200"><p className="font-semibold text-amber-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Don\'t peek:</strong> Run to planned sample size to avoid false positives</li><li>‚Ä¢ <strong>Correct for multiples:</strong> Testing many variants inflates false positive rate</li><li>‚Ä¢ <strong>Use guardrails:</strong> Primary metric wins mean nothing if guardrails fail</li><li>‚Ä¢ <strong>Watch for novelty:</strong> Run long enough for novelty effects to decay</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Before your next A/B test: write a hypothesis, calculate sample size, define primary AND guardrail metrics, commit to duration upfront. Resist the urge to peek daily‚Äîtrust the process.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-amber-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const UserSegmentationRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'tutorial' | 'play' | 'result'>('intro');
      const [tutorialStep, setTutorialStep] = useState(0);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState('');
      const [scenarioIndex, setScenarioIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [quizIndex, setQuizIndex] = useState(0);
      const [quizScore, setQuizScore] = useState(0);
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const infoContent: Record<string, string> = { 'segmentation': 'User segmentation divides your user base into groups with similar characteristics or behaviors. This enables personalized experiences, targeted marketing, and prioritized product development based on each segment\'s needs.', 'behavioral': 'Behavioral segmentation groups users by actions: feature usage, purchase history, engagement patterns. "Power users" vs "casual users" is behavioral. It\'s predictive‚Äîpast behavior indicates future behavior.', 'demographic': 'Demographic segmentation uses attributes: age, location, device, language. Useful for localization and compliance, but less predictive than behavioral. A 25-year-old in NYC might behave identically to a 45-year-old in Austin.', 'rfm': 'RFM = Recency (when last active), Frequency (how often), Monetary (spend value). Score each 1-5, combine for segments like "Champions" (555) or "At Risk" (155). Simple, actionable, widely used.', 'lifecycle': 'Lifecycle segments: New (0-7 days), Activated (completed key action), Engaged (regular usage), At-risk (declining), Churned (inactive 30+ days). Each stage needs different interventions.', 'value': 'Value-based segmentation: High-LTV users get white-glove treatment, mid-tier get automation, low-value get self-service. Allocate resources where ROI is highest. Don\'t treat all users equally.', 'dynamic': 'Segments aren\'t static. Users move between segments: new‚Üíengaged‚Üíchurning. Build triggers that detect transitions and respond automatically. "User hasn\'t opened in 7 days" ‚Üí re-engagement campaign.' };
      const tutorialSteps = [{ title: 'What is User Segmentation?', content: 'Segmentation divides users into meaningful groups. Instead of treating 100K users the same, identify subgroups: power users, at-risk users, high-value customers. Each segment has different needs, behaviors, and value. Personalization at scale.' }, { title: 'Behavioral vs Demographic', content: 'Demographic: who they are (age, location). Behavioral: what they do (purchases, engagement). Behavioral is usually more predictive. Two users with identical demographics can have opposite behaviors. Prioritize behavioral segmentation for product decisions.' }, { title: 'RFM Analysis', content: 'Recency: Days since last activity. Frequency: Sessions/purchases per month. Monetary: Total spend. Score each 1-5. "Champions" (5-5-5): recent, frequent, high-spend. "Hibernating" (1-1-1): old, rare, low-spend. RFM is simple but powerful.' }, { title: 'Lifecycle Stages', content: 'New: Just joined, needs onboarding. Activated: Completed key action, building habit. Engaged: Regular user, maximize value. At-risk: Usage declining, needs intervention. Churned: Gone, may win back. Each stage requires different strategies.' }, { title: 'Value-Based Segmentation', content: 'Top 10% of users often drive 50%+ of revenue. Segment by LTV: High-value (VIP support, early access), Medium (scaled engagement), Low (efficient self-service). Don\'t over-invest in low-value users or under-invest in high-value.' }, { title: 'Dynamic Segmentation', content: 'Users move between segments constantly. Today\'s champion is tomorrow\'s churning user. Build automated triggers: "If user moves from Engaged to At-Risk, trigger intervention." Real-time segmentation enables proactive action.' }, { title: 'Segment-Specific Strategies', content: 'New users: Onboarding, feature discovery. Power users: Advanced features, referral programs. At-risk: Win-back campaigns, surveys. Each segment gets tailored messaging, features, and treatment. One-size-fits-all fails.' }];
      const scenarios = [{ title: 'Choosing Segmentation Approach', context: 'Your fitness app has 500K users. Marketing wants to segment by age groups (18-24, 25-34, etc.). Product wants to segment by workout frequency.', question: 'Which segmentation approach is likely more valuable for improving retention?', options: ['Age groups‚Äîdifferent ages have different fitness goals', 'Workout frequency‚Äîbehavioral data predicts future behavior better', 'Both equally‚Äîcombine demographic and behavioral', 'Neither‚Äî500K users is too small to segment'], correct: 1, explanation: 'Behavioral segmentation (workout frequency) is more predictive. A daily exerciser aged 22 behaves more like a daily exerciser aged 45 than like an inactive 22-year-old. Age might inform content preferences, but frequency predicts retention and engagement. Start with behavioral, layer demographic for personalization.' }, { title: 'RFM Segment Action', context: 'RFM analysis reveals: Segment A (Champions, 5-5-5): 5% of users, 35% of revenue. Segment B (At-Risk, 2-3-4): 15% of users, 25% of revenue. Segment C (New, 4-1-1): 30% of users, 5% of revenue.', question: 'Where should you focus retention efforts first?', options: ['Segment A‚Äîthey\'re the most valuable, protect them', 'Segment B‚Äîat-risk users with proven value are highest ROI to save', 'Segment C‚Äîlargest segment, most growth potential', 'Equal focus on all three segments'], correct: 1, explanation: 'Segment B (At-Risk) is the sweet spot. They\'ve proven they can generate value (25% of revenue) but are slipping away. Segment A (Champions) are already engaged‚Äîmaintain, don\'t over-invest. Segment C (New) has potential but unproven value‚Äîinvest in activation, not heavy retention. Save at-risk proven value first.' }, { title: 'Lifecycle Transition Detection', context: 'You need to identify users transitioning from "Engaged" to "At-Risk." Data available: last login date, session count (30 days), feature usage, purchase history.', question: 'What\'s the best indicator to trigger an "At-Risk" intervention?', options: ['No purchase in 30 days', 'Declining session count week-over-week for 2+ weeks', 'Not using the newest feature', 'Last login was 14+ days ago'], correct: 1, explanation: 'Declining session count week-over-week catches the trend before it\'s too late. Last login 14+ days might already be too far gone. No purchase isn\'t relevant for all users (some never purchase). Newest feature usage is too specific. The declining trend pattern identifies the transition as it happens, enabling earlier intervention.' }, { title: 'Segment Personalization', context: 'Your e-commerce app identifies: "Weekend Warriors" (shop only weekends), "Deal Seekers" (only buy on sale), "Brand Loyalists" (buy full price, specific brands).', question: 'How should push notification strategy differ for these segments?', options: ['Same notifications to all‚Äîconsistency is key', 'Weekend Warriors: Friday notifications. Deal Seekers: Sale alerts. Brand Loyalists: New arrivals from their brands', 'Only notify Deal Seekers since they respond to promotions', 'Notify based on time zones only'], correct: 1, explanation: 'Segment-specific messaging dramatically improves engagement. Weekend Warriors don\'t need Tuesday notifications. Deal Seekers ignore full-price alerts. Brand Loyalists want curated updates, not sale spam. Match message timing and content to segment behavior. Generic broadcasts underperform personalized approaches by 3-5x.' }];
      const quizQuestions = [{ q: 'Why is behavioral segmentation usually more valuable than demographic?', options: ['It\'s easier to collect', 'Past behavior predicts future behavior better than demographics', 'Demographics are legally restricted', 'Behavioral data is more accurate'], correct: 1 }, { q: 'In RFM analysis, what does a score of 1-5-5 indicate?', options: ['Champion user‚Äîhigh on all dimensions', 'User who hasn\'t been active recently but was frequent and high-value', 'New user with potential', 'Low-value user across all dimensions'], correct: 1 }, { q: 'Why should at-risk users with proven value get priority retention focus?', options: ['They\'re the easiest to reach', 'They\'ve demonstrated value and are worth saving before they churn', 'They\'re the largest segment', 'Regulations require it'], correct: 1 }, { q: 'What makes dynamic segmentation important?', options: ['It\'s required by analytics platforms', 'Users move between segments, and detecting transitions enables proactive action', 'Static segments are illegal', 'Dynamic segments are cheaper to implement'], correct: 1 }, { q: 'How should high-value users be treated differently?', options: ['They should receive more advertisements', 'They should get VIP support, early access, and personalized experiences', 'They should be charged higher prices', 'They should be excluded from A/B tests'], correct: 1 }];
      if (phase === 'intro') {
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">üë•</div><h2 className="text-2xl font-bold text-rose-800">User Segmentation</h2><p className="text-gray-600">Master personalization at scale</p></div><div className="bg-rose-50 p-4 rounded-xl"><p className="text-sm text-gray-700"><strong>Learning Objectives:</strong></p><ul className="text-sm text-gray-600 mt-2 space-y-1"><li>‚Ä¢ Understand behavioral vs demographic segmentation</li><li>‚Ä¢ Apply RFM analysis for actionable segments</li><li>‚Ä¢ Design lifecycle-based user journeys</li><li>‚Ä¢ Implement value-based resource allocation</li></ul></div><div className="bg-white p-4 rounded-xl border border-rose-200"><p className="text-sm text-gray-700"><strong>Why This Matters:</strong> Treating all users the same wastes resources and frustrates users. Segmentation enables the right message to the right user at the right time. It\'s the foundation of personalization, targeted marketing, and efficient resource allocation.</p></div><button onClick={() => setPhase('tutorial')} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Begin Learning ‚Üí</button></div>);
      }
      if (phase === 'tutorial') {
         const step = tutorialSteps[tutorialStep];
         return (<div className="space-y-6"><div className="flex justify-between items-center"><span className="text-sm text-gray-500">Concept {tutorialStep + 1}/{tutorialSteps.length}</span><div className="flex gap-1">{tutorialSteps.map((_, i) => (<div key={i} className={`w-2 h-2 rounded-full ${i <= tutorialStep ? 'bg-rose-600' : 'bg-gray-200'}`} />))}</div></div><div className="bg-rose-50 p-6 rounded-xl"><h3 className="text-lg font-bold text-rose-800 mb-3">{step.title}</h3><p className="text-gray-700">{step.content}</p></div><div className="flex justify-end"><button onClick={() => { setInfoTopic(Object.keys(infoContent)[tutorialStep] || 'segmentation'); setShowInfo(!showInfo); }} className="text-rose-600 text-sm flex items-center gap-1">‚ÑπÔ∏è More Details</button></div>{showInfo && (<div className="bg-white p-3 rounded-lg border border-rose-200 text-sm"><p>{infoContent[infoTopic] || infoContent['segmentation']}</p></div>)}{tutorialStep < tutorialSteps.length - 1 ? (<button onClick={() => { setTutorialStep(tutorialStep + 1); setShowInfo(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Next Concept ‚Üí</button>) : (<button onClick={() => { setPhase('play'); setGameLog([...gameLog, 'Started User Segmentation scenarios']); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Apply Knowledge ‚Üí</button>)}</div>);
      }
      if (phase === 'play') {
         if (scenarioIndex < scenarios.length) {
            const s = scenarios[scenarioIndex];
            return (<div className="space-y-4"><div className="flex justify-between items-center"><span className="text-sm font-medium text-rose-700">Scenario {scenarioIndex + 1}/{scenarios.length}</span><button onClick={() => { setInfoTopic('segmentation'); setShowInfo(true); }} className="text-rose-600 text-lg">‚ÑπÔ∏è</button></div>{showInfo && (<div className="bg-rose-50 p-3 rounded-lg text-sm"><p>{infoContent[infoTopic]}</p><button onClick={() => setShowInfo(false)} className="text-rose-600 text-sm mt-2">Close</button></div>)}<div className="bg-white p-4 rounded-xl border-2 border-rose-200"><h3 className="font-bold text-rose-800">{s.title}</h3><p className="text-sm text-gray-600 mt-2">{s.context}</p><p className="font-medium mt-3">{s.question}</p></div><div className="space-y-2">{s.options.map((opt, i) => (<button key={i} onClick={() => { if (!answered) { setSelectedAnswer(i); setAnswered(true); if (i === s.correct) { setScore(score + 1); setGameLog([...gameLog, `Correct: ${s.title}`]); } else { setGameLog([...gameLog, `Incorrect: ${s.title} - chose "${opt}"`]); } } }} disabled={answered} className={`w-full p-3 rounded-lg text-left text-sm border-2 ${answered ? (i === s.correct ? 'border-green-500 bg-green-50' : i === selectedAnswer ? 'border-red-300 bg-red-50' : 'border-gray-200') : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{answered && (<div className="bg-rose-50 p-4 rounded-xl text-sm"><p className="font-medium text-rose-800">üí° Why: {s.explanation}</p></div>)}{answered && (<button onClick={() => { setScenarioIndex(scenarioIndex + 1); setSelectedAnswer(null); setAnswered(false); setShowInfo(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">{scenarioIndex < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'Take Assessment ‚Üí'}</button>)}</div>);
         }
         const q = quizQuestions[quizIndex];
         if (quizIndex < quizQuestions.length) {
            return (<div className="space-y-6"><div className="text-center"><h3 className="text-xl font-bold text-rose-800">Concept Check</h3><p className="text-sm text-gray-500">Question {quizIndex + 1}/{quizQuestions.length}</p></div><div className="bg-rose-50 p-4 rounded-xl"><p className="font-medium">{q.q}</p></div><div className="space-y-2">{q.options.map((opt, i) => (<button key={i} onClick={() => { if (!quizAnswered) { setQuizAnswered(true); if (i === q.correct) setQuizScore(quizScore + 1); } }} disabled={quizAnswered} className={`w-full p-3 rounded-lg text-left border-2 ${quizAnswered ? (i === q.correct ? 'border-green-500 bg-green-50' : 'border-gray-200') : 'border-gray-200 hover:border-rose-400'}`}>{opt}</button>))}</div>{quizAnswered && (<button onClick={() => { setQuizIndex(quizIndex + 1); setQuizAnswered(false); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Next ‚Üí</button>)}</div>);
         }
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         setPhase('result');
         return null;
      }
      if (phase === 'result') {
         const pct = Math.round(((score + quizScore) / (scenarios.length + quizQuestions.length)) * 100);
         return (<div className="space-y-6"><div className="text-center"><div className="text-6xl mb-4">{pct >= 80 ? 'üèÜ' : 'üë•'}</div><h2 className="text-2xl font-bold text-rose-800">User Segmentation Complete!</h2></div><div className="bg-rose-50 p-6 rounded-xl text-center"><div className="text-4xl font-bold text-rose-700">{pct}%</div><div className="text-sm text-gray-600">Mastery Score</div></div><div className="bg-white p-4 rounded-xl border border-rose-200"><p className="font-semibold text-rose-800 mb-2">Key Insights:</p><ul className="space-y-2 text-sm text-gray-600"><li>‚Ä¢ <strong>Behavioral over demographic:</strong> What users do predicts better than who they are</li><li>‚Ä¢ <strong>RFM for quick wins:</strong> Simple, actionable, proven framework</li><li>‚Ä¢ <strong>Prioritize at-risk value:</strong> Save users who\'ve proven they can generate revenue</li><li>‚Ä¢ <strong>Dynamic triggers:</strong> Detect transitions, act proactively</li></ul></div><div className="bg-gray-50 p-4 rounded-xl text-sm"><p className="font-semibold mb-2">Real-World Application:</p><p className="text-gray-600">Start simple: Create an RFM analysis of your users. Identify your Champions (protect them) and At-Risk valuable users (save them). Build one automated trigger for segment transitions.</p></div><button onClick={() => { setPhase('intro'); setScore(0); setScenarioIndex(0); setSelectedAnswer(null); setAnswered(false); setQuizIndex(0); setQuizAnswered(false); setQuizScore(0); setTutorialStep(0); }} className="w-full py-3 bg-rose-600 text-white rounded-xl font-semibold">Practice Again</button></div>);
      }
      return null;
   };

   const FinancialStatementsRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Profitable Bankruptcy",
            context: "A SaaS startup shows: Revenue $2M, Net Income $400K (20% margin). But they're asking for emergency funding. Their balance sheet shows: Cash $50K, AR $800K (90-day terms), AP $600K (due in 30 days).",
            question: "Why is this profitable company in financial trouble?",
            opts: [
               'The profit margin is too low',
               'Cash flow crisis - AR collection too slow vs AP due dates',
               'They have too much debt',
               'Revenue is declining'
            ],
            correct: 1,
            wrongExplanations: [
               "20% net margin is excellent for SaaS. Margin isn't the problem here. Look at the timing mismatch between assets and liabilities.",
               "", // Correct
               "There's no mention of debt. The issue is working capital timing - they're owed money that won't arrive before bills are due.",
               "Nothing indicates declining revenue. This is a TIMING problem, not a revenue problem. Profitable companies can run out of cash."
            ],
            realWorld: "Toys 'R' Us was profitable in many years before bankruptcy. They couldn't manage working capital during seasonal inventory buildups. Profit ‚â† Cash.",
            concept: "cash_vs_profit",
            why: "Profit is accounting. Cash is survival. They have $800K coming but only $50K in hand, with $600K due NOW. They'll be profitable on paper while bouncing checks. This is why the Cash Flow Statement matters more than the Income Statement for survival."
         },
         {
            title: "The Margin Mystery",
            context: "Two competitors: Company A has 70% gross margin but 5% net margin. Company B has 40% gross margin but 15% net margin. Same revenue ($10M each).",
            question: "What does this tell you about their business models?",
            opts: [
               'Company A is more efficient',
               'Company B has better products',
               'Company A overspends on sales/marketing/overhead',
               'Company B has lower quality products'
            ],
            correct: 2,
            wrongExplanations: [
               "Company A is LESS efficient. They make more per sale (70% vs 40%) but keep less (5% vs 15%). Something is eating their profits between gross and net.",
               "", // Close but wrong framing
               "", // Correct
               "Lower gross margin doesn't mean lower quality. It often means different business models - physical vs digital, commoditized vs differentiated."
            ],
            realWorld: "WeWork had 80%+ gross margins on desks but burned billions on sales, marketing, and Adam Neumann's expenses. High gross margin means nothing if operating costs eat it all.",
            concept: "margin_analysis",
            why: "The GAP between gross and net margin reveals operating efficiency. Company A: 70% - 5% = 65% goes to OpEx. Company B: 40% - 15% = 25% to OpEx. Company A spends 2.6x more on operations per dollar of gross profit. That's a red flag."
         },
         {
            title: "The Growth Trap",
            context: "A startup's 3-year trend: Year 1: Revenue $1M, Burn $500K. Year 2: Revenue $3M, Burn $2M. Year 3: Revenue $8M, Burn $6M. They're raising Series B.",
            question: "What's the critical question investors will ask?",
            opts: [
               'Why is revenue growing so fast?',
               'When will burn rate decrease?',
               'What is the path to unit economics profitability?',
               'Why don\'t you have more customers?'
            ],
            correct: 2,
            wrongExplanations: [
               "Fast revenue growth is GOOD - investors want that. The question is whether that growth is sustainable and eventually profitable.",
               "Burn rate might never decrease if you're scaling. The question is whether each dollar of burn generates profitable returns eventually.",
               "", // Correct
               "Revenue is 8x in 3 years - customer acquisition isn't the problem here. The question is whether those customers are profitable."
            ],
            realWorld: "Uber scaled to $10B+ revenue while losing billions. Investors finally asked: 'Will a ride EVER be profitable?' Unit economics matter more than total growth.",
            concept: "unit_economics",
            why: "Unit economics = profit per customer/transaction. If you lose money on each sale, more sales = more losses. Investors want to see: 'We lose money overall because of fixed costs, but each new customer is profitable. At X scale, we'll be profitable.'"
         },
         {
            title: "The Debt Dilemma",
            context: "Company has $5M revenue, $1M net income. Balance sheet shows: $2M cash, $3M debt at 8% interest ($240K/year). They're considering taking $5M more debt to expand.",
            question: "What financial metric should guide this decision?",
            opts: [
               'Current ratio - can they pay short-term bills?',
               'Interest coverage ratio - can they service the debt?',
               'Gross margin - are products profitable?',
               'Revenue growth rate - is business growing?'
            ],
            correct: 1,
            wrongExplanations: [
               "Current ratio measures short-term liquidity, not debt capacity. They have $2M cash which is fine for short-term. The question is long-term debt service.",
               "", // Correct
               "Gross margin matters for product profitability, not debt decisions. They're already net profitable - the question is debt capacity.",
               "Growth rate is important but doesn't answer: 'Can we afford this debt?' Fast-growing companies have gone bankrupt from over-leveraging."
            ],
            realWorld: "Hertz had strong revenue but took on too much debt. When COVID hit, they couldn't make interest payments and filed bankruptcy despite having a real business.",
            concept: "leverage_ratios",
            why: "Interest Coverage = EBIT / Interest Expense. Current: ~$1.2M / $240K = 5x (healthy). With $5M more at 8%: $640K total interest. New ratio: ~1.9x (danger zone). Banks want 3x+ coverage. This expansion could make them fragile."
         },
         {
            title: "The AR Alarm",
            context: "Your SaaS dashboard shows: MRR grew 50% this year ($100K‚Üí$150K). But AR also grew 200% ($50K‚Üí$150K). Days Sales Outstanding went from 30 to 90 days.",
            question: "What's the hidden problem these numbers reveal?",
            opts: [
               'Growth is too fast to manage',
               'Customers are churning',
               'Revenue recognition is aggressive or customers aren\'t paying',
               'Pricing is too low'
            ],
            correct: 2,
            wrongExplanations: [
               "Fast growth is manageable - the problem is specifically in collections/AR. Growth itself isn't the issue.",
               "If customers churned, revenue would drop, not grow. This is a payment issue, not a retention issue.",
               "", // Correct
               "Pricing doesn't explain why AR grew 4x while revenue grew 1.5x. The issue is cash collection, not pricing."
            ],
            realWorld: "Luckin Coffee (China Starbucks competitor) showed massive revenue growth, but AR grew faster. Investigation revealed fabricated sales that never collected payment. $300M fraud.",
            concept: "ar_analysis",
            why: "Red flags: (1) AR growing faster than revenue = customers not paying, (2) DSO tripling = it takes 3x longer to collect, (3) Either sales are 'recognized' before payment is certain (aggressive accounting) OR customers are slow/unable to pay. Both are serious. Investigate immediately."
         }
      ];

      const infoTopics: Record<string, { title: string; content: string }> = {
         income: {
            title: "Income Statement Deep Dive",
            content: "Revenue - COGS = Gross Profit. Gross - OpEx = Operating Income. Operating - Interest - Taxes = Net Income. Watch the GAPS between margins - they reveal where money goes. High gross but low net = operational inefficiency."
         },
         balance: {
            title: "Balance Sheet Analysis",
            content: "Assets = Liabilities + Equity. Current assets/liabilities = due within 1 year. Working Capital = Current Assets - Current Liabilities. Negative working capital = potential cash crisis. Watch AR trends - growing faster than revenue is a red flag."
         },
         cashflow: {
            title: "Cash Flow Statement",
            content: "Operating: cash from business. Investing: buying/selling assets. Financing: debt/equity changes. Profitable companies can have negative operating cash flow (growing AR/inventory). Cash is survival - profit is accounting."
         },
         ratios: {
            title: "Critical Financial Ratios",
            content: "Current Ratio = Current Assets / Current Liabilities (liquidity). Interest Coverage = EBIT / Interest (debt safety). DSO = AR / (Revenue/365) (collection speed). Gross Margin trends reveal pricing power. Compare ratios to industry benchmarks."
         },
         redflags: {
            title: "Financial Red Flags",
            content: "AR growing faster than revenue. Inventory building up. Decreasing margins over time. Debt increasing while profits fall. Revenue up but cash flow down. These patterns often precede major problems or fraud."
         },
         uniteconomics: {
            title: "Unit Economics",
            content: "LTV (Customer Lifetime Value) vs CAC (Customer Acquisition Cost). LTV/CAC should be 3x+. Payback period = months to recover CAC. Contribution margin per unit. If unit economics don't work, scale just accelerates losses."
         }
      };

      useEffect(() => { if (infoTopic && infoTopics[infoTopic]) setShowInfo(true); }, [infoTopic]);

      const startGame = () => {
         setPhase('play');
         setScenario(0);
         setScore(0);
         setSelected(null);
         setAnswered(false);
         setGameLog([]);
         setConceptGaps([]);
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         const isCorrect = idx === s.correct;
         if (isCorrect) {
            setScore(prev => prev + 20);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Understood ${s.concept}`]);
         } else {
            setConceptGaps(prev => prev.includes(s.concept) ? prev : [...prev, s.concept]);
            setGameLog(prev => [...prev, `‚úó ${s.title}: Gap in ${s.concept}`]);
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const getGrade = () => {
         const pct = (score / (scenarios.length * 20)) * 100;
         if (pct >= 90) return { letter: 'A', label: 'Financial Analyst', color: 'text-green-400' };
         if (pct >= 70) return { letter: 'B', label: 'Financially Literate', color: 'text-blue-400' };
         if (pct >= 50) return { letter: 'C', label: 'Developing', color: 'text-yellow-400' };
         return { letter: 'D', label: 'Study Needed', color: 'text-red-400' };
      };

      const conceptLabels: Record<string, string> = {
         cash_vs_profit: "Cash Flow vs Profit",
         margin_analysis: "Margin Analysis & Efficiency",
         unit_economics: "Unit Economics & Scalability",
         leverage_ratios: "Debt & Leverage Ratios",
         ar_analysis: "Accounts Receivable Red Flags"
      };

      if (phase === 'intro') return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-slate-900 to-gray-900 text-white p-4 overflow-auto">
            <div className="text-center mb-4">
               <h1 className="text-2xl font-bold mb-2">üìä Financial Detective</h1>
               <p className="text-blue-300 text-sm">Read between the lines. Numbers tell stories‚Äîif you know what to look for.</p>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-blue-400">‚ö†Ô∏è Why This Matters</h2>
               <div className="space-y-2 text-sm text-slate-300">
                  <p>‚Ä¢ <span className="text-red-400 font-bold">Profitable companies</span> go bankrupt every year</p>
                  <p>‚Ä¢ <span className="text-yellow-400 font-bold">Financial fraud</span> often hides in plain sight</p>
                  <p>‚Ä¢ <span className="text-green-400 font-bold">The real story</span> is in the trends, not the headlines</p>
               </div>
            </div>

            <div className="bg-black/30 rounded-xl p-4 mb-4">
               <h2 className="text-lg font-bold mb-3 text-blue-400">üéØ How This Works</h2>
               <div className="space-y-2 text-sm">
                  <p>‚Ä¢ <span className="text-white font-bold">5 real financial scenarios</span> with hidden problems</p>
                  <p>‚Ä¢ Analyze <span className="text-yellow-400">income statements, balance sheets, cash flow</span></p>
                  <p>‚Ä¢ Spot <span className="text-red-400">red flags</span> that indicate trouble ahead</p>
                  <p>‚Ä¢ Learn what <span className="text-cyan-400">investors and lenders</span> actually look for</p>
               </div>
            </div>

            <div className="flex flex-wrap gap-2 mb-4">
               {Object.keys(infoTopics).map(key => (
                  <button
                     key={key}
                     onClick={() => setInfoTopic(key)}
                     className="text-xs bg-blue-500/20 px-2 py-1 rounded-full text-blue-300 hover:bg-blue-500/30"
                  >
                     ‚ÑπÔ∏è {infoTopics[key].title.split(' ')[0]}
                  </button>
               ))}
            </div>

            <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-blue-600 to-slate-600 rounded-xl font-bold text-lg">
               ‚ñ∂Ô∏è BEGIN ANALYSIS
            </button>

            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}
         </div>
      );

      if (phase === 'result') {
         const grade = getGrade();
         return (
            <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-slate-900 to-gray-900 text-white p-4 overflow-auto">
               <div className="text-center mb-4">
                  <div className={`text-6xl font-bold ${grade.color}`}>{grade.letter}</div>
                  <div className="text-xl font-bold">{grade.label}</div>
                  <div className="text-blue-400">Score: {score}/{scenarios.length * 20}</div>
               </div>

               {conceptGaps.length > 0 && (
                  <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-red-400 mb-2">üìö Concepts to Study</h3>
                     <div className="space-y-1">
                        {conceptGaps.map((gap, i) => (
                           <div key={i} className="flex items-center gap-2 text-sm">
                              <span className="text-red-400">‚Üí</span>
                              <span className="text-slate-300">{conceptLabels[gap] || gap}</span>
                              <button
                                 onClick={() => {
                                    const topic = gap === 'cash_vs_profit' ? 'cashflow' :
                                                  gap === 'margin_analysis' ? 'income' :
                                                  gap === 'unit_economics' ? 'uniteconomics' :
                                                  gap === 'leverage_ratios' ? 'ratios' : 'redflags';
                                    setInfoTopic(topic);
                                 }}
                                 className="text-xs text-blue-400 underline"
                              >
                                 Learn
                              </button>
                           </div>
                        ))}
                     </div>
                  </div>
               )}

               {conceptGaps.length === 0 && (
                  <div className="bg-green-900/30 border border-green-500/50 rounded-xl p-3 mb-3">
                     <h3 className="font-bold text-green-400 mb-2">üéâ Financial Expert!</h3>
                     <p className="text-sm text-slate-300">You can read between the financial lines‚Äîspotting cash crises, margin problems, and red flags before they become disasters.</p>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-3 mb-3 max-h-32 overflow-auto">
                  <h3 className="font-bold text-blue-400 mb-2">üìã Session Log</h3>
                  {gameLog.map((log, i) => (
                     <p key={i} className="text-xs text-slate-400">{log}</p>
                  ))}
               </div>

               <div className="bg-black/30 rounded-xl p-3 mb-4">
                  <h3 className="font-bold text-blue-400 mb-2">üí° Key Insights</h3>
                  <ul className="text-sm text-slate-300 space-y-1">
                     <li>‚Ä¢ <span className="text-yellow-400">Profit ‚â† Cash</span>‚Äîtiming kills profitable companies</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Margin gaps</span> reveal operational efficiency</li>
                     <li>‚Ä¢ <span className="text-yellow-400">AR growing faster than revenue</span> is a red flag</li>
                     <li>‚Ä¢ <span className="text-yellow-400">Unit economics</span> matter more than total growth</li>
                  </ul>
               </div>

               <button onClick={startGame} className="w-full py-3 bg-gradient-to-r from-blue-600 to-slate-600 rounded-xl font-bold">
                  üîÑ TRY AGAIN
               </button>

               {showInfo && infoTopic && infoTopics[infoTopic] && (
                  <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                     <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3>
                        <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                        <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg font-bold">Got it!</button>
                     </div>
                  </div>
               )}
            </div>
         );
      }

      const s = scenarios[scenario];
      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-blue-900 via-slate-900 to-gray-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-blue-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300 leading-relaxed">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-blue-600 rounded-lg font-bold">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-blue-500/30">
               <div className="flex justify-between items-center">
                  <span className="font-bold text-sm">üìä {s.title}</span>
                  <span className="text-blue-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               </div>
               <div className="flex gap-1 mt-2">
                  {scenarios.slice(0, scenario).map((_, i) => (
                     <div key={i} className={`w-3 h-3 rounded ${gameLog[i]?.startsWith('‚úì') ? 'bg-green-500' : 'bg-red-500'}`} />
                  ))}
                  <div className="w-3 h-3 rounded bg-blue-500 animate-pulse" />
                  {scenarios.slice(scenario + 1).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded bg-slate-600" />
                  ))}
               </div>
            </div>

            <div className="flex-1 p-3 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-200 leading-relaxed">{s.context}</p>
               </div>

               <p className="text-sm font-bold text-blue-400 mb-2">{s.question}</p>

               <div className="space-y-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`w-full p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600 border-2 border-green-400'
                                 : i === selected
                                    ? 'bg-red-600 border-2 border-red-400'
                                    : 'bg-black/30 opacity-50'
                              : 'bg-black/30 hover:bg-blue-600/50 border-2 border-transparent'
                        }`}
                     >
                        <span className="flex items-start gap-2">
                           <span className="font-bold text-blue-400">{String.fromCharCode(65 + i)}.</span>
                           <span>{opt}</span>
                        </span>
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-2">
                     {selected !== s.correct && (
                        <div className="p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                           <p className="text-xs font-bold text-red-400 mb-1">‚ùå Why {String.fromCharCode(65 + (selected || 0))} is Wrong:</p>
                           <p className="text-sm text-slate-300">{s.wrongExplanations[selected || 0]}</p>
                        </div>
                     )}

                     <div className="p-3 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p className="text-xs font-bold text-green-400 mb-1">‚úì The Real Issue:</p>
                        <p className="text-sm text-slate-300">{s.why}</p>
                     </div>

                     <div className="p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                        <p className="text-xs font-bold text-amber-400 mb-1">üì∞ Real Case:</p>
                        <p className="text-sm text-slate-300">{s.realWorld}</p>
                     </div>

                     <button onClick={next} className="w-full py-3 bg-gradient-to-r from-blue-600 to-slate-600 rounded-xl font-bold mt-2">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Case ‚Üí'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-blue-500/30 flex gap-2 justify-center flex-wrap">
               <button onClick={() => setInfoTopic('income')} className="text-xs text-blue-400 hover:text-blue-300">‚ÑπÔ∏è Income</button>
               <button onClick={() => setInfoTopic('balance')} className="text-xs text-blue-400 hover:text-blue-300">‚ÑπÔ∏è Balance</button>
               <button onClick={() => setInfoTopic('cashflow')} className="text-xs text-blue-400 hover:text-blue-300">‚ÑπÔ∏è Cash Flow</button>
               <button onClick={() => setInfoTopic('redflags')} className="text-xs text-blue-400 hover:text-blue-300">‚ÑπÔ∏è Red Flags</button>
            </div>
         </div>
      );
   };

   const PricingStrategyRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [round, setRound] = useState(0);
      const [revenue, setRevenue] = useState(0);
      const [customers, setCustomers] = useState(0);
      const [log, setLog] = useState<string[]>([]);
      const rounds = [
         {product:'SaaS Tool',cost:20,competitors:[49,79,99],options:[{price:29,demand:100},{price:49,demand:70},{price:79,demand:40},{price:99,demand:20}]},
         {product:'Online Course',cost:50,competitors:[197,297,497],options:[{price:97,demand:80},{price:197,demand:50},{price:297,demand:30},{price:497,demand:15}]},
         {product:'Consulting Hour',cost:0,competitors:[150,250,400],options:[{price:100,demand:90},{price:200,demand:50},{price:350,demand:25},{price:500,demand:10}]},
         {product:'Physical Product',cost:15,competitors:[29,39,49],options:[{price:24,demand:100},{price:34,demand:70},{price:44,demand:45},{price:54,demand:25}]},
         {product:'Mobile App',cost:5,competitors:[0,4.99,9.99],options:[{price:0,demand:1000},{price:2.99,demand:200},{price:6.99,demand:80},{price:12.99,demand:30}]}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         costplus:{title:'Cost-Plus Pricing',content:'Price = Cost + Markup. Simple but ignores what customers will pay and competitor prices.'},
         value:{title:'Value-Based Pricing',content:'Price based on value delivered to customer. Can charge premium if you solve expensive problems.'},
         competition:{title:'Competitive Pricing',content:'Price relative to competitors. Can undercut, match, or premium price based on differentiation.'},
         psychology:{title:'Price Psychology',content:'$99 vs $100 matters. Anchoring, decoy pricing, bundling all influence perceived value.'}
      };
      const choose = (idx:number) => {
         const r = rounds[round];
         const opt = r.options[idx];
         const profit = (opt.price - r.cost) * opt.demand;
         setRevenue(rev => rev + profit);
         setCustomers(c => c + opt.demand);
         setLog(l => [...l, `${r.product}: $${opt.price} x ${opt.demand} = $${profit} profit`]);
         if(round >= rounds.length - 1) setPhase('result');
         else setRound(rnd => rnd + 1);
      };
      const grade = revenue >= 50000 ? 'A' : revenue >= 35000 ? 'B' : revenue >= 20000 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-6"><div className="text-6xl mb-4">üè∑Ô∏è</div><h2 className="text-2xl font-bold mb-2">Pricing Strategy</h2><p className="text-slate-300 text-center mb-6 max-w-md">Set prices for 5 products! Balance profit margins with customer demand.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl font-bold">Start Pricing</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üí∞' : grade === 'B' ? 'üìà' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">Pricing Complete!</h2><div className="text-2xl font-bold text-yellow-400 mb-2">${revenue.toLocaleString()} Profit</div><div className="text-sm text-slate-400 mb-4">{customers} total customers</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Pricing genius!' : grade === 'B' ? 'Good margins!' : 'Left money on table!'}</p><button onClick={() => {setPhase('intro');setRound(0);setRevenue(0);setCustomers(0);setLog([]);}} className="px-6 py-2 bg-yellow-600 rounded-lg">Try Again</button></div>);
      const r = rounds[round];
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-yellow-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-yellow-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-yellow-500/30"><div className="flex justify-between items-center mb-2"><span className="font-bold">üè∑Ô∏è Pricing</span><span className="text-yellow-400">{round + 1}/{rounds.length}</span></div><div className="flex gap-4 text-sm"><span>üí∞ ${revenue.toLocaleString()}</span><span>üë• {customers}</span></div></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-3"><p className="font-bold text-lg">{r.product}</p><p className="text-sm text-slate-400">Your cost: ${r.cost} | Competitors: ${r.competitors.join(', $')}</p></div><div className="grid gap-2">{r.options.map((opt, i) => (<button key={i} onClick={() => choose(i)} className="p-3 bg-black/30 hover:bg-yellow-600/50 rounded-lg text-left"><div className="flex justify-between"><span className="font-bold">${opt.price}</span><span className="text-sm text-slate-400">~{opt.demand} customers</span></div><div className="text-xs text-slate-500">Profit: ${(opt.price - r.cost) * opt.demand}</div></button>))}</div></div><div className="p-3 bg-black/30 border-t border-yellow-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-yellow-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const BudgetingRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [month, setMonth] = useState(1);
      const [cash, setCash] = useState(50000);
      const [revenue] = useState(20000);
      const [allocations, setAllocations] = useState<{[k:string]:number}>({});
      const [log, setLog] = useState<string[]>([]);
      const categories = [
         {id:'payroll',name:'Payroll',icon:'üë•',min:8000,max:15000,impact:'team'},
         {id:'marketing',name:'Marketing',icon:'üì¢',min:0,max:8000,impact:'growth'},
         {id:'operations',name:'Operations',icon:'‚öôÔ∏è',min:2000,max:5000,impact:'stability'},
         {id:'rnd',name:'R&D',icon:'üî¨',min:0,max:6000,impact:'product'},
         {id:'emergency',name:'Emergency Fund',icon:'üõ°Ô∏è',min:0,max:5000,impact:'safety'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         runway:{title:'Cash Runway',content:'Months of operation before running out of cash. Runway = Cash / Monthly Burn. Always know your runway.'},
         burn:{title:'Burn Rate',content:'How much cash you spend per month. Gross burn = total spending. Net burn = spending - revenue.'},
         zero:{title:'Zero-Based Budgeting',content:'Start from zero each period, justify every expense. Prevents bloat but takes more time.'},
         forecast:{title:'Forecasting',content:'Project future revenue and expenses. Be conservative on revenue, generous on expenses.'}
      };
      const [budgetSet, setBudgetSet] = useState(false);
      const setBudget = (id:string, val:number) => {
         setAllocations(a => ({...a, [id]: val}));
      };
      const totalAllocated = Object.values(allocations).reduce((a,b) => a + b, 0);
      const confirmBudget = () => {
         if(totalAllocated > revenue) return;
         setBudgetSet(true);
         const saved = revenue - totalAllocated;
         setCash(c => c + saved);
         setLog(l => [...l, `Month ${month}: Allocated $${totalAllocated}, Saved $${saved}`]);
      };
      const nextMonth = () => {
         if(month >= 6) setPhase('result');
         else { setMonth(m => m + 1); setAllocations({}); setBudgetSet(false); }
      };
      const grade = cash >= 80000 ? 'A' : cash >= 60000 ? 'B' : cash >= 40000 ? 'C' : 'D';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">üìã</div><h2 className="text-2xl font-bold mb-2">Startup Budgeting</h2><p className="text-slate-300 text-center mb-6 max-w-md">Manage your startup budget for 6 months! Allocate $20k monthly revenue across categories.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-violet-500 to-indigo-500 rounded-xl font-bold">Start Budgeting</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üìà' : 'üìä'}</div><h2 className="text-2xl font-bold mb-2">6 Months Complete!</h2><div className="text-2xl font-bold text-violet-400 mb-2">${cash.toLocaleString()} Cash</div><div className="text-sm text-slate-400 mb-4">Started: $50,000</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Financial wizard!' : grade === 'B' ? 'Good management!' : 'Watch the burn!'}</p><button onClick={() => {setPhase('intro');setMonth(1);setCash(50000);setAllocations({});setBudgetSet(false);setLog([]);}} className="px-6 py-2 bg-violet-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-indigo-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-violet-500/30"><div className="flex justify-between items-center mb-2"><span className="font-bold">üìã Budget</span><span className="text-violet-400">Month {month}/6</span></div><div className="flex gap-4 text-sm"><span>üíµ Cash: ${cash.toLocaleString()}</span><span>üìà Revenue: ${revenue.toLocaleString()}</span></div></div><div className="flex-1 p-3 overflow-auto">{!budgetSet ? (<div className="space-y-3">{categories.map(cat => (<div key={cat.id} className="bg-black/30 rounded-lg p-3"><div className="flex justify-between mb-2"><span>{cat.icon} {cat.name}</span><span className="text-violet-400">${allocations[cat.id] || 0}</span></div><input type="range" min={cat.min} max={cat.max} step={500} value={allocations[cat.id] || cat.min} onChange={e => setBudget(cat.id, Number(e.target.value))} className="w-full" /></div>))}<div className={`text-center p-2 rounded ${totalAllocated > revenue ? 'bg-red-600/50' : 'bg-green-600/50'}`}>{totalAllocated > revenue ? `Over budget by $${totalAllocated - revenue}` : `$${revenue - totalAllocated} unallocated (savings)`}</div></div>) : (<div className="text-center p-4"><p className="text-xl mb-4">Budget set for Month {month}</p><p className="text-slate-400">Allocated: ${totalAllocated}</p><p className="text-green-400">Saved: ${revenue - totalAllocated}</p></div>)}</div><div className="p-3 bg-black/30 border-t border-violet-500/30">{!budgetSet ? (<button onClick={confirmBudget} disabled={totalAllocated > revenue} className="w-full py-3 bg-violet-600 rounded-xl font-bold disabled:opacity-50">Confirm Budget</button>) : (<button onClick={nextMonth} className="w-full py-3 bg-violet-600 rounded-xl font-bold">{month >= 6 ? 'See Results' : 'Next Month'}</button>)}<div className="flex gap-2 mt-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-violet-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div></div>);
   };

   // --- STRATEGY & GROWTH RENDERERS ---
   const MarketResearchRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [question, setQuestion] = useState(0);
      const [score, setScore] = useState(0);
      const [answered, setAnswered] = useState(false);
      const [selected, setSelected] = useState<number|null>(null);
      const [log, setLog] = useState<string[]>([]);
      const questions = [
         {q:'TAM is $10B, SAM is $1B, SOM is $100M. What does SOM represent?',opts:['Total market globally','Market you can serve','Market you can realistically capture','Your current revenue'],correct:2,explain:'SOM (Serviceable Obtainable Market) is the realistic portion you can capture given resources and competition.'},
         {q:'Which research method gives qualitative insights but is hard to scale?',opts:['Surveys','Customer interviews','A/B testing','Analytics'],correct:1,explain:'Interviews provide deep insights into motivations and pain points but are time-intensive to conduct.'},
         {q:'Your survey has 1000 responses with 60% saying they would buy. How many will actually buy?',opts:['600','300','60','Unknown without more data'],correct:2,explain:'Rule of thumb: divide stated intent by 10. People overstate purchase intent. 60% stated = ~6% actual.'},
         {q:'What is a "Jobs to be Done" framework used for?',opts:['HR hiring','Understanding why customers buy','Task management','Market sizing'],correct:1,explain:'JTBD focuses on the underlying job/goal customers are trying to accomplish, not product features.'},
         {q:'Which metric best validates product-market fit?',opts:['Website traffic','Social media followers','40%+ would be very disappointed without product','Investor interest'],correct:2,explain:'Sean Ellis test: if 40%+ of users would be "very disappointed" without your product, you have PMF.'},
         {q:'Primary research is data you collect yourself. What is secondary research?',opts:['Less important research','Research using existing data/reports','Research done second','Backup research'],correct:1,explain:'Secondary research uses existing sources: industry reports, census data, competitor filings, etc.'}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         tam:{title:'TAM/SAM/SOM',content:'TAM = Total market. SAM = Serviceable (you could reach). SOM = Obtainable (you can realistically get). Investors want big TAM, realistic SOM.'},
         methods:{title:'Research Methods',content:'Surveys (quantitative), Interviews (qualitative), Focus groups, Observation, Analytics. Mix methods for best insights.'},
         validation:{title:'Validation',content:'Talk to 50+ potential customers before building. Ask about problems, not solutions. "Would you buy?" means little.'},
         pmf:{title:'Product-Market Fit',content:'When customers desperately want your product. Signs: organic growth, low churn, word of mouth, pull not push.'}
      };
      const answer = (idx:number) => {
         if(answered) return;
         setSelected(idx);
         setAnswered(true);
         if(idx === questions[question].correct) {
            setScore(s => s + 1);
            setLog(l => [...l, `Q${question+1}: Correct!`]);
         } else {
            setLog(l => [...l, `Q${question+1}: Wrong`]);
         }
      };
      const next = () => {
         if(question >= questions.length - 1) setPhase('result');
         else { setQuestion(q => q + 1); setAnswered(false); setSelected(null); }
      };
      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 2 ? 'C' : 'D';
      const q = questions[question];
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white p-6"><div className="text-6xl mb-4">üî¨</div><h2 className="text-2xl font-bold mb-2">Market Research</h2><p className="text-slate-300 text-center mb-6 max-w-md">Master market research! Learn TAM/SAM/SOM, validation methods, and product-market fit.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-teal-500 to-emerald-500 rounded-xl font-bold">Start Learning</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white p-6"><div className="text-6xl mb-4">{grade === 'A' ? 'üî¨' : grade === 'B' ? 'üìä' : 'üìã'}</div><h2 className="text-2xl font-bold mb-2">Research Complete!</h2><div className="text-4xl font-bold text-teal-400 mb-2">{score}/{questions.length}</div><div className="text-6xl mb-4">{grade}</div><p className="text-slate-400 mb-4">{grade === 'A' ? 'Research expert!' : grade === 'B' ? 'Good foundation!' : 'Keep learning!'}</p><button onClick={() => {setPhase('intro');setQuestion(0);setScore(0);setAnswered(false);setSelected(null);setLog([]);}} className="px-6 py-2 bg-teal-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-teal-900 via-emerald-900 to-green-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-teal-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-teal-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-teal-500/30 flex justify-between items-center"><span className="font-bold">üî¨ Market Research</span><span className="text-teal-400">{question + 1}/{questions.length}</span><span className="text-emerald-400">Score: {score}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-sm">{q.q}</p></div><div className="grid gap-2">{q.opts.map((opt, i) => (<button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm ${answered ? i === q.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30' : 'bg-black/30 hover:bg-teal-600/50'}`}>{opt}</button>))}</div>{answered && (<div className="mt-3 p-3 bg-black/30 rounded-lg"><p className="text-sm text-slate-300">{q.explain}</p><button onClick={next} className="mt-3 w-full py-2 bg-teal-600 rounded-lg">{question >= questions.length - 1 ? 'See Results' : 'Next'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-teal-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-teal-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const CompetitiveAnalysisRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Strategic Competitive Analysis - Deep understanding of when to attack, when to defend, when to flee
      const scenarios = [
         {
            title: "The Incumbent's Dilemma",
            context: "You're a streaming startup in 2010. Netflix dominates DVD-by-mail with 20M subscribers, massive distribution infrastructure, and first-mover advantage. But they're starting to experiment with streaming. You have better streaming tech.",
            question: "What's the WORST strategic move you could make?",
            opts: [
               'Wait for Netflix to fully commit to streaming, then attack DVD market',
               'Race Netflix to streaming, trying to beat them on technology',
               'Target a niche Netflix ignores (anime, international films)',
               'Partner with studios Netflix has alienated'
            ],
            correct: 0,
            wrongExplanations: [
               "", // Correct - this is the worst move
               "Racing on tech is risky but not the worst. At least you're moving toward the future. Netflix's tech advantage was beatable - Hulu and Amazon proved that.",
               "Niche targeting is actually smart strategy. Crunchyroll built a billion-dollar business in anime that Netflix ignored for years.",
               "Studio partnerships are viable. Netflix burned bridges early. Amazon and Apple leveraged this to get exclusive deals."
            ],
            realWorld: "Blockbuster made this exact mistake - waiting for Netflix to commit to streaming while clinging to physical stores. By the time they reacted, Netflix had insurmountable scale. The DVD market died faster than anyone predicted.",
            concept: "disruption_timing",
            why: "Clayton Christensen's Innovator's Dilemma: Incumbents are trapped serving current customers with current business models. Attacking their LEGACY business gives them time to transition. Instead, attack where they're GOING - that forces them to fight on two fronts. Netflix was vulnerable during transition, not after."
         },
         {
            title: "The Moat Mirage",
            context: "You're analyzing a competitor with: 50% market share, strong brand recognition, patents expiring in 2 years, and enterprise customers locked into 5-year contracts. Investors call them 'unassailable.'",
            question: "Which 'moat' is actually weakest?",
            opts: [
               'Market share - 50% means half the market is available',
               'Brand recognition - brands can be displaced by category change',
               'Patents - 2 years is enough time to prepare your attack',
               'Customer contracts - switching costs protect them'
            ],
            correct: 1,
            wrongExplanations: [
               "50% market share is genuinely concerning - network effects may apply, and the other 50% may be fragmented low-value segments. Market share CAN be a real moat.",
               "", // Correct
               "Patents expiring in 2 years is actually actionable - you can plan product launches around that timeline. This is more predictable than you'd think.",
               "5-year contracts are real protection. Enterprises hate switching. This gives them time to respond to any threat."
            ],
            realWorld: "BlackBerry had dominant brand recognition in smartphones. But Apple didn't compete on 'business phones' - they created 'personal computers in your pocket.' Brand moats collapse when category definitions change. Nokia, Kodak, and Yahoo all had 'strong brands.'",
            concept: "moat_analysis",
            why: "Brands feel permanent but they're tied to CATEGORIES. When Tesla entered cars, BMW's brand didn't help because Tesla redefined the category as 'technology' not 'German engineering.' Always ask: 'What category does their brand own, and can I create a new category?'"
         },
         {
            title: "The Copycat Paradox",
            context: "You've built a successful SaaS product. A well-funded competitor launches a near-perfect copy at 50% of your price. They're burning cash to grab share. Your customers are nervous. Your board wants you to respond.",
            question: "What's the strategically CORRECT response?",
            opts: [
               'Match their price - you can\'t lose customers',
               'Sue for IP infringement',
               'Double-down on innovation and customer success',
               'Raise prices on your most valuable features'
            ],
            correct: 3,
            wrongExplanations: [
               "Price matching is what they WANT you to do. It validates their strategy and destroys your margins. You're playing their game on their terms. This is a trap.",
               "Lawsuits take years and rarely work. Meanwhile they're eating your market. Even if you win, you've distracted your team and spent millions. Patents rarely cover business models.",
               "Doubling down on innovation sounds right but is a slow response. While you're 'innovating,' price-sensitive customers are leaving. You need to segment NOW.",
               "" // Correct
            ],
            realWorld: "When low-cost airlines attacked legacy carriers, successful airlines like Emirates RAISED prices and improved first-class. They ceded price-sensitive segments and doubled down on premium. Trying to serve everyone serves no one.",
            concept: "price_response",
            why: "Price wars destroy industries - everyone loses. Instead, SEGMENT: Let them take price-sensitive customers (often your worst customers anyway). Raise prices for premium buyers who value your differentiation. Slack did this when Microsoft Teams launched free - they went upmarket to enterprise."
         },
         {
            title: "The Partnership Trap",
            context: "A larger competitor offers to 'partner' with you. They'll give you access to their sales channel (10x your reach) and distribution network. In return, they want API access to your core technology and co-branding rights. Your board is excited.",
            question: "What's the hidden danger in this partnership?",
            opts: [
               'They\'ll steal your technology through the API',
               'They\'re learning your playbook to build a competitor',
               'Co-branding will dilute your brand value',
               'All of the above - this is a classic acquisition play'
            ],
            correct: 3,
            wrongExplanations: [
               "API access is ONE risk, but it's not the only one. Even with contractual protections, they gain strategic intelligence.",
               "Learning your playbook is ONE risk. But the pattern is bigger - they're gathering intel for build vs buy decisions.",
               "Brand dilution is ONE risk. But when customers associate you with them, you become a feature, not a product.",
               "" // Correct
            ],
            realWorld: "Microsoft's 1997 'partnership' with Apple included a $150M investment. But it also meant Microsoft got Apple to drop IE lawsuit and make Office for Mac, learning Apple's direction. Amazon 'partnered' with many marketplace sellers before launching Amazon Basics versions of their best products.",
            concept: "partnership_dynamics",
            why: "Large companies don't partner with small ones out of kindness. They're either: 1) Evaluating you for acquisition (due diligence disguised as partnership), 2) Keeping you close while they build competitive features, or 3) Preventing you from partnering with their real competitors. 'Keep your friends close and enemies closer' is their strategy."
         },
         {
            title: "The Data Advantage",
            context: "You're competing against Google in a new market. They have 10 years of user data, AI/ML expertise, and infinite resources. Your product is better designed but you have 1/1000th of their data. VCs ask how you'll win.",
            question: "What's the MOST credible competitive strategy?",
            opts: [
               'Build better AI/ML algorithms that need less data',
               'Focus on privacy as a differentiator against their data practices',
               'Create a proprietary data source they cannot access or replicate',
               'Partner with other companies who also fear Google'
            ],
            correct: 2,
            wrongExplanations: [
               "Better algorithms rarely overcome massive data disadvantages. Google has the best AI researchers in the world. You won't out-algorithm them - they'll copy any innovation in months.",
               "Privacy as a differentiator worked for Apple (bundled with hardware) and DuckDuckGo (search is simple). But for complex products, most users still choose features over privacy. This is niche, not winning.",
               "", // Correct
               "Anti-Google coalitions look good on paper but rarely execute. Each partner has different priorities. Microsoft, Apple, and others have tried this - coordination is nearly impossible."
            ],
            realWorld: "LinkedIn's data moat wasn't AI - it was the professional graph no one else had. Waze beat Google Maps initially by crowdsourcing real-time traffic data Google couldn't access. Spotify's advantage isn't algorithm - it's 600M+ user-generated playlists creating unique data.",
            concept: "data_moats",
            why: "Data advantages come from UNIQUE sources, not more of the same. Google has more web data, but they don't have: your customer's proprietary data, community-generated content, real-time IoT feeds from your devices, or domain-specific signals from your vertical. Find data THEY CAN'T GET."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         disruption_timing: "Disruption & Timing Strategy",
         moat_analysis: "Competitive Moat Evaluation",
         price_response: "Pricing Strategy & Segmentation",
         partnership_dynamics: "Strategic Partnerships",
         data_moats: "Data Competitive Advantage"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         porter: {
            title: "Porter's 5 Forces",
            content: "Michael Porter's framework: 1) Supplier Power - can they raise prices? 2) Buyer Power - can customers demand discounts? 3) Competitive Rivalry - how intense is competition? 4) Threat of Substitution - can customers use alternatives? 5) Threat of New Entry - how easy to enter your market? High forces = low profitability. Analyze all 5 before entering any market."
         },
         moats: {
            title: "Competitive Moats",
            content: "Warren Buffett's concept: sustainable advantages that protect profits. 7 types: 1) Network effects (Facebook, Uber) 2) Switching costs (Salesforce, SAP) 3) Brand (Apple, Coca-Cola) 4) Scale economics (Walmart, Amazon) 5) Counter-positioning (Southwest vs legacy airlines) 6) Patents/IP (Pharma, Qualcomm) 7) Process power (Toyota Production System). Most moats are WEAKER than founders think."
         },
         disruption: {
            title: "Disruptive Innovation",
            content: "Clayton Christensen's theory: Startups win by targeting overlooked segments with 'worse' products that improve over time. Incumbents can't respond because serving their best customers is more profitable than fighting for marginal ones. Classic examples: Steel mini-mills vs integrated mills, PCs vs mainframes, Netflix vs Blockbuster. Disruption happens from BELOW."
         },
         asymmetry: {
            title: "Asymmetric Competition",
            content: "When you're small, fight asymmetrically: 1) Speed - decide in days what takes them months, 2) Focus - do one thing better vs their 100 things, 3) Risk tolerance - bet on unproven approaches, 4) Customer intimacy - know 100 customers deeply vs 1M superficially, 5) Talent density - your 10 people are better than their 10,000's average. Don't fight symmetric wars you can't win."
         }
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Correct! Demonstrated ${conceptLabels[s.concept]}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó ${s.title}: Missed. The trap was "${s.opts[idx]}"`]);
            if (!conceptGaps.includes(s.concept)) {
               setConceptGaps(prev => [...prev, s.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setAnswered(false);
            setSelected(null);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-red-900 via-rose-900 to-pink-900 text-white p-6">
               <div className="text-6xl mb-4">‚öîÔ∏è</div>
               <h2 className="text-2xl font-bold mb-2">Competitive Strategy Lab</h2>
               <p className="text-slate-300 text-center mb-4 max-w-md">
                  Master the strategic thinking that separates winning startups from failed ones.
               </p>
               <div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm">
                  <p className="text-red-400 font-bold mb-2">‚ö†Ô∏è Warning: These aren't simple answers</p>
                  <ul className="text-slate-300 space-y-1 text-xs">
                     <li>‚Ä¢ Real competitive strategy requires nuanced thinking</li>
                     <li>‚Ä¢ Every option will seem reasonable - only one is correct</li>
                     <li>‚Ä¢ You'll learn from real case studies: Netflix, Apple, Google</li>
                     <li>‚Ä¢ Wrong answers reveal common strategic mistakes</li>
                  </ul>
               </div>
               <button
                  onClick={() => setPhase('play')}
                  className="px-8 py-3 bg-gradient-to-r from-red-500 to-rose-500 rounded-xl font-bold hover:from-red-400 hover:to-rose-400 transition-all"
               >
                  Begin Strategy Analysis
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-red-900 via-rose-900 to-pink-900 text-white p-6 overflow-auto">
               <div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? '‚öîÔ∏è' : grade === 'C' ? 'üìä' : 'üìö'}</div>
               <h2 className="text-2xl font-bold mb-2">Strategy Assessment Complete</h2>
               <div className="text-4xl font-bold text-red-400 mb-2">{score}/{scenarios.length}</div>
               <div className="text-5xl mb-4">{grade}</div>
               <p className="text-slate-400 mb-4 text-center">
                  {grade === 'A' ? 'Strategic mastermind! You think like a seasoned strategist.' :
                   grade === 'B' ? 'Strong strategic intuition. Minor blind spots to address.' :
                   grade === 'C' ? 'Good foundation, but falling for common strategic traps.' :
                   'Competitive strategy requires study. Many dangerous misconceptions.'}
               </p>

               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4">
                     <p className="text-red-400 font-bold text-sm mb-2">üìö Concepts to Study:</p>
                     <ul className="text-slate-300 text-xs space-y-1">
                        {conceptGaps.map(gap => (
                           <li key={gap}>‚Ä¢ {conceptLabels[gap]}</li>
                        ))}
                     </ul>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">
                  <p className="text-red-400 font-bold text-sm mb-2">Session Log:</p>
                  {gameLog.map((entry, i) => (
                     <p key={i} className="text-xs text-slate-300">{entry}</p>
                  ))}
               </div>

               <button
                  onClick={() => {
                     setPhase('intro');
                     setScenario(0);
                     setScore(0);
                     setAnswered(false);
                     setSelected(null);
                     setGameLog([]);
                     setConceptGaps([]);
                  }}
                  className="px-6 py-2 bg-red-600 rounded-lg hover:bg-red-500"
               >
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-red-900 via-rose-900 to-pink-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-red-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-red-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-red-500/30 flex justify-between items-center">
               <span className="font-bold">‚öîÔ∏è Strategy Lab</span>
               <span className="text-red-400">{scenario + 1}/{scenarios.length}</span>
               <span className="text-rose-400">Score: {score}</span>
            </div>

            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-xl p-3 mb-3">
                  <p className="font-bold text-red-400 mb-2">{s.title}</p>
                  <p className="text-sm text-slate-300">{s.context}</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-3">
                  <p className="font-medium text-white">{s.question}</p>
               </div>

               <div className="grid gap-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600'
                                 : i === selected
                                    ? 'bg-red-600'
                                    : 'bg-black/30'
                              : 'bg-black/30 hover:bg-red-600/50'
                        }`}
                     >
                        {opt}
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-3">
                     {selected !== s.correct && s.wrongExplanations[selected!] && (
                        <div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30">
                           <p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Was Wrong:</p>
                           <p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30">
                        <p className="text-xs text-green-300 font-bold mb-1">‚úì Strategic Insight:</p>
                        <p className="text-sm text-green-100">{s.why}</p>
                     </div>
                     <div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30">
                        <p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p>
                        <p className="text-sm text-blue-100">{s.realWorld}</p>
                     </div>
                     <button
                        onClick={next}
                        className="w-full py-2 bg-red-600 rounded-lg hover:bg-red-500"
                     >
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-red-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button
                     key={k}
                     onClick={() => { setInfoTopic(k); setShowInfo(true); }}
                     className="text-xs text-red-400 hover:text-red-300"
                  >
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   const BusinessModelRenderer = () => {
      const [phase, setPhase] = useState<'intro'|'play'|'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string|null>(null);
      const [step, setStep] = useState(0);
      const [model, setModel] = useState<{[k:string]:string}>({});
      const [log, setLog] = useState<string[]>([]);
      const steps = [
         {element:'Customer Segments',question:'Who are your customers?',options:['Mass market (everyone)','Niche market (specific segment)','Multi-sided platform (2+ groups)','Diversified (unrelated segments)']},
         {element:'Value Proposition',question:'What value do you deliver?',options:['Newness (innovation)','Performance (better/faster)','Convenience (easier access)','Price (cheaper alternative)']},
         {element:'Revenue Streams',question:'How do you make money?',options:['One-time sales','Subscription recurring','Freemium + premium','Transaction fees/commission']},
         {element:'Channels',question:'How do you reach customers?',options:['Direct sales team','Online/digital only','Partner distribution','Retail/physical stores']},
         {element:'Key Resources',question:'What is your key asset?',options:['Technology/IP','Human expertise','Brand/community','Physical assets']}
      ];
      const infoTopics:{[k:string]:{title:string,content:string}} = {
         canvas:{title:'Business Model Canvas',content:'9 blocks: Customer Segments, Value Prop, Channels, Customer Relationships, Revenue, Key Resources, Activities, Partners, Costs.'},
         revenue:{title:'Revenue Models',content:'Subscription, Freemium, Marketplace, Advertising, Licensing, Transaction fees. Match model to value delivery.'},
         lean:{title:'Lean Canvas',content:'Startup-focused version: Problem, Solution, Key Metrics, Unique Value Prop, Unfair Advantage, Channels, Segments, Costs, Revenue.'},
         fit:{title:'Model-Market Fit',content:'Your business model must match how customers want to buy. B2B enterprise ‚â† B2C consumer.'}
      };
      const choose = (idx:number) => {
         setModel(m => ({...m, [steps[step].element]: steps[step].options[idx]}));
         setLog(l => [...l, `${steps[step].element}: ${steps[step].options[idx]}`]);
         if(step >= steps.length - 1) setPhase('result');
         else setStep(s => s + 1);
      };
      const modelType = model['Revenue Streams']?.includes('Subscription') ? 'SaaS' : model['Revenue Streams']?.includes('commission') ? 'Marketplace' : model['Revenue Streams']?.includes('Freemium') ? 'Freemium' : 'Traditional';
      if(phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">üèóÔ∏è</div><h2 className="text-2xl font-bold mb-2">Business Model Builder</h2><p className="text-slate-300 text-center mb-6 max-w-md">Design your business model! Choose elements that define how you create and capture value.</p><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl font-bold">Start Building</button></div>);
      if(phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white p-6"><div className="text-6xl mb-4">üèóÔ∏è</div><h2 className="text-2xl font-bold mb-2">Model Complete!</h2><div className="text-xl font-bold text-purple-400 mb-4">{modelType} Business Model</div><div className="bg-black/30 rounded-xl p-4 mb-4 text-left max-w-sm w-full">{Object.entries(model).map(([k,v]) => (<div key={k} className="mb-2"><span className="text-purple-400 text-xs">{k}:</span><p className="text-sm">{v}</p></div>))}</div><button onClick={() => {setPhase('intro');setStep(0);setModel({});setLog([]);}} className="px-6 py-2 bg-purple-600 rounded-lg">Build Another</button></div>);
      const s = steps[step];
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-purple-900 via-violet-900 to-indigo-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-purple-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-purple-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-purple-500/30 flex justify-between items-center"><span className="font-bold">üèóÔ∏è Business Model</span><span className="text-purple-400">{step + 1}/{steps.length}</span></div><div className="flex-1 p-4 flex flex-col justify-center"><div className="bg-black/30 rounded-xl p-4 mb-4"><p className="text-purple-400 text-sm mb-1">{s.element}</p><p className="text-lg font-medium">{s.question}</p></div><div className="grid gap-2">{s.options.map((opt, i) => (<button key={i} onClick={() => choose(i)} className="p-3 bg-black/30 hover:bg-purple-600/50 rounded-lg text-left text-sm">{opt}</button>))}</div></div><div className="p-3 bg-black/30 border-t border-purple-500/30 flex gap-2 justify-center">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-purple-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   const GrowthStrategyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Growth Channel Mastery - Understanding which channels work for which businesses and why
      const scenarios = [
         {
            title: "The Viral Illusion",
            context: "You're building a B2B project management tool. Your team is excited about adding viral features: 'Invite teammates to earn premium features!' and social sharing. A competitor without viral features is growing faster through content marketing.",
            question: "Why is viral growth WRONG for this product?",
            opts: [
               'Viral features are never effective for B2B',
               'The buying decision isn\'t made by individual users who benefit from inviting',
               'Project management is too boring to go viral',
               'Content marketing is always better than viral'
            ],
            correct: 1,
            wrongExplanations: [
               "Viral CAN work for B2B - Slack, Notion, and Figma all grew virally. But the incentive structure must match the buyer's motivation.",
               "", // Correct
               "Boring doesn't prevent virality. Dropbox (file storage) and Zoom (video calls) grew virally with 'boring' products. The key is incentive alignment.",
               "Content marketing isn't universally better. It depends on the product and audience. The issue here is incentive mismatch."
            ],
            realWorld: "Slack grew virally because individual team members WANTED to use it and could convince their team. Compare to enterprise software where procurement decides - viral incentives for end-users don't influence purchasing. Know your buyer.",
            concept: "viral_incentive_alignment",
            why: "Viral growth requires: 1) Users personally benefit from inviting others, 2) Users have autonomy to invite, 3) The product improves with more users. B2B project management fails #2 - the person who would invite doesn't make the buying decision. Their CTO/procurement does. Incentives are misaligned."
         },
         {
            title: "The Paid Acquisition Trap",
            context: "Your e-commerce startup has $100 LTV. You're spending on Facebook ads with $50 CAC (2x LTV:CAC ratio). Your CFO says 'We're profitable! Let's 10x ad spend.' But when you scale from $10K to $100K monthly, CAC rises to $80 and LTV drops to $90.",
            question: "What caused this performance collapse?",
            opts: [
               'Facebook ads just don\'t work at scale',
               'You exhausted your best audience and now reach lower-intent users',
               'Your competitors started outbidding you',
               'The algorithm broke'
            ],
            correct: 1,
            wrongExplanations: [
               "Facebook ads work at massive scale for many companies. The issue isn't the platform - it's the audience targeting strategy.",
               "", // Correct
               "Competition affects costs, but a 60% CAC increase while spending 10x more suggests audience quality decline, not just competition.",
               "Algorithms don't 'break.' Performance changes reflect real dynamics in targeting, audience saturation, and ad fatigue."
            ],
            realWorld: "Every paid channel has a 'best audience' - the 1% who are perfect fits. As you scale, you reach the 5%, then 20%, then 50%. Each tier converts worse. Uber solved this by launching city-by-city, dominating the best audience before expanding.",
            concept: "audience_saturation",
            why: "Paid channels have natural limits. Your first $10K finds ideal customers actively searching. Your next $100K reaches people who might want your product. Your next $1M reaches everyone. Each layer converts worse and churns faster. Scale by adding NEW high-intent channels, not by forcing more through saturated ones."
         },
         {
            title: "The Content Paradox",
            context: "You publish 10 blog posts/month. Traffic is growing 20% quarterly. But despite 50K monthly visitors, only 50 become customers (0.1% conversion). Your competitor publishes 2 posts/month but converts 2% of visitors.",
            question: "What's the strategic difference between you and your competitor?",
            opts: [
               'They have better SEO and rank higher',
               'They\'re writing for buyers while you\'re writing for browsers',
               'They just have a better product',
               'Conversion rate is less important than total traffic'
            ],
            correct: 1,
            wrongExplanations: [
               "Ranking doesn't determine conversion rate. You could rank #1 for the wrong keywords and still convert poorly.",
               "", // Correct
               "Product quality affects conversion, but a 20x difference (0.1% vs 2%) is too large to be product alone. Content strategy matters.",
               "Conversion rate is critical. 50K √ó 0.1% = 50 customers. 5K √ó 2% = 100 customers. They get 2x customers with 10% of your traffic."
            ],
            realWorld: "HubSpot's early content targeted 'inbound marketing' - a term they invented. Every reader was a potential buyer. Compare to companies blogging about industry news - high traffic, low intent. Shopify blogs about 'how to start a business' - readers who need their product.",
            concept: "content_intent_matching",
            why: "Traffic is vanity, conversions are sanity. High-volume, low-intent content (industry news, entertainment) attracts browsers. High-intent content (how to solve the problem your product solves) attracts buyers. 2 posts targeting buyers beat 10 posts targeting browsers."
         },
         {
            title: "The Sales Scaling Myth",
            context: "Your enterprise SaaS closes $200K deals with a 6-month sales cycle. One rep closes 10 deals/year ($2M). You hire 5 more reps expecting $10M additional revenue. After 12 months, the 5 new reps combined closed only 8 deals ($1.6M).",
            question: "What's the MOST LIKELY cause of this failure?",
            opts: [
               'The new reps were less talented',
               'The market became more competitive',
               'You didn\'t have enough pipeline/leads for 6 reps',
               'Enterprise sales can\'t scale'
            ],
            correct: 2,
            wrongExplanations: [
               "Rep talent varies, but 5 average reps should still close more than 8 deals combined. The failure is too systematic to be talent alone.",
               "Competition affects everyone, including your star rep. If competition was the cause, your original rep would have declined too.",
               "", // Correct
               "Enterprise sales scales very well - Salesforce, Oracle, and SAP prove this. The constraint is usually pipeline, not the model."
            ],
            realWorld: "Salesforce learned this early: before adding sales reps, they invested heavily in marketing/SDR teams to generate pipeline. The rule of thumb: each enterprise rep needs 3-4x their quota in qualified pipeline. You hired reps without the leads to feed them.",
            concept: "sales_pipeline_math",
            why: "Sales scaling fails when you hire closers without leads. Pipeline math: if each rep needs $800K pipeline to close $200K (25% close rate), 6 reps need $4.8M pipeline. If you only generated $2M in pipeline, reps fight over the same deals. Solution: scale marketing/SDR BEFORE hiring more closers."
         },
         {
            title: "The Community Confusion",
            context: "You're building a developer tool. Everyone says 'build community!' You launch a Discord with 2,000 members. Activity is high - lots of memes, off-topic chat, and support questions. But few are buying your product.",
            question: "What's wrong with this community strategy?",
            opts: [
               'Discord is the wrong platform for developers',
               'Communities take years to generate revenue',
               'The community attracts users, not buyers - wrong incentive structure',
               '2,000 members isn\'t big enough to drive sales'
            ],
            correct: 2,
            wrongExplanations: [
               "Discord works well for developers - Midjourney, Vercel, and many dev tools use it successfully. Platform isn't the issue.",
               "Well-designed communities can drive revenue quickly. Figma's community drove adoption within months. The issue is strategy, not time.",
               "", // Correct
               "Size doesn't determine revenue. 100 highly-engaged potential buyers beat 10,000 people looking for free support."
            ],
            realWorld: "Figma built a community of DESIGNERS who shared templates. Each template showcase was implicit product marketing. Compare to dev tools with 'support communities' - members come for free help, not to buy. Notion built a community of POWER USERS who became evangelists.",
            concept: "community_purpose",
            why: "Communities fail when they attract free-seekers instead of potential buyers. The fix: build community around OUTCOMES your product enables, not around the product itself. A 'design inspiration' community attracts designers who might buy Figma. A 'Figma support' community attracts people avoiding payment."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         viral_incentive_alignment: "Viral Growth Incentive Structures",
         audience_saturation: "Paid Acquisition & Audience Saturation",
         content_intent_matching: "Content Strategy & Buyer Intent",
         sales_pipeline_math: "Sales Scaling & Pipeline Mathematics",
         community_purpose: "Community Building for Growth"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         channels: {
            title: "Growth Channel Framework",
            content: "19 traction channels (Bullseye Framework): Viral, PR, Content, SEO, Social, Email, Partnerships, Biz Dev, Sales, Trade Shows, Speaking, Community, Ads, Affiliate, Existing Platforms, Offline, Engineering as Marketing, Guerrilla, Trade Publications. Test 3, focus on 1."
         },
         loops: {
            title: "Growth Loops",
            content: "Sustainable growth comes from LOOPS, not funnels. Viral loop: User invites ‚Üí new users invite. Content loop: Content ranks ‚Üí users create content. Paid loop: Revenue ‚Üí reinvest in ads ‚Üí more revenue. Sales loop: Customer success ‚Üí referrals ‚Üí new sales. Identify which loop fits your model."
         },
         metrics: {
            title: "Growth Metrics That Matter",
            content: "CAC (Customer Acquisition Cost), LTV (Lifetime Value), LTV:CAC ratio (aim for 3:1+), Payback period (months to recover CAC), Viral coefficient (users acquired per user), Magic number (net new ARR / prior quarter S&M spend). Track the metric that matters for YOUR stage."
         },
         stages: {
            title: "Growth Stage Matching",
            content: "Pre-PMF: Do things that don't scale, find channels that work. Early growth: Double down on 1-2 channels. Scaling: Add channels while maintaining efficiency. Each stage has different optimal strategies. Premature scaling is the #1 startup killer."
         }
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Correct! Understood ${conceptLabels[s.concept]}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó ${s.title}: Missed. Fell for "${s.opts[idx].substring(0, 35)}..."`]);
            if (!conceptGaps.includes(s.concept)) {
               setConceptGaps(prev => [...prev, s.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setAnswered(false);
            setSelected(null);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-green-900 via-lime-900 to-emerald-900 text-white p-6">
               <div className="text-6xl mb-4">üöÄ</div>
               <h2 className="text-2xl font-bold mb-2">Growth Channel Mastery</h2>
               <p className="text-slate-300 text-center mb-4 max-w-md">
                  Learn why growth strategies fail and how to match channels to your business model.
               </p>
               <div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm">
                  <p className="text-green-400 font-bold mb-2">üéØ Common Growth Mistakes:</p>
                  <ul className="text-slate-300 space-y-1 text-xs">
                     <li>‚Ä¢ Copying strategies that worked for different business models</li>
                     <li>‚Ä¢ Scaling paid acquisition before understanding audience limits</li>
                     <li>‚Ä¢ Building community for the wrong audience</li>
                     <li>‚Ä¢ Hiring sales reps without pipeline to support them</li>
                  </ul>
               </div>
               <button
                  onClick={() => setPhase('play')}
                  className="px-8 py-3 bg-gradient-to-r from-green-500 to-lime-500 rounded-xl font-bold hover:from-green-400 hover:to-lime-400 transition-all"
               >
                  Start Growing
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-green-900 via-lime-900 to-emerald-900 text-white p-6 overflow-auto">
               <div className="text-6xl mb-4">{grade === 'A' ? 'üöÄ' : grade === 'B' ? 'üìà' : grade === 'C' ? 'üìä' : 'üìö'}</div>
               <h2 className="text-2xl font-bold mb-2">Growth Assessment Complete</h2>
               <div className="text-4xl font-bold text-green-400 mb-2">{score}/{scenarios.length}</div>
               <div className="text-5xl mb-4">{grade}</div>
               <p className="text-slate-400 mb-4 text-center">
                  {grade === 'A' ? 'Growth expert! You understand channel-product fit.' :
                   grade === 'B' ? 'Strong growth intuition. Some channel blindspots.' :
                   grade === 'C' ? 'Decent foundation, but falling for common growth myths.' :
                   'Growth strategy needs work. Study channel-product matching.'}
               </p>

               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4">
                     <p className="text-green-400 font-bold text-sm mb-2">üìö Concepts to Study:</p>
                     <ul className="text-slate-300 text-xs space-y-1">
                        {conceptGaps.map(gap => (
                           <li key={gap}>‚Ä¢ {conceptLabels[gap]}</li>
                        ))}
                     </ul>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">
                  <p className="text-green-400 font-bold text-sm mb-2">Session Log:</p>
                  {gameLog.map((entry, i) => (
                     <p key={i} className="text-xs text-slate-300">{entry}</p>
                  ))}
               </div>

               <button
                  onClick={() => {
                     setPhase('intro');
                     setScenario(0);
                     setScore(0);
                     setAnswered(false);
                     setSelected(null);
                     setGameLog([]);
                     setConceptGaps([]);
                  }}
                  className="px-6 py-2 bg-green-600 rounded-lg hover:bg-green-500"
               >
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-green-900 via-lime-900 to-emerald-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-green-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-green-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-green-500/30 flex justify-between items-center">
               <span className="font-bold">üöÄ Growth Strategy</span>
               <span className="text-green-400">{scenario + 1}/{scenarios.length}</span>
               <span className="text-lime-400">Score: {score}</span>
            </div>

            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-xl p-3 mb-3">
                  <p className="font-bold text-green-400 mb-2">{s.title}</p>
                  <p className="text-sm text-slate-300">{s.context}</p>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-3">
                  <p className="font-medium text-white">{s.question}</p>
               </div>

               <div className="grid gap-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600'
                                 : i === selected
                                    ? 'bg-red-600'
                                    : 'bg-black/30'
                              : 'bg-black/30 hover:bg-green-600/50'
                        }`}
                     >
                        {opt}
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-3">
                     {selected !== s.correct && s.wrongExplanations[selected!] && (
                        <div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30">
                           <p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Was Wrong:</p>
                           <p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30">
                        <p className="text-xs text-green-300 font-bold mb-1">‚úì Growth Insight:</p>
                        <p className="text-sm text-green-100">{s.why}</p>
                     </div>
                     <div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30">
                        <p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p>
                        <p className="text-sm text-blue-100">{s.realWorld}</p>
                     </div>
                     <button
                        onClick={next}
                        className="w-full py-2 bg-green-600 rounded-lg hover:bg-green-500"
                     >
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-green-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button
                     key={k}
                     onClick={() => { setInfoTopic(k); setShowInfo(true); }}
                     className="text-xs text-green-400 hover:text-green-300"
                  >
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   const PivotDecisionRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Startup Survival Simulator - Learning from real failure patterns
      const scenarios = [
         {
            title: "The Traction Trap",
            context: "18 months in. You've built a beautifully designed productivity app. 5,000 signups, but only 50 active weekly users (1%). You've iterated on features 12 times based on 'user feedback.' Your runway is 8 months. The team is demoralized.",
            signals: { bad: ['1% active rate', '12 iterations without improvement', 'Team demoralized'], good: ['5,000 signups', '8 months runway', 'Beautiful product'] },
            question: "What's the CORE problem you need to solve?",
            opts: [
               'Keep iterating - you haven\'t found the right feature yet',
               'You\'re solving a problem users don\'t actually have',
               'Marketing is the issue - get more signups',
               'The product needs to be rebuilt from scratch'
            ],
            correct: 1,
            wrongExplanations: [
               "12 iterations with no retention improvement is a signal: features aren't the problem. More features on a product nobody needs won't help.",
               "", // Correct
               "5,000 signups proves marketing works. 50 active users proves the product doesn't. Pouring water into a leaky bucket doesn't fill it.",
               "The product being 'beautiful' isn't the issue. The problem is product-MARKET fit, not product quality. A rebuild solves the wrong problem."
            ],
            realWorld: "Color Labs raised $41M, built beautiful photo-sharing tech, got downloads... but nobody used it. The problem they solved (photo sharing with nearby strangers) wasn't a real problem. They pivoted twice before shutting down. Lesson: validate the PROBLEM before building the solution.",
            concept: "problem_validation",
            why: "Low activation despite signups = problem-solution mismatch. Users are curious enough to try, but the product doesn't solve a real problem they have. The fix isn't more features or more marketing - it's going back to customer discovery to find a problem worth solving."
         },
         {
            title: "The Zombie Company",
            context: "Your SaaS has $30K MRR, 200 customers, 2% monthly churn, and you're profitable. But growth has flatlined for 18 months. Revenue: $30K‚Üí$31K‚Üí$30K‚Üí$32K. You've tried new features, new marketing channels, and price changes. Nothing moves the needle.",
            signals: { bad: ['18 months flat', 'No growth despite efforts', 'Market might be saturated'], good: ['Profitable', 'Low churn', 'Real customers'] },
            question: "What should you do with this business?",
            opts: [
               'Keep trying new growth tactics - something will work',
               'Raise funding to accelerate growth',
               'Accept it as a lifestyle business or seek acquisition',
               'Pivot to a completely different product'
            ],
            correct: 2,
            wrongExplanations: [
               "18 months of trying suggests you've tested most reasonable tactics. Doing the same thing expecting different results is the definition of insanity.",
               "VCs don't fund flat-growth companies. Even if you got funding, more money in a stagnant market won't create growth. You'd be diluting for nothing.",
               "", // Correct
               "You have a profitable business with happy customers. Pivoting abandons proven revenue for uncertain new ventures. That's irrational."
            ],
            realWorld: "Basecamp (37signals) deliberately stayed small and profitable rather than chasing hockey-stick growth. Many 'zombie' companies are acquired by larger players who value the customer base. Mailchimp grew slowly for years before exploding. Not every company needs to be a unicorn.",
            concept: "growth_ceiling",
            why: "Some markets have natural ceilings. You've validated the business (profitability + low churn) but may have captured most of your addressable market. Options: 1) Run as lifestyle business, 2) Sell to strategic acquirer, 3) Expand to adjacent market. Forcing growth in a saturated market wastes resources."
         },
         {
            title: "The Pivot Paradox",
            context: "You started as a B2C social app. After 2 years: 100K users, no revenue model that works. You pivot to B2B, selling analytics to brands. 6 months in: 5 paying customers ($50K ARR), strong retention, but long sales cycles. Board wants you to pivot again to 'something scalable.'",
            signals: { bad: ['B2C failed', 'Long B2B sales cycle', 'Board pressure'], good: ['$50K ARR in 6 months', 'Strong retention', 'Real revenue'] },
            question: "Should you pivot again as the board suggests?",
            opts: [
               'Yes - B2B enterprise is too slow for venture returns',
               'No - you finally have product-market fit, double down',
               'Yes - listen to your board, they have more experience',
               'No - but negotiate a smaller market to go after'
            ],
            correct: 1,
            wrongExplanations: [
               "Slow doesn't mean bad. Salesforce, Workday, and many successful companies have long sales cycles. $50K ARR in 6 months is a strong signal.",
               "", // Correct
               "Boards can be wrong. They're optimizing for fund returns, not necessarily your company. 5 paying customers with retention is rare - most startups never get here.",
               "You're not negotiating the market size, you're validating product-market fit. Focus on the signal: customers are paying and staying."
            ],
            realWorld: "Slack pivoted from a gaming company to B2B chat. Early enterprise sales were slow. If they had pivoted again instead of doubling down, we wouldn't have Slack. Instagram pivoted from Burbn and stuck with their new direction despite early doubts. One successful pivot is enough.",
            concept: "pivot_commitment",
            why: "The most dangerous time is right after a successful pivot, when you're tempted to pivot again before the new direction has time to mature. 5 customers + strong retention = signal. Give it time. Most successful startups did ONE major pivot, not many."
         },
         {
            title: "The Runway Reckoning",
            context: "You have 4 months of runway. Revenue is $15K MRR, growing 8% month-over-month. At current burn ($40K/mo), you'll die before reaching profitability. VCs are passing because you're 'too early.' You can cut to 2-person team and extend runway to 12 months.",
            signals: { bad: ['4 months runway', 'VCs passing', '$25K monthly burn'], good: ['8% MoM growth', '$15K MRR', 'Clear path visible'] },
            question: "What's the RIGHT decision for this startup?",
            opts: [
               'Keep the team and die trying - cutting kills momentum',
               'Cut aggressively, extend runway, and keep growing',
               'Pivot to something that raises easier',
               'Shut down now while you can return money to investors'
            ],
            correct: 1,
            wrongExplanations: [
               "Dead startups don't have momentum. Pride in team size over survival is a common founder mistake. Survival > team size.",
               "", // Correct
               "You have 8% MoM growth and paying customers. Pivoting away from traction to chase 'easier fundraising' abandons real validation.",
               "Shutting down a growing business with 12 months of possible runway (after cuts) is premature. Many great companies survived near-death moments."
            ],
            realWorld: "Airbnb cut to core team and survived on credit cards before Y Combinator. Tesla was days from bankruptcy multiple times. Companies that survive and win are often the ones willing to cut deep to extend runway during tough times. Survival is the only metric that matters.",
            concept: "runway_survival",
            why: "8% MoM growth means you double every 9 months. With 12 months runway (post-cuts), you could reach $30K+ MRR - much more fundable. The math: survive long enough for growth to compound. Cut everything that isn't directly driving growth or survival."
         },
         {
            title: "The Signal vs Noise",
            context: "Your dev tool has 3 customer types: Enterprises (slow to close, high ACV), SMBs (medium speed, medium ACV), and Developers (fast to close, low ACV but high volume). Last quarter: 2 enterprise deals ($50K), 10 SMB ($30K), 200 developer signups ($10K). Everyone says 'go enterprise.'",
            signals: { bad: ['Scattered focus', 'Different sales motions needed', 'Resource constraints'], good: ['Revenue from all segments', 'Developer volume', 'Enterprise interest'] },
            question: "Which segment should you focus on?",
            opts: [
               'Enterprise - highest revenue per customer',
               'SMB - balanced between volume and value',
               'Developer - highest volume, fastest feedback loops',
               'All three - diversification reduces risk'
            ],
            correct: 2,
            wrongExplanations: [
               "Enterprise has highest ACV but slowest velocity. With limited resources, 2 deals/quarter means you can't iterate fast enough to find product-market fit.",
               "SMB is a reasonable choice but 10 deals/quarter still limits learning velocity. You need faster feedback loops at this stage.",
               "", // Correct
               "Diversification at early stage = diluted focus. You can't build three different sales motions, support systems, and product experiences with a small team."
            ],
            realWorld: "Stripe focused on developers first, ignoring enterprise for years. Developers became their distribution channel - when devs joined big companies, they brought Stripe. Twilio did the same. Developer-first created pull demand that made enterprise sales easier later.",
            concept: "segment_focus",
            why: "At early stage, velocity of learning > revenue per customer. 200 developers = 200 feedback loops. 2 enterprises = 2 feedback loops. Developers compound: they become advocates, build on your platform, and pull enterprises toward you. Focus creates momentum."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         problem_validation: "Problem-Solution Fit Validation",
         growth_ceiling: "Market Size & Growth Ceilings",
         pivot_commitment: "Pivot Timing & Commitment",
         runway_survival: "Runway Management & Survival",
         segment_focus: "Customer Segment Focus"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         when: {
            title: "When to Pivot",
            content: "Pivot when: 1) Consistent low retention despite iterations, 2) Unable to find sustainable acquisition channel, 3) Market too small for your ambitions, 4) Core thesis proven wrong by data. DON'T pivot when: you have paying customers with retention, you're just impatient, or because others are doing something 'hotter.'"
         },
         types: {
            title: "Types of Pivots",
            content: "Customer segment pivot (same product, different buyer), Problem pivot (same customer, different pain), Solution pivot (same problem, different approach), Channel pivot (same product, different distribution), Revenue model pivot (same product, different monetization), Technology pivot (same outcome, different tech). Change ONE thing, not everything."
         },
         signs: {
            title: "Warning Signs to Watch",
            content: "Danger signs: Flat growth despite efforts, High churn regardless of features, Long sales cycles eating runway, Customer apathy ('nice to have' not 'must have'), Founder burnout and loss of conviction, Every growth channel fails. The absence of pull demand is the clearest signal."
         },
         persistence: {
            title: "When to Persist",
            content: "Persist when: Strong retention (users who try it, keep it), Clear word-of-mouth (users recommend without prompts), Improving metrics over time, Passionate user segment (even if small), External tailwinds coming. Many legendary companies took 3-5 years to find PMF. Patience ‚â† complacency."
         }
      };

      const answer = (idx: number) => {
         if (answered) return;
         setSelected(idx);
         setAnswered(true);
         const s = scenarios[scenario];
         if (idx === s.correct) {
            setScore(prev => prev + 1);
            setGameLog(prev => [...prev, `‚úì ${s.title}: Correct decision! Understood ${conceptLabels[s.concept]}`]);
         } else {
            setGameLog(prev => [...prev, `‚úó ${s.title}: Wrong call. Fell for "${s.opts[idx].substring(0, 30)}..."`]);
            if (!conceptGaps.includes(s.concept)) {
               setConceptGaps(prev => [...prev, s.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(prev => prev + 1);
            setAnswered(false);
            setSelected(null);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6">
               <div className="text-6xl mb-4">üîÑ</div>
               <h2 className="text-2xl font-bold mb-2">Startup Survival Simulator</h2>
               <p className="text-slate-300 text-center mb-4 max-w-md">
                  Navigate the hardest decisions founders face: pivot, persist, or shut down.
               </p>
               <div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm">
                  <p className="text-orange-400 font-bold mb-2">üíÄ Why Most Startups Fail:</p>
                  <ul className="text-slate-300 space-y-1 text-xs">
                     <li>‚Ä¢ 42% - No market need (building what nobody wants)</li>
                     <li>‚Ä¢ 29% - Ran out of cash (bad runway management)</li>
                     <li>‚Ä¢ 23% - Wrong team (co-founder issues)</li>
                     <li>‚Ä¢ 19% - Got outcompeted (wrong strategy)</li>
                  </ul>
               </div>
               <button
                  onClick={() => setPhase('play')}
                  className="px-8 py-3 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl font-bold hover:from-orange-400 hover:to-amber-400 transition-all"
               >
                  Start Making Decisions
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white p-6 overflow-auto">
               <div className="text-6xl mb-4">{grade === 'A' ? 'üéØ' : grade === 'B' ? 'üîÑ' : grade === 'C' ? '‚ö†Ô∏è' : 'üíÄ'}</div>
               <h2 className="text-2xl font-bold mb-2">Survival Assessment Complete</h2>
               <div className="text-4xl font-bold text-orange-400 mb-2">{score}/{scenarios.length}</div>
               <div className="text-5xl mb-4">{grade}</div>
               <p className="text-slate-400 mb-4 text-center">
                  {grade === 'A' ? 'Survival instincts! You make tough calls correctly.' :
                   grade === 'B' ? 'Good judgment. Some dangerous blind spots remain.' :
                   grade === 'C' ? 'Mixed results. Study the failure patterns.' :
                   'Dangerous misconceptions. Learn before betting your company.'}
               </p>

               {conceptGaps.length > 0 && (
                  <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4">
                     <p className="text-orange-400 font-bold text-sm mb-2">üìö Concepts to Study:</p>
                     <ul className="text-slate-300 text-xs space-y-1">
                        {conceptGaps.map(gap => (
                           <li key={gap}>‚Ä¢ {conceptLabels[gap]}</li>
                        ))}
                     </ul>
                  </div>
               )}

               <div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">
                  <p className="text-orange-400 font-bold text-sm mb-2">Decision Log:</p>
                  {gameLog.map((entry, i) => (
                     <p key={i} className="text-xs text-slate-300">{entry}</p>
                  ))}
               </div>

               <button
                  onClick={() => {
                     setPhase('intro');
                     setScenario(0);
                     setScore(0);
                     setAnswered(false);
                     setSelected(null);
                     setGameLog([]);
                     setConceptGaps([]);
                  }}
                  className="px-6 py-2 bg-orange-600 rounded-lg hover:bg-orange-500"
               >
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-orange-900 via-amber-900 to-yellow-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-orange-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-orange-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}

            <div className="p-3 bg-black/30 border-b border-orange-500/30 flex justify-between items-center">
               <span className="font-bold">üîÑ Survival Sim</span>
               <span className="text-orange-400">{scenario + 1}/{scenarios.length}</span>
               <span className="text-amber-400">Score: {score}</span>
            </div>

            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-xl p-3 mb-3">
                  <p className="font-bold text-orange-400 mb-2">{s.title}</p>
                  <p className="text-sm text-slate-300 mb-3">{s.context}</p>
                  <div className="grid grid-cols-2 gap-2 text-xs">
                     <div>
                        <p className="text-red-400 mb-1">üö© Warning Signs:</p>
                        {s.signals.bad.map((sig, i) => <p key={i} className="text-slate-300">‚Ä¢ {sig}</p>)}
                     </div>
                     <div>
                        <p className="text-green-400 mb-1">‚úì Positive Signs:</p>
                        {s.signals.good.map((sig, i) => <p key={i} className="text-slate-300">‚Ä¢ {sig}</p>)}
                     </div>
                  </div>
               </div>

               <div className="bg-black/30 rounded-xl p-4 mb-3">
                  <p className="font-medium text-white">{s.question}</p>
               </div>

               <div className="grid gap-2">
                  {s.opts.map((opt, i) => (
                     <button
                        key={i}
                        onClick={() => answer(i)}
                        disabled={answered}
                        className={`p-3 rounded-lg text-left text-sm transition-all ${
                           answered
                              ? i === s.correct
                                 ? 'bg-green-600'
                                 : i === selected
                                    ? 'bg-red-600'
                                    : 'bg-black/30'
                              : 'bg-black/30 hover:bg-orange-600/50'
                        }`}
                     >
                        {opt}
                     </button>
                  ))}
               </div>

               {answered && (
                  <div className="mt-3 space-y-3">
                     {selected !== s.correct && s.wrongExplanations[selected!] && (
                        <div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30">
                           <p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Kills Companies:</p>
                           <p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30">
                        <p className="text-xs text-green-300 font-bold mb-1">‚úì Survival Insight:</p>
                        <p className="text-sm text-green-100">{s.why}</p>
                     </div>
                     <div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30">
                        <p className="text-xs text-blue-300 font-bold mb-1">üìñ Real Example:</p>
                        <p className="text-sm text-blue-100">{s.realWorld}</p>
                     </div>
                     <button
                        onClick={next}
                        className="w-full py-2 bg-orange-600 rounded-lg hover:bg-orange-500"
                     >
                        {scenario >= scenarios.length - 1 ? 'See Assessment' : 'Next Decision'}
                     </button>
                  </div>
               )}
            </div>

            <div className="p-3 bg-black/30 border-t border-orange-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button
                     key={k}
                     onClick={() => { setInfoTopic(k); setShowInfo(true); }}
                     className="text-xs text-orange-400 hover:text-orange-300"
                  >
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- TEAM BUILDING RENDERER ---
   const TeamBuildingRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Co-founder & Team Dynamics Lab - Real scenarios that destroy companies
      const scenarios = [
         {
            title: "The Equity Time Bomb",
            context: "You and your co-founder started 50/50. After 18 months, you've raised $2M and have 10 employees. Your co-founder wants to leave for a 'better opportunity' - they've only vested 25% (1.5 years of 4-year vesting). They want to keep all 50% because they were 'there from the start.'",
            question: "How should you handle this situation?",
            opts: [
               'Let them keep the full 50% - they were essential early on',
               'They keep only their vested 25% - the agreement is clear',
               'Negotiate a middle ground to preserve the relationship',
               'Accelerate their vesting as a goodwill gesture'
            ],
            correct: 1,
            wrongExplanations: [
               "Giving 50% to someone who contributed 1.5 of 10 years is unfair to you, your team, and your investors. It also sets terrible precedent.",
               "", // Correct
               "Middle ground sounds nice but undermines the vesting agreement. Future employees will expect the same exceptions. Agreements exist for this reason.",
               "Accelerating vesting rewards leaving. This creates perverse incentives for everyone else to leave early and demand acceleration."
            ],
            realWorld: "The Winklevoss twins and Mark Zuckerberg. Eduardo Saverin and Mark Zuckerberg. Co-founder disputes with unclear or unenforced vesting destroy companies. Vesting exists specifically for this scenario.",
            concept: "cofounder_vesting",
            why: "Vesting protects everyone. If they leave at 18 months, they've earned 18 months of equity. Honoring the agreement: 1) Is fair to remaining team members, 2) Protects your cap table for future fundraising, 3) Sets clear precedent."
         },
         {
            title: "The Silent Disagreement",
            context: "You're CEO, your co-founder is CTO. You disagree on a major technical decision: they want to rebuild the platform (6 months, $500K), you think the current system is fine. They haven't explicitly objected but have stopped contributing to planning meetings.",
            question: "What's the REAL problem here?",
            opts: [
               'Force a decision as CEO - someone has to lead',
               'The technical disagreement - find a compromise on the rebuild',
               'The communication breakdown - address the disengagement directly',
               'Give them what they want to restore motivation'
            ],
            correct: 2,
            wrongExplanations: [
               "Forcing decisions without addressing communication creates resentment. You'll 'win' but lose engagement on everything else.",
               "The technical debate is the symptom, not the disease. Solve this and the pattern repeats on the next conflict.",
               "", // Correct
               "Capitulating teaches that disengagement works. Your co-founder learns passive-aggression gets results."
            ],
            realWorld: "Most co-founder breakups aren't about the disagreement itself - they're about how disagreements are handled. Companies die when co-founders stop talking honestly.",
            concept: "cofounder_communication",
            why: "The technical decision matters less than the meta-problem: your co-founder is withdrawing instead of engaging. Address this directly: 'I noticed you've pulled back. What's going on?' Healthy relationships require surfacing conflict, not avoiding it."
         },
         {
            title: "The Brilliant Jerk",
            context: "Your 3rd engineer is exceptional - 3x more productive than anyone else, built your core infrastructure. But they're toxic: dismissive of others, hostile in code reviews, and two good engineers quit citing them as the reason.",
            question: "What should you do about this engineer?",
            opts: [
               'Keep them - losing 3x productivity would devastate the company',
               'Coach them intensively - their skills justify the investment',
               'Fire them - cultural damage exceeds productivity value',
               'Isolate them - let them work alone on critical projects'
            ],
            correct: 2,
            wrongExplanations: [
               "3x productivity minus 2 departures (and future departures) is negative. Plus, the remaining team operates at reduced effectiveness around them.",
               "Coaching rarely fixes deeply ingrained behavior patterns in adults. You'll invest heavily while the damage continues.",
               "", // Correct
               "Isolation signals bad behavior is acceptable if you're skilled enough. Culture becomes: 'values don't apply to top performers.'"
            ],
            realWorld: "Netflix's culture doc: 'Brilliant jerks' are not tolerated because teamwork damage exceeds individual contribution. Apple fired brilliant engineers for undermining teams.",
            concept: "culture_enforcement",
            why: "One toxic hire costs: departures, reduced team productivity, damaged psychological safety, cultural erosion. Fire fast. The relief confirms it was right."
         },
         {
            title: "The First Marketing Hire",
            context: "Candidate A: Ex-Google, perfect resume, wants $180K + 0.5% equity, talks about 'brand building.' Candidate B: 5 years at startups, scrappy, wants $100K + 1% equity, talks about 'CAC, LTV, and experiment velocity.'",
            question: "Which candidate should you hire?",
            opts: [
               'Candidate A - big company experience means quality and best practices',
               'Candidate B - startup experience and metrics focus match your stage',
               'Neither - keep doing marketing yourself until you find someone better',
               'Candidate A at Candidate B\'s compensation - negotiate hard'
            ],
            correct: 1,
            wrongExplanations: [
               "Big company marketers optimize for large budgets and brand consistency. Startups need scrappy experimentation and small budget efficiency. Wrong skill set.",
               "", // Correct
               "Founder time is valuable. Marketing yourself takes time from product, fundraising, and strategy.",
               "If they accept B's terms, it signals desperation or misunderstanding. Misaligned expectations create problems later."
            ],
            realWorld: "Airbnb's early marketing was cereal boxes and Craigslist hacks, not 'brand awareness.' Early stage needs someone who runs experiments on $5K budgets, not $5M campaigns.",
            concept: "stage_appropriate_hiring",
            why: "Stage-appropriate hiring is crucial. Language reveals mindset: 'CAC/LTV' = growth thinking. 'Brand building' = wrong stage for a startup."
         },
         {
            title: "The Scaling Struggle",
            context: "An early employee who was amazing in the scrappy phase is struggling at scale. They can't manage their growing team, miss deadlines, and quality dropped. They've been here since the beginning. You've given feedback 3 times with no improvement.",
            question: "What's the right decision?",
            opts: [
               'Fire them - 3 feedback rounds is enough',
               'Move them to an individual contributor role',
               'Keep coaching - loyalty deserves more patience',
               'Wait for them to realize and leave voluntarily'
            ],
            correct: 1,
            wrongExplanations: [
               "Firing is an option but not best. They were excellent as an IC and might still be. Firing wastes domain knowledge.",
               "", // Correct
               "3 rounds with no improvement suggests capability, not effort. More coaching won't solve a fundamental mismatch.",
               "Waiting is worst. Their team suffers, they suffer, and the problem grows. Leaders make hard decisions."
            ],
            realWorld: "Many founding team members become ICs as companies scale. Stripe and Airbnb moved early employees to IC roles successfully. The conversation: 'Your greatest value is X. Let's put you there.'",
            concept: "role_evolution",
            why: "Great at Stage A doesn't mean great at Stage B. Move to IC: honors contribution, uses expertise, protects their team. It's kind, not cruel."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         cofounder_vesting: "Co-founder Equity & Vesting",
         cofounder_communication: "Co-founder Communication Patterns",
         culture_enforcement: "Culture Enforcement",
         stage_appropriate_hiring: "Stage-Appropriate Hiring",
         role_evolution: "Role Evolution & Scaling"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         vesting: { title: "Vesting Fundamentals", content: "Standard: 4-year vesting, 1-year cliff. After 1 year: 25% vests. Then monthly for remaining 3 years. ALL founders should vest. Accelerated vesting on acquisition (single trigger) or acquisition + termination (double trigger)." },
         equity: { title: "Equity Split Guidelines", content: "Equal splits work when both founders are equally committed. Unequal when one has idea/expertise or started earlier. Address equity early - it only gets harder to discuss later." },
         culture: { title: "Culture & Values", content: "Culture = how your team behaves when you're not watching. Define values early, hire for them, fire for violations. Culture debt is as dangerous as technical debt." },
         hiring: { title: "Early Hiring", content: "First 10 hires set culture. Prioritize: 1) Can do the job, 2) Will do the job, 3) Fit the team, 4) Can grow. For startups: bias toward generalists." }
      };

      const answer = (idx: number) => { if (answered) return; setSelected(idx); setAnswered(true); const s = scenarios[scenario]; if (idx === s.correct) { setScore(p => p + 1); setGameLog(l => [...l, `‚úì ${s.title}: Correct!`]); } else { setGameLog(l => [...l, `‚úó ${s.title}: Missed`]); if (!conceptGaps.includes(s.concept)) { setConceptGaps(g => [...g, s.concept]); } } };
      const next = () => { if (scenario >= scenarios.length - 1) { setPhase('result'); } else { setScenario(p => p + 1); setAnswered(false); setSelected(null); } };
      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white p-6"><div className="text-6xl mb-4">üë•</div><h2 className="text-2xl font-bold mb-2">Co-founder & Team Lab</h2><p className="text-slate-300 text-center mb-4 max-w-md">Navigate the human dynamics that make or break startups.</p><div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm"><p className="text-indigo-400 font-bold mb-2">üíî 65% of startups fail due to co-founder conflict</p></div><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl font-bold">Build Team</button></div>);
      if (phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white p-6 overflow-auto"><div className="text-6xl mb-4">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üë•' : 'üîß'}</div><h2 className="text-2xl font-bold mb-2">Team Assessment</h2><div className="text-4xl font-bold text-indigo-400 mb-2">{score}/{scenarios.length}</div><div className="text-5xl mb-4">{grade}</div>{conceptGaps.length > 0 && (<div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4"><p className="text-indigo-400 font-bold text-sm mb-2">üìö Study:</p><ul className="text-slate-300 text-xs">{conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}</ul></div>)}<div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">{gameLog.map((l,i) => <p key={i} className="text-xs text-slate-300">{l}</p>)}</div><button onClick={() => {setPhase('intro');setScenario(0);setScore(0);setAnswered(false);setSelected(null);setGameLog([]);setConceptGaps([]);}} className="px-6 py-2 bg-indigo-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-indigo-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-indigo-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-indigo-500/30 flex justify-between items-center"><span className="font-bold">üë• Team Lab</span><span className="text-indigo-400">{scenario + 1}/{scenarios.length}</span><span className="text-purple-400">Score: {score}</span></div><div className="flex-1 p-4 overflow-auto"><div className="bg-black/30 rounded-xl p-3 mb-3"><p className="font-bold text-indigo-400 mb-2">{s.title}</p><p className="text-sm text-slate-300">{s.context}</p></div><div className="bg-black/30 rounded-xl p-4 mb-3"><p className="font-medium">{s.question}</p></div><div className="grid gap-2">{s.opts.map((opt, i) => (<button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm ${answered ? i === s.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30' : 'bg-black/30 hover:bg-indigo-600/50'}`}>{opt}</button>))}</div>{answered && (<div className="mt-3 space-y-3">{selected !== s.correct && s.wrongExplanations[selected!] && (<div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30"><p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Fails:</p><p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p></div>)}<div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30"><p className="text-xs text-green-300 font-bold mb-1">‚úì Insight:</p><p className="text-sm text-green-100">{s.why}</p></div><div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30"><p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p><p className="text-sm text-blue-100">{s.realWorld}</p></div><button onClick={next} className="w-full py-2 bg-indigo-600 rounded-lg">{scenario >= scenarios.length - 1 ? 'See Results' : 'Next'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-indigo-500/30 flex gap-2 justify-center flex-wrap">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-indigo-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   // --- LEADERSHIP RENDERER ---
   const LeadershipRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      // Situational Leadership Lab - Context determines the right approach
      const scenarios = [
         {
            title: "The Founder's Trap",
            context: "You're a technical founder who built the first version of the product. Now you have 15 engineers. You still review every PR, attend every standup, and make every technical decision. Your CTO hire just quit, saying 'you won't let anyone else lead.'",
            question: "What's the REAL problem with your leadership?",
            opts: [
               'You need to hire a better CTO who can work with you',
               'You\'re bottlenecking the organization by not delegating',
               'Your standards are too high - lower them',
               'The team needs more training before you can step back'
            ],
            correct: 1,
            wrongExplanations: [
               "Every CTO will face the same problem. The issue isn't them - it's that you're not creating space for leadership to emerge. You'll keep losing leaders.",
               "", // Correct
               "High standards aren't the problem. The problem is that YOU are the only one who can meet them. That's a system failure, not a standards issue.",
               "Waiting for the 'right time' to delegate is a trap. Teams develop BY being given responsibility, not before."
            ],
            realWorld: "Steve Jobs was fired from Apple partly for micromanaging. When he returned, he'd learned to hire great people and give them space. Elon Musk struggles with this - his companies succeed despite his micromanagement, not because of it.",
            concept: "delegation_scaling",
            why: "Founders who built the first version often become the constraint on the next version. Every decision that runs through you is a decision that's slower than it should be. Your job shifts from 'doing' to 'enabling others to do.' If you're the smartest person in every room, you've failed at hiring."
         },
         {
            title: "The Transparency Dilemma",
            context: "Your startup is in trouble. Runway is 4 months, fundraising is stalling, and you might need layoffs. Your team doesn't know - you've been shielding them to protect morale. But rumors are spreading and anxiety is rising.",
            question: "What's the RIGHT level of transparency here?",
            opts: [
               'Keep shielding them - leaders carry the burden so others can work',
               'Full transparency - share everything, let them decide if they want to stay',
               'Partial transparency - share the challenge, your plan, and what you need from them',
               'Wait until you have a solution, then share'
            ],
            correct: 2,
            wrongExplanations: [
               "Shielding creates worse anxiety. People know something is wrong and imagine worse scenarios. You're also denying them agency to help or prepare.",
               "Full transparency without context or plan creates panic. Sharing 'we might die' without 'here's how we might survive' is irresponsible.",
               "", // Correct
               "Waiting erodes trust. If you solve it, they'll wonder what else you're hiding. If you don't, they'll resent not having time to prepare."
            ],
            realWorld: "Buffer shared their runway publicly during a crisis - it built trust. But they also shared their plan. Contrast with startups that say nothing until layoffs: employees feel betrayed and survivors lose trust.",
            concept: "transparency_calibration",
            why: "The right formula: Share the challenge (honest), Share your plan (action), Share what you need (agency), Acknowledge uncertainty (humble). This treats your team as adults who can handle hard truths while giving them a way to contribute to the solution."
         },
         {
            title: "The Loyalty vs Performance",
            context: "Your first employee was critical in the early days. They took a pay cut, worked nights, and believed when no one else did. Now they're a director, but they're clearly not at the level the role requires. They're defensive about feedback and their team is struggling.",
            question: "What does good leadership require here?",
            opts: [
               'Keep them in role - loyalty must be rewarded',
               'Quietly move responsibilities away while keeping their title',
               'Have an honest conversation about the gap and explore options together',
               'Fire them - performance is all that matters'
            ],
            correct: 2,
            wrongExplanations: [
               "Keeping underperformers in roles they can't handle hurts them (stress, failure), their team (bad leadership), and the company. Loyalty isn't an excuse for harm.",
               "Shadow-removing responsibilities is dishonest and humiliating. They'll know, others will know, and trust erodes. It's cowardly, not kind.",
               "", // Correct
               "Immediate firing without conversation ignores their contribution and your responsibility to help them succeed. It also sends a message that loyalty is punished."
            ],
            realWorld: "Netflix's culture of 'adequate performance gets a generous severance' sounds harsh but is actually clearer and kinder than companies that keep people in failing roles for years. The key: have the conversation EARLY, not after resentment builds.",
            concept: "performance_conversations",
            why: "The honest conversation: 'The role has outgrown where you are right now. I value you and want you here. Let's figure out together where you can succeed - whether that's a different role, development support, or an honest exit.' This honors their contribution while addressing reality."
         },
         {
            title: "The Visionary Trap",
            context: "You have a bold vision for the company. Your team keeps pushing back with 'practical concerns' about execution, resources, and risk. You believe great leaders push through doubt. But you've noticed the best people are becoming disengaged.",
            question: "What's happening with your leadership?",
            opts: [
               'Your team doesn\'t share your vision - replace doubters with believers',
               'Great visions always face resistance - push harder',
               'You\'re confusing conviction with stubbornness - leadership requires listening',
               'Lower your ambitions to match team capability'
            ],
            correct: 2,
            wrongExplanations: [
               "Replacing doubters with yes-people creates echo chambers. The best people push back because they care. Losing them is a warning sign, not a hiring problem.",
               "There's a difference between vision pushback (expected) and disengagement from your best people (danger signal). The latter suggests your leadership style is the problem.",
               "", // Correct
               "This isn't about lowering ambitions - it's about how you hold them. You can have bold vision AND listen to execution concerns."
            ],
            realWorld: "Travis Kalanick pushed his vision at Uber despite pushback on ethics. His conviction created massive value but also massive problems. Contrast with Satya Nadella, who transformed Microsoft by holding bold vision while genuinely listening.",
            concept: "vision_vs_stubbornness",
            why: "Vision + Stubbornness = Blind spots and exit of best people. Vision + Listening = Course-corrected execution and engaged team. The test: Are your best people leaning in or checking out? If checking out, the problem is you, not them."
         },
         {
            title: "The Crisis Leader",
            context: "A major customer just publicly accused your company of data mishandling on Twitter. Your PR person wants to issue a corporate statement. Your lawyer wants to say nothing. Your customer success lead wants to apologize immediately. Your team is looking to you.",
            question: "What's the MOST important leadership action right now?",
            opts: [
               'Get the facts before responding - you can\'t lead without information',
               'Make a quick decision - any direction is better than paralysis',
               'Let the experts (PR, legal) handle it - they know their domains',
               'Gather the team, acknowledge the crisis, assign clear roles, and set a timeline'
            ],
            correct: 3,
            wrongExplanations: [
               "Facts are important, but in crisis, speed matters. Perfect information never arrives. You need enough to act, not everything.",
               "Quick decisions without coordination create chaos. Different people doing different things makes crises worse.",
               "Domain experts have narrow views. Legal wants to minimize liability. PR wants reputation. You need someone integrating all concerns - that's leadership.",
               "" // Correct
            ],
            realWorld: "Johnson & Johnson's Tylenol crisis response is legendary: immediate action, clear leadership, transparent communication. Contrast with Boeing's 737 MAX response: delayed, defensive, and diffuse leadership. The difference was leadership clarity, not facts.",
            concept: "crisis_leadership",
            why: "In crisis, your team needs: 1) Acknowledgment (yes, this is serious), 2) Calm (not panic), 3) Structure (who does what), 4) Timeline (when we'll know more). The facts matter, but leadership coordination matters more. You're the one who sees the whole picture."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         delegation_scaling: "Delegation & Scaling Leadership",
         transparency_calibration: "Transparency & Communication",
         performance_conversations: "Performance & Loyalty Tradeoffs",
         vision_vs_stubbornness: "Vision vs. Stubbornness",
         crisis_leadership: "Crisis Leadership"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         styles: { title: "Situational Leadership", content: "Adapt your style to the situation: Directing (crisis, new hires), Coaching (willing but not able), Supporting (able but not confident), Delegating (able and willing). The same person needs different styles at different times." },
         feedback: { title: "Feedback Framework (SBI)", content: "Situation: When/where did it happen? Behavior: What specifically did they do? Impact: What was the effect? Then ask for their perspective. Agree on next steps together. Focus on behaviors, not character." },
         delegation: { title: "Delegation Levels", content: "Level 1: Do exactly this. Level 2: Research and recommend. Level 3: Research, recommend, and act. Level 4: Act and inform me. Level 5: Act independently. Match level to trust and competence." },
         trust: { title: "Trust Equation", content: "Trust = (Credibility + Reliability + Intimacy) / Self-Interest. Build trust through demonstrated competence, keeping commitments, creating psychological safety, and visibly putting team before self." }
      };

      const answer = (idx: number) => { if (answered) return; setSelected(idx); setAnswered(true); const s = scenarios[scenario]; if (idx === s.correct) { setScore(p => p + 1); setGameLog(l => [...l, `‚úì ${s.title}: Correct!`]); } else { setGameLog(l => [...l, `‚úó ${s.title}: Missed`]); if (!conceptGaps.includes(s.concept)) { setConceptGaps(g => [...g, s.concept]); } } };
      const next = () => { if (scenario >= scenarios.length - 1) { setPhase('result'); } else { setScenario(p => p + 1); setAnswered(false); setSelected(null); } };
      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';
      const s = scenarios[scenario];

      if (phase === 'intro') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-6"><div className="text-6xl mb-4">üëî</div><h2 className="text-2xl font-bold mb-2">Situational Leadership Lab</h2><p className="text-slate-300 text-center mb-4 max-w-md">Master the leadership challenges that derail founders.</p><div className="bg-black/30 rounded-xl p-4 mb-6 max-w-md text-sm"><p className="text-amber-400 font-bold mb-2">üéØ Leadership is contextual:</p><ul className="text-slate-300 space-y-1 text-xs"><li>‚Ä¢ Same situation requires different approaches at different stages</li><li>‚Ä¢ What works in crisis fails in growth, and vice versa</li></ul></div><button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold">Lead the Way</button></div>);
      if (phase === 'result') return (<div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white p-6 overflow-auto"><div className="text-6xl mb-4">{grade === 'A' ? 'üëë' : grade === 'B' ? 'üëî' : 'üìö'}</div><h2 className="text-2xl font-bold mb-2">Leadership Assessment</h2><div className="text-4xl font-bold text-amber-400 mb-2">{score}/{scenarios.length}</div><div className="text-5xl mb-4">{grade}</div>{conceptGaps.length > 0 && (<div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4"><p className="text-amber-400 font-bold text-sm mb-2">üìö Study:</p><ul className="text-slate-300 text-xs">{conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}</ul></div>)}<div className="bg-black/30 rounded-xl p-4 max-w-md w-full mb-4 max-h-32 overflow-y-auto">{gameLog.map((l,i) => <p key={i} className="text-xs text-slate-300">{l}</p>)}</div><button onClick={() => {setPhase('intro');setScenario(0);setScore(0);setAnswered(false);setSelected(null);setGameLog([]);setConceptGaps([]);}} className="px-6 py-2 bg-amber-600 rounded-lg">Try Again</button></div>);
      return (<div className="w-full h-full flex flex-col bg-gradient-to-br from-amber-900 via-orange-900 to-red-900 text-white overflow-hidden">{showInfo && infoTopic && infoTopics[infoTopic] && (<div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}><div className="bg-slate-800 rounded-xl p-4 max-w-md" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-amber-400 mb-2">{infoTopics[infoTopic].title}</h3><p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p><button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-amber-600 rounded-lg">Got it!</button></div></div>)}<div className="p-3 bg-black/30 border-b border-amber-500/30 flex justify-between items-center"><span className="font-bold">üëî Leadership</span><span className="text-amber-400">{scenario + 1}/{scenarios.length}</span><span className="text-orange-400">Score: {score}</span></div><div className="flex-1 p-4 overflow-auto"><div className="bg-black/30 rounded-xl p-3 mb-3"><p className="font-bold text-amber-400 mb-2">{s.title}</p><p className="text-sm text-slate-300">{s.context}</p></div><div className="bg-black/30 rounded-xl p-4 mb-3"><p className="font-medium">{s.question}</p></div><div className="grid gap-2">{s.opts.map((opt, i) => (<button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm ${answered ? i === s.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30' : 'bg-black/30 hover:bg-amber-600/50'}`}>{opt}</button>))}</div>{answered && (<div className="mt-3 space-y-3">{selected !== s.correct && s.wrongExplanations[selected!] && (<div className="p-3 bg-red-900/50 rounded-lg border border-red-500/30"><p className="text-xs text-red-300 font-bold mb-1">‚ùå Why This Fails:</p><p className="text-sm text-red-100">{s.wrongExplanations[selected!]}</p></div>)}<div className="p-3 bg-green-900/50 rounded-lg border border-green-500/30"><p className="text-xs text-green-300 font-bold mb-1">‚úì Leadership Insight:</p><p className="text-sm text-green-100">{s.why}</p></div><div className="p-3 bg-blue-900/50 rounded-lg border border-blue-500/30"><p className="text-xs text-blue-300 font-bold mb-1">üìñ Real World:</p><p className="text-sm text-blue-100">{s.realWorld}</p></div><button onClick={next} className="w-full py-2 bg-amber-600 rounded-lg">{scenario >= scenarios.length - 1 ? 'See Results' : 'Next'}</button></div>)}</div><div className="p-3 bg-black/30 border-t border-amber-500/30 flex gap-2 justify-center flex-wrap">{Object.keys(infoTopics).map(k => <button key={k} onClick={() => {setInfoTopic(k);setShowInfo(true);}} className="text-xs text-amber-400">‚ÑπÔ∏è {infoTopics[k].title}</button>)}</div></div>);
   };

   // --- CUSTOMER JOURNEY RENDERER ---
   const CustomerJourneyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Awareness Paradox",
            context: "Your B2B SaaS startup has a $200 CAC target. Marketing is running Google Ads that generate 500 clicks/day at $4/click ($2,000/day spend). Conversion rate is 0.4%, meaning 2 trials per day. But your SDR team reports these leads rarely convert to paid‚Äîthey're 'just researching' with no urgency.",
            question: "What's the real problem with your awareness strategy?",
            opts: [
               "A) Increase ad spend to get more volume‚Äîit's a numbers game",
               "B) You're capturing low-intent awareness traffic, not high-intent consideration traffic",
               "C) Lower the trial barrier‚Äîmake signup even easier",
               "D) The SDR team needs better scripts to create urgency"
            ],
            correct: 1,
            wrongExplanations: [
               "More volume of low-quality leads just wastes more money. Your $2,000/day is generating 2 trials with poor conversion‚Äîspending $4,000 for 4 bad leads doesn't help.",
               "",
               "Easier signup often DECREASES quality further. You'd get more 'tire kickers' who never intended to buy, wasting even more SDR time on unqualified leads.",
               "SDRs can't manufacture intent that doesn't exist. Creating artificial urgency on low-intent leads damages trust and rarely converts. The problem is upstream."
            ],
            realWorld: "HubSpot discovered that their highest-converting leads came from educational content (ebooks, tools) that attracted people actively solving problems‚Äînot from ads targeting broad awareness keywords. Their content-first approach reduced CAC by 61% while increasing close rates.",
            concept: "intent_matching",
            why: "Awareness ‚â† interest. Google Ads targeting 'what is CRM' captures educational intent. Targeting 'best CRM for sales teams 2024' captures evaluation intent. The journey stage determines conversion potential‚Äîmatching content to intent is more important than traffic volume."
         },
         {
            title: "The Consideration Maze",
            context: "Prospects are comparing your project management tool to Asana and Monday.com. Your analytics show visitors spend 8 minutes on your comparison page, view pricing, then leave without signing up. Exit surveys say 'need to think about it.' You have 3x more features than competitors at the same price.",
            question: "Why aren't feature-rich comparisons converting?",
            opts: [
               "A) More features overwhelm evaluation‚Äîthey need clarity on their specific use case",
               "B) Lower your price to be clearly cheaper than competitors",
               "C) Add even more features to the comparison chart",
               "D) Implement aggressive retargeting to stay top of mind"
            ],
            correct: 0,
            wrongExplanations: [
               "",
               "Price wars in SaaS rarely work. Monday.com and Asana have deeper pockets‚Äîthey can always match or beat you. You'd destroy margins without winning customers.",
               "More features = more overwhelm. The problem is decision paralysis, not lack of options. Each additional feature makes the choice harder, not easier.",
               "Retargeting people who are confused doesn't reduce confusion‚Äîit just annoys them. You'll train them to ignore your ads without addressing why they didn't convert."
            ],
            realWorld: "Basecamp built a $100M+ business by doing the OPPOSITE‚Äîfewer features, clearer positioning. Their 'here's what we DON'T do' messaging helped prospects self-select. Conversion rates increased 24% after they removed feature comparisons and replaced them with use-case stories.",
            concept: "consideration_clarity",
            why: "In the consideration stage, prospects need help deciding, not more options. Feature lists create analysis paralysis. Use-case matching ('Are you a team of 5-15? Here's exactly how teams like yours use us') converts because it answers 'Is this right for ME?' not 'Which has more features?'"
         },
         {
            title: "The Checkout Cliff",
            context: "Your e-commerce store has a 68% cart abandonment rate. Most abandon at the payment page. You've implemented 'only 2 left!' urgency messaging, countdown timers for 'limited' discounts, and exit-intent popups offering 15% off. Abandonment hasn't improved, and customers who do buy rarely return.",
            question: "What's causing persistent abandonment despite urgency tactics?",
            opts: [
               "A) Urgency tactics aren't aggressive enough‚Äîadd more scarcity signals",
               "B) Manipulation erodes trust at decision time‚Äîaddress real objections instead",
               "C) The 15% discount isn't enough‚Äîoffer 25% to close more deals",
               "D) Payment friction‚Äîadd more payment options like crypto"
            ],
            correct: 1,
            wrongExplanations: [
               "More manipulation increases skepticism. Savvy customers recognize fake urgency ('only 2 left!' that never changes). This destroys trust precisely when you need it most‚Äîat purchase time.",
               "",
               "Training customers to expect discounts destroys margins and attracts price-sensitive buyers who churn. Plus, discount-seekers learned to abandon carts TO get offers.",
               "Payment options matter, but most abandoned carts aren't payment friction‚Äîthey're trust and value uncertainty. Adding crypto doesn't address 'Is this worth it?'"
            ],
            realWorld: "Zappos built a $1B+ business with NO urgency tactics. Instead, they addressed real decision-stage concerns: free shipping, 365-day returns, 24/7 support visible at checkout. Their return rate was 35% but customer LTV was 2.5x industry average because trust converted browsers into repeat buyers.",
            concept: "decision_trust",
            why: "At the decision stage, customers aren't resisting purchase‚Äîthey're managing risk. 'What if it doesn't work?' 'What if I don't like it?' Manipulation amplifies these fears. Addressing them (easy returns, support access, real reviews) converts because it reduces perceived risk, not because it creates artificial urgency."
         },
         {
            title: "The Retention Trap",
            context: "Your SaaS has 8% monthly churn. The customer success team sends automated 'we miss you!' emails to inactive users and offers discounts to churning customers. Win-back rate is just 3%. Meanwhile, NPS surveys show churned customers cite 'didn't see value' as the primary reason for leaving.",
            question: "Why isn't your retention strategy working?",
            opts: [
               "A) Discounts should be bigger‚Äî50% off for 6 months to keep them",
               "B) Send more frequent engagement emails to stay top of mind",
               "C) Retention fails when activation failed‚Äîcustomers never reached value",
               "D) Implement annual contracts to lock customers in longer"
            ],
            correct: 2,
            wrongExplanations: [
               "Discounting churning customers just delays inevitable departure while destroying unit economics. If they 'didn't see value' at $X, they won't see it at $X/2 either.",
               "More emails to users who already don't find value is spam. It doesn't create value‚Äîit creates annoyance and speeds up the unsubscribe/churn decision.",
               "",
               "Forced retention creates resentful customers who actively warn others. You'd reduce churn numbers while increasing negative word of mouth‚Äînet negative."
            ],
            realWorld: "Slack discovered that teams who sent 2,000+ messages in the first month had 93% retention vs. 45% for those who didn't. They shifted from 'prevent churn' to 'accelerate activation'‚Äîadding an onboarding wizard that got teams to value faster. Churn dropped from 8% to 3% monthly.",
            concept: "activation_retention",
            why: "Retention is won or lost at activation, not at churn. 'Didn't see value' means they never experienced the 'aha moment.' The fix isn't retention campaigns‚Äîit's ensuring customers reach value before they have time to churn. Time-to-value is the leading indicator of retention."
         },
         {
            title: "The Advocacy Mirage",
            context: "Your NPS is 72 (great!), but referral program uptake is only 4%. You offer $50 for both referrer and referee. Marketing sends monthly 'refer a friend' emails. Your best customers give testimonials when asked but rarely share spontaneously. You're mystified why high satisfaction doesn't translate to advocacy.",
            question: "Why doesn't NPS correlate with actual referrals?",
            opts: [
               "A) Increase referral reward to $100‚Äîmoney motivates sharing",
               "B) Satisfaction and advocacy are different‚Äîpeople share identity, not products",
               "C) Send referral requests more frequently to increase exposure",
               "D) Implement a leaderboard to gamify referrals"
            ],
            correct: 1,
            wrongExplanations: [
               "Larger incentives can actually reduce sharing‚Äîit makes the recommendation feel transactional rather than genuine. Friends trust recommendations, not paid advertisements.",
               "",
               "More referral requests feel spammy and actually reduce response rates. Customers who haven't shared after 12 monthly emails won't share after 24.",
               "Leaderboards work for gamified communities but make referrals feel like a game, not a genuine recommendation. Most customers don't want to 'compete' at referring friends."
            ],
            realWorld: "Crossfit became a $4B industry with minimal marketing budget. Members didn't share because of referral bonuses‚Äîthey shared because 'being a Crossfitter' became part of their identity. Tesla owners don't refer for $1,000 credits‚Äîthey refer because recommending Tesla signals who they are.",
            concept: "identity_advocacy",
            why: "People don't refer products‚Äîthey refer parts of their identity. 'I use Notion' is product usage. 'I'm a Notion person who optimizes everything' is identity. Advocacy happens when your product becomes part of how customers see themselves. The job isn't 'incentivize sharing'‚Äîit's 'make usage an identity.'"
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         intent_matching: "Intent-Based Awareness Strategy",
         consideration_clarity: "Consideration Stage Simplification",
         decision_trust: "Decision-Stage Trust Building",
         activation_retention: "Activation-First Retention",
         identity_advocacy: "Identity-Driven Advocacy"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         awareness: { title: "Awareness Stage Metrics", content: "Key metrics: Traffic quality (not just quantity), search intent match, content engagement depth, and brand recall. CAC at awareness is often misleading‚Äîintent matters more than clicks. High-intent traffic at $10/click beats low-intent at $2/click." },
         consideration: { title: "Consideration Psychology", content: "Prospects in consideration seek clarity, not features. They're asking 'Is this right for me?' not 'Which is better?' Decision fatigue is real‚Äîtoo many options paralyze. Use-case matching and 'who this is for' messaging converts better than feature comparisons." },
         decision: { title: "Decision Stage Dynamics", content: "At decision time, customers manage risk, not seek deals. They're asking 'What if this doesn't work?' Address fears with: visible support, easy returns, real reviews, and trust signals. Manipulation increases perceived risk‚Äîauthenticity decreases it." },
         retention: { title: "Retention Leading Indicators", content: "Retention is predicted by activation, not satisfaction surveys. Track time-to-value, feature adoption milestones, and engagement patterns. Intervene BEFORE usage drops‚Äîonce customers disengage, win-back is nearly impossible." },
         advocacy: { title: "Advocacy Psychology", content: "Referrals are identity expressions, not transactions. People share things that signal who they are to their network. Make product usage an identity marker. 'I'm an X user' should feel like membership, not consumption." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Understood customer journey psychology`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6">
               <div className="text-6xl mb-4">üó∫Ô∏è</div>
               <h2 className="text-2xl font-bold mb-2">Customer Journey Mastery</h2>
               <p className="text-violet-300 text-center mb-4 max-w-md">
                  Navigate the psychological dynamics of each customer journey stage‚Äîfrom first touch to passionate advocacy.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">In this simulation, you'll face real scenarios where:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Awareness traffic doesn't mean awareness success</li>
                     <li>‚Ä¢ Features can hurt consideration conversion</li>
                     <li>‚Ä¢ Urgency tactics can backfire at decision time</li>
                     <li>‚Ä¢ Retention starts at activation, not churn prevention</li>
                     <li>‚Ä¢ High NPS doesn't guarantee advocacy</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-xl font-bold">
                  Map the Journey
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üó∫Ô∏è' : grade === 'C' ? 'üìç' : 'üîÑ'}</div>
               <h2 className="text-xl font-bold mb-2">Journey Analysis Complete</h2>
               <div className="text-3xl font-bold text-violet-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Customer journey expert! You understand the psychology of each stage.' :
                   grade === 'B' ? 'Strong journey thinking‚Äîyou see beyond tactics to psychology.' :
                   grade === 'C' ? 'Good foundation‚Äîfocus on understanding WHY tactics work or fail.' :
                   'Review the fundamentals‚Äîjourney stages have distinct psychological dynamics.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Concepts to Review:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-violet-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-violet-900 via-purple-900 to-fuchsia-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-violet-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-violet-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-violet-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">üó∫Ô∏è {sc.title}</span>
               <span className="text-violet-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-fuchsia-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-violet-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-violet-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Why this works:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why your choice fails:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-violet-900/30 border border-violet-500/30 rounded-lg p-3">
                        <p className="text-xs text-violet-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-violet-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-violet-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-violet-400 hover:text-violet-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- MVP DEVELOPMENT RENDERER ---
   const MVPRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Feature Creep Trap",
            context: "Your team spent 3 months brainstorming and has a 47-feature roadmap. Engineering estimates 8 months to build everything. Your co-founder argues 'We need feature parity with competitors or no one will switch.' The team is excited about the AI-powered analytics dashboard that took 2 weeks to spec out.",
            question: "What's the critical MVP mistake being made here?",
            opts: [
               "A) Build the AI analytics first‚Äîit's the most innovative feature",
               "B) The team is building a product, not testing a hypothesis about customer behavior",
               "C) 8 months is too long‚Äîhire more engineers to ship in 4 months",
               "D) Feature parity is correct‚Äîmatch competitors then add unique features"
            ],
            correct: 1,
            wrongExplanations: [
               "Innovation doesn't matter if no one needs the core product. AI analytics is a 'nice to have'‚Äîyou're assuming the base product is wanted without testing it. Many startups build impressive tech for problems nobody pays to solve.",
               "",
               "More engineers won't fix the fundamental problem‚Äîyou're building before validating. Faster execution of the wrong plan is still wrong. 'Move fast' applies to learning, not just building.",
               "Feature parity is a trap for startups. Competing on features with established players is a losing game‚Äîthey have more resources. Startups win by solving one problem 10x better, not by copying everything."
            ],
            realWorld: "Dropbox's MVP was a 3-minute video showing the product concept‚Äîbefore writing any code. The video got 75,000 email signups overnight, validating demand without building anything. They could have spent months building features nobody wanted.",
            concept: "hypothesis_validation",
            why: "MVP isn't about building a smaller product‚Äîit's about testing whether your core hypothesis is true. The question isn't 'What features do we need?' but 'What's the smallest experiment to prove customers will pay for our solution?' Every feature delays learning."
         },
         {
            title: "The Technical Perfectionism Trap",
            context: "Your technical co-founder insists on building with microservices architecture, Kubernetes for scaling, and a custom GraphQL layer. They argue: 'We'll need this when we scale‚Äîrebuilding later will cost 10x more.' Your MVP serves a local market of ~1,000 potential customers. Current runway: 10 months.",
            question: "What's the real cost of this technical approach?",
            opts: [
               "A) It's the right call‚Äîtechnical debt is expensive to fix later",
               "B) Over-engineering burns runway solving problems you don't have yet",
               "C) Compromise‚Äîuse microservices but skip Kubernetes",
               "D) Hire more senior engineers who can build it faster"
            ],
            correct: 1,
            wrongExplanations: [
               "Technical debt only matters if you survive to encounter it. Building for 1M users when you have 0 users is solving an imaginary problem. Most startups fail from lack of customers, not lack of infrastructure.",
               "",
               "This is still over-engineering. Microservices add complexity that slows iteration. For 1,000 users, a simple monolith built in 2 weeks beats a distributed system built in 2 months.",
               "Even senior engineers can't make complex architecture simple. The problem is scope, not skill. Adding people to a complex project often slows it down (Brooks's Law)."
            ],
            realWorld: "Twitter ran on a Ruby on Rails monolith until they had millions of users. The famous 'Fail Whale' only appeared after massive success. Stripe's first version was simple PHP code. Instagram had 13 employees when they sold for $1B‚Äîsimple architecture scales further than you think.",
            concept: "premature_scaling",
            why: "The goal of MVP isn't building the best architecture‚Äîit's learning whether customers want your product. Every hour spent on scale-ready infrastructure is an hour not spent talking to customers. Build for today's problems. Tomorrow's problems are a luxury of survival."
         },
         {
            title: "The 'Almost Done' Paradox",
            context: "Your MVP is 85% complete. The core workflow works but has rough edges: error messages are technical, some edge cases crash, and the onboarding has no help text. Your designer says '2 more weeks for polish.' A beta user said 'It works but feels unfinished.' You have 30 potential early adopters waiting.",
            question: "What should you do with the 85% MVP?",
            opts: [
               "A) Wait for the 2-week polish‚Äîfirst impressions matter",
               "B) Ship now and personally onboard those 30 users through the rough edges",
               "C) Ship to 5 users first as a 'soft launch'",
               "D) The beta feedback confirms you need to fix issues first"
            ],
            correct: 1,
            wrongExplanations: [
               "The 2-week polish cycle is a trap‚Äîthere will always be 'just 2 more weeks' of improvements. Meanwhile, you're guessing what polish actually matters. Ship imperfect, learn what actually frustrates users, then fix THOSE issues.",
               "",
               "5 users is too small for real learning. You need enough users to see patterns, and you need to move fast. 'Soft launch' often becomes an excuse to delay indefinitely.",
               "That beta user used the product anyway. 'Feels unfinished' is expected for early products. The question is whether they'll USE it despite the rough edges‚Äîthat tells you if the core value is there."
            ],
            realWorld: "Airbnb's first version was 'air mattresses on the floor.' Craigslist still looks like it's from 1999 and makes $500M+ annually. Instagram launched with 1 filter and crashed constantly. Early users who love the core value will forgive rough edges.",
            concept: "launch_courage",
            why: "Paul Graham: 'If you're not embarrassed by the first version, you launched too late.' The goal is learning, not impressing. Personal onboarding through rough edges gives you direct customer insight no amount of polish provides. Ship, learn, iterate."
         },
         {
            title: "The Build vs Buy Dilemma",
            context: "Your productivity app needs user authentication, payment processing, email notifications, and file storage. Your engineering team estimates: Auth (3 weeks custom), Payments (4 weeks custom), Email (2 weeks), Storage (2 weeks). Total: 11 weeks for infrastructure before building actual product features. Engineers argue custom gives more control.",
            question: "How should you approach this infrastructure decision?",
            opts: [
               "A) Build custom‚Äîyou'll need the flexibility as you scale",
               "B) Use existing services (Auth0, Stripe, SendGrid, S3)‚Äîship in days, not weeks",
               "C) Build payment processing custom‚Äîit's core to revenue; buy the rest",
               "D) Skip non-essential features (email, storage) for MVP"
            ],
            correct: 1,
            wrongExplanations: [
               "Custom auth and payments add zero value to your product. Customers don't care how you authenticate them‚Äîthey care if your productivity features solve their problem. 11 weeks of commodity infrastructure is 11 weeks of delayed learning.",
               "",
               "Payment processing is NOT your core value‚Äîyour productivity features are. Stripe takes 2.9% but lets you ship immediately. Building payments is reinventing a solved problem when you should be solving unsolved ones.",
               "Email and storage might be essential for MVP functionality. The question isn't 'What's essential?' but 'What should we build vs buy?' Buy commodity; build differentiation."
            ],
            realWorld: "Slack uses AWS for infrastructure, Stripe for payments, and Segment for analytics. They focused engineering on what makes Slack special‚Äîthe messaging experience. Uber's MVP used Twilio for SMS, Google Maps for mapping, and Braintree for payments. They built the matching algorithm themselves.",
            concept: "build_vs_buy",
            why: "Build what differentiates you; buy everything else. Every hour spent on commoditized infrastructure is an hour stolen from your unique value proposition. Third-party services have thousands of engineer-hours behind them‚Äîyou can't match that, and you don't need to."
         },
         {
            title: "The Metrics Trap",
            context: "Your MVP launched 2 weeks ago. You're tracking: 500 signups, 10,000 page views, 2,000 social media impressions, 150 newsletter subscribers. Your investor asks 'How's traction?' and you proudly share these numbers. But you haven't measured how many users actually completed the core workflow or returned after day 1.",
            question: "What's fundamentally wrong with these metrics?",
            opts: [
               "A) The numbers are too small‚Äîneed more volume for valid data",
               "B) These are vanity metrics‚Äîthey don't indicate product-market fit",
               "C) Need to add more metrics like time on site and bounce rate",
               "D) Two weeks isn't enough time‚Äîwait for 30-day cohort data"
            ],
            correct: 1,
            wrongExplanations: [
               "Volume isn't the issue. 500 users who actually used your product is plenty for early learning. The problem is you're not measuring the right things‚Äîsignups without usage tells you nothing about product value.",
               "",
               "More vanity metrics don't help. Time on site and bounce rate tell you about website performance, not product-market fit. The question is: 'Are users getting value and coming back?'",
               "Waiting 30 days won't help if you're measuring the wrong things. You'll have 30 days of the wrong data. Start measuring real engagement now‚Äîeven 2-day retention tells you something."
            ],
            realWorld: "Facebook's key early metric wasn't signups‚Äîit was '7 friends in 10 days.' They found users who added 7 friends within 10 days stayed forever. Slack measures 'messages sent' not 'workspaces created.' Superhuman asks users 'How disappointed would you be if you could no longer use this product?'‚Äî40%+ very disappointed = PMF.",
            concept: "actionable_metrics",
            why: "Vanity metrics (signups, page views, downloads) make you feel good but don't drive decisions. Actionable metrics answer: 'Are users getting value?' Track: activation (did they complete core workflow?), retention (did they come back?), and engagement (how much do they use it?). These predict success."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         hypothesis_validation: "Hypothesis-Driven Development",
         premature_scaling: "Avoiding Premature Optimization",
         launch_courage: "Launch Timing Courage",
         build_vs_buy: "Strategic Build vs Buy Decisions",
         actionable_metrics: "Actionable vs Vanity Metrics"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         definition: { title: "What is MVP Really?", content: "MVP isn't 'Version 1 of the product.' It's the smallest experiment that tests your riskiest assumption. Emphasis on VIABLE (delivers value) and MINIMUM (just enough to learn). The goal is learning, not launching." },
         scope: { title: "Ruthless Scoping", content: "For each feature, ask: 'If we remove this, can we still test our hypothesis?' If yes, remove it. MVP should feel uncomfortably small. If you're not cutting features, you're not scoping an MVP‚Äîyou're building a full product slowly." },
         validation: { title: "Validation Before Building", content: "Hierarchy of validation: 1) Talk to customers (cheapest), 2) Landing page/waitlist, 3) Concierge/manual version, 4) Code MVP. Each step confirms demand before investing more. Many successful MVPs had zero code." },
         iteration: { title: "Build-Measure-Learn", content: "The loop: Build (smallest experiment) ‚Üí Measure (specific hypothesis) ‚Üí Learn (what did we discover?). Each cycle should take days, not months. Speed of iteration is the startup's advantage over incumbents." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Understood lean MVP thinking`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-6">
               <div className="text-6xl mb-4">üöÄ</div>
               <h2 className="text-2xl font-bold mb-2">MVP Survival Simulator</h2>
               <p className="text-lime-300 text-center mb-4 max-w-md">
                  Navigate the treacherous decisions that kill most MVPs‚Äîfeature creep, perfectionism, and vanity metrics.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll face scenarios where:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ More features often means less learning</li>
                     <li>‚Ä¢ Perfect architecture kills runway</li>
                     <li>‚Ä¢ 'Almost done' is a dangerous trap</li>
                     <li>‚Ä¢ Building what you could buy wastes focus</li>
                     <li>‚Ä¢ The wrong metrics hide failure</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-lime-500 to-green-500 rounded-xl font-bold">
                  Launch MVP Lab
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üéØ' : grade === 'B' ? 'üöÄ' : grade === 'C' ? 'üîß' : '‚ö†Ô∏è'}</div>
               <h2 className="text-xl font-bold mb-2">MVP Lab Complete</h2>
               <div className="text-3xl font-bold text-lime-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Lean startup master! You prioritize learning over building.' :
                   grade === 'B' ? 'Strong MVP instincts‚Äîyou understand the core principles.' :
                   grade === 'C' ? 'Watch out for common traps‚Äîfocus on hypothesis testing.' :
                   'Review lean startup fundamentals‚ÄîMVP is about learning, not launching.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Concepts to Review:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-lime-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-lime-900 via-green-900 to-emerald-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-lime-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-lime-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-lime-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">üöÄ {sc.title}</span>
               <span className="text-lime-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-green-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-lime-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-lime-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Why this works:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why your choice fails:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-lime-900/30 border border-lime-500/30 rounded-lg p-3">
                        <p className="text-xs text-lime-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-lime-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-lime-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-lime-400 hover:text-lime-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- RISK ASSESSMENT RENDERER ---
   const RiskAssessmentRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Market Blind Spot",
            context: "Your B2B SaaS targets mid-market companies (100-500 employees). After 8 months of sales, you've closed only 3 customers despite 200+ demos. Conversion rate is 1.5%. Your investors ask if you're addressing a real market need. The sales team blames 'long sales cycles.' Customer interviews reveal most prospects say 'interesting but not urgent.'",
            question: "What's the real risk being masked here?",
            opts: [
               "A) Sales execution risk‚Äîneed better salespeople",
               "B) Market risk‚Äîyou're solving a 'vitamin' problem, not a 'painkiller'",
               "C) Pricing risk‚Äîproduct is too expensive for the market",
               "D) Competitive risk‚Äîprospects are choosing competitors"
            ],
            correct: 1,
            wrongExplanations: [
               "Better salespeople won't help if the product doesn't solve an urgent problem. 'Interesting but not urgent' is customer language for 'I don't really need this.' The problem is upstream of sales.",
               "",
               "If prospects aren't buying at any price point, pricing isn't the issue. 'Not urgent' isn't about cost‚Äîit's about priority. They're not negotiating on price; they're not seeing value.",
               "Prospects aren't mentioning competitors‚Äîthey're saying 'not urgent.' They're choosing 'do nothing,' not a rival product. This is a different and more dangerous situation."
            ],
            realWorld: "Ev Williams (Twitter, Medium founder): 'Take a human desire, preferably one that has been around for a long time, and use modern technology to take out steps.' Vitamins are nice-to-have; painkillers are must-have. 42% of startups fail because there's no market need‚Äîthe #1 cause of startup death.",
            concept: "market_need",
            why: "The 'vitamin vs painkiller' framework distinguishes nice-to-have from must-have products. 'Interesting but not urgent' is the death signal‚Äîit means you've built a vitamin. Real market need manifests as: customers actively searching for solutions, willing to pay before the product is perfect, and urgent timeline pressure."
         },
         {
            title: "The Runway Illusion",
            context: "Your startup has $1.2M in the bank and burns $150K/month (8 months runway). You're raising a Series A but VCs want to see 3x revenue growth. Current MRR: $40K. Growing 12% month-over-month. Your financial model shows you'll hit the 3x target in 10 months. The team is focused on hitting growth targets.",
            question: "What financial risk is being ignored?",
            opts: [
               "A) Growth risk‚Äî12% MoM might not be sustainable",
               "B) Runway assumes linear burn, but scaling requires increased spend‚Äîyou'll run out earlier",
               "C) VCs might change their metrics by the time you're ready",
               "D) Need to raise a bridge round immediately"
            ],
            correct: 1,
            wrongExplanations: [
               "Growth sustainability matters, but the immediate existential risk is financial. Even if growth holds, you're planning for a 10-month journey with only 8 months of gas. The math doesn't work regardless of growth rate.",
               "",
               "VC goalposts do move, but that's not the immediate crisis. You physically can't reach 10 months if you only have 8 months of runway. Worry about VC preferences after you've solved the survival problem.",
               "Bridge rounds are expensive (high dilution, signals weakness). Raising in desperation gets bad terms. The right answer is to extend runway through efficiency, not by raising more at poor terms."
            ],
            realWorld: "CB Insights data shows 29% of startups fail because they run out of cash. Founders consistently underestimate burn increases during scaling‚Äîhiring, infrastructure, marketing all spike. The average startup raises 3-6 months before running out, but at that point, valuation negotiations suffer dramatically.",
            concept: "runway_math",
            why: "The trap: Planning for 10 months when you have 8 months of cash assumes static burn rate. Scaling requires investment‚Äîhiring salespeople, marketing spend, infrastructure. Real runway = Cash √∑ (Current Burn + Growth Investment). Always model scenarios where growth costs more than expected."
         },
         {
            title: "The Hero Dependency",
            context: "Your CTO built 80% of the codebase and is the only person who understands the payment integration, the API architecture, and the deployment pipeline. They work 70-hour weeks and seem to enjoy being indispensable. When asked about documentation, they say 'it's all in my head‚Äîfaster that way.' The company is preparing to raise Series A.",
            question: "What's the board's primary concern here?",
            opts: [
               "A) Burnout risk‚Äîthe CTO is overworked",
               "B) Key-person dependency creates existential risk that tanks valuation",
               "C) Documentation should be improved for better engineering practices",
               "D) Need to hire more senior engineers to distribute workload"
            ],
            correct: 1,
            wrongExplanations: [
               "Burnout is real but secondary. The board's concern is: if this person leaves, what happens to the company? A vacation or illness could halt development. A resignation could kill the company.",
               "",
               "Documentation is a symptom, not the issue. Improving docs is good, but it doesn't solve the concentration risk. The CTO might resist documentation because it reduces their indispensability.",
               "More engineers help but don't solve the risk if knowledge stays concentrated. The new engineers will still depend on the CTO for critical context. The power dynamic must change."
            ],
            realWorld: "In 2015, a fintech startup's CTO left with zero documentation. They spent 6 months reverse-engineering their own codebase and missed their fundraising window. Investors explicitly ask about 'bus factor' (what happens if key people are hit by a bus). Companies with key-person dependency get lower valuations or pass altogether.",
            concept: "key_person_risk",
            why: "Key-person dependency is an existential risk that sophisticated investors specifically screen for. The fix isn't just documentation‚Äîit's cultural. 'Indispensable' employees are actually liabilities. The goal is building systems where no single person can halt operations. This requires active management, not just hope."
         },
         {
            title: "The Regulatory Gamble",
            context: "Your healthtech startup lets users upload medical records and get AI-powered health insights. You've grown to 50,000 users in 6 months. Legal costs for HIPAA compliance would be $300K and take 9 months. Your current legal interpretation is that you're 'health adjacent, not a health provider' so HIPAA doesn't apply. An investor asks about regulatory risk.",
            question: "How should you assess this regulatory risk?",
            opts: [
               "A) The legal interpretation is probably correct‚Äîkeep growing",
               "B) Regulatory gray areas create binary existential risk‚Äîclarify before scaling further",
               "C) Wait for regulators to contact you‚Äîreact then",
               "D) Move headquarters to a country with less strict regulations"
            ],
            correct: 1,
            wrongExplanations: [
               "Legal interpretations from startup lawyers aren't the same as regulatory positions. Many startups have been shut down after believing their own legal theories. 'Probably correct' isn't acceptable for existential risks.",
               "",
               "Waiting for regulators is playing Russian roulette. By the time they contact you, they've already decided you're in violation. Enforcement actions are public, damaging, and expensive. Proactive engagement gives you influence; reactive defense does not.",
               "Regulatory arbitrage works temporarily but creates scaling limits, complicates fundraising, and signals to investors that you're avoiding compliance rather than solving it."
            ],
            realWorld: "23andMe was ordered by the FDA to stop selling genetic health reports in 2013. They spent 4 years working with regulators before relaunching. Contrast with Theranos, which avoided regulatory scrutiny until it became criminal. Uber spent billions fighting regulatory battles that proactive engagement might have prevented.",
            concept: "regulatory_clarity",
            why: "Regulatory risk is binary‚Äîyou're either compliant or you're not. Gray areas feel safe but are actually maximum risk: you're building on uncertain ground. The cost of proactive compliance ($300K, 9 months) vs cost of enforcement (company shutdown, personal liability, reputation damage). Clarify BEFORE scaling."
         },
         {
            title: "The Technical Debt Time Bomb",
            context: "Your startup's codebase was built fast by 2 developers in 6 months. It works but has no tests, no documentation, and a single database that holds everything. New features take 3x longer than they should because developers are afraid of breaking things. You need to hire 5 engineers to hit growth targets, but onboarding takes 2-3 months because 'you just have to learn the quirks.'",
            question: "What risk should you prioritize addressing?",
            opts: [
               "A) Hiring risk‚Äî5 engineers in this market will be hard to find",
               "B) The codebase creates compounding velocity risk‚Äîyou'll slow down as you scale",
               "C) Start rewriting the codebase from scratch with proper architecture",
               "D) Hire contractor help to add tests and documentation"
            ],
            correct: 1,
            wrongExplanations: [
               "Hiring is a challenge, but finding engineers isn't the blocker. The blocker is: even good engineers will be unproductive in this codebase. Hiring won't solve velocity if the system resists change.",
               "",
               "Rewrites are almost always wrong. Joel Spolsky: 'The worst strategic mistake any software company can make: rewrite the code from scratch.' Rewrites take 2-3x longer than estimated, introduce new bugs, and halt feature development.",
               "Contractors writing tests for code they don't understand produces low-value tests. Tests are valuable when developers who understand the system write them to protect critical paths."
            ],
            realWorld: "Twitter's 'Fail Whale' era wasn't caused by scaling‚Äîit was caused by technical debt accumulated during growth. They spent years incrementally improving architecture while maintaining service. Netscape's decision to rewrite from scratch (Netscape 6) killed the company. Stripe's codebase is famously well-maintained because they invest 20% of engineering time in 'code health.'",
            concept: "technical_velocity",
            why: "Technical debt compounds like financial debt‚Äîwith interest. The symptom is 'features take 3x longer.' Left untreated, this becomes '10x longer' then 'impossible.' The fix isn't rewriting‚Äîit's incremental improvement: add tests to critical paths, document as you touch code, refactor in small pieces alongside features. Budget 20-30% of engineering for 'code health.'"
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         market_need: "Market Need Validation",
         runway_math: "Runway Financial Modeling",
         key_person_risk: "Key-Person Dependency",
         regulatory_clarity: "Regulatory Risk Assessment",
         technical_velocity: "Technical Debt Management"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         framework: { title: "Risk Prioritization Matrix", content: "Assess each risk by: Probability (how likely?) √ó Impact (how severe?) = Priority. Focus on high-probability, high-impact risks first. Accept low-probability, low-impact risks consciously. Never ignore high-impact risks regardless of probability." },
         types: { title: "The 5 Startup Killers", content: "1) No market need (42%), 2) Ran out of cash (29%), 3) Wrong team (23%), 4) Got outcompeted (19%), 5) Pricing/cost issues (18%). These overlap‚Äîbut market and cash are the biggest killers. Source: CB Insights analysis of 101 startup failures." },
         mitigation: { title: "RAID Framework", content: "Risk (uncertain events that may harm), Assumption (beliefs taken as true), Issue (current problems), Dependency (reliance on external factors). Track all four explicitly. Most startups only track issues; the other three kill silently." },
         monitoring: { title: "Leading Indicators", content: "Lagging indicators tell you what happened; leading indicators predict what will happen. Churn rate is lagging; declining engagement is leading. Cash in bank is lagging; burn rate trajectory is leading. Monitor leading indicators weekly." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Correctly identified the risk`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-red-900 via-rose-900 to-orange-900 text-white p-6">
               <div className="text-6xl mb-4">‚ö†Ô∏è</div>
               <h2 className="text-2xl font-bold mb-2">Risk Intelligence Lab</h2>
               <p className="text-red-300 text-center mb-4 max-w-md">
                  Identify hidden risks that kill startups before they become crises. Most risks are invisible until it's too late.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll analyze scenarios involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Market risks masked as sales problems</li>
                     <li>‚Ä¢ Financial models that don't account for scaling costs</li>
                     <li>‚Ä¢ Key-person dependencies investors hate</li>
                     <li>‚Ä¢ Regulatory gray areas that are actually red zones</li>
                     <li>‚Ä¢ Technical debt compounding silently</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-red-500 to-orange-500 rounded-xl font-bold">
                  Assess Risks
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-red-900 via-rose-900 to-orange-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üõ°Ô∏è' : grade === 'B' ? '‚ö†Ô∏è' : grade === 'C' ? 'üé≤' : 'üí•'}</div>
               <h2 className="text-xl font-bold mb-2">Risk Assessment Complete</h2>
               <div className="text-3xl font-bold text-red-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Exceptional risk intelligence! You see through surface symptoms to root causes.' :
                   grade === 'B' ? 'Strong risk awareness‚Äîyou catch most hidden dangers.' :
                   grade === 'C' ? 'Some risks slipped by‚Äîstudy the patterns that mask real dangers.' :
                   'Critical gaps in risk detection‚Äîmany startup killers would go unnoticed.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Risk Areas to Study:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-red-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-red-900 via-rose-900 to-orange-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-red-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-red-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-red-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">‚ö†Ô∏è {sc.title}</span>
               <span className="text-red-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-orange-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-red-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-red-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">The Real Risk:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why that's not the primary risk:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-orange-900/30 border border-orange-500/30 rounded-lg p-3">
                        <p className="text-xs text-orange-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-red-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-red-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-red-400 hover:text-red-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- SUSTAINABILITY RENDERER ---
   const SustainabilityRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Greenwashing Temptation",
            context: "Your DTC fashion brand is launching a 'sustainable collection.' Marketing wants to use terms like 'eco-friendly' and 'green' on packaging. Actual changes: 15% recycled materials in packaging (not products), carbon offsets purchased for shipping. Your competitor just faced backlash for similar claims‚Äîthe FTC is cracking down on vague environmental marketing.",
            question: "How should you position your sustainability efforts?",
            opts: [
               "A) Use 'eco-friendly' broadly‚Äîmost customers won't investigate details",
               "B) Make specific, verifiable claims about exactly what you've changed",
               "C) Don't mention sustainability‚Äîavoid the regulatory risk entirely",
               "D) Wait until you're fully sustainable before marketing anything"
            ],
            correct: 1,
            wrongExplanations: [
               "Vague claims like 'eco-friendly' are exactly what the FTC targets. Everlane, H&M, and Allbirds have all faced greenwashing accusations. The short-term marketing gain leads to long-term reputation and legal damage.",
               "",
               "Avoiding sustainability messaging when you ARE making changes misses genuine differentiation opportunity. Customers increasingly demand transparency‚Äîsilence can be as damaging as false claims.",
               "Waiting for 'full' sustainability is unrealistic and delays genuine progress. Customers respect honest communication about a journey more than either silence or false perfection claims."
            ],
            realWorld: "Patagonia's 'Don't Buy This Jacket' campaign succeeded because it was radically honest about consumption. They publish exact environmental impact data, admit shortcomings, and explain improvement plans. Result: $1B+ revenue and fierce customer loyalty. Meanwhile, H&M's 'Conscious Collection' faced lawsuits for misleading claims.",
            concept: "authentic_sustainability",
            why: "Specificity is the antidote to greenwashing. Instead of 'eco-friendly,' say: 'This package uses 15% post-consumer recycled materials.' Instead of 'carbon neutral,' say: 'We offset shipping emissions through verified forest projects in X.' Customers and regulators reward precision; they punish vagueness."
         },
         {
            title: "The Diversity Dilemma",
            context: "Your startup is 18 months old with 25 employees. Looking at the team, 22 employees match the founders' demographics. HR reports 80% of applicants come from the same sources: referrals and 3 tech job boards. The board is asking about diversity metrics for the next funding round. A quick 'diversity hire' could address optics before investor meetings.",
            question: "What's the sustainable approach to building a diverse team?",
            opts: [
               "A) Fast-track a few diverse candidates to improve metrics before fundraising",
               "B) Fix the pipeline first‚Äîchange where and how you recruit",
               "C) Diversity will happen naturally as you grow‚Äîdon't force it",
               "D) Implement strict demographic quotas for all new hires"
            ],
            correct: 1,
            wrongExplanations: [
               "Tokenism creates worse problems than it solves. 'Diversity hires' often feel isolated, receive less mentorship, and leave faster. The optics fix creates a retention problem and doesn't address root causes.",
               "",
               "Data shows diversity doesn't happen 'naturally' in homogeneous environments. Referrals perpetuate existing patterns. Without intervention, you'll be having the same conversation in 5 years at 250 employees.",
               "Quotas without pipeline changes create impossible situations: you can't hit targets if diverse candidates aren't applying. Quotas also create backlash and questions about meritocracy that undermine inclusion."
            ],
            realWorld: "Pinterest published their diversity data publicly and committed to specific pipeline changes: partnering with HBCUs, removing degree requirements, blind resume reviews, and structured interviews. In 5 years, they moved from 1% to 9% Black employees in technical roles. Contrast with companies that set quotas without pipeline work‚Äîthey struggled to hire and faced retention crises.",
            concept: "systemic_diversity",
            why: "Sustainable diversity is systemic, not cosmetic. Change the inputs: where you post jobs, what credentials you require, how you evaluate candidates. Referrals from a homogeneous team produce homogeneous candidates. Diverse pipelines produce diverse teams naturally‚Äîwithout quotas or tokenism."
         },
         {
            title: "The Governance Gamble",
            context: "Your startup raised a $2M seed round and is now raising Series A. Lead investor offers $8M at a $40M valuation‚Äîgreat terms. But they want: board control (2 of 3 seats), protective provisions on major decisions (hiring, spending >$50K, pivots), and participation rights that could block future investors. Your alternative is a $6M offer at $35M with standard terms.",
            question: "How do you evaluate these governance trade-offs?",
            opts: [
               "A) Take the $8M‚Äîmore money is always better",
               "B) The protective provisions create existential risk‚Äîprefer standard terms",
               "C) Negotiate for more money but accept the governance terms",
               "D) Walk away from both and keep bootstrapping"
            ],
            correct: 1,
            wrongExplanations: [
               "More money with hostile governance is a trap. You'll have $8M but can't spend $50K without approval. Board control means they can replace you. You've traded ownership for the illusion of a bigger company.",
               "",
               "Negotiating more money while accepting governance terms still leaves you with the control problems. The governance terms ARE the issue‚Äîmore money doesn't compensate for losing control of your company.",
               "Walking away from both offers isn't strategic‚Äîit's reactive. The $6M with standard terms is a reasonable deal. Bootstrapping indefinitely to avoid any governance trade-offs limits growth potential."
            ],
            realWorld: "WeWork is the cautionary tale: Masayoshi Son of SoftBank pushed aggressive growth, Adam Neumann had dual-class voting control but still lost the company when the board turned. Conversely, Notion turned down funding for years to maintain control, only raising when they found aligned investors. Travis Kalanick at Uber was removed by investors who had accumulated enough board power.",
            concept: "governance_protection",
            why: "Governance determines who controls major decisions. Protective provisions that require investor approval for hiring, spending, and pivots effectively transfer control even if you 'own' majority shares. Standard terms exist because they're battle-tested fair. Non-standard terms usually benefit whoever proposed them."
         },
         {
            title: "The Burn Rate Pressure",
            context: "Your SaaS startup reached profitability at $3M ARR with 15% growth. Your VC investor is unhappy: 'Growth is too slow. You should be at 50%+ growth. Burn your profits to grow faster.' Profitable competitors in your space grow 20-30%. The market leader grows 80% but burns $50M/year. If you accelerate burn, you'll need to raise again within 18 months.",
            question: "What's the economically sustainable path?",
            opts: [
               "A) Follow VC advice‚Äîthey know what successful companies look like",
               "B) Profitable growth at 15-20% is sustainable; aggressive burn is a different business model",
               "C) Compromise: burn half the profits for 30% growth",
               "D) The profitability proves the model is wrong‚Äîpivot to something with more growth potential"
            ],
            correct: 1,
            wrongExplanations: [
               "VCs optimize for portfolio returns, not individual company sustainability. They benefit from 1 company growing 100x, even if 9 die trying. Your incentives are different‚Äîyou need the company to survive and succeed.",
               "",
               "Splitting the difference satisfies no one. You still need to raise again, but now you've also slowed your runway extension. Half-measures in business model decisions usually produce the worst of both worlds.",
               "Profitability at $3M ARR is extremely rare and valuable‚Äîit's not evidence of a bad model. Most SaaS companies at $3M ARR are burning cash. Pivoting away from proven profitability is backwards."
            ],
            realWorld: "Basecamp (37signals) stayed profitable and small while VC-backed project management tools burned billions. They're still profitable 20 years later. Mailchimp reached $12B exit while staying profitable and never raising VC. Meanwhile, WeWork, Uber, and countless 'grow at all costs' companies burned billions and many never achieved sustainable economics.",
            concept: "sustainable_economics",
            why: "Profitability gives you options. Burn rate creates dependency on investors for survival. There's nothing wrong with VC-backed hypergrowth‚Äîbut it's a choice, not a requirement. Profitable companies can wait for the right opportunities; burning companies must take whatever terms the market offers."
         },
         {
            title: "The Customer Revenue Trap",
            context: "Your startup has 10 customers paying $50K/year ($500K ARR). A Fortune 500 company offers a $2M annual contract‚Äîbut requires 12 custom features, dedicated support, and compliance certifications. Your roadmap would be derailed for 6-9 months. The deal would make you profitable and impress investors. But your core product development would stop.",
            question: "How do you evaluate this enterprise opportunity?",
            opts: [
               "A) Take it‚Äî$2M solves most problems and validates enterprise market",
               "B) The customization creates unsustainable dependency‚Äîdecline or negotiate scope",
               "C) Take it but hire more engineers to do both",
               "D) Ask them to wait 12 months until your roadmap allows it"
            ],
            correct: 1,
            wrongExplanations: [
               "Taking unscoped enterprise deals is how startups become service companies. You'll have 1 customer paying 80% of revenue with 12 custom features nobody else wants. If they churn, you're dead. If they stay, you're their custom vendor.",
               "",
               "Hiring to do both sounds logical but rarely works. New engineers take 3-6 months to become productive. The enterprise deadline is fixed. You'll still derail the roadmap AND add burn rate.",
               "Asking them to wait 12 months means losing the deal‚Äîenterprise procurement doesn't wait. This is essentially declining but without the honesty of a clear 'no.'"
            ],
            realWorld: "Zendesk nearly died early on by taking big enterprise deals that required heavy customization. They eventually learned to say no to revenue that didn't fit their product strategy. Stripe famously declined large deals that would have required non-standard integrations, protecting their API consistency that eventually became their moat.",
            concept: "strategic_revenue",
            why: "Not all revenue is equal. Revenue that advances your product strategy is strategic; revenue that derails it is a trap. The question isn't 'Can we do this?' but 'Should we?' Big checks from customers who want you to become their custom vendor is a different business than scalable product revenue."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         authentic_sustainability: "Authentic Sustainability Claims",
         systemic_diversity: "Systemic Diversity Building",
         governance_protection: "Governance Structure Protection",
         sustainable_economics: "Sustainable Business Economics",
         strategic_revenue: "Strategic Revenue Selection"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         esg: { title: "ESG for Startups", content: "ESG (Environmental, Social, Governance) isn't just for corporations. VCs increasingly use ESG screens. Build practices early: carbon tracking, diversity data, board independence. These are easier to establish at 20 employees than retrofit at 200." },
         triple: { title: "Triple Bottom Line", content: "People, Planet, Profit. Sustainable businesses optimize all three, understanding they're interconnected. Employee wellbeing drives productivity. Environmental efficiency reduces costs. Good governance attracts investors. It's not charity‚Äîit's strategy." },
         stakeholder: { title: "Stakeholder Capitalism", content: "Beyond shareholders: employees, customers, communities, environment. Long-term value creation requires considering all stakeholders. Short-term extraction from any group eventually destroys value. Amazon's 'customer obsession' is stakeholder thinking." },
         bcorp: { title: "B Corp Certification", content: "Legal structure that embeds stakeholder consideration into governance. B Corps balance profit with purpose by statute. Requires rigorous impact assessment. Signals commitment but requires ongoing compliance. Consider if it aligns with your mission." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Chose sustainable path`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-6">
               <div className="text-6xl mb-4">üåç</div>
               <h2 className="text-2xl font-bold mb-2">Sustainable Business Lab</h2>
               <p className="text-emerald-300 text-center mb-4 max-w-md">
                  Navigate the tensions between short-term gains and long-term sustainability in ESG, governance, and growth.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll face real trade-offs involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Environmental claims that could backfire legally</li>
                     <li>‚Ä¢ Diversity approaches that create vs solve problems</li>
                     <li>‚Ä¢ Governance terms that determine company control</li>
                     <li>‚Ä¢ Growth pressure from investors vs economic reality</li>
                     <li>‚Ä¢ Revenue that advances vs derails product strategy</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl font-bold">
                  Build Sustainably
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üåü' : grade === 'B' ? 'üåç' : grade === 'C' ? 'üå±' : '‚ö†Ô∏è'}</div>
               <h2 className="text-xl font-bold mb-2">Sustainability Assessment</h2>
               <div className="text-3xl font-bold text-emerald-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Sustainability strategist! You balance short-term pressures with long-term health.' :
                   grade === 'B' ? 'Strong sustainable thinking‚Äîyou see through most short-term temptations.' :
                   grade === 'C' ? 'Some unsustainable patterns‚Äîstudy how short-term gains can create long-term problems.' :
                   'Review sustainability fundamentals‚Äîmany decisions would harm long-term health.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Areas to Strengthen:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-emerald-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-emerald-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-emerald-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-emerald-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">üåç {sc.title}</span>
               <span className="text-emerald-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-teal-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-emerald-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-emerald-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Sustainable Path:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why that's unsustainable:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-emerald-900/30 border border-emerald-500/30 rounded-lg p-3">
                        <p className="text-xs text-emerald-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-emerald-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-emerald-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-emerald-400 hover:text-emerald-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- EXIT STRATEGY RENDERER ---
   const ExitStrategyRenderer = () => {
      const [phase, setPhase] = useState<'intro' | 'play' | 'result'>('intro');
      const [scenario, setScenario] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState<number | null>(null);
      const [answered, setAnswered] = useState(false);
      const [gameLog, setGameLog] = useState<string[]>([]);
      const [showInfo, setShowInfo] = useState(false);
      const [infoTopic, setInfoTopic] = useState<string | null>(null);
      const [conceptGaps, setConceptGaps] = useState<string[]>([]);

      const scenarios = [
         {
            title: "The Earnout Trap",
            context: "Your SaaS startup ($8M ARR, 40% growth) receives an acquisition offer: $60M total, but structured as $35M upfront + $25M earnout over 3 years tied to hitting 50% YoY growth targets. Your current investor owns 35% and is pushing to accept. The acquirer is a large enterprise software company known for slow integration and bureaucracy.",
            question: "What's the critical issue with this deal structure?",
            opts: [
               "A) $60M total is fair‚Äîaccept and hit the earnout targets",
               "B) Earnouts controlled by acquirer create misaligned incentives‚Äîthe targets become nearly impossible",
               "C) Negotiate for $50M all-cash instead",
               "D) The investor pressure means you should take it quickly"
            ],
            correct: 1,
            wrongExplanations: [
               "Earnouts are not guaranteed money. Once acquired, you lose control over resources, hiring, pricing‚Äîeverything that drives growth. The acquirer has incentive to NOT pay the earnout by making targets unreachable.",
               "",
               "Negotiating for less all-cash might work, but $50M vs $35M guaranteed isn't necessarily better. The issue is understanding earnout risk, not just the dollar amount. Some earnout structures are reasonable.",
               "Investor pressure to close quickly is a red flag, not a reason to accept. VCs sometimes push bad deals because returning something beats returning nothing. Your incentives may differ from theirs."
            ],
            realWorld: "Groupon acquired hundreds of daily deal companies with earnouts. Post-acquisition, Groupon changed sales strategies, redirected traffic, and adjusted metrics‚Äîmost earnouts were never paid. Founders who expected $10-50M earnouts often received $0. The acquisition price you negotiate is the price you get; earnouts are negotiating leverage for buyers.",
            concept: "earnout_structure",
            why: "Earnouts transfer risk from buyer to seller. Once acquired, you control nothing: they choose your budget, team, pricing, and strategy. If growth slows (for ANY reason), they don't pay the earnout. Treat earnouts as bonus, not base. If the all-cash portion isn't acceptable alone, the deal isn't acceptable."
         },
         {
            title: "The Acqui-hire Dilemma",
            context: "Your startup has 8 months of runway and no clear path to profitability. A FAANG company offers to acqui-hire your 12-person team: each engineer gets $300K sign-on + $400K/year total comp. Investors would receive $0 (no proceeds after debt). Your lead investor says this 'violates fiduciary duty' to shareholders. The team is exhausted and demoralized.",
            question: "How should you navigate this acqui-hire situation?",
            opts: [
               "A) Reject‚Äîkeep building until you find product-market fit",
               "B) Accept but be transparent‚Äîteam wellbeing matters, and investors knew the risks",
               "C) The fiduciary duty argument means you cannot take this deal",
               "D) Shop the acqui-hire offer to other companies for better terms"
            ],
            correct: 1,
            wrongExplanations: [
               "8 months of runway with no path to profitability means you'll likely hit zero with everyone unemployed. Rejection sacrifices team for a low-probability outcome. Founders who burn out teams for failing companies damage their reputation.",
               "",
               "Fiduciary duty doesn't require destroying team value to chase impossible investor returns. Courts understand that when companies fail, investor returns can be zero. The duty is to make good-faith decisions‚Äîwhich includes considering all stakeholders.",
               "Shopping acqui-hire offers is risky‚Äîword travels fast in tech. The FAANG offer might disappear if they learn you're negotiating with competitors. This is a tactic for strong positions, not desperate ones."
            ],
            realWorld: "When Yahoo acquired Summly for $30M, the 17-year-old founder Nick D'Aloisio prioritized team outcomes. Many acqui-hires at FAANG result in better individual outcomes than failed startups. Reid Hoffman openly discusses how acqui-hires aren't failures‚Äîthey're transitions that preserve value for teams when companies don't work out.",
            concept: "acquihire_ethics",
            why: "Acqui-hires aren't failures‚Äîthey're responsible endings. When a startup can't survive, the choice is: 1) everyone loses their jobs when money runs out, or 2) team lands at good company with real comp. Fiduciary duty doesn't mean suicidal pursuit of investor returns. Transparency and good faith matter more than heroic last stands."
         },
         {
            title: "The Timing Paradox",
            context: "Your startup just closed an incredible quarter: $5M ARR (up from $3M last quarter), 200% YoY growth, major enterprise customer signed. Inbound acquisition interest is at an all-time high‚Äîa strategic buyer is discussing $80M. Your investors say 'don't sell now, you're just getting started.' But you're burning $400K/month with 10 months runway.",
            question: "What's the strategic truth about exit timing?",
            opts: [
               "A) Never sell after your best quarter‚Äîthe trajectory suggests much higher valuations ahead",
               "B) Best time to sell is when you have options‚Äîthis may not last",
               "C) Raise more funding to extend runway and capture the higher valuation",
               "D) The investor advice is correct‚Äîfounders who sell early leave money on the table"
            ],
            correct: 1,
            wrongExplanations: [
               "One great quarter doesn't guarantee future growth. The enterprise customer could churn. Competition could emerge. Macro conditions could shift. 'Trajectory' is a story about the past, not a guarantee about the future.",
               "",
               "Raising at peak momentum might work, but dilution costs are high. More importantly, fundraising takes 6-8 months‚Äîyou might miss the acquisition window and still burn runway. The 'raise and grow bigger' path has risk too.",
               "Investor advice to hold often reflects their incentives, not yours. VCs need big exits to return funds. A $80M exit might be life-changing for you but not meaningful for a $500M fund. Their advice optimizes for their outcomes."
            ],
            realWorld: "Instagram sold to Facebook for $1B at 13 employees with minimal revenue‚Äîseemingly 'too early.' But founders Kevin Systrom and Mike Krieger understood timing. Compare to Snap, which rejected Facebook's $3B offer and later faced brutal public market scrutiny. The 'right' time to exit is when you have leverage, not when you need to.",
            concept: "exit_timing",
            why: "The best time to exit is when you have options‚Äînot when you need to. Momentum creates leverage; desperation destroys it. Consider: What happens if this great quarter doesn't repeat? What's the downside scenario? Upside is theoretical; the exit offer is concrete. Optimism is not strategy."
         },
         {
            title: "The Founder Liquidity Question",
            context: "You've been building for 6 years. Paper net worth: $15M. Reality: salary of $130K, no savings, maxed credit cards during the early years. A secondary investor offers to buy $3M of your shares at the last round's valuation. Your co-founder says 'selling shares signals you don't believe in the company.' The board is neutral but watching.",
            question: "How should you think about founder secondary liquidity?",
            opts: [
               "A) Never sell‚Äîit does signal lack of confidence to investors and team",
               "B) Taking secondary improves decision-making by reducing personal financial pressure",
               "C) Wait for the exit‚Äîall or nothing",
               "D) Only sell if you're planning to leave the company"
            ],
            correct: 1,
            wrongExplanations: [
               "Modern venture practice accepts founder secondary. YC, a]16z, and most sophisticated VCs explicitly support it. The 'never sell' mentality often leads to desperate founders making poor decisions because they need the company to exit for personal financial survival.",
               "",
               "All-or-nothing thinking ignores the reality of founder psychology. 6 years of below-market salary while sitting on illiquid paper wealth creates stress that affects judgment. Waiting indefinitely isn't noble‚Äîit's often irrational.",
               "Secondary and commitment are unrelated. Taking $3M of $15M in liquidity still leaves $12M of alignment. Many of the best founders took secondary to reduce personal stress while continuing to build great companies."
            ],
            realWorld: "Phil Libin, Evernote founder, openly advocates for founder liquidity: 'Founders make better decisions when they're not financially desperate.' Stripe founders took some liquidity while continuing to build. Stewart Butterfield took secondary at Slack years before the exit. It's now standard in later-stage rounds.",
            concept: "founder_liquidity",
            why: "Founder liquidity isn't about belief‚Äîit's about psychology. 6 years of sacrifice creates stress that clouds judgment. Founders who desperately need an exit make worse decisions than those with financial security. Taking 20% off the table while keeping 80% aligned is healthy, not disloyal. Sophisticated investors understand this."
         },
         {
            title: "The Strategic vs Financial Buyer",
            context: "Your developer tools startup ($12M ARR) has two acquisition offers. Microsoft offers $150M all-cash. A private equity firm offers $180M but requires you to stay 4 years and hit aggressive EBITDA targets (from -$2M to +$10M in 3 years). Your team of 45 mostly joined for the mission of developer productivity. Microsoft would integrate you into Azure.",
            question: "How do you compare strategic vs financial buyers?",
            opts: [
               "A) Take the higher PE offer‚Äî$30M more is significant",
               "B) Strategic fit and team outcomes matter as much as price‚Äîevaluate post-acquisition reality",
               "C) Microsoft's bureaucracy will kill the product‚ÄîPE is more aligned",
               "D) Let the team vote on which offer to take"
            ],
            correct: 1,
            wrongExplanations: [
               "The PE offer's $30M premium comes with strings: 4-year commitment, aggressive profitability targets from a money-losing position, likely layoffs to hit EBITDA. After you account for the 4-year lock-in and achievement risk, net value may be lower.",
               "",
               "Microsoft's bureaucracy is real but so is PE's profitability pressure. Going from -$2M to +$10M EBITDA in 3 years usually means cutting R&D and team‚Äîexactly what developer tool people hate. Neither is obviously better; both have trade-offs.",
               "Team votes on major strategic decisions sounds democratic but creates false consensus. Employees don't have full context on deal terms, don't bear the same risks, and shouldn't be burdened with this decision. Leadership decides; transparency follows."
            ],
            realWorld: "GitHub sold to Microsoft for $7.5B despite fears of 'Microsoft bureaucracy killing the product.' Years later, GitHub has grown significantly under Microsoft while maintaining developer trust. Conversely, many PE acquisitions of dev tools have led to price increases, feature cuts, and engineer departures. Neither path is guaranteed‚Äîevaluation is everything.",
            concept: "buyer_types",
            why: "Strategic buyers acquire for synergy‚Äîthey'll change things but also invest. Financial buyers acquire for returns‚Äîthey'll optimize for EBITDA, often through cost cuts. Neither is inherently better. Ask: What happens to my team? What happens to customers? What am I locked into? The headline number is just the start of analysis."
         }
      ];

      const conceptLabels: { [key: string]: string } = {
         earnout_structure: "Earnout Risk Assessment",
         acquihire_ethics: "Acqui-hire Decision Making",
         exit_timing: "Strategic Exit Timing",
         founder_liquidity: "Founder Secondary Liquidity",
         buyer_types: "Strategic vs Financial Buyers"
      };

      const infoTopics: { [k: string]: { title: string; content: string } } = {
         types: { title: "Exit Types", content: "M&A (most common, 90%+ of exits), IPO (rare, <1% of startups), Acqui-hire (team-focused, common for failing startups), Secondary (partial liquidity), SPAC (special purpose acquisition), Management buyout. Each has radically different implications." },
         valuation: { title: "Exit Valuation Drivers", content: "Revenue multiples vary by industry: SaaS 5-15x ARR, marketplace 2-5x GMV. Strategic premium adds 20-50% if buyer has synergies. Competitive tension (multiple bidders) adds 10-30%. Growth rate and profitability path matter enormously." },
         structure: { title: "Deal Structure Terms", content: "All-cash vs stock vs earnout. Escrow holdbacks (10-20% typical). Reps & warranties (liability for misrepresentation). Non-competes (2-4 years typical). Retention packages for team. Founder role and earnout conditions." },
         timing: { title: "Exit Timing Strategy", content: "Best exits come from positions of strength‚Äîgrowing, funded, multiple interested buyers. Worst exits come from desperation‚Äîlow runway, failing metrics, single buyer. Build relationships with potential acquirers before you need them." }
      };

      const sc = scenarios[scenario];

      const answer = (i: number) => {
         if (answered) return;
         setSelected(i);
         setAnswered(true);
         if (i === sc.correct) {
            setScore(s => s + 1);
            setGameLog(l => [...l, `‚úì ${sc.title}: Strategic exit thinking`]);
         } else {
            setGameLog(l => [...l, `‚úó ${sc.title}: ${sc.wrongExplanations[i]}`]);
            if (!conceptGaps.includes(sc.concept)) {
               setConceptGaps(g => [...g, sc.concept]);
            }
         }
      };

      const next = () => {
         if (scenario >= scenarios.length - 1) {
            setPhase('result');
         } else {
            setScenario(s => s + 1);
            setSelected(null);
            setAnswered(false);
         }
      };

      const grade = score >= 5 ? 'A' : score >= 4 ? 'B' : score >= 3 ? 'C' : 'D';

      if (phase === 'intro') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-6">
               <div className="text-6xl mb-4">üö™</div>
               <h2 className="text-2xl font-bold mb-2">Exit Strategy Simulator</h2>
               <p className="text-yellow-300 text-center mb-4 max-w-md">
                  Navigate the complex negotiations of startup exits‚Äîwhere headline valuations hide dangerous deal structures.
               </p>
               <div className="bg-black/30 rounded-lg p-4 mb-6 max-w-md">
                  <p className="text-sm text-slate-300 mb-2">You'll face real exit scenarios involving:</p>
                  <ul className="text-xs text-slate-400 space-y-1">
                     <li>‚Ä¢ Earnouts that sound good but never pay out</li>
                     <li>‚Ä¢ Acqui-hire ethics when companies are failing</li>
                     <li>‚Ä¢ Timing decisions that determine leverage</li>
                     <li>‚Ä¢ Founder liquidity vs 'commitment' narratives</li>
                     <li>‚Ä¢ Strategic vs financial buyer trade-offs</li>
                  </ul>
               </div>
               <button onClick={() => setPhase('play')} className="px-8 py-3 bg-gradient-to-r from-yellow-500 to-amber-500 rounded-xl font-bold">
                  Plan Your Exit
               </button>
            </div>
         );
      }

      if (phase === 'result') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white p-6 overflow-auto">
               <div className="text-5xl mb-3">{grade === 'A' ? 'üèÜ' : grade === 'B' ? 'üö™' : grade === 'C' ? 'üìä' : '‚ö†Ô∏è'}</div>
               <h2 className="text-xl font-bold mb-2">Exit Strategy Assessment</h2>
               <div className="text-3xl font-bold text-yellow-400 mb-1">{score}/{scenarios.length}</div>
               <div className="text-4xl mb-3">{grade}</div>
               <p className="text-slate-400 text-sm mb-3 text-center">
                  {grade === 'A' ? 'Exit expert! You see through deal structures to real value.' :
                   grade === 'B' ? 'Strong exit instincts‚Äîyou understand most deal dynamics.' :
                   grade === 'C' ? 'Some traps would catch you‚Äîstudy earnouts and timing.' :
                   'Review exit fundamentals‚Äîmany common traps would harm your outcome.'}
               </p>
               {conceptGaps.length > 0 && (
                  <div className="w-full max-w-md bg-red-900/30 border border-red-500/30 rounded-lg p-3 mb-3">
                     <p className="text-xs text-red-400 font-semibold mb-2">Exit Concepts to Study:</p>
                     <ul className="text-xs text-red-300 space-y-1">
                        {conceptGaps.map(g => <li key={g}>‚Ä¢ {conceptLabels[g]}</li>)}
                     </ul>
                  </div>
               )}
               <div className="w-full max-w-md bg-black/30 rounded-lg p-3 mb-4 max-h-28 overflow-y-auto">
                  {gameLog.map((l, i) => <p key={i} className="text-xs text-slate-300 mb-1">{l}</p>)}
               </div>
               <button onClick={() => { setPhase('intro'); setScenario(0); setScore(0); setAnswered(false); setSelected(null); setGameLog([]); setConceptGaps([]); }} className="px-6 py-2 bg-yellow-600 rounded-lg">
                  Try Again
               </button>
            </div>
         );
      }

      return (
         <div className="w-full h-full flex flex-col bg-gradient-to-br from-yellow-900 via-amber-900 to-orange-900 text-white overflow-hidden">
            {showInfo && infoTopic && infoTopics[infoTopic] && (
               <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => { setShowInfo(false); setInfoTopic(null); }}>
                  <div className="bg-slate-800 rounded-xl p-4 max-w-sm" onClick={e => e.stopPropagation()}>
                     <h3 className="text-lg font-bold text-yellow-400 mb-2">{infoTopics[infoTopic].title}</h3>
                     <p className="text-sm text-slate-300">{infoTopics[infoTopic].content}</p>
                     <button onClick={() => { setShowInfo(false); setInfoTopic(null); }} className="mt-4 w-full py-2 bg-yellow-600 rounded-lg">Got it!</button>
                  </div>
               </div>
            )}
            <div className="p-3 bg-black/30 border-b border-yellow-500/30 flex justify-between items-center">
               <span className="font-bold text-sm">üö™ {sc.title}</span>
               <span className="text-yellow-400 text-sm">{scenario + 1}/{scenarios.length}</span>
               <span className="text-amber-400 text-sm">Score: {score}</span>
            </div>
            <div className="flex-1 p-4 overflow-auto">
               <div className="bg-black/30 rounded-lg p-3 mb-3">
                  <p className="text-sm text-slate-300">{sc.context}</p>
               </div>
               <div className="bg-yellow-800/30 rounded-lg p-3 mb-3">
                  <p className="font-medium text-sm">{sc.question}</p>
               </div>
               <div className="grid gap-2 mb-3">
                  {sc.opts.map((opt, i) => (
                     <button key={i} onClick={() => answer(i)} disabled={answered} className={`p-3 rounded-lg text-left text-sm transition-all ${answered ? i === sc.correct ? 'bg-green-600' : i === selected ? 'bg-red-600' : 'bg-black/30 opacity-50' : 'bg-black/30 hover:bg-yellow-600/50'}`}>
                        {opt}
                     </button>
                  ))}
               </div>
               {answered && (
                  <div className="space-y-3">
                     <div className="bg-green-900/30 border border-green-500/30 rounded-lg p-3">
                        <p className="text-xs text-green-400 font-semibold mb-1">Exit Strategy Insight:</p>
                        <p className="text-sm text-slate-300">{sc.why}</p>
                     </div>
                     {selected !== sc.correct && sc.wrongExplanations[selected!] && (
                        <div className="bg-red-900/30 border border-red-500/30 rounded-lg p-3">
                           <p className="text-xs text-red-400 font-semibold mb-1">Why that's risky:</p>
                           <p className="text-sm text-slate-300">{sc.wrongExplanations[selected!]}</p>
                        </div>
                     )}
                     <div className="bg-yellow-900/30 border border-yellow-500/30 rounded-lg p-3">
                        <p className="text-xs text-yellow-400 font-semibold mb-1">üìä Real World:</p>
                        <p className="text-sm text-slate-300">{sc.realWorld}</p>
                     </div>
                     <button onClick={next} className="w-full py-2 bg-yellow-600 rounded-lg font-medium">
                        {scenario >= scenarios.length - 1 ? 'See Results' : 'Next Scenario'}
                     </button>
                  </div>
               )}
            </div>
            <div className="p-2 bg-black/30 border-t border-yellow-500/30 flex gap-2 justify-center flex-wrap">
               {Object.keys(infoTopics).map(k => (
                  <button key={k} onClick={() => { setInfoTopic(k); setShowInfo(true); }} className="text-xs text-yellow-400 hover:text-yellow-300">
                     ‚ÑπÔ∏è {infoTopics[k].title}
                  </button>
               ))}
            </div>
         </div>
      );
   };

   // --- GENERIC RENDERER ---
   const GenericRenderer = () => {
      if (type === 'poster' || type === 'infographic') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center p-8 bg-slate-900/5">
               <div className="relative rounded-2xl overflow-hidden shadow-2xl border-[12px] border-white bg-slate-900 max-w-4xl max-h-full group">
                  <img src={parsedData?.data || parsedData} className="max-w-full max-h-[70vh] object-contain transition-transform duration-700 group-hover:scale-105" alt="Artifact" />
               </div>
            </div>
         );
      }

      // Debug fallback for unrecognized types
      console.warn("GeneratedDiagram: Unrecognized type", type, "with data:", data);
      return (
         <div className="p-8 text-center">
            <p className="text-slate-400 font-serif italic mb-4">Rendering visual artifact...</p>
            <p className="text-xs text-slate-300">Type: <code className="bg-slate-100 px-1 rounded">{type}</code></p>
            {parsedData === null && <p className="text-xs text-red-400 mt-2">Error: Failed to parse diagram data.</p>}
         </div>
      );
   };



   const renderVisual = () => {
      switch (type) {
         case 'dynamic_blueprint': return <DynamicBlueprintRenderer />;
         case 'rocket': return <RocketEngineRenderer />;
         case 'projectile': return <ProjectileRenderer />;
         case 'compound_interest': return <CompoundInterestRenderer />;
         case 'supply_demand': return <SupplyDemandRenderer />;
         case 'pendulum': return <PendulumRenderer />;
         case 'waves': return <WaveInterferenceRenderer />;
         case 'circuits': return <CircuitRenderer />;
         case 'sorting':
            return <SortingRenderer />;
         case 'addition':
            return <AdditionRenderer />;
         case 'subtraction':
            return <SubtractionRenderer />;
         case 'multiplication':
            return <MultiplicationRenderer />;
         case 'division':
            return <DivisionRenderer />;
         case 'fractions':
            return <FractionRenderer />;
         case 'area':
            return <AreaRenderer />;
         case 'triangle':
            return <TriangleRenderer />;
         case 'force_lab':
            return <ForceLabRenderer />;
         case 'energy_coaster':
            return <EnergyCoasterRenderer />;
         case 'atomic_builder':
            return <AtomicBuilderRenderer />;
         case 'equation_balancer':
            return <EquationBalancerRenderer />;
         case 'gas_law':
            return <GasLawRenderer />;
         case 'advanced_force_lab':
            return <AdvancedForceLabRenderer />;
         case 'newton_third_law':
            return <NewtonThirdLawRenderer />;
         case 'net_force':
            return <NetForceRenderer />;
         case 'gravity_acceleration':
            return <GravityAccelerationRenderer />;
         case 'force_classification':
            return <ForceClassificationRenderer />;
         case 'stress_response':
            return <StressResponseRenderer />;
         case 'posture_analyzer':
            return <PostureAnalyzerRenderer />;
         case 'heart_rate_zones':
            return <HeartRateZoneRenderer />;
         case 'plate_method':
            return <PlateMethodRenderer />;
         case 'breathing_guide':
            return <BreathingGuideRenderer />;
         case 'gravitational_pe':
            return <GravitationalPERenderer />;
         case 'chemical_pe':
            return <ChemicalPERenderer />;
         case 'energy_conservation':
            return <EnergyConservationRenderer />;
         case 'machine_efficiency':
            return <MachineEfficiencyRenderer />;
         case 'convection':
            return <ConvectionRenderer />;
         case 'specific_heat':
            return <SpecificHeatRenderer />;
         case 'latent_heat':
            return <LatentHeatRenderer />;
         case 'entropy':
            return <EntropyRenderer />;
         case 'heat_engine':
            return <HeatEngineRenderer />;
         case 'light_transmission':
            return <LightTransmissionRenderer />;
         case 'light_absorption':
            return <LightAbsorptionRenderer />;
         case 'digital_signal':
            return <DigitalSignalRenderer />;
         case 'wave_equation':
            return <WaveEquationRenderer />;
         case 'superposition':
            return <SuperpositionRenderer />;
         case 'wave_interference':
            return <WaveInterference2DRenderer />;
         case 'standing_wave':
            return <StandingWaveRenderer />;
         case 'resonance':
            return <ResonanceRenderer />;
         case 'doppler_effect':
            return <DopplerEffectRenderer />;
         case 'snells_law':
            return <SnellsLawRenderer />;
         case 'tir':
            return <TIRRenderer />;
         case 'lens':
            return <LensRenderer />;
         case 'mirror':
            return <MirrorRenderer />;
         case 'ray_tracing':
            return <RayTracingLabRenderer />;
         case 'polarization':
            return <PolarizationRenderer />;
         case 'diffraction':
            return <DiffractionRenderer />;
         case 'dispersion':
            return <DispersionRenderer />;
         case 'thin_film':
            return <ThinFilmRenderer />;
         case 'wave_particle_duality':
            return <WaveParticleDualityRenderer />;
         case 'photoelectric_effect':
            return <PhotoelectricEffectRenderer />;
         case 'laser':
            return <LaserRenderer />;
         case 'acoustic_levitation':
            return <AcousticLevitationRenderer />;
         case 'fiber_optics':
            return <FiberOpticsRenderer />;
         case 'static_balloon':
            return <StaticBalloonRenderer />;
         case 'circuit_builder_basic':
            return <CircuitBuilderBasicRenderer />;
         case 'magnet_maze':
            return <MagnetMazeRenderer />;
         case 'electromagnet_basic':
            return <ElectromagnetBasicRenderer />;
         case 'conductivity_tester':
            return <ConductivityTesterRenderer />;
         case 'simple_switch':
            return <SimpleSwitchRenderer />;
         case 'magnetic_pole':
            return <MagneticPoleRenderer />;
         case 'attract_repel':
            return <AttractRepelRenderer />;
         case 'compass':
            return <CompassRenderer />;
         case 'magnetic_material':
            return <MagneticMaterialRenderer />;
         case 'series_circuit':
            return <SeriesCircuitRenderer />;
         case 'parallel_circuit':
            return <ParallelCircuitRenderer />;
         case 'voltage_potential':
            return <VoltagePotentialRenderer />;
         case 'current_flow':
            return <CurrentFlowRenderer />;
         case 'ohms_law':
            return <OhmsLawRenderer />;
         case 'electromagnet':
            return <ElectromagnetRenderer />;
         case 'basic_motor':
            return <BasicMotorRenderer />;
         case 'basic_generator':
            return <BasicGeneratorRenderer />;
         case 'earth_field':
            return <EarthFieldRenderer />;
         case 'household_safety':
            return <HouseholdSafetyRenderer />;
         case 'coulombs_law':
            return <CoulombsLawRenderer />;
         case 'electric_field':
            return <ElectricFieldRenderer />;
         case 'capacitor_lab':
            return <CapacitorLabRenderer />;
         case 'rlc_circuit':
            return <RLCCircuitRenderer />;
         case 'faradays_law':
            return <FaradaysLawRenderer />;
         case 'magnetic_flux':
            return <MagneticFluxRenderer />;
         case 'lenzs_law':
            return <LenzsLawRenderer />;
         case 'battery_connections':
            return <BatteryConnectionsRenderer />;
         case 'bulb_power':
            return <BulbPowerRenderer />;
         case 'multi_step_equations':
            return <MultiStepEquationsRenderer />;
         case 'variables_both_sides':
            return <VariablesBothSidesRenderer />;
         case 'linear_inequalities':
            return <LinearInequalitiesRenderer />;
         case 'inequalities_number_line':
            return <InequalitiesNumberLineRenderer />;
         case 'independent_dependent_variables':
            return <IndependentDependentVariablesRenderer />;
         case 'counting_100':
            return <Counting100Renderer />;
         case 'one_to_one_correspondence':
            return <OneToOneCorrespondenceRenderer />;
         case 'subitizing':
            return <SubitizingRenderer />;
         case 'place_value_tens_ones':
            return <PlaceValueTensOnesRenderer />;
         case 'addition_putting_together':
            return <AdditionPuttingTogetherRenderer />;
         case 'subtraction_taking_apart':
            return <SubtractionTakingApartRenderer />;
         case 'fact_families':
            return <FactFamiliesRenderer />;
         case 'positive_negative_intro':
            return <PositiveNegativeIntroRenderer />;
         case 'skip_counting':
            return <SkipCountingRenderer />;
         case 'fraction_intro':
            return <FractionIntroRenderer />;
         case 'multiplication_repeated_addition':
            return <MultiplicationRepeatedAdditionRenderer />;
         case 'division_fair_sharing':
            return <DivisionFairSharingRenderer />;
         case 'multi_digit_addition_regrouping':
            return <MultiDigitAdditionRegroupingRenderer />;
         case 'multi_digit_subtraction_borrowing':
            return <MultiDigitSubtractionBorrowingRenderer />;
         case 'multiplication_tables':
            return <MultiplicationTablesRenderer />;
         case 'z_score':
            return <ZScoreRenderer />;
         case 'correlation_coefficient':
            return <CorrelationCoefficientRenderer />;
         case 'combinations_permutations':
            return <CombinationsPermutationsRenderer />;
         case 'conditional_probability':
            return <ConditionalProbabilityRenderer />;
         case 'margin_of_error':
            return <MarginOfErrorRenderer />;
         // Plural/variant type mappings to existing renderers
         case 'metal_conductors':
            return <ConductivityTesterRenderer />;
         case 'insulators':
            return <ConductivityTesterRenderer />;
         case 'simple_switches':
            return <SimpleSwitchRenderer />;
         case 'magnetic_poles':
            return <MagneticPoleRenderer />;
         case 'compass_use':
            return <CompassRenderer />;
         case 'electromagnets':
            return <ElectromagnetRenderer />;
         case 'basic_motors':
            return <BasicMotorRenderer />;
         case 'basic_generators':
            return <BasicGeneratorRenderer />;
         case 'earth_magnetic_field':
            return <EarthFieldRenderer />;
         case 'lorentz_force':
            return <LorentzForceRenderer />;
         case 'inductance':
            return <InductanceRenderer />;
         case 'transformers':
            return <TransformersRenderer />;
         case 'day_night_cycle':
            return <DayNightCycleRenderer />;
         case 'moon_phases':
            return <MoonPhasesRenderer />;
         case 'time_dilation':
            return <TimeDilationRenderer />;
         case 'atom_structure':
            return <AtomStructureRenderer />;
         case 'solenoid':
            return <InductanceRenderer />;
         case 'seasons':
            return <DayNightCycleRenderer />;
         case 'solar_system':
            return <MoonPhasesRenderer />;
         case 'isotopes':
            return <AtomStructureRenderer />;
         case 'length_contraction':
            return <TimeDilationRenderer />;
         case 'mass_energy':
            return <TimeDilationRenderer />;
         // ============================================
         // ENTREPRENEURSHIP GRAPHICS (50)
         // ============================================
         // Mindset & Foundational Skills (10)
         case 'growth_mindset':
            return <GrowthMindsetRenderer />;
         case 'opportunity_recognition':
            return <OpportunityRecognitionRenderer />;
         case 'calculated_risk':
            return <CalculatedRiskRenderer />;
         case 'resilience_grit':
            return <ResilienceGritRenderer />;
         case 'scamper_creativity':
            return <ScamperCreativityRenderer />;
         case 'critical_thinking':
            return <CriticalThinkingRenderer />;
         case 'self_reliance':
            return <SelfRelianceRenderer />;
         case 'adaptability_pivot':
            return <AdaptabilityPivotRenderer />;
         case 'empathy_mapping':
            return <EmpathyMappingRenderer />;
         case 'ethical_leadership':
            return <EthicalLeadershipRenderer />;
         // Ideation & Design Thinking (10)
         case 'design_thinking':
            return <DesignThinkingRenderer />;
         case 'problem_solution_fit':
            return <ProblemSolutionFitRenderer />;
         case 'customer_discovery':
            return <CustomerDiscoveryRenderer />;
         case 'user_personas':
            return <UserPersonasRenderer />;
         case 'value_proposition':
            return <ValuePropositionRenderer />;
         case 'prototyping':
            return <PrototypingRenderer />;
         case 'iterative_design':
            return <IterativeDesignRenderer />;
         case 'blue_ocean':
            return <BlueOceanRenderer />;
         case 'trend_analysis':
            return <TrendAnalysisRenderer />;
         case 'first_principles':
            return <FirstPrinciplesRenderer />;
         // Business Models & Strategy (10)
         case 'lean_canvas':
            return <LeanCanvasRenderer />;
         case 'business_model_canvas':
            return <BusinessModelCanvasRenderer />;
         case 'b2b_vs_b2c':
            return <B2bVsB2cRenderer />;
         case 'revenue_models':
            return <RevenueModelsRenderer />;
         case 'unit_economics':
            return <UnitEconomicsRenderer />;
         case 'cac_calculator':
            return <CacCalculatorRenderer />;
         case 'ltv_calculator':
            return <LtvCalculatorRenderer />;
         case 'scalability':
            return <ScalabilityRenderer />;
         case 'franchising':
            return <FranchisingRenderer />;
         case 'social_enterprise':
            return <SocialEnterpriseRenderer />;
         // Marketing & Sales (10)
         case 'four_ps_marketing':
            return <FourPsMarketingRenderer />;
         case 'branding_identity':
            return <BrandingIdentityRenderer />;
         case 'digital_marketing':
            return <DigitalMarketingRenderer />;
         case 'content_strategy':
            return <ContentStrategyRenderer />;
         case 'email_marketing':
            return <EmailMarketingRenderer />;
         case 'influencer_marketing':
            return <InfluencerMarketingRenderer />;
         case 'sales_funnel':
            return <SalesFunnelRenderer />;
         case 'public_relations':
            return <PublicRelationsRenderer />;
         case 'guerrilla_marketing':
            return <GuerrillaMarketingRenderer />;
         case 'copywriting':
            return <CopywritingRenderer />;
         // Financial Literacy (10)
         case 'bootstrapping':
            return <BootstrappingRenderer />;
         case 'cash_flow':
            return <CashFlowRenderer />;
         case 'profit_loss':
            return <ProfitLossRenderer />;
         case 'break_even':
            return <BreakEvenRenderer />;
         case 'pricing_strategies':
            return <PricingStrategiesRenderer />;
         case 'equity_ownership':
            return <EquityOwnershipRenderer />;
         case 'angel_investors':
            return <AngelInvestorsRenderer />;
         case 'venture_capital':
            return <VentureCapitalRenderer />;
         case 'crowdfunding':
            return <CrowdfundingRenderer />;
         case 'pitch_deck':
            return <PitchDeckRenderer />;
         // ============================================
         // ENTREPRENEURSHIP GRAPHICS PART 2 (50)
         // Section VI: Operations & Management
         // ============================================
         case 'supply_chain':
            return <SupplyChainRenderer />;
         case 'inventory_management':
            return <InventoryManagementRenderer />;
         case 'outsourcing':
            return <OutsourcingRenderer />;
         case 'hiring':
            return <HiringRenderer />;
         case 'project_management':
            return <ProjectManagementRenderer />;
         case 'quality_control':
            return <QualityControlRenderer />;
         case 'customer_success':
            return <CustomerSuccessRenderer />;
         case 'agile':
            return <AgileRenderer />;
         case 'time_management':
            return <TimeManagementRenderer />;
         case 'business_structures':
            return <BusinessStructuresRenderer />;
         case 'intellectual_property':
            return <IntellectualPropertyRenderer />;
         case 'contracts':
            return <ContractsRenderer />;
         case 'permits':
            return <PermitsRenderer />;
         case 'employment_law':
            return <EmploymentLawRenderer />;
         case 'ecommerce':
            return <EcommerceRenderer />;
         case 'social_media':
            return <SocialMediaRenderer />;
         case 'seo':
            return <SEORenderer />;
         case 'analytics':
            return <AnalyticsRenderer />;
         case 'cybersecurity':
            return <CybersecurityRenderer />;
         case 'elevator_pitch':
            return <ElevatorPitchRenderer />;
         case 'networking':
            return <NetworkingRenderer />;
         case 'branding':
            return <BrandingRenderer />;
         case 'public_relations':
            return <PublicRelationsRenderer />;
         case 'negotiation':
            return <NegotiationRenderer />;
         case 'fundraising':
            return <FundraisingRenderer />;
         case 'financial_statements':
            return <FinancialStatementsRenderer />;
         case 'accounting_equation':
            return <AccountingEquationRenderer />;
         case 'double_entry_bookkeeping':
            return <DoubleEntryBookkeepingRenderer />;
         case 'gaap_compliance':
            return <GAAPComplianceRenderer />;
         case 'gaap_vs_ifrs':
            return <GAAPvsIFRSRenderer />;
         case 'chart_of_accounts':
            return <ChartOfAccountsRenderer />;
         case 'general_ledger':
            return <GeneralLedgerRenderer />;
         case 'accounts_payable':
            return <AccountsPayableRenderer />;
         case 'accounts_receivable':
            return <AccountsReceivableRenderer />;
         case 'bank_reconciliation':
            return <BankReconciliationRenderer />;
         case 'balance_sheet':
            return <BalanceSheetRenderer />;
         case 'income_statement':
            return <IncomeStatementRenderer />;
         case 'cash_flow_statement':
            return <CashFlowStatementRenderer />;
         case 'retained_earnings':
            return <RetainedEarningsRenderer />;
         case 'accrual_cash_basis':
            return <AccrualCashBasisRenderer />;
         case 'depreciation_methods':
            return <DepreciationMethodsRenderer />;
         case 'amortization':
            return <AmortizationRenderer />;
         case 'inventory_valuation':
            return <InventoryValuationRenderer />;
         case 'cogs_calculation':
            return <COGSCalculationRenderer />;
         case 'profit_margin':
            return <ProfitMarginRenderer />;
         case 'financial_ratio_analysis':
            return <FinancialRatioAnalysisRenderer />;
         case 'working_capital':
            return <WorkingCapitalManagementRenderer />;
         case 'budget_forecast':
            return <BudgetForecastRenderer />;
         case 'variance_analysis':
            return <VarianceAnalysisRenderer />;
         case 'zero_based_budget':
            return <ZeroBasedBudgetRenderer />;
         case 'capex_opex':
            return <CapExOpExRenderer />;
         case 'fixed_variable_costs':
            return <FixedVariableCostsRenderer />;
         case 'break_even_analysis':
            return <BreakEvenAnalysisRenderer />;
         case 'internal_controls':
            return <InternalControlsRenderer />;
         case 'audit_prep':
            return <AuditPrepRenderer />;
         case 'tax_structures':
            return <TaxStructuresRenderer />;
         case 'sales_tax_nexus':
            return <SalesTaxNexusRenderer />;
         case 'payroll_processing':
            return <PayrollProcessingRenderer />;
         case 'time_value_money':
            return <TimeValueMoneyRenderer />;
         case 'npv_irr':
            return <NpvIrrRenderer />;
         case 'equity_debt_financing':
            return <EquityDebtFinancingRenderer />;
         case 'wacc':
            return <WaccRenderer />;
         case 'stock_options':
            return <StockOptionsRenderer />;
         case 'dividend_policy':
            return <DividendPolicyRenderer />;
         case 'financial_modeling':
            return <FinancialModelingRenderer />;
         case 'cloud_accounting':
            return <CloudAccountingRenderer />;
         case 'erp_basics':
            return <ErpBasicsRenderer />;
         case 'audit_trails':
            return <AuditTrailsRenderer />;
         case 'forensic_accounting':
            return <ForensicAccountingRenderer />;
         case 'cvp_analysis':
            return <CvpAnalysisRenderer />;
         case 'managerial_accounting':
            return <ManagerialAccountingRenderer />;
         case 'financial_statement_auditing':
            return <FinancialStatementAuditingRenderer />;
         case 'esg_reporting':
            return <EsgReportingRenderer />;
         case 'crypto_accounting':
            return <CryptoAccountingRenderer />;
         case 'tax_credits':
            return <TaxCreditsRenderer />;
         case 'fractional_cfo':
            return <FractionalCfoRenderer />;
         case 'aso_keywords':
            return <AsoKeywordsRenderer />;
         case 'aso_creative_optimization':
            return <AsoCreativeOptimizationRenderer />;
         case 'apple_search_ads':
            return <AppleSearchAdsRenderer />;
         case 'google_uac':
            return <GoogleUacRenderer />;
         case 'cpi_model':
            return <CpiModelRenderer />;
         case 'social_media_ads':
            return <SocialMediaAdsRenderer />;
         case 'viral_loops':
            return <ViralLoopsRenderer />;
         case 'referral_programs':
            return <ReferralProgramsRenderer />;
         case 'push_notifications':
            return <PushNotificationsRenderer />;
         case 'in_app_messaging':
            return <InAppMessagingRenderer />;
         case 'email_marketing_for_apps':
            return <EmailMarketingForAppsRenderer />;
         case 'retention_metrics':
            return <RetentionMetricsRenderer />;
         case 'cohort_analysis':
            return <CohortAnalysisRenderer />;
         case 'mobile_ab_testing':
            return <MobileABTestingRenderer />;
         case 'user_segmentation':
            return <UserSegmentationRenderer />;
         case 'pricing_strategy':
            return <PricingStrategyRenderer />;
         case 'budgeting':
            return <BudgetingRenderer />;
         case 'unit_economics':
            return <UnitEconomicsRenderer />;
         case 'market_research':
            return <MarketResearchRenderer />;
         case 'competitive_analysis':
            return <CompetitiveAnalysisRenderer />;
         case 'business_model':
            return <BusinessModelRenderer />;
         case 'growth_strategy':
            return <GrowthStrategyRenderer />;
         case 'pivot_decision':
            return <PivotDecisionRenderer />;
         case 'team_building':
            return <TeamBuildingRenderer />;
         case 'leadership':
            return <LeadershipRenderer />;
         case 'customer_journey':
            return <CustomerJourneyRenderer />;
         case 'mvp':
            return <MVPRenderer />;
         case 'risk_assessment':
            return <RiskAssessmentRenderer />;
         case 'sustainability':
            return <SustainabilityRenderer />;
         case 'exit_strategy':
            return <ExitStrategyRenderer />;
         case 'business_structures':
            return <BusinessStructuresRenderer />;
         default:
            return <GenericRenderer />;
      }
   };

   return (
      <div className="h-full flex flex-col bg-[#F8FAFC]">
         <div className="flex-1 overflow-auto custom-scrollbar relative">
            {renderVisual()}
         </div>
         <div className="px-6 py-3 bg-white border-t border-slate-200 text-[10px] text-slate-500 font-medium flex gap-2 items-center justify-center shrink-0">
            <i className="fa-solid fa-brain text-indigo-500"></i>
            <span className="font-serif italic opacity-80">{parsedData?.insight || "Interactive model generated by Atlas Core."}</span>
         </div>
      </div>
   );
};

export default GeneratedDiagram;
