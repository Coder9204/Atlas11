
import React, { useMemo, useState, useEffect, useRef } from 'react';

interface DiagramProps {
   type: string;
   data: string | any;
   title: string;
}

// --- DYNAMIC BLUEPRINT ENGINE TYPES ---
interface BlueprintVariable {
   label: string;
   min: number;
   max: number;
   value: number;
   step?: number;
   unit?: string;
}

interface BlueprintElement {
   type: 'rect' | 'circle' | 'line' | 'text' | 'emoji' | 'path';
   id: string;
   attributes: Record<string, string | number>; // Values can be formulas e.g., "variables.x * 2"
   content?: string;
}

interface BlueprintChallenge {
   goal: string; // Formula evaluating to boolean, e.g. "variables.x > 10 && variables.x < 20"
   constraints?: { label: string, condition: string }[]; // Conditions that must be met
   feedback: { success: string, failure: string };
}

interface BlueprintData {
   scenario: string;
   variables: Record<string, BlueprintVariable>;
   calculations?: Record<string, string>;
   elements: BlueprintElement[];
   challenge?: BlueprintChallenge;
   insight: string;
}

const GeneratedDiagram: React.FC<DiagramProps> = ({ type, data, title }) => {
   const parsedData = useMemo(() => {
      console.log("[GeneratedDiagram] Received:", { type, data: typeof data, title });

      if (!data) {
         console.warn("[GeneratedDiagram] No data provided");
         return null;
      }

      try {
         // If data is already an object (not a string), use it directly
         if (typeof data === 'object') {
            console.log("[GeneratedDiagram] Data is already an object:", data);
            return data;
         }

         // Try to parse JSON string
         const parsed = JSON.parse(data);
         console.log("[GeneratedDiagram] Parsed data:", parsed);
         return parsed;
      } catch (e) {
         console.error("[GeneratedDiagram] JSON parse error:", e, "Raw data:", data);
         return null;
      }
   }, [data]);

   // --- DYNAMIC BLUEPRINT RENDERER ---
   const DynamicBlueprintRenderer = () => {
      const blueprint = parsedData as BlueprintData;

      // Validation: Ensure blueprint has required fields
      if (!blueprint || !blueprint.variables || !blueprint.elements) {
         return (
            <div className="h-full flex flex-col items-center justify-center p-8 bg-amber-50">
               <div className="max-w-md text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-100 flex items-center justify-center">
                     <i className="fa-solid fa-triangle-exclamation text-2xl text-amber-600"></i>
                  </div>
                  <h3 className="text-lg font-bold text-slate-800 mb-2">Blueprint Data Issue</h3>
                  <p className="text-sm text-slate-600 mb-4">The interactive graphic couldn't be rendered due to missing or invalid data.</p>
                  <div className="text-left bg-white p-4 rounded-lg border border-amber-200 text-xs font-mono overflow-auto max-h-48">
                     <p className="text-amber-700 mb-2">Expected: variables, elements, scenario</p>
                     <p className="text-slate-500">Received: {JSON.stringify(blueprint, null, 2).slice(0, 300)}...</p>
                  </div>
               </div>
            </div>
         );
      }

      // Initialize state from blueprint defaults
      const [variables, setVariables] = useState<Record<string, number>>(() => {
         const init: Record<string, number> = {};
         Object.entries(blueprint.variables || {}).forEach(([key, conf]) => {
            init[key] = conf.value;
         });
         return init;
      });

      const [challengeState, setChallengeState] = useState<'idle' | 'success' | 'failure'>('idle');
      const [feedbackMsg, setFeedbackMsg] = useState<string>("");

      // Helper: Safe evaluation of formulas
      const evaluateFormula = (formula: string | number): any => {
         if (typeof formula === 'number') return formula;
         if (!formula || (!formula.includes('variables') && !formula.includes('Math') && !formula.includes('calculations'))) return formula;

         try {
            const calculatedValues: Record<string, number> = {};
            if (blueprint.calculations) {
               Object.entries(blueprint.calculations).forEach(([key, calcFormula]) => {
                  try {
                     const func = new Function('variables', 'Math', `return ${calcFormula}`);
                     calculatedValues[key] = func(variables, Math);
                  } catch (e) { calculatedValues[key] = 0; }
               });
            }

            const func = new Function('variables', 'calculations', 'Math', `return ${formula}`);
            return func(variables, calculatedValues, Math);
         } catch (e) {
            return 0;
         }
      };

      // Check Challenge Status
      useEffect(() => {
         if (!blueprint.challenge) return;

         const isGoalMet = evaluateFormula(blueprint.challenge.goal);
         const constraintsMet = blueprint.challenge.constraints ? blueprint.challenge.constraints.every(c => evaluateFormula(c.condition)) : true;

         if (isGoalMet && constraintsMet) {
            setChallengeState('success');
            setFeedbackMsg(blueprint.challenge.feedback.success);
         } else if (!constraintsMet) {
            // Find which constraint failed
            const failed = blueprint.challenge.constraints?.find(c => !evaluateFormula(c.condition));
            setChallengeState('failure');
            setFeedbackMsg(failed ? `Constraint Violated: ${failed.label}` : blueprint.challenge.feedback.failure);
         } else {
            setChallengeState('idle');
            setFeedbackMsg("");
         }
      }, [variables, blueprint.challenge]);

      // Derived calculations for display
      const currentCalculations = useMemo(() => {
         const calc: Record<string, number> = {};
         if (blueprint.calculations) {
            Object.entries(blueprint.calculations).forEach(([key, formula]) => {
               calc[key] = Number(evaluateFormula(formula)); // Re-use eval logic
            });
         }
         return calc;
      }, [variables, blueprint.calculations]);


      return (
         <div className="w-full h-full bg-slate-50 flex flex-col md:flex-row overflow-hidden relative">
            {/* VISUALIZATION CANVAS */}
            <div className="flex-1 relative flex items-center justify-center p-8 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
               <div className="relative z-10 w-full max-w-2xl aspect-[4/3] bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                  <svg viewBox="0 0 800 600" className="w-full h-full">
                     <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                           <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f1f5f9" strokeWidth="1" />
                        </pattern>
                     </defs>
                     <rect width="100%" height="100%" fill="url(#grid)" />

                     {/* Render Dynamic Elements */}
                     {blueprint.elements?.map((el, i) => {
                        // Evaluate all dynamic attributes
                        const attrs: any = {};
                        Object.entries(el.attributes || {}).forEach(([attrKey, attrVal]) => {
                           attrs[attrKey] = evaluateFormula(attrVal);
                        });

                        // React key
                        const key = el.id || i;

                        switch (el.type) {
                           case 'rect':
                              return <rect key={key} {...attrs} />;
                           case 'circle':
                              return <circle key={key} {...attrs} />;
                           case 'line':
                              return <line key={key} {...attrs} strokeLinecap="round" />;
                           case 'text':
                              // Support template syntax: "Thrust: {{calculations.thrust}} N"
                              let textContent = el.content || attrs.text || '';
                              if (typeof textContent === 'string' && textContent.includes('{{')) {
                                 textContent = textContent.replace(/\{\{([^}]+)\}\}/g, (_, expr) => {
                                    const val = evaluateFormula(expr.trim());
                                    return typeof val === 'number' ? val.toFixed(1) : val;
                                 });
                              } else if (typeof textContent === 'string' && (textContent.includes('calculations.') || textContent.includes('variables.'))) {
                                 // If it's just a formula without template
                                 const val = evaluateFormula(textContent);
                                 textContent = typeof val === 'number' ? val.toFixed(1) : val;
                              }
                              return <text key={key} {...attrs} textAnchor="middle" alignmentBaseline="middle">{textContent}</text>;
                           case 'emoji':
                              return (
                                 <text key={key} x={attrs.x} y={attrs.y} fontSize={attrs.fontSize || 40} textAnchor="middle" alignmentBaseline="middle">
                                    {el.content}
                                 </text>
                              );
                           default: return null;
                        }
                     })}
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full md:w-80 bg-white border-l border-slate-100 p-6 flex flex-col gap-6 shadow-[-10px_0_40px_rgba(0,0,0,0.02)] z-20 overflow-y-auto">
               <div className="mb-2">
                  <h3 className="text-xs font-black text-indigo-500 uppercase tracking-widest mb-1">Interactive Lab</h3>
                  <p className="text-lg font-serif font-bold text-slate-800 leading-tight">{blueprint.scenario}</p>
               </div>

               {/* Variable Controls */}
               <div className="space-y-6">
                  {Object.entries(blueprint.variables || {}).map(([key, conf]) => (
                     <div key={key}>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-500 uppercase">{conf.label}</label>
                           <span className="text-xs font-mono font-bold text-indigo-600">
                              {variables[key]} <span className="text-slate-400">{conf.unit}</span>
                           </span>
                        </div>
                        <input
                           type="range"
                           min={conf.min} max={conf.max} step={conf.step || 1}
                           value={variables[key]}
                           onChange={(e) => setVariables(prev => ({ ...prev, [key]: Number(e.target.value) }))}
                           className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                        />
                     </div>
                  ))}
               </div>

               {/* Live Calculations */}
               {Object.keys(currentCalculations).length > 0 && (
                  <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 space-y-2">
                     <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Real-time Metrics</div>
                     {Object.entries(currentCalculations).map(([key, val]) => (
                        <div key={key} className="flex justify-between items-center">
                           <span className="text-xs font-medium text-slate-600 capitalize">{key.replace(/_/g, ' ')}</span>
                           <span className="text-sm font-mono font-bold text-slate-900">{typeof val === 'number' ? val.toFixed(1) : val}</span>
                        </div>
                     ))}
                  </div>
               )}

               <div className="mt-auto pt-6 border-t border-slate-100">
                  {/* Challenge Feedback */}
                  {blueprint.challenge && (
                     <div className={`mb-4 p-3 rounded-xl border ${challengeState === 'success' ? 'bg-green-50 border-green-200 text-green-800' : challengeState === 'failure' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                        <div className="flex items-center gap-2 mb-1">
                           <i className={`fa-solid ${challengeState === 'success' ? 'fa-check-circle' : challengeState === 'failure' ? 'fa-triangle-exclamation' : 'fa-circle-question'}`}></i>
                           <span className="text-xs font-black uppercase tracking-widest">{challengeState === 'success' ? 'Success' : challengeState === 'failure' ? 'Warning' : 'Challenge Active'}</span>
                        </div>
                        <p className="text-xs font-bold leading-tight">{feedbackMsg || "Adjust variables to meet the goal."}</p>
                     </div>
                  )}

                  <div className="flex gap-3">
                     <div className="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0">
                        <i className="fa-solid fa-lightbulb"></i>
                     </div>
                     <p className="text-xs text-slate-600 italic leading-relaxed">
                        {blueprint.insight}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MULTI-STEP EQUATIONS RENDERER ---
   const MultiStepEquationsRenderer = () => {
      const config = parsedData || {
         initialEquation: { left: "2x + 5", right: "13" },
         steps: [
            { type: 'subtract', value: 5, target: '2x + 5', result: '2x' },
            { type: 'divide', value: 2, target: '2x', result: 'x' }
         ],
         goal: "x"
      };

      const [current, setCurrent] = useState(config.initialEquation);
      const [history, setHistory] = useState([{ ...config.initialEquation, op: "Start" }]);
      const [isSolved, setIsSolved] = useState(false);

      const handleStep = (step: any) => {
         if (isSolved) return;

         const newVal = step.type === 'subtract'
            ? (parseInt(current.right) - step.value).toString()
            : (parseInt(current.right) / step.value).toString();

         const nextState = { left: step.result, right: newVal };
         setHistory([...history, { ...nextState, op: `${step.type === 'subtract' ? '-' : '√∑'} ${step.value}` }]);
         setCurrent(nextState);
         if (step.result === config.goal) setIsSolved(true);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl p-8 border border-slate-200">
               <div className="text-center mb-8">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Escape Room: Unlock the Variable</h3>
                  <p className="text-slate-500 italic">Apply operations to both sides to isolate {config.goal}!</p>
               </div>

               <div className="flex items-center justify-center gap-8 mb-12">
                  <div className="p-6 bg-indigo-50 rounded-2xl border-2 border-indigo-200 min-w-[120px] text-center shadow-inner">
                     <span className="text-3xl font-mono font-bold text-indigo-600">{current.left}</span>
                  </div>
                  <div className="text-4xl font-bold text-slate-300">=</div>
                  <div className="p-6 bg-indigo-50 rounded-2xl border-2 border-indigo-200 min-w-[120px] text-center shadow-inner">
                     <span className="text-3xl font-mono font-bold text-indigo-600">{current.right}</span>
                  </div>
               </div>

               <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                  {config.steps.map((s: any, i: number) => (
                     <button
                        key={i}
                        onClick={() => handleStep(s)}
                        disabled={current.left !== s.target || isSolved}
                        className="p-4 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg active:scale-95"
                     >
                        {s.type === 'subtract' ? 'Subtract' : 'Divide'} {s.value} from both sides
                     </button>
                  ))}
               </div>

               <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                  <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Operation History</h4>
                  <div className="space-y-3">
                     {history.map((h, i) => (
                        <div key={i} className="flex justify-between items-center text-sm">
                           <div className="flex items-center gap-3">
                              <span className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold">{i}</span>
                              <span className="text-slate-500 font-medium">{h.op}</span>
                           </div>
                           <span className="font-mono font-bold text-slate-700">{h.left} = {h.right}</span>
                        </div>
                     ))}
                  </div>
               </div>

               {isSolved && (
                  <div className="mt-8 p-6 bg-green-50 border-2 border-green-200 rounded-2xl text-green-800 text-center animate-in fade-in zoom-in duration-500">
                     <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i className="fa-solid fa-unlock text-2xl text-green-600"></i>
                     </div>
                     <h4 className="text-xl font-bold mb-1">Variable Unlocked!</h4>
                     <p className="text-sm opacity-80">{config.goal} = {current.right}</p>
                  </div>
               )}
            </div>
         </div>
      );
   };

   // --- VARIABLES ON BOTH SIDES RENDERER ---
   const VariablesBothSidesRenderer = () => {
      const config = parsedData || {
         initial: { left: ["3x", "5"], right: ["x", "13"] },
         goal: "2x = 8"
      };

      const [state, setState] = useState(config.initial);
      const [isSolved, setIsSolved] = useState(false);

      const moveTerm = (term: string, from: 'left' | 'right') => {
         if (isSolved) return;

         const newState = {
            left: [...state.left],
            right: [...state.right]
         };

         if (term === 'x' && from === 'right') {
            newState.right = state.right.filter(t => t !== 'x');
            newState.left = ["2x", "5"];
            setState(newState);
            if (newState.left.join(" ") === "2x 5" && newState.right.join(" ") === "13") {
               setIsSolved(true);
            }
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200 relative overflow-hidden">
               <div className="absolute top-0 left-0 w-full h-2 bg-indigo-500"></div>

               <div className="text-center mb-12">
                  <h3 className="text-3xl font-serif font-bold text-slate-800 mb-2">Equation Tug-of-War</h3>
                  <p className="text-slate-500 italic">Gather your variables on one side and numbers on the other!</p>
               </div>

               <div className="relative h-48 flex items-center justify-between mb-12 px-12">
                  <div className="absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2"></div>

                  <div className="relative z-10 flex gap-3">
                     {state.left.map((t: string, i: number) => (
                        <div key={i} className={`px-6 py-4 rounded-xl shadow-lg border-2 font-mono font-bold text-xl transition-all hover:-translate-y-1 cursor-pointer ${t.includes('x') ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-amber-500 border-amber-300 text-white'}`}>
                           {t}
                        </div>
                     ))}
                  </div>

                  <div className="relative z-20 w-16 h-16 bg-white rounded-full border-4 border-slate-200 flex items-center justify-center shadow-xl">
                     <span className="text-2xl font-black text-slate-300">=</span>
                  </div>

                  <div className="relative z-10 flex gap-3">
                     {state.right.map((t: string, i: number) => (
                        <div key={i} className={`px-6 py-4 rounded-xl shadow-lg border-2 font-mono font-bold text-xl transition-all hover:-translate-y-1 cursor-pointer ${t.includes('x') ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-amber-500 border-amber-300 text-white'}`}>
                           {t}
                        </div>
                     ))}
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-6">
                  <div className="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Strategy: Variables</h4>
                     <button
                        onClick={() => moveTerm('x', 'right')}
                        disabled={!state.right.includes('x')}
                        className="w-full p-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-md active:scale-95 disabled:opacity-30"
                     >
                        Subtract 'x' from both sides
                     </button>
                  </div>
                  <div className="p-6 bg-slate-50 rounded-2xl border border-slate-100">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Strategy: Constants</h4>
                     <button
                        disabled
                        className="w-full p-4 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 transition-all shadow-md active:scale-95 opacity-30"
                     >
                        Subtract '5' from both sides
                     </button>
                  </div>
               </div>

               {isSolved && (
                  <div className="mt-8 p-4 bg-green-50 border border-green-200 rounded-xl text-green-800 text-center animate-bounce">
                     <span className="font-bold">Great job! You gathered the variables. Now solve for x!</span>
                  </div>
               )}
            </div>
         </div>
      );
   };

   // --- LINEAR INEQUALITIES RENDERER ---
   const LinearInequalitiesRenderer = () => {
      const config = parsedData || {
         inequality: "v ‚â§ 65",
         limit: 65,
         variable: "v",
         unit: "mph",
         label: "Speed"
      };

      const [value, setValue] = useState(45);
      const isLegal = value <= config.limit;

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col items-center justify-center p-8 overflow-hidden">
            <div className="max-w-4xl w-full relative h-[400px] bg-slate-800 rounded-3xl border-4 border-slate-700 shadow-2xl overflow-hidden mb-8">
               <div className="absolute bottom-0 w-full h-32 bg-slate-700">
                  <div className="absolute top-1/2 w-full h-2 border-t-4 border-dashed border-slate-500"></div>
               </div>

               <div className="absolute top-12 right-12 w-24 h-32 bg-white rounded-lg border-4 border-slate-900 flex flex-col items-center p-2 shadow-xl">
                  <span className="text-[10px] font-black text-slate-900 uppercase">Speed Limit</span>
                  <span className="text-4xl font-black text-slate-900 mt-2">{config.limit}</span>
               </div>

               <div
                  className="absolute bottom-12 transition-all duration-500 ease-out"
                  style={{ left: `${(value / 120) * 80}%` }}
               >
                  <div className="relative">
                     <span className="text-6xl">üöó</span>
                     <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-full shadow-lg border-2 border-slate-200">
                        <span className="text-sm font-bold text-slate-800">{value} {config.unit}</span>
                     </div>
                  </div>
               </div>

               <div className={`absolute top-12 left-12 px-6 py-3 rounded-2xl border-4 font-black text-2xl uppercase tracking-widest transition-all ${isLegal ? 'bg-green-500/20 border-green-500 text-green-500' : 'bg-red-500/20 border-red-500 text-red-500'}`}>
                  {isLegal ? 'Legal' : 'Illegal'}
               </div>
            </div>

            <div className="max-w-2xl w-full bg-white rounded-2xl p-8 shadow-xl">
               <div className="flex justify-between items-center mb-6">
                  <div>
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Inequality</h4>
                     <span className="text-3xl font-mono font-bold text-indigo-600">{config.inequality}</span>
                  </div>
                  <div className="text-right">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Current {config.label}</h4>
                     <span className={`text-3xl font-mono font-bold ${isLegal ? 'text-green-600' : 'text-red-600'}`}>{value} {config.unit}</span>
                  </div>
               </div>

               <input
                  type="range"
                  min="0" max="120"
                  value={value}
                  onChange={(e) => setValue(parseInt(e.target.value))}
                  className="w-full h-4 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500 mb-4"
               />

               <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                  <span>0 {config.unit}</span>
                  <span>60 {config.unit}</span>
                  <span>120 {config.unit}</span>
               </div>
            </div>
         </div>
      );
   };

   // --- INEQUALITIES NUMBER LINE RENDERER ---
   const InequalitiesNumberLineRenderer = () => {
      const [value, setValue] = useState(0);
      const [isClosed, setIsClosed] = useState(true);
      const [direction, setDirection] = useState<'left' | 'right'>('right');

      const inequality = `x ${direction === 'right' ? (isClosed ? '‚â•' : '>') : (isClosed ? '‚â§' : '<')} ${value}`;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200">
               <div className="text-center mb-12">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Inequality Grapher</h3>
                  <div className="inline-block px-6 py-3 bg-indigo-600 text-white rounded-2xl text-4xl font-mono font-bold shadow-lg">
                     {inequality}
                  </div>
               </div>

               <div className="relative h-32 mb-12">
                  <svg viewBox="0 0 800 100" className="w-full h-full overflow-visible">
                     <line x1="50" y1="50" x2="750" y2="50" stroke="#cbd5e1" strokeWidth="2" />
                     {[-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5].map(num => {
                        const x = 400 + num * 60;
                        return (
                           <g key={num}>
                              <line x1={x} y1="45" x2={x} y2="55" stroke="#94a3b8" strokeWidth="2" />
                              <text x={x} y="75" textAnchor="middle" fontSize="12" fill="#64748b" fontWeight="bold">{num}</text>
                           </g>
                        );
                     })}
                     <line
                        x1={400 + value * 60}
                        y1="50"
                        x2={direction === 'right' ? 750 : 50}
                        y2="50"
                        stroke="#6366f1"
                        strokeWidth="8"
                        strokeOpacity="0.3"
                     />
                     <circle
                        cx={400 + value * 60}
                        cy="50"
                        r="8"
                        fill={isClosed ? "#6366f1" : "white"}
                        stroke="#6366f1"
                        strokeWidth="3"
                     />
                  </svg>
               </div>

               <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">1. Set Value</h4>
                     <input
                        type="range"
                        min="-5" max="5" step="1"
                        value={value}
                        onChange={(e) => setValue(parseInt(e.target.value))}
                        className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                     />
                     <div className="text-center font-bold text-slate-600">{value}</div>
                  </div>
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">2. Circle Type</h4>
                     <div className="flex gap-2">
                        <button
                           onClick={() => setIsClosed(false)}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${!isClosed ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Open
                        </button>
                        <button
                           onClick={() => setIsClosed(true)}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${isClosed ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Closed
                        </button>
                     </div>
                  </div>
                  <div className="space-y-4">
                     <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">3. Direction</h4>
                     <div className="flex gap-2">
                        <button
                           onClick={() => setDirection('left')}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${direction === 'left' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Left
                        </button>
                        <button
                           onClick={() => setDirection('right')}
                           className={`flex-1 p-3 rounded-xl border-2 font-bold transition-all ${direction === 'right' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}`}
                        >
                           Right
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- INDEPENDENT/DEPENDENT VARIABLES RENDERER ---
   const IndependentDependentVariablesRenderer = () => {
      const [input, setInput] = useState(5);
      const [isProcessing, setIsProcessing] = useState(false);
      const [output, setOutput] = useState(10);

      const process = (val: number) => {
         setIsProcessing(true);
         setInput(val);
         setTimeout(() => {
            setOutput(val * 2);
            setIsProcessing(false);
         }, 800);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col items-center justify-center p-8">
            <div className="max-w-4xl w-full bg-white rounded-3xl shadow-xl p-12 border border-slate-200">
               <div className="text-center mb-12">
                  <h3 className="text-2xl font-bold text-slate-800 mb-2">Cause & Effect Laboratory</h3>
                  <p className="text-slate-500 italic">The Independent variable CAUSES the Dependent variable to change.</p>
               </div>

               <div className="flex items-center justify-between gap-8 mb-12">
                  <div className="flex-1 flex flex-col items-center">
                     <div className="mb-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-xs font-black uppercase tracking-widest">Independent Variable</div>
                     <div className="w-32 h-32 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg relative">
                        <span className="text-4xl font-bold text-white">{input}</span>
                        <div className="absolute -bottom-4 w-8 h-8 bg-indigo-600 rotate-45"></div>
                     </div>
                     <div className="mt-8 w-full">
                        <input
                           type="range"
                           min="1" max="10"
                           value={input}
                           onChange={(e) => process(parseInt(e.target.value))}
                           className="w-full h-2 bg-slate-100 rounded-full appearance-none cursor-pointer accent-indigo-500"
                        />
                     </div>
                  </div>

                  <div className="w-48 h-48 bg-slate-800 rounded-3xl flex flex-col items-center justify-center relative shadow-2xl border-4 border-slate-700">
                     <div className="text-xs font-black text-slate-500 uppercase mb-2">The Rule</div>
                     <div className="text-2xl font-mono font-bold text-white">x √ó 2</div>
                     {isProcessing && (
                        <div className="absolute inset-0 bg-indigo-500/20 animate-pulse rounded-2xl flex items-center justify-center">
                           <i className="fa-solid fa-gear text-4xl text-white animate-spin"></i>
                        </div>
                     )}
                  </div>

                  <div className="flex-1 flex flex-col items-center">
                     <div className="mb-4 px-4 py-2 bg-amber-100 text-amber-700 rounded-full text-xs font-black uppercase tracking-widest">Dependent Variable</div>
                     <div className={`w-32 h-32 bg-amber-500 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-500 ${isProcessing ? 'scale-90 opacity-50' : 'scale-100 opacity-100'}`}>
                        <span className="text-4xl font-bold text-white">{output}</span>
                     </div>
                     <div className="mt-8 text-center text-slate-400 font-medium italic">
                        "I depend on the input!"
                     </div>
                  </div>
               </div>

               <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 flex gap-6 items-center">
                  <div className="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0">
                     <i className="fa-solid fa-flask-vial text-xl"></i>
                  </div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800 mb-1">Laboratory Insight</h4>
                     <p className="text-xs text-slate-600 leading-relaxed">
                        In this experiment, you control the <strong>Input</strong> (Independent). The <strong>Output</strong> (Dependent) changes automatically based on the rule. You can't change the output without changing the input first!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CONCEPT 101: ANGLE TYPES RENDERER ---
   function AngleTypesRenderer() {
      const [angle, setAngle] = useState(45);
      const [showProtractor, setShowProtractor] = useState(true);
      const [showRealWorld, setShowRealWorld] = useState(false);

      const getAngleType = (deg: number) => {
         if (deg === 0) return { label: "ZERO", color: "text-slate-400", desc: "No opening between rays." };
         if (deg < 90) return { label: "ACUTE", color: "text-emerald-500", desc: "Less than 90¬∞, forms a sharp corner." };
         if (deg === 90) return { label: "RIGHT", color: "text-blue-500", desc: "Exactly 90¬∞, forms a perfect 'L' shape." };
         if (deg < 180) return { label: "OBTUSE", color: "text-orange-500", desc: "Greater than 90¬∞ but less than 180¬∞." };
         if (deg === 180) return { label: "STRAIGHT", color: "text-red-500", desc: "Exactly 180¬∞, forms a straight line." };
         return { label: "REFLEX", color: "text-purple-500", desc: "Greater than 180¬∞." };
      };

      const typeInfo = getAngleType(angle);

      const realWorldExamples: Record<string, { img: string, label: string }> = {
         ACUTE: { img: "üçï", label: "Pizza Slice" },
         RIGHT: { img: "üìÑ", label: "Paper Corner" },
         OBTUSE: { img: "ü™ë", label: "Reclining Chair" },
         STRAIGHT: { img: "üìè", label: "Straight Ruler" }
      };

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-6">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Angle Architect Studio</h2>
                  <p className="text-slate-500">Designing with Degrees</p>
               </div>
               <div className={`px-4 py-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center min-w-[120px]`}>
                  <span className={`text-2xl font-black ${typeInfo.color}`}>{angle}¬∞</span>
                  <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400">{typeInfo.label}</span>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-8 items-center justify-center">
               {/* ANGLE VISUALIZER */}
               <div className="relative w-64 h-64 flex items-center justify-center bg-slate-50 rounded-full border border-slate-100 shadow-inner">
                  {/* Protractor Background */}
                  {showProtractor && (
                     <svg className="absolute inset-0 w-full h-full opacity-20" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="currentColor" strokeWidth="1" strokeDasharray="2 2" />
                        {[...Array(13)].map((_, i) => {
                           const deg = i * 15;
                           const rad = (deg * Math.PI) / 180;
                           const x1 = 100 + Math.cos(rad) * 85;
                           const y1 = 100 - Math.sin(rad) * 85;
                           const x2 = 100 + Math.cos(rad) * 90;
                           const y2 = 100 - Math.sin(rad) * 90;
                           return <line key={deg} x1={x1} y1={y1} x2={x2} y2={y2} stroke="currentColor" strokeWidth="1" />;
                        })}
                     </svg>
                  )}

                  {/* The Angle */}
                  <svg className="w-full h-full overflow-visible" viewBox="0 0 200 200">
                     {/* Base Ray */}
                     <line x1="100" y1="100" x2="190" y2="100" stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />

                     {/* Rotating Ray */}
                     <line
                        x1="100" y1="100"
                        x2={100 + Math.cos((-angle * Math.PI) / 180) * 90}
                        y2={100 + Math.sin((-angle * Math.PI) / 180) * 90}
                        stroke="currentColor"
                        className={typeInfo.color}
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Angle Arc */}
                     <path
                        d={`M 130 100 A 30 30 0 ${angle > 180 ? 1 : 0} 0 ${100 + Math.cos((-angle * Math.PI) / 180) * 30} ${100 + Math.sin((-angle * Math.PI) / 180) * 30}`}
                        fill="none"
                        stroke="currentColor"
                        className={typeInfo.color}
                        strokeWidth="2"
                        opacity="0.3"
                     />

                     {/* Right Angle Square */}
                     {angle === 90 && (
                        <rect x="100" y="70" width="30" height="30" fill="none" stroke="currentColor" className={typeInfo.color} strokeWidth="2" />
                     )}

                     {/* Vertex */}
                     <circle cx="100" cy="100" r="6" fill="#1e293b" />
                  </svg>

                  {/* Drag Handle (Invisible but large) */}
                  <div
                     className="absolute inset-0 cursor-pointer"
                     onMouseDown={(e) => {
                        const rect = e.currentTarget.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const handleMove = (moveEvent: MouseEvent) => {
                           const dx = moveEvent.clientX - centerX;
                           const dy = moveEvent.clientY - centerY;
                           let deg = Math.atan2(-dy, dx) * (180 / Math.PI);
                           if (deg < 0) deg += 360;
                           setAngle(Math.round(deg));
                        };

                        const handleUp = () => {
                           window.removeEventListener('mousemove', handleMove);
                           window.removeEventListener('mouseup', handleUp);
                        };

                        window.addEventListener('mousemove', handleMove);
                        window.addEventListener('mouseup', handleUp);
                     }}
                  ></div>
               </div>

               {/* INFO & CONTROLS */}
               <div className="flex-1 max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                     <h3 className={`text-lg font-bold mb-1 ${typeInfo.color}`}>{typeInfo.label} ANGLE</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">{typeInfo.desc}</p>
                  </div>

                  {showRealWorld && realWorldExamples[typeInfo.label] && (
                     <div className="flex items-center gap-4 p-4 rounded-2xl bg-indigo-50 border border-indigo-100 animate-in fade-in slide-in-from-bottom-2">
                        <div className="text-4xl">{realWorldExamples[typeInfo.label].img}</div>
                        <div>
                           <p className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Real World Example</p>
                           <p className="text-sm font-bold text-indigo-900">{realWorldExamples[typeInfo.label].label}</p>
                        </div>
                     </div>
                  )}

                  <div className="space-y-4">
                     <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Quick Snaps</label>
                        <div className="flex flex-wrap gap-2">
                           {[30, 45, 60, 90, 120, 150, 180].map(val => (
                              <button
                                 key={val}
                                 onClick={() => setAngle(val)}
                                 className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${angle === val ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:border-slate-300'}`}
                              >
                                 {val}¬∞
                              </button>
                           ))}
                        </div>
                     </div>

                     <div className="flex gap-4">
                        <button
                           onClick={() => setShowProtractor(!showProtractor)}
                           className={`flex-1 py-2 rounded-xl text-xs font-bold border transition-all ${showProtractor ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600'}`}
                        >
                           <i className={`fa-solid fa-compass mr-2`}></i>
                           Protractor
                        </button>
                        <button
                           onClick={() => setShowRealWorld(!showRealWorld)}
                           className={`flex-1 py-2 rounded-xl text-xs font-bold border transition-all ${showRealWorld ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600'}`}
                        >
                           <i className={`fa-solid fa-eye mr-2`}></i>
                           Examples
                        </button>
                     </div>
                  </div>
               </div>
            </div>

            <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
               <div className="p-4 rounded-xl bg-emerald-50 border border-emerald-100">
                  <h4 className="text-xs font-bold text-emerald-700 mb-1">Acute</h4>
                  <p className="text-[10px] text-emerald-600">Sharp, less than 90¬∞. Think "a-cute" little angle!</p>
               </div>
               <div className="p-4 rounded-xl bg-blue-50 border border-blue-100">
                  <h4 className="text-xs font-bold text-blue-700 mb-1">Right</h4>
                  <p className="text-[10px] text-blue-600">Exactly 90¬∞. The corner of a paper or a room.</p>
               </div>
               <div className="p-4 rounded-xl bg-orange-50 border border-orange-100">
                  <h4 className="text-xs font-bold text-orange-700 mb-1">Obtuse</h4>
                  <p className="text-[10px] text-orange-600">Wide, between 90¬∞ and 180¬∞. Like a reclining chair.</p>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 102: ANGLE PARTNERS RENDERER ---
   function AnglePartnersRenderer() {
      const [mode, setMode] = useState<'complementary' | 'supplementary'>('complementary');
      const [angleA, setAngleA] = useState(mode === 'complementary' ? 50 : 120);

      const target = mode === 'complementary' ? 90 : 180;
      const angleB = target - angleA;

      const handleModeChange = (newMode: 'complementary' | 'supplementary') => {
         setMode(newMode);
         if (newMode === 'complementary' && angleA >= 90) setAngleA(45);
         if (newMode === 'supplementary' && angleA < 90) setAngleA(120);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Angle Partners</h2>
                  <p className="text-slate-500 italic font-serif">Finding the Perfect Match</p>
               </div>
               <div className="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                  <button
                     onClick={() => handleModeChange('complementary')}
                     className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'complementary' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                     Complementary (90¬∞)
                  </button>
                  <button
                     onClick={() => handleModeChange('supplementary')}
                     className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'supplementary' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                  >
                     Supplementary (180¬∞)
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZATION */}
               <div className="relative w-80 h-80 bg-white rounded-3xl border border-slate-200 shadow-xl flex items-center justify-center overflow-hidden">
                  <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: 'radial-gradient(#4f46e5 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>

                  <svg viewBox="0 0 200 200" className="w-64 h-64 overflow-visible">
                     {/* Target Frame */}
                     <path
                        d={mode === 'complementary' ? "M 100 100 L 190 100 A 90 90 0 0 0 100 10" : "M 10 100 L 190 100 A 90 90 0 0 0 10 100"}
                        fill="none"
                        stroke="#e2e8f0"
                        strokeWidth="2"
                        strokeDasharray="4 4"
                     />

                     {/* Angle A */}
                     <path
                        d={`M 100 100 L 190 100 A 90 90 0 0 0 ${100 + Math.cos((-angleA * Math.PI) / 180) * 90} ${100 + Math.sin((-angleA * Math.PI) / 180) * 90} Z`}
                        fill="#4f46e5"
                        fillOpacity="0.1"
                        stroke="#4f46e5"
                        strokeWidth="3"
                        strokeLinejoin="round"
                     />

                     {/* Angle B */}
                     <path
                        d={`M 100 100 L ${100 + Math.cos((-angleA * Math.PI) / 180) * 90} ${100 + Math.sin((-angleA * Math.PI) / 180) * 90} A 90 90 0 0 0 ${100 + Math.cos((-target * Math.PI) / 180) * 90} ${100 + Math.sin((-target * Math.PI) / 180) * 90} Z`}
                        fill="#ec4899"
                        fillOpacity="0.1"
                        stroke="#ec4899"
                        strokeWidth="3"
                        strokeLinejoin="round"
                     />

                     {/* Labels */}
                     <text
                        x={100 + Math.cos((-angleA / 2 * Math.PI) / 180) * 60}
                        y={100 + Math.sin((-angleA / 2 * Math.PI) / 180) * 60}
                        textAnchor="middle"
                        className="fill-indigo-700 font-bold text-[12px]"
                     >
                        {angleA}¬∞
                     </text>
                     <text
                        x={100 + Math.cos((-(angleA + angleB / 2) * Math.PI) / 180) * 60}
                        y={100 + Math.sin((-(angleA + angleB / 2) * Math.PI) / 180) * 60}
                        textAnchor="middle"
                        className="fill-pink-700 font-bold text-[12px]"
                     >
                        {angleB}¬∞
                     </text>

                     {/* Right Angle Symbol for Complementary */}
                     {mode === 'complementary' && (
                        <path d="M 100 80 L 120 80 L 120 100" fill="none" stroke="#94a3b8" strokeWidth="1" />
                     )}
                  </svg>

                  {/* Partnership Meter */}
                  <div className="absolute bottom-6 left-6 right-6 h-2 bg-slate-100 rounded-full overflow-hidden flex">
                     <div style={{ width: `${(angleA / target) * 100}%` }} className="h-full bg-indigo-500 transition-all duration-300"></div>
                     <div style={{ width: `${(angleB / target) * 100}%` }} className="h-full bg-pink-500 transition-all duration-300"></div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-xs space-y-8">
                  <div className="space-y-4">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Adjust Angle A</label>
                        <span className="text-xl font-black text-indigo-600">{angleA}¬∞</span>
                     </div>
                     <input
                        type="range"
                        min="1"
                        max={target - 1}
                        value={angleA}
                        onChange={(e) => setAngleA(parseInt(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                     />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                     <div className="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Angle A</p>
                        <p className="text-2xl font-black text-indigo-600">{angleA}¬∞</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Angle B</p>
                        <p className="text-2xl font-black text-pink-600">{angleB}¬∞</p>
                     </div>
                  </div>

                  <div className="p-5 rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200">
                     <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-bold uppercase tracking-widest opacity-80">Combined Total</span>
                        <span className="text-2xl font-black">{angleA + angleB}¬∞</span>
                     </div>
                     <p className="text-xs opacity-90 leading-relaxed">
                        {mode === 'complementary'
                           ? "These angles are COMPLEMENTARY because they sum to 90¬∞ (a right angle)."
                           : "These angles are SUPPLEMENTARY because they sum to 180¬∞ (a straight line)."}
                     </p>
                  </div>
               </div>
            </div>

            {/* EDUCATIONAL FOOTER */}
            <div className="mt-12 flex flex-col md:flex-row gap-6">
               <div className="flex-1 flex gap-4 items-start p-4 rounded-2xl bg-white border border-slate-100">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 font-bold">C</div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800">Complementary (90¬∞)</h4>
                     <p className="text-xs text-slate-500">Think "C" for "Corner". Two angles that fit perfectly into a 90¬∞ corner.</p>
                  </div>
               </div>
               <div className="flex-1 flex gap-4 items-start p-4 rounded-2xl bg-white border border-slate-100">
                  <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 font-bold">S</div>
                  <div>
                     <h4 className="text-sm font-bold text-slate-800">Supplementary (180¬∞)</h4>
                     <p className="text-xs text-slate-500">Think "S" for "Straight". Two angles that form a straight line together.</p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 103: INTERSECTION INVESTIGATION RENDERER ---
   function IntersectionInvestigationRenderer() {
      const [rotation, setRotation] = useState(70);
      const [highlightType, setHighlightType] = useState<'none' | 'vertical' | 'adjacent'>('none');

      const angle1 = rotation;
      const angle2 = 180 - rotation;
      const angle3 = rotation;
      const angle4 = 180 - rotation;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Intersection Investigation</h2>
                  <p className="text-slate-500 italic font-serif">Where Lines Cross</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setHighlightType(highlightType === 'vertical' ? 'none' : 'vertical')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${highlightType === 'vertical' ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     Vertical Pairs
                  </button>
                  <button
                     onClick={() => setHighlightType(highlightType === 'adjacent' ? 'none' : 'adjacent')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${highlightType === 'adjacent' ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     Adjacent Pairs
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZATION */}
               <div className="relative w-80 h-80 bg-slate-50 rounded-full border border-slate-100 shadow-inner flex items-center justify-center">
                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                     {/* Line 1 (Static Horizontal) */}
                     <line x1="10" y1="100" x2="190" y2="100" stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />

                     {/* Line 2 (Rotating) */}
                     <line
                        x1={100 + Math.cos((rotation * Math.PI) / 180) * 90}
                        y1={100 + Math.sin((rotation * Math.PI) / 180) * 90}
                        x2={100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 90}
                        y2={100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 90}
                        stroke="#475569"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Angle Arcs & Labels */}
                     {/* Angle 1 (Top Right) */}
                     <path
                        d={`M 130 100 A 30 30 0 0 0 ${100 + Math.cos((rotation * Math.PI) / 180) * 30} ${100 + Math.sin((rotation * Math.PI) / 180) * 30}`}
                        fill="none" stroke={highlightType === 'vertical' ? '#4f46e5' : (highlightType === 'adjacent' ? '#ec4899' : '#94a3b8')} strokeWidth="3"
                     />
                     <text x="140" y="85" className="text-[12px] font-bold fill-slate-800">{angle1}¬∞</text>

                     {/* Angle 2 (Top Left) */}
                     <path
                        d={`M ${100 + Math.cos((rotation * Math.PI) / 180) * 30} ${100 + Math.sin((rotation * Math.PI) / 180) * 30} A 30 30 0 0 0 70 100`}
                        fill="none" stroke={highlightType === 'adjacent' ? '#ec4899' : '#94a3b8'} strokeWidth="3"
                     />
                     <text x="50" y="85" className="text-[12px] font-bold fill-slate-800">{angle2}¬∞</text>

                     {/* Angle 3 (Bottom Left) */}
                     <path
                        d={`M 70 100 A 30 30 0 0 0 ${100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 30} ${100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 30}`}
                        fill="none" stroke={highlightType === 'vertical' ? '#4f46e5' : (highlightType === 'adjacent' ? '#ec4899' : '#94a3b8')} strokeWidth="3"
                     />
                     <text x="50" y="125" className="text-[12px] font-bold fill-slate-800">{angle3}¬∞</text>

                     {/* Angle 4 (Bottom Right) */}
                     <path
                        d={`M ${100 + Math.cos(((rotation + 180) * Math.PI) / 180) * 30} ${100 + Math.sin(((rotation + 180) * Math.PI) / 180) * 30} A 30 30 0 0 0 130 100`}
                        fill="none" stroke={highlightType === 'adjacent' ? '#ec4899' : '#94a3b8'} strokeWidth="3"
                     />
                     <text x="140" y="125" className="text-[12px] font-bold fill-slate-800">{angle4}¬∞</text>

                     {/* Vertex */}
                     <circle cx="100" cy="100" r="5" fill="#1e293b" />
                  </svg>

                  {/* Rotation Handle */}
                  <div
                     className="absolute inset-0 cursor-pointer"
                     onMouseDown={(e) => {
                        const rect = e.currentTarget.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const handleMove = (moveEvent: MouseEvent) => {
                           const dx = moveEvent.clientX - centerX;
                           const dy = moveEvent.clientY - centerY;
                           let deg = Math.atan2(dy, dx) * (180 / Math.PI);
                           if (deg < 0) deg += 360;
                           // Keep it in a reasonable range to avoid flipping labels too much
                           setRotation(Math.round(deg % 180));
                        };

                        const handleUp = () => {
                           window.removeEventListener('mousemove', handleMove);
                           window.removeEventListener('mouseup', handleUp);
                        };

                        window.addEventListener('mousemove', handleMove);
                        window.addEventListener('mouseup', handleUp);
                     }}
                  ></div>
               </div>

               {/* INSIGHTS PANEL */}
               <div className="w-full max-w-sm space-y-6">
                  {highlightType === 'vertical' ? (
                     <div className="p-5 rounded-2xl bg-indigo-50 border border-indigo-100 animate-in fade-in zoom-in-95">
                        <h3 className="text-lg font-bold text-indigo-900 mb-2">Vertical Angles</h3>
                        <p className="text-sm text-indigo-700 leading-relaxed">
                           Angles opposite each other at an intersection are <strong>Vertical</strong>. They are always <strong>equal</strong>!
                        </p>
                        <div className="mt-4 flex gap-4">
                           <div className="flex-1 bg-white p-3 rounded-xl border border-indigo-200 text-center">
                              <span className="text-xs font-bold text-slate-400 block mb-1">Pair 1</span>
                              <span className="text-lg font-black text-indigo-600">{angle1}¬∞ = {angle3}¬∞</span>
                           </div>
                           <div className="flex-1 bg-white p-3 rounded-xl border border-indigo-200 text-center">
                              <span className="text-xs font-bold text-slate-400 block mb-1">Pair 2</span>
                              <span className="text-lg font-black text-indigo-600">{angle2}¬∞ = {angle4}¬∞</span>
                           </div>
                        </div>
                     </div>
                  ) : highlightType === 'adjacent' ? (
                     <div className="p-5 rounded-2xl bg-pink-50 border border-pink-100 animate-in fade-in zoom-in-95">
                        <h3 className="text-lg font-bold text-pink-900 mb-2">Adjacent Angles</h3>
                        <p className="text-sm text-pink-700 leading-relaxed">
                           Angles next to each other are <strong>Adjacent</strong>. At an intersection, they are <strong>supplementary</strong> (sum to 180¬∞).
                        </p>
                        <div className="mt-4 p-3 bg-white rounded-xl border border-pink-200 text-center">
                           <span className="text-lg font-black text-pink-600">{angle1}¬∞ + {angle2}¬∞ = 180¬∞</span>
                        </div>
                     </div>
                  ) : (
                     <div className="p-5 rounded-2xl bg-slate-50 border border-slate-100">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">Intersection Rules</h3>
                        <p className="text-sm text-slate-600 leading-relaxed">
                           Drag the lines to see how all four angles change together. If you know just <strong>one</strong> angle, you can find all the others!
                        </p>
                     </div>
                  )}

                  <div className="grid grid-cols-2 gap-4">
                     {[1, 2, 3, 4].map(num => (
                        <div key={num} className="p-3 rounded-xl bg-white border border-slate-200 flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400">‚à†{num}</span>
                           <span className="text-sm font-black text-slate-700">{num % 2 === 1 ? angle1 : angle2}¬∞</span>
                        </div>
                     ))}
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 104: AREA SURVEYOR RENDERER ---
   function AreaSurveyorRenderer() {
      const [shape, setShape] = useState<'rectangle' | 'parallelogram' | 'triangle' | 'trapezoid'>('rectangle');
      const [base, setBase] = useState(6);
      const [height, setHeight] = useState(4);
      const [base2, setBase2] = useState(4); // For trapezoid
      const [showDecomposition, setShowDecomposition] = useState(false);

      const calculateArea = () => {
         switch (shape) {
            case 'rectangle': return base * height;
            case 'parallelogram': return base * height;
            case 'triangle': return 0.5 * base * height;
            case 'trapezoid': return 0.5 * (base + base2) * height;
         }
      };

      const area = calculateArea();

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Land Surveyor Studio</h2>
                  <p className="text-slate-500 italic font-serif">Measuring Property & Area</p>
               </div>
               <div className="flex flex-wrap gap-2 max-w-[300px] justify-end">
                  {['rectangle', 'parallelogram', 'triangle', 'trapezoid'].map(s => (
                     <button
                        key={s}
                        onClick={() => { setShape(s as any); setShowDecomposition(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider border transition-all ${shape === s ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* GRID VISUALIZER */}
               <div className="relative w-full max-w-md aspect-square bg-slate-50 rounded-2xl border border-slate-100 shadow-inner flex items-center justify-center p-8">
                  {/* Grid Lines */}
                  <div className="absolute inset-0 opacity-[0.05] pointer-events-none" style={{ backgroundImage: 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>

                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible drop-shadow-lg">
                     {/* The Shape */}
                     {shape === 'rectangle' && (
                        <rect x="40" y={160 - height * 20} width={base * 20} height={height * 20} fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3" />
                     )}
                     {shape === 'parallelogram' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L ${60 + base * 20} ${160 - height * 20} L 60 ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}
                     {shape === 'triangle' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L 40 ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}
                     {shape === 'trapezoid' && (
                        <path
                           d={`M 40 160 L ${40 + base * 20} 160 L ${40 + (base + base2) / 2 * 20 + base2 / 2 * 20} ${160 - height * 20} L ${40 + (base + base2) / 2 * 20 - base2 / 2 * 20} ${160 - height * 20} Z`}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="3"
                        />
                     )}

                     {/* Dimension Labels */}
                     <text x={40 + base * 10} y="175" textAnchor="middle" className="text-[10px] font-bold fill-slate-500">base: {base}</text>
                     <line x1="30" y1={160} x2="30" y2={160 - height * 20} stroke="#94a3b8" strokeWidth="1" strokeDasharray="2 2" />
                     <text x="25" y={160 - height * 10} textAnchor="middle" transform={`rotate(-90, 25, ${160 - height * 10})`} className="text-[10px] font-bold fill-slate-500">height: {height}</text>

                     {shape === 'trapezoid' && (
                        <text x={40 + base * 10} y={150 - height * 20} textAnchor="middle" className="text-[10px] font-bold fill-slate-500">base2: {base2}</text>
                     )}
                  </svg>

                  {/* Decomposition Overlay */}
                  {showDecomposition && shape === 'parallelogram' && (
                     <div className="absolute inset-0 flex items-center justify-center p-8 pointer-events-none">
                        <div className="w-full h-full relative">
                           <div className="absolute bg-amber-400 opacity-30 animate-pulse" style={{ left: '40px', bottom: '40px', width: '20px', height: `${height * 20}px`, clipPath: 'polygon(0% 100%, 100% 100%, 100% 0%)' }}></div>
                        </div>
                     </div>
                  )}
               </div>

               {/* CONTROLS & FORMULA */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-5 rounded-2xl bg-indigo-600 text-white shadow-xl shadow-indigo-100">
                     <p className="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1">Current Formula</p>
                     <h3 className="text-xl font-black mb-4">
                        {shape === 'rectangle' && "Area = base √ó height"}
                        {shape === 'parallelogram' && "Area = base √ó height"}
                        {shape === 'triangle' && "Area = ¬Ω √ó base √ó height"}
                        {shape === 'trapezoid' && "Area = ¬Ω √ó (b1 + b2) √ó h"}
                     </h3>
                     <div className="flex justify-between items-center pt-4 border-t border-white/20">
                        <span className="text-xs font-bold opacity-80">Total Area</span>
                        <span className="text-3xl font-black">{area} sq units</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Base</label>
                           <span className="text-xs font-bold text-slate-700">{base}</span>
                        </div>
                        <input type="range" min="2" max="8" value={base} onChange={(e) => setBase(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Height</label>
                           <span className="text-xs font-bold text-slate-700">{height}</span>
                        </div>
                        <input type="range" min="2" max="6" value={height} onChange={(e) => setHeight(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                     </div>
                     {shape === 'trapezoid' && (
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Base 2</label>
                              <span className="text-xs font-bold text-slate-700">{base2}</span>
                           </div>
                           <input type="range" min="2" max="8" value={base2} onChange={(e) => setBase2(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                        </div>
                     )}
                  </div>

                  <button
                     onClick={() => setShowDecomposition(!showDecomposition)}
                     className={`w-full py-3 rounded-xl text-xs font-bold border transition-all ${showDecomposition ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                  >
                     <i className="fa-solid fa-wand-magic-sparkles mr-2"></i>
                     {showDecomposition ? "Hide Derivation" : "Show How Formula Works"}
                  </button>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 105: CIRCLE LAB RENDERER ---
   function CircleLabRenderer() {
      const [radius, setRadius] = useState(5);
      const [isUnwrapped, setIsUnwrapped] = useState(false);
      const [showArea, setShowArea] = useState(false);

      const diameter = radius * 2;
      const circumference = 2 * Math.PI * radius;
      const area = Math.PI * radius * radius;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Circle Lab</h2>
                  <p className="text-slate-500 italic font-serif">Discovering the Magic of Pi (œÄ)</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-slate-800 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Pi (œÄ)</span>
                     <span className="text-xl font-black">‚âà 3.14159</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* CIRCLE VISUALIZER */}
               <div className="relative w-80 h-80 flex items-center justify-center bg-slate-50 rounded-3xl border border-slate-100 shadow-inner">
                  <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                     {/* The Circle */}
                     <circle
                        cx="100" cy="100" r={radius * 15}
                        fill={showArea ? "#4f46e5" : "none"}
                        fillOpacity="0.1"
                        stroke="#4f46e5"
                        strokeWidth="3"
                        className="transition-all duration-500"
                     />

                     {/* Radius Line */}
                     <line x1="100" y1="100" x2={100 + radius * 15} y2="100" stroke="#1e293b" strokeWidth="2" strokeLinecap="round" />
                     <text x={100 + radius * 7.5} y="90" textAnchor="middle" className="text-[10px] font-bold fill-slate-800">r = {radius}</text>

                     {/* Diameter Line (Dashed) */}
                     <line x1={100 - radius * 15} y1="100" x2="100" y2="100" stroke="#94a3b8" strokeWidth="1" strokeDasharray="2 2" />
                     <text x={100 - radius * 7.5} y="115" textAnchor="middle" className="text-[8px] font-bold fill-slate-400">d = {diameter}</text>

                     {/* Unwrapped Circumference */}
                     {isUnwrapped && (
                        <line
                           x1="10" y1="180"
                           x2={10 + (circumference * 15 / (2 * Math.PI * 5)) * 31.4}
                           y2="180"
                           stroke="#ec4899"
                           strokeWidth="4"
                           strokeLinecap="round"
                           className="animate-in slide-in-from-left duration-1000"
                        />
                     )}
                  </svg>

                  {/* Center Point */}
                  <div className="absolute w-2 h-2 bg-slate-800 rounded-full"></div>
               </div>

               {/* STATS & CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-1 gap-4">
                     <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Circumference (C = 2œÄr)</span>
                           <span className="text-lg font-black text-indigo-900">{circumference.toFixed(2)}</span>
                        </div>
                        <p className="text-[10px] text-indigo-600">The distance all the way around the circle.</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-pink-50 border border-pink-100">
                        <div className="flex justify-between items-center mb-1">
                           <span className="text-[10px] font-bold text-pink-400 uppercase tracking-widest">Area (A = œÄr¬≤)</span>
                           <span className="text-lg font-black text-pink-900">{area.toFixed(2)}</span>
                        </div>
                        <p className="text-[10px] text-pink-600">The total space inside the circle.</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Adjust Radius</label>
                           <span className="text-xs font-bold text-slate-700">{radius} units</span>
                        </div>
                        <input type="range" min="1" max="6" step="0.5" value={radius} onChange={(e) => setRadius(parseFloat(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800" />
                     </div>

                     <div className="flex gap-4">
                        <button
                           onClick={() => setIsUnwrapped(!isUnwrapped)}
                           className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${isUnwrapped ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                        >
                           <i className="fa-solid fa-ruler-horizontal mr-2"></i>
                           Unwrap C
                        </button>
                        <button
                           onClick={() => setShowArea(!showArea)}
                           className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${showArea ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}
                        >
                           <i className="fa-solid fa-fill-drip mr-2"></i>
                           Fill Area
                        </button>
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-slate-800 text-white">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2">
                        <i className="fa-solid fa-lightbulb text-amber-400"></i>
                        Did you know?
                     </h4>
                     <p className="text-[10px] leading-relaxed opacity-80">
                        If you divide any circle's <strong>Circumference</strong> by its <strong>Diameter</strong>, you ALWAYS get <strong>œÄ (3.14...)</strong>. It's a universal constant!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 151: Z-SCORE RENDERER ---
   function ZScoreRenderer() {
      const [mean, setMean] = useState(100);
      const [sd, setSd] = useState(15);
      const [rawValue, setRawValue] = useState(115);

      const zScore = (rawValue - mean) / sd;

      // Normal distribution probability density function
      const pdf = (x: number, m: number, s: number) => {
         return (1 / (s * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - m) / s, 2));
      };

      // Cumulative distribution function approximation (Percentile)
      const getPercentile = (z: number) => {
         const t = 1 / (1 + 0.2316419 * Math.abs(z));
         const d = 0.3989423 * Math.exp(-z * z / 2);
         const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
         return z > 0 ? 1 - p : p;
      };

      const percentile = getPercentile(zScore) * 100;

      // Generate curve points
      const points = [];
      const startX = mean - 4 * sd;
      const endX = mean + 4 * sd;
      const step = (endX - startX) / 100;

      for (let x = startX; x <= endX; x += step) {
         points.push({ x, y: pdf(x, mean, sd) });
      }

      // Scaling for SVG
      const svgWidth = 400;
      const svgHeight = 200;
      const margin = 40;
      const chartWidth = svgWidth - 2 * margin;
      const chartHeight = svgHeight - 2 * margin;

      const scaleX = (val: number) => margin + ((val - startX) / (endX - startX)) * chartWidth;
      const scaleY = (val: number) => (svgHeight - margin) - (val / pdf(mean, mean, sd)) * chartHeight;

      const pathData = `M ${points.map(p => `${scaleX(p.x)},${scaleY(p.y)}`).join(' L ')}`;

      // Shaded area path
      const shadedPoints = points.filter(p => p.x <= rawValue);
      const shadedPath = shadedPoints.length > 0
         ? `M ${scaleX(startX)},${svgHeight - margin} L ${shadedPoints.map(p => `${scaleX(p.x)},${scaleY(p.y)}`).join(' L ')} L ${scaleX(rawValue)},${svgHeight - margin} Z`
         : "";

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Z-Score Explorer</h2>
                  <p className="text-slate-500 italic font-serif">Standard Position Finder</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-indigo-600 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Z-Score</span>
                     <span className="text-xl font-black">{zScore.toFixed(2)}</span>
                  </div>
                  <div className="px-4 py-2 rounded-xl bg-emerald-600 text-white flex flex-col items-center min-w-[100px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Percentile</span>
                     <span className="text-xl font-black">{percentile.toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* BELL CURVE VISUALIZER */}
               <div className="relative w-full max-w-lg aspect-video bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-4">
                  <svg viewBox={`0 0 ${svgWidth} ${svgHeight}`} className="w-full h-full overflow-visible">
                     {/* Shaded Area */}
                     <path d={shadedPath} fill="#4f46e5" fillOpacity="0.2" className="transition-all duration-300" />

                     {/* The Curve */}
                     <path d={pathData} fill="none" stroke="#4f46e5" strokeWidth="3" strokeLinecap="round" />

                     {/* X-Axis */}
                     <line x1={margin} y1={svgHeight - margin} x2={svgWidth - margin} y2={svgHeight - margin} stroke="#94a3b8" strokeWidth="1" />

                     {/* Mean Line */}
                     <line
                        x1={scaleX(mean)} y1={scaleY(0)}
                        x2={scaleX(mean)} y2={scaleY(pdf(mean, mean, sd))}
                        stroke="#94a3b8" strokeWidth="1" strokeDasharray="4 4"
                     />
                     <text x={scaleX(mean)} y={svgHeight - margin + 15} textAnchor="middle" className="text-[10px] fill-slate-400 font-bold">Mean (Œº)</text>

                     {/* Raw Value Marker */}
                     <g className="transition-all duration-300">
                        <line
                           x1={scaleX(rawValue)} y1={svgHeight - margin}
                           x2={scaleX(rawValue)} y2={scaleY(pdf(rawValue, mean, sd))}
                           stroke="#1e293b" strokeWidth="2"
                        />
                        <circle cx={scaleX(rawValue)} cy={scaleY(pdf(rawValue, mean, sd))} r="5" fill="#1e293b" />
                        <text x={scaleX(rawValue)} y={scaleY(pdf(rawValue, mean, sd)) - 10} textAnchor="middle" className="text-[10px] font-bold fill-slate-800">x = {rawValue}</text>
                     </g>

                     {/* SD Markers */}
                     {[1, 2, 3].map(i => (
                        <g key={i}>
                           <line x1={scaleX(mean + i * sd)} y1={svgHeight - margin - 5} x2={scaleX(mean + i * sd)} y2={svgHeight - margin + 5} stroke="#cbd5e1" strokeWidth="1" />
                           <line x1={scaleX(mean - i * sd)} y1={svgHeight - margin - 5} x2={scaleX(mean - i * sd)} y2={svgHeight - margin + 5} stroke="#cbd5e1" strokeWidth="1" />
                        </g>
                     ))}
                  </svg>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-2">
                     <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Z-Score Formula</h4>
                     <div className="text-xl font-serif italic text-center py-2">
                        z = (x - Œº) / œÉ
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed">
                        The z-score tells you how many standard deviations a value is from the mean.
                     </p>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Raw Score (x)</label>
                           <span className="text-xs font-bold text-slate-700">{rawValue}</span>
                        </div>
                        <input
                           type="range" min={mean - 4 * sd} max={mean + 4 * sd} step="1"
                           value={rawValue} onChange={(e) => setRawValue(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>

                     <div className="grid grid-cols-2 gap-4">
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mean (Œº)</label>
                              <span className="text-xs font-bold text-slate-700">{mean}</span>
                           </div>
                           <input
                              type="range" min="50" max="150" step="1"
                              value={mean} onChange={(e) => {
                                 const newMean = parseInt(e.target.value);
                                 setMean(newMean);
                                 setRawValue(newMean + (rawValue - mean));
                              }}
                              className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                           />
                        </div>
                        <div>
                           <div className="flex justify-between mb-2">
                              <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Std Dev (œÉ)</label>
                              <span className="text-xs font-bold text-slate-700">{sd}</span>
                           </div>
                           <input
                              type="range" min="5" max="30" step="1"
                              value={sd} onChange={(e) => setSd(parseInt(e.target.value))}
                              className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-lightbulb text-amber-500"></i>
                        Interpretation
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        {zScore === 0 ? (
                           "Your score is exactly at the mean."
                        ) : zScore > 0 ? (
                           `Your score is ${zScore.toFixed(2)} standard deviations ABOVE the mean. You performed better than ${percentile.toFixed(1)}% of the population.`
                        ) : (
                           `Your score is ${Math.abs(zScore).toFixed(2)} standard deviations BELOW the mean. ${percentile.toFixed(1)}% of the population scored lower than you.`
                        )}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 152: CORRELATION COEFFICIENT RENDERER ---
   function CorrelationCoefficientRenderer() {
      const [points, setPoints] = useState([
         { x: 10, y: 20 }, { x: 20, y: 35 }, { x: 30, y: 45 }, { x: 40, y: 60 },
         { x: 50, y: 70 }, { x: 60, y: 85 }, { x: 70, y: 90 }, { x: 80, y: 110 }
      ]);
      const [showLine, setShowLine] = useState(true);

      // Calculate Pearson Correlation Coefficient (r)
      const calculateR = () => {
         const n = points.length;
         if (n < 2) return 0;

         let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
         points.forEach(p => {
            sumX += p.x;
            sumY += p.y;
            sumXY += p.x * p.y;
            sumX2 += p.x * p.x;
            sumY2 += p.y * p.y;
         });

         const numerator = n * sumXY - sumX * sumY;
         const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
         return denominator === 0 ? 0 : numerator / denominator;
      };

      const r = calculateR();

      // Calculate Line of Best Fit (y = mx + b)
      const calculateLine = () => {
         const n = points.length;
         let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
         points.forEach(p => {
            sumX += p.x;
            sumY += p.y;
            sumXY += p.x * p.y;
            sumX2 += p.x * p.x;
         });

         const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
         const b = (sumY - m * sumX) / n;
         return { m, b };
      };

      const { m, b } = calculateLine();

      const presets = {
         perfect_positive: [{ x: 10, y: 10 }, { x: 20, y: 20 }, { x: 30, y: 30 }, { x: 40, y: 40 }, { x: 50, y: 50 }, { x: 60, y: 60 }, { x: 70, y: 70 }, { x: 80, y: 80 }],
         perfect_negative: [{ x: 10, y: 90 }, { x: 20, y: 80 }, { x: 30, y: 70 }, { x: 40, y: 60 }, { x: 50, y: 50 }, { x: 60, y: 40 }, { x: 70, y: 30 }, { x: 80, y: 20 }],
         no_correlation: [{ x: 10, y: 50 }, { x: 20, y: 20 }, { x: 30, y: 80 }, { x: 40, y: 40 }, { x: 50, y: 70 }, { x: 60, y: 10 }, { x: 70, y: 90 }, { x: 80, y: 30 }],
         strong_positive: [{ x: 10, y: 15 }, { x: 20, y: 30 }, { x: 30, y: 25 }, { x: 40, y: 55 }, { x: 50, y: 65 }, { x: 60, y: 60 }, { x: 70, y: 85 }, { x: 80, y: 95 }]
      };

      const handlePointDrag = (index: number, newX: number, newY: number) => {
         const newPoints = [...points];
         newPoints[index] = {
            x: Math.max(0, Math.min(100, newX)),
            y: Math.max(0, Math.min(100, newY))
         };
         setPoints(newPoints);
      };

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Correlation Lab</h2>
                  <p className="text-slate-500 italic font-serif">Relationship Strength Analyzer</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Correlation (r)</span>
                     <div className="flex items-center gap-2">
                        <div className="w-32 h-2 bg-slate-100 rounded-full overflow-hidden relative">
                           <div
                              className={`absolute h-full transition-all duration-500 ${r >= 0 ? 'bg-indigo-500' : 'bg-rose-500'}`}
                              style={{
                                 left: '50%',
                                 width: `${Math.abs(r) * 50}%`,
                                 transform: r < 0 ? 'translateX(-100%)' : 'none'
                              }}
                           />
                           <div className="absolute left-1/2 top-0 w-0.5 h-full bg-slate-300" />
                        </div>
                        <span className={`text-xl font-black min-w-[60px] text-right ${Math.abs(r) > 0.7 ? 'text-indigo-600' : 'text-slate-600'}`}>
                           {r.toFixed(2)}
                        </span>
                     </div>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-8 items-center justify-center">
               {/* SCATTER PLOT */}
               <div className="relative w-full max-w-lg aspect-square bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8">
                  <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                     {/* Grid Lines */}
                     {[0, 25, 50, 75, 100].map(val => (
                        <g key={val}>
                           <line x1={val} y1="0" x2={val} y2="100" stroke="#e2e8f0" strokeWidth="0.5" strokeDasharray="2 2" />
                           <line x1="0" y1={val} x2="100" y2={val} stroke="#e2e8f0" strokeWidth="0.5" strokeDasharray="2 2" />
                        </g>
                     ))}

                     {/* Best Fit Line */}
                     {showLine && (
                        <line
                           x1="0" y1={100 - b}
                           x2="100" y2={100 - (m * 100 + b)}
                           stroke="#4f46e5" strokeWidth="1" strokeDasharray="4 2"
                           className="transition-all duration-300"
                        />
                     )}

                     {/* Data Points */}
                     {points.map((p, i) => (
                        <g key={i} className="cursor-move group">
                           <circle
                              cx={p.x} cy={100 - p.y} r="2.5"
                              fill={Math.abs(r) > 0.7 ? "#4f46e5" : "#64748b"}
                              className="transition-colors duration-300 group-hover:fill-indigo-400"
                           />
                           {/* Invisible larger hit area for dragging */}
                           <circle
                              cx={p.x} cy={100 - p.y} r="6"
                              fill="transparent"
                              onMouseDown={(e) => {
                                 const svg = e.currentTarget.ownerSVGElement!;
                                 const startX = e.clientX;
                                 const startY = e.clientY;
                                 const initialX = p.x;
                                 const initialY = p.y;

                                 const onMouseMove = (moveEvent: MouseEvent) => {
                                    const rect = svg.getBoundingClientRect();
                                    const scale = 100 / rect.width;
                                    const dx = (moveEvent.clientX - startX) * scale;
                                    const dy = (moveEvent.clientY - startY) * scale;
                                    handlePointDrag(i, initialX + dx, initialY - dy);
                                 };

                                 const onMouseUp = () => {
                                    window.removeEventListener('mousemove', onMouseMove);
                                    window.removeEventListener('mouseup', onMouseUp);
                                 };

                                 window.addEventListener('mousemove', onMouseMove);
                                 window.addEventListener('mouseup', onMouseUp);
                              }}
                           />
                        </g>
                     ))}
                  </svg>
                  <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Variable X</div>
                  <div className="absolute left-2 top-1/2 -translate-y-1/2 -rotate-90 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Variable Y</div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-2 gap-3">
                     {Object.entries(presets).map(([key, data]) => (
                        <button
                           key={key}
                           onClick={() => setPoints(data)}
                           className="px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 text-[10px] font-bold text-slate-600 hover:bg-white hover:border-indigo-300 hover:text-indigo-600 transition-all capitalize"
                        >
                           {key.replace('_', ' ')}
                        </button>
                     ))}
                  </div>

                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-3">
                     <div className="flex justify-between items-center">
                        <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Interpretation</h4>
                        <button
                           onClick={() => setShowLine(!showLine)}
                           className={`px-2 py-1 rounded-lg text-[8px] font-bold uppercase tracking-widest transition-all ${showLine ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-400'}`}
                        >
                           Best Fit Line
                        </button>
                     </div>
                     <p className="text-sm font-bold">
                        {Math.abs(r) < 0.3 ? "Weak" : Math.abs(r) < 0.7 ? "Moderate" : "Strong"} {r >= 0 ? "Positive" : "Negative"} Relationship
                     </p>
                     <p className="text-[10px] opacity-80 leading-relaxed">
                        {Math.abs(r) > 0.9 ? "The points follow a near-perfect line." :
                           Math.abs(r) > 0.5 ? "There is a clear trend, but with some scatter." :
                              "The points are widely scattered with little linear pattern."}
                     </p>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-triangle-exclamation text-amber-500"></i>
                        Critical Insight
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        <strong>Correlation is NOT causation!</strong> Even if r = 1.00, it doesn't mean X <em>causes</em> Y. There could be a third variable at play.
                     </p>
                  </div>

                  <div className="flex flex-col gap-2">
                     <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <span>r¬≤ (Coefficient of Determination)</span>
                        <span className="text-slate-700">{(r * r * 100).toFixed(1)}%</span>
                     </div>
                     <div className="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div
                           className="h-full bg-indigo-400 transition-all duration-500"
                           style={{ width: `${r * r * 100}%` }}
                        />
                     </div>
                     <p className="text-[9px] text-slate-500 italic">
                        {(r * r * 100).toFixed(1)}% of the variation in Y can be explained by X.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 153: COMBINATIONS AND PERMUTATIONS RENDERER ---
   function CombinationsPermutationsRenderer() {
      const [n, setN] = useState(5);
      const [r, setR] = useState(3);
      const [mode, setMode] = useState<'permutation' | 'combination'>('permutation');

      const colors = ["#4f46e5", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899", "#06b6d4"];
      const items = Array.from({ length: n }, (_, i) => ({ id: i, color: colors[i % colors.length] }));

      const factorial = (num: number): number => {
         if (num <= 1) return 1;
         return num * factorial(num - 1);
      };

      const calculateCount = () => {
         if (r > n) return 0;
         const nFact = factorial(n);
         const nMinusRFact = factorial(n - r);

         if (mode === 'permutation') {
            return nFact / nMinusRFact;
         } else {
            return nFact / (factorial(r) * nMinusRFact);
         }
      };

      const count = calculateCount();

      // Generate a few example arrangements/selections
      const generateExamples = () => {
         const examples: number[][] = [];
         const indices = Array.from({ length: n }, (_, i) => i);

         if (mode === 'permutation') {
            // Simple shuffle-based examples for permutations
            for (let i = 0; i < Math.min(count, 6); i++) {
               const shuffled = [...indices].sort(() => Math.random() - 0.5);
               examples.push(shuffled.slice(0, r));
            }
         } else {
            // Simple selection-based examples for combinations
            for (let i = 0; i < Math.min(count, 6); i++) {
               const selection = [...indices].sort(() => Math.random() - 0.5).slice(0, r).sort((a, b) => a - b);
               // Ensure uniqueness for combinations in examples
               if (!examples.some(ex => ex.every((val, idx) => val === selection[idx]))) {
                  examples.push(selection);
               } else {
                  i--; // Try again
               }
            }
         }
         return examples;
      };

      const examples = generateExamples();

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Arrangement Academy</h2>
                  <p className="text-slate-500 italic font-serif">Order Matters?</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setMode('permutation')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'permutation' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Permutation
                  </button>
                  <button
                     onClick={() => setMode('combination')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'combination' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Combination
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-md space-y-8">
                  <div className="p-6 rounded-3xl bg-slate-50 border border-slate-100 shadow-inner">
                     <div className="flex flex-wrap gap-4 justify-center mb-8">
                        {items.map(item => (
                           <div
                              key={item.id}
                              className="w-10 h-10 rounded-full shadow-md flex items-center justify-center text-white font-bold text-xs"
                              style={{ backgroundColor: item.color }}
                           >
                              {String.fromCharCode(65 + item.id)}
                           </div>
                        ))}
                     </div>

                     <div className="text-center space-y-2">
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                           {mode === 'permutation' ? 'Possible Arrangements' : 'Possible Selections'}
                        </p>
                        <p className="text-4xl font-black text-slate-800">{count.toLocaleString()}</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Example {mode === 'permutation' ? 'Orderings' : 'Sets'}</p>
                     <div className="grid grid-cols-2 gap-4">
                        {examples.map((ex, i) => (
                           <div key={i} className="flex gap-2 justify-center p-2 rounded-xl bg-white border border-slate-100 shadow-sm">
                              {ex.map(idx => (
                                 <div
                                    key={idx}
                                    className="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold text-white"
                                    style={{ backgroundColor: items[idx].color }}
                                 >
                                    {String.fromCharCode(65 + idx)}
                                 </div>
                              ))}
                           </div>
                        ))}
                     </div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-4">
                     <div className="flex justify-between items-center">
                        <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">Formula</h4>
                        <span className="text-[10px] font-mono opacity-40">n = {n}, r = {r}</span>
                     </div>
                     <div className="text-2xl font-serif italic text-center py-2">
                        {mode === 'permutation' ? (
                           <>P(n,r) = n! / (n-r)!</>
                        ) : (
                           <>C(n,r) = n! / (r! ¬∑ (n-r)!)</>
                        )}
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed text-center">
                        {mode === 'permutation' ? (
                           "Order matters. ABC is different from CBA."
                        ) : (
                           "Order doesn't matter. {A,B,C} is the same as {C,B,A}."
                        )}
                     </p>
                  </div>

                  <div className="space-y-6">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Objects (n)</label>
                           <span className="text-xs font-bold text-slate-700">{n}</span>
                        </div>
                        <input
                           type="range" min="1" max="7" step="1"
                           value={n} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setN(val);
                              if (r > val) setR(val);
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Number to Select (r)</label>
                           <span className="text-xs font-bold text-slate-700">{r}</span>
                        </div>
                        <input
                           type="range" min="1" max={n} step="1"
                           value={r} onChange={(e) => setR(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-indigo-900">
                        <i className="fa-solid fa-briefcase text-indigo-500"></i>
                        Real World Context
                     </h4>
                     <p className="text-[10px] leading-relaxed text-indigo-800">
                        {mode === 'permutation' ? (
                           "Use Permutations for PIN codes, race results, or passwords where the sequence is critical."
                        ) : (
                           "Use Combinations for lottery numbers, committee members, or pizza toppings where the group is what matters."
                        )}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 154: CONDITIONAL PROBABILITY RENDERER ---
   function ConditionalProbabilityRenderer() {
      const [sizeA, setSizeA] = useState(60);
      const [sizeB, setSizeB] = useState(40);
      const [overlap, setOverlap] = useState(25);
      const [view, setView] = useState<'venn' | 'tree'>('venn');

      const total = 100;
      const pA = sizeA / total;
      const pB = sizeB / total;
      const pAandB = overlap / total;

      const pAgivenB = pB === 0 ? 0 : pAandB / pB;
      const pBgivenA = pA === 0 ? 0 : pAandB / pA;

      const isIndependent = Math.abs(pAgivenB - pA) < 0.01;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Probability Lab</h2>
                  <p className="text-slate-500 italic font-serif">Given That... "The Reduced Sample Space"</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setView('venn')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${view === 'venn' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Venn Diagram
                  </button>
                  <button
                     onClick={() => setView('tree')}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${view === 'tree' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                  >
                     Tree Diagram
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-md aspect-square bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8 flex items-center justify-center relative">
                  {view === 'venn' ? (
                     <svg viewBox="0 0 200 200" className="w-full h-full overflow-visible">
                        {/* Sample Space */}
                        <rect x="0" y="0" width="200" height="200" fill="none" stroke="#cbd5e1" strokeWidth="1" strokeDasharray="4 4" />
                        <text x="5" y="15" className="text-[10px] fill-slate-400 font-bold">Sample Space (S)</text>

                        {/* Circle A */}
                        <circle
                           cx={100 - (sizeA / 4)} cy="100" r={sizeA * 0.8}
                           fill="#4f46e5" fillOpacity="0.1" stroke="#4f46e5" strokeWidth="2"
                           className="transition-all duration-500"
                        />

                        {/* Circle B */}
                        <circle
                           cx={100 + (sizeB / 4) - (overlap / 2)} cy="100" r={sizeB * 0.8}
                           fill="#ec4899" fillOpacity="0.1" stroke="#ec4899" strokeWidth="2"
                           className="transition-all duration-500"
                        />

                        {/* Labels */}
                        <text x={100 - (sizeA / 2)} y="100" textAnchor="middle" className="text-xs font-bold fill-indigo-600">A</text>
                        <text x={100 + (sizeB / 2)} y="100" textAnchor="middle" className="text-xs font-bold fill-pink-600">B</text>
                        {overlap > 10 && (
                           <text x={100 - (overlap / 4)} y="100" textAnchor="middle" className="text-[10px] font-bold fill-slate-800">A‚à©B</text>
                        )}
                     </svg>
                  ) : (
                     <div className="w-full h-full flex flex-col justify-center gap-8 py-4">
                        {/* Root */}
                        <div className="flex items-center gap-12">
                           <div className="w-2 h-2 bg-slate-400 rounded-full" />
                           <div className="flex flex-col gap-16">
                              {/* Branch B */}
                              <div className="relative">
                                 <div className="absolute -left-12 top-1/2 w-12 h-0.5 bg-slate-200 -rotate-12 origin-left" />
                                 <div className="flex items-center gap-8">
                                    <div className="px-3 py-1 rounded-lg bg-pink-100 text-pink-700 text-[10px] font-bold">Event B (P={pB.toFixed(2)})</div>
                                    <div className="flex flex-col gap-4">
                                       <div className="flex items-center gap-4">
                                          <div className="w-8 h-0.5 bg-slate-200" />
                                          <div className="px-2 py-1 rounded-md bg-indigo-100 text-indigo-700 text-[8px] font-bold">A | B (P={pAgivenB.toFixed(2)})</div>
                                       </div>
                                       <div className="flex items-center gap-4">
                                          <div className="w-8 h-0.5 bg-slate-200" />
                                          <div className="px-2 py-1 rounded-md bg-slate-100 text-slate-500 text-[8px] font-bold">Not A | B (P={(1 - pAgivenB).toFixed(2)})</div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                              {/* Branch Not B */}
                              <div className="relative">
                                 <div className="absolute -left-12 top-1/2 w-12 h-0.5 bg-slate-200 rotate-12 origin-left" />
                                 <div className="px-3 py-1 rounded-lg bg-slate-100 text-slate-500 text-[10px] font-bold">Not B (P={(1 - pB).toFixed(2)})</div>
                              </div>
                           </div>
                        </div>
                     </div>
                  )}
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                     <div className="p-4 rounded-2xl bg-indigo-600 text-white text-center">
                        <span className="text-[10px] font-bold opacity-60 uppercase tracking-widest">P(A | B)</span>
                        <p className="text-2xl font-black">{pAgivenB.toFixed(3)}</p>
                        <p className="text-[8px] opacity-80 mt-1">Prob of A, GIVEN B</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-pink-600 text-white text-center">
                        <span className="text-[10px] font-bold opacity-60 uppercase tracking-widest">P(B | A)</span>
                        <p className="text-2xl font-black">{pBgivenA.toFixed(3)}</p>
                        <p className="text-[8px] opacity-80 mt-1">Prob of B, GIVEN A</p>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Size of Event A</label>
                           <span className="text-xs font-bold text-slate-700">{sizeA}%</span>
                        </div>
                        <input
                           type="range" min="10" max="80" step="1"
                           value={sizeA} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setSizeA(val);
                              if (overlap > Math.min(val, sizeB)) setOverlap(Math.min(val, sizeB));
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                        />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Size of Event B</label>
                           <span className="text-xs font-bold text-slate-700">{sizeB}%</span>
                        </div>
                        <input
                           type="range" min="10" max="80" step="1"
                           value={sizeB} onChange={(e) => {
                              const val = parseInt(e.target.value);
                              setSizeB(val);
                              if (overlap > Math.min(sizeA, val)) setOverlap(Math.min(sizeA, val));
                           }}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-600"
                        />
                     </div>
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Overlap (A ‚à© B)</label>
                           <span className="text-xs font-bold text-slate-700">{overlap}%</span>
                        </div>
                        <input
                           type="range" min="0" max={Math.min(sizeA, sizeB)} step="1"
                           value={overlap} onChange={(e) => setOverlap(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className={`p-4 rounded-2xl border transition-all ${isIndependent ? 'bg-emerald-50 border-emerald-100 text-emerald-800' : 'bg-amber-50 border-amber-100 text-amber-800'}`}>
                     <h4 className="text-xs font-bold mb-1 flex items-center gap-2">
                        <i className={`fa-solid ${isIndependent ? 'fa-check-circle' : 'fa-circle-nodes'}`}></i>
                        {isIndependent ? 'Independent Events' : 'Dependent Events'}
                     </h4>
                     <p className="text-[10px] leading-relaxed opacity-90">
                        {isIndependent
                           ? "Knowing B occurred does NOT change the probability of A. P(A|B) = P(A)."
                           : `Knowing B occurred changes the probability of A from ${pA.toFixed(2)} to ${pAgivenB.toFixed(2)}.`}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- CONCEPT 155: MARGIN OF ERROR RENDERER ---
   function MarginOfErrorRenderer() {
      const [n, setN] = useState(1000);
      const [confidence, setConfidence] = useState(0.95);
      const [p, setP] = useState(0.52); // Point estimate (e.g., 52% support)

      const zScores: Record<number, number> = { 0.90: 1.645, 0.95: 1.96, 0.99: 2.576 };
      const z = zScores[confidence];

      const moe = z * Math.sqrt((p * (1 - p)) / n);
      const lowerBound = p - moe;
      const upperBound = p + moe;

      return (
         <div className="w-full h-full bg-white flex flex-col p-6 overflow-auto">
            <div className="flex justify-between items-start mb-8">
               <div>
                  <h2 className="text-2xl font-bold text-slate-800">Poll Predictor</h2>
                  <p className="text-slate-500 italic font-serif">Understanding the "Plus or Minus"</p>
               </div>
               <div className="flex gap-2">
                  <div className="px-4 py-2 rounded-xl bg-slate-800 text-white flex flex-col items-center min-w-[120px]">
                     <span className="text-xs font-bold opacity-60 uppercase tracking-widest">Margin of Error</span>
                     <span className="text-xl font-black">¬±{(moe * 100).toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row gap-12 items-center justify-center">
               {/* VISUALIZER */}
               <div className="w-full max-w-lg space-y-12">
                  <div className="relative h-40 bg-slate-50 rounded-3xl border border-slate-100 shadow-inner p-8 flex items-center">
                     <svg viewBox="0 0 400 100" className="w-full overflow-visible">
                        {/* Scale */}
                        <line x1="0" y1="80" x2="400" y2="80" stroke="#cbd5e1" strokeWidth="1" />
                        {[0, 0.25, 0.5, 0.75, 1].map(val => (
                           <g key={val}>
                              <line x1={val * 400} y1="75" x2={val * 400} y2="85" stroke="#cbd5e1" strokeWidth="1" />
                              <text x={val * 400} y="95" textAnchor="middle" className="text-[10px] fill-slate-400 font-bold">{val * 100}%</text>
                           </g>
                        ))}

                        {/* Error Bar */}
                        <line
                           x1={lowerBound * 400} y1="40"
                           x2={upperBound * 400} y2="40"
                           stroke="#4f46e5" strokeWidth="4" strokeLinecap="round"
                           className="transition-all duration-500"
                        />
                        <line x1={lowerBound * 400} y1="30" x2={lowerBound * 400} y2="50" stroke="#4f46e5" strokeWidth="2" className="transition-all duration-500" />
                        <line x1={upperBound * 400} y1="30" x2={upperBound * 400} y2="50" stroke="#4f46e5" strokeWidth="2" className="transition-all duration-500" />

                        {/* Point Estimate */}
                        <circle
                           cx={p * 400} cy="40" r="6"
                           fill="#1e293b"
                           className="transition-all duration-500"
                        />
                        <text x={p * 400} y="25" textAnchor="middle" className="text-xs font-bold fill-slate-800">{(p * 100).toFixed(1)}%</text>
                     </svg>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                     <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100 text-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Lower Bound</span>
                        <p className="text-lg font-black text-slate-700">{(lowerBound * 100).toFixed(1)}%</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-indigo-50 border border-indigo-100 text-center">
                        <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Confidence</span>
                        <p className="text-lg font-black text-indigo-700">{(confidence * 100).toFixed(0)}%</p>
                     </div>
                     <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100 text-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Upper Bound</span>
                        <p className="text-lg font-black text-slate-700">{(upperBound * 100).toFixed(1)}%</p>
                     </div>
                  </div>
               </div>

               {/* CONTROLS */}
               <div className="w-full max-w-sm space-y-6">
                  <div className="p-4 rounded-2xl bg-slate-800 text-white space-y-4">
                     <h4 className="text-xs font-bold uppercase tracking-widest opacity-60">The Math</h4>
                     <div className="text-lg font-serif italic text-center py-2">
                        MoE = z * ‚àö[p(1-p) / n]
                     </div>
                     <p className="text-[10px] opacity-80 leading-relaxed text-center">
                        The Margin of Error tells you how much the poll results might differ from the real world.
                     </p>
                  </div>

                  <div className="space-y-6">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sample Size (n)</label>
                           <span className="text-xs font-bold text-slate-700">{n.toLocaleString()} people</span>
                        </div>
                        <input
                           type="range" min="100" max="5000" step="100"
                           value={n} onChange={(e) => setN(parseInt(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                        <p className="text-[9px] text-slate-400 mt-1 italic">Larger sample = smaller error.</p>
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Confidence Level</label>
                        </div>
                        <div className="flex gap-2">
                           {[0.90, 0.95, 0.99].map(level => (
                              <button
                                 key={level}
                                 onClick={() => setConfidence(level)}
                                 className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${confidence === level ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                              >
                                 {level * 100}%
                              </button>
                           ))}
                        </div>
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Poll Result (p)</label>
                           <span className="text-xs font-bold text-slate-700">{(p * 100).toFixed(0)}%</span>
                        </div>
                        <input
                           type="range" min="0.1" max="0.9" step="0.01"
                           value={p} onChange={(e) => setP(parseFloat(e.target.value))}
                           className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800"
                        />
                     </div>
                  </div>

                  <div className="p-4 rounded-2xl bg-amber-50 border border-amber-100">
                     <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-amber-900">
                        <i className="fa-solid fa-circle-info text-amber-500"></i>
                        Statistical Significance
                     </h4>
                     <p className="text-[10px] leading-relaxed text-amber-800">
                        If two candidates are within each other's Margin of Error, the race is considered a <strong>"Statistical Dead Heat"</strong> or "Too Close to Call."
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   }

   // --- ENHANCED ROCKET ENGINE RENDERER ---
   const RocketEngineRenderer = () => {
      const [throttle, setThrottle] = useState(60);
      const [mixtureRatio, setMixtureRatio] = useState(2.5); // O/F Ratio
      const [isFiring, setIsFiring] = useState(false);
      const [burnTime, setBurnTime] = useState(0);
      const [challengeComplete, setChallengeComplete] = useState(false);

      // Physics Calculations
      const idealRatio = 2.56; // Optimal O/F for LOX/RP-1
      const ratioEfficiency = Math.max(0, 1 - Math.abs(mixtureRatio - idealRatio) * 0.4);
      const thrust = Math.floor(throttle * 9.5 * ratioEfficiency);
      const chamberTemp = Math.floor(2800 + (throttle * 6) - (Math.abs(mixtureRatio - idealRatio) * 600));
      const chamberPressure = Math.floor(throttle * 2.8);
      const exhaustVelocity = Math.floor(2800 + ratioEfficiency * 500);
      const specificImpulse = Math.floor(exhaustVelocity / 9.8);
      const fuelFlow = (throttle / 100) * 55;
      const oxidizerFlow = fuelFlow * mixtureRatio;
      const totalMassFlow = fuelFlow + oxidizerFlow;

      // Status indicators
      const isRich = mixtureRatio < idealRatio - 0.4;
      const isLean = mixtureRatio > idealRatio + 0.4;
      const isOverheat = chamberTemp > 3400;
      const isUnderPressure = chamberPressure < 100 && isFiring;
      const efficiencyPercent = Math.round(ratioEfficiency * 100);

      // Challenge: Achieve 800+ kN thrust with stable temp
      const goalMet = thrust >= 800 && !isOverheat && isFiring;

      // Burn timer
      React.useEffect(() => {
         let interval: NodeJS.Timeout;
         if (isFiring) {
            interval = setInterval(() => {
               setBurnTime(prev => prev + 0.1);
               if (goalMet && !challengeComplete) {
                  setChallengeComplete(true);
               }
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isFiring, goalMet, challengeComplete]);

      // Flame animation height
      const flameHeight = isFiring ? Math.min(150, thrust / 5) : 0;
      const flameOpacity = isFiring ? Math.min(1, throttle / 80) : 0;

      return (
         <div className="w-full h-full bg-slate-900 text-slate-100 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 relative flex items-center justify-center p-4 overflow-hidden">
               {/* Grid background */}
               <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:30px_30px]"></div>

               {/* Engine Schematic */}
               <div className="relative z-10 w-full max-w-md">
                  <svg viewBox="0 0 400 650" className="w-full h-auto">
                     <defs>
                        <linearGradient id="loxGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#3b82f6" />
                           <stop offset="100%" stopColor="#1e40af" />
                        </linearGradient>
                        <linearGradient id="rp1Gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#f97316" />
                           <stop offset="100%" stopColor="#c2410c" />
                        </linearGradient>
                        <linearGradient id="chamberGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#334155" />
                           <stop offset="100%" stopColor="#1e293b" />
                        </linearGradient>
                        <linearGradient id="flameGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#fbbf24" />
                           <stop offset="30%" stopColor="#f97316" />
                           <stop offset="100%" stopColor="#ef4444" />
                        </linearGradient>
                        <filter id="glow">
                           <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                           <feMerge>
                              <feMergeNode in="coloredBlur" />
                              <feMergeNode in="SourceGraphic" />
                           </feMerge>
                        </filter>
                     </defs>

                     {/* LOX Tank */}
                     <g>
                        <rect x="80" y="30" width="100" height="120" rx="10" fill="url(#loxGradient)" stroke="#60a5fa" strokeWidth="2" />
                        <text x="130" y="75" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">LIQUID</text>
                        <text x="130" y="90" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">OXYGEN</text>
                        <text x="130" y="115" textAnchor="middle" fill="#93c5fd" fontSize="10">-183¬∞C</text>
                        <text x="130" y="135" textAnchor="middle" fill="#93c5fd" fontSize="9">{oxidizerFlow.toFixed(1)} kg/s</text>
                     </g>

                     {/* RP-1 Tank */}
                     <g>
                        <rect x="220" y="30" width="100" height="120" rx="10" fill="url(#rp1Gradient)" stroke="#fb923c" strokeWidth="2" />
                        <text x="270" y="75" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">RP-1</text>
                        <text x="270" y="90" textAnchor="middle" fill="white" fontSize="11" fontWeight="bold">KEROSENE</text>
                        <text x="270" y="115" textAnchor="middle" fill="#fed7aa" fontSize="10">20¬∞C</text>
                        <text x="270" y="135" textAnchor="middle" fill="#fed7aa" fontSize="9">{fuelFlow.toFixed(1)} kg/s</text>
                     </g>

                     {/* Fuel Lines */}
                     <path d="M130 150 L130 200 L175 230" fill="none" stroke="#60a5fa" strokeWidth="6" strokeLinecap="round" />
                     <path d="M270 150 L270 200 L225 230" fill="none" stroke="#fb923c" strokeWidth="6" strokeLinecap="round" />

                     {/* Flow indicators when firing */}
                     {isFiring && (
                        <>
                           <circle r="4" fill="#93c5fd">
                              <animateMotion dur="0.5s" repeatCount="indefinite" path="M130 150 L130 200 L175 230" />
                           </circle>
                           <circle r="4" fill="#fdba74">
                              <animateMotion dur="0.5s" repeatCount="indefinite" path="M270 150 L270 200 L225 230" />
                           </circle>
                        </>
                     )}

                     {/* Turbopump */}
                     <g>
                        <circle cx="200" cy="250" r="35" fill="#475569" stroke="#94a3b8" strokeWidth="3" />
                        <text x="200" y="245" textAnchor="middle" fill="white" fontSize="8" fontWeight="bold">TURBO</text>
                        <text x="200" y="258" textAnchor="middle" fill="white" fontSize="8" fontWeight="bold">PUMP</text>
                        {isFiring && (
                           <g transform="translate(200, 250)">
                              <path d="M-12,-12 L12,12 M-12,12 L12,-12 M0,-15 L0,15 M-15,0 L15,0" stroke="#94a3b8" strokeWidth="2">
                                 <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="0.3s" repeatCount="indefinite" />
                              </path>
                           </g>
                        )}
                     </g>

                     {/* Injector Plate */}
                     <rect x="160" y="295" width="80" height="15" rx="3" fill="#64748b" stroke="#94a3b8" strokeWidth="2" />
                     <text x="200" y="290" textAnchor="middle" fill="#94a3b8" fontSize="8">INJECTOR</text>

                     {/* Combustion Chamber */}
                     <g>
                        <path d="M160 310 Q140 370 160 410 L240 410 Q260 370 240 310 Z"
                           fill="url(#chamberGradient)"
                           stroke={isOverheat ? "#ef4444" : "#94a3b8"}
                           strokeWidth="3" />
                        {isFiring && (
                           <ellipse cx="200" cy="360" rx="30" ry="20" fill="#fbbf24" opacity="0.6">
                              <animate attributeName="opacity" values="0.4;0.8;0.4" dur="0.2s" repeatCount="indefinite" />
                           </ellipse>
                        )}
                     </g>

                     {/* Chamber Labels */}
                     <g>
                        <text x="290" y="330" fill="#94a3b8" fontSize="9">Chamber</text>
                        <text x="290" y="345" fill={chamberTemp > 3200 ? "#f87171" : "#22c55e"} fontSize="11" fontWeight="bold">{isFiring ? chamberTemp : 20}¬∞C</text>
                        <text x="290" y="365" fill="#94a3b8" fontSize="9">Pressure</text>
                        <text x="290" y="380" fill="#22c55e" fontSize="11" fontWeight="bold">{isFiring ? chamberPressure : 0} bar</text>
                     </g>

                     {/* Nozzle */}
                     <path d="M160 410 L120 530 L280 530 L240 410" fill="#1e293b" stroke="#94a3b8" strokeWidth="3" />
                     <text x="200" y="480" textAnchor="middle" fill="#64748b" fontSize="10">NOZZLE</text>

                     {/* Exhaust Plume */}
                     {isFiring && (
                        <g filter="url(#glow)">
                           <path
                              d={`M130 530 Q${200 + Math.sin(burnTime * 10) * 20} ${530 + flameHeight / 2} ${200} ${530 + flameHeight} Q${200 - Math.sin(burnTime * 10) * 20} ${530 + flameHeight / 2} 270 530 Z`}
                              fill="url(#flameGradient)"
                              opacity={flameOpacity}
                           >
                              <animate attributeName="d"
                                 values={`M130 530 Q180 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q220 ${530 + flameHeight / 2} 270 530 Z;M130 530 Q220 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q180 ${530 + flameHeight / 2} 270 530 Z;M130 530 Q180 ${530 + flameHeight / 2} 200 ${530 + flameHeight} Q220 ${530 + flameHeight / 2} 270 530 Z`}
                                 dur="0.15s"
                                 repeatCount="indefinite" />
                           </path>
                           <ellipse cx="200" cy="535" rx="50" ry="10" fill="#fef3c7" opacity="0.7" />
                        </g>
                     )}

                     {/* Thrust Vector */}
                     {isFiring && (
                        <g>
                           <text x="200" y={545 + flameHeight + 20} textAnchor="middle" fill="#fbbf24" fontSize="14" fontWeight="bold">
                              {thrust} kN
                           </text>
                        </g>
                     )}
                  </svg>

                  {/* Warning Overlays */}
                  {isOverheat && isFiring && (
                     <div className="absolute top-1/3 left-1/2 -translate-x-1/2 bg-red-600/95 text-white px-6 py-3 rounded-xl font-bold animate-pulse shadow-2xl border-2 border-red-400 z-20">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">üî•</span>
                           <div>
                              <div className="text-sm font-black uppercase">OVERHEAT WARNING</div>
                              <div className="text-xs opacity-80">Reduce throttle or adjust O/F ratio</div>
                           </div>
                        </div>
                     </div>
                  )}

                  {challengeComplete && (
                     <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-green-600/95 text-white px-6 py-3 rounded-xl font-bold shadow-2xl border-2 border-green-400 z-20">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">üéâ</span>
                           <div>
                              <div className="text-sm font-black uppercase">CHALLENGE COMPLETE!</div>
                              <div className="text-xs opacity-80">Achieved 800+ kN stable thrust</div>
                           </div>
                        </div>
                     </div>
                  )}
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-slate-800 p-6 border-l border-slate-700 flex flex-col gap-5 overflow-y-auto">
               {/* Header */}
               <div className="flex items-center justify-between border-b border-slate-700 pb-4">
                  <div className="flex items-center gap-3">
                     <div className={`w-3 h-3 rounded-full ${isFiring ? 'bg-green-500 animate-pulse shadow-lg shadow-green-500/50' : 'bg-slate-500'}`}></div>
                     <h2 className="text-sm font-black uppercase tracking-widest text-slate-300">Engine Control</h2>
                  </div>
                  {isFiring && (
                     <div className="text-xs font-mono text-slate-400">
                        T+{burnTime.toFixed(1)}s
                     </div>
                  )}
               </div>

               {/* Challenge Goal */}
               <div className={`p-3 rounded-xl border ${goalMet ? 'bg-green-900/30 border-green-600' : 'bg-slate-700/30 border-slate-600'}`}>
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-1">üéØ Challenge</div>
                  <div className="text-sm font-bold text-white">Achieve 800+ kN thrust without overheating</div>
                  <div className={`text-xs mt-1 ${goalMet ? 'text-green-400' : 'text-slate-400'}`}>
                     {goalMet ? '‚úì Goal achieved!' : `Current: ${thrust} kN`}
                  </div>
               </div>

               {/* Throttle Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-blue-300 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-gauge-high"></i> Throttle
                     </label>
                     <span className="text-sm font-mono font-bold text-white">{throttle}%</span>
                  </div>
                  <input
                     type="range" min="0" max="110" value={throttle}
                     onChange={(e) => setThrottle(Number(e.target.value))}
                     className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[9px] text-slate-500 mt-1">
                     <span>IDLE</span>
                     <span>MAX</span>
                     <span className="text-amber-400">OVERDRIVE</span>
                  </div>
               </div>

               {/* Mixture Ratio Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-orange-300 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-droplet"></i> O/F Ratio
                     </label>
                     <span className={`text-sm font-mono font-bold ${isRich ? 'text-blue-400' : isLean ? 'text-orange-400' : 'text-green-400'}`}>
                        {mixtureRatio.toFixed(2)} {isRich ? '(Rich)' : isLean ? '(Lean)' : '(Optimal)'}
                     </span>
                  </div>
                  <input
                     type="range" min="1.5" max="3.5" step="0.05" value={mixtureRatio}
                     onChange={(e) => setMixtureRatio(Number(e.target.value))}
                     className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-orange-500"
                  />
                  <div className="flex justify-between text-[9px] mt-1">
                     <span className="text-blue-400">Fuel Rich</span>
                     <span className="text-green-400">‚Üì Optimal: 2.56</span>
                     <span className="text-orange-400">Oxidizer Rich</span>
                  </div>
               </div>

               {/* Metrics Grid */}
               <div className="grid grid-cols-2 gap-3">
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Thrust</div>
                     <div className="text-2xl font-mono font-bold text-white">{isFiring ? thrust : 0} <span className="text-sm">kN</span></div>
                  </div>
                  <div className={`p-3 rounded-xl border ${isOverheat ? 'bg-red-900/30 border-red-600' : 'bg-slate-700/50 border-slate-600'}`}>
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Chamber Temp</div>
                     <div className={`text-2xl font-mono font-bold ${isOverheat ? 'text-red-400' : 'text-white'}`}>
                        {isFiring ? chamberTemp : 20} <span className="text-sm">¬∞C</span>
                     </div>
                  </div>
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Specific Impulse</div>
                     <div className="text-xl font-mono font-bold text-white">{isFiring ? specificImpulse : 0} <span className="text-sm">s</span></div>
                  </div>
                  <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                     <div className="text-[9px] font-black uppercase text-slate-400 mb-1">Efficiency</div>
                     <div className={`text-xl font-mono font-bold ${efficiencyPercent > 90 ? 'text-green-400' : efficiencyPercent > 70 ? 'text-amber-400' : 'text-red-400'}`}>
                        {efficiencyPercent}%
                     </div>
                  </div>
               </div>

               {/* Mass Flow Display */}
               <div className="bg-slate-700/30 p-3 rounded-xl border border-slate-600">
                  <div className="text-[9px] font-black uppercase text-slate-400 mb-2">Mass Flow Rate</div>
                  <div className="flex justify-between items-center text-sm">
                     <span className="text-blue-300">LOX: {oxidizerFlow.toFixed(1)} kg/s</span>
                     <span className="text-slate-400">|</span>
                     <span className="text-orange-300">RP-1: {fuelFlow.toFixed(1)} kg/s</span>
                  </div>
                  <div className="mt-1 text-xs text-slate-400">
                     Total: {totalMassFlow.toFixed(1)} kg/s
                  </div>
               </div>

               {/* Ignition Button */}
               <button
                  onClick={() => {
                     setIsFiring(!isFiring);
                     if (!isFiring) setBurnTime(0);
                  }}
                  className={`w-full py-4 rounded-xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all ${isFiring
                     ? 'bg-gradient-to-r from-red-600 to-red-700 text-white hover:from-red-700 hover:to-red-800'
                     : 'bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800'
                     }`}
               >
                  {isFiring ? 'üõë ENGINE CUTOFF' : 'üî• IGNITE ENGINE'}
               </button>

               {/* Educational Insight */}
               <div className="flex gap-3 p-3 bg-slate-700/30 rounded-xl border border-slate-600">
                  <div className="w-8 h-8 rounded-full bg-amber-500/20 text-amber-400 flex items-center justify-center shrink-0">
                     <i className="fa-solid fa-lightbulb"></i>
                  </div>
                  <p className="text-xs text-slate-300 leading-relaxed">
                     <strong>Insight:</strong> The O/F ratio controls the balance between efficiency and cooling.
                     Too lean (high O/F) burns hotter but more efficiently. Too rich provides cooling but wastes fuel.
                     Real Merlin engines use O/F ‚âà 2.56 for optimal performance.
                  </p>
               </div>
            </div>
         </div>
      );
   };

   // --- COMPOUND INTEREST RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Time > Amount due to exponential growth
   // Stage 2: Primary = starting age, Secondary = contribution, rate
   // Stage 3: Growth curve with contribution band, milestone markers
   // Stage 4: FV = PMT √ó (((1 + r)^t - 1) / r), curve reshapes at 60fps
   // Stage 5: State ‚Üí Derived ‚Üí Visual flow
   // Stage 6: Challenge = "Reach $1M"
   const CompoundInterestRenderer = () => {
      const [startAge, setStartAge] = useState(30);
      const [monthlyContribution, setMonthlyContribution] = useState(500);
      const [annualReturn, setAnnualReturn] = useState(0.07);
      const [showComparison, setShowComparison] = useState(false);
      const [comparisonAge, setComparisonAge] = useState(40);
      const [challengeMode, setChallengeMode] = useState(false);
      const retirementAge = 65;

      // Derived calculations
      const yearsInvesting = retirementAge - startAge;
      const monthsInvesting = yearsInvesting * 12;
      const monthlyRate = annualReturn / 12;

      // Future Value with regular contributions: FV = PMT √ó (((1 + r)^n - 1) / r)
      const calculateFV = (months: number, contribution: number, rate: number) => {
         if (rate === 0) return contribution * months;
         return contribution * ((Math.pow(1 + rate, months) - 1) / rate);
      };

      const finalBalance = calculateFV(monthsInvesting, monthlyContribution, monthlyRate);
      const totalContributed = monthlyContribution * monthsInvesting;
      const interestEarned = finalBalance - totalContributed;
      const interestPercentage = finalBalance > 0 ? (interestEarned / finalBalance) * 100 : 0;

      // Comparison calculations
      const compYears = retirementAge - comparisonAge;
      const compMonths = compYears * 12;
      const compBalance = calculateFV(compMonths, monthlyContribution, monthlyRate);

      // Challenge: $1M goal
      const goalAmount = 1000000;
      const goalReached = finalBalance >= goalAmount;

      // Generate curve points for visualization
      const generateCurvePoints = (startAge: number, contribution: number): { x: number, y: number }[] => {
         const points: { x: number, y: number }[] = [];
         const years = retirementAge - startAge;
         for (let year = 0; year <= years; year++) {
            const months = year * 12;
            const balance = calculateFV(months, contribution, monthlyRate);
            points.push({ x: startAge + year, y: balance });
         }
         return points;
      };

      const curvePoints = generateCurvePoints(startAge, monthlyContribution);
      const comparisonPoints = showComparison ? generateCurvePoints(comparisonAge, monthlyContribution) : [];

      // SVG dimensions and scaling
      const chartWidth = 700;
      const chartHeight = 350;
      const padding = { top: 40, right: 40, bottom: 50, left: 80 };
      const innerWidth = chartWidth - padding.left - padding.right;
      const innerHeight = chartHeight - padding.top - padding.bottom;

      // Find max Y for scaling
      const maxY = Math.max(finalBalance, showComparison ? compBalance : 0, goalAmount) * 1.1;

      // Scale functions
      const scaleX = (age: number) => padding.left + ((age - 20) / (retirementAge - 20)) * innerWidth;
      const scaleY = (value: number) => padding.top + innerHeight - (value / maxY) * innerHeight;

      // Generate path string
      const generatePath = (points: { x: number, y: number }[]) => {
         if (points.length === 0) return '';
         return points.map((p, i) =>
            `${i === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`
         ).join(' ');
      };

      // Generate filled area path (for contributions)
      const generateAreaPath = () => {
         const contributionPoints: { x: number, y: number }[] = [];
         const years = yearsInvesting;
         for (let year = 0; year <= years; year++) {
            const months = year * 12;
            const contributed = monthlyContribution * months;
            contributionPoints.push({ x: startAge + year, y: contributed });
         }

         const forward = contributionPoints.map((p, i) =>
            `${i === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`
         ).join(' ');

         const backward = [...contributionPoints].reverse().map(p =>
            `L ${scaleX(p.x)} ${scaleY(0)}`
         ).join(' ');

         return forward + ' ' + backward + ' Z';
      };

      // Format currency
      const formatCurrency = (value: number) => {
         if (value >= 1000000) return `$${(value / 1000000).toFixed(2)}M`;
         if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
         return `$${value.toFixed(0)}`;
      };

      return (
         <div className="w-full h-full bg-gradient-to-br from-slate-50 to-blue-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-4 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Compound Interest Calculator</h2>
                     <p className="text-sm text-slate-500">Discover why time is your most powerful asset</p>
                  </div>
                  <div className="flex items-center gap-3">
                     <button
                        onClick={() => setShowComparison(!showComparison)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${showComparison
                           ? 'bg-purple-500 text-white'
                           : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                           }`}
                     >
                        {showComparison ? 'üìä Comparison ON' : 'üìä Compare'}
                     </button>
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode
                           ? 'bg-amber-500 text-white'
                           : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-4 p-3 rounded-xl border-2 ${goalReached
                     ? 'bg-green-50 border-green-300 text-green-800'
                     : 'bg-amber-50 border-amber-300 text-amber-800'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-2xl">{goalReached ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold">
                                 {goalReached ? 'MILLIONAIRE ACHIEVED!' : 'The Millionaire Race'}
                              </div>
                              <div className="text-xs opacity-80">
                                 {goalReached
                                    ? `You'll have ${formatCurrency(finalBalance)} at retirement!`
                                    : `Adjust controls to reach $1,000,000 by age ${retirementAge}`
                                 }
                              </div>
                           </div>
                        </div>
                        <div className="text-right">
                           <div className="text-lg font-mono font-bold">
                              {formatCurrency(finalBalance)}
                           </div>
                           <div className="text-xs opacity-70">
                              / $1,000,000
                           </div>
                        </div>
                     </div>
                  </div>
               )}

               {/* SVG Chart */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200">
                  <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full h-full">
                     <defs>
                        <linearGradient id="growthGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#22c55e" stopOpacity="0.3" />
                           <stop offset="100%" stopColor="#22c55e" stopOpacity="0.05" />
                        </linearGradient>
                        <linearGradient id="contributionGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.4" />
                           <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.1" />
                        </linearGradient>
                     </defs>

                     {/* Grid lines */}
                     {[0, 0.25, 0.5, 0.75, 1].map(ratio => (
                        <g key={ratio}>
                           <line
                              x1={padding.left}
                              y1={scaleY(maxY * ratio)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(maxY * ratio)}
                              stroke="#e2e8f0"
                              strokeDasharray={ratio === 0 ? "0" : "4 4"}
                           />
                           <text
                              x={padding.left - 10}
                              y={scaleY(maxY * ratio) + 4}
                              textAnchor="end"
                              fill="#94a3b8"
                              fontSize="10"
                           >
                              {formatCurrency(maxY * ratio)}
                           </text>
                        </g>
                     ))}

                     {/* Age axis */}
                     {[20, 30, 40, 50, 60, 65].map(age => (
                        <g key={age}>
                           <line
                              x1={scaleX(age)}
                              y1={padding.top}
                              x2={scaleX(age)}
                              y2={chartHeight - padding.bottom}
                              stroke="#e2e8f0"
                              strokeDasharray="4 4"
                           />
                           <text
                              x={scaleX(age)}
                              y={chartHeight - padding.bottom + 20}
                              textAnchor="middle"
                              fill="#64748b"
                              fontSize="11"
                              fontWeight="bold"
                           >
                              {age}
                           </text>
                        </g>
                     ))}
                     <text
                        x={chartWidth / 2}
                        y={chartHeight - 10}
                        textAnchor="middle"
                        fill="#94a3b8"
                        fontSize="12"
                     >
                        Age
                     </text>

                     {/* $1M Goal line */}
                     {challengeMode && (
                        <g>
                           <line
                              x1={padding.left}
                              y1={scaleY(goalAmount)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(goalAmount)}
                              stroke={goalReached ? "#22c55e" : "#fbbf24"}
                              strokeWidth="2"
                              strokeDasharray="8 4"
                           />
                           <text
                              x={chartWidth - padding.right + 5}
                              y={scaleY(goalAmount) + 4}
                              fill={goalReached ? "#22c55e" : "#fbbf24"}
                              fontSize="10"
                              fontWeight="bold"
                           >
                              $1M GOAL
                           </text>
                        </g>
                     )}

                     {/* Contribution area (what you put in) */}
                     <path
                        d={generateAreaPath()}
                        fill="url(#contributionGradient)"
                     />

                     {/* Comparison curve (ghost) */}
                     {showComparison && comparisonPoints.length > 0 && (
                        <path
                           d={generatePath(comparisonPoints)}
                           fill="none"
                           stroke="#a855f7"
                           strokeWidth="3"
                           strokeDasharray="8 4"
                           opacity="0.7"
                        />
                     )}

                     {/* Main growth curve */}
                     <path
                        d={generatePath(curvePoints)}
                        fill="none"
                        stroke="#22c55e"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Current position marker */}
                     <g>
                        <circle
                           cx={scaleX(startAge)}
                           cy={scaleY(0)}
                           r="8"
                           fill="#3b82f6"
                           stroke="#fff"
                           strokeWidth="3"
                        />
                        <text
                           x={scaleX(startAge)}
                           y={scaleY(0) + 25}
                           textAnchor="middle"
                           fill="#3b82f6"
                           fontSize="10"
                           fontWeight="bold"
                        >
                           START
                        </text>
                     </g>

                     {/* End point marker */}
                     <g>
                        <circle
                           cx={scaleX(retirementAge)}
                           cy={scaleY(finalBalance)}
                           r="10"
                           fill={goalReached ? "#22c55e" : "#f59e0b"}
                           stroke="#fff"
                           strokeWidth="3"
                        >
                           {goalReached && (
                              <animate attributeName="r" values="10;14;10" dur="1s" repeatCount="3" />
                           )}
                        </circle>
                        <text
                           x={scaleX(retirementAge)}
                           y={scaleY(finalBalance) - 18}
                           textAnchor="middle"
                           fill="#1e293b"
                           fontSize="14"
                           fontWeight="bold"
                        >
                           {formatCurrency(finalBalance)}
                        </text>
                     </g>

                     {/* Comparison end point */}
                     {showComparison && (
                        <g>
                           <circle
                              cx={scaleX(retirementAge)}
                              cy={scaleY(compBalance)}
                              r="8"
                              fill="#a855f7"
                              stroke="#fff"
                              strokeWidth="3"
                           />
                           <text
                              x={scaleX(retirementAge) + 25}
                              y={scaleY(compBalance) + 4}
                              fill="#a855f7"
                              fontSize="11"
                              fontWeight="bold"
                           >
                              {formatCurrency(compBalance)}
                           </text>
                        </g>
                     )}

                     {/* Legend */}
                     <g transform={`translate(${padding.left + 10}, ${padding.top + 10})`}>
                        <rect x="0" y="0" width="12" height="12" fill="#22c55e" rx="2" />
                        <text x="18" y="10" fill="#64748b" fontSize="10">Interest Earned</text>
                        <rect x="0" y="18" width="12" height="12" fill="#3b82f6" opacity="0.5" rx="2" />
                        <text x="18" y="28" fill="#64748b" fontSize="10">Your Contributions</text>
                        {showComparison && (
                           <>
                              <rect x="0" y="36" width="12" height="12" fill="#a855f7" rx="2" />
                              <text x="18" y="46" fill="#64748b" fontSize="10">Late Start (Age {comparisonAge})</text>
                           </>
                        )}
                     </g>
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-6 border-l border-slate-200 flex flex-col gap-5 overflow-y-auto shadow-lg">
               {/* Results Summary */}
               <div className="grid grid-cols-2 gap-3">
                  <div className={`p-4 rounded-xl border-2 ${goalReached && challengeMode ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}`}>
                     <div className="text-[10px] font-black uppercase text-slate-400 mb-1">Final Balance</div>
                     <div className={`text-2xl font-mono font-bold ${goalReached && challengeMode ? 'text-green-600' : 'text-slate-800'}`}>
                        {formatCurrency(finalBalance)}
                     </div>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                     <div className="text-[10px] font-black uppercase text-blue-400 mb-1">You Contributed</div>
                     <div className="text-2xl font-mono font-bold text-blue-600">
                        {formatCurrency(totalContributed)}
                     </div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                     <div className="text-[10px] font-black uppercase text-green-400 mb-1">Interest Earned</div>
                     <div className="text-xl font-mono font-bold text-green-600">
                        {formatCurrency(interestEarned)}
                     </div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                     <div className="text-[10px] font-black uppercase text-purple-400 mb-1">Interest %</div>
                     <div className="text-xl font-mono font-bold text-purple-600">
                        {interestPercentage.toFixed(1)}%
                     </div>
                  </div>
               </div>

               {/* Starting Age Control (PRIMARY) */}
               <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-indigo-600 uppercase flex items-center gap-2">
                        <span className="text-lg">‚≠ê</span> Starting Age (KEY!)
                     </label>
                     <span className="text-lg font-mono font-bold text-indigo-700">{startAge}</span>
                  </div>
                  <input
                     type="range" min="20" max="50" value={startAge}
                     onChange={(e) => setStartAge(Number(e.target.value))}
                     className="w-full h-3 bg-indigo-200 rounded-full appearance-none cursor-pointer accent-indigo-500"
                  />
                  <div className="flex justify-between text-[10px] text-indigo-400 mt-1">
                     <span>20 (Early)</span>
                     <span>35</span>
                     <span>50 (Late)</span>
                  </div>
               </div>

               {/* Monthly Contribution Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-piggy-bank text-blue-500"></i> Monthly Contribution
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">${monthlyContribution}</span>
                  </div>
                  <input
                     type="range" min="100" max="2000" step="50" value={monthlyContribution}
                     onChange={(e) => setMonthlyContribution(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>$100</span>
                     <span>$1000</span>
                     <span>$2000</span>
                  </div>
               </div>

               {/* Return Rate Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                        <i className="fa-solid fa-chart-line text-green-500"></i> Annual Return
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{(annualReturn * 100).toFixed(1)}%</span>
                  </div>
                  <input
                     type="range" min="0.04" max="0.10" step="0.005" value={annualReturn}
                     onChange={(e) => setAnnualReturn(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-green-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>4% (Conservative)</span>
                     <span>7%</span>
                     <span>10% (Aggressive)</span>
                  </div>
               </div>

               {/* Comparison Age (when enabled) */}
               {showComparison && (
                  <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                     <div className="flex justify-between mb-2">
                        <label className="text-xs font-bold text-purple-600 uppercase">
                           üë§ Compare: Start at Age
                        </label>
                        <span className="text-sm font-mono font-bold text-purple-700">{comparisonAge}</span>
                     </div>
                     <input
                        type="range" min="25" max="55" value={comparisonAge}
                        onChange={(e) => setComparisonAge(Number(e.target.value))}
                        className="w-full h-2 bg-purple-200 rounded-full appearance-none cursor-pointer accent-purple-500"
                     />
                     <div className="mt-2 p-2 bg-white rounded-lg">
                        <div className="text-xs text-purple-600">
                           <strong>Difference:</strong> {formatCurrency(Math.abs(finalBalance - compBalance))}
                           {finalBalance > compBalance
                              ? <span className="text-green-600"> more</span>
                              : <span className="text-red-600"> less</span>
                           } by starting {Math.abs(startAge - comparisonAge)} years {startAge < comparisonAge ? 'earlier' : 'later'}
                        </div>
                     </div>
                  </div>
               )}

               {/* Years Investing */}
               <div className="bg-slate-100 p-3 rounded-xl text-center">
                  <div className="text-sm text-slate-600">
                     <span className="font-bold text-slate-800">{yearsInvesting} years</span> of investing
                     = <span className="font-bold text-green-600">{interestPercentage.toFixed(0)}%</span> from interest
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Notice how the curve gets steeper over time?
                        That's compound interest working. Starting at 25 instead of 35 with the SAME
                        monthly amount can mean <strong>2-3x more</strong> at retirement.
                        You can't make up for lost time by contributing more later.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUPPLY & DEMAND RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Price finds equilibrium where supply meets demand
   // Stage 2: Primary = shift demand/supply curves, Secondary = price controls
   // Stage 3: Classic X-diagram with equilibrium point, surplus/shortage areas
   // Stage 4: Demand: P = a - bQ, Supply: P = c + dQ, Equilibrium: where they intersect
   // Stage 5: State (curve positions) ‚Üí Derived (equilibrium, surplus) ‚Üí Visual
   // Stage 6: Challenges = "Find equilibrium", "Create shortage", "Price ceiling"
   const SupplyDemandRenderer = () => {
      const [demandShift, setDemandShift] = useState(0); // -50 to +50
      const [supplyShift, setSupplyShift] = useState(0); // -50 to +50
      const [priceControl, setPriceControl] = useState<number | null>(null);
      const [showSurplus, setShowSurplus] = useState(true);
      const [scenario, setScenario] = useState<'normal' | 'oil_shock' | 'tech_boom' | 'subsidy'>('normal');
      const [challengeMode, setChallengeMode] = useState(false);
      const [challengeTarget, setChallengeTarget] = useState<'equilibrium' | 'shortage' | 'surplus'>('equilibrium');

      // Base curve parameters (linear for simplicity)
      // Demand: P = 100 - Q (slopes down)
      // Supply: P = 10 + 0.8Q (slopes up)
      const demandIntercept = 100 + demandShift;
      const demandSlope = -1;
      const supplyIntercept = 10 + supplyShift;
      const supplySlope = 0.8;

      // Calculate equilibrium
      // 100 + demandShift - Q = 10 + supplyShift + 0.8Q
      // 90 + demandShift - supplyShift = 1.8Q
      // Q = (90 + demandShift - supplyShift) / 1.8
      const equilibriumQ = Math.max(0, (90 + demandShift - supplyShift) / 1.8);
      const equilibriumP = demandIntercept + demandSlope * equilibriumQ;

      // Price-controlled quantities
      const controlledPrice = priceControl ?? equilibriumP;
      const qDemanded = Math.max(0, (demandIntercept - controlledPrice) / Math.abs(demandSlope));
      const qSupplied = Math.max(0, (controlledPrice - supplyIntercept) / supplySlope);

      const hasShortage = priceControl !== null && priceControl < equilibriumP;
      const hasSurplus = priceControl !== null && priceControl > equilibriumP;
      const shortageAmount = hasShortage ? qDemanded - qSupplied : 0;
      const surplusAmount = hasSurplus ? qSupplied - qDemanded : 0;

      // Challenge evaluation
      const challengeMet = challengeMode && (
         (challengeTarget === 'equilibrium' && priceControl === null && Math.abs(demandShift) < 5 && Math.abs(supplyShift) < 5) ||
         (challengeTarget === 'shortage' && shortageAmount > 20) ||
         (challengeTarget === 'surplus' && surplusAmount > 20)
      );

      // Apply scenario presets
      const applyScenario = (s: typeof scenario) => {
         setScenario(s);
         setPriceControl(null);
         switch (s) {
            case 'normal':
               setDemandShift(0);
               setSupplyShift(0);
               break;
            case 'oil_shock':
               setDemandShift(0);
               setSupplyShift(-30); // Supply decreases
               break;
            case 'tech_boom':
               setDemandShift(25); // Demand increases
               setSupplyShift(0);
               break;
            case 'subsidy':
               setDemandShift(0);
               setSupplyShift(20); // Supply increases
               break;
         }
      };

      // SVG dimensions
      const chartWidth = 600;
      const chartHeight = 400;
      const padding = { top: 40, right: 40, bottom: 60, left: 70 };
      const innerWidth = chartWidth - padding.left - padding.right;
      const innerHeight = chartHeight - padding.top - padding.bottom;

      // Scale functions (Q: 0-100, P: 0-120)
      const maxQ = 100;
      const maxP = 120;
      const scaleX = (q: number) => padding.left + (q / maxQ) * innerWidth;
      const scaleY = (p: number) => padding.top + innerHeight - (p / maxP) * innerHeight;

      // Generate line paths
      const demandPath = `M ${scaleX(0)} ${scaleY(demandIntercept)} L ${scaleX(Math.min(maxQ, demandIntercept / Math.abs(demandSlope)))} ${scaleY(0)}`;
      const supplyPath = `M ${scaleX(0)} ${scaleY(supplyIntercept)} L ${scaleX(maxQ)} ${scaleY(supplyIntercept + supplySlope * maxQ)}`;

      return (
         <div className="w-full h-full bg-gradient-to-br from-emerald-50 to-blue-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-3 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Supply & Demand</h2>
                     <p className="text-sm text-slate-500">Discover how markets find equilibrium</p>
                  </div>
                  <div className="flex items-center gap-2">
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Scenario Buttons */}
               <div className="mb-3 flex gap-2 flex-wrap">
                  {[
                     { id: 'normal', label: '‚öñÔ∏è Normal', desc: 'Base case' },
                     { id: 'oil_shock', label: 'üõ¢Ô∏è Oil Shock', desc: 'Supply drops' },
                     { id: 'tech_boom', label: 'üì± Tech Boom', desc: 'Demand rises' },
                     { id: 'subsidy', label: 'üí∞ Subsidy', desc: 'Supply rises' },
                  ].map(s => (
                     <button
                        key={s.id}
                        onClick={() => applyScenario(s.id as typeof scenario)}
                        className={`px-3 py-2 rounded-lg text-xs font-bold transition-all ${scenario === s.id
                           ? 'bg-indigo-500 text-white shadow-lg'
                           : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'
                           }`}
                     >
                        {s.label}
                     </button>
                  ))}
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-3 p-3 rounded-xl border-2 ${challengeMet ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-xl">{challengeMet ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold text-slate-800">
                                 {challengeTarget === 'equilibrium' && 'Find Market Equilibrium'}
                                 {challengeTarget === 'shortage' && 'Create a Shortage (20+ units)'}
                                 {challengeTarget === 'surplus' && 'Create a Surplus (20+ units)'}
                              </div>
                              <div className="text-xs text-slate-600">
                                 {challengeMet ? 'Challenge Complete!' : 'Adjust curves or set price controls'}
                              </div>
                           </div>
                        </div>
                        <select
                           value={challengeTarget}
                           onChange={(e) => setChallengeTarget(e.target.value as typeof challengeTarget)}
                           className="text-xs p-1 rounded border border-slate-300"
                        >
                           <option value="equilibrium">Equilibrium</option>
                           <option value="shortage">Shortage</option>
                           <option value="surplus">Surplus</option>
                        </select>
                     </div>
                  </div>
               )}

               {/* SVG Chart */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200">
                  <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full h-full">
                     <defs>
                        <linearGradient id="shortageGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#ef4444" stopOpacity="0.3" />
                           <stop offset="100%" stopColor="#ef4444" stopOpacity="0.1" />
                        </linearGradient>
                        <linearGradient id="surplusGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#22c55e" stopOpacity="0.1" />
                           <stop offset="100%" stopColor="#22c55e" stopOpacity="0.3" />
                        </linearGradient>
                     </defs>

                     {/* Grid */}
                     {[0, 25, 50, 75, 100].map(q => (
                        <g key={`q-${q}`}>
                           <line x1={scaleX(q)} y1={padding.top} x2={scaleX(q)} y2={chartHeight - padding.bottom} stroke="#e2e8f0" strokeDasharray="4 4" />
                           <text x={scaleX(q)} y={chartHeight - padding.bottom + 20} textAnchor="middle" fill="#64748b" fontSize="10">{q}</text>
                        </g>
                     ))}
                     {[0, 30, 60, 90, 120].map(p => (
                        <g key={`p-${p}`}>
                           <line x1={padding.left} y1={scaleY(p)} x2={chartWidth - padding.right} y2={scaleY(p)} stroke="#e2e8f0" strokeDasharray="4 4" />
                           <text x={padding.left - 10} y={scaleY(p) + 4} textAnchor="end" fill="#64748b" fontSize="10">${p}</text>
                        </g>
                     ))}

                     {/* Axis labels */}
                     <text x={chartWidth / 2} y={chartHeight - 15} textAnchor="middle" fill="#64748b" fontSize="12" fontWeight="bold">Quantity (Q)</text>
                     <text x={20} y={chartHeight / 2} textAnchor="middle" fill="#64748b" fontSize="12" fontWeight="bold" transform={`rotate(-90, 20, ${chartHeight / 2})`}>Price (P)</text>

                     {/* Shortage/Surplus areas when price control active */}
                     {priceControl !== null && showSurplus && (
                        <g>
                           {hasShortage && (
                              <rect
                                 x={scaleX(qSupplied)}
                                 y={scaleY(controlledPrice) - 15}
                                 width={scaleX(qDemanded) - scaleX(qSupplied)}
                                 height={30}
                                 fill="url(#shortageGradient)"
                                 rx="4"
                              />
                           )}
                           {hasSurplus && (
                              <rect
                                 x={scaleX(qDemanded)}
                                 y={scaleY(controlledPrice) - 15}
                                 width={scaleX(qSupplied) - scaleX(qDemanded)}
                                 height={30}
                                 fill="url(#surplusGradient)"
                                 rx="4"
                              />
                           )}
                        </g>
                     )}

                     {/* Price control line */}
                     {priceControl !== null && (
                        <g>
                           <line
                              x1={padding.left}
                              y1={scaleY(priceControl)}
                              x2={chartWidth - padding.right}
                              y2={scaleY(priceControl)}
                              stroke={hasShortage ? "#ef4444" : hasSurplus ? "#22c55e" : "#6366f1"}
                              strokeWidth="3"
                              strokeDasharray="8 4"
                           />
                           <text
                              x={chartWidth - padding.right + 5}
                              y={scaleY(priceControl) + 4}
                              fill={hasShortage ? "#ef4444" : hasSurplus ? "#22c55e" : "#6366f1"}
                              fontSize="10"
                              fontWeight="bold"
                           >
                              {hasShortage ? 'PRICE CEILING' : hasSurplus ? 'PRICE FLOOR' : 'PRICE CONTROL'}
                           </text>
                        </g>
                     )}

                     {/* Demand curve (blue, slopes down) */}
                     <path d={demandPath} fill="none" stroke="#3b82f6" strokeWidth="4" strokeLinecap="round" />
                     <text x={scaleX(5)} y={scaleY(demandIntercept - 5) - 10} fill="#3b82f6" fontSize="12" fontWeight="bold">Demand (D)</text>

                     {/* Supply curve (orange, slopes up) */}
                     <path d={supplyPath} fill="none" stroke="#f97316" strokeWidth="4" strokeLinecap="round" />
                     <text x={scaleX(85)} y={scaleY(supplyIntercept + supplySlope * 85) - 10} fill="#f97316" fontSize="12" fontWeight="bold">Supply (S)</text>

                     {/* Equilibrium point */}
                     {equilibriumQ > 0 && equilibriumP > 0 && equilibriumP < maxP && (
                        <g>
                           {/* Dashed lines to axes */}
                           <line x1={scaleX(equilibriumQ)} y1={scaleY(equilibriumP)} x2={scaleX(equilibriumQ)} y2={chartHeight - padding.bottom} stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />
                           <line x1={scaleX(equilibriumQ)} y1={scaleY(equilibriumP)} x2={padding.left} y2={scaleY(equilibriumP)} stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />

                           {/* Equilibrium marker */}
                           <circle cx={scaleX(equilibriumQ)} cy={scaleY(equilibriumP)} r="12" fill="#10b981" stroke="#fff" strokeWidth="3">
                              <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" />
                           </circle>
                           <text x={scaleX(equilibriumQ)} y={scaleY(equilibriumP) - 20} textAnchor="middle" fill="#10b981" fontSize="11" fontWeight="bold">
                              Equilibrium
                           </text>
                           <text x={scaleX(equilibriumQ)} y={scaleY(equilibriumP) + 5} textAnchor="middle" fill="#fff" fontSize="10" fontWeight="bold">E</text>
                        </g>
                     )}

                     {/* Shortage/Surplus labels */}
                     {hasShortage && shortageAmount > 5 && (
                        <text
                           x={(scaleX(qSupplied) + scaleX(qDemanded)) / 2}
                           y={scaleY(controlledPrice) + 5}
                           textAnchor="middle"
                           fill="#ef4444"
                           fontSize="11"
                           fontWeight="bold"
                        >
                           SHORTAGE: {shortageAmount.toFixed(0)} units
                        </text>
                     )}
                     {hasSurplus && surplusAmount > 5 && (
                        <text
                           x={(scaleX(qDemanded) + scaleX(qSupplied)) / 2}
                           y={scaleY(controlledPrice) + 5}
                           textAnchor="middle"
                           fill="#22c55e"
                           fontSize="11"
                           fontWeight="bold"
                        >
                           SURPLUS: {surplusAmount.toFixed(0)} units
                        </text>
                     )}
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-5 border-l border-slate-200 flex flex-col gap-4 overflow-y-auto shadow-lg">
               {/* Market Status */}
               <div className={`p-4 rounded-xl border-2 ${hasShortage ? 'bg-red-50 border-red-200' :
                  hasSurplus ? 'bg-green-50 border-green-200' :
                     'bg-emerald-50 border-emerald-200'
                  }`}>
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-1">Market Status</div>
                  <div className={`text-lg font-bold ${hasShortage ? 'text-red-600' : hasSurplus ? 'text-green-600' : 'text-emerald-600'
                     }`}>
                     {hasShortage ? '‚ö†Ô∏è SHORTAGE' : hasSurplus ? 'üì¶ SURPLUS' : '‚úÖ EQUILIBRIUM'}
                  </div>
                  <div className="text-sm text-slate-600 mt-1">
                     P* = ${equilibriumP.toFixed(0)} | Q* = {equilibriumQ.toFixed(0)} units
                  </div>
               </div>

               {/* Demand Shift Control */}
               <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-blue-600 uppercase flex items-center gap-2">
                        üìâ Demand Shift
                     </label>
                     <span className="text-sm font-mono font-bold text-blue-700">
                        {demandShift > 0 ? '+' : ''}{demandShift}
                     </span>
                  </div>
                  <input
                     type="range" min="-50" max="50" value={demandShift}
                     onChange={(e) => setDemandShift(Number(e.target.value))}
                     className="w-full h-3 bg-blue-200 rounded-full appearance-none cursor-pointer accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] text-blue-400 mt-1">
                     <span>‚Üê Less demand</span>
                     <span>More demand ‚Üí</span>
                  </div>
               </div>

               {/* Supply Shift Control */}
               <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-orange-600 uppercase flex items-center gap-2">
                        üìà Supply Shift
                     </label>
                     <span className="text-sm font-mono font-bold text-orange-700">
                        {supplyShift > 0 ? '+' : ''}{supplyShift}
                     </span>
                  </div>
                  <input
                     type="range" min="-50" max="50" value={supplyShift}
                     onChange={(e) => setSupplyShift(Number(e.target.value))}
                     className="w-full h-3 bg-orange-200 rounded-full appearance-none cursor-pointer accent-orange-500"
                  />
                  <div className="flex justify-between text-[10px] text-orange-400 mt-1">
                     <span>‚Üê Less supply</span>
                     <span>More supply ‚Üí</span>
                  </div>
               </div>

               {/* Price Control */}
               <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <div className="flex justify-between items-center mb-2">
                     <label className="text-xs font-bold text-purple-600 uppercase">
                        üèõÔ∏è Price Control
                     </label>
                     <button
                        onClick={() => setPriceControl(priceControl === null ? equilibriumP : null)}
                        className={`px-2 py-1 rounded text-xs font-bold ${priceControl !== null
                           ? 'bg-purple-500 text-white'
                           : 'bg-purple-200 text-purple-600'
                           }`}
                     >
                        {priceControl !== null ? 'ON' : 'OFF'}
                     </button>
                  </div>
                  {priceControl !== null && (
                     <>
                        <input
                           type="range" min="20" max="100" value={priceControl}
                           onChange={(e) => setPriceControl(Number(e.target.value))}
                           className="w-full h-3 bg-purple-200 rounded-full appearance-none cursor-pointer accent-purple-500"
                        />
                        <div className="flex justify-between text-[10px] text-purple-400 mt-1">
                           <span>$20 (Ceiling)</span>
                           <span className="font-bold">${priceControl}</span>
                           <span>$100 (Floor)</span>
                        </div>
                     </>
                  )}
               </div>

               {/* Real-World Examples */}
               <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                  <div className="text-[10px] font-black uppercase text-slate-400 mb-2">Real Examples</div>
                  <div className="grid grid-cols-2 gap-2 text-xs">
                     <div className="p-2 bg-white rounded border border-slate-100">
                        <span className="font-bold text-red-500">Shortage:</span> Rent control, PS5 launch
                     </div>
                     <div className="p-2 bg-white rounded border border-slate-100">
                        <span className="font-bold text-green-500">Surplus:</span> Min wage, farm subsidies
                     </div>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Markets naturally find equilibrium where supply meets demand.
                        Price controls (ceilings/floors) create shortages or surpluses because they prevent
                        prices from adjusting. The "invisible hand" works through price signals!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- PENDULUM / SIMPLE HARMONIC MOTION RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Period depends on LENGTH, not mass or amplitude (for small angles)
   // Stage 2: Primary = pendulum length, Secondary = initial amplitude, gravity
   // Stage 3: Animated pendulum bob swinging, period vs length graph
   // Stage 4: T = 2œÄ‚àö(L/g), Œ∏(t) = Œ∏‚ÇÄcos(œât), œâ = ‚àö(g/L)
   // Stage 5: State (length, amplitude) ‚Üí Derived (period, angular freq) ‚Üí Animation
   // Stage 6: Challenge = "Match the period to 2.0s"
   const PendulumRenderer = () => {
      const [length, setLength] = useState(1.0); // meters
      const [amplitude, setAmplitude] = useState(30); // degrees (initial angle)
      const [gravity, setGravity] = useState(9.8); // m/s¬≤
      const [isSwinging, setIsSwinging] = useState(false);
      const [time, setTime] = useState(0);
      const [showPhaseSpace, setShowPhaseSpace] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);
      const targetPeriod = 2.0; // Challenge: match this period

      // Physics calculations
      // Period: T = 2œÄ‚àö(L/g) (for small angles)
      const period = 2 * Math.PI * Math.sqrt(length / gravity);
      const angularFrequency = Math.sqrt(gravity / length); // œâ = ‚àö(g/L)

      // Current angle: Œ∏(t) = Œ∏‚ÇÄ * cos(œât) (simple harmonic motion for small angles)
      const amplitudeRad = amplitude * (Math.PI / 180);
      const currentAngleRad = amplitudeRad * Math.cos(angularFrequency * time);
      const currentAngleDeg = currentAngleRad * (180 / Math.PI);

      // Angular velocity: Œ∏'(t) = -Œ∏‚ÇÄœâ * sin(œât)
      const angularVelocity = -amplitudeRad * angularFrequency * Math.sin(angularFrequency * time);

      // Challenge evaluation
      const periodError = Math.abs(period - targetPeriod);
      const challengeMet = challengeMode && periodError < 0.05;

      // Animation loop
      useEffect(() => {
         if (!isSwinging) return;

         const startTime = performance.now();
         const initialTime = time;

         const animate = (now: number) => {
            const elapsed = (now - startTime) / 1000; // seconds
            setTime(initialTime + elapsed);
            if (isSwinging) {
               requestAnimationFrame(animate);
            }
         };

         const animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isSwinging]);

      // SVG dimensions
      const pivotX = 300;
      const pivotY = 60;
      const pixelsPerMeter = 180; // Scale: 180px = 1m
      const bobRadius = 25;

      // Calculate bob position
      const bobX = pivotX + Math.sin(currentAngleRad) * length * pixelsPerMeter;
      const bobY = pivotY + Math.cos(currentAngleRad) * length * pixelsPerMeter;

      // Generate trail/ghost positions for visualization
      const trailAngles = [];
      for (let i = 0; i <= 10; i++) {
         const trailAngle = amplitudeRad * Math.cos(angularFrequency * (time - i * 0.05));
         trailAngles.push({
            x: pivotX + Math.sin(trailAngle) * length * pixelsPerMeter,
            y: pivotY + Math.cos(trailAngle) * length * pixelsPerMeter,
            opacity: 1 - i * 0.09
         });
      }

      return (
         <div className="w-full h-full bg-gradient-to-br from-violet-50 to-indigo-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-4 flex flex-col">
               {/* Header */}
               <div className="mb-3 flex items-center justify-between">
                  <div>
                     <h2 className="text-xl font-bold text-slate-800">Simple Pendulum</h2>
                     <p className="text-sm text-slate-500">Discover what affects the period</p>
                  </div>
                  <div className="flex items-center gap-2">
                     <button
                        onClick={() => setChallengeMode(!challengeMode)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'
                           }`}
                     >
                        {challengeMode ? 'üéØ Challenge ON' : 'üéØ Challenge'}
                     </button>
                  </div>
               </div>

               {/* Challenge Banner */}
               {challengeMode && (
                  <div className={`mb-3 p-3 rounded-xl border-2 ${challengeMet ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                           <span className="text-xl">{challengeMet ? 'üéâ' : 'üéØ'}</span>
                           <div>
                              <div className="text-sm font-bold text-slate-800">
                                 Match Period = {targetPeriod.toFixed(1)}s
                              </div>
                              <div className="text-xs text-slate-600">
                                 {challengeMet ? 'Perfect! You found it!' : `Current: ${period.toFixed(2)}s (off by ${periodError.toFixed(2)}s)`}
                              </div>
                           </div>
                        </div>
                        <div className="text-xs text-slate-500">
                           Hint: Adjust the length!
                        </div>
                     </div>
                  </div>
               )}

               {/* SVG Visualization */}
               <div className="flex-1 bg-white rounded-2xl shadow-lg p-4 border border-slate-200 flex items-center justify-center">
                  <svg viewBox="0 0 600 420" className="w-full h-full max-h-[350px]">
                     <defs>
                        <linearGradient id="stringGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                           <stop offset="0%" stopColor="#6366f1" />
                           <stop offset="100%" stopColor="#4f46e5" />
                        </linearGradient>
                        <radialGradient id="bobGradient" cx="30%" cy="30%">
                           <stop offset="0%" stopColor="#818cf8" />
                           <stop offset="100%" stopColor="#4f46e5" />
                        </radialGradient>
                        <filter id="bobShadow" x="-50%" y="-50%" width="200%" height="200%">
                           <feDropShadow dx="3" dy="5" stdDeviation="4" floodOpacity="0.3" />
                        </filter>
                     </defs>

                     {/* Background grid */}
                     <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e2e8f0" strokeWidth="0.5" />
                     </pattern>
                     <rect width="600" height="420" fill="url(#grid)" />

                     {/* Pivot point */}
                     <rect x={pivotX - 60} y={pivotY - 20} width="120" height="25" fill="#374151" rx="4" />
                     <circle cx={pivotX} cy={pivotY} r="8" fill="#1f2937" stroke="#fff" strokeWidth="2" />

                     {/* Amplitude arc (dashed) */}
                     <path
                        d={`M ${pivotX + Math.sin(-amplitudeRad) * length * pixelsPerMeter * 0.3} ${pivotY + Math.cos(-amplitudeRad) * length * pixelsPerMeter * 0.3} 
                            A ${length * pixelsPerMeter * 0.3} ${length * pixelsPerMeter * 0.3} 0 0 1 
                            ${pivotX + Math.sin(amplitudeRad) * length * pixelsPerMeter * 0.3} ${pivotY + Math.cos(amplitudeRad) * length * pixelsPerMeter * 0.3}`}
                        fill="none"
                        stroke="#a78bfa"
                        strokeWidth="2"
                        strokeDasharray="6 4"
                        opacity="0.5"
                     />

                     {/* Trail/ghost positions */}
                     {isSwinging && trailAngles.slice(2).map((pos, i) => (
                        <circle
                           key={i}
                           cx={pos.x}
                           cy={pos.y}
                           r={bobRadius * 0.6}
                           fill="#a78bfa"
                           opacity={pos.opacity * 0.3}
                        />
                     ))}

                     {/* String/rod */}
                     <line
                        x1={pivotX} y1={pivotY}
                        x2={bobX} y2={bobY}
                        stroke="url(#stringGradient)"
                        strokeWidth="4"
                        strokeLinecap="round"
                     />

                     {/* Bob */}
                     <circle
                        cx={bobX}
                        cy={bobY}
                        r={bobRadius}
                        fill="url(#bobGradient)"
                        filter="url(#bobShadow)"
                        stroke="#fff"
                        strokeWidth="3"
                     />

                     {/* Angle indicator */}
                     <text x={pivotX + 35} y={pivotY + 50} fill="#6366f1" fontSize="12" fontWeight="bold">
                        Œ∏ = {currentAngleDeg.toFixed(1)}¬∞
                     </text>

                     {/* Length indicator */}
                     <line x1={pivotX + 40} y1={pivotY + 10} x2={pivotX + 40} y2={pivotY + length * pixelsPerMeter - 10} stroke="#94a3b8" strokeWidth="1" markerEnd="url(#arrow)" />
                     <text x={pivotX + 55} y={pivotY + length * pixelsPerMeter / 2} fill="#64748b" fontSize="11">
                        L = {length.toFixed(2)}m
                     </text>

                     {/* Period display */}
                     <rect x="430" y="20" width="150" height="70" fill="#f8fafc" rx="8" stroke="#e2e8f0" />
                     <text x="505" y="45" textAnchor="middle" fill="#64748b" fontSize="10" fontWeight="bold">PERIOD</text>
                     <text x="505" y="72" textAnchor="middle" fill={challengeMet ? "#22c55e" : "#4f46e5"} fontSize="24" fontWeight="bold">
                        T = {period.toFixed(2)}s
                     </text>

                     {/* Formula */}
                     <text x="505" y="115" textAnchor="middle" fill="#94a3b8" fontSize="11">
                        T = 2œÄ‚àö(L/g)
                     </text>
                  </svg>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-96 bg-white p-5 border-l border-slate-200 flex flex-col gap-4 overflow-y-auto shadow-lg">
               {/* Start/Stop Button */}
               <button
                  onClick={() => {
                     if (!isSwinging) setTime(0);
                     setIsSwinging(!isSwinging);
                  }}
                  className={`w-full py-4 rounded-xl font-bold text-lg transition-all ${isSwinging
                     ? 'bg-red-500 text-white hover:bg-red-600'
                     : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:from-indigo-600 hover:to-purple-600'
                     }`}
               >
                  {isSwinging ? '‚èπÔ∏è STOP' : '‚ñ∂Ô∏è START SWING'}
               </button>

               {/* Physics Metrics */}
               <div className="grid grid-cols-2 gap-3">
                  <div className="p-3 bg-indigo-50 rounded-xl border-2 border-indigo-200 text-center">
                     <div className="text-[10px] font-black uppercase text-indigo-400">Period</div>
                     <div className="text-xl font-mono font-bold text-indigo-600">{period.toFixed(2)}s</div>
                  </div>
                  <div className="p-3 bg-purple-50 rounded-xl border-2 border-purple-200 text-center">
                     <div className="text-[10px] font-black uppercase text-purple-400">Frequency</div>
                     <div className="text-xl font-mono font-bold text-purple-600">{(1 / period).toFixed(2)} Hz</div>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                     <div className="text-[10px] font-black uppercase text-slate-400">Angular œâ</div>
                     <div className="text-lg font-mono font-bold text-slate-600">{angularFrequency.toFixed(2)} rad/s</div>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl border border-slate-200 text-center">
                     <div className="text-[10px] font-black uppercase text-slate-400">Time</div>
                     <div className="text-lg font-mono font-bold text-slate-600">{time.toFixed(1)}s</div>
                  </div>
               </div>

               {/* Length Control (PRIMARY - affects period) */}
               <div className="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-indigo-600 uppercase flex items-center gap-2">
                        ‚≠ê Length (affects period!)
                     </label>
                     <span className="text-sm font-mono font-bold text-indigo-700">{length.toFixed(2)} m</span>
                  </div>
                  <input
                     type="range" min="0.25" max="2.5" step="0.05" value={length}
                     onChange={(e) => setLength(Number(e.target.value))}
                     className="w-full h-3 bg-indigo-200 rounded-full appearance-none cursor-pointer accent-indigo-500"
                  />
                  <div className="flex justify-between text-[10px] text-indigo-400 mt-1">
                     <span>0.25m (fast)</span>
                     <span>1.0m</span>
                     <span>2.5m (slow)</span>
                  </div>
               </div>

               {/* Amplitude Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase">
                        üìê Initial Amplitude
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{amplitude}¬∞</span>
                  </div>
                  <input
                     type="range" min="5" max="45" step="5" value={amplitude}
                     onChange={(e) => setAmplitude(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-violet-500"
                  />
                  <div className="text-[10px] text-slate-400 mt-1 text-center">
                     (Doesn't affect period for small angles!)
                  </div>
               </div>

               {/* Gravity Control */}
               <div>
                  <div className="flex justify-between mb-2">
                     <label className="text-xs font-bold text-slate-500 uppercase">
                        üåç Gravity
                     </label>
                     <span className="text-sm font-mono font-bold text-slate-700">{gravity.toFixed(1)} m/s¬≤</span>
                  </div>
                  <input
                     type="range" min="1.6" max="25" step="0.1" value={gravity}
                     onChange={(e) => setGravity(Number(e.target.value))}
                     className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-emerald-500"
                  />
                  <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                     <span>üåô Moon (1.6)</span>
                     <span>üåç Earth (9.8)</span>
                     <span>‚ôÉ Jupiter (25)</span>
                  </div>
               </div>

               {/* Key Discovery Box */}
               <div className="bg-emerald-50 p-3 rounded-xl border-2 border-emerald-200">
                  <div className="text-xs text-emerald-800">
                     <strong>üî¨ Key Discovery:</strong> Try changing the amplitude and mass (imagine different bobs).
                     Does the period change? <em>For small angles, only LENGTH and GRAVITY affect the period!</em>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="flex gap-3 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center shrink-0 text-xl">
                     üí°
                  </div>
                  <div>
                     <p className="text-xs text-amber-800 leading-relaxed">
                        <strong>Key Insight:</strong> Galileo discovered that a pendulum's period is
                        independent of its amplitude (for small swings). This led to the invention
                        of accurate clocks! The formula T = 2œÄ‚àö(L/g) shows only length and gravity matter.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ADDITION RENDERER (Concrete ‚Üí Pictorial ‚Üí Abstract) ---
   // Stage 1: Core insight = Combining groups.
   // Stage 2: Primary = num1, num2.
   // Stage 3: Concrete (Apples) + Pictorial (Number Line) + Abstract (Equation).
   // Stage 4: a + b = c.
   // Stage 5: State (num1, num2) ‚Üí Derived (total, paths).
   // Stage 6: Challenge = "Make the total 10".
   const AdditionRenderer = () => {
      const [num1, setNum1] = useState(5);
      const [num2, setNum2] = useState(4);
      const [showNumberLine, setShowNumberLine] = useState(true);
      const [isCombining, setIsCombining] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);

      const total = num1 + num2;
      const isChallengeMet = challengeMode && total === 10;

      // Helper to render a group of apples
      const renderApples = (count: number, color: string, isResult: boolean = false) => {
         const apples = [];
         const cols = 5;
         for (let i = 0; i < count; i++) {
            const row = Math.floor(i / cols);
            const col = i % cols;
            apples.push(
               <g key={i} transform={`translate(${col * 25 + 15}, ${row * 25 + 15})`} className="animate-in zoom-in duration-300">
                  <circle r="10" fill={color} />
                  <path d="M-2,-8 Q0,-12 2,-8" stroke="#4ade80" strokeWidth="2" fill="none" />
                  <circle r="2" cx="3" cy="-3" fill="white" opacity="0.4" />
               </g>
            );
         }
         return apples;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Addition</h2>
                     <p className="text-slate-500 text-sm">Combining groups into one total</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the total exactly 10</p>
                           <p className="text-xs opacity-80">Adjust the numbers to find different ways to make 10.</p>
                        </div>
                        {isChallengeMet && (
                           <div className="ml-auto animate-bounce text-green-600 font-black">SUCCESS!</div>
                        )}
                     </div>
                  </div>
               )}

               {/* CONCRETE LAYER: Apples */}
               <div className="flex-1 grid grid-cols-3 gap-4 min-h-0">
                  <div className="bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex flex-col items-center">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Group A</span>
                     <svg className="w-full h-full max-h-[150px]">
                        {renderApples(num1, "#ef4444")}
                     </svg>
                     <div className="mt-2 text-2xl font-black text-red-500">{num1}</div>
                  </div>

                  <div className="flex items-center justify-center text-4xl font-black text-slate-300">+</div>

                  <div className="bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex flex-col items-center">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Group B</span>
                     <svg className="w-full h-full max-h-[150px]">
                        {renderApples(num2, "#3b82f6")}
                     </svg>
                     <div className="mt-2 text-2xl font-black text-blue-500">{num2}</div>
                  </div>
               </div>

               {/* PICTORIAL LAYER: Number Line */}
               {showNumberLine && (
                  <div className="h-24 bg-slate-50 rounded-2xl border border-slate-100 p-4 relative overflow-hidden">
                     <svg viewBox="0 0 600 80" className="w-full h-full">
                        {/* Line */}
                        <line x1="20" y1="50" x2="580" y2="50" stroke="#cbd5e1" strokeWidth="2" />
                        {/* Ticks */}
                        {Array.from({ length: 21 }).map((_, i) => (
                           <g key={i} transform={`translate(${20 + i * 28}, 50)`}>
                              <line y1="-5" y2="5" stroke="#cbd5e1" strokeWidth="2" />
                              <text y="20" textAnchor="middle" fontSize="10" fill="#94a3b8" fontWeight="bold">{i}</text>
                           </g>
                        ))}
                        {/* Jump 1 */}
                        <path
                           d={`M 20,50 Q ${20 + (num1 * 28) / 2},10 ${20 + num1 * 28},50`}
                           fill="none" stroke="#ef4444" strokeWidth="3" strokeDasharray="4 2"
                        />
                        {/* Jump 2 */}
                        <path
                           d={`M ${20 + num1 * 28},50 Q ${20 + num1 * 28 + (num2 * 28) / 2},10 ${20 + (num1 + num2) * 28},50`}
                           fill="none" stroke="#3b82f6" strokeWidth="3"
                        />
                        {/* Marker */}
                        <circle cx={20 + (num1 + num2) * 28} cy="50" r="6" fill="#10b981" className="shadow-lg" />
                     </svg>
                  </div>
               )}

               {/* ABSTRACT LAYER: Equation */}
               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-red-400">{num1}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">First Part</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{num2}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Second Part</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{total}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
               <div className="space-y-6">
                  {/* Num 1 Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üçé Group A Size</label>
                        <span className="text-2xl font-black text-red-500">{num1}</span>
                     </div>
                     <input
                        type="range" min="0" max="10" step="1" value={num1}
                        onChange={(e) => setNum1(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500"
                     />
                  </div>

                  {/* Num 2 Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üîµ Group B Size</label>
                        <span className="text-2xl font-black text-blue-500">{num2}</span>
                     </div>
                     <input
                        type="range" min="0" max="10" step="1" value={num2}
                        onChange={(e) => setNum2(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowNumberLine(!showNumberLine)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${showNumberLine ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showNumberLine ? 'üìè HIDE NUMBER LINE' : 'üìè SHOW NUMBER LINE'}
                  </button>

                  <button
                     onClick={() => {
                        const n1 = Math.floor(Math.random() * 10);
                        const n2 = Math.floor(Math.random() * 10);
                        setNum1(n1);
                        setNum2(n2);
                     }}
                     className="w-full py-3 bg-white border border-slate-200 rounded-xl font-bold text-sm text-slate-600 hover:bg-slate-50 transition-all"
                  >
                     üé≤ RANDOM PROBLEM
                  </button>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                  <div className="flex gap-3">
                     <div className="text-emerald-600 text-lg">üí°</div>
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Addition is just putting things together.
                        You can see it as <strong>counting objects</strong> (concrete) or as
                        <strong>jumping forward</strong> on a line (pictorial). The equation
                        is just a short way to write what happened!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUBTRACTION RENDERER (Take-Away vs Difference) ---
   // Stage 1: Core insight = Removal or Comparison.
   // Stage 2: Primary = minuend, subtrahend.
   // Stage 3: Mode toggle (Take Away / Difference).
   // Stage 4: a - b = c.
   // Stage 5: State (num1, num2, mode) ‚Üí Derived (result, matched).
   // Stage 6: Challenge = "Find the difference".
   const SubtractionRenderer = () => {
      const [num1, setNum1] = useState(8);
      const [num2, setNum2] = useState(3);
      const [mode, setMode] = useState<'takeaway' | 'difference'>('takeaway');
      const [challengeMode, setChallengeMode] = useState(false);

      const result = num1 - num2;
      const isChallengeMet = challengeMode && result === 5;

      const renderTakeAway = () => {
         const items = [];
         const cols = 5;
         for (let i = 0; i < num1; i++) {
            const row = Math.floor(i / cols);
            const col = i % cols;
            const isRemoved = i >= num1 - num2;
            items.push(
               <g key={i} transform={`translate(${col * 30 + 20}, ${row * 30 + 20})`} className="transition-all duration-500">
                  <circle r="12" fill={isRemoved ? "#cbd5e1" : "#f97316"} opacity={isRemoved ? 0.3 : 1} />
                  {isRemoved && (
                     <path d="M-8,-8 L8,8 M8,-8 L-8,8" stroke="#ef4444" strokeWidth="3" />
                  )}
                  <circle r="3" cx="4" cy="-4" fill="white" opacity="0.4" />
               </g>
            );
         }
         return items;
      };

      const renderDifference = () => {
         const groupA = [];
         const groupB = [];
         const connections = [];

         for (let i = 0; i < num1; i++) {
            groupA.push(
               <circle key={`a-${i}`} cx="20" cy={i * 30 + 20} r="12" fill="#f97316" />
            );
         }
         for (let i = 0; i < num2; i++) {
            groupB.push(
               <circle key={`b-${i}`} cx="180" cy={i * 30 + 20} r="12" fill="#6366f1" />
            );
            connections.push(
               <line key={`c-${i}`} x1="32" y1={i * 30 + 20} x2="168" y2={i * 30 + 20} stroke="#cbd5e1" strokeWidth="2" strokeDasharray="4 2" />
            );
         }

         return (
            <g>
               {connections}
               {groupA}
               {groupB}
               {/* Highlight the difference */}
               {Array.from({ length: num1 - num2 }).map((_, i) => (
                  <rect
                     key={`h-${i}`}
                     x="5" y={(num2 + i) * 30 + 5}
                     width="30" height="30"
                     fill="none" stroke="#ef4444" strokeWidth="2" rx="4"
                     className="animate-pulse"
                  />
               ))}
            </g>
         );
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Subtraction</h2>
                     <p className="text-slate-500 text-sm">Taking away or finding the difference</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setMode('takeaway')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'takeaway' ? 'bg-orange-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        TAKE AWAY
                     </button>
                     <button
                        onClick={() => setMode('difference')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'difference' ? 'bg-indigo-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        DIFFERENCE
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the difference exactly 5</p>
                           <p className="text-xs opacity-80">Adjust the numbers until the result is 5.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8">
                  <svg className="w-full h-full max-w-[400px] max-h-[400px]" viewBox="0 0 200 300">
                     {mode === 'takeaway' ? renderTakeAway() : renderDifference()}
                  </svg>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-orange-400">{num1}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Start</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">‚àí</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{num2}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Remove</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{result}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Left</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Start Amount</label>
                        <span className="text-2xl font-black text-orange-500">{num1}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={num1}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setNum1(val);
                           if (num2 > val) setNum2(val);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Take Away</label>
                        <span className="text-2xl font-black text-indigo-500">{num2}</span>
                     </div>
                     <input
                        type="range" min="0" max={num1} step="1" value={num2}
                        onChange={(e) => setNum2(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>Inverse Relationship:</strong> Notice that if
                        <span className="font-bold"> {num1} - {num2} = {result}</span>, then
                        <span className="font-bold"> {num2} + {result} = {num1}</span>.
                        Subtraction is just addition in reverse!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MULTIPLICATION RENDERER (Area Model & Distributive Property) ---
   // Stage 1: Core insight = Repeated groups / Area.
   // Stage 2: Primary = rows, cols.
   // Stage 3: Resizable Grid + Distributive Split.
   // Stage 4: a √ó b = c.
   // Stage 5: State (rows, cols, splitX) ‚Üí Derived (area, parts).
   // Stage 6: Challenge = "Make Area 24".
   const MultiplicationRenderer = () => {
      const [rows, setRows] = useState(4);
      const [cols, setCols] = useState(6);
      const [splitX, setSplitX] = useState(0); // 0 means no split
      const [challengeMode, setChallengeMode] = useState(false);

      const area = rows * cols;
      const isChallengeMet = challengeMode && area === 24;

      const renderGrid = () => {
         const cells = [];
         const cellSize = 30;
         for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
               const isSplit = splitX > 0 && c >= splitX;
               cells.push(
                  <rect
                     key={`${r}-${c}`}
                     x={c * cellSize + 10}
                     y={r * cellSize + 10}
                     width={cellSize - 2}
                     height={cellSize - 2}
                     fill={isSplit ? "#6366f1" : "#f97316"}
                     className="animate-in zoom-in duration-300"
                     rx="4"
                  />
               );
            }
         }
         return cells;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Multiplication</h2>
                     <p className="text-slate-500 text-sm">Repeated groups as an area model</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Make the area exactly 24</p>
                           <p className="text-xs opacity-80">Find different dimensions (rows √ó cols) that equal 24.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-hidden">
                  <div className="relative">
                     <svg width={cols * 30 + 20} height={rows * 30 + 20}>
                        {renderGrid()}
                        {/* Labels */}
                        <text x={-5} y={rows * 15 + 10} textAnchor="middle" transform={`rotate(-90, -5, ${rows * 15 + 10})`} className="text-xs font-black fill-slate-400">{rows}</text>
                        <text x={cols * 15 + 10} y={-5} textAnchor="middle" className="text-xs font-black fill-slate-400">{cols}</text>
                     </svg>
                  </div>
               </div>

               {/* Distributive Property View */}
               {splitX > 0 && (
                  <div className="p-4 bg-slate-50 rounded-2xl border border-slate-200 flex items-center justify-center gap-4 text-sm font-bold">
                     <span className="text-orange-500">({rows} √ó {splitX})</span>
                     <span className="text-slate-400">+</span>
                     <span className="text-indigo-500">({rows} √ó {cols - splitX})</span>
                     <span className="text-slate-400">=</span>
                     <span className="text-emerald-500">{area}</span>
                  </div>
               )}

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-orange-400">{rows}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Rows</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√ó</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{cols}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Cols</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{area}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Area</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üï Rows</label>
                        <span className="text-2xl font-black text-orange-500">{rows}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={rows}
                        onChange={(e) => setRows(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üî Columns</label>
                        <span className="text-2xl font-black text-indigo-500">{cols}</span>
                     </div>
                     <input
                        type="range" min="1" max="12" step="1" value={cols}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setCols(val);
                           if (splitX >= val) setSplitX(0);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚úÇ Split (Distributive)</label>
                        <span className="text-2xl font-black text-slate-400">{splitX || 'Off'}</span>
                     </div>
                     <input
                        type="range" min="0" max={cols - 1} step="1" value={splitX}
                        onChange={(e) => setSplitX(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-400"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Multiplication is just area!
                        The <strong>Distributive Property</strong> lets you break a big
                        problem into two smaller ones.
                        <span className="block mt-1 font-bold">4 √ó 6 is the same as (4 √ó 4) + (4 √ó 2).</span>
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- DIVISION RENDERER (Sharing vs Grouping) ---
   // Stage 1: Core insight = Fair sharing or finding sets.
   // Stage 2: Primary = dividend, divisor.
   // Stage 3: Mode toggle (Sharing / Grouping).
   // Stage 4: a √∑ b = c (r d).
   // Stage 5: State (total, divisor, mode) ‚Üí Derived (quotient, remainder).
   // Stage 6: Challenge = "Fair sharing with remainder".
   const DivisionRenderer = () => {
      const [total, setTotal] = useState(12);
      const [divisor, setDivisor] = useState(3);
      const [mode, setMode] = useState<'sharing' | 'grouping'>('sharing');
      const [challengeMode, setChallengeMode] = useState(false);

      const quotient = Math.floor(total / divisor);
      const remainder = total % divisor;
      const isChallengeMet = challengeMode && remainder === 2;

      const renderSharing = () => {
         const groups = [];
         for (let g = 0; g < divisor; g++) {
            const items = [];
            for (let i = 0; i < quotient; i++) {
               items.push(
                  <circle key={i} cx={i * 15 + 10} cy="10" r="6" fill="#10b981" className="animate-in zoom-in duration-300" />
               );
            }
            groups.push(
               <div key={g} className="flex flex-col items-center gap-2 p-3 bg-white rounded-xl border border-slate-200 shadow-sm">
                  <span className="text-[8px] font-bold text-slate-400 uppercase">Friend {g + 1}</span>
                  <svg width={quotient * 15 + 10} height="20">{items}</svg>
                  <span className="text-xs font-black text-emerald-500">{quotient}</span>
               </div>
            );
         }
         return (
            <div className="flex flex-wrap justify-center gap-4">
               {groups}
               {remainder > 0 && (
                  <div className="flex flex-col items-center gap-2 p-3 bg-amber-50 rounded-xl border border-amber-200 shadow-sm">
                     <span className="text-[8px] font-bold text-amber-500 uppercase">Remainder</span>
                     <svg width={remainder * 15 + 10} height="20">
                        {Array.from({ length: remainder }).map((_, i) => (
                           <circle key={i} cx={i * 15 + 10} cy="10" r="6" fill="#f59e0b" />
                        ))}
                     </svg>
                     <span className="text-xs font-black text-amber-600">{remainder}</span>
                  </div>
               )}
            </div>
         );
      };

      const renderGrouping = () => {
         const groups = [];
         for (let g = 0; g < quotient; g++) {
            groups.push(
               <div key={g} className="p-2 bg-indigo-50 rounded-lg border border-indigo-100 flex gap-1">
                  {Array.from({ length: divisor }).map((_, i) => (
                     <div key={i} className="w-3 h-3 rounded-full bg-indigo-500" />
                  ))}
               </div>
            );
         }
         return (
            <div className="flex flex-wrap justify-center gap-3">
               {groups}
               {remainder > 0 && (
                  <div className="p-2 bg-amber-50 rounded-lg border border-amber-100 flex gap-1">
                     {Array.from({ length: remainder }).map((_, i) => (
                        <div key={i} className="w-3 h-3 rounded-full bg-amber-500" />
                     ))}
                  </div>
               )}
            </div>
         );
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Division</h2>
                     <p className="text-slate-500 text-sm">Sharing equally or making groups</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setMode('sharing')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'sharing' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        SHARING
                     </button>
                     <button
                        onClick={() => setMode('grouping')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${mode === 'grouping' ? 'bg-indigo-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        GROUPING
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Find a combination with remainder 2</p>
                           <p className="text-xs opacity-80">Adjust the total and divisor until 2 items are left over.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-y-auto">
                  {mode === 'sharing' ? renderSharing() : renderGrouping()}
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">{total}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√∑</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-indigo-400">{divisor}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">{mode === 'sharing' ? 'Friends' : 'Group Size'}</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{quotient}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">{mode === 'sharing' ? 'Each' : 'Groups'}</div>
                  </div>
                  {remainder > 0 && (
                     <>
                        <div className="text-xl font-bold text-slate-600">rem</div>
                        <div className="flex flex-col items-center">
                           <div className="text-4xl font-black text-amber-400">{remainder}</div>
                           <div className="text-[8px] font-bold text-slate-500 uppercase">Left</div>
                        </div>
                     </>
                  )}
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Items</label>
                        <span className="text-2xl font-black text-emerald-500">{total}</span>
                     </div>
                     <input
                        type="range" min="1" max="30" step="1" value={total}
                        onChange={(e) => setTotal(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{mode === 'sharing' ? 'Number of Friends' : 'Items per Group'}</label>
                        <span className="text-2xl font-black text-indigo-500">{divisor}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={divisor}
                        onChange={(e) => setDivisor(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Division is "undoing" multiplication.
                        If <span className="font-bold">{divisor} √ó {quotient} = {divisor * quotient}</span>,
                        then <span className="font-bold">{total} √∑ {divisor} = {quotient}</span>
                        (with {remainder} left over).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FRACTION RENDERER (Part-Whole, Equivalence, Comparison) ---
   // Stage 1: Core insight = Equal parts of a whole.
   // Stage 2: Primary = numerator, denominator.
   // Stage 3: Bar vs Circle models + Equivalence ghosting.
   // Stage 4: n/d.
   // Stage 5: State (n, d, model) ‚Üí Derived (percentage, angle).
   // Stage 6: Challenge = "Find equivalent to 1/2".
   const FractionRenderer = () => {
      const [num, setNum] = useState(1);
      const [den, setDen] = useState(4);
      const [model, setModel] = useState<'bar' | 'circle'>('bar');
      const [showEquivalent, setShowEquivalent] = useState(false);
      const [challengeMode, setChallengeMode] = useState(false);

      const percentage = (num / den) * 100;
      const isChallengeMet = challengeMode && num / den === 0.5 && den !== 2;

      const renderBar = (n: number, d: number, color: string, isGhost: boolean = false) => {
         const parts = [];
         const width = 300;
         const height = 40;
         const partWidth = width / d;

         for (let i = 0; i < d; i++) {
            parts.push(
               <rect
                  key={i}
                  x={i * partWidth}
                  y={0}
                  width={partWidth}
                  height={height}
                  fill={i < n ? color : "transparent"}
                  stroke={isGhost ? "#cbd5e1" : "#94a3b8"}
                  strokeWidth={isGhost ? "1" : "2"}
                  opacity={isGhost ? 0.3 : 1}
                  className="transition-all duration-500"
               />
            );
         }
         return <g transform="translate(10, 10)">{parts}</g>;
      };

      const renderCircle = (n: number, d: number, color: string) => {
         const parts = [];
         const radius = 80;
         const cx = 100;
         const cy = 100;

         for (let i = 0; i < d; i++) {
            const startAngle = (i * 360) / d;
            const endAngle = ((i + 1) * 360) / d;
            const x1 = cx + radius * Math.cos((startAngle - 90) * Math.PI / 180);
            const y1 = cy + radius * Math.sin((startAngle - 90) * Math.PI / 180);
            const x2 = cx + radius * Math.cos((endAngle - 90) * Math.PI / 180);
            const y2 = cy + radius * Math.sin((endAngle - 90) * Math.PI / 180);

            const largeArcFlag = 360 / d > 180 ? 1 : 0;
            const dPath = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

            parts.push(
               <path
                  key={i}
                  d={dPath}
                  fill={i < n ? color : "white"}
                  stroke="#94a3b8"
                  strokeWidth="2"
                  className="transition-all duration-500"
               />
            );
         }
         return <g transform="translate(50, 20)">{parts}</g>;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Fractions</h2>
                     <p className="text-slate-500 text-sm">Parts of a whole</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setModel('bar')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${model === 'bar' ? 'bg-blue-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        BAR MODEL
                     </button>
                     <button
                        onClick={() => setModel('circle')}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${model === 'circle' ? 'bg-purple-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                           }`}
                     >
                        CIRCLE MODEL
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Find an equivalent to 1/2 (but not 1/2!)</p>
                           <p className="text-xs opacity-80">Adjust the sliders to find another fraction that covers half the shape.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8">
                  <svg className="w-full max-w-[400px] h-[250px]" viewBox="0 0 320 250">
                     {model === 'bar' ? (
                        <>
                           {renderBar(num, den, model === 'bar' ? "#3b82f6" : "#a855f7")}
                           {showEquivalent && (
                              <g transform="translate(0, 60)">
                                 {renderBar(num * 2, den * 2, "#cbd5e1", true)}
                                 <text x="160" y="60" textAnchor="middle" className="text-[10px] fill-slate-400 font-bold italic">Equivalent: {num * 2}/{den * 2}</text>
                              </g>
                           )}
                        </>
                     ) : (
                        renderCircle(num, den, "#a855f7")
                     )}
                  </svg>

                  <div className="mt-8 flex items-center gap-8">
                     <div className="flex flex-col items-center">
                        <div className="text-5xl font-black text-slate-900 border-b-4 border-slate-900 pb-1 mb-1">{num}</div>
                        <div className="text-5xl font-black text-slate-900">{den}</div>
                     </div>
                     <div className="h-20 w-px bg-slate-200" />
                     <div className="text-center">
                        <div className="text-3xl font-black text-slate-400">{percentage.toFixed(0)}%</div>
                        <div className="text-[10px] font-bold text-slate-400 uppercase">of the whole</div>
                     </div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Numerator (Parts)</label>
                        <span className="text-2xl font-black text-blue-500">{num}</span>
                     </div>
                     <input
                        type="range" min="0" max={den} step="1" value={num}
                        onChange={(e) => setNum(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Denominator (Total)</label>
                        <span className="text-2xl font-black text-slate-900">{den}</span>
                     </div>
                     <input
                        type="range" min="1" max="12" step="1" value={den}
                        onChange={(e) => {
                           const val = Number(e.target.value);
                           setDen(val);
                           if (num > val) setNum(val);
                        }}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-900"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowEquivalent(!showEquivalent)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${showEquivalent ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showEquivalent ? 'üîç HIDE EQUIVALENT' : 'üîç SHOW EQUIVALENT'}
                  </button>

                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> The <strong>denominator</strong> tells you how many equal parts make a whole.
                        The <strong>numerator</strong> tells you how many of those parts you have.
                        Different fractions can represent the <strong>same amount</strong> (like 1/2 and 2/4)!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- AREA RENDERER (Grid Discovery & Formula Bridge) ---
   // Stage 1: Core insight = Area is the space inside a boundary.
   // Stage 2: Primary = width, height.
   // Stage 3: Resizable Grid + Counting Mode.
   // Stage 4: A = L √ó W.
   // Stage 5: State (w, h, showGrid) ‚Üí Derived (area).
   // Stage 6: Challenge = "Build Area 12".
   const AreaRenderer = () => {
      const [width, setWidth] = useState(4);
      const [height, setHeight] = useState(3);
      const [showGrid, setShowGrid] = useState(true);
      const [challengeMode, setChallengeMode] = useState(false);

      const area = width * height;
      const isChallengeMet = challengeMode && area === 12;

      const renderGrid = () => {
         const cells = [];
         const cellSize = 40;
         for (let r = 0; r < height; r++) {
            for (let c = 0; c < width; c++) {
               cells.push(
                  <rect
                     key={`${r}-${c}`}
                     x={c * cellSize}
                     y={r * cellSize}
                     width={cellSize - 1}
                     height={cellSize - 1}
                     fill={showGrid ? "#f8fafc" : "#3b82f6"}
                     stroke={showGrid ? "#cbd5e1" : "none"}
                     className="transition-all duration-300"
                  />
               );
               if (showGrid) {
                  cells.push(
                     <text
                        key={`t-${r}-${c}`}
                        x={c * cellSize + cellSize / 2}
                        y={r * cellSize + cellSize / 2 + 4}
                        textAnchor="middle"
                        className="text-[8px] fill-slate-300 font-bold"
                     >
                        {r * width + c + 1}
                     </text>
                  );
               }
            }
         }
         return cells;
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Area of Rectangles</h2>
                     <p className="text-slate-500 text-sm">Measuring space with unit squares</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Build a rectangle with Area 12</p>
                           <p className="text-xs opacity-80">Adjust width and height until the total area is exactly 12.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 overflow-hidden">
                  <div className="relative">
                     <svg width={width * 40} height={height * 40} className="shadow-xl rounded-sm overflow-visible">
                        {renderGrid()}
                        {/* Dimension Labels */}
                        <g transform={`translate(${width * 20}, -15)`}>
                           <text textAnchor="middle" className="text-sm font-black fill-blue-600">{width} units</text>
                           <path d={`M ${-width * 20},5 L ${width * 20},5`} stroke="#3b82f6" strokeWidth="2" markerStart="url(#arrow)" markerEnd="url(#arrow)" />
                        </g>
                        <g transform={`translate(${-15}, ${height * 20}) rotate(-90)`}>
                           <text textAnchor="middle" className="text-sm font-black fill-blue-600">{height} units</text>
                           <path d={`M ${-height * 20},5 L ${height * 20},5`} stroke="#3b82f6" strokeWidth="2" />
                        </g>
                     </svg>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{width}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Width</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">√ó</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-blue-400">{height}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Height</div>
                  </div>
                  <div className="text-3xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-5xl font-black text-emerald-400">{area}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Area</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üî Width</label>
                        <span className="text-2xl font-black text-blue-500">{width}</span>
                     </div>
                     <input
                        type="range" min="1" max="10" step="1" value={width}
                        onChange={(e) => setWidth(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="space-y-3">
                     <div className="flex justify-between items-end">
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚Üï Height</label>
                        <span className="text-2xl font-black text-blue-500">{height}</span>
                     </div>
                     <input
                        type="range" min="1" max="8" step="1" value={height}
                        onChange={(e) => setHeight(Number(e.target.value))}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="space-y-4">
                  <button
                     onClick={() => setShowGrid(!showGrid)}
                     className={`w-full py-3 rounded-xl font-bold text-sm transition-all ${showGrid ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'
                        }`}
                  >
                     {showGrid ? 'üî¢ HIDE UNIT SQUARES' : 'üî¢ SHOW UNIT SQUARES'}
                  </button>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Area is the number of <strong>unit squares</strong>
                        that fit inside a shape. Instead of counting them all one by one,
                        you can just multiply the <strong>width</strong> by the <strong>height</strong>!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- POSTURE ANALYZER RENDERER ---
   const PostureAnalyzerRenderer = () => {
      const [view, setView] = useState<'side' | 'front'>('side');
      const [headForward, setHeadForward] = useState(20); // 0-100
      const [shoulderRound, setShoulderRound] = useState(30); // 0-100
      const [showCorrections, setShowCorrections] = useState(false);

      const score = Math.max(0, 100 - (headForward * 0.5) - (shoulderRound * 0.5));

      return (
         <div className="w-full h-full bg-white flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Posture Analyzer</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Alignment & Ergonomics</p>
               </div>
               <div className="flex gap-2">
                  <button
                     onClick={() => setView('side')}
                     className={`px-4 py-2 rounded-xl text-[10px] font-bold transition-all ${view === 'side' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-500'}`}
                  >
                     SIDE VIEW
                  </button>
                  <button
                     onClick={() => setView('front')}
                     className={`px-4 py-2 rounded-xl text-[10px] font-bold transition-all ${view === 'front' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-500'}`}
                  >
                     FRONT VIEW
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visual Assessment Area */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12">
                  <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-64 h-[400px] flex items-center justify-center">
                     {/* Human Skeleton Simplified */}
                     <svg className="w-full h-full overflow-visible" viewBox="0 0 100 200">
                        {view === 'side' ? (
                           <g className="transition-all duration-500">
                              {/* Spine */}
                              <path
                                 d={`M 50 180 Q 45 140 50 100 Q ${50 + shoulderRound / 10} 60 ${50 - headForward / 5} 30`}
                                 fill="none" stroke="#cbd5e1" strokeWidth="4" strokeLinecap="round"
                              />
                              {/* Head */}
                              <circle cx={50 - headForward / 5} cy="20" r="10" fill="#1e293b" />
                              {/* Shoulder */}
                              <circle cx={50 + shoulderRound / 10} cy="60" r="4" fill="#3b82f6" />
                              {/* Hip */}
                              <circle cx="50" cy="100" r="5" fill="#1e293b" />
                              {/* Leg */}
                              <line x1="50" y1="100" x2="50" y2="180" stroke="#1e293b" strokeWidth="4" />

                              {/* Correction Guides */}
                              {showCorrections && (
                                 <g className="animate-pulse">
                                    <line x1="50" y1="10" x2="50" y2="190" stroke="#10b981" strokeWidth="1" strokeDasharray="4 2" />
                                    <path d="M 40 30 L 50 30" stroke="#10b981" strokeWidth="2" markerEnd="url(#arrow)" />
                                    <path d="M 60 60 L 50 60" stroke="#10b981" strokeWidth="2" markerEnd="url(#arrow)" />
                                 </g>
                              )}
                           </g>
                        ) : (
                           <g className="transition-all duration-500">
                              {/* Torso */}
                              <rect x="35" y="60" width="30" height="40" rx="5" fill="#f1f5f9" stroke="#cbd5e1" strokeWidth="2" />
                              {/* Head */}
                              <circle cx="50" cy="30" r="12" fill="#1e293b" />
                              {/* Shoulders */}
                              <line x1="30" y1="60" x2="70" y2="60" stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                              {/* Hips */}
                              <line x1="35" y1="100" x2="65" y2="100" stroke="#1e293b" strokeWidth="6" strokeLinecap="round" />
                              {/* Legs */}
                              <line x1="40" y1="100" x2="40" y2="180" stroke="#1e293b" strokeWidth="4" />
                              <line x1="60" y1="100" x2="60" y2="180" stroke="#1e293b" strokeWidth="4" />
                           </g>
                        )}
                        <defs>
                           <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse">
                              <path d="M 0 0 L 10 5 L 0 10 z" fill="#10b981" />
                           </marker>
                        </defs>
                     </svg>
                  </div>
               </div>

               {/* Controls & Analysis */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Posture Score</p>
                     <div className="text-5xl font-black text-slate-900">{Math.round(score)}<span className="text-lg text-slate-300">/100</span></div>
                     <p className={`text-[10px] font-bold mt-2 uppercase tracking-tight ${score > 80 ? 'text-emerald-500' : score > 60 ? 'text-amber-500' : 'text-red-500'}`}>
                        {score > 80 ? 'Excellent Alignment' : score > 60 ? 'Room for Improvement' : 'Correction Required'}
                     </p>
                  </div>

                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Simulation Controls</p>
                     <div className="space-y-4">
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HEAD FORWARD</span>
                              <span className="text-slate-900">{headForward}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={headForward}
                              onChange={(e) => setHeadForward(parseInt(e.target.value))}
                              className="w-full accent-slate-900"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">SHOULDER ROUNDING</span>
                              <span className="text-slate-900">{shoulderRound}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={shoulderRound}
                              onChange={(e) => setShoulderRound(parseInt(e.target.value))}
                              className="w-full accent-slate-900"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Alignment Check</p>
                     <ul className="space-y-2">
                        {[
                           { label: 'Ears over shoulders', status: headForward < 20 ? '‚úì' : '‚ö†Ô∏è', color: headForward < 20 ? 'text-emerald-500' : 'text-amber-500' },
                           { label: 'Shoulders back', status: shoulderRound < 30 ? '‚úì' : '‚ö†Ô∏è', color: shoulderRound < 30 ? 'text-emerald-500' : 'text-amber-500' },
                           { label: 'Hips level', status: '‚úì', color: 'text-emerald-500' },
                           { label: 'Neutral spine', status: (headForward + shoulderRound) < 50 ? '‚úì' : '‚ö†Ô∏è', color: (headForward + shoulderRound) < 50 ? 'text-emerald-500' : 'text-amber-500' }
                        ].map(item => (
                           <li key={item.label} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 text-[10px] font-bold">
                              <span className="text-slate-600">{item.label}</span>
                              <span className={item.color}>{item.status}</span>
                           </li>
                        ))}
                     </ul>
                  </div>

                  <button
                     onClick={() => setShowCorrections(!showCorrections)}
                     className={`mt-auto p-4 rounded-2xl font-black text-xs transition-all uppercase ${showCorrections ? 'bg-emerald-500 text-white' : 'bg-slate-900 text-white hover:bg-slate-800'
                        }`}
                  >
                     {showCorrections ? 'Hide Corrections' : 'Show Corrections'}
                  </button>
               </div>
            </div>
         </div>
      );
   };
   // --- HEART RATE ZONE RENDERER ---
   const HeartRateZoneRenderer = () => {
      const [age, setAge] = useState(25);
      const [restingHR, setRestingHR] = useState(60);
      const [intensity, setIntensity] = useState(50);

      const maxHR = 220 - age;
      const hrr = maxHR - restingHR;
      const targetHR = Math.round(restingHR + (hrr * intensity) / 100);

      const getZone = (hr: number) => {
         const pct = ((hr - restingHR) / hrr) * 100;
         if (intensity < 50) return { name: 'Warm Up', color: 'bg-slate-400', text: 'text-slate-400', desc: 'Light activity, preparing the body.' };
         if (intensity < 60) return { name: 'Zone 1: Recovery', color: 'bg-emerald-400', text: 'text-emerald-400', desc: 'Very light. Improves overall health and helps recovery.' };
         if (intensity < 70) return { name: 'Zone 2: Aerobic', color: 'bg-emerald-500', text: 'text-emerald-500', desc: 'Light. Build endurance and burns fat efficiently.' };
         if (intensity < 80) return { name: 'Zone 3: Tempo', color: 'bg-amber-500', text: 'text-amber-500', desc: 'Moderate. Improves aerobic capacity and circulation.' };
         if (intensity < 90) return { name: 'Zone 4: Threshold', color: 'bg-orange-500', text: 'text-orange-500', desc: 'Hard. Increases maximum performance capacity.' };
         return { name: 'Zone 5: Anaerobic', color: 'bg-red-500', text: 'text-red-500', desc: 'Maximum. Improves speed and neuromuscular system.' };
      };

      const zone = getZone(targetHR);

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Heart Rate Zone Trainer</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Target Heart Rate & Intensity</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Max HR</p>
                     <p className="text-lg font-black text-slate-900">{maxHR}</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Target</p>
                     <p className={`text-lg font-black ${zone.text}`}>{targetHR} <span className="text-[10px]">BPM</span></p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative flex flex-col items-center gap-12">
                     {/* Pulsing Heart */}
                     <div className="relative">
                        <div
                           className={`text-8xl transition-all duration-300 transform`}
                           style={{
                              animation: `pulse ${60 / targetHR}s infinite cubic-bezier(0.4, 0, 0.6, 1)`,
                              filter: `drop-shadow(0 0 20px ${zone.color.replace('bg-', '')})`
                           }}
                        >
                           ‚ù§Ô∏è
                        </div>
                        <style>{`
                           @keyframes pulse {
                              0%, 100% { transform: scale(1); }
                              50% { transform: scale(1.15); }
                           }
                        `}</style>
                     </div>

                     {/* Zone Gauge */}
                     <div className="w-64 h-8 bg-slate-100 rounded-full overflow-hidden flex border border-slate-200">
                        <div className="h-full bg-emerald-400" style={{ width: '10%' }} />
                        <div className="h-full bg-emerald-500" style={{ width: '10%' }} />
                        <div className="h-full bg-amber-500" style={{ width: '10%' }} />
                        <div className="h-full bg-orange-500" style={{ width: '10%' }} />
                        <div className="h-full bg-red-500" style={{ width: '10%' }} />
                        <div className="flex-1 bg-slate-200" />
                     </div>

                     <div className="text-center max-w-xs">
                        <h3 className={`text-2xl font-black uppercase tracking-tight ${zone.text}`}>{zone.name}</h3>
                        <p className="text-xs font-bold text-slate-500 mt-2 leading-relaxed">{zone.desc}</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">User Profile</p>
                     <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold text-slate-400">AGE</label>
                           <input
                              type="number" value={age}
                              onChange={(e) => setAge(Math.max(1, Math.min(100, parseInt(e.target.value) || 1)))}
                              className="w-full p-3 bg-white border border-slate-200 rounded-xl font-black text-sm focus:ring-2 focus:ring-slate-900 outline-none"
                           />
                        </div>
                        <div className="space-y-2">
                           <label className="text-[10px] font-bold text-slate-400">RESTING HR</label>
                           <input
                              type="number" value={restingHR}
                              onChange={(e) => setRestingHR(Math.max(30, Math.min(120, parseInt(e.target.value) || 30)))}
                              className="w-full p-3 bg-white border border-slate-200 rounded-xl font-black text-sm focus:ring-2 focus:ring-slate-900 outline-none"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Exercise Intensity</p>
                     <div className="space-y-4">
                        <div className="flex justify-between items-end">
                           <span className="text-3xl font-black text-slate-900">{intensity}%</span>
                           <span className="text-[10px] font-bold text-slate-400 uppercase mb-1">of HR Reserve</span>
                        </div>
                        <input
                           type="range" min="0" max="100" value={intensity}
                           onChange={(e) => setIntensity(parseInt(e.target.value))}
                           className="w-full accent-slate-900"
                        />
                        <div className="flex justify-between text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                           <span>Rest</span>
                           <span>Light</span>
                           <span>Moderate</span>
                           <span>Hard</span>
                           <span>Max</span>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Karvonen Formula</p>
                     <p className="text-[10px] leading-relaxed text-slate-300">
                        Target HR = ((Max HR ‚àí Resting HR) √ó %Intensity) + Resting HR
                     </p>
                     <div className="mt-4 pt-4 border-t border-slate-800">
                        <p className="text-[10px] italic text-slate-500">This formula is more accurate than age-only calculations as it accounts for your fitness level (Resting HR).</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BREATHING GUIDE RENDERER ---
   const BreathingGuideRenderer = () => {
      const [pattern, setPattern] = useState<'box' | '478' | 'relax'>('box');
      const [isActive, setIsActive] = useState(false);
      const [phase, setPhase] = useState<'In' | 'Hold' | 'Out' | 'Hold_Out'>('In');
      const [timeLeft, setTimeLeft] = useState(4);

      const patterns = {
         box: { in: 4, hold: 4, out: 4, hold_out: 4, label: 'Box Breathing' },
         '478': { in: 4, hold: 7, out: 8, hold_out: 0, label: '4-7-8 Technique' },
         relax: { in: 4, hold: 0, out: 6, hold_out: 0, label: 'Relaxation (4-6)' }
      };

      useEffect(() => {
         let timer: any;
         if (isActive) {
            timer = setInterval(() => {
               setTimeLeft(prev => {
                  if (prev <= 1) {
                     // Switch phase
                     const current = patterns[pattern];
                     if (phase === 'In') {
                        if (current.hold > 0) { setPhase('Hold'); return current.hold; }
                        else { setPhase('Out'); return current.out; }
                     } else if (phase === 'Hold') {
                        setPhase('Out'); return current.out;
                     } else if (phase === 'Out') {
                        if (current.hold_out > 0) { setPhase('Hold_Out'); return current.hold_out; }
                        else { setPhase('In'); return current.in; }
                     } else {
                        setPhase('In'); return current.in;
                     }
                  }
                  return prev - 1;
               });
            }, 1000);
         } else {
            setPhase('In');
            setTimeLeft(patterns[pattern].in);
         }
         return () => clearInterval(timer);
      }, [isActive, phase, pattern]);

      const getScale = () => {
         if (!isActive) return 1;
         if (phase === 'In') return 1 + (1 - timeLeft / patterns[pattern].in) * 0.5;
         if (phase === 'Hold') return 1.5;
         if (phase === 'Out') return 1 + (timeLeft / patterns[pattern].out) * 0.5;
         return 1;
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Breathing Guide</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Autonomic Regulation</p>
               </div>
               <div className="flex gap-2">
                  {Object.entries(patterns).map(([key, p]) => (
                     <button
                        key={key} onClick={() => { setPattern(key as any); setIsActive(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${pattern === key ? 'bg-white text-slate-950' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}
                     >
                        {p.label}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative flex items-center justify-center p-12 overflow-hidden bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
                  <div className="absolute inset-0 opacity-20 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '50px 50px' }} />

                  <div className="relative flex flex-col items-center">
                     {/* Breathing Circle */}
                     <div
                        className="w-64 h-64 rounded-full border-4 border-emerald-500/30 flex items-center justify-center transition-all duration-1000 ease-linear"
                        style={{ transform: `scale(${getScale()})`, backgroundColor: phase.includes('Hold') ? 'rgba(16, 185, 129, 0.1)' : 'transparent' }}
                     >
                        <div className="w-48 h-48 rounded-full bg-emerald-500/20 blur-2xl animate-pulse" />
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black tracking-tighter text-emerald-400">{phase.replace('_', ' ')}</span>
                           <span className="text-xl font-mono text-emerald-500/50">{timeLeft}s</span>
                        </div>
                     </div>

                     <button
                        onClick={() => setIsActive(!isActive)}
                        className={`mt-16 px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest ${isActive ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-emerald-500 text-slate-950 shadow-[0_0_30px_rgba(16,185,129,0.3)]'}`}
                     >
                        {isActive ? 'Stop Session' : 'Start Breathing'}
                     </button>
                  </div>
               </div>

               {/* Info Panel */}
               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Current Technique</p>
                     <h3 className="text-2xl font-black text-white">{patterns[pattern].label}</h3>
                     <div className="p-4 bg-slate-950 rounded-2xl border border-slate-800 space-y-3">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500">INHALE</span>
                           <span className="text-emerald-400">{patterns[pattern].in}s</span>
                        </div>
                        {patterns[pattern].hold > 0 && (
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HOLD</span>
                              <span className="text-emerald-400">{patterns[pattern].hold}s</span>
                           </div>
                        )}
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500">EXHALE</span>
                           <span className="text-emerald-400">{patterns[pattern].out}s</span>
                        </div>
                        {patterns[pattern].hold_out > 0 && (
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-slate-500">HOLD</span>
                              <span className="text-emerald-400">{patterns[pattern].hold_out}s</span>
                           </div>
                        )}
                     </div>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Science</p>
                        <p className="text-[10px] leading-relaxed text-slate-300">
                           By extending your <strong>exhale</strong> longer than your inhale, you stimulate the <strong>Vagus Nerve</strong>, which signals your brain to switch from "Fight or Flight" to "Rest and Digest" mode.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- PLATE METHOD RENDERER ---
   const PlateMethodRenderer = () => {
      const [portions, setPortions] = useState({ veggies: 50, protein: 25, carbs: 25 });
      const [mealType, setMealType] = useState<'balanced' | 'low_carb' | 'high_protein'>('balanced');

      const setPreset = (type: 'balanced' | 'low_carb' | 'high_protein') => {
         setMealType(type);
         if (type === 'balanced') setPortions({ veggies: 50, protein: 25, carbs: 25 });
         if (type === 'low_carb') setPortions({ veggies: 60, protein: 30, carbs: 10 });
         if (type === 'high_protein') setPortions({ veggies: 40, protein: 40, carbs: 20 });
      };

      const getScore = () => {
         const { veggies, protein, carbs } = portions;
         let score = 100;
         if (veggies < 40) score -= (40 - veggies) * 2;
         if (protein < 20) score -= (20 - protein) * 2;
         if (carbs > 40) score -= (carbs - 40) * 1.5;
         return Math.max(0, Math.round(score));
      };

      const score = getScore();

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">The Plate Method</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Visual Portion Control</p>
               </div>
               <div className="flex gap-2">
                  {(['balanced', 'low_carb', 'high_protein'] as const).map(t => (
                     <button
                        key={t} onClick={() => setPreset(t)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${mealType === t ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {t.replace('_', ' ')}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visual Plate */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative w-80 h-80 bg-white rounded-full shadow-2xl border-[12px] border-slate-100 flex items-center justify-center overflow-hidden">
                     <svg viewBox="0 0 100 100" className="absolute inset-0 w-full h-full -rotate-90">
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#10b981" strokeWidth="80"
                           strokeDasharray={`${portions.veggies} 100`}
                        />
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#f59e0b" strokeWidth="80"
                           strokeDasharray={`${portions.protein} 100`}
                           strokeDashoffset={`-${portions.veggies}`}
                        />
                        <circle
                           cx="50" cy="50" r="40" fill="transparent" stroke="#3b82f6" strokeWidth="80"
                           strokeDasharray={`${portions.carbs} 100`}
                           strokeDashoffset={`-${portions.veggies + portions.protein}`}
                        />
                     </svg>

                     <div className="absolute inset-0 pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">ü•¶</span>
                           <span className="text-[10px] font-black text-emerald-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">VEGGIES</span>
                        </div>
                        <div className="absolute top-1/4 right-1/4 translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">üçó</span>
                           <span className="text-[10px] font-black text-amber-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">PROTEIN</span>
                        </div>
                        <div className="absolute bottom-1/4 right-1/2 translate-x-1/2 translate-y-1/2 flex flex-col items-center">
                           <span className="text-3xl">üçö</span>
                           <span className="text-[10px] font-black text-blue-900 bg-white/80 px-2 py-0.5 rounded-full mt-1">CARBS</span>
                        </div>
                     </div>

                     <div className="absolute w-20 h-20 bg-white rounded-full shadow-lg flex flex-col items-center justify-center border-4 border-slate-50">
                        <span className="text-[8px] font-black text-slate-400 uppercase">Score</span>
                        <span className="text-2xl font-black text-slate-900">{score}</span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Adjust Portions (%)</p>
                     <div className="space-y-6">
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-emerald-600">VEGETABLES</span>
                              <span className="text-slate-900">{portions.veggies}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.veggies}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.protein / (portions.protein + portions.carbs || 1);
                                 setPortions({
                                    veggies: val,
                                    protein: Math.round(remaining * ratio),
                                    carbs: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-emerald-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-amber-600">PROTEIN</span>
                              <span className="text-slate-900">{portions.protein}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.protein}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.veggies / (portions.veggies + portions.carbs || 1);
                                 setPortions({
                                    protein: val,
                                    veggies: Math.round(remaining * ratio),
                                    carbs: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-amber-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between text-[10px] font-bold">
                              <span className="text-blue-600">CARBOHYDRATES</span>
                              <span className="text-slate-900">{portions.carbs}%</span>
                           </div>
                           <input
                              type="range" min="0" max="100" value={portions.carbs}
                              onChange={(e) => {
                                 const val = parseInt(e.target.value);
                                 const remaining = 100 - val;
                                 const ratio = portions.veggies / (portions.veggies + portions.protein || 1);
                                 setPortions({
                                    carbs: val,
                                    veggies: Math.round(remaining * ratio),
                                    protein: Math.round(remaining * (1 - ratio))
                                 });
                              }}
                              className="w-full accent-blue-500"
                           />
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Why this works</p>
                     <ul className="space-y-3">
                        <li className="flex gap-3">
                           <span className="text-emerald-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Veggies (50%):</strong> High fiber and nutrients, low calorie density.</p>
                        </li>
                        <li className="flex gap-3">
                           <span className="text-amber-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Protein (25%):</strong> Essential for muscle repair and satiety.</p>
                        </li>
                        <li className="flex gap-3">
                           <span className="text-blue-400 text-xs">‚úî</span>
                           <p className="text-[10px] text-slate-300 leading-relaxed"><strong>Carbs (25%):</strong> Primary energy source for brain and body.</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GRAVITATIONAL PE RENDERER (PE = mgh) ---
   const GravitationalPERenderer = () => {
      const [height, setHeight] = useState(10); // meters
      const [mass, setMass] = useState(5);     // kg
      const [gravity, setGravity] = useState(9.8); // m/s^2
      const [isDropping, setIsDropping] = useState(false);
      const [currentHeight, setCurrentHeight] = useState(10);
      const [velocity, setVelocity] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);
      const [targetPE, setTargetPE] = useState(500);

      const planets = [
         { name: 'Earth', g: 9.8, color: 'text-blue-400' },
         { name: 'Moon', g: 1.6, color: 'text-slate-400' },
         { name: 'Mars', g: 3.7, color: 'text-orange-400' },
         { name: 'Jupiter', g: 24.8, color: 'text-amber-600' }
      ];

      const pe = mass * gravity * height;
      const currentPE = mass * gravity * currentHeight;
      const ke = 0.5 * mass * velocity * velocity;
      const totalE = pe; // Initial total energy

      useEffect(() => {
         let animationFrame: number;
         if (isDropping && currentHeight > 0) {
            let lastTime = performance.now();
            const animate = (time: number) => {
               const dt = (time - lastTime) / 1000;
               lastTime = time;

               setCurrentHeight(prev => {
                  const newHeight = prev - velocity * dt - 0.5 * gravity * dt * dt;
                  if (newHeight <= 0) {
                     setIsDropping(false);
                     setVelocity(Math.sqrt(2 * gravity * height)); // Final velocity
                     return 0;
                  }
                  return newHeight;
               });
               setVelocity(v => v + gravity * dt);
               animationFrame = requestAnimationFrame(animate);
            };
            animationFrame = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationFrame);
      }, [isDropping, gravity, height]);

      const reset = () => {
         setIsDropping(false);
         setCurrentHeight(height);
         setVelocity(0);
      };

      useEffect(() => {
         reset();
      }, [height, mass, gravity]);

      const isChallengeMet = challengeMode && Math.abs(pe - targetPE) < 10;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Gravitational Potential Energy</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">PE = mgh</p>
               </div>
               <div className="flex items-center gap-4">
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'}`}
                  >
                     {challengeMode ? 'Exit Challenge' : 'Challenge Mode'}
                  </button>
                  <div className="flex gap-1">
                     {planets.map(p => (
                        <button
                           key={p.name}
                           onClick={() => setGravity(p.g)}
                           className={`px-2 py-1 rounded-md text-[10px] font-bold transition-all ${gravity === p.g ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                        >
                           {p.name}
                        </button>
                     ))}
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Area */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  {/* Ground */}
                  <div className="absolute bottom-20 left-10 right-10 h-2 bg-slate-200 rounded-full" />

                  {/* Object */}
                  <div
                     className="absolute w-12 h-12 bg-indigo-600 rounded-2xl shadow-lg flex items-center justify-center transition-transform duration-75"
                     style={{
                        bottom: `${88 + (currentHeight * 20)}px`,
                        transform: `rotate(${velocity * 2}deg)`
                     }}
                  >
                     <span className="text-white font-black text-xs">{mass}kg</span>
                  </div>

                  {/* Height Indicator */}
                  <div
                     className="absolute left-20 border-l-2 border-dashed border-slate-300 flex flex-col justify-between py-2"
                     style={{ bottom: '88px', height: `${height * 20}px` }}
                  >
                     <div className="w-4 h-0.5 bg-slate-300" />
                     <div className="absolute top-1/2 -translate-y-1/2 -left-8 text-[10px] font-bold text-slate-400 rotate-90 whitespace-nowrap">
                        HEIGHT: {height}m
                     </div>
                     <div className="w-4 h-0.5 bg-slate-300" />
                  </div>

                  {/* Energy Bars */}
                  <div className="absolute right-10 bottom-32 flex gap-4 items-end h-48">
                     <div className="flex flex-col items-center gap-2">
                        <div className="w-8 bg-slate-100 rounded-t-lg relative overflow-hidden h-full">
                           <div
                              className="absolute bottom-0 w-full bg-emerald-500 transition-all duration-75"
                              style={{ height: `${(currentPE / (totalE || 1)) * 100}%` }}
                           />
                        </div>
                        <span className="text-[8px] font-black text-slate-400 uppercase">PE</span>
                     </div>
                     <div className="flex flex-col items-center gap-2">
                        <div className="w-8 bg-slate-100 rounded-t-lg relative overflow-hidden h-full">
                           <div
                              className="absolute bottom-0 w-full bg-blue-500 transition-all duration-75"
                              style={{ height: `${(ke / (totalE || 1)) * 100}%` }}
                           />
                        </div>
                        <span className="text-[8px] font-black text-slate-400 uppercase">KE</span>
                     </div>
                  </div>

                  {/* Controls Overlay */}
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsDropping(true)}
                        disabled={isDropping || currentHeight <= 0}
                        className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black text-sm shadow-xl hover:bg-indigo-700 disabled:opacity-50 transition-all"
                     >
                        DROP OBJECT
                     </button>
                     <button
                        onClick={reset}
                        className="px-8 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-sm hover:bg-slate-200 transition-all"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               {/* Right Panel */}
               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  {challengeMode && (
                     <div className={`p-6 rounded-3xl border-2 transition-all ${isChallengeMet ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}`}>
                        <div className="flex items-center gap-3 mb-4">
                           <div className={`w-8 h-8 rounded-full flex items-center justify-center text-lg ${isChallengeMet ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'}`}>
                              {isChallengeMet ? '‚úì' : 'üéØ'}
                           </div>
                           <div>
                              <p className="font-bold text-slate-800 text-sm">Goal: Reach {targetPE}J of PE</p>
                              <p className="text-[10px] text-slate-500">Adjust mass and height to hit the target.</p>
                           </div>
                        </div>
                        {isChallengeMet && <div className="text-emerald-600 font-black text-center animate-bounce">CHALLENGE COMPLETE!</div>}
                     </div>
                  )}

                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">MASS (kg)</span>
                           <span className="text-slate-900">{mass} kg</span>
                        </div>
                        <input
                           type="range" min="1" max="20" value={mass}
                           onChange={(e) => setMass(parseInt(e.target.value))}
                           className="w-full accent-indigo-600"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">HEIGHT (m)</span>
                           <span className="text-slate-900">{height} m</span>
                        </div>
                        <input
                           type="range" min="1" max="20" value={height}
                           onChange={(e) => setHeight(parseInt(e.target.value))}
                           className="w-full accent-indigo-600"
                        />
                     </div>
                  </div>

                  <div className="mt-auto grid grid-cols-2 gap-4">
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Potential Energy</p>
                        <p className="text-xl font-black text-emerald-600">{Math.round(currentPE)}J</p>
                     </div>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Kinetic Energy</p>
                        <p className="text-xl font-black text-blue-600">{Math.round(ke)}J</p>
                     </div>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm col-span-2">
                        <p className="text-[8px] font-black text-slate-400 uppercase mb-1">Velocity</p>
                        <p className="text-xl font-black text-slate-900">{velocity.toFixed(1)} m/s</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CHEMICAL PE RENDERER (Bond Energy) ---
   const ChemicalPERenderer = () => {
      const [reaction, setReaction] = useState<'exothermic' | 'endothermic'>('exothermic');
      const [isReacting, setIsReacting] = useState(false);
      const [progress, setProgress] = useState(0);

      const reactions = {
         exothermic: {
            name: 'Combustion (Methane)',
            reactants: 'CH‚ÇÑ + 2O‚ÇÇ',
            products: 'CO‚ÇÇ + 2H‚ÇÇO',
            energyDelta: -890, // kJ/mol
            activationEnergy: 100,
            desc: 'Energy is released as new, stronger bonds form.'
         },
         endothermic: {
            name: 'Photosynthesis (Simplified)',
            reactants: '6CO‚ÇÇ + 6H‚ÇÇO',
            products: 'C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ',
            energyDelta: 2800, // kJ/mol
            activationEnergy: 500,
            desc: 'Energy is absorbed to break strong bonds and form weaker ones.'
         }
      };

      const current = reactions[reaction];

      useEffect(() => {
         let interval: any;
         if (isReacting) {
            interval = setInterval(() => {
               setProgress(p => {
                  if (p >= 100) {
                     setIsReacting(false);
                     return 100;
                  }
                  return p + 2;
               });
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isReacting]);

      const reset = () => {
         setIsReacting(false);
         setProgress(0);
      };

      useEffect(() => {
         reset();
      }, [reaction]);

      const getEnergyY = (x: number) => {
         const startY = 200;
         const peakY = startY - current.activationEnergy * 0.2;
         const endY = startY - current.energyDelta * 0.1;

         if (x < 30) return startY;
         if (x < 50) {
            const t = (x - 30) / 20;
            return startY + (peakY - startY) * (1 - Math.cos(t * Math.PI)) / 2;
         }
         if (x < 70) {
            const t = (x - 50) / 20;
            return peakY + (endY - peakY) * (1 - Math.cos(t * Math.PI)) / 2;
         }
         return endY;
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Chemical Potential Energy</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Bond Energy & Reactions</p>
               </div>
               <div className="flex gap-2">
                  {(['exothermic', 'endothermic'] as const).map(type => (
                     <button
                        key={type}
                        onClick={() => setReaction(type)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${reaction === type ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {type}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex flex-col p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="flex-1 relative">
                     <svg viewBox="0 0 400 300" className="w-full h-full">
                        <line x1="40" y1="260" x2="380" y2="260" stroke="#cbd5e1" strokeWidth="2" markerEnd="url(#arrow)" />
                        <line x1="40" y1="260" x2="40" y2="20" stroke="#cbd5e1" strokeWidth="2" markerEnd="url(#arrow)" />
                        <text x="380" y="275" textAnchor="end" className="text-[8px] font-bold fill-slate-400">REACTION PROGRESS</text>
                        <text x="35" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">POTENTIAL ENERGY</text>

                        <path
                           d={`M 40,200 L 120,200 ${Array.from({ length: 41 }).map((_, i) => {
                              const x = 120 + i * 4;
                              const progressX = (i / 40) * 40 + 30;
                              return `L ${x},${getEnergyY(progressX)}`;
                           }).join(' ')} L 360,${getEnergyY(70)}`}
                           fill="none"
                           stroke="#6366f1"
                           strokeWidth="4"
                           strokeLinecap="round"
                        />

                        {isReacting && (
                           <circle
                              cx={120 + (progress / 100) * 160}
                              cy={getEnergyY(30 + (progress / 100) * 40)}
                              r="6"
                              fill="#ef4444"
                              className="animate-pulse"
                           />
                        )}

                        <text x="80" y="190" textAnchor="middle" className="text-[10px] font-black fill-slate-600">REACTANTS</text>
                        <text x="320" y={getEnergyY(70) - 10} textAnchor="middle" className="text-[10px] font-black fill-slate-600">PRODUCTS</text>

                        <line
                           x1="360" y1="200" x2="360" y2={getEnergyY(70)}
                           stroke={reaction === 'exothermic' ? '#10b981' : '#ef4444'}
                           strokeWidth="2"
                           strokeDasharray="4"
                           markerEnd="url(#arrow)"
                        />
                        <text x="365" y={(200 + getEnergyY(70)) / 2} className="text-[8px] font-bold fill-slate-500">
                           ŒîH = {current.energyDelta} kJ/mol
                        </text>
                     </svg>

                     <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-4">
                        <button
                           onClick={() => setIsReacting(true)}
                           disabled={isReacting}
                           className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black text-sm shadow-xl hover:bg-indigo-700 disabled:opacity-50 transition-all"
                        >
                           START REACTION
                        </button>
                        <button
                           onClick={reset}
                           className="px-8 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-sm hover:bg-slate-200 transition-all"
                        >
                           RESET
                        </button>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Reaction Details</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Equation</span>
                           <span className="text-sm font-mono font-bold text-indigo-600">{current.reactants} ‚Üí {current.products}</span>
                        </div>
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Type</span>
                           <span className={`text-[10px] font-black px-2 py-1 rounded-full ${reaction === 'exothermic' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                              {reaction.toUpperCase()}
                           </span>
                        </div>
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        {current.desc}
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <p className="text-[10px] font-black text-indigo-900 uppercase mb-2">Bond Energy Rule</p>
                        <p className="text-[10px] text-indigo-700 leading-relaxed">
                           Breaking bonds <strong>requires</strong> energy (+).<br />
                           Forming bonds <strong>releases</strong> energy (-).
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENERGY CONSERVATION RENDERER ---
   const EnergyConservationRenderer = () => {
      const [scenario, setScenario] = useState<'pendulum' | 'coaster' | 'ball'>('pendulum');
      const [friction, setFriction] = useState(0); // 0-100
      const [isPlaying, setIsPlaying] = useState(false);
      const [time, setTime] = useState(0);

      const [pe, setPe] = useState(100);
      const [ke, setKe] = useState(0);
      const [thermal, setThermal] = useState(0);

      useEffect(() => {
         let animationId: number;
         if (isPlaying) {
            const animate = () => {
               setTime(t => t + 0.05);
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isPlaying]);

      useEffect(() => {
         const damping = friction * 0.001;
         let newPe = 0;
         let newKe = 0;

         if (scenario === 'pendulum') {
            const amplitude = 100 * Math.exp(-damping * time);
            const angle = amplitude * Math.cos(2 * time);
            newPe = Math.abs(angle);
            newKe = amplitude - newPe;
         } else if (scenario === 'ball') {
            const gravity = 9.8;
            const h0 = 100;
            const period = Math.sqrt(2 * h0 / gravity) * 2;
            const tInPeriod = time % period;
            const halfPeriod = period / 2;

            let h;
            if (tInPeriod < halfPeriod) {
               h = h0 - 0.5 * gravity * tInPeriod * tInPeriod;
            } else {
               const tUp = tInPeriod - halfPeriod;
               const v0 = gravity * halfPeriod;
               h = v0 * tUp - 0.5 * gravity * tUp * tUp;
            }

            const bounceCount = Math.floor(time / period);
            const energyLoss = Math.pow(1 - friction / 200, bounceCount);
            newPe = Math.max(0, h * energyLoss);
            newKe = Math.max(0, (h0 - h) * energyLoss);
         } else if (scenario === 'coaster') {
            const x = (time * 50) % 400;
            const h = 50 + 40 * Math.sin(x / 50);
            const energyLoss = Math.exp(-damping * time);
            newPe = h * energyLoss;
            newKe = (100 - h) * energyLoss;
         }

         setPe(newPe);
         setKe(newKe);
         setThermal(100 - (newPe + newKe));
      }, [time, scenario, friction]);

      const reset = () => {
         setTime(0);
         setThermal(0);
         setIsPlaying(false);
      };

      useEffect(() => {
         reset();
      }, [scenario]);

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Energy Conservation Lab</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Total Energy is Constant</p>
               </div>
               <div className="flex gap-2">
                  {(['pendulum', 'coaster', 'ball'] as const).map(s => (
                     <button
                        key={s}
                        onClick={() => setScenario(s)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${scenario === s ? 'bg-white text-slate-900' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-12 overflow-hidden bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-full h-full flex items-center justify-center">
                     {scenario === 'pendulum' && (
                        <div className="relative h-64 w-64 flex flex-col items-center">
                           <div className="w-32 h-2 bg-slate-700 rounded-full" />
                           <div
                              className="absolute top-0 origin-top transition-transform duration-75"
                              style={{ transform: `rotate(${(pe - 50) * 0.8}deg)`, height: '200px' }}
                           >
                              <div className="w-1 h-full bg-slate-500 mx-auto" />
                              <div className="w-10 h-10 bg-indigo-500 rounded-full shadow-[0_0_20px_rgba(99,102,241,0.5)] -mt-5 mx-auto" />
                           </div>
                        </div>
                     )}

                     {scenario === 'ball' && (
                        <div className="relative h-64 w-64">
                           <div className="absolute bottom-0 w-full h-2 bg-slate-700 rounded-full" />
                           <div
                              className="absolute left-1/2 -translate-x-1/2 w-12 h-12 bg-emerald-500 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.5)] transition-all duration-75"
                              style={{ bottom: `${8 + pe * 2}px` }}
                           />
                        </div>
                     )}

                     {scenario === 'coaster' && (
                        <div className="relative h-64 w-full px-12">
                           <svg viewBox="0 0 400 200" className="w-full h-full">
                              <path
                                 d="M 0,150 Q 100,50 200,150 T 400,150"
                                 fill="none" stroke="#475569" strokeWidth="4" strokeLinecap="round"
                              />
                              <circle
                                 cx={(time * 50) % 400}
                                 cy={150 - (100 - (50 + 40 * Math.sin(((time * 50) % 400) / 50)))}
                                 r="10" fill="#f59e0b"
                              />
                           </svg>
                        </div>
                     )}
                  </div>

                  <div className="absolute top-10 right-10 flex flex-col gap-4 bg-slate-900/80 backdrop-blur-md p-6 rounded-3xl border border-slate-700 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Energy Distribution</p>
                     <div className="flex gap-4 h-32 items-end">
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-blue-500 transition-all duration-75" style={{ height: `${pe}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-blue-400">PE</span>
                        </div>
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-emerald-500 transition-all duration-75" style={{ height: `${ke}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-emerald-400">KE</span>
                        </div>
                        <div className="flex flex-col items-center gap-2">
                           <div className="w-6 bg-slate-800 rounded-t-lg relative overflow-hidden h-full">
                              <div className="absolute bottom-0 w-full bg-red-500 transition-all duration-75" style={{ height: `${thermal}%` }} />
                           </div>
                           <span className="text-[8px] font-bold text-red-400">HEAT</span>
                        </div>
                     </div>
                     <div className="mt-4 pt-4 border-t border-slate-800">
                        <div className="flex justify-between text-[10px] font-black">
                           <span className="text-slate-500">TOTAL ENERGY</span>
                           <span className="text-white">100%</span>
                        </div>
                     </div>
                  </div>

                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`px-10 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-xl ${isPlaying ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-white text-slate-950'}`}
                     >
                        {isPlaying ? 'PAUSE' : 'START SIM'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-10 py-4 bg-slate-800 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-700 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-800 border-l border-slate-700 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-400 uppercase">Friction / Damping</span>
                           <span className="text-white">{friction}%</span>
                        </div>
                        <input
                           type="range" min="0" max="100" value={friction}
                           onChange={(e) => setFriction(parseInt(e.target.value))}
                           className="w-full accent-white"
                        />
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl border border-slate-700">
                     <p className="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">The Law</p>
                     <p className="text-xs leading-relaxed text-slate-300 italic">
                        "Energy cannot be created or destroyed; it can only be changed from one form to another."
                     </p>
                     <p className="text-[10px] mt-4 text-slate-500 leading-relaxed">
                        Notice how the Total Energy (PE + KE + Heat) always sums to 100%. Friction doesn't "destroy" energy; it transforms it into thermal energy (Heat).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- MACHINE EFFICIENCY RENDERER (Sankey Diagrams) ---
   const MachineEfficiencyRenderer = () => {
      const [machine, setMachine] = useState<'car' | 'bulb' | 'motor'>('car');

      const machines = {
         car: {
            name: 'Internal Combustion Engine',
            useful: 25,
            waste: 75,
            usefulLabel: 'Kinetic Energy',
            wasteLabel: 'Thermal Energy (Heat)',
            desc: 'Most energy in a car is lost as heat through the exhaust and radiator.'
         },
         bulb: {
            name: 'Incandescent Lightbulb',
            useful: 5,
            waste: 95,
            usefulLabel: 'Light Energy',
            wasteLabel: 'Thermal Energy (Heat)',
            desc: 'Incandescent bulbs are highly inefficient, converting most electricity to heat.'
         },
         motor: {
            name: 'Electric Motor',
            useful: 85,
            waste: 15,
            usefulLabel: 'Kinetic Energy',
            wasteLabel: 'Heat & Sound',
            desc: 'Electric motors are very efficient, with minimal energy lost to friction and heat.'
         }
      };

      const current = machines[machine];
      const usefulWidth = (current.useful / 100) * 200;
      const wasteWidth = (current.waste / 100) * 200;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Machine Efficiency</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Sankey Diagram Visualization</p>
               </div>
               <div className="flex gap-2">
                  {(['car', 'bulb', 'motor'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMachine(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${machine === m ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 500 400" className="w-full h-full max-w-lg">
                     <path
                        d="M 50,150 L 200,150 L 200,250 L 50,250 Z"
                        fill="#94a3b8" opacity="0.3"
                     />
                     <text x="125" y="205" textAnchor="middle" className="text-[10px] font-black fill-slate-500">INPUT ENERGY (100%)</text>

                     <path
                        d={`M 200,150 L 450,150 L 450,${150 + usefulWidth} L 200,${150 + usefulWidth} Z`}
                        fill="#10b981" className="transition-all duration-700"
                     />
                     <text x="325" y={150 + usefulWidth / 2 + 5} textAnchor="middle" className="text-[10px] font-black fill-white">
                        USEFUL: {current.useful}%
                     </text>
                     <text x="455" y={150 + usefulWidth / 2 + 5} className="text-[8px] font-bold fill-emerald-600">{current.usefulLabel}</text>

                     <path
                        d={`M 200,${150 + usefulWidth} Q 200,350 350,350 L 350,${350 + wasteWidth} Q 200,${350 + wasteWidth} 200,250 Z`}
                        fill="#ef4444" className="transition-all duration-700"
                     />
                     <text x="275" y={350 + wasteWidth / 2 + 5} textAnchor="middle" className="text-[10px] font-black fill-white">
                        WASTE: {current.waste}%
                     </text>
                     <text x="355" y={350 + wasteWidth / 2 + 5} className="text-[8px] font-bold fill-red-600">{current.wasteLabel}</text>

                     <g transform="translate(50, 50)">
                        <rect width="180" height="60" rx="12" fill="#f8fafc" stroke="#e2e8f0" strokeWidth="1" />
                        <text x="90" y="25" textAnchor="middle" className="text-[8px] font-black fill-slate-400 uppercase">Efficiency Formula</text>
                        <text x="90" y="45" textAnchor="middle" className="text-xs font-black fill-slate-900">
                           (Useful / Total) √ó 100 = {current.useful}%
                        </text>
                     </g>
                  </svg>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Machine Profile</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">
                        {current.desc}
                     </p>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        In any energy transformation, some energy is always "degraded" into less useful forms, usually <strong>thermal energy</strong> (heat). This is why machines get hot when they run!
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p className="text-[10px] font-black text-emerald-900 uppercase mb-2">Efficiency Tip</p>
                        <p className="text-[10px] text-emerald-700 leading-relaxed">
                           Higher efficiency means less energy is wasted, reducing costs and environmental impact.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- CONVECTION RENDERER (Fluid Circulation) ---
   const ConvectionRenderer = () => {
      const [isHeating, setIsHeating] = useState(false);
      const [heatPos, setHeatPos] = useState(50); // % from left
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number, temp: number }[]>([]);

      useEffect(() => {
         const initial = [];
         for (let i = 0; i < 50; i++) {
            initial.push({
               x: Math.random() * 400,
               y: Math.random() * 300,
               vx: (Math.random() - 0.5) * 2,
               vy: (Math.random() - 0.5) * 2,
               temp: 20
            });
         }
         setParticles(initial);
      }, []);

      useEffect(() => {
         let animationId: number;
         const animate = () => {
            setParticles(prev => prev.map(p => {
               let { x, y, vx, vy, temp } = p;
               const distToHeat = Math.abs(x - (heatPos * 4));
               if (isHeating && y > 250 && distToHeat < 50) {
                  temp = Math.min(100, temp + 2);
               } else {
                  temp = Math.max(20, temp - 0.1);
               }
               const buoyancy = (temp - 20) * 0.05;
               vy -= buoyancy;
               vy += 0.1;
               vx *= 0.98;
               vy *= 0.98;
               x += vx;
               y += vy;
               if (x < 0) { x = 0; vx *= -1; }
               if (x > 400) { x = 400; vx *= -1; }
               if (y < 0) { y = 0; vy *= -1; }
               if (y > 300) { y = 300; vy *= -0.5; temp -= 1; }
               const centerX = 200;
               if (temp > 50) vx += (x < centerX ? -0.1 : 0.1);
               return { x, y, vx, vy, temp };
            }));
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isHeating, heatPos]);

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Convection Currents</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Heat Transfer in Fluids</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">HEAT SOURCE POSITION</span>
                  <input
                     type="range" min="10" max="90" value={heatPos}
                     onChange={(e) => setHeatPos(parseInt(e.target.value))}
                     className="w-32 accent-red-500"
                  />
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="relative w-[400px] h-[300px] border-2 border-slate-800 rounded-xl overflow-hidden bg-slate-900/50">
                     {particles.map((p, i) => (
                        <div
                           key={i}
                           className="absolute w-3 h-3 rounded-full blur-[2px] transition-colors duration-300"
                           style={{
                              left: `${p.x}px`,
                              top: `${p.y}px`,
                              backgroundColor: `rgb(${Math.min(255, p.temp * 2.5)}, 100, ${Math.max(100, 255 - p.temp * 2)})`,
                              opacity: 0.6
                           }}
                        />
                     ))}
                     <div
                        className={`absolute bottom-0 h-4 w-20 -translate-x-1/2 rounded-t-xl transition-all duration-500 ${isHeating ? 'bg-red-500 shadow-[0_-10px_30px_rgba(239,68,68,0.5)]' : 'bg-slate-800'}`}
                        style={{ left: `${heatPos}%` }}
                     />
                  </div>
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2">
                     <button
                        onMouseDown={() => setIsHeating(true)}
                        onMouseUp={() => setIsHeating(false)}
                        onMouseLeave={() => setIsHeating(false)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-red-500 text-white scale-95' : 'bg-white text-slate-950'}`}
                     >
                        HOLD TO HEAT
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Mechanism</p>
                     <h3 className="text-2xl font-black text-white">How it Works</h3>
                     <div className="space-y-4">
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 font-black">1</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Heat source warms the fluid at the bottom.
                           </p>
                        </div>
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-400 font-black">2</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Warm fluid becomes <strong>less dense</strong> and rises.
                           </p>
                        </div>
                        <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex gap-4">
                           <div className="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-black">3</div>
                           <p className="text-[10px] text-slate-300 leading-relaxed">
                              Cooler, denser fluid sinks to take its place, creating a <strong>circulation loop</strong>.
                           </p>
                        </div>
                     </div>
                  </div>
                  <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700 mt-auto">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Real World Examples</p>
                     <ul className="text-[10px] text-slate-300 space-y-2">
                        <li>‚Ä¢ Boiling water in a pot</li>
                        <li>‚Ä¢ Atmospheric wind patterns</li>
                        <li>‚Ä¢ Tectonic plate movement (Mantle)</li>
                        <li>‚Ä¢ Ocean currents</li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SPECIFIC HEAT RENDERER (Q = mcŒîT) ---
   const SpecificHeatRenderer = () => {
      const [material, setMaterial] = useState<'water' | 'iron' | 'aluminum'>('water');
      const [mass, setMass] = useState(1); // kg
      const [isHeating, setIsHeating] = useState(false);
      const [temp, setTemp] = useState(20); // Celsius
      const [energyUsed, setEnergyUsed] = useState(0); // Joules

      const materials = {
         water: { name: 'Water', c: 4184, color: 'bg-blue-400', desc: 'High specific heat; takes a lot of energy to warm up.' },
         iron: { name: 'Iron', c: 450, color: 'bg-slate-500', desc: 'Low specific heat; warms up very quickly.' },
         aluminum: { name: 'Aluminum', c: 900, color: 'bg-slate-300', desc: 'Moderate specific heat.' }
      };

      const current = materials[material];

      useEffect(() => {
         let interval: any;
         if (isHeating) {
            interval = setInterval(() => {
               const power = 1000;
               const dt = 0.1;
               const energy = power * dt;
               setEnergyUsed(prev => prev + energy);
               setTemp(prev => {
                  const deltaT = energy / (mass * current.c);
                  return Math.min(100, prev + deltaT);
               });
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isHeating, mass, current.c]);

      const reset = () => {
         setIsHeating(false);
         setTemp(20);
         setEnergyUsed(0);
      };

      useEffect(() => {
         reset();
      }, [material]);

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Specific Heat Lab</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Q = mcŒîT</p>
               </div>
               <div className="flex gap-2">
                  {(['water', 'iron', 'aluminum'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMaterial(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${material === m ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative flex flex-col items-center">
                     <div className="absolute -left-16 bottom-20 w-8 h-48 bg-slate-100 rounded-full border-2 border-slate-200 p-1 flex flex-col justify-end">
                        <div
                           className="w-full bg-red-500 rounded-full transition-all duration-300"
                           style={{ height: `${(temp / 100) * 100}%` }}
                        />
                        <div className="absolute -top-6 left-0 w-full text-center text-[10px] font-black text-red-500">{Math.round(temp)}¬∞C</div>
                     </div>

                     <div className={`w-40 h-40 ${current.color} rounded-2xl shadow-lg border-4 border-white flex items-center justify-center relative overflow-hidden`}>
                        <div className="absolute inset-0 bg-black/10 flex items-center justify-center">
                           <span className="text-white font-black text-xl">{current.name}</span>
                        </div>
                        {material === 'water' && temp > 80 && (
                           <div className="absolute inset-0 pointer-events-none">
                              {Array.from({ length: 5 }).map((_, i) => (
                                 <div
                                    key={i}
                                    className="absolute w-2 h-2 bg-white/40 rounded-full animate-bounce"
                                    style={{ left: `${20 + i * 15}%`, bottom: '10%', animationDelay: `${i * 0.2}s` }}
                                 />
                              ))}
                           </div>
                        )}
                     </div>

                     <div className={`mt-4 w-48 h-8 rounded-xl transition-colors duration-500 ${isHeating ? 'bg-orange-500 shadow-[0_0_30px_rgba(249,115,22,0.4)]' : 'bg-slate-200'}`} />
                     <p className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">1000W Heater</p>
                  </div>

                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onMouseDown={() => setIsHeating(true)}
                        onMouseUp={() => setIsHeating(false)}
                        onMouseLeave={() => setIsHeating(false)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-orange-500 text-white scale-95' : 'bg-white text-slate-950'}`}
                     >
                        HOLD TO HEAT
                     </button>
                     <button
                        onClick={reset}
                        className="px-12 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Material Properties</p>
                     <h3 className="text-2xl font-black text-slate-900">{current.name}</h3>
                     <div className="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Specific Heat (c)</span>
                           <span className="text-sm font-black text-indigo-600">{current.c} J/kg¬∑¬∞C</span>
                        </div>
                        <div className="flex justify-between items-center">
                           <span className="text-[10px] font-bold text-slate-400 uppercase">Mass (m)</span>
                           <div className="flex items-center gap-2">
                              <input
                                 type="range" min="0.5" max="5" step="0.5" value={mass}
                                 onChange={(e) => setMass(parseFloat(e.target.value))}
                                 className="w-20 accent-indigo-600"
                              />
                              <span className="text-sm font-black text-slate-900">{mass}kg</span>
                           </div>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto grid grid-cols-1 gap-4">
                     <div className="p-6 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">Energy Consumed (Q)</p>
                        <p className="text-3xl font-black text-orange-400">{Math.round(energyUsed).toLocaleString()} J</p>
                        <p className="text-[10px] text-slate-500 mt-4 leading-relaxed">
                           {current.desc}
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LATENT HEAT RENDERER (Phase Changes) ---
   const LatentHeatRenderer = () => {
      const [isHeating, setIsHeating] = useState(false);
      const [energy, setEnergy] = useState(0); // kJ
      const [mass, setMass] = useState(1); // kg

      const cIce = 2.1;
      const Lf = 334;
      const cWater = 4.18;
      const Lv = 2260;
      const cSteam = 2.0;

      const getTemp = (q: number) => {
         let currentQ = q / mass;
         const qToMelt = (0 - (-20)) * cIce;
         if (currentQ <= qToMelt) return -20 + currentQ / cIce;
         currentQ -= qToMelt;
         if (currentQ <= Lf) return 0;
         currentQ -= Lf;
         const qToBoil = (100 - 0) * cWater;
         if (currentQ <= qToBoil) return 0 + currentQ / cWater;
         currentQ -= qToBoil;
         if (currentQ <= Lv) return 100;
         currentQ -= Lv;
         return 100 + currentQ / cSteam;
      };

      const temp = getTemp(energy);
      const phase = temp < 0 ? 'Ice' : temp === 0 && (energy / mass) < (20 * cIce + Lf) ? 'Melting' : temp < 100 ? 'Water' : temp === 100 && (energy / mass) < (20 * cIce + Lf + 100 * cWater + Lv) ? 'Boiling' : 'Steam';

      useEffect(() => {
         let interval: any;
         if (isHeating) {
            interval = setInterval(() => {
               setEnergy(prev => prev + 10);
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isHeating]);

      const reset = () => {
         setIsHeating(false);
         setEnergy(0);
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Phase Change & Latent Heat</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Heating Curve of Water</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">MASS: {mass}kg</span>
                  <input
                     type="range" min="0.5" max="2" step="0.1" value={mass}
                     onChange={(e) => setMass(parseFloat(e.target.value))}
                     className="w-24 accent-indigo-600"
                  />
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex flex-col p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="flex-1 relative">
                     <svg viewBox="0 0 500 300" className="w-full h-full">
                        <line x1="50" y1="250" x2="450" y2="250" stroke="#cbd5e1" strokeWidth="2" />
                        <line x1="50" y1="250" x2="50" y2="20" stroke="#cbd5e1" strokeWidth="2" />
                        <text x="450" y="265" textAnchor="end" className="text-[8px] font-bold fill-slate-400">ENERGY ADDED (kJ)</text>
                        <text x="45" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">TEMPERATURE (¬∞C)</text>

                        <line x1="50" y1="150" x2="450" y2="150" stroke="#f1f5f9" strokeWidth="1" strokeDasharray="4" />
                        <text x="45" y="153" textAnchor="end" className="text-[8px] font-bold fill-slate-300">0¬∞C</text>
                        <line x1="50" y1="50" x2="450" y2="50" stroke="#f1f5f9" strokeWidth="1" strokeDasharray="4" />
                        <text x="45" y="53" textAnchor="end" className="text-[8px] font-bold fill-slate-300">100¬∞C</text>

                        <path
                           d={`M 50,${250 - (getTemp(0) + 20)} ${Array.from({ length: 100 }).map((_, i) => {
                              const q = i * 40;
                              const x = 50 + (q / 4000) * 400;
                              const y = 250 - (getTemp(q) + 20);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none" stroke="#e2e8f0" strokeWidth="2"
                        />

                        <path
                           d={`M 50,${250 - (getTemp(0) + 20)} ${Array.from({ length: Math.floor(energy / 40) + 1 }).map((_, i) => {
                              const q = i * 40;
                              const x = 50 + (q / 4000) * 400;
                              const y = 250 - (getTemp(q) + 20);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none" stroke="#6366f1" strokeWidth="4" strokeLinecap="round"
                        />

                        <circle
                           cx={50 + (energy / 4000) * 400}
                           cy={250 - (temp + 20)}
                           r="6" fill="#ef4444" className="animate-pulse"
                        />
                     </svg>

                     <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex gap-4">
                        <button
                           onMouseDown={() => setIsHeating(true)}
                           onMouseUp={() => setIsHeating(false)}
                           onMouseLeave={() => setIsHeating(false)}
                           className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isHeating ? 'bg-indigo-600 text-white scale-95' : 'bg-white text-slate-950'}`}
                        >
                           HOLD TO HEAT
                        </button>
                        <button
                           onClick={reset}
                           className="px-12 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all uppercase tracking-widest"
                        >
                           RESET
                        </button>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Current State</p>
                     <div className="p-6 bg-white rounded-3xl border border-slate-200 shadow-sm flex flex-col items-center gap-2">
                        <span className="text-4xl">{phase === 'Ice' ? 'üßä' : phase === 'Melting' ? 'üíßüßä' : phase === 'Water' ? 'üíß' : phase === 'Boiling' ? 'üí®üíß' : 'üí®'}</span>
                        <h3 className="text-2xl font-black text-slate-900 uppercase">{phase}</h3>
                        <p className="text-4xl font-black text-indigo-600">{Math.round(temp)}¬∞C</p>
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        Notice the <strong>plateaus</strong> at 0¬∞C and 100¬∞C. During these times, the energy added is used to <strong>break molecular bonds</strong> (Latent Heat) rather than increasing the temperature.
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <p className="text-[10px] font-black text-indigo-900 uppercase mb-2">Energy Stats</p>
                        <div className="flex justify-between text-[10px]">
                           <span className="text-indigo-700">Total Energy:</span>
                           <span className="font-black text-indigo-900">{energy} kJ</span>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENTROPY RENDERER (Order vs Disorder) ---
   const EntropyRenderer = () => {
      const [isSimulating, setIsSimulating] = useState(false);
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number }[]>([]);
      const [entropy, setEntropy] = useState(0);

      const initParticles = () => {
         const initial = [];
         for (let i = 0; i < 100; i++) {
            initial.push({
               x: 10 + Math.random() * 80,
               y: 10 + Math.random() * 80,
               vx: (Math.random() - 0.5) * 4,
               vy: (Math.random() - 0.5) * 4
            });
         }
         setParticles(initial);
         setEntropy(0);
      };

      useEffect(() => {
         initParticles();
      }, []);

      useEffect(() => {
         let animationId: number;
         if (isSimulating) {
            const animate = () => {
               setParticles(prev => {
                  const next = prev.map(p => {
                     let { x, y, vx, vy } = p;
                     x += vx;
                     y += vy;
                     if (x < 0 || x > 390) vx *= -1;
                     if (y < 0 || y > 290) vy *= -1;
                     return { x, y, vx, vy };
                  });
                  const grid = Array(16).fill(0);
                  next.forEach(p => {
                     const col = Math.floor(p.x / 100);
                     const row = Math.floor(p.y / 75);
                     const idx = Math.min(15, row * 4 + col);
                     grid[idx]++;
                  });
                  let e = 0;
                  grid.forEach(count => {
                     if (count > 0) {
                        const p = count / 100;
                        e -= p * Math.log2(p);
                     }
                  });
                  setEntropy(e / 4);
                  return next;
               });
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isSimulating]);

      const reset = () => {
         setIsSimulating(false);
         initParticles();
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Entropy & Disorder</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">The Second Law of Thermodynamics</p>
               </div>
               <div className="flex items-center gap-4">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-500 uppercase">Entropy Level</span>
                     <span className="text-xl font-black text-emerald-400">{(entropy * 100).toFixed(1)}%</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="relative w-[400px] h-[300px] border-2 border-slate-800 rounded-xl overflow-hidden bg-slate-900/30">
                     <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 opacity-10 pointer-events-none">
                        {Array.from({ length: 16 }).map((_, i) => (
                           <div key={i} className="border border-slate-500" />
                        ))}
                     </div>
                     {particles.map((p, i) => (
                        <div
                           key={i}
                           className="absolute w-2 h-2 bg-indigo-500 rounded-full shadow-[0_0_8px_rgba(99,102,241,0.5)]"
                           style={{ left: `${p.x}px`, top: `${p.y}px` }}
                        />
                     ))}
                  </div>
                  <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsSimulating(!isSimulating)}
                        className={`px-12 py-4 rounded-2xl font-black text-sm transition-all uppercase tracking-widest shadow-2xl ${isSimulating ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-white text-slate-950'}`}
                     >
                        {isSimulating ? 'PAUSE' : 'RELEASE PARTICLES'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-12 py-4 bg-slate-800 text-slate-400 rounded-2xl font-black text-sm hover:bg-slate-700 transition-all uppercase tracking-widest"
                     >
                        RESET
                     </button>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Insight</p>
                     <h3 className="text-2xl font-black text-white">Arrow of Time</h3>
                     <p className="text-sm text-slate-400 leading-relaxed">
                        Entropy is a measure of <strong>disorder</strong> or the number of ways a system can be arranged.
                     </p>
                     <div className="p-6 bg-slate-800 rounded-3xl border border-slate-700">
                        <p className="text-xs leading-relaxed text-slate-300">
                           When particles are clumped in a corner, there are very few ways to arrange them (Low Entropy). As they spread out, the number of possible arrangements increases (High Entropy).
                        </p>
                     </div>
                  </div>
                  <div className="mt-auto p-4 bg-indigo-500/10 rounded-2xl border border-indigo-500/20">
                     <p className="text-[10px] font-black text-indigo-400 uppercase mb-2">Second Law</p>
                     <p className="text-[10px] text-slate-400 leading-relaxed">
                        In an isolated system, entropy never decreases. Systems naturally move from <strong>order</strong> to <strong>disorder</strong>.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- HEAT ENGINE RENDERER (PV Diagrams) ---
   const HeatEngineRenderer = () => {
      const [isPlaying, setIsPlaying] = useState(false);
      const [progress, setProgress] = useState(0);
      const [tempH, setTempH] = useState(500); // Kelvin
      const [tempL, setTempL] = useState(300); // Kelvin

      useEffect(() => {
         let animationId: number;
         if (isPlaying) {
            const animate = () => {
               setProgress(p => (p + 1) % 100);
               animationId = requestAnimationFrame(animate);
            };
            animationId = requestAnimationFrame(animate);
         }
         return () => cancelAnimationFrame(animationId);
      }, [isPlaying]);

      const getPV = (p: number) => {
         const vMin = 100;
         const vMax = 300;
         const gamma = 1.4;
         if (p < 25) {
            const t = p / 25;
            const v = vMin + t * 100;
            return { v, p: (tempH * 10) / v };
         } else if (p < 50) {
            const t = (p - 25) / 25;
            const vStart = 200;
            const v = vStart + t * (vMax - vStart);
            const pStart = (tempH * 10) / vStart;
            return { v, p: pStart * Math.pow(vStart / v, gamma) };
         } else if (p < 75) {
            const t = (p - 50) / 25;
            const vStart = vMax;
            const v = vStart - t * (vStart - 150);
            return { v, p: (tempL * 10) / v };
         } else {
            const t = (p - 75) / 25;
            const vStart = 150;
            const v = vStart - t * (vStart - vMin);
            const pStart = (tempL * 10) / vStart;
            return { v, p: pStart * Math.pow(vStart / v, gamma) };
         }
      };

      const current = getPV(progress);
      const efficiency = (1 - tempL / tempH) * 100;

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Heat Engine Cycle</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">PV Diagram & Efficiency</p>
               </div>
               <div className="flex items-center gap-6">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-500 uppercase">Carnot Efficiency</span>
                     <span className="text-xl font-black text-emerald-600">{efficiency.toFixed(1)}%</span>
                  </div>
                  <button
                     onClick={() => setIsPlaying(!isPlaying)}
                     className={`px-8 py-3 rounded-xl font-black text-sm transition-all shadow-lg ${isPlaying ? 'bg-red-500 text-white' : 'bg-indigo-600 text-white'}`}
                  >
                     {isPlaying ? 'STOP ENGINE' : 'START ENGINE'}
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 400 300" className="w-full h-full max-w-md">
                     <line x1="50" y1="250" x2="380" y2="250" stroke="#cbd5e1" strokeWidth="2" />
                     <line x1="50" y1="250" x2="50" y2="20" stroke="#cbd5e1" strokeWidth="2" />
                     <text x="380" y="265" textAnchor="end" className="text-[8px] font-bold fill-slate-400">VOLUME (V)</text>
                     <text x="45" y="30" textAnchor="end" className="text-[8px] font-bold fill-slate-400 rotate-90 origin-top-right">PRESSURE (P)</text>

                     <path
                        d={`M ${getPV(0).v},${250 - getPV(0).p} ${Array.from({ length: 101 }).map((_, i) => {
                           const pt = getPV(i);
                           return `L ${pt.v},${250 - pt.p}`;
                        }).join(' ')}`}
                        fill="#6366f1" fillOpacity="0.1" stroke="#6366f1" strokeWidth="2"
                     />
                     <circle cx={current.v} cy={250 - current.p} r="6" fill="#ef4444" className="transition-all duration-75" />
                     <text x="200" y="150" textAnchor="middle" className="text-[10px] font-black fill-indigo-600/40 uppercase">Work Done (W)</text>
                  </svg>

                  <div className="absolute left-10 bottom-10 w-32 h-48 border-2 border-slate-200 rounded-xl bg-slate-50 overflow-hidden">
                     <div className="absolute bottom-0 w-full bg-indigo-500/20 transition-all duration-75" style={{ height: `${(current.v / 300) * 100}%` }} />
                     <div className="absolute w-full h-4 bg-slate-800 transition-all duration-75" style={{ bottom: `${(current.v / 300) * 100}%` }} />
                     <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span className="text-[8px] font-black text-slate-400 uppercase">Cylinder</span>
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-red-500 uppercase">Hot Reservoir (TH)</span>
                           <span className="text-slate-900">{tempH} K</span>
                        </div>
                        <input
                           type="range" min="400" max="800" value={tempH}
                           onChange={(e) => setTempH(parseInt(e.target.value))}
                           className="w-full accent-red-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-blue-500 uppercase">Cold Reservoir (TL)</span>
                           <span className="text-slate-900">{tempL} K</span>
                        </div>
                        <input
                           type="range" min="200" max="350" value={tempL}
                           onChange={(e) => setTempL(parseInt(e.target.value))}
                           className="w-full accent-blue-500"
                        />
                     </div>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        A heat engine works by taking heat from a hot source, converting some of it into <strong>Work</strong>, and exhausting the rest to a cold sink.
                     </p>
                  </div>

                  <div className="mt-auto p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                     <p className="text-[10px] font-black text-emerald-900 uppercase mb-2">Efficiency Rule</p>
                     <p className="text-[10px] text-emerald-700 leading-relaxed">
                        To increase efficiency, you must either increase the temperature of the hot source or decrease the temperature of the cold sink.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LIGHT TRANSMISSION RENDERER ---
   const LightTransmissionRenderer = () => {
      const [material, setMaterial] = useState<'glass' | 'tinted' | 'metal'>('glass');
      const [thickness, setThickness] = useState(1); // 1-10
      const [wavelength, setWavelength] = useState(550); // nm (Visible range)

      const materials = {
         glass: { name: 'Clear Glass', transmission: 0.95, absorption: 0.02, reflection: 0.03, color: 'bg-blue-100/30' },
         tinted: { name: 'Tinted Glass', transmission: 0.4, absorption: 0.5, reflection: 0.1, color: 'bg-slate-800/60' },
         metal: { name: 'Polished Metal', transmission: 0, absorption: 0.1, reflection: 0.9, color: 'bg-slate-300' }
      };

      const current = materials[material];

      // Beer-Lambert Law approximation
      const effectiveTransmission = material === 'metal' ? 0 : Math.pow(current.transmission, thickness);
      const effectiveAbsorption = material === 'metal' ? 0.1 : (1 - effectiveTransmission - current.reflection);
      const effectiveReflection = current.reflection;

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight text-white">Light Transmission</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Transmission vs. Absorption vs. Reflection</p>
               </div>
               <div className="flex gap-2">
                  {(['glass', 'tinted', 'metal'] as const).map(m => (
                     <button
                        key={m}
                        onClick={() => setMaterial(m)}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${material === m ? 'bg-white text-slate-950' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {m}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox="0 0 600 400" className="w-full h-full max-w-2xl">
                     {/* Light Source */}
                     <rect x="20" y="180" width="40" height="40" rx="4" fill="#fbbf24" />
                     <path d="M 60,200 L 250,200" stroke="#fbbf24" strokeWidth="4" strokeDasharray="8 4" className="animate-[dash_2s_linear_infinite]" />

                     {/* Material Sample */}
                     <rect
                        x="250" y={200 - 50}
                        width={thickness * 10} height="100"
                        className={`${current.color} transition-all duration-500`}
                        stroke="rgba(255,255,255,0.2)"
                     />

                     {/* Transmitted Light */}
                     {effectiveTransmission > 0 && (
                        <path
                           d={`M ${250 + thickness * 10},200 L 550,200`}
                           stroke="#fbbf24"
                           strokeWidth={4 * effectiveTransmission}
                           opacity={effectiveTransmission}
                           strokeDasharray="8 4"
                           className="animate-[dash_2s_linear_infinite]"
                        />
                     )}

                     {/* Reflected Light */}
                     {effectiveReflection > 0 && (
                        <path
                           d="M 250,200 L 100,100"
                           stroke="#fbbf24"
                           strokeWidth={4 * effectiveReflection}
                           opacity={effectiveReflection}
                           strokeDasharray="8 4"
                           className="animate-[dash_2s_linear_infinite]"
                        />
                     )}

                     {/* Labels */}
                     <text x="40" y="170" className="text-[10px] font-black fill-amber-400 uppercase">Source</text>
                     <text x="300" y="320" textAnchor="middle" className="text-[10px] font-black fill-slate-500 uppercase">Material Sample</text>
                     <text x="500" y="190" textAnchor="middle" className="text-[10px] font-black fill-amber-400 uppercase">Transmitted</text>
                  </svg>

                  <style>{`
                     @keyframes dash {
                        to { stroke-dashoffset: -12; }
                     }
                  `}</style>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Thickness</span>
                           <span className="text-white">{thickness} units</span>
                        </div>
                        <input
                           type="range" min="1" max="10" step="1" value={thickness}
                           onChange={(e) => setThickness(parseInt(e.target.value))}
                           className="w-full accent-white"
                        />
                     </div>

                     <div className="p-6 bg-black/40 rounded-3xl border border-slate-800 space-y-4">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Energy Distribution</p>
                        <div className="space-y-3">
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Transmission</span>
                                 <span className="text-emerald-400">{Math.round(effectiveTransmission * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-emerald-500 transition-all duration-500" style={{ width: `${effectiveTransmission * 100}%` }} />
                              </div>
                           </div>
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Absorption</span>
                                 <span className="text-red-400">{Math.round(effectiveAbsorption * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-red-500 transition-all duration-500" style={{ width: `${effectiveAbsorption * 100}%` }} />
                              </div>
                           </div>
                           <div className="space-y-1">
                              <div className="flex justify-between text-[10px] font-bold">
                                 <span>Reflection</span>
                                 <span className="text-blue-400">{Math.round(effectiveReflection * 100)}%</span>
                              </div>
                              <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                 <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${effectiveReflection * 100}%` }} />
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-800 rounded-3xl">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        {material === 'metal'
                           ? "Metals are opaque because their free electrons reflect most light energy."
                           : "As thickness increases, transmission decreases exponentially as more photons are absorbed or scattered."}
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- LIGHT ABSORPTION RENDERER ---
   const LightAbsorptionRenderer = () => {
      const [objectColor, setObjectColor] = useState<'red' | 'green' | 'blue' | 'black' | 'white'>('red');
      const [lightColor, setLightColor] = useState<'white' | 'red' | 'green' | 'blue'>('white');
      const [isShining, setIsShining] = useState(false);
      const [temp, setTemp] = useState(20);

      const colors = {
         red: { hex: '#ef4444', absorbs: ['green', 'blue'] },
         green: { hex: '#10b981', absorbs: ['red', 'blue'] },
         blue: { hex: '#3b82f6', absorbs: ['red', 'green'] },
         black: { hex: '#18181b', absorbs: ['red', 'green', 'blue'] },
         white: { hex: '#ffffff', absorbs: [] }
      };

      const lightHex = {
         white: '#ffffff',
         red: '#ef4444',
         green: '#10b981',
         blue: '#3b82f6'
      };

      useEffect(() => {
         let interval: any;
         if (isShining) {
            interval = setInterval(() => {
               setTemp(prev => {
                  let absorptionRate = 0;
                  if (lightColor === 'white') {
                     absorptionRate = colors[objectColor].absorbs.length * 0.1;
                     if (objectColor === 'black') absorptionRate = 0.5;
                  } else {
                     const isAbsorbed = colors[objectColor].absorbs.includes(lightColor);
                     absorptionRate = isAbsorbed ? 0.3 : 0.05;
                  }
                  return Math.min(100, prev + absorptionRate);
               });
            }, 100);
         }
         return () => clearInterval(interval);
      }, [isShining, objectColor, lightColor]);

      const reflectedColor = () => {
         if (!isShining) return 'transparent';
         if (lightColor === 'white') return colors[objectColor].hex;
         const isAbsorbed = colors[objectColor].absorbs.includes(lightColor);
         return isAbsorbed ? '#111' : lightHex[lightColor];
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Light Absorption & Color</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Energy Conversion & Perception</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex flex-col items-end">
                     <span className="text-[10px] font-bold text-slate-400 uppercase">Surface Temp</span>
                     <span className="text-xl font-black text-red-600">{temp.toFixed(1)}¬∞C</span>
                  </div>
                  <button
                     onMouseDown={() => setIsShining(true)}
                     onMouseUp={() => setIsShining(false)}
                     onMouseLeave={() => setIsShining(false)}
                     className={`px-8 py-3 rounded-xl font-black text-sm transition-all shadow-lg ${isShining ? 'bg-amber-500 text-white scale-95' : 'bg-slate-900 text-white'}`}
                  >
                     SHINE LIGHT
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative flex flex-col items-center gap-12">
                     {/* Light Source */}
                     <div className="flex flex-col items-center gap-4">
                        <div className="flex gap-2">
                           {(['white', 'red', 'green', 'blue'] as const).map(c => (
                              <button
                                 key={c}
                                 onClick={() => setLightColor(c)}
                                 className={`w-8 h-8 rounded-full border-2 transition-all ${lightColor === c ? 'border-slate-900 scale-110 shadow-lg' : 'border-transparent opacity-50'}`}
                                 style={{ backgroundColor: lightHex[c] }}
                              />
                           ))}
                        </div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Light Color</p>
                     </div>

                     <div className="relative">
                        {/* Incoming Light Beam */}
                        {isShining && (
                           <div
                              className="absolute -top-32 left-1/2 -translate-x-1/2 w-8 h-32 blur-sm opacity-40 transition-all duration-300"
                              style={{
                                 background: `linear-gradient(to bottom, transparent, ${lightHex[lightColor]})`,
                                 clipPath: 'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)'
                              }}
                           />
                        )}

                        {/* Object */}
                        <div className="flex flex-col items-center gap-4">
                           <div
                              className="w-48 h-48 rounded-3xl shadow-2xl transition-all duration-500 border-4 border-white relative overflow-hidden"
                              style={{ backgroundColor: colors[objectColor].hex }}
                           >
                              {/* Heat Glow */}
                              <div
                                 className="absolute inset-0 bg-red-500 transition-opacity duration-1000"
                                 style={{ opacity: (temp - 20) / 160 }}
                              />
                           </div>
                           <div className="flex gap-2">
                              {(['red', 'green', 'blue', 'black', 'white'] as const).map(c => (
                                 <button
                                    key={c}
                                    onClick={() => { setObjectColor(c); setTemp(20); }}
                                    className={`w-6 h-6 rounded-full border-2 transition-all ${objectColor === c ? 'border-slate-900 scale-110' : 'border-transparent opacity-50'}`}
                                    style={{ backgroundColor: colors[c].hex }}
                                 />
                              ))}
                           </div>
                           <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Object Color</p>
                        </div>

                        {/* Reflected Light */}
                        {isShining && (
                           <div
                              className="absolute -top-24 -right-24 w-6 h-24 blur-md opacity-30 transition-all duration-300"
                              style={{
                                 background: `linear-gradient(to top, transparent, ${reflectedColor()})`,
                                 transform: 'rotate(45deg)'
                              }}
                           />
                        )}
                     </div>
                  </div>
               </div>

               <div className="w-full lg:w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-8">
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">The Mechanism</p>
                     <h3 className="text-2xl font-black text-slate-900">Why is it {objectColor}?</h3>
                     <p className="text-sm text-slate-600 leading-relaxed">
                        {objectColor === 'black'
                           ? "Black objects absorb almost all visible light, converting the energy into heat. This is why black clothes feel hotter in the sun!"
                           : objectColor === 'white'
                              ? "White objects reflect most visible light, absorbing very little energy and staying cooler."
                              : `A ${objectColor} object reflects ${objectColor} light and absorbs other colors like ${colors[objectColor].absorbs.join(' and ')}.`}
                     </p>
                  </div>

                  <div className="p-6 bg-slate-900 rounded-3xl text-white">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Energy Transformation</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        When light is <strong>absorbed</strong>, its electromagnetic energy is converted into <strong>thermal energy</strong> (vibrating molecules), which increases the object's temperature.
                     </p>
                  </div>

                  <div className="mt-auto space-y-4">
                     <div className="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                        <p className="text-[10px] font-black text-amber-900 uppercase mb-2">Key Concept</p>
                        <p className="text-[10px] text-amber-700 leading-relaxed">
                           The color we see is the light that was <strong>NOT</strong> absorbed by the object.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- DIGITAL SIGNAL RENDERER ---
   const DigitalSignalRenderer = () => {
      const [sampleRate, setSampleRate] = useState(10); // 2-40
      const [bitDepth, setBitDepth] = useState(4); // 1-8
      const [freq, setFreq] = useState(1); // Hz
      const [showAnalog, setShowAnalog] = useState(true);
      const [showDigital, setShowDigital] = useState(true);

      const width = 600;
      const height = 300;
      const padding = 40;

      // Generate analog wave points
      const analogPoints = Array.from({ length: 200 }, (_, i) => {
         const x = (i / 199) * (width - 2 * padding) + padding;
         const t = (i / 199) * 2 * Math.PI * freq;
         const y = Math.sin(t) * (height / 2 - padding) + height / 2;
         return { x, y };
      });

      // Generate digital samples
      const numSamples = sampleRate;
      const quantizationLevels = Math.pow(2, bitDepth);
      const digitalPoints = Array.from({ length: numSamples }, (_, i) => {
         const x = (i / (numSamples - 1)) * (width - 2 * padding) + padding;
         const t = (i / (numSamples - 1)) * 2 * Math.PI * freq;
         const rawY = Math.sin(t);

         // Quantize
         const level = Math.round(((rawY + 1) / 2) * (quantizationLevels - 1));
         const quantizedY = (level / (quantizationLevels - 1)) * 2 - 1;
         const y = quantizedY * (height / 2 - padding) + height / 2;

         return { x, y, level };
      });

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight text-white uppercase">Analog to Digital</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Sampling & Quantization</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-2">
                     <input type="checkbox" checked={showAnalog} onChange={() => setShowAnalog(!showAnalog)} className="accent-blue-500" />
                     <span className="text-[10px] font-bold uppercase text-slate-400">Analog</span>
                  </div>
                  <div className="flex items-center gap-2">
                     <input type="checkbox" checked={showDigital} onChange={() => setShowDigital(!showDigital)} className="accent-emerald-500" />
                     <span className="text-[10px] font-bold uppercase text-slate-400">Digital</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               <div className="flex-1 relative bg-black flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full max-w-2xl overflow-visible">
                     {/* Grid Lines for Quantization */}
                     {Array.from({ length: quantizationLevels }).map((_, i) => {
                        const y = (i / (quantizationLevels - 1)) * (height - 2 * padding) + padding;
                        return (
                           <line key={i} x1={padding} y1={y} x2={width - padding} y2={y} stroke="rgba(255,255,255,0.05)" strokeWidth="1" />
                        );
                     })}

                     {/* Analog Wave */}
                     {showAnalog && (
                        <path
                           d={`M ${analogPoints.map(p => `${p.x},${p.y}`).join(' L ')}`}
                           fill="none"
                           stroke="#3b82f6"
                           strokeWidth="2"
                           className="opacity-50"
                        />
                     )}

                     {/* Digital Staircase */}
                     {showDigital && (
                        <path
                           d={`M ${digitalPoints.map((p, i) => {
                              const next = digitalPoints[i + 1];
                              if (!next) return `${p.x},${p.y}`;
                              return `${p.x},${p.y} L ${next.x},${p.y}`;
                           }).join(' L ')}`}
                           fill="none"
                           stroke="#10b981"
                           strokeWidth="3"
                           strokeLinecap="round"
                        />
                     )}

                     {/* Sample Points */}
                     {showDigital && digitalPoints.map((p, i) => (
                        <circle key={i} cx={p.x} cy={p.y} r="4" fill="#10b981" />
                     ))}

                     {/* Axes */}
                     <line x1={padding} y1={height / 2} x2={width - padding} y2={height / 2} stroke="white" strokeWidth="1" opacity="0.2" />
                     <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="white" strokeWidth="1" opacity="0.2" />
                  </svg>
               </div>

               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <div className="space-y-6">
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Sample Rate</span>
                           <span className="text-emerald-400">{sampleRate} Hz</span>
                        </div>
                        <input
                           type="range" min="2" max="40" step="1" value={sampleRate}
                           onChange={(e) => setSampleRate(parseInt(e.target.value))}
                           className="w-full accent-emerald-500"
                        />
                        <p className="text-[8px] text-slate-500 italic">How often we take a "snapshot" of the wave.</p>
                     </div>

                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold">
                           <span className="text-slate-500 uppercase">Bit Depth</span>
                           <span className="text-blue-400">{bitDepth} bits ({quantizationLevels} levels)</span>
                        </div>
                        <input
                           type="range" min="1" max="8" step="1" value={bitDepth}
                           onChange={(e) => setBitDepth(parseInt(e.target.value))}
                           className="w-full accent-blue-500"
                        />
                        <p className="text-[8px] text-slate-500 italic">Precision of each snapshot (rounding to nearest level).</p>
                     </div>
                  </div>

                  <div className="p-6 bg-black/40 rounded-3xl border border-slate-800 space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Digital Error (Aliasing)</p>
                     <div className="space-y-2">
                        <p className="text-xs text-slate-400 leading-relaxed">
                           {sampleRate < freq * 4
                              ? "‚ö†Ô∏è Warning: Sample rate is too low! The digital signal is losing the true shape of the wave (Aliasing)."
                              : "The digital signal is a good approximation of the analog wave."}
                        </p>
                     </div>
                  </div>

                  <div className="mt-auto p-6 bg-slate-800 rounded-3xl">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300">
                        Digital signals are <strong>discrete</strong> approximations. Higher sample rates and bit depths create more accurate "high-fidelity" representations but require more data storage.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };
   // --- WAVE EQUATION RENDERER ---
   const WaveEquationRenderer = () => {
      const [freq, setFreq] = useState(2);
      const [wavelength, setWavelength] = useState(100);
      const [locked, setLocked] = useState<'v' | 'f' | 'l' | null>(null);
      const [medium, setMedium] = useState('custom');
      const [time, setTime] = useState(0);

      const speed = freq * wavelength;

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      const mediums = [
         { id: 'custom', name: 'Custom', speed: speed },
         { id: 'air', name: 'Air (Sound)', speed: 343 },
         { id: 'water', name: 'Water (Sound)', speed: 1480 },
         { id: 'steel', name: 'Steel (Sound)', speed: 5960 },
         { id: 'vacuum', name: 'Vacuum (Light)', speed: 300000000 },
      ];

      const handleMediumChange = (m: string) => {
         setMedium(m);
         if (m !== 'custom') {
            const targetSpeed = mediums.find(x => x.id === m)?.speed || 343;
            // Adjust wavelength to keep frequency constant
            setWavelength(targetSpeed / freq);
         }
      };

      const updateFreq = (f: number) => {
         setFreq(f);
         if (locked === 'v') {
            setWavelength(speed / f);
         }
      };

      const updateWavelength = (l: number) => {
         setWavelength(l);
         if (locked === 'v') {
            setFreq(speed / l);
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">WAVE EQUATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">v = f √ó Œª</p>
               </div>
               <div className="flex gap-2">
                  {mediums.map(m => (
                     <button
                        key={m.id}
                        onClick={() => handleMediumChange(m.id)}
                        className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${medium === m.id ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {m.name}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="100%" height="200" className="overflow-visible">
                     <defs>
                        <linearGradient id="waveGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#6366f1" />
                           <stop offset="100%" stopColor="#a855f7" />
                        </linearGradient>
                     </defs>
                     {/* Axis */}
                     <line x1="0" y1="100" x2="100%" y2="100%" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Wave Path */}
                     <path
                        d={Array.from({ length: 100 }, (_, i) => {
                           const x = (i / 100) * 800;
                           const y = 100 + Math.sin((x / (wavelength / 10)) - time * freq * 2) * 40;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="url(#waveGrad)"
                        strokeWidth="4"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                     />

                     {/* Wavelength Marker */}
                     <g transform={`translate(100, 160)`}>
                        <line x1="0" y1="0" x2={wavelength / 2} y2="0" stroke="#fbbf24" strokeWidth="2" />
                        <line x1="0" y1="-5" x2="0" y2="5" stroke="#fbbf24" strokeWidth="2" />
                        <line x1={wavelength / 2} y1="-5" x2={wavelength / 2} y2="5" stroke="#fbbf24" strokeWidth="2" />
                        <text x={wavelength / 4} y="15" textAnchor="middle" fill="#fbbf24" className="text-[10px] font-bold">Œª = {wavelength.toFixed(1)}m</text>
                     </g>
                  </svg>

                  {/* Speed Indicator */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Wave Speed (v)</p>
                     <p className="text-2xl font-black text-white tabular-nums">
                        {speed > 1000000 ? (speed / 1000000).toFixed(1) + 'M' : speed.toFixed(1)} <span className="text-xs text-slate-500">m/s</span>
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  {/* Frequency Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-center">
                        <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Frequency (f)</label>
                        <button
                           onClick={() => setLocked(locked === 'f' ? null : 'f')}
                           className={`p-1 rounded transition-colors ${locked === 'f' ? 'text-indigo-400' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                           <i className={`fa-solid ${locked === 'f' ? 'fa-lock' : 'fa-lock-open'}`}></i>
                        </button>
                     </div>
                     <input
                        type="range"
                        min="0.5"
                        max="10"
                        step="0.1"
                        value={freq}
                        onChange={(e) => updateFreq(parseFloat(e.target.value))}
                        disabled={locked === 'f'}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.5 Hz</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{freq.toFixed(1)} Hz</span>
                        <span>10 Hz</span>
                     </div>
                  </div>

                  {/* Wavelength Control */}
                  <div className="space-y-3">
                     <div className="flex justify-between items-center">
                        <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Wavelength (Œª)</label>
                        <button
                           onClick={() => setLocked(locked === 'l' ? null : 'l')}
                           className={`p-1 rounded transition-colors ${locked === 'l' ? 'text-amber-400' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                           <i className={`fa-solid ${locked === 'l' ? 'fa-lock' : 'fa-lock-open'}`}></i>
                        </button>
                     </div>
                     <input
                        type="range"
                        min="10"
                        max="500"
                        step="1"
                        value={wavelength}
                        onChange={(e) => updateWavelength(parseFloat(e.target.value))}
                        disabled={locked === 'l'}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10 m</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{wavelength.toFixed(1)} m</span>
                        <span>500 m</span>
                     </div>
                  </div>

                  {/* Lock Speed Toggle */}
                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <div className="flex items-center justify-between mb-2">
                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lock Speed (v)</span>
                        <button
                           onClick={() => setLocked(locked === 'v' ? null : 'v')}
                           className={`w-10 h-5 rounded-full relative transition-colors ${locked === 'v' ? 'bg-indigo-500' : 'bg-slate-700'}`}
                        >
                           <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${locked === 'v' ? 'left-6' : 'left-1'}`} />
                        </button>
                     </div>
                     <p className="text-[10px] text-slate-500 leading-tight">
                        When locked, changing frequency will automatically adjust wavelength to maintain the same wave speed.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Wave speed is a property of the <strong>medium</strong>. If the medium doesn't change, increasing frequency must decrease wavelength.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SUPERPOSITION RENDERER ---
   const SuperpositionRenderer = () => {
      const [wave1, setWave1] = useState({ amp: 40, freq: 2, phase: 0 });
      const [wave2, setWave2] = useState({ amp: 40, freq: 2, phase: Math.PI });
      const [showIndividual, setShowIndividual] = useState(true);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      const getWaveY = (x: number, w: { amp: number, freq: number, phase: number }) => {
         return Math.sin((x / 20) - time * w.freq + w.phase) * w.amp;
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">WAVE SUPERPOSITION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Principle of Superposition</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setShowIndividual(!showIndividual)}
                     className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${showIndividual ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                  >
                     {showIndividual ? 'Hide Components' : 'Show Components'}
                  </button>
                  <button
                     onClick={() => setWave2({ ...wave2, phase: wave2.phase === 0 ? Math.PI : 0 })}
                     className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-95"
                  >
                     Toggle Phase (180¬∞)
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="100%" height="300" className="overflow-visible">
                     {/* Grid Lines */}
                     <line x1="0" y1="150" x2="100%" y2="150%" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {showIndividual && (
                        <>
                           {/* Wave 1 */}
                           <path
                              d={Array.from({ length: 100 }, (_, i) => {
                                 const x = (i / 100) * 800;
                                 const y = 150 + getWaveY(x, wave1);
                                 return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                              }).join(' ')}
                              fill="none"
                              stroke="#6366f1"
                              strokeWidth="2"
                              strokeOpacity="0.4"
                           />
                           {/* Wave 2 */}
                           <path
                              d={Array.from({ length: 100 }, (_, i) => {
                                 const x = (i / 100) * 800;
                                 const y = 150 + getWaveY(x, wave2);
                                 return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                              }).join(' ')}
                              fill="none"
                              stroke="#ec4899"
                              strokeWidth="2"
                              strokeOpacity="0.4"
                           />
                        </>
                     )}

                     {/* Resultant Wave */}
                     <path
                        d={Array.from({ length: 100 }, (_, i) => {
                           const x = (i / 100) * 800;
                           const y = 150 + getWaveY(x, wave1) + getWaveY(x, wave2);
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#22d3ee"
                        strokeWidth="5"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className="drop-shadow-[0_0_8px_rgba(34,211,238,0.5)]"
                     />
                  </svg>

                  {/* Interference Label */}
                  <div className="absolute top-8 left-8">
                     <div className="flex items-center gap-3">
                        <div className={`w-3 h-3 rounded-full ${Math.abs(wave1.phase - wave2.phase) < 0.1 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`} />
                        <span className="text-sm font-black tracking-widest uppercase">
                           {Math.abs(wave1.phase - wave2.phase) < 0.1 ? 'Constructive' : 'Destructive'} Interference
                        </span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  {/* Wave 1 Controls */}
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Wave A (Indigo)</p>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Amplitude</span>
                           <span className="text-white">{wave1.amp}</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max="80"
                           value={wave1.amp}
                           onChange={(e) => setWave1({ ...wave1, amp: parseInt(e.target.value) })}
                           className="w-full accent-indigo-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Frequency</span>
                           <span className="text-white">{wave1.freq.toFixed(1)}</span>
                        </div>
                        <input
                           type="range"
                           min="0.5"
                           max="5"
                           step="0.1"
                           value={wave1.freq}
                           onChange={(e) => setWave1({ ...wave1, freq: parseFloat(e.target.value) })}
                           className="w-full accent-indigo-500"
                        />
                     </div>
                  </div>

                  {/* Wave 2 Controls */}
                  <div className="space-y-4">
                     <p className="text-[10px] font-black text-pink-400 uppercase tracking-widest">Wave B (Pink)</p>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Amplitude</span>
                           <span className="text-white">{wave2.amp}</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max="80"
                           value={wave2.amp}
                           onChange={(e) => setWave2({ ...wave2, amp: parseInt(e.target.value) })}
                           className="w-full accent-pink-500"
                        />
                     </div>
                     <div className="space-y-2">
                        <div className="flex justify-between text-[10px] font-bold text-slate-500">
                           <span>Phase Shift</span>
                           <span className="text-white">{(wave2.phase * 180 / Math.PI).toFixed(0)}¬∞</span>
                        </div>
                        <input
                           type="range"
                           min="0"
                           max={Math.PI * 2}
                           step="0.1"
                           value={wave2.phase}
                           onChange={(e) => setWave2({ ...wave2, phase: parseFloat(e.target.value) })}
                           className="w-full accent-pink-500"
                        />
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Waves don't bounce off each other. They <strong>pass through</strong>, and at every point, the total displacement is simply the sum of the individual waves.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- 2D WAVE INTERFERENCE RENDERER ---
   const WaveInterference2DRenderer = () => {
      const [sourceDist, setSourceDist] = useState(100);
      const [wavelength, setWavelength] = useState(40);
      const [showPathDiff, setShowPathDiff] = useState(false);
      const [probePos, setProbePos] = useState({ x: 400, y: 150 });
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      const s1 = { x: 400 - sourceDist / 2, y: 50 };
      const s2 = { x: 400 + sourceDist / 2, y: 50 };

      const d1 = Math.sqrt(Math.pow(probePos.x - s1.x, 2) + Math.pow(probePos.y - s1.y, 2));
      const d2 = Math.sqrt(Math.pow(probePos.x - s2.x, 2) + Math.pow(probePos.y - s2.y, 2));
      const pathDiff = Math.abs(d1 - d2);
      const phaseDiff = (pathDiff / wavelength) * 2 * Math.PI;

      const interference = Math.cos(phaseDiff / 2); // Amplitude factor

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">2D INTERFERENCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Two-Source Interference Pattern</p>
               </div>
               <button
                  onClick={() => setShowPathDiff(!showPathDiff)}
                  className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${showPathDiff ? 'bg-emerald-500/20 border-emerald-500 text-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
               >
                  {showPathDiff ? 'Hide Analysis' : 'Show Path Difference'}
               </button>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 overflow-hidden border-r border-slate-900 cursor-crosshair"
                  onMouseMove={(e) => {
                     const rect = e.currentTarget.getBoundingClientRect();
                     setProbePos({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                  }}
               >
                  <svg width="100%" height="100%" className="absolute inset-0">
                     <defs>
                        <radialGradient id="ripple1">
                           <stop offset="0%" stopColor="#10b981" stopOpacity="0.6" />
                           <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                        </radialGradient>
                     </defs>

                     {/* Sources */}
                     <circle cx={s1.x} cy={s1.y} r="6" fill="#10b981" className="animate-pulse" />
                     <circle cx={s2.x} cy={s2.y} r="6" fill="#10b981" className="animate-pulse" />

                     {/* Ripple Visualization (Simplified with concentric circles) */}
                     {[1, 2, 3, 4, 5].map(i => (
                        <React.Fragment key={i}>
                           <circle
                              cx={s1.x}
                              cy={s1.y}
                              r={((time * 20 + i * wavelength) % 400)}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="2"
                              strokeOpacity={Math.max(0, 1 - ((time * 20 + i * wavelength) % 400) / 400)}
                           />
                           <circle
                              cx={s2.x}
                              cy={s2.y}
                              r={((time * 20 + i * wavelength) % 400)}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="2"
                              strokeOpacity={Math.max(0, 1 - ((time * 20 + i * wavelength) % 400) / 400)}
                           />
                        </React.Fragment>
                     ))}

                     {/* Probe Lines */}
                     {showPathDiff && (
                        <>
                           <line x1={s1.x} y1={s1.y} x2={probePos.x} y2={probePos.y} stroke="#64748b" strokeWidth="1" strokeDasharray="4 4" />
                           <line x1={s2.x} y1={s2.y} x2={probePos.x} y2={probePos.y} stroke="#64748b" strokeWidth="1" strokeDasharray="4 4" />
                           <circle cx={probePos.x} cy={probePos.y} r="10" fill={Math.abs(interference) > 0.7 ? '#10b981' : '#ef4444'} fillOpacity="0.3" stroke={Math.abs(interference) > 0.7 ? '#10b981' : '#ef4444'} strokeWidth="2" />
                        </>
                     )}
                  </svg>

                  {/* Probe Info Overlay */}
                  <div className="absolute bottom-8 left-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-2">
                     <div className="flex justify-between gap-8">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Path Diff (Œîd)</span>
                        <span className="text-xs font-bold text-white">{pathDiff.toFixed(1)} px</span>
                     </div>
                     <div className="flex justify-between gap-8">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">In Wavelengths</span>
                        <span className="text-xs font-bold text-emerald-400">{(pathDiff / wavelength).toFixed(2)} Œª</span>
                     </div>
                     <div className="pt-2 border-t border-slate-800">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Interference</p>
                        <p className={`text-sm font-black ${(pathDiff / wavelength) % 1 < 0.1 || (pathDiff / wavelength) % 1 > 0.9 ? 'text-emerald-400' : Math.abs((pathDiff / wavelength) % 1 - 0.5) < 0.1 ? 'text-red-400' : 'text-white'}`}>
                           {(pathDiff / wavelength) % 1 < 0.1 || (pathDiff / wavelength) % 1 > 0.9 ? 'CONSTRUCTIVE' : Math.abs((pathDiff / wavelength) % 1 - 0.5) < 0.1 ? 'DESTRUCTIVE' : 'INTERMEDIATE'}
                        </p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Source Separation</label>
                     <input
                        type="range"
                        min="20"
                        max="300"
                        value={sourceDist}
                        onChange={(e) => setSourceDist(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Narrow</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{sourceDist} px</span>
                        <span>Wide</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="10"
                        max="100"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{wavelength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Interference depends on the <strong>Path Difference</strong>. If the difference is a whole number of wavelengths (1Œª, 2Œª...), the waves arrive in phase and add up.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- STANDING WAVE RENDERER ---
   const StandingWaveRenderer = () => {
      const [harmonic, setHarmonic] = useState(1);
      const [type, setType] = useState<'string' | 'openPipe' | 'closedPipe'>('string');
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      const getAmplitude = (x: number) => {
         const L = 600;
         if (type === 'string') {
            // Nodes at both ends: sin(nœÄx/L)
            return Math.sin((harmonic * Math.PI * x) / L);
         } else if (type === 'openPipe') {
            // Antinodes at both ends: cos(nœÄx/L)
            return Math.cos((harmonic * Math.PI * x) / L);
         } else {
            // Node at one end, antinode at other: sin((2n-1)œÄx/2L)
            return Math.sin(((2 * harmonic - 1) * Math.PI * x) / (2 * L));
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">STANDING WAVES</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Resonance & Harmonics</p>
               </div>
               <div className="flex gap-2">
                  {(['string', 'openPipe', 'closedPipe'] as const).map(t => (
                     <button
                        key={t}
                        onClick={() => { setType(t); setHarmonic(1); }}
                        className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${type === t ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                     >
                        {t === 'string' ? 'String' : t === 'openPipe' ? 'Open Pipe' : 'Closed Pipe'}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="200" className="overflow-visible">
                     {/* Boundary Markers */}
                     <line x1="0" y1="0" x2="0" y2="200" stroke={type === 'string' || type === 'closedPipe' ? '#f97316' : '#1e293b'} strokeWidth="4" />
                     <line x1="600" y1="0" x2="600" y2="200" stroke={type === 'string' ? '#f97316' : '#1e293b'} strokeWidth="4" />

                     {/* Wave Path */}
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 + amp * Math.sin(time * 5) * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="3"
                        strokeLinecap="round"
                     />

                     {/* Envelope */}
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 + amp * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="1"
                        strokeDasharray="4 4"
                        strokeOpacity="0.3"
                     />
                     <path
                        d={Array.from({ length: 101 }, (_, i) => {
                           const x = i * 6;
                           const amp = getAmplitude(x);
                           const y = 100 - amp * 60;
                           return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                        }).join(' ')}
                        fill="none"
                        stroke="#f97316"
                        strokeWidth="1"
                        strokeDasharray="4 4"
                        strokeOpacity="0.3"
                     />

                     {/* Node/Antinode Labels */}
                     {Array.from({ length: harmonic + 1 }).map((_, i) => {
                        const x = (i / harmonic) * 600;
                        const amp = getAmplitude(x);
                        const isNode = Math.abs(amp) < 0.1;
                        return (
                           <g key={i} transform={`translate(${x}, 100)`}>
                              <circle r="4" fill={isNode ? '#ef4444' : '#3b82f6'} />
                              <text y={isNode ? 20 : -20} textAnchor="middle" className="text-[10px] font-bold fill-slate-500">
                                 {isNode ? 'NODE' : 'ANTINODE'}
                              </text>
                           </g>
                        );
                     })}
                  </svg>

                  {/* Harmonic Info */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Harmonic (n)</p>
                     <p className="text-2xl font-black text-white tabular-nums">
                        {harmonic}
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Harmonic Number</label>
                     <div className="grid grid-cols-4 gap-2">
                        {[1, 2, 3, 4, 5, 6, 7, 8].map(h => (
                           <button
                              key={h}
                              onClick={() => setHarmonic(h)}
                              className={`py-2 rounded-lg text-xs font-bold transition-all ${harmonic === h ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                           >
                              {h}
                           </button>
                        ))}
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Standing waves occur when waves reflect and interfere. <strong>Nodes</strong> are points of zero motion, while <strong>Antinodes</strong> are points of maximum motion.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RESONANCE RENDERER ---
   const ResonanceRenderer = () => {
      const [driveFreq, setDriveFreq] = useState(1.0);
      const [naturalFreq, setNaturalFreq] = useState(2.0);
      const [damping, setDamping] = useState(0.1);
      const [time, setTime] = useState(0);
      const [history, setHistory] = useState<number[]>([]);

      useEffect(() => {
         const interval = setInterval(() => {
            setTime(t => t + 0.1);
         }, 30);
         return () => clearInterval(interval);
      }, []);

      // Simple damped driven oscillator approximation for visualization
      const amplitude = 1 / Math.sqrt(Math.pow(Math.pow(naturalFreq, 2) - Math.pow(driveFreq, 2), 2) + Math.pow(driveFreq * damping, 2));
      const currentPos = Math.sin(time * driveFreq * 2 * Math.PI) * amplitude * 20;

      useEffect(() => {
         setHistory(prev => [...prev.slice(-100), currentPos]);
      }, [time]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-rose-400">RESONANCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Driven Oscillations</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setDriveFreq(naturalFreq)}
                     className="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-rose-500/20 transition-all active:scale-95"
                  >
                     Match Natural Freq
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Oscillator Visual */}
                  <div className="relative h-64 w-full flex items-center justify-center">
                     {/* Spring/Support */}
                     <div className="absolute top-0 w-32 h-2 bg-slate-800 rounded-full" />
                     <svg width="40" height="200" className="absolute top-2">
                        <path
                           d={`M 20,0 ${Array.from({ length: 20 }, (_, i) => {
                              const y = (i + 1) * (100 + currentPos) / 20;
                              const x = 20 + (i % 2 === 0 ? 10 : -10);
                              return `L ${x},${y}`;
                           }).join(' ')}`}
                           fill="none"
                           stroke="#475569"
                           strokeWidth="2"
                        />
                     </svg>
                     {/* Mass */}
                     <div
                        className="absolute w-16 h-16 bg-gradient-to-br from-rose-500 to-rose-700 rounded-2xl shadow-2xl border-2 border-rose-400/50 flex items-center justify-center"
                        style={{ transform: `translateY(${currentPos}px)` }}
                     >
                        <i className="fa-solid fa-weight-hanging text-white/50 text-2xl"></i>
                     </div>
                  </div>

                  {/* Waveform History */}
                  <div className="w-full h-32 mt-8 bg-black/40 rounded-2xl border border-slate-800 overflow-hidden relative">
                     <svg width="100%" height="100%" preserveAspectRatio="none" viewBox="0 0 100 100">
                        <path
                           d={`M 0,50 ${history.map((h, i) => `L ${i},${50 + h}`).join(' ')}`}
                           fill="none"
                           stroke="#fb7185"
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-4 text-[8px] font-black text-slate-600 uppercase tracking-widest">Amplitude Response</div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-rose-400 uppercase tracking-widest">Driving Frequency (Hz)</label>
                     <input
                        type="range"
                        min="0.1"
                        max="5.0"
                        step="0.1"
                        value={driveFreq}
                        onChange={(e) => setDriveFreq(parseFloat(e.target.value))}
                        className="w-full accent-rose-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.1 Hz</span>
                        <span className="text-white bg-rose-500/20 px-2 py-0.5 rounded">{driveFreq.toFixed(1)} Hz</span>
                        <span>5.0 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Natural Frequency (Hz)</label>
                     <input
                        type="range"
                        min="0.5"
                        max="4.0"
                        step="0.1"
                        value={naturalFreq}
                        onChange={(e) => setNaturalFreq(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0.5 Hz</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{naturalFreq.toFixed(1)} Hz</span>
                        <span>4.0 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Damping (Friction)</label>
                     <input
                        type="range"
                        min="0.01"
                        max="0.5"
                        step="0.01"
                        value={damping}
                        onChange={(e) => setDamping(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Low</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{damping.toFixed(2)}</span>
                        <span>High</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-rose-500/10 rounded-3xl border border-rose-500/20">
                     <p className="text-[10px] font-bold text-rose-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Resonance happens when the <strong>Driving Frequency</strong> matches the <strong>Natural Frequency</strong>. Energy builds up, leading to massive oscillations.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DOPPLER EFFECT RENDERER ---
   const DopplerEffectRenderer = () => {
      const [sourceVel, setSourceVel] = useState(0);
      const [observerVel, setObserverVel] = useState(0);
      const [freq, setFreq] = useState(2);
      const [time, setTime] = useState(0);
      const [ripples, setRipples] = useState<{ x: number, t: number }[]>([]);

      const speedOfSound = 340;

      useEffect(() => {
         const interval = setInterval(() => {
            setTime(t => t + 0.1);
            setRipples(prev => [...prev.slice(-20), { x: (time * sourceVel) % 800, t: time }]);
         }, 50);
         return () => clearInterval(interval);
      }, [time, sourceVel]);

      const sourcePos = (time * sourceVel) % 800;
      const observerPos = 600;

      // Frequency at observer: f' = f * (v + vo) / (v - vs)
      const observedFreq = freq * (speedOfSound + observerVel) / (speedOfSound - sourceVel);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">DOPPLER EFFECT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Frequency Shift due to Motion</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => { setSourceVel(0); setObserverVel(0); }}
                     className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded-xl text-xs font-bold transition-all"
                  >
                     Reset Motion
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Road/Path */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="8 8" />

                     {/* Ripples */}
                     {ripples.map((r, i) => (
                        <circle
                           key={i}
                           cx={r.x}
                           cy="200"
                           r={(time - r.t) * speedOfSound * 0.5}
                           fill="none"
                           stroke="#3b82f6"
                           strokeWidth="2"
                           strokeOpacity={Math.max(0, 1 - (time - r.t) * 0.5)}
                        />
                     ))}

                     {/* Source (Ambulance/Car) */}
                     <g transform={`translate(${sourcePos}, 200)`}>
                        <rect x="-20" y="-10" width="40" height="20" fill="#ef4444" rx="4" />
                        <circle cx="-10" cy="10" r="4" fill="#000" />
                        <circle cx="10" cy="10" r="4" fill="#000" />
                        <text y="-20" textAnchor="middle" className="text-[10px] font-black fill-red-400">SOURCE</text>
                     </g>

                     {/* Observer */}
                     <g transform={`translate(${observerPos}, 200)`}>
                        <circle r="10" fill="#10b981" />
                        <text y="-20" textAnchor="middle" className="text-[10px] font-black fill-emerald-400">OBSERVER</text>
                     </g>
                  </svg>

                  {/* Frequency Comparison */}
                  <div className="absolute top-8 left-8 flex gap-4">
                     <div className="bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Source Freq</p>
                        <p className="text-xl font-black text-white tabular-nums">{freq.toFixed(1)} <span className="text-xs text-slate-500">Hz</span></p>
                     </div>
                     <div className="bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Observed Freq</p>
                        <p className={`text-xl font-black tabular-nums ${observedFreq > freq ? 'text-blue-400' : observedFreq < freq ? 'text-red-400' : 'text-white'}`}>
                           {observedFreq.toFixed(1)} <span className="text-xs text-slate-500">Hz</span>
                        </p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Source Velocity (vs)</label>
                     <input
                        type="range"
                        min="-200"
                        max="200"
                        value={sourceVel}
                        onChange={(e) => setSourceVel(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Away</span>
                        <span className="text-white bg-blue-500/20 px-2 py-0.5 rounded">{sourceVel} m/s</span>
                        <span>Towards</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Observer Velocity (vo)</label>
                     <input
                        type="range"
                        min="-100"
                        max="100"
                        value={observerVel}
                        onChange={(e) => setObserverVel(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Away</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{observerVel} m/s</span>
                        <span>Towards</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-blue-500/10 rounded-3xl border border-blue-500/20">
                     <p className="text-[10px] font-bold text-blue-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        When the source moves <strong>towards</strong> you, wave crests are bunched together, resulting in a <strong>higher pitch</strong>. As it moves away, they spread out.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- SNELL'S LAW RENDERER ---
   const SnellsLawRenderer = () => {
      const [n1, setN1] = useState(1.0); // Air
      const [n2, setN2] = useState(1.5); // Glass
      const [angle1, setAngle1] = useState(45); // Degrees

      const angle1Rad = (angle1 * Math.PI) / 180;
      // n1 sin Œ∏1 = n2 sin Œ∏2 => sin Œ∏2 = (n1/n2) * sin Œ∏1
      const sinTheta2 = (n1 / n2) * Math.sin(angle1Rad);
      const isTIR = sinTheta2 > 1;
      const angle2Rad = isTIR ? 0 : Math.asin(sinTheta2);
      const angle2 = (angle2Rad * 180) / Math.PI;

      const centerX = 400;
      const centerY = 200;
      const rayLength = 150;

      const x1 = centerX - Math.sin(angle1Rad) * rayLength;
      const y1 = centerY - Math.cos(angle1Rad) * rayLength;

      const x2 = centerX + Math.sin(angle2Rad) * rayLength;
      const y2 = centerY + Math.cos(angle2Rad) * rayLength;

      // Reflection ray for TIR or partial reflection
      const xr = centerX + Math.sin(angle1Rad) * rayLength;
      const yr = centerY - Math.cos(angle1Rad) * rayLength;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">SNELL'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Refraction & Index of Refraction</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => { setN1(1.0); setN2(1.5); }} className="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold">Air ‚Üí Glass</button>
                  <button onClick={() => { setN1(1.5); setN2(1.0); }} className="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold">Glass ‚Üí Air</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Mediums */}
                     <rect x="0" y="200" width="800" height="200" fill="#0ea5e9" fillOpacity="0.1" />
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#38bdf8" strokeWidth="2" />

                     {/* Normal Line */}
                     <line x1="400" y1="50" x2="400" y2="350" stroke="#475569" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Incident Ray */}
                     <line x1={x1} y1={y1} x2={centerX} y2={centerY} stroke="#fbbf24" strokeWidth="3" />
                     <circle cx={x1} cy={y1} r="4" fill="#fbbf24" />

                     {/* Refracted Ray */}
                     {!isTIR && (
                        <line x1={centerX} y1={centerY} x2={x2} y2={y2} stroke="#fbbf24" strokeWidth="3" />
                     )}

                     {/* TIR Ray */}
                     {isTIR && (
                        <line x1={centerX} y1={centerY} x2={xr} y2={yr} stroke="#f87171" strokeWidth="3" strokeDasharray="4 4" />
                     )}

                     {/* Angle Labels */}
                     <text x={centerX - 30} y={centerY - 50} textAnchor="end" className="text-[10px] font-bold fill-amber-400">Œ∏‚ÇÅ = {angle1.toFixed(1)}¬∞</text>
                     {!isTIR && (
                        <text x={centerX + 30} y={centerY + 50} textAnchor="start" className="text-[10px] font-bold fill-amber-400">Œ∏‚ÇÇ = {angle2.toFixed(1)}¬∞</text>
                     )}
                     {isTIR && (
                        <text x={centerX + 40} y={centerY - 40} textAnchor="start" className="text-[10px] font-black fill-red-500">TIR ACTIVE</text>
                     )}

                     {/* Medium Labels */}
                     <text x="20" y="180" className="text-[10px] font-black fill-slate-500 uppercase tracking-widest">Medium 1 (n={n1.toFixed(2)})</text>
                     <text x="20" y="230" className="text-[10px] font-black fill-sky-500 uppercase tracking-widest">Medium 2 (n={n2.toFixed(2)})</text>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Incident Angle (Œ∏‚ÇÅ)</label>
                     <input
                        type="range"
                        min="0"
                        max="90"
                        value={angle1}
                        onChange={(e) => setAngle1(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{angle1}¬∞</span>
                        <span>90¬∞</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Index n‚ÇÅ</label>
                     <input
                        type="range"
                        min="1.0"
                        max="2.5"
                        step="0.01"
                        value={n1}
                        onChange={(e) => setN1(parseFloat(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1.0</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{n1.toFixed(2)}</span>
                        <span>2.5</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-sky-400 uppercase tracking-widest">Index n‚ÇÇ</label>
                     <input
                        type="range"
                        min="1.0"
                        max="2.5"
                        step="0.01"
                        value={n2}
                        onChange={(e) => setN2(parseFloat(e.target.value))}
                        className="w-full accent-sky-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1.0</span>
                        <span className="text-white bg-sky-500/20 px-2 py-0.5 rounded">{n2.toFixed(2)}</span>
                        <span>2.5</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light bends <strong>towards</strong> the normal when entering a denser medium (higher n). If it enters a less dense medium at a steep enough angle, it reflects completely (TIR).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- TIR RENDERER ---
   const TIRRenderer = () => {
      const [n1, setN1] = useState(1.5); // Glass
      const [n2, setN2] = useState(1.0); // Air
      const [angle, setAngle] = useState(30);

      const criticalAngle = (Math.asin(n2 / n1) * 180) / Math.PI;
      const isTIR = angle > criticalAngle;

      const angleRad = (angle * Math.PI) / 180;
      const centerX = 400;
      const centerY = 200;

      // Incident ray
      const x1 = centerX - Math.sin(angleRad) * 150;
      const y1 = centerY + Math.cos(angleRad) * 150;

      // Refracted/Reflected ray
      let x2, y2;
      if (isTIR) {
         x2 = centerX + Math.sin(angleRad) * 150;
         y2 = centerY + Math.cos(angleRad) * 150;
      } else {
         const angle2Rad = Math.asin((n1 / n2) * Math.sin(angleRad));
         x2 = centerX + Math.sin(angle2Rad) * 150;
         y2 = centerY - Math.cos(angle2Rad) * 150;
      }

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">TOTAL INTERNAL REFLECTION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">The Critical Angle</p>
               </div>
               <div className="bg-indigo-500/20 px-4 py-2 rounded-xl border border-indigo-500/30">
                  <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Critical Angle (Œ∏c)</p>
                  <p className="text-sm font-black text-white">{criticalAngle.toFixed(1)}¬∞</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Mediums */}
                     <rect x="0" y="200" width="800" height="200" fill="#6366f1" fillOpacity="0.1" />
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#818cf8" strokeWidth="2" />

                     {/* Normal */}
                     <line x1="400" y1="50" x2="400" y2="350" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Incident Ray */}
                     <line x1={x1} y1={y1} x2={centerX} y2={centerY} stroke="#fcd34d" strokeWidth="4" />

                     {/* Output Ray */}
                     <line x1={centerX} y1={centerY} x2={x2} y2={y2} stroke={isTIR ? '#f87171' : '#fcd34d'} strokeWidth={isTIR ? 4 : 2} strokeDasharray={isTIR ? 'none' : '4 4'} />

                     {/* Labels */}
                     <text x="20" y="230" className="text-[10px] font-black fill-indigo-400 uppercase tracking-widest">Dense Medium (n={n1.toFixed(2)})</text>
                     <text x="20" y="180" className="text-[10px] font-black fill-slate-500 uppercase tracking-widest">Less Dense (n={n2.toFixed(2)})</text>

                     {isTIR && (
                        <g transform={`translate(${centerX + 50}, ${centerY + 50})`}>
                           <text className="text-sm font-black fill-red-500">TRAPPED!</text>
                        </g>
                     )}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Incident Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="90"
                        value={angle}
                        onChange={(e) => setAngle(parseInt(e.target.value))}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{angle}¬∞</span>
                        <span>90¬∞</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Condition for TIR</p>
                     <ul className="text-[10px] text-slate-500 space-y-1">
                        <li className="flex items-center gap-2">
                           <div className={`w-1.5 h-1.5 rounded-full ${n1 > n2 ? 'bg-green-500' : 'bg-red-500'}`} />
                           Dense ‚Üí Less Dense
                        </li>
                        <li className="flex items-center gap-2">
                           <div className={`w-1.5 h-1.5 rounded-full ${angle > criticalAngle ? 'bg-green-500' : 'bg-red-500'}`} />
                           Angle &gt; Critical Angle
                        </li>
                     </ul>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This is how <strong>Fiber Optics</strong> work! Light is reflected back into the glass over and over, allowing it to travel long distances without escaping.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LENS RENDERER ---
   const LensRenderer = () => {
      const [focalLength, setFocalLength] = useState(100); // Positive for converging, negative for diverging
      const [objDist, setObjDist] = useState(200);
      const [objHeight, setObjHeight] = useState(50);

      // 1/f = 1/do + 1/di => 1/di = 1/f - 1/do = (do - f) / (f * do) => di = (f * do) / (do - f)
      const imgDist = (focalLength * objDist) / (objDist - focalLength);
      const magnification = -imgDist / objDist;
      const imgHeight = objHeight * magnification;

      const centerX = 400;
      const centerY = 200;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">LENS LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Ray Tracing & Image Formation</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setFocalLength(100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength > 0 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Converging</button>
                  <button onClick={() => setFocalLength(-100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength < 0 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Diverging</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Lens */}
                     <path
                        d={focalLength > 0
                           ? "M 400,100 Q 430,200 400,300 Q 370,200 400,100"
                           : "M 390,100 Q 410,200 390,300 L 410,300 Q 390,200 410,100 Z"}
                        fill="#0ea5e9"
                        fillOpacity="0.2"
                        stroke="#0ea5e9"
                        strokeWidth="2"
                     />

                     {/* Focal Points */}
                     <circle cx={centerX - focalLength} cy="200" r="3" fill="#ef4444" />
                     <circle cx={centerX + focalLength} cy="200" r="3" fill="#ef4444" />
                     <text x={centerX - focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>
                     <text x={centerX + focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>

                     {/* Object */}
                     <line x1={centerX - objDist} y1="200" x2={centerX - objDist} y2={200 - objHeight} stroke="#fbbf24" strokeWidth="4" />
                     <path d={`M ${centerX - objDist - 5},${200 - objHeight + 10} L ${centerX - objDist},${200 - objHeight} L ${centerX - objDist + 5},${200 - objHeight + 10}`} fill="none" stroke="#fbbf24" strokeWidth="2" />

                     {/* Image */}
                     {Math.abs(objDist - focalLength) > 1 && (
                        <>
                           <line
                              x1={centerX + imgDist}
                              y1="200"
                              x2={centerX + imgDist}
                              y2={200 - imgHeight}
                              stroke="#3b82f6"
                              strokeWidth="4"
                              strokeOpacity="0.6"
                              strokeDasharray={imgDist < 0 ? "4 4" : "none"}
                           />
                           <path
                              d={`M ${centerX + imgDist - 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)} L ${centerX + imgDist},${200 - imgHeight} L ${centerX + imgDist + 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)}`}
                              fill="none"
                              stroke="#3b82f6"
                              strokeWidth="2"
                              strokeOpacity="0.6"
                           />
                        </>
                     )}

                     {/* Rays */}
                     {/* Ray 1: Parallel to axis, then through focal point */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX} y2={200 - objHeight} stroke="#475569" strokeWidth="1" />
                     <line x1={centerX} y1={200 - objHeight} x2={centerX + 400} y2={200 - objHeight + (400 * (objHeight / focalLength))} stroke="#475569" strokeWidth="1" />

                     {/* Ray 2: Through center of lens */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX + 400} y2={200 - objHeight + (400 + objDist) * (objHeight / objDist)} stroke="#475569" strokeWidth="1" />
                  </svg>

                  {/* Stats Overlay */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-3">
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Image Type</p>
                        <p className="text-sm font-black text-white">
                           {imgDist > 0 ? 'REAL' : 'VIRTUAL'} & {Math.abs(magnification) > 1 ? 'MAGNIFIED' : 'REDUCED'}
                        </p>
                     </div>
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Magnification</p>
                        <p className="text-sm font-black text-emerald-400">{magnification.toFixed(2)}x</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Object Distance (do)</label>
                     <input
                        type="range"
                        min="10"
                        max="400"
                        value={objDist}
                        onChange={(e) => setObjDist(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Close</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{objDist} px</span>
                        <span>Far</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Focal Length (f)</label>
                     <input
                        type="range"
                        min={focalLength > 0 ? 20 : -200}
                        max={focalLength > 0 ? 200 : -20}
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Real images</strong> are formed where rays actually meet (can be projected). <strong>Virtual images</strong> are where rays only <em>appear</em> to come from.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- MIRROR RENDERER ---
   const MirrorRenderer = () => {
      const [focalLength, setFocalLength] = useState(100); // Positive for concave, negative for convex
      const [objDist, setObjDist] = useState(200);
      const [objHeight, setObjHeight] = useState(50);

      // 1/f = 1/do + 1/di => 1/di = 1/f - 1/do => di = (f * do) / (do - f)
      const imgDist = (focalLength * objDist) / (objDist - focalLength);
      const magnification = -imgDist / objDist;
      const imgHeight = objHeight * magnification;

      const centerX = 400;
      const centerY = 200;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-400">MIRROR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Reflection & Image Formation</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setFocalLength(100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength > 0 ? 'bg-amber-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Concave</button>
                  <button onClick={() => setFocalLength(-100)} className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${focalLength < 0 ? 'bg-amber-500 text-white' : 'bg-slate-800 text-slate-400'}`}>Convex</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="2" strokeDasharray="4 4" />

                     {/* Mirror */}
                     <path
                        d={focalLength > 0
                           ? "M 400,100 Q 370,200 400,300"
                           : "M 400,100 Q 430,200 400,300"}
                        fill="none"
                        stroke="#94a3b8"
                        strokeWidth="8"
                        strokeLinecap="round"
                     />

                     {/* Focal Points */}
                     <circle cx={centerX - focalLength} cy="200" r="3" fill="#ef4444" />
                     <text x={centerX - focalLength} y="220" textAnchor="middle" className="text-[8px] fill-red-500 font-bold">F</text>

                     {/* Object */}
                     <line x1={centerX - objDist} y1="200" x2={centerX - objDist} y2={200 - objHeight} stroke="#fbbf24" strokeWidth="4" />
                     <path d={`M ${centerX - objDist - 5},${200 - objHeight + 10} L ${centerX - objDist},${200 - objHeight} L ${centerX - objDist + 5},${200 - objHeight + 10}`} fill="none" stroke="#fbbf24" strokeWidth="2" />

                     {/* Image */}
                     {Math.abs(objDist - focalLength) > 1 && (
                        <>
                           <line
                              x1={centerX - imgDist}
                              y1="200"
                              x2={centerX - imgDist}
                              y2={200 - imgHeight}
                              stroke="#f59e0b"
                              strokeWidth="4"
                              strokeOpacity="0.6"
                              strokeDasharray={imgDist < 0 ? "4 4" : "none"}
                           />
                           <path
                              d={`M ${centerX - imgDist - 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)} L ${centerX - imgDist},${200 - imgHeight} L ${centerX - imgDist + 5},${200 - imgHeight + (imgHeight > 0 ? 10 : -10)}`}
                              fill="none"
                              stroke="#f59e0b"
                              strokeWidth="2"
                              strokeOpacity="0.6"
                           />
                        </>
                     )}

                     {/* Rays */}
                     {/* Ray 1: Parallel to axis, then through focal point */}
                     <line x1={centerX - objDist} y1={200 - objHeight} x2={centerX} y2={200 - objHeight} stroke="#475569" strokeWidth="1" />
                     <line x1={centerX} y1={200 - objHeight} x2={centerX - 400} y2={200 - objHeight + (400 * (objHeight / focalLength))} stroke="#475569" strokeWidth="1" />
                  </svg>

                  {/* Stats Overlay */}
                  <div className="absolute top-8 right-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl space-y-3">
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Image Type</p>
                        <p className="text-sm font-black text-white">
                           {imgDist > 0 ? 'REAL' : 'VIRTUAL'} & {Math.abs(magnification) > 1 ? 'MAGNIFIED' : 'REDUCED'}
                        </p>
                     </div>
                     <div>
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Magnification</p>
                        <p className="text-sm font-black text-amber-400">{magnification.toFixed(2)}x</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Object Distance (do)</label>
                     <input
                        type="range"
                        min="10"
                        max="400"
                        value={objDist}
                        onChange={(e) => setObjDist(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Close</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{objDist} px</span>
                        <span>Far</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Focal Length (f)</label>
                     <input
                        type="range"
                        min={focalLength > 0 ? 20 : -200}
                        max={focalLength > 0 ? 200 : -20}
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-amber-500/10 rounded-3xl border border-amber-500/20">
                     <p className="text-[10px] font-bold text-amber-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Concave mirrors</strong> can form real or virtual images depending on object position. <strong>Convex mirrors</strong> always form virtual, reduced, upright images.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- POLARIZATION RENDERER ---
   const PolarizationRenderer = () => {
      const [angle1, setAngle1] = useState(0);
      const [angle2, setAngle2] = useState(90);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // Malus's Law: I = I0 * cos^2(theta)
      const relativeAngle = Math.abs(angle1 - angle2);
      const intensity = Math.pow(Math.cos((relativeAngle * Math.PI) / 180), 2);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">POLARIZATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Malus's Law & Wave Filtering</p>
               </div>
               <div className="bg-purple-500/20 px-4 py-2 rounded-xl border border-purple-500/30">
                  <p className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Light Intensity</p>
                  <p className="text-sm font-black text-white">{(intensity * 100).toFixed(0)}%</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Unpolarized Light */}
                     <g transform="translate(50, 150)">
                        {[0, 45, 90, 135].map(a => (
                           <line key={a} x1="-30" y1="0" x2="30" y2="0" stroke="#fff" strokeWidth="1" strokeOpacity="0.3" transform={`rotate(${a})`} />
                        ))}
                        <text y="50" textAnchor="middle" className="text-[8px] fill-slate-500 font-bold">UNPOLARIZED</text>
                     </g>

                     {/* Polarizer 1 */}
                     <g transform={`translate(200, 150)`}>
                        <rect x="-40" y="-60" width="80" height="120" fill="#1e293b" rx="8" stroke="#475569" />
                        {/* Slits */}
                        {Array.from({ length: 7 }).map((_, i) => (
                           <line key={i} x1="-30" y1={-45 + i * 15} x2="30" y2={-45 + i * 15} stroke="#334155" strokeWidth="2" transform={`rotate(${angle1})`} />
                        ))}
                        <text y="80" textAnchor="middle" className="text-[8px] fill-purple-400 font-bold">POLARIZER A ({angle1}¬∞)</text>
                     </g>

                     {/* Polarized Light (Between) */}
                     <g transform="translate(325, 150)">
                        <line x1="-30" y1="0" x2="30" y2="0" stroke="#a855f7" strokeWidth="3" transform={`rotate(${angle1})`} />
                        <text y="50" textAnchor="middle" className="text-[8px] fill-slate-500 font-bold">POLARIZED</text>
                     </g>

                     {/* Polarizer 2 (Analyzer) */}
                     <g transform={`translate(450, 150)`}>
                        <rect x="-40" y="-60" width="80" height="120" fill="#1e293b" rx="8" stroke="#475569" />
                        {/* Slits */}
                        {Array.from({ length: 7 }).map((_, i) => (
                           <line key={i} x1="-30" y1={-45 + i * 15} x2="30" y2={-45 + i * 15} stroke="#334155" strokeWidth="2" transform={`rotate(${angle2})`} />
                        ))}
                        <text y="80" textAnchor="middle" className="text-[8px] fill-purple-400 font-bold">ANALYZER B ({angle2}¬∞)</text>
                     </g>

                     {/* Final Light */}
                     <g transform="translate(550, 150)">
                        <circle r={20 * intensity} fill="#fff" fillOpacity={0.8} className="blur-sm" />
                        <line x1="-20" y1="0" x2="20" y2="0" stroke="#fff" strokeWidth={3 * intensity} transform={`rotate(${angle2})`} />
                     </g>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Polarizer A Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="180"
                        value={angle1}
                        onChange={(e) => setAngle1(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-purple-500/20 px-2 py-0.5 rounded">{angle1}¬∞</span>
                        <span>180¬∞</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Analyzer B Angle</label>
                     <input
                        type="range"
                        min="0"
                        max="180"
                        value={angle2}
                        onChange={(e) => setAngle2(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0¬∞</span>
                        <span className="text-white bg-purple-500/20 px-2 py-0.5 rounded">{angle2}¬∞</span>
                        <span>180¬∞</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Malus's Law</p>
                     <p className="text-[10px] font-mono text-purple-400 mb-2">I = I‚ÇÄ cos¬≤(Œ∏)</p>
                     <p className="text-[10px] text-slate-500 leading-tight">
                        When polarizers are <strong>crossed</strong> (90¬∞ apart), no light passes through.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-purple-500/10 rounded-3xl border border-purple-500/20">
                     <p className="text-[10px] font-bold text-purple-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light is a <strong>transverse wave</strong>. Polarizers act like fences that only let waves vibrating in a specific direction pass through.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DIFFRACTION RENDERER ---
   const DiffractionRenderer = () => {
      const [slitWidth, setSlitWidth] = useState(10); // micrometers
      const [wavelength, setWavelength] = useState(500); // nanometers
      const [distance, setDistance] = useState(1.0); // meters

      // Single Slit Diffraction: I(theta) = I0 * [sin(beta)/beta]^2 where beta = (pi * a * sin(theta)) / lambda
      // We'll approximate for a small range of angles
      const points = Array.from({ length: 200 }, (_, i) => {
         const x = (i - 100) / 10; // angle approximation
         const beta = (Math.PI * (slitWidth * 1e-6) * (x * 1e-3)) / (wavelength * 1e-9);
         const intensity = beta === 0 ? 1 : Math.pow(Math.sin(beta) / beta, 2);
         return { x: i, y: 100 - intensity * 80 };
      });

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">SINGLE SLIT DIFFRACTION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Wave Bending & Interference</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-2">
                     <div className="w-3 h-3 rounded-full" style={{ backgroundColor: `hsl(${(700 - wavelength) * 0.8}, 100%, 50%)` }} />
                     <span className="text-xs font-bold text-slate-400">{wavelength} nm</span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Intensity Graph */}
                  <div className="w-full h-48 bg-black/40 rounded-2xl border border-slate-800 relative overflow-hidden mb-8">
                     <svg width="100%" height="100%" viewBox="0 0 200 100" preserveAspectRatio="none">
                        <path
                           d={`M ${points.map(p => `${p.x},${p.y}`).join(' L ')}`}
                           fill="none"
                           stroke={`hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`}
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-4 text-[8px] font-black text-slate-600 uppercase tracking-widest">Intensity Pattern</div>
                  </div>

                  {/* Visual Pattern */}
                  <div className="w-full h-12 rounded-lg relative overflow-hidden shadow-2xl shadow-orange-500/10">
                     <div
                        className="absolute inset-0"
                        style={{
                           background: `radial-gradient(circle at center, hsl(${(700 - wavelength) * 0.8}, 100%, 50%) 0%, transparent 70%)`,
                           backgroundSize: `${200 / (slitWidth / 5)}px 100%`,
                           opacity: 0.8
                        }}
                     />
                  </div>
                  <p className="mt-4 text-[8px] font-black text-slate-500 uppercase tracking-widest">Projected Fringe Pattern</p>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Slit Width (a)</label>
                     <input
                        type="range"
                        min="2"
                        max="50"
                        value={slitWidth}
                        onChange={(e) => setSlitWidth(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Narrow</span>
                        <span className="text-white bg-orange-500/20 px-2 py-0.5 rounded">{slitWidth} Œºm</span>
                        <span>Wide</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="380"
                        max="750"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Violet</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>Red</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        The <strong>narrower</strong> the slit, the <strong>wider</strong> the diffraction pattern. This proves light behaves as a wave, spreading out when it passes through small openings.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- DISPERSION RENDERER ---
   const DispersionRenderer = () => {
      const [prismAngle, setPrismAngle] = useState(60);
      const [incidentAngle, setIncidentAngle] = useState(45);

      const colors = [
         { name: 'Red', wavelength: 700, n: 1.51 },
         { name: 'Orange', wavelength: 600, n: 1.52 },
         { name: 'Yellow', wavelength: 580, n: 1.53 },
         { name: 'Green', wavelength: 530, n: 1.54 },
         { name: 'Blue', wavelength: 470, n: 1.55 },
         { name: 'Violet', wavelength: 400, n: 1.56 },
      ];

      const centerX = 400;
      const centerY = 200;
      const prismSize = 150;

      // Prism vertices
      const p1 = { x: centerX, y: centerY - prismSize * 0.6 };
      const p2 = { x: centerX - prismSize * 0.5, y: centerY + prismSize * 0.4 };
      const p3 = { x: centerX + prismSize * 0.5, y: centerY + prismSize * 0.4 };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-pink-400">PRISM DISPERSION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Refractive Index & Wavelength</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Prism */}
                     <path d={`M ${p1.x},${p1.y} L ${p2.x},${p2.y} L ${p3.x},${p3.y} Z`} fill="#0ea5e9" fillOpacity="0.1" stroke="#0ea5e9" strokeWidth="2" />

                     {/* Incident White Light */}
                     <line x1="100" y1={centerY} x2={centerX - prismSize * 0.3} y2={centerY} stroke="#fff" strokeWidth="4" strokeOpacity="0.8" />
                     <text x="100" y={centerY - 10} className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">White Light</text>

                     {/* Dispersed Rays (Simplified Visualization) */}
                     {colors.map((c, i) => {
                        const offset = i * 4;
                        const angle = (i - 2.5) * 2;
                        return (
                           <g key={c.name}>
                              {/* Ray inside prism */}
                              <line
                                 x1={centerX - prismSize * 0.3}
                                 y1={centerY}
                                 x2={centerX + prismSize * 0.2}
                                 y2={centerY + offset}
                                 stroke={`hsl(${(700 - c.wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="1"
                                 strokeOpacity="0.5"
                              />
                              {/* Ray exiting prism */}
                              <line
                                 x1={centerX + prismSize * 0.2}
                                 y1={centerY + offset}
                                 x2={centerX + 300}
                                 y2={centerY + offset + 50 + i * 10}
                                 stroke={`hsl(${(700 - c.wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="2"
                              />
                           </g>
                        );
                     })}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-pink-400 uppercase tracking-widest">Prism Material</label>
                     <div className="grid grid-cols-2 gap-2">
                        <button className="px-3 py-2 bg-pink-500 text-white rounded-xl text-[10px] font-bold">Crown Glass</button>
                        <button className="px-3 py-2 bg-slate-800 text-slate-400 rounded-xl text-[10px] font-bold">Flint Glass</button>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Refractive Index (n)</p>
                     <div className="space-y-2">
                        {colors.filter((_, i) => i % 2 === 0).map(c => (
                           <div key={c.name} className="flex justify-between items-center">
                              <span className="text-[10px] font-bold text-slate-500">{c.name}</span>
                              <span className="text-[10px] font-mono text-white">{c.n}</span>
                           </div>
                        ))}
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-pink-500/10 rounded-3xl border border-pink-500/20">
                     <p className="text-[10px] font-bold text-pink-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Different colors of light have different <strong>wavelengths</strong>. Shorter wavelengths (Violet) slow down more and bend more than longer wavelengths (Red).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- THIN FILM RENDERER ---
   const ThinFilmRenderer = () => {
      const [thickness, setThickness] = useState(200); // nanometers
      const [nFilm, setNFilm] = useState(1.33); // Water/Oil
      const [wavelength, setWavelength] = useState(500);

      // Constructive interference: 2nt = (m + 1/2)lambda (if one phase shift)
      // or 2nt = m*lambda (if zero or two phase shifts)
      // For oil on water (n1=1 < n2=1.5 > n3=1.33), one phase shift at top.
      const phaseShift = 0.5;
      const m = Math.floor((2 * nFilm * thickness) / wavelength - phaseShift);
      const isConstructive = Math.abs((2 * nFilm * thickness) / wavelength - (m + phaseShift)) < 0.1;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-teal-400">THIN FILM INTERFERENCE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Oil Slicks & Soap Bubbles</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Film Visual */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     {/* Top Layer (Air) */}
                     <div className="absolute top-0 w-full h-20 bg-slate-900/20 border-b border-slate-700 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Air (n=1.0)</span>
                     </div>
                     {/* Film Layer */}
                     <div
                        className="absolute w-full border-y border-teal-500/30 transition-all duration-300"
                        style={{
                           height: `${thickness / 2}px`,
                           backgroundColor: `hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`,
                           opacity: isConstructive ? 0.6 : 0.1,
                           boxShadow: isConstructive ? `0 0 40px hsl(${(700 - wavelength) * 0.8}, 100%, 50%, 0.3)` : 'none'
                        }}
                     >
                        <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent" />
                     </div>
                     {/* Bottom Layer (Substrate) */}
                     <div className="absolute bottom-0 w-full h-20 bg-slate-800/40 border-t border-slate-700 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Substrate (n=1.5)</span>
                     </div>

                     {/* Rays */}
                     <svg className="absolute inset-0 w-full h-full overflow-visible">
                        <path d="M 50,50 L 128,120 L 200,50" fill="none" stroke="#fff" strokeWidth="2" strokeOpacity="0.5" />
                        <path d="M 128,120 L 128,160 L 200,90" fill="none" stroke="#fff" strokeWidth="2" strokeOpacity="0.3" strokeDasharray="4 4" />
                     </svg>
                  </div>

                  <div className="mt-8 text-center">
                     <p className={`text-sm font-black ${isConstructive ? 'text-teal-400' : 'text-slate-600'}`}>
                        {isConstructive ? 'CONSTRUCTIVE INTERFERENCE' : 'DESTRUCTIVE INTERFERENCE'}
                     </p>
                     <p className="text-[10px] text-slate-500 mt-1">at {wavelength} nm</p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-teal-400 uppercase tracking-widest">Film Thickness (t)</label>
                     <input
                        type="range"
                        min="50"
                        max="500"
                        value={thickness}
                        onChange={(e) => setThickness(parseInt(e.target.value))}
                        className="w-full accent-teal-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>50 nm</span>
                        <span className="text-white bg-teal-500/20 px-2 py-0.5 rounded">{thickness} nm</span>
                        <span>500 nm</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="380"
                        max="750"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Violet</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>Red</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-teal-500/10 rounded-3xl border border-teal-500/20">
                     <p className="text-[10px] font-bold text-teal-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Light reflects off both the <strong>top</strong> and <strong>bottom</strong> of the film. If these two reflections line up (constructive), that color becomes vivid.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RAY TRACING LAB RENDERER ---
   const RayTracingLabRenderer = () => {
      const [sourcePos, setSourcePos] = useState({ x: 100, y: 200 });
      const [focalLength, setFocalLength] = useState(100);
      const [numRays, setNumRays] = useState(5);

      const centerX = 400;
      const centerY = 200;

      const rays = Array.from({ length: numRays }, (_, i) => {
         const angle = (i - (numRays - 1) / 2) * 10; // degrees
         const angleRad = (angle * Math.PI) / 180;

         // Ray from source to lens plane (x = centerX)
         const dx = centerX - sourcePos.x;
         const dy = dx * Math.tan(angleRad);
         const hitY = sourcePos.y + dy;

         // Ray after lens
         // Using lens maker/ray transfer matrix logic simplified
         // For a thin lens: y2 = y1, theta2 = theta1 - y1/f
         const theta1 = angleRad;
         const y1 = hitY - centerY;
         const theta2 = theta1 - y1 / focalLength;

         const xEnd = centerX + 400;
         const yEnd = centerY + y1 + (400 * Math.tan(theta2));

         return { hitY, xEnd, yEnd };
      });

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">RAY TRACING LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multi-Ray Optics Sandbox</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="800" height="400" className="overflow-visible">
                     {/* Optical Axis */}
                     <line x1="0" y1="200" x2="800" y2="200" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />

                     {/* Lens */}
                     <line x1={centerX} y1="50" x2={centerX} y2="350" stroke="#0ea5e9" strokeWidth="4" strokeOpacity="0.3" />
                     <text x={centerX} y="40" textAnchor="middle" className="text-[8px] font-black fill-sky-500 uppercase tracking-widest">Lens Plane</text>

                     {/* Rays */}
                     {rays.map((r, i) => (
                        <g key={i}>
                           <line x1={sourcePos.x} y1={sourcePos.y} x2={centerX} y2={r.hitY} stroke="#fbbf24" strokeWidth="1" strokeOpacity="0.4" />
                           <line x1={centerX} y1={r.hitY} x2={r.xEnd} y2={r.yEnd} stroke="#fbbf24" strokeWidth="1.5" strokeOpacity="0.8" />
                        </g>
                     ))}

                     {/* Light Source */}
                     <g
                        transform={`translate(${sourcePos.x}, ${sourcePos.y})`}
                        className="cursor-move"
                        onMouseDown={(e) => {
                           const svg = e.currentTarget.ownerSVGElement;
                           const move = (moveEvent: MouseEvent) => {
                              const pt = svg!.createSVGPoint();
                              pt.x = moveEvent.clientX;
                              pt.y = moveEvent.clientY;
                              const transformed = pt.matrixTransform(svg!.getScreenCTM()!.inverse());
                              setSourcePos({ x: Math.max(50, Math.min(centerX - 20, transformed.x)), y: transformed.y });
                           };
                           const up = () => {
                              window.removeEventListener('mousemove', move);
                              window.removeEventListener('mouseup', up);
                           };
                           window.addEventListener('mousemove', move);
                           window.addEventListener('mouseup', up);
                        }}
                     >
                        <circle r="12" fill="#fbbf24" className="animate-pulse" />
                        <circle r="6" fill="#fff" />
                        <text y="-20" textAnchor="middle" className="text-[8px] font-black fill-amber-400 uppercase tracking-widest">Source (Drag Me)</text>
                     </g>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-sky-400 uppercase tracking-widest">Focal Length</label>
                     <input
                        type="range"
                        min="50"
                        max="300"
                        value={focalLength}
                        onChange={(e) => setFocalLength(parseInt(e.target.value))}
                        className="w-full accent-sky-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Short</span>
                        <span className="text-white bg-sky-500/20 px-2 py-0.5 rounded">{focalLength} px</span>
                        <span>Long</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Number of Rays</label>
                     <input
                        type="range"
                        min="1"
                        max="21"
                        step="2"
                        value={numRays}
                        onChange={(e) => setNumRays(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{numRays}</span>
                        <span>21</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-blue-500/10 rounded-3xl border border-blue-500/20">
                     <p className="text-[10px] font-bold text-blue-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Notice how all rays from a single point on the source <strong>converge</strong> to a single point on the other side. This is how a clear image is formed!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- WAVE-PARTICLE DUALITY RENDERER ---
   const WaveParticleDualityRenderer = () => {
      const [mode, setMode] = useState<'wave' | 'particle'>('wave');
      const [intensity, setIntensity] = useState(50);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">WAVE-PARTICLE DUALITY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Quantum Mechanics & The Double Slit</p>
               </div>
               <div className="flex bg-slate-800 p-1 rounded-xl border border-slate-700">
                  <button
                     onClick={() => setMode('wave')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${mode === 'wave' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     WAVE
                  </button>
                  <button
                     onClick={() => setMode('particle')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${mode === 'particle' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     PARTICLE
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Slit Wall */}
                     <rect x="200" y="0" width="10" height="120" fill="#1e293b" />
                     <rect x="200" y="140" width="10" height="20" fill="#1e293b" />
                     <rect x="200" y="180" width="10" height="120" fill="#1e293b" />

                     {/* Source */}
                     <g transform="translate(50, 150)">
                        <circle r="10" fill="#06b6d4" className="animate-pulse" />
                        <text y="30" textAnchor="middle" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Electron Gun</text>
                     </g>

                     {/* Visualization */}
                     {mode === 'wave' ? (
                        <g>
                           {/* Interference Pattern */}
                           {Array.from({ length: 10 }).map((_, i) => (
                              <circle
                                 key={i}
                                 cx="205"
                                 cy="130"
                                 r={(time * 50 + i * 40) % 400}
                                 fill="none"
                                 stroke="#06b6d4"
                                 strokeWidth="1"
                                 strokeOpacity={Math.max(0, 1 - ((time * 50 + i * 40) % 400) / 400)}
                              />
                           ))}
                           {Array.from({ length: 10 }).map((_, i) => (
                              <circle
                                 key={i + 10}
                                 cx="205"
                                 cy="170"
                                 r={(time * 50 + i * 40) % 400}
                                 fill="none"
                                 stroke="#06b6d4"
                                 strokeWidth="1"
                                 strokeOpacity={Math.max(0, 1 - ((time * 50 + i * 40) % 400) / 400)}
                              />
                           ))}
                           {/* Screen Pattern */}
                           <rect x="550" y="0" width="20" height="300" fill="url(#interference-gradient)" />
                        </g>
                     ) : (
                        <g>
                           {/* Particles */}
                           {Array.from({ length: 20 }).map((_, i) => {
                              const t = (time + i * 0.5) % 4;
                              const x = 50 + t * 125;
                              const isTop = (i % 2 === 0);
                              const y = isTop ? 130 : 170;
                              return (
                                 <circle key={i} cx={x} cy={y} r="3" fill="#06b6d4" fillOpacity={x > 200 ? 1 : 0.2} />
                              );
                           })}
                           {/* Screen Pattern */}
                           <rect x="550" y="110" width="20" height="40" fill="#06b6d4" fillOpacity="0.8" />
                           <rect x="550" y="150" width="20" height="40" fill="#06b6d4" fillOpacity="0.8" />
                        </g>
                     )}

                     <defs>
                        <linearGradient id="interference-gradient" x1="0" y1="0" x2="0" y2="1">
                           <stop offset="0%" stopColor="transparent" />
                           <stop offset="20%" stopColor="#06b6d4" />
                           <stop offset="30%" stopColor="transparent" />
                           <stop offset="50%" stopColor="#06b6d4" />
                           <stop offset="70%" stopColor="transparent" />
                           <stop offset="80%" stopColor="#06b6d4" />
                           <stop offset="100%" stopColor="transparent" />
                        </linearGradient>
                     </defs>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-cyan-400 uppercase tracking-widest">Observation Mode</label>
                     <p className="text-[10px] text-slate-500 leading-relaxed">
                        {mode === 'wave'
                           ? "When unobserved, electrons travel as probability waves, interfering with themselves."
                           : "When we 'watch' which slit the electron goes through, the wave function collapses into a particle."}
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-cyan-500/10 rounded-3xl border border-cyan-500/20">
                     <p className="text-[10px] font-bold text-cyan-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This is the heart of <strong>Quantum Mechanics</strong>. Matter is neither just a wave nor just a particle‚Äîit's both, until we measure it!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- PHOTOELECTRIC EFFECT RENDERER ---
   const PhotoelectricEffectRenderer = () => {
      const [wavelength, setWavelength] = useState(400); // nm
      const [intensity, setIntensity] = useState(50);
      const [workFunction, setWorkFunction] = useState(2.3); // eV (Sodium)
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // E = hf = hc/lambda
      const h = 4.1357e-15; // eV*s
      const c = 3e8; // m/s
      const photonEnergy = (h * c) / (wavelength * 1e-9);
      const maxKE = Math.max(0, photonEnergy - workFunction);
      const electronSpeed = Math.sqrt(maxKE) * 20; // scaled for visualization

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-400">PHOTOELECTRIC EFFECT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Photons & Electron Emission</p>
               </div>
               <div className="bg-amber-500/20 px-4 py-2 rounded-xl border border-amber-500/30">
                  <p className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Max Electron KE</p>
                  <p className="text-sm font-black text-white">{maxKE.toFixed(2)} eV</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Metal Plate */}
                     <rect x="400" y="50" width="20" height="200" fill="#475569" rx="4" />
                     <text x="410" y="270" textAnchor="middle" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Metal Plate</text>

                     {/* Photons */}
                     {Array.from({ length: Math.floor(intensity / 10) }).map((_, i) => {
                        const t = (time + i * 0.8) % 3;
                        const x = 50 + t * 115;
                        const y = 100 + i * 20;
                        return (
                           <g key={i} transform={`translate(${x}, ${y})`}>
                              <path
                                 d="M 0,0 Q 5,-5 10,0 Q 15,5 20,0"
                                 fill="none"
                                 stroke={`hsl(${(700 - wavelength) * 0.8}, 100%, 50%)`}
                                 strokeWidth="2"
                              />
                              <circle r="2" fill="#fff" />
                           </g>
                        );
                     })}

                     {/* Electrons */}
                     {maxKE > 0 && Array.from({ length: Math.floor(intensity / 10) }).map((_, i) => {
                        const t = (time + i * 0.8) % 3;
                        if (t < 1.5) return null;
                        const x = 420 + (t - 1.5) * electronSpeed * 10;
                        const y = 100 + i * 20;
                        return (
                           <circle key={`e-${i}`} cx={x} cy={y} r="3" fill="#38bdf8" className="animate-pulse" />
                        );
                     })}
                  </svg>

                  {/* Energy Chart Overlay */}
                  <div className="absolute bottom-8 left-8 bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-2xl">
                     <div className="flex items-end gap-2 h-24">
                        <div className="w-8 bg-amber-500/40 rounded-t-lg" style={{ height: `${photonEnergy * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-amber-400">PHOTON</p>
                        </div>
                        <div className="w-8 bg-slate-700 rounded-t-lg" style={{ height: `${workFunction * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-slate-400">WORK FN</p>
                        </div>
                        <div className="w-8 bg-sky-500/40 rounded-t-lg" style={{ height: `${maxKE * 20}px` }}>
                           <p className="text-[8px] -rotate-90 origin-left translate-x-4 -translate-y-2 font-black text-sky-400">KE MAX</p>
                        </div>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-amber-400 uppercase tracking-widest">Light Wavelength (Œª)</label>
                     <input
                        type="range"
                        min="200"
                        max="800"
                        value={wavelength}
                        onChange={(e) => setWavelength(parseInt(e.target.value))}
                        className="w-full accent-amber-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>UV</span>
                        <span className="text-white bg-amber-500/20 px-2 py-0.5 rounded">{wavelength} nm</span>
                        <span>IR</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Metal Work Function (Œ¶)</label>
                     <select
                        value={workFunction}
                        onChange={(e) => setWorkFunction(parseFloat(e.target.value))}
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-xs font-bold text-white outline-none focus:ring-2 focus:ring-amber-500/50"
                     >
                        <option value="2.3">Sodium (2.3 eV)</option>
                        <option value="4.3">Zinc (4.3 eV)</option>
                        <option value="4.7">Copper (4.7 eV)</option>
                        <option value="5.1">Platinum (5.1 eV)</option>
                     </select>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-amber-500/10 rounded-3xl border border-amber-500/20">
                     <p className="text-[10px] font-bold text-amber-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Increasing <strong>intensity</strong> (brightness) only ejects <em>more</em> electrons, but increasing <strong>frequency</strong> (shorter Œª) makes them fly <em>faster</em>.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LASER RENDERER ---
   const LaserRenderer = () => {
      const [isPumping, setIsPumping] = useState(false);
      const [atoms, setAtoms] = useState<{ id: number, state: 'ground' | 'excited', x: number, y: number }[]>(
         Array.from({ length: 20 }, (_, i) => ({
            id: i,
            state: 'ground',
            x: 50 + Math.random() * 300,
            y: 50 + Math.random() * 200
         }))
      );
      const [photons, setPhotons] = useState<{ id: number, x: number, y: number, direction: 1 | -1 }[]>([]);

      useEffect(() => {
         const interval = setInterval(() => {
            if (isPumping) {
               setAtoms(prev => prev.map(a => Math.random() > 0.9 ? { ...a, state: 'excited' } : a));
            } else {
               setAtoms(prev => prev.map(a => Math.random() > 0.98 ? { ...a, state: 'ground' } : a));
            }

            // Move photons
            setPhotons(prev => prev.map(p => ({ ...p, x: p.x + p.direction * 10 })).filter(p => p.x > 0 && p.x < 400));

            // Stimulated emission logic
            setAtoms(prev => {
               const nextAtoms = [...prev];
               setPhotons(prevPhotons => {
                  const nextPhotons = [...prevPhotons];
                  prevPhotons.forEach(p => {
                     nextAtoms.forEach((a, idx) => {
                        if (a.state === 'excited' && Math.abs(a.x - p.x) < 20 && Math.abs(a.y - p.y) < 20) {
                           nextAtoms[idx] = { ...a, state: 'ground' };
                           nextPhotons.push({ id: Math.random(), x: a.x, y: a.y, direction: p.direction });
                        }
                     });
                  });
                  return nextPhotons;
               });
               return nextAtoms;
            });
         }, 50);
         return () => clearInterval(interval);
      }, [isPumping]);

      const excitedCount = atoms.filter(a => a.state === 'excited').length;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-rose-400">LASER PHYSICS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Stimulated Emission & Pumping</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onMouseDown={() => setIsPumping(true)}
                     onMouseUp={() => setIsPumping(false)}
                     onMouseLeave={() => setIsPumping(false)}
                     className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isPumping ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/40 scale-95' : 'bg-slate-800 text-slate-400 hover:text-white'}`}
                  >
                     HOLD TO PUMP ENERGY
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative w-[400px] h-[300px] border-x-4 border-slate-700 bg-slate-900/20 rounded-lg">
                     {/* Mirrors */}
                     <div className="absolute -left-1 top-0 bottom-0 w-1 bg-slate-400 opacity-80 shadow-[0_0_15px_rgba(255,255,255,0.3)]" />
                     <div className="absolute -right-1 top-0 bottom-0 w-1 bg-slate-400 opacity-40" />

                     {/* Atoms */}
                     {atoms.map(a => (
                        <div
                           key={a.id}
                           className={`absolute w-4 h-4 rounded-full transition-colors duration-300 ${a.state === 'excited' ? 'bg-rose-500 shadow-[0_0_10px_#f43f5e]' : 'bg-slate-700'}`}
                           style={{ left: a.x, top: a.y }}
                        />
                     ))}

                     {/* Photons */}
                     {photons.map(p => (
                        <div
                           key={p.id}
                           className="absolute w-2 h-0.5 bg-rose-400 shadow-[0_0_8px_#fb7185]"
                           style={{ left: p.x, top: p.y }}
                        />
                     ))}

                     {/* Laser Beam (if many photons) */}
                     {photons.length > 15 && (
                        <div className="absolute right-[-200px] top-0 bottom-0 flex items-center">
                           <div className="h-2 w-[200px] bg-rose-500 shadow-[0_0_20px_#f43f5e] opacity-80" />
                        </div>
                     )}
                  </div>

                  <div className="mt-8 flex gap-8">
                     <div className="text-center">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Excited Atoms</p>
                        <p className="text-xl font-black text-rose-400">{excitedCount} / 20</p>
                     </div>
                     <div className="text-center">
                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Photon Count</p>
                        <p className="text-xl font-black text-white">{photons.length}</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-rose-400 uppercase tracking-widest">Population Inversion</label>
                     <p className="text-[10px] text-slate-500 leading-relaxed">
                        To create a laser, we need more atoms in the <strong>excited state</strong> than the ground state. This is called population inversion.
                     </p>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Laser Acronym</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        <strong>L</strong>ight <strong>A</strong>mplification by <strong>S</strong>timulated <strong>E</strong>mission of <strong>R</strong>adiation.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-rose-500/10 rounded-3xl border border-rose-500/20">
                     <p className="text-[10px] font-bold text-rose-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        One photon hits an excited atom, causing it to drop to ground state and release a <strong>second identical photon</strong>. This chain reaction creates the beam!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ACOUSTIC LEVITATION RENDERER ---
   const AcousticLevitationRenderer = () => {
      const [freq, setFreq] = useState(40); // kHz
      const [amplitude, setAmplitude] = useState(80);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.1), 30);
         return () => clearInterval(interval);
      }, []);

      // Nodes are at intervals of lambda/2
      // lambda = v/f. v = 343 m/s. f = 40kHz => lambda = 8.5mm
      const nodes = [60, 120, 180, 240];

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">ACOUSTIC LEVITATION</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Standing Waves & Radiation Pressure</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative w-48 h-[300px] flex flex-col items-center">
                     {/* Transducers */}
                     <div className="w-full h-8 bg-slate-800 rounded-t-2xl border-b-4 border-emerald-500/50 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-500">TRANSDUCER TOP</span>
                     </div>

                     <div className="flex-1 w-full relative bg-emerald-500/5 flex items-center justify-center overflow-hidden">
                        {/* Standing Wave Visualization */}
                        <svg className="absolute inset-0 w-full h-full">
                           {Array.from({ length: 40 }).map((_, i) => {
                              const y = i * 7.5;
                              const wave = Math.sin(y * 0.1 + time) * (amplitude / 4);
                              return (
                                 <line
                                    key={i}
                                    x1={24 - wave}
                                    y1={y}
                                    x2={168 + wave}
                                    y2={y}
                                    stroke="#10b981"
                                    strokeWidth="1"
                                    strokeOpacity="0.1"
                                 />
                              );
                           })}
                        </svg>

                        {/* Levitating Particles */}
                        {nodes.map((nodeY, i) => (
                           <div
                              key={i}
                              className="absolute w-4 h-4 bg-white rounded-full shadow-[0_0_15px_rgba(255,255,255,0.8)] blur-[1px]"
                              style={{
                                 top: nodeY + Math.sin(time * 2) * 2,
                                 left: '50%',
                                 transform: 'translateX(-50%)',
                                 opacity: amplitude > 50 ? 1 : 0.2
                              }}
                           />
                        ))}
                     </div>

                     <div className="w-full h-8 bg-slate-800 rounded-b-2xl border-t-4 border-emerald-500/50 flex items-center justify-center">
                        <span className="text-[8px] font-black text-slate-500">TRANSDUCER BOTTOM</span>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Acoustic Amplitude</label>
                     <input
                        type="range"
                        min="0"
                        max="100"
                        value={amplitude}
                        onChange={(e) => setAmplitude(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Off</span>
                        <span className="text-white bg-emerald-500/20 px-2 py-0.5 rounded">{amplitude}%</span>
                        <span>Max</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Physics</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        Sound waves create <strong>pressure</strong>. In a standing wave, particles are pushed toward the <strong>nodes</strong> (points of zero movement) where they stay suspended.
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        This isn't magic‚Äîit's <strong>Radiation Pressure</strong>! We can use sound to manipulate matter without ever touching it.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- FIBER OPTICS RENDERER ---
   const FiberOpticsRenderer = () => {
      const [incidentAngle, setIncidentAngle] = useState(20);
      const [fiberCurvature, setFiberCurvature] = useState(0);
      const [time, setTime] = useState(0);

      useEffect(() => {
         const interval = setInterval(() => setTime(t => t + 0.05), 30);
         return () => clearInterval(interval);
      }, []);

      // Total Internal Reflection: n1 sin(theta1) = n2 sin(theta2)
      // For glass (n=1.5) to air (n=1.0), critical angle is ~41.8 deg.
      const criticalAngle = 41.8;
      const isLeaking = (90 - incidentAngle) < criticalAngle;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">FIBER OPTICS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total Internal Reflection & Data</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLeaking ? 'bg-red-500/20 border-red-500/30' : 'bg-indigo-500/20 border-indigo-500/30'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-400">Signal Status</p>
                  <p className={`text-sm font-black ${isLeaking ? 'text-red-400' : 'text-indigo-400'}`}>
                     {isLeaking ? 'SIGNAL LEAKING' : 'TOTAL INTERNAL REFLECTION'}
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="300" className="overflow-visible">
                     {/* Fiber Core */}
                     <path
                        d={`M 50,150 Q ${300},${150 + fiberCurvature} 550,150`}
                        fill="none"
                        stroke="#312e81"
                        strokeWidth="40"
                        strokeLinecap="round"
                        strokeOpacity="0.3"
                     />
                     <path
                        d={`M 50,150 Q ${300},${150 + fiberCurvature} 550,150`}
                        fill="none"
                        stroke="#4338ca"
                        strokeWidth="2"
                        strokeDasharray="4 4"
                        strokeOpacity="0.5"
                     />

                     {/* Light Signal */}
                     <path
                        d={`M 50,150 L 100,${150 - incidentAngle} L 200,${150 + incidentAngle} L 300,${150 - incidentAngle} L 400,${150 + incidentAngle} L 500,${150 - incidentAngle} L 550,150`}
                        fill="none"
                        stroke={isLeaking ? '#ef4444' : '#818cf8'}
                        strokeWidth="3"
                        strokeOpacity={isLeaking ? 0.4 : 1}
                        className={isLeaking ? '' : 'animate-pulse'}
                     />

                     {/* Leaking Rays */}
                     {isLeaking && (
                        <g>
                           <line x1="100" y1={150 - incidentAngle} x2="120" y2={150 - incidentAngle - 40} stroke="#ef4444" strokeWidth="1" strokeOpacity="0.6" />
                           <line x1="200" y1={150 + incidentAngle} x2="220" y2={150 + incidentAngle + 40} stroke="#ef4444" strokeWidth="1" strokeOpacity="0.6" />
                        </g>
                     )}

                     <text x="50" y="120" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest">Input Signal</text>
                     <text x="500" y="120" className="text-[8px] font-black fill-slate-500 uppercase tracking-widest text-right">Output</text>
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Incident Angle</label>
                     <input
                        type="range"
                        min="5"
                        max="60"
                        value={incidentAngle}
                        onChange={(e) => setIncidentAngle(parseInt(e.target.value))}
                        className="w-full accent-indigo-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Shallow</span>
                        <span className="text-white bg-indigo-500/20 px-2 py-0.5 rounded">{incidentAngle}¬∞</span>
                        <span>Steep</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fiber Curvature</label>
                     <input
                        type="range"
                        min="-100"
                        max="100"
                        value={fiberCurvature}
                        onChange={(e) => setFiberCurvature(parseInt(e.target.value))}
                        className="w-full accent-slate-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Straight</span>
                        <span className="text-white bg-slate-800 px-2 py-0.5 rounded">{fiberCurvature}</span>
                        <span>Bent</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-indigo-500/10 rounded-3xl border border-indigo-500/20">
                     <p className="text-[10px] font-bold text-indigo-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Fiber optics work because light is <strong>trapped</strong> inside the glass. As long as the angle is shallow enough, the light reflects 100% and never escapes.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- STATIC BALLOON RENDERER ---
   const StaticBalloonRenderer = () => {
      const [balloonPos, setBalloonPos] = useState({ x: 100, y: 150 });
      const [balloonCharges, setBalloonCharges] = useState(0);
      const [isRubbing, setIsRubbing] = useState(false);

      const sweaterX = 50;
      const wallX = 500;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">STATIC ELECTRICITY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Charge Transfer & Attraction</p>
               </div>
               <div className="bg-yellow-500/20 px-4 py-2 rounded-xl border border-yellow-500/30">
                  <p className="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Balloon Charge</p>
                  <p className="text-sm font-black text-white">{balloonCharges} Electrons</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Sweater */}
               <div className="absolute left-10 top-20 bottom-20 w-32 bg-red-600/20 border-2 border-red-500/30 rounded-3xl flex items-center justify-center">
                  <div className="grid grid-cols-3 gap-4 opacity-40">
                     {Array.from({ length: 12 }).map((_, i) => (
                        <span key={i} className="text-red-400 font-bold text-xs">+</span>
                     ))}
                  </div>
                  <p className="absolute -bottom-8 text-[8px] font-black text-slate-500 uppercase tracking-widest">Wool Sweater</p>
               </div>

               {/* Wall */}
               <div className="absolute right-10 top-20 bottom-20 w-20 bg-slate-800/40 border-l-4 border-slate-700 rounded-r-3xl flex flex-col justify-around p-4">
                  {Array.from({ length: 8 }).map((_, i) => (
                     <div key={i} className="flex justify-between items-center opacity-40">
                        <span className="text-blue-400 text-[8px]">+</span>
                        <span className="text-red-400 text-[8px]">-</span>
                     </div>
                  ))}
                  <p className="absolute -bottom-8 right-0 text-[8px] font-black text-slate-500 uppercase tracking-widest">Neutral Wall</p>
               </div>

               {/* Balloon */}
               <div
                  className="absolute cursor-move select-none"
                  style={{ left: balloonPos.x, top: balloonPos.y }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - balloonPos.x;
                     const startY = e.clientY - balloonPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        const newX = moveEvent.clientX - startX;
                        const newY = moveEvent.clientY - startY;
                        setBalloonPos({ x: newX, y: newY });

                        // Rubbing logic
                        if (newX < 150) {
                           setIsRubbing(true);
                           setBalloonCharges(prev => Math.min(20, prev + 1));
                        } else {
                           setIsRubbing(false);
                        }

                        // Wall sticking logic
                        if (newX > 400 && balloonCharges > 5) {
                           setBalloonPos(prev => ({ ...prev, x: 440 }));
                        }
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                        setIsRubbing(false);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className={`w-24 h-32 bg-yellow-500 rounded-full relative shadow-2xl transition-transform ${isRubbing ? 'scale-105' : ''}`}>
                     <div className="absolute inset-0 flex flex-wrap content-center justify-center p-4">
                        {Array.from({ length: Math.floor(balloonCharges) }).map((_, i) => (
                           <span key={i} className="text-slate-900 font-black text-[10px] m-0.5">-</span>
                        ))}
                     </div>
                     <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-2 h-4 bg-yellow-600 rounded-b-full" />
                  </div>
                  <p className="text-center mt-4 text-[8px] font-black text-slate-500 uppercase tracking-widest">Drag Me!</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-500/10 flex items-center justify-center border border-yellow-500/20 shrink-0">
                     <span className="text-2xl">üí°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Rubbing the balloon on the sweater transfers <strong>electrons</strong>. The negatively charged balloon then repels electrons in the wall, leaving a positive surface that it sticks to!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CIRCUIT BUILDER BASIC RENDERER ---
   const CircuitBuilderBasicRenderer = () => {
      const [isBatteryConnected, setIsBatteryConnected] = useState(false);
      const [isBulbConnected, setIsBulbConnected] = useState(false);
      const [isSwitchClosed, setIsSwitchClosed] = useState(false);

      const isLit = isBatteryConnected && isBulbConnected && isSwitchClosed;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">MY FIRST CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Battery, Bulb & Switch</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLit ? 'bg-yellow-500/20 border-yellow-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Circuit Status</p>
                  <p className={`text-sm font-black ${isLit ? 'text-yellow-400' : 'text-slate-400'}`}>
                     {isLit ? 'LIGHT IS ON!' : 'INCOMPLETE'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Wires */}
                  <path d="M 100,200 L 100,100 L 500,100 L 500,200" fill="none" stroke="#475569" strokeWidth="8" strokeLinecap="round" />
                  <path d="M 100,250 L 100,350 L 500,350 L 500,250" fill="none" stroke="#475569" strokeWidth="8" strokeLinecap="round" />

                  {/* Battery Slot */}
                  <g transform="translate(50, 200)" className="cursor-pointer" onClick={() => setIsBatteryConnected(!isBatteryConnected)}>
                     <rect x="0" y="0" width="100" height="50" fill={isBatteryConnected ? '#f59e0b' : '#1e293b'} rx="8" stroke={isBatteryConnected ? '#fbbf24' : '#334155'} strokeWidth="2" />
                     <rect x="100" y="15" width="10" height="20" fill="#94a3b8" rx="2" />
                     <text x="50" y="30" textAnchor="middle" className="text-[10px] font-black fill-slate-900 uppercase">BATTERY</text>
                     {!isBatteryConnected && <text x="50" y="-10" textAnchor="middle" className="text-[8px] font-bold fill-blue-400 animate-bounce">CLICK TO ADD</text>}
                  </g>

                  {/* Bulb Slot */}
                  <g transform="translate(450, 200)" className="cursor-pointer" onClick={() => setIsBulbConnected(!isBulbConnected)}>
                     <circle cx="50" cy="25" r="30" fill={isLit ? '#fef08a' : isBulbConnected ? '#334155' : '#1e293b'} stroke={isBulbConnected ? '#94a3b8' : '#334155'} strokeWidth="2" className={isLit ? 'shadow-[0_0_50px_#facc15]' : ''} />
                     <path d="M 35,45 L 65,45 L 60,60 L 40,60 Z" fill="#94a3b8" />
                     <text x="50" y="30" textAnchor="middle" className={`text-[10px] font-black uppercase ${isLit ? 'fill-yellow-700' : 'fill-slate-500'}`}>BULB</text>
                     {!isBulbConnected && <text x="50" y="-15" textAnchor="middle" className="text-[8px] font-bold fill-blue-400 animate-bounce">CLICK TO ADD</text>}
                  </g>

                  {/* Switch */}
                  <g transform="translate(250, 80)" className="cursor-pointer" onClick={() => setIsSwitchClosed(!isSwitchClosed)}>
                     <circle cx="0" cy="20" r="6" fill="#475569" />
                     <circle cx="100" cy="20" r="6" fill="#475569" />
                     <line
                        x1="0" y1="20"
                        x2={isSwitchClosed ? 100 : 80} y2={isSwitchClosed ? 20 : -20}
                        stroke="#94a3b8" strokeWidth="6" strokeLinecap="round"
                        className="transition-all duration-300"
                     />
                     <text x="50" y="50" textAnchor="middle" className="text-[10px] font-black fill-slate-500 uppercase">SWITCH</text>
                  </g>

                  {/* Electrons (Flowing) */}
                  {isLit && Array.from({ length: 12 }).map((_, i) => (
                     <circle key={i} r="3" fill="#38bdf8">
                        <animateMotion
                           dur="2s"
                           repeatCount="indefinite"
                           path="M 100,225 L 100,350 L 500,350 L 500,225 M 500,225 L 500,100 L 100,100 L 100,225"
                           begin={`${i * 0.2}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-3 gap-8">
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">Energy Source</p>
                     <p className="text-xs font-bold text-blue-400">Battery</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">The Load</p>
                     <p className="text-xs font-bold text-yellow-400">Light Bulb</p>
                  </div>
                  <div className="text-center">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">The Control</p>
                     <p className="text-xs font-bold text-slate-400">Switch</p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNET MAZE RENDERER ---
   const MagnetMazeRenderer = () => {
      const [ballPos, setBallPos] = useState({ x: 100, y: 100 });
      const [magnetPos, setMagnetPos] = useState({ x: 300, y: 300 });

      useEffect(() => {
         const dx = magnetPos.x - ballPos.x;
         const dy = magnetPos.y - ballPos.y;
         const dist = Math.sqrt(dx * dx + dy * dy);

         if (dist < 150 && dist > 10) {
            const force = (150 - dist) / 50;
            setBallPos(prev => ({
               x: prev.x + (dx / dist) * force,
               y: prev.y + (dy / dist) * force
            }));
         }
      }, [magnetPos]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">MAGNET MAZE</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Fields & Forces</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Maze Walls (Simplified) */}
               <svg className="absolute inset-0 w-full h-full">
                  <rect x="200" y="0" width="20" height="250" fill="#1e293b" />
                  <rect x="400" y="150" width="20" height="250" fill="#1e293b" />
                  <text x="500" y="350" className="text-[10px] font-black fill-emerald-500 uppercase tracking-widest">Goal</text>
                  <circle cx="520" cy="345" r="30" fill="none" stroke="#10b981" strokeWidth="2" strokeDasharray="4 4" />
               </svg>

               {/* Iron Ball */}
               <div
                  className="absolute w-8 h-8 bg-slate-400 rounded-full shadow-lg border-2 border-slate-300 transition-all duration-100"
                  style={{ left: ballPos.x - 16, top: ballPos.y - 16 }}
               >
                  <div className="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-full" />
               </div>

               {/* Magnet (Draggable) */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 20, top: magnetPos.y - 40 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-10 h-20 flex flex-col rounded-md overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
                  <p className="text-center mt-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Magnet</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üß≤</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Magnets exert a <strong>force</strong> on certain metals like iron. This force gets stronger as the magnet gets closer!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTROMAGNET BASIC RENDERER ---
   const ElectromagnetBasicRenderer = () => {
      const [numCoils, setNumCoils] = useState(5);
      const [isPowerOn, setIsPowerOn] = useState(false);
      const [paperclips, setPaperclips] = useState<{ id: number, x: number, y: number, isPickedUp: boolean }[]>(
         Array.from({ length: 8 }, (_, i) => ({
            id: i,
            x: 400 + Math.random() * 150,
            y: 300 + Math.random() * 50,
            isPickedUp: false
         }))
      );

      const magneticStrength = isPowerOn ? numCoils * 10 : 0;

      useEffect(() => {
         if (isPowerOn) {
            setPaperclips(prev => prev.map(p => {
               if (p.x < 350 && Math.abs(p.y - 200) < 100) {
                  return { ...p, x: 250, y: 200 + (p.id - 4) * 10, isPickedUp: true };
               }
               return p;
            }));
         } else {
            setPaperclips(prev => prev.map(p => p.isPickedUp ? { ...p, y: 320, isPickedUp: false } : p));
         }
      }, [isPowerOn, numCoils]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTROMAGNET LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Electricity + Magnetism</p>
               </div>
               <div className="flex gap-4">
                  <button
                     onClick={() => setIsPowerOn(!isPowerOn)}
                     className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isPowerOn ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/40' : 'bg-slate-800 text-slate-400'}`}
                  >
                     {isPowerOn ? 'POWER ON' : 'POWER OFF'}
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="600" height="400" className="overflow-visible">
                     {/* Battery */}
                     <rect x="50" y="300" width="80" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                     <rect x="130" y="310" width="8" height="20" fill="#94a3b8" />

                     {/* Wires */}
                     <path d="M 130,320 L 200,320 L 200,200" fill="none" stroke={isPowerOn ? '#fb923c' : '#475569'} strokeWidth="4" />
                     <path d="M 50,320 L 20,320 L 20,100 L 200,100 L 200,200" fill="none" stroke={isPowerOn ? '#fb923c' : '#475569'} strokeWidth="4" />

                     {/* Iron Nail */}
                     <rect x="180" y="150" width="150" height="20" fill="#64748b" rx="2" transform="rotate(90, 255, 200)" />
                     <path d="M 245,100 L 265,100 L 255,80 Z" fill="#475569" />

                     {/* Coils */}
                     {Array.from({ length: numCoils }).map((_, i) => (
                        <path
                           key={i}
                           d={`M 245,${120 + i * 20} Q 280,${130 + i * 20} 245,${140 + i * 20}`}
                           fill="none"
                           stroke={isPowerOn ? '#fb923c' : '#475569'}
                           strokeWidth="3"
                        />
                     ))}

                     {/* Magnetic Field (Visual) */}
                     {isPowerOn && (
                        <g className="animate-pulse">
                           <ellipse cx="255" cy="200" rx="60" ry="120" fill="none" stroke="#fb923c" strokeWidth="1" strokeOpacity="0.2" />
                           <ellipse cx="255" cy="200" rx="40" ry="100" fill="none" stroke="#fb923c" strokeWidth="1" strokeOpacity="0.3" />
                        </g>
                     )}

                     {/* Paperclips */}
                     {paperclips.map(p => (
                        <g key={p.id} transform={`translate(${p.x}, ${p.y}) rotate(${p.isPickedUp ? 90 : 0})`}>
                           <rect width="15" height="4" fill="none" stroke="#94a3b8" strokeWidth="1.5" rx="2" />
                        </g>
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Number of Coils</label>
                     <input
                        type="range"
                        min="1"
                        max="10"
                        value={numCoils}
                        onChange={(e) => setNumCoils(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Weak</span>
                        <span className="text-white bg-orange-500/20 px-2 py-0.5 rounded">{numCoils} Turns</span>
                        <span>Strong</span>
                     </div>
                  </div>

                  <div className="p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Secret</p>
                     <p className="text-[10px] text-slate-300 leading-tight">
                        Electricity flowing through a wire creates a <strong>magnetic field</strong>. Wrapping the wire into coils concentrates that field, making it strong enough to pick up metal!
                     </p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-orange-500/10 rounded-3xl border border-orange-500/20">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Unlike permanent magnets, electromagnets can be <strong>turned on and off</strong>. This makes them incredibly useful in everything from scrap yards to MRI machines.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- CONDUCTIVITY TESTER RENDERER ---
   const ConductivityTesterRenderer = () => {
      const [selectedObject, setSelectedObject] = useState<'none' | 'copper' | 'wood' | 'plastic' | 'water'>('none');

      const objects = {
         none: { name: 'Empty', isConductor: false, color: 'transparent' },
         copper: { name: 'Copper Coin', isConductor: true, color: '#b45309' },
         wood: { name: 'Wooden Stick', isConductor: false, color: '#78350f' },
         plastic: { name: 'Plastic Ruler', isConductor: false, color: '#3b82f6' },
         water: { name: 'Salt Water', isConductor: true, color: '#0ea5e9' }
      };

      const isLit = selectedObject !== 'none' && objects[selectedObject].isConductor;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">CONDUCTIVITY TESTER</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Conductors vs. Insulators</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isLit ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Result</p>
                  <p className={`text-sm font-black ${isLit ? 'text-emerald-400' : 'text-slate-400'}`}>
                     {isLit ? 'CONDUCTOR' : 'INSULATOR'}
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Circuit */}
                     <path d="M 100,150 L 50,150 L 50,50 L 350,50 L 350,150 L 300,150" fill="none" stroke="#475569" strokeWidth="6" strokeLinecap="round" />
                     <path d="M 100,200 L 50,200 L 50,250 L 350,250 L 350,200 L 300,200" fill="none" stroke="#475569" strokeWidth="6" strokeLinecap="round" />

                     {/* Battery */}
                     <rect x="170" y="30" width="60" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                     <text x="200" y="55" textAnchor="middle" className="text-[8px] font-black fill-slate-500">BATTERY</text>

                     {/* Bulb */}
                     <circle cx="200" cy="250" r="25" fill={isLit ? '#fef08a' : '#1e293b'} stroke="#334155" strokeWidth="2" className={isLit ? 'shadow-[0_0_40px_#facc15]' : ''} />
                     <text x="200" y="255" textAnchor="middle" className={`text-[8px] font-black ${isLit ? 'fill-yellow-700' : 'fill-slate-500'}`}>BULB</text>

                     {/* Test Probes */}
                     <rect x="100" y="140" width="10" height="70" fill="#94a3b8" rx="2" />
                     <rect x="290" y="140" width="10" height="70" fill="#94a3b8" rx="2" />

                     {/* Test Object */}
                     {selectedObject !== 'none' && (
                        <rect
                           x="110" y="165" width="180" height="20"
                           fill={objects[selectedObject].color}
                           rx="4"
                           className="animate-in fade-in zoom-in duration-300"
                        />
                     )}

                     {/* Electrons */}
                     {isLit && Array.from({ length: 10 }).map((_, i) => (
                        <circle key={i} r="2" fill="#10b981">
                           <animateMotion
                              dur="1.5s"
                              repeatCount="indefinite"
                              path="M 110,175 L 290,175 M 290,175 L 350,175 L 350,250 L 200,250 L 50,250 L 50,175 L 110,175"
                              begin={`${i * 0.15}s`}
                           />
                        </circle>
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-4 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <p className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Select Object to Test</p>
                  <div className="grid grid-cols-1 gap-2">
                     {Object.entries(objects).filter(([k]) => k !== 'none').map(([key, obj]) => (
                        <button
                           key={key}
                           onClick={() => setSelectedObject(key as any)}
                           className={`p-4 rounded-2xl border text-left transition-all ${selectedObject === key ? 'bg-emerald-500/20 border-emerald-500/40' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}
                        >
                           <div className="flex items-center justify-between">
                              <span className="text-xs font-bold">{obj.name}</span>
                              <div className="w-4 h-4 rounded-full" style={{ backgroundColor: obj.color }} />
                           </div>
                        </button>
                     ))}
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        <strong>Conductors</strong> (like copper) have loose electrons that can flow easily. <strong>Insulators</strong> (like wood) hold onto their electrons tightly, blocking the flow.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- SIMPLE SWITCH RENDERER ---
   const SimpleSwitchRenderer = () => {
      const [isClosed, setIsClosed] = useState(false);
      const [circuitType, setCircuitType] = useState<'series' | 'parallel'>('series');

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">SWITCH LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Controlling the Flow</p>
               </div>
               <div className="flex bg-slate-800 p-1 rounded-xl border border-slate-700">
                  <button
                     onClick={() => setCircuitType('series')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${circuitType === 'series' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     SERIES
                  </button>
                  <button
                     onClick={() => setCircuitType('parallel')}
                     className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${circuitType === 'parallel' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20' : 'text-slate-500 hover:text-slate-300'}`}
                  >
                     PARALLEL
                  </button>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Battery */}
                  <rect x="50" y="180" width="60" height="40" fill="#1e293b" rx="4" stroke="#334155" />
                  <text x="80" y="205" textAnchor="middle" className="text-[8px] font-black fill-slate-500">BATTERY</text>

                  {/* Series Circuit */}
                  {circuitType === 'series' ? (
                     <g>
                        <path d="M 110,200 L 200,200 M 300,200 L 400,200 L 400,100 L 500,100 M 500,300 L 400,300 L 400,200 M 50,200 L 20,200 L 20,350 L 500,350 L 500,300" fill="none" stroke="#475569" strokeWidth="4" />
                        {/* Switch */}
                        <g transform="translate(200, 180)" className="cursor-pointer" onClick={() => setIsClosed(!isClosed)}>
                           <circle cx="0" cy="20" r="4" fill="#94a3b8" />
                           <circle cx="100" cy="20" r="4" fill="#94a3b8" />
                           <line x1="0" y1="20" x2={isClosed ? 100 : 80} y2={isClosed ? 20 : -10} stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />
                        </g>
                        {/* Bulbs */}
                        <circle cx="500" cy="100" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                        <circle cx="500" cy="300" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                     </g>
                  ) : (
                     <g>
                        <path d="M 110,200 L 200,200 M 300,200 L 350,200 L 350,100 L 500,100 M 350,200 L 350,300 L 500,300 M 50,200 L 20,200 L 20,350 L 550,350 L 550,100 L 500,100 M 550,300 L 500,300" fill="none" stroke="#475569" strokeWidth="4" />
                        {/* Switch */}
                        <g transform="translate(200, 180)" className="cursor-pointer" onClick={() => setIsClosed(!isClosed)}>
                           <circle cx="0" cy="20" r="4" fill="#94a3b8" />
                           <circle cx="100" cy="20" r="4" fill="#94a3b8" />
                           <line x1="0" y1="20" x2={isClosed ? 100 : 80} y2={isClosed ? 20 : -10} stroke="#94a3b8" strokeWidth="4" strokeLinecap="round" />
                        </g>
                        {/* Bulbs */}
                        <circle cx="500" cy="100" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                        <circle cx="500" cy="300" r="20" fill={isClosed ? '#fef08a' : '#1e293b'} stroke="#334155" className={isClosed ? 'shadow-[0_0_30px_#facc15]' : ''} />
                     </g>
                  )}

                  {/* Electrons */}
                  {isClosed && Array.from({ length: 15 }).map((_, i) => (
                     <circle key={i} r="2" fill="#22d3ee">
                        <animateMotion
                           dur="2s"
                           repeatCount="indefinite"
                           path={circuitType === 'series'
                              ? "M 110,200 L 200,200 L 300,200 L 400,200 L 400,100 L 500,100 L 500,300 L 500,350 L 20,350 L 20,200 L 50,200"
                              : "M 110,200 L 200,200 L 300,200 L 350,200 L 350,100 L 500,100 L 550,100 L 550,350 L 20,350 L 20,200 L 50,200"
                           }
                           begin={`${i * 0.15}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">üîå</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A switch works by <strong>breaking the path</strong>. When it's open, electrons can't jump the gap, so the circuit stops. Close it, and the loop is complete!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC POLE RENDERER ---
   const MagneticPoleRenderer = () => {
      const [isBroken, setIsBroken] = useState(false);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">MAGNETIC POLES</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">North, South & Monopoles</p>
               </div>
               <button
                  onClick={() => setIsBroken(!isBroken)}
                  className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${isBroken ? 'bg-slate-800 text-slate-400' : 'bg-red-500 text-white shadow-lg shadow-red-500/40'}`}
               >
                  {isBroken ? 'RESET MAGNET' : 'BREAK THE MAGNET'}
               </button>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative flex items-center gap-4">
                  {!isBroken ? (
                     <div className="w-64 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800 animate-in zoom-in duration-500">
                        <div className="flex-1 bg-red-600 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black">N</span>
                           <span className="text-[10px] font-bold opacity-50">NORTH</span>
                        </div>
                        <div className="flex-1 bg-blue-600 flex flex-col items-center justify-center">
                           <span className="text-4xl font-black">S</span>
                           <span className="text-[10px] font-bold opacity-50">SOUTH</span>
                        </div>
                     </div>
                  ) : (
                     <div className="flex gap-16 animate-in slide-in-from-left duration-500">
                        <div className="w-32 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                           <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-2xl">N</div>
                           <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-2xl">S</div>
                        </div>
                        <div className="w-32 h-24 flex rounded-xl overflow-hidden shadow-2xl border border-slate-800">
                           <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-2xl">N</div>
                           <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-2xl">S</div>
                        </div>
                     </div>
                  )}

                  {/* Field Lines (Visual) */}
                  <svg className="absolute inset-0 -z-10 w-[800px] h-[400px] -translate-x-1/4 -translate-y-1/4 pointer-events-none">
                     <defs>
                        <linearGradient id="field-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                           <stop offset="0%" stopColor="#ef4444" stopOpacity="0.2" />
                           <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.2" />
                        </linearGradient>
                     </defs>
                     {!isBroken && (
                        <g>
                           <path d="M 300,200 Q 400,100 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="2" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,300 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="2" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,50 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="1" strokeDasharray="4 4" />
                           <path d="M 300,200 Q 400,350 500,200" fill="none" stroke="url(#field-grad)" strokeWidth="1" strokeDasharray="4 4" />
                        </g>
                     )}
                  </svg>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">‚úÇÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Every magnet has two poles. If you break a magnet in half, you don't get a "North" and a "South"‚Äîyou get <strong>two smaller magnets</strong>, each with its own North and South!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ATTRACT & REPEL RENDERER ---
   const AttractRepelRenderer = () => {
      const [leftMagnetType, setLeftMagnetType] = useState<'N' | 'S'>('N');
      const [rightMagnetType, setRightMagnetType] = useState<'N' | 'S'>('S');
      const [distance, setDistance] = useState(200);

      const isAttracting = leftMagnetType !== rightMagnetType;
      const forceStrength = Math.max(0, (300 - distance) / 20);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">ATTRACT OR REPEL?</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Interaction Rules</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isAttracting ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-red-500/20 border-red-500/30'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Interaction</p>
                  <p className={`text-sm font-black ${isAttracting ? 'text-emerald-400' : 'text-red-400'}`}>
                     {isAttracting ? 'ATTRACTING' : 'REPELLING'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               <div className="flex items-center gap-8" style={{ gap: `${distance}px` }}>
                  {/* Left Magnet */}
                  <div
                     className="w-32 h-16 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800 cursor-pointer"
                     onClick={() => setLeftMagnetType(leftMagnetType === 'N' ? 'S' : 'N')}
                  >
                     <div className={`flex-1 flex items-center justify-center font-black ${leftMagnetType === 'N' ? 'bg-red-600' : 'bg-blue-600'}`}>
                        {leftMagnetType}
                     </div>
                     <div className={`flex-1 flex items-center justify-center font-black ${leftMagnetType === 'N' ? 'bg-blue-600' : 'bg-red-600'}`}>
                        {leftMagnetType === 'N' ? 'S' : 'N'}
                     </div>
                  </div>

                  {/* Right Magnet */}
                  <div
                     className="w-32 h-16 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800 cursor-pointer"
                     onClick={() => setRightMagnetType(rightMagnetType === 'N' ? 'S' : 'N')}
                  >
                     <div className={`flex-1 flex items-center justify-center font-black ${rightMagnetType === 'N' ? 'bg-red-600' : 'bg-blue-600'}`}>
                        {rightMagnetType}
                     </div>
                     <div className={`flex-1 flex items-center justify-center font-black ${rightMagnetType === 'N' ? 'bg-blue-600' : 'bg-red-600'}`}>
                        {rightMagnetType === 'N' ? 'S' : 'N'}
                     </div>
                  </div>
               </div>

               {/* Force Arrows */}
               <div className="mt-12 flex items-center gap-4">
                  {isAttracting ? (
                     <div className="flex items-center gap-2 text-emerald-400">
                        <span className="text-2xl animate-bounce">‚Üí</span>
                        <span className="text-[10px] font-black uppercase tracking-widest">Pulling Together</span>
                        <span className="text-2xl animate-bounce">‚Üê</span>
                     </div>
                  ) : (
                     <div className="flex items-center gap-2 text-red-400">
                        <span className="text-2xl animate-bounce">‚Üê</span>
                        <span className="text-[10px] font-black uppercase tracking-widest">Pushing Away</span>
                        <span className="text-2xl animate-bounce">‚Üí</span>
                     </div>
                  )}
               </div>

               {/* Distance Slider */}
               <div className="absolute bottom-12 w-64">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center mb-4">Distance</label>
                  <input
                     type="range"
                     min="50"
                     max="400"
                     value={distance}
                     onChange={(e) => setDistance(parseInt(e.target.value))}
                     className="w-full accent-blue-500"
                  />
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">ü§ù</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     The golden rule of magnetism: <strong>Opposites attract</strong> (N and S), and <strong>likes repel</strong> (N and N, or S and S). The closer they are, the stronger the force!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- COMPASS RENDERER ---
   const CompassRenderer = () => {
      const [magnetPos, setMagnetPos] = useState({ x: 450, y: 150 });
      const [isDragging, setIsDragging] = useState(false);

      const compasses = Array.from({ length: 25 }).map((_, i) => ({
         x: 50 + (i % 5) * 80,
         y: 50 + Math.floor(i / 5) * 60
      }));

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">COMPASS LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Earth's Field & Local Magnets</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 overflow-hidden">
               {/* Compass Grid */}
               {compasses.map((c, i) => {
                  const dx = magnetPos.x - c.x;
                  const dy = magnetPos.y - c.y;
                  const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                  return (
                     <div
                        key={i}
                        className="absolute w-12 h-12 rounded-full border border-slate-800 bg-slate-900/30 flex items-center justify-center"
                        style={{ left: c.x - 24, top: c.y - 24 }}
                     >
                        <div
                           className="w-8 h-1 bg-gradient-to-r from-red-500 to-blue-500 rounded-full transition-transform duration-200"
                           style={{ transform: `rotate(${angle}deg)` }}
                        />
                        <div className="absolute w-1 h-1 bg-white rounded-full" />
                     </div>
                  );
               })}

               {/* Draggable Magnet */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 40, top: magnetPos.y - 20 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-20 h-10 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
                  <p className="text-center mt-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Drag Me!</p>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üß≠</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A compass needle is just a <strong>tiny magnet</strong> that's free to spin. It always points toward the strongest magnetic field nearby‚Äîusually the Earth, unless there's a closer magnet!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC MATERIAL RENDERER ---
   const MagneticMaterialRenderer = () => {
      const [selectedMaterial, setSelectedMaterial] = useState<'none' | 'iron' | 'aluminum' | 'wood'>('none');
      const [magnetPos, setMagnetPos] = useState({ x: 100, y: 150 });

      const materials = {
         none: { name: 'Empty', isMagnetic: false, color: 'transparent' },
         iron: { name: 'Iron Bolt', isMagnetic: true, color: '#64748b' },
         aluminum: { name: 'Aluminum Foil', isMagnetic: false, color: '#cbd5e1' },
         wood: { name: 'Wooden Block', isMagnetic: false, color: '#78350f' }
      };

      const isAttracted = selectedMaterial !== 'none' && materials[selectedMaterial].isMagnetic && magnetPos.x > 350;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-slate-400">MAGNETIC MATERIALS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">What sticks to a magnet?</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border transition-all ${isAttracted ? 'bg-red-500/20 border-red-500/30' : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Interaction</p>
                  <p className={`text-sm font-black ${isAttracted ? 'text-red-400' : 'text-slate-400'}`}>
                     {isAttracted ? 'ATTRACTED!' : 'NO INTERACTION'}
                  </p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Test Tray */}
               <div className="absolute right-20 top-1/2 -translate-y-1/2 w-48 h-48 bg-slate-900/50 border-2 border-dashed border-slate-800 rounded-3xl flex items-center justify-center">
                  {selectedMaterial !== 'none' ? (
                     <div
                        className={`w-24 h-24 rounded-2xl shadow-2xl transition-all duration-300 ${isAttracted ? 'translate-x-[-20px]' : ''}`}
                        style={{ backgroundColor: materials[selectedMaterial].color }}
                     >
                        <div className="absolute inset-0 flex items-center justify-center">
                           <span className="text-[10px] font-black uppercase tracking-widest opacity-50">{materials[selectedMaterial].name}</span>
                        </div>
                     </div>
                  ) : (
                     <span className="text-[10px] font-black text-slate-700 uppercase tracking-widest">Place Object Here</span>
                  )}
               </div>

               {/* Draggable Magnet */}
               <div
                  className="absolute cursor-move select-none z-10"
                  style={{ left: magnetPos.x - 40, top: magnetPos.y - 20 }}
                  onMouseDown={(e) => {
                     const startX = e.clientX - magnetPos.x;
                     const startY = e.clientY - magnetPos.y;
                     const move = (moveEvent: MouseEvent) => {
                        setMagnetPos({
                           x: moveEvent.clientX - startX,
                           y: moveEvent.clientY - startY
                        });
                     };
                     const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                     };
                     window.addEventListener('mousemove', move);
                     window.addEventListener('mouseup', up);
                  }}
               >
                  <div className="w-20 h-10 flex rounded-lg overflow-hidden shadow-2xl border border-slate-800">
                     <div className="flex-1 bg-red-600 flex items-center justify-center font-black text-xs">N</div>
                     <div className="flex-1 bg-blue-600 flex items-center justify-center font-black text-xs">S</div>
                  </div>
               </div>

               {/* Material Selector */}
               <div className="absolute left-8 top-1/2 -translate-y-1/2 flex flex-col gap-2">
                  {Object.entries(materials).filter(([k]) => k !== 'none').map(([key, obj]) => (
                     <button
                        key={key}
                        onClick={() => setSelectedMaterial(key as any)}
                        className={`p-4 rounded-2xl border text-left transition-all ${selectedMaterial === key ? 'bg-slate-800 border-slate-600' : 'bg-slate-900/30 border-slate-800 hover:border-slate-700'}`}
                     >
                        <span className="text-xs font-bold">{obj.name}</span>
                     </button>
                  ))}
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-slate-500/10 flex items-center justify-center border border-slate-500/20 shrink-0">
                     <span className="text-2xl">üß±</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Not all metals are magnetic! <strong>Iron, Nickel, and Cobalt</strong> are the big three. Metals like Aluminum and Copper don't stick to magnets at all.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SERIES CIRCUIT RENDERER ---
   const SeriesCircuitRenderer = () => {
      const [voltage, setVoltage] = useState(9);
      const [resistors, setResistors] = useState([10, 10, 10]); // Ohms

      const totalResistance = resistors.reduce((a, b) => a + b, 0);
      const current = voltage / totalResistance;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">SERIES CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Single Path & Voltage Division</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-yellow-500/10 px-4 py-2 rounded-xl border border-yellow-500/20">
                     <p className="text-[8px] font-black text-yellow-400 uppercase tracking-widest">Total Current</p>
                     <p className="text-sm font-black text-white">{current.toFixed(2)} A</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Circuit Path */}
                  <rect x="100" y="100" width="400" height="200" fill="none" stroke="#334155" strokeWidth="4" rx="8" />

                  {/* Battery */}
                  <g transform="translate(80, 175)">
                     <rect x="0" y="0" width="40" height="50" fill="#1e293b" rx="4" stroke="#fbbf24" strokeWidth="2" />
                     <text x="20" y="30" textAnchor="middle" className="text-[8px] font-black fill-yellow-500">9V</text>
                  </g>

                  {/* Resistors */}
                  {resistors.map((r, i) => {
                     const x = 200 + i * 100;
                     return (
                        <g key={i} transform={`translate(${x}, 100)`}>
                           <path d="M -20,0 L -10,0 L -5,-10 L 5,10 L 15,-10 L 25,10 L 30,0 L 40,0" fill="none" stroke="#94a3b8" strokeWidth="2" />
                           <text x="10" y="-20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">{r} Œ©</text>
                           <text x="10" y="20" textAnchor="middle" className="text-[8px] font-bold fill-yellow-400">{(current * r).toFixed(1)}V</text>
                        </g>
                     );
                  })}

                  {/* Electrons */}
                  {Array.from({ length: 12 }).map((_, i) => (
                     <circle key={i} r="3" fill="#fbbf24">
                        <animateMotion
                           dur={`${2 / current}s`}
                           repeatCount="indefinite"
                           path="M 100,200 L 100,100 L 500,100 L 500,300 L 100,300 L 100,200"
                           begin={`${i * 0.2}s`}
                        />
                     </circle>
                  ))}
               </svg>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-2 gap-8">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Battery Voltage</label>
                     <input
                        type="range"
                        min="1"
                        max="24"
                        value={voltage}
                        onChange={(e) => setVoltage(parseInt(e.target.value))}
                        className="w-full accent-yellow-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>1V</span>
                        <span className="text-white">{voltage}V</span>
                        <span>24V</span>
                     </div>
                  </div>
                  <div className="p-4 bg-yellow-500/5 rounded-2xl border border-yellow-500/10">
                     <p className="text-[10px] font-black text-yellow-400 uppercase tracking-widest mb-2">The Rule</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        In a series circuit, the <strong>current is the same</strong> everywhere, but the <strong>voltage splits</strong> between the components.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- PARALLEL CIRCUIT RENDERER ---
   const ParallelCircuitRenderer = () => {
      const [voltage, setVoltage] = useState(12);
      const [resistors, setResistors] = useState([20, 30, 60]); // Ohms

      const currents = resistors.map(r => voltage / r);
      const totalCurrent = currents.reduce((a, b) => a + b, 0);
      const totalResistance = voltage / totalCurrent;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">PARALLEL CIRCUIT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multiple Paths & Constant Voltage</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">Total Current</p>
                  <p className="text-sm font-black text-white">{totalCurrent.toFixed(2)} A</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="600" height="400" className="overflow-visible">
                  {/* Main Bus */}
                  <path d="M 100,200 L 150,200 M 150,100 L 150,300 M 450,100 L 450,300 M 450,200 L 500,200" fill="none" stroke="#334155" strokeWidth="4" />

                  {/* Battery */}
                  <g transform="translate(50, 175)">
                     <rect x="0" y="0" width="40" height="50" fill="#1e293b" rx="4" stroke="#3b82f6" strokeWidth="2" />
                     <text x="20" y="30" textAnchor="middle" className="text-[8px] font-black fill-blue-500">{voltage}V</text>
                  </g>

                  {/* Parallel Branches */}
                  {resistors.map((r, i) => {
                     const y = 100 + i * 100;
                     return (
                        <g key={i}>
                           <path d={`M 150,${y} L 250,${y} M 350,${y} L 450,${y}`} fill="none" stroke="#334155" strokeWidth="4" />
                           <g transform={`translate(250, ${y})`}>
                              <path d="M 0,0 L 10,0 L 15,-10 L 25,10 L 35,-10 L 45,10 L 50,0 L 100,0" fill="none" stroke="#94a3b8" strokeWidth="2" />
                              <text x="50" y="-20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">{r} Œ©</text>
                              <text x="50" y="20" textAnchor="middle" className="text-[8px] font-bold fill-blue-400">{currents[i].toFixed(2)}A</text>
                           </g>
                           {/* Branch Electrons */}
                           {Array.from({ length: 6 }).map((_, j) => (
                              <circle key={j} r="2" fill="#3b82f6">
                                 <animateMotion
                                    dur={`${1.5 / currents[i]}s`}
                                    repeatCount="indefinite"
                                    path={`M 150,${y} L 450,${y}`}
                                    begin={`${j * 0.25}s`}
                                 />
                              </circle>
                           ))}
                        </g>
                     );
                  })}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto grid grid-cols-2 gap-8">
                  <div className="p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                     <p className="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">The Rule</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        In a parallel circuit, the <strong>voltage is the same</strong> across all branches, but the <strong>current splits</strong>. Adding more branches <strong>decreases</strong> total resistance!
                     </p>
                  </div>
                  <div className="flex items-center gap-4">
                     <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                        <span className="text-2xl">üè†</span>
                     </div>
                     <p className="text-xs text-slate-500 leading-relaxed">
                        This is how your house is wired. If one light goes out, the others stay on because they each have their own path to the battery!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- VOLTAGE POTENTIAL RENDERER ---
   const VoltagePotentialRenderer = () => {
      const [height, setHeight] = useState(100);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTRIC POTENTIAL</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">The Water Analogy</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Potential (Voltage)</p>
                  <p className="text-sm font-black text-white">{(height / 10).toFixed(1)} Volts</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative w-full max-w-md h-64 border-b-4 border-slate-800">
                  {/* Water Tank */}
                  <div
                     className="absolute bottom-0 left-1/2 -translate-x-1/2 w-32 bg-blue-500/30 border-2 border-blue-400/50 rounded-t-xl transition-all duration-500"
                     style={{ height: `${height}px` }}
                  >
                     <div className="absolute top-0 left-0 right-0 h-1 bg-blue-300 animate-pulse" />
                     <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest rotate-90">High Pressure</span>
                     </div>
                  </div>

                  {/* Ground */}
                  <div className="absolute bottom-[-20px] left-0 right-0 text-center">
                     <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest">Ground (0V)</span>
                  </div>

                  {/* Electrons (Falling) */}
                  {Array.from({ length: 8 }).map((_, i) => (
                     <div
                        key={i}
                        className="absolute w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                        style={{
                           left: `${30 + i * 10}%`,
                           bottom: `${height + 20}px`,
                           animationDelay: `${i * 0.2}s`,
                           animationDuration: `${1.5 - height / 200}s`
                        }}
                     />
                  ))}
               </div>

               {/* Height Slider */}
               <div className="absolute right-12 top-1/2 -translate-y-1/2 h-48 flex flex-col items-center gap-4">
                  <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Increase Potential</span>
                  <input
                     type="range"
                     min="20"
                     max="200"
                     value={height}
                     onChange={(e) => setHeight(parseInt(e.target.value))}
                     className="h-full appearance-none bg-slate-800 w-2 rounded-full outline-none"
                     style={{ writingMode: 'bt-lr' } as any}
                  />
                  <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Decrease Potential</span>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üåä</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Think of <strong>Voltage</strong> like water pressure. The higher the tank, the more "push" the water has. In a circuit, voltage is the "push" that makes electrons flow!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CURRENT FLOW RENDERER ---
   const CurrentFlowRenderer = () => {
      const [speed, setSpeed] = useState(1);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">ELECTRIC CURRENT</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Flow Rate & Amperes</p>
               </div>
               <div className="bg-cyan-500/10 px-4 py-2 rounded-xl border border-cyan-500/20">
                  <p className="text-[8px] font-black text-cyan-400 uppercase tracking-widest">Current (Amps)</p>
                  <p className="text-sm font-black text-white">{speed.toFixed(1)} A</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Wire Section */}
               <div className="relative w-full max-w-2xl h-32 bg-slate-900/50 border-y-4 border-slate-800 flex items-center overflow-hidden">
                  {/* Electrons */}
                  {Array.from({ length: 20 }).map((_, i) => (
                     <div
                        key={i}
                        className="absolute w-6 h-6 bg-cyan-400 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(34,211,238,0.5)]"
                        style={{
                           left: `${(i * 10) % 110}%`,
                           animation: `flow ${2 / speed}s linear infinite`,
                           animationDelay: `${(i * 0.1)}s`
                        }}
                     >
                        <span className="text-[10px] font-black text-slate-900">-</span>
                     </div>
                  ))}
               </div>

               <style>{`
                  @keyframes flow {
                     from { transform: translateX(-100px); }
                     to { transform: translateX(800px); }
                  }
               `}</style>

               {/* Speed Slider */}
               <div className="mt-12 w-64">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center mb-4">Flow Rate</label>
                  <input
                     type="range"
                     min="0.1"
                     max="5"
                     step="0.1"
                     value={speed}
                     onChange={(e) => setSpeed(parseFloat(e.target.value))}
                     className="w-full accent-cyan-500"
                  />
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">‚ö°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Current</strong> is the rate at which charge flows. 1 Ampere means 6.24 quintillion electrons are passing through a point every single second!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- OHM'S LAW RENDERER ---
   const OhmsLawRenderer = () => {
      const [voltage, setVoltage] = useState(10);
      const [resistance, setResistance] = useState(5);

      const current = voltage / resistance;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-white">OHM'S LAW LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">V = I √ó R</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700">
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Current (I)</p>
                     <p className="text-sm font-black text-white">{current.toFixed(2)} A</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* The "Ohm's Law" Triangle/Cartoon */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     {/* Voltage (The Pusher) */}
                     <div
                        className="absolute top-0 w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + voltage / 20})` }}
                     >
                        <span className="text-slate-900 font-black text-xl">V</span>
                     </div>

                     {/* Resistance (The Squeezer) */}
                     <div
                        className="absolute right-0 w-24 h-24 bg-red-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + resistance / 20})` }}
                     >
                        <span className="text-white font-black text-xl">R</span>
                     </div>

                     {/* Current (The Flow) */}
                     <div
                        className="absolute bottom-0 w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center shadow-lg transition-all duration-300"
                        style={{ transform: `scale(${0.5 + current / 5})` }}
                     >
                        <span className="text-white font-black text-xl">I</span>
                     </div>
                  </div>

                  <div className="mt-12 text-center">
                     <p className="text-2xl font-black tracking-tighter">
                        <span className="text-yellow-500">{voltage}V</span> =
                        <span className="text-blue-500"> {current.toFixed(2)}A</span> √ó
                        <span className="text-red-500"> {resistance}Œ©</span>
                     </p>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-8 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-yellow-500 uppercase tracking-widest">Voltage (V)</label>
                     <input
                        type="range"
                        min="1"
                        max="20"
                        value={voltage}
                        onChange={(e) => setVoltage(parseInt(e.target.value))}
                        className="w-full accent-yellow-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Low Push</span>
                        <span>{voltage}V</span>
                        <span>High Push</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-red-500 uppercase tracking-widest">Resistance (R)</label>
                     <input
                        type="range"
                        min="1"
                        max="20"
                        value={resistance}
                        onChange={(e) => setResistance(parseInt(e.target.value))}
                        className="w-full accent-red-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>Easy Path</span>
                        <span>{resistance}Œ©</span>
                        <span>Hard Path</span>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-6 bg-slate-800/50 rounded-3xl border border-slate-700">
                     <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest text-center">The Insight</p>
                     <p className="text-xs leading-relaxed text-slate-300 text-center">
                        Voltage <strong>pushes</strong> current, while Resistance <strong>opposes</strong> it. If you double the resistance, you cut the current in half!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTROMAGNET RENDERER (ADVANCED) ---
   const ElectromagnetRenderer = () => {
      const [numCoils, setNumCoils] = useState(50);
      const [current, setCurrent] = useState(2);
      const [coreMaterial, setCoreMaterial] = useState<'air' | 'iron'>('air');

      const magneticField = (coreMaterial === 'iron' ? 100 : 1) * numCoils * current;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">ELECTROMAGNET LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Solenoids & Permeability</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Field Strength (B)</p>
                  <p className="text-sm font-black text-white">{(magneticField / 1000).toFixed(2)} Tesla (est.)</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Magnetic Field Lines */}
                     {Array.from({ length: 12 }).map((_, i) => (
                        <ellipse
                           key={i}
                           cx="200" cy="150"
                           rx={60 + i * 20}
                           ry={40 + i * 15}
                           fill="none"
                           stroke="#fb923c"
                           strokeWidth="1"
                           strokeOpacity={Math.min(0.5, (magneticField / 5000) * (1 - i / 12))}
                           className="animate-pulse"
                        />
                     ))}

                     {/* Core */}
                     <rect
                        x="100" y="130" width="200" height="40"
                        fill={coreMaterial === 'iron' ? '#475569' : 'transparent'}
                        stroke={coreMaterial === 'iron' ? '#64748b' : '#334155'}
                        strokeWidth="2"
                        rx="4"
                     />
                     {coreMaterial === 'air' && (
                        <text x="200" y="155" textAnchor="middle" className="text-[8px] font-black fill-slate-700">AIR CORE</text>
                     )}

                     {/* Coils */}
                     {Array.from({ length: Math.floor(numCoils / 5) }).map((_, i) => (
                        <path
                           key={i}
                           d={`M ${110 + i * 10},120 Q ${115 + i * 10},110 ${120 + i * 10},120 L ${120 + i * 10},180 Q ${115 + i * 10},190 ${110 + i * 10},180 Z`}
                           fill="none"
                           stroke="#b45309"
                           strokeWidth="2"
                        />
                     ))}
                  </svg>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Number of Turns (N)</label>
                     <input
                        type="range"
                        min="10"
                        max="100"
                        value={numCoils}
                        onChange={(e) => setNumCoils(parseInt(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10</span>
                        <span>{numCoils} Turns</span>
                        <span>100</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Current (I)</label>
                     <input
                        type="range"
                        min="0"
                        max="5"
                        step="0.1"
                        value={current}
                        onChange={(e) => setCurrent(parseFloat(e.target.value))}
                        className="w-full accent-orange-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>0A</span>
                        <span>{current} Amps</span>
                        <span>5A</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Core Material</label>
                     <div className="grid grid-cols-2 gap-2">
                        <button
                           onClick={() => setCoreMaterial('air')}
                           className={`p-2 rounded-xl border text-[10px] font-black transition-all ${coreMaterial === 'air' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
                        >
                           AIR
                        </button>
                        <button
                           onClick={() => setCoreMaterial('iron')}
                           className={`p-2 rounded-xl border text-[10px] font-black transition-all ${coreMaterial === 'iron' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
                        >
                           IRON
                        </button>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-orange-500/5 rounded-2xl border border-orange-500/10">
                     <p className="text-[10px] font-bold text-orange-400 uppercase mb-2 tracking-widest">The Secret</p>
                     <p className="text-[10px] text-slate-400 leading-tight">
                        An iron core concentrates the magnetic field lines because it has high <strong>permeability</strong>. This can make the magnet 100x stronger!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BASIC MOTOR RENDERER ---
   const BasicMotorRenderer = () => {
      const [speed, setSpeed] = useState(0);
      const [rotation, setRotation] = useState(0);

      useEffect(() => {
         if (speed === 0) return;
         const interval = setInterval(() => {
            setRotation(prev => (prev + speed) % 360);
         }, 16);
         return () => clearInterval(interval);
      }, [speed]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">DC MOTOR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Lorentz Force & Commutation</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">RPM (est.)</p>
                  <p className="text-sm font-black text-white">{speed * 60}</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="400" height="300" className="overflow-visible">
                  {/* Stator Magnets */}
                  <rect x="50" y="100" width="40" height="100" fill="#ef4444" rx="4" />
                  <text x="70" y="155" textAnchor="middle" className="text-xl font-black fill-white">N</text>
                  <rect x="310" y="100" width="40" height="100" fill="#3b82f6" rx="4" />
                  <text x="330" y="155" textAnchor="middle" className="text-xl font-black fill-white">S</text>

                  {/* Rotor (Armature) */}
                  <g transform={`rotate(${rotation}, 200, 150)`}>
                     <rect x="150" y="140" width="100" height="20" fill="#b45309" rx="2" stroke="#78350f" />
                     <rect x="195" y="100" width="10" height="100" fill="#b45309" rx="2" stroke="#78350f" />
                     {/* Force Arrows */}
                     {speed > 0 && (
                        <g>
                           <path d="M 150,140 L 150,100" stroke="#10b981" strokeWidth="4" markerEnd="url(#arrowhead)" />
                           <path d="M 250,160 L 250,200" stroke="#10b981" strokeWidth="4" markerEnd="url(#arrowhead)" />
                        </g>
                     )}
                  </g>

                  {/* Commutator & Brushes */}
                  <circle cx="200" cy="150" r="15" fill="#94a3b8" stroke="#475569" />
                  <path d="M 180,150 L 170,150 M 220,150 L 230,150" stroke="#475569" strokeWidth="4" />

                  <defs>
                     <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                     </marker>
                  </defs>
               </svg>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex flex-col gap-4">
                  <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest text-center">Throttle (Current)</label>
                  <input
                     type="range"
                     min="0"
                     max="10"
                     step="1"
                     value={speed}
                     onChange={(e) => setSpeed(parseInt(e.target.value))}
                     className="w-full accent-blue-500"
                  />
                  <div className="flex justify-between text-[10px] font-bold text-slate-500">
                     <span>OFF</span>
                     <span>{speed === 0 ? 'STOPPED' : 'RUNNING'}</span>
                     <span>MAX POWER</span>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BASIC GENERATOR RENDERER ---
   const BasicGeneratorRenderer = () => {
      const [rotation, setRotation] = useState(0);
      const [isSpinning, setIsSpinning] = useState(false);

      useEffect(() => {
         if (!isSpinning) return;
         const interval = setInterval(() => {
            setRotation(prev => (prev + 5) % 360);
         }, 16);
         return () => clearInterval(interval);
      }, [isSpinning]);

      const voltage = Math.sin(rotation * (Math.PI / 180)) * 10;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">AC GENERATOR</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Faraday's Law & Induction</p>
               </div>
               <div className="bg-yellow-500/10 px-4 py-2 rounded-xl border border-yellow-500/20">
                  <p className="text-[8px] font-black text-yellow-400 uppercase tracking-widest">Output Voltage</p>
                  <p className="text-sm font-black text-white">{voltage.toFixed(2)} V</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <svg width="400" height="300" className="overflow-visible">
                     {/* Magnets */}
                     <rect x="50" y="100" width="40" height="100" fill="#ef4444" rx="4" />
                     <rect x="310" y="100" width="40" height="100" fill="#3b82f6" rx="4" />

                     {/* Rotating Coil */}
                     <g transform={`rotate(${rotation}, 200, 150)`}>
                        <rect x="150" y="100" width="100" height="100" fill="none" stroke="#fbbf24" strokeWidth="4" rx="4" />
                        {/* Flux Lines (Visual) */}
                        <line x1="150" y1="150" x2="250" y2="150" stroke="#fbbf24" strokeWidth="1" strokeDasharray="4 4" />
                     </g>

                     {/* Slip Rings */}
                     <circle cx="200" cy="250" r="10" fill="none" stroke="#94a3b8" strokeWidth="2" />
                     <circle cx="200" cy="270" r="10" fill="none" stroke="#94a3b8" strokeWidth="2" />
                  </svg>
               </div>

               {/* Oscilloscope */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-hidden border-t lg:border-t-0 border-slate-800">
                  <div className="flex-1 bg-slate-950 rounded-2xl border border-slate-800 relative overflow-hidden">
                     <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 pointer-events-none">
                        {Array.from({ length: 16 }).map((_, i) => (
                           <div key={i} className="border border-slate-900/50" />
                        ))}
                     </div>
                     {/* Sine Wave */}
                     <svg className="absolute inset-0 w-full h-full">
                        <path
                           d={Array.from({ length: 100 }).map((_, i) => {
                              const x = (i / 100) * 320;
                              const y = 80 + Math.sin((i / 10 + rotation / 10) * Math.PI) * 50;
                              return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                           }).join(' ')}
                           fill="none"
                           stroke="#fbbf24"
                           strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute top-2 left-2 text-[8px] font-black text-slate-500 uppercase tracking-widest">Oscilloscope</div>
                  </div>

                  <button
                     onClick={() => setIsSpinning(!isSpinning)}
                     className={`w-full py-4 rounded-2xl text-xs font-black transition-all ${isSpinning ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/40'}`}
                  >
                     {isSpinning ? 'STOP TURBINE' : 'START TURBINE'}
                  </button>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-500/10 flex items-center justify-center border border-yellow-500/20 shrink-0">
                     <span className="text-2xl">üåÄ</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A generator is just a motor in reverse! Instead of using electricity to make motion, we use <strong>motion to make electricity</strong> by spinning a coil through a magnetic field.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- EARTH FIELD RENDERER ---
   const EarthFieldRenderer = () => {
      const [showField, setShowField] = useState(true);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">GEOMAGNETISM</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Earth's Protective Shield</p>
               </div>
               <button
                  onClick={() => setShowField(!showField)}
                  className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${showField ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/40' : 'bg-slate-800 text-slate-500 border-slate-700'}`}
               >
                  {showField ? 'HIDE FIELD' : 'SHOW FIELD'}
               </button>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative">
                  {/* Earth */}
                  <div className="w-48 h-48 rounded-full bg-gradient-to-br from-blue-600 to-emerald-600 shadow-[0_0_50px_rgba(59,130,246,0.3)] relative overflow-hidden border-2 border-blue-400/20">
                     {/* Continents (Simplified) */}
                     <div className="absolute top-4 left-8 w-12 h-8 bg-emerald-500/40 rounded-full blur-sm" />
                     <div className="absolute top-20 left-20 w-16 h-12 bg-emerald-500/40 rounded-full blur-sm" />
                     <div className="absolute bottom-8 left-12 w-10 h-14 bg-emerald-500/40 rounded-full blur-sm" />

                     {/* Internal Magnet */}
                     <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-32 flex flex-col rounded-full overflow-hidden opacity-80 rotate-[11deg]">
                        <div className="flex-1 bg-blue-600 flex items-center justify-center text-[8px] font-black">S</div>
                        <div className="flex-1 bg-red-600 flex items-center justify-center text-[8px] font-black">N</div>
                     </div>
                  </div>

                  {/* Magnetic Field Lines */}
                  {showField && (
                     <svg className="absolute inset-0 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] pointer-events-none overflow-visible" style={{ left: '50%', top: '50%' }}>
                        <defs>
                           <linearGradient id="earth-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                              <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.2" />
                              <stop offset="50%" stopColor="#3b82f6" stopOpacity="0.05" />
                              <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.2" />
                           </linearGradient>
                        </defs>
                        <g transform="rotate(11, 300, 300)">
                           {Array.from({ length: 8 }).map((_, i) => (
                              <ellipse
                                 key={i}
                                 cx="300" cy="300"
                                 rx={100 + i * 40}
                                 ry={150 + i * 60}
                                 fill="none"
                                 stroke="url(#earth-grad)"
                                 strokeWidth="1.5"
                                 strokeDasharray="5 5"
                                 className="animate-[pulse_4s_infinite]"
                                 style={{ animationDelay: `${i * 0.5}s` }}
                              />
                           ))}
                        </g>
                     </svg>
                  )}

                  {/* Solar Wind (Visual) */}
                  <div className="absolute left-[-300px] top-1/2 -translate-y-1/2 flex flex-col gap-8 opacity-40">
                     {Array.from({ length: 5 }).map((_, i) => (
                        <div
                           key={i}
                           className="w-32 h-1 bg-gradient-to-r from-yellow-400 to-transparent rounded-full animate-[slide_2s_linear_infinite]"
                           style={{ animationDelay: `${i * 0.4}s` }}
                        />
                     ))}
                  </div>
               </div>

               <style>{`
                  @keyframes slide {
                     from { transform: translateX(0); }
                     to { transform: translateX(100px); }
                  }
               `}</style>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">üåç</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Earth is like a giant bar magnet! Its magnetic field (the <strong>magnetosphere</strong>) acts as a shield, deflecting harmful solar radiation and making life possible.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- HOUSEHOLD SAFETY RENDERER ---
   const HouseholdSafetyRenderer = () => {
      const [isOverloaded, setIsOverloaded] = useState(false);
      const [breakerTripped, setBreakerTripped] = useState(false);
      const [appliances, setAppliances] = useState({
         toaster: false,
         microwave: false,
         kettle: false
      });

      const totalCurrent = (appliances.toaster ? 8 : 0) + (appliances.microwave ? 10 : 0) + (appliances.kettle ? 9 : 0);
      const limit = 20;

      useEffect(() => {
         if (totalCurrent > limit && !breakerTripped) {
            setIsOverloaded(true);
            const timer = setTimeout(() => {
               setBreakerTripped(true);
               setIsOverloaded(false);
            }, 1000);
            return () => clearTimeout(timer);
         }
      }, [totalCurrent, breakerTripped]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-400">ELECTRICAL SAFETY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Breakers & Overloads</p>
               </div>
               <div className="flex gap-4">
                  <div className={`px-4 py-2 rounded-xl border transition-all ${breakerTripped ? 'bg-red-500/20 border-red-500/30' : 'bg-emerald-500/20 border-emerald-500/30'}`}>
                     <p className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Breaker Status</p>
                     <p className={`text-sm font-black ${breakerTripped ? 'text-red-400' : 'text-emerald-400'}`}>
                        {breakerTripped ? 'TRIPPED' : 'ACTIVE'}
                     </p>
                  </div>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               {/* Circuit Board */}
               <div className="w-full max-w-2xl bg-slate-900/50 rounded-3xl border border-slate-800 p-8">
                  <div className="flex justify-between items-end gap-8">
                     {/* Appliances */}
                     {Object.entries(appliances).map(([name, active]) => (
                        <button
                           key={name}
                           onClick={() => !breakerTripped && setAppliances(prev => ({ ...prev, [name]: !active }))}
                           className={`flex-1 p-6 rounded-2xl border transition-all flex flex-col items-center gap-4 ${active ? 'bg-slate-800 border-slate-600' : 'bg-slate-950 border-slate-800'}`}
                        >
                           <span className="text-3xl">{name === 'toaster' ? 'üçû' : name === 'microwave' ? 'üç±' : 'ü´ñ'}</span>
                           <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">{name}</span>
                           <span className={`text-[10px] font-bold ${active ? 'text-emerald-400' : 'text-slate-700'}`}>{active ? 'ON' : 'OFF'}</span>
                        </button>
                     ))}
                  </div>

                  {/* Meter */}
                  <div className="mt-12 p-6 bg-slate-950 rounded-2xl border border-slate-800">
                     <div className="flex justify-between items-center mb-4">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Load</span>
                        <span className={`text-xl font-black ${totalCurrent > limit ? 'text-red-500' : 'text-white'}`}>{breakerTripped ? 0 : totalCurrent} / {limit} Amps</span>
                     </div>
                     <div className="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-800">
                        <div
                           className={`h-full transition-all duration-500 ${totalCurrent > limit ? 'bg-red-500' : 'bg-emerald-500'}`}
                           style={{ width: `${breakerTripped ? 0 : (totalCurrent / limit) * 100}%` }}
                        />
                     </div>
                  </div>
               </div>

               {breakerTripped && (
                  <button
                     onClick={() => {
                        setBreakerTripped(false);
                        setAppliances({ toaster: false, microwave: false, kettle: false });
                     }}
                     className="mt-8 px-8 py-3 bg-red-500 text-white rounded-xl font-black text-xs shadow-lg shadow-red-500/40 animate-bounce"
                  >
                     RESET CIRCUIT BREAKER
                  </button>
               )}
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üõ°Ô∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     A <strong>circuit breaker</strong> is a safety switch. If too many appliances are on at once, the wire gets hot and could start a fire. The breaker "trips" to cut the power before that happens!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- COULOMB'S LAW RENDERER ---
   const CoulombsLawRenderer = () => {
      const [q1, setQ1] = useState(5); // microCoulombs
      const [q2, setQ2] = useState(-5);
      const [distance, setDistance] = useState(10); // cm

      const k = 8.987e9;
      const force = (k * Math.abs(q1 * 1e-6 * q2 * 1e-6)) / Math.pow(distance * 1e-2, 2);
      const isAttractive = (q1 > 0 && q2 < 0) || (q1 < 0 && q2 > 0);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">COULOMB'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Electrostatic Force</p>
               </div>
               <div className="bg-purple-500/10 px-4 py-2 rounded-xl border border-purple-500/20">
                  <p className="text-[8px] font-black text-purple-400 uppercase tracking-widest">Force (F)</p>
                  <p className="text-sm font-black text-white">{force.toFixed(2)} Newtons</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <div className="relative w-full max-w-2xl h-64 flex items-center justify-between px-20">
                  {/* Charge 1 */}
                  <div
                     className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 ${q1 > 0 ? 'bg-red-500 shadow-red-500/50' : 'bg-blue-500 shadow-blue-500/50'}`}
                     style={{ transform: `scale(${0.8 + Math.abs(q1) / 20})` }}
                  >
                     <span className="text-xl font-black">{q1 > 0 ? '+' : '-'}{Math.abs(q1)}</span>
                  </div>

                  {/* Force Arrows */}
                  <div className="flex-1 flex items-center justify-center relative">
                     <div className="w-full h-1 bg-slate-800 absolute top-1/2 -translate-y-1/2" />
                     <div
                        className={`absolute top-1/2 -translate-y-1/2 flex items-center gap-2 transition-all duration-500 ${isAttractive ? 'flex-row' : 'flex-row-reverse'}`}
                        style={{ width: `${100 - distance * 2}%` }}
                     >
                        <div className={`w-8 h-8 border-t-4 border-r-4 border-purple-500 ${isAttractive ? 'rotate-45' : '-rotate-[135deg]'}`} />
                        <div className="flex-1 h-1 bg-purple-500 animate-pulse" />
                        <div className={`w-8 h-8 border-t-4 border-r-4 border-purple-500 ${isAttractive ? '-rotate-[135deg]' : 'rotate-45'}`} />
                     </div>
                  </div>

                  {/* Charge 2 */}
                  <div
                     className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 ${q2 > 0 ? 'bg-red-500 shadow-red-500/50' : 'bg-blue-500 shadow-blue-500/50'}`}
                     style={{ transform: `scale(${0.8 + Math.abs(q2) / 20})` }}
                  >
                     <span className="text-xl font-black">{q2 > 0 ? '+' : '-'}{Math.abs(q2)}</span>
                  </div>
               </div>

               {/* Distance Label */}
               <div className="absolute bottom-20 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                  Distance: {distance} cm
               </div>
            </div>

            {/* Controls */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-4xl mx-auto grid grid-cols-3 gap-8">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-red-400 uppercase tracking-widest">Charge 1 (ŒºC)</label>
                     <input
                        type="range"
                        min="-10"
                        max="10"
                        value={q1}
                        onChange={(e) => setQ1(parseInt(e.target.value))}
                        className="w-full accent-red-500"
                     />
                  </div>
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Charge 2 (ŒºC)</label>
                     <input
                        type="range"
                        min="-10"
                        max="10"
                        value={q2}
                        onChange={(e) => setQ2(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                  </div>
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Distance (cm)</label>
                     <input
                        type="range"
                        min="5"
                        max="50"
                        value={distance}
                        onChange={(e) => setDistance(parseInt(e.target.value))}
                        className="w-full accent-purple-500"
                     />
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- ELECTRIC FIELD RENDERER ---
   const ElectricFieldRenderer = () => {
      const [charges, setCharges] = useState([
         { x: 150, y: 150, q: 1 },
         { x: 350, y: 150, q: -1 }
      ]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-cyan-400">ELECTRIC FIELD MAP</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Vector Fields & Flux</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden">
               <svg width="500" height="300" className="overflow-visible">
                  {/* Field Vectors (Simplified Grid) */}
                  {Array.from({ length: 10 }).map((_, i) => (
                     Array.from({ length: 6 }).map((_, j) => {
                        const px = 50 + i * 45;
                        const py = 40 + j * 45;

                        // Calculate net field at this point
                        let ex = 0;
                        let ey = 0;
                        charges.forEach(c => {
                           const dx = px - c.x;
                           const dy = py - c.y;
                           const r2 = dx * dx + dy * dy;
                           const r = Math.sqrt(r2);
                           const f = c.q / (r2 * r);
                           ex += f * dx;
                           ey += f * dy;
                        });

                        const angle = Math.atan2(ey, ex) * (180 / Math.PI);
                        const mag = Math.sqrt(ex * ex + ey * ey);
                        const opacity = Math.min(0.6, mag * 100000);

                        return (
                           <g key={`${i}-${j}`} transform={`translate(${px}, ${py}) rotate(${angle})`} opacity={opacity}>
                              <path d="M -5,0 L 5,0 M 2,-3 L 5,0 L 2,3" fill="none" stroke="#22d3ee" strokeWidth="1" />
                           </g>
                        );
                     })
                  ))}

                  {/* Charges */}
                  {charges.map((c, i) => (
                     <circle
                        key={i}
                        cx={c.x} cy={c.y} r="12"
                        fill={c.q > 0 ? '#ef4444' : '#3b82f6'}
                        className="cursor-pointer"
                        onClick={() => {
                           const newCharges = [...charges];
                           newCharges[i].q *= -1;
                           setCharges(newCharges);
                        }}
                     />
                  ))}
               </svg>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center border border-cyan-500/20 shrink-0">
                     <span className="text-2xl">üìç</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     Electric field lines always point <strong>away from positive</strong> charges and <strong>towards negative</strong> charges. The closer the lines, the stronger the field!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- CAPACITOR LAB RENDERER ---
   const CapacitorLabRenderer = () => {
      const [area, setArea] = useState(200); // mm^2
      const [separation, setSeparation] = useState(5); // mm
      const [voltage, setVoltage] = useState(5);

      const epsilon0 = 8.854e-12;
      const capacitance = (epsilon0 * area * 1e-6) / (separation * 1e-3);
      const charge = capacitance * voltage;
      const energy = 0.5 * capacitance * voltage * voltage;

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-400">CAPACITOR LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Dielectrics & Energy Storage</p>
               </div>
               <div className="flex gap-4">
                  <div className="bg-emerald-500/10 px-4 py-2 rounded-xl border border-emerald-500/20 text-right">
                     <p className="text-[8px] font-black text-emerald-400 uppercase tracking-widest">Capacitance</p>
                     <p className="text-sm font-black text-white">{(capacitance * 1e12).toFixed(2)} pF</p>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  <div className="relative flex flex-col items-center gap-4">
                     {/* Top Plate */}
                     <div
                        className="h-4 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center relative shadow-[0_0_20px_rgba(16,185,129,0.2)]"
                        style={{ width: `${area / 2}px`, transform: `translateY(${-separation * 5}px)` }}
                     >
                        {Array.from({ length: Math.floor(charge * 1e11) }).map((_, i) => (
                           <div key={i} className="w-1 h-1 bg-red-500 rounded-full mx-0.5" />
                        ))}
                        <div className="absolute -top-6 text-[8px] font-black text-red-400">+ CHARGE</div>
                     </div>

                     {/* Bottom Plate */}
                     <div
                        className="h-4 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center relative shadow-[0_0_20px_rgba(16,185,129,0.2)]"
                        style={{ width: `${area / 2}px`, transform: `translateY(${separation * 5}px)` }}
                     >
                        {Array.from({ length: Math.floor(charge * 1e11) }).map((_, i) => (
                           <div key={i} className="w-1 h-1 bg-blue-500 rounded-full mx-0.5" />
                        ))}
                        <div className="absolute -bottom-6 text-[8px] font-black text-blue-400">- CHARGE</div>
                     </div>

                     {/* Field Lines */}
                     <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        {Array.from({ length: 10 }).map((_, i) => (
                           <div
                              key={i}
                              className="w-0.5 bg-emerald-500/20 absolute"
                              style={{
                                 height: `${separation * 10}px`,
                                 left: `${(i * 10) + (50 - (10 * 5))}%`
                              }}
                           />
                        ))}
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Plate Area (A)</label>
                     <input
                        type="range"
                        min="100"
                        max="400"
                        value={area}
                        onChange={(e) => setArea(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>100 mm¬≤</span>
                        <span>{area} mm¬≤</span>
                        <span>400 mm¬≤</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Separation (d)</label>
                     <input
                        type="range"
                        min="2"
                        max="20"
                        value={separation}
                        onChange={(e) => setSeparation(parseInt(e.target.value))}
                        className="w-full accent-emerald-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>2 mm</span>
                        <span>{separation} mm</span>
                        <span>20 mm</span>
                     </div>
                  </div>

                  <div className="p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10">
                     <p className="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest">Stored Energy</p>
                     <p className="text-xl font-black text-white">{(energy * 1e9).toFixed(2)} nJ</p>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-slate-800/50 rounded-2xl border border-slate-700">
                     <p className="text-[10px] text-slate-400 leading-tight">
                        Capacitance increases with <strong>Area</strong> and decreases with <strong>Separation</strong>. It's like a bucket for electric charge!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- RLC CIRCUIT RENDERER ---
   const RLCCircuitRenderer = () => {
      const [frequency, setFrequency] = useState(60); // Hz
      const [resistance, setResistance] = useState(10); // Ohms
      const [inductance, setInductance] = useState(0.1); // Henrys
      const [capacitance, setCapacitance] = useState(100); // microFarads

      const omega = 2 * Math.PI * frequency;
      const xl = omega * inductance;
      const xc = 1 / (omega * capacitance * 1e-6);
      const impedance = Math.sqrt(Math.pow(resistance, 2) + Math.pow(xl - xc, 2));
      const phase = Math.atan((xl - xc) / resistance) * (180 / Math.PI);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-400">RLC CIRCUIT LAB</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Impedance & Resonance</p>
               </div>
               <div className="bg-blue-500/10 px-4 py-2 rounded-xl border border-blue-500/20">
                  <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">Impedance (Z)</p>
                  <p className="text-sm font-black text-white">{impedance.toFixed(2)} Œ©</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Visualizer */}
               <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden border-r border-slate-900">
                  {/* Phasor Diagram */}
                  <div className="relative w-64 h-64 border-2 border-slate-800 rounded-full">
                     <div className="absolute inset-0 flex items-center justify-center">
                        {/* R Vector */}
                        <div
                           className="h-1 bg-emerald-500 absolute origin-left"
                           style={{ width: `${resistance * 5}px`, transform: 'rotate(0deg)' }}
                        />
                        {/* XL Vector */}
                        <div
                           className="h-1 bg-red-500 absolute origin-left"
                           style={{ width: `${xl * 2}px`, transform: 'rotate(-90deg)' }}
                        />
                        {/* XC Vector */}
                        <div
                           className="h-1 bg-blue-500 absolute origin-left"
                           style={{ width: `${xc * 2}px`, transform: 'rotate(90deg)' }}
                        />
                        {/* Z Vector */}
                        <div
                           className="h-1.5 bg-white absolute origin-left shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                           style={{ width: `${impedance * 5}px`, transform: `rotate(${-phase}deg)` }}
                        />
                     </div>
                     <div className="absolute top-2 left-2 text-[8px] font-black text-slate-500 uppercase">Phasor Diagram</div>
                  </div>

                  <div className="mt-12 grid grid-cols-3 gap-8 text-center">
                     <div>
                        <p className="text-[8px] font-black text-red-400 uppercase tracking-widest">X_L</p>
                        <p className="text-lg font-black">{xl.toFixed(1)}Œ©</p>
                     </div>
                     <div>
                        <p className="text-[8px] font-black text-blue-400 uppercase tracking-widest">X_C</p>
                        <p className="text-lg font-black">{xc.toFixed(1)}Œ©</p>
                     </div>
                     <div>
                        <p className="text-[8px] font-black text-white uppercase tracking-widest">Phase</p>
                        <p className="text-lg font-black">{phase.toFixed(1)}¬∞</p>
                     </div>
                  </div>
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-slate-900/30 p-6 flex flex-col gap-6 overflow-y-auto border-t lg:border-t-0 border-slate-800">
                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Frequency (f)</label>
                     <input
                        type="range"
                        min="10"
                        max="200"
                        value={frequency}
                        onChange={(e) => setFrequency(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                     <div className="flex justify-between text-[10px] font-bold text-slate-500">
                        <span>10 Hz</span>
                        <span>{frequency} Hz</span>
                        <span>200 Hz</span>
                     </div>
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Inductance (L)</label>
                     <input
                        type="range"
                        min="0.01"
                        max="0.5"
                        step="0.01"
                        value={inductance}
                        onChange={(e) => setInductance(parseFloat(e.target.value))}
                        className="w-full accent-red-500"
                     />
                  </div>

                  <div className="space-y-4">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Capacitance (C)</label>
                     <input
                        type="range"
                        min="10"
                        max="500"
                        value={capacitance}
                        onChange={(e) => setCapacitance(parseInt(e.target.value))}
                        className="w-full accent-blue-500"
                     />
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-blue-500/5 rounded-2xl border border-blue-500/10">
                     <p className="text-[10px] text-slate-400 leading-tight">
                        Resonance occurs when <strong>X_L = X_C</strong>. At this point, the impedance is at its minimum and equal to the resistance!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- FARADAY'S LAW RENDERER ---
   const FaradaysLawRenderer = () => {
      const [magnetPos, setMagnetPos] = useState(0);
      const [isMoving, setIsMoving] = useState(false);
      const [inducedVoltage, setInducedVoltage] = useState(0);

      useEffect(() => {
         if (!isMoving) {
            setInducedVoltage(0);
            return;
         }
         const interval = setInterval(() => {
            setMagnetPos(prev => {
               const next = prev + 5;
               if (next > 400) {
                  setIsMoving(false);
                  return 0;
               }
               // Voltage is proportional to velocity (rate of change of flux)
               setInducedVoltage(Math.sin(next / 20) * 10);
               return next;
            });
         }, 16);
         return () => clearInterval(interval);
      }, [isMoving]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-400">FARADAY'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Magnetic Induction</p>
               </div>
               <div className="bg-orange-500/10 px-4 py-2 rounded-xl border border-orange-500/20">
                  <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest">Induced EMF (Œµ)</p>
                  <p className="text-sm font-black text-white">{inducedVoltage.toFixed(2)} V</p>
               </div>
            </div>

            <div className="flex-1 relative bg-slate-950 flex flex-col items-center justify-center p-8 overflow-hidden">
               <svg width="500" height="300" className="overflow-visible">
                  {/* Coil */}
                  <g transform="translate(250, 150)">
                     {Array.from({ length: 5 }).map((_, i) => (
                        <ellipse
                           key={i}
                           cx={-20 + i * 10} cy="0"
                           rx="20" ry="60"
                           fill="none"
                           stroke="#b45309"
                           strokeWidth="3"
                           strokeOpacity={0.8}
                        />
                     ))}
                  </g>

                  {/* Magnet */}
                  <g transform={`translate(${magnetPos}, 150)`}>
                     <rect x="-60" y="-20" width="60" height="40" fill="#ef4444" rx="4" />
                     <rect x="0" y="-20" width="60" height="40" fill="#3b82f6" rx="4" />
                     <text x="-30" y="5" textAnchor="middle" className="text-xs font-black fill-white">N</text>
                     <text x="30" y="5" textAnchor="middle" className="text-xs font-black fill-white">S</text>

                     {/* Magnetic Field Lines (Visual) */}
                     {Array.from({ length: 6 }).map((_, i) => (
                        <path
                           key={i}
                           d={`M 60,${-15 + i * 6} Q 100,${-30 + i * 12} 140,${-15 + i * 6}`}
                           fill="none"
                           stroke="#fb923c"
                           strokeWidth="1"
                           strokeOpacity="0.3"
                        />
                     ))}
                  </g>

                  {/* Galvanometer */}
                  <g transform="translate(250, 250)">
                     <rect x="-50" y="-30" width="100" height="60" fill="#1e293b" rx="8" stroke="#334155" />
                     <path d="M -40,10 Q 0,-40 40,10" fill="none" stroke="#475569" strokeWidth="2" />
                     <line
                        x1="0" y1="10"
                        x2={inducedVoltage * 4} y2="-20"
                        stroke="#ef4444"
                        strokeWidth="3"
                        className="transition-all duration-100"
                     />
                     <text x="0" y="20" textAnchor="middle" className="text-[8px] font-black fill-slate-500">GALVANOMETER</text>
                  </g>
               </svg>

               <button
                  onClick={() => setIsMoving(true)}
                  disabled={isMoving}
                  className={`mt-8 px-8 py-3 rounded-xl font-black text-xs transition-all ${isMoving ? 'bg-slate-800 text-slate-500' : 'bg-orange-500 text-white shadow-lg shadow-orange-500/40'}`}
               >
                  {isMoving ? 'INDUCING CURRENT...' : 'PUSH MAGNET THROUGH COIL'}
               </button>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üß≤</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Lenz's Law</strong>: The induced current creates a magnetic field that <strong>opposes</strong> the change that created it. Nature doesn't like change!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MAGNETIC FLUX RENDERER ---
   const MagneticFluxRenderer = () => {
      const [angle, setAngle] = useState(0);
      const [fieldStrength, setFieldStrength] = useState(0.5);
      const [loopArea, setLoopArea] = useState(0.1);
      const [isAnimating, setIsAnimating] = useState(false);

      const flux = fieldStrength * loopArea * Math.cos(angle * Math.PI / 180);

      useEffect(() => {
         if (!isAnimating) return;
         const interval = setInterval(() => {
            setAngle(prev => (prev + 2) % 360);
         }, 50);
         return () => clearInterval(interval);
      }, [isAnimating]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50">
               <h3 className="text-xl font-black tracking-tight text-cyan-400">MAGNETIC FLUX</h3>
               <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Œ¶ = BA cos Œ∏</p>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 relative flex items-center justify-center p-8">
                  <svg width="400" height="350" viewBox="0 0 400 350">
                     {/* Magnetic field lines */}
                     {Array.from({ length: 8 }).map((_, i) => (
                        <line key={i} x1="50" y1={70 + i * 30} x2="350" y2={70 + i * 30}
                           stroke="#3b82f6" strokeWidth="2" strokeOpacity={0.3 + fieldStrength * 0.5}
                           markerEnd="url(#arrowB)" />
                     ))}
                     <defs>
                        <marker id="arrowB" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                           <path d="M0,0 L6,3 L0,6 Z" fill="#3b82f6" fillOpacity={0.5 + fieldStrength * 0.5} />
                        </marker>
                     </defs>

                     {/* Loop */}
                     <g transform={`translate(200, 180) rotate(${angle})`}>
                        <ellipse cx="0" cy="0" rx={80 * loopArea * 10} ry="60" fill="none"
                           stroke="#fbbf24" strokeWidth="4" />
                        <line x1="0" y1="-60" x2="0" y2="-100" stroke="#fbbf24" strokeWidth="2" />
                        <polygon points="0,-100 -6,-88 6,-88" fill="#fbbf24" />
                        <text x="15" y="-85" className="text-[10px] font-bold fill-fbbf24">nÃÇ</text>
                     </g>

                     {/* Angle arc */}
                     <path d={`M 200,120 A 60,60 0 0 1 ${200 + 60 * Math.sin(angle * Math.PI / 180)},${120 - 60 * Math.cos(angle * Math.PI / 180)}`}
                        fill="none" stroke="#22c55e" strokeWidth="2" strokeDasharray="4" />
                     <text x="220" y="105" className="text-xs font-bold fill-emerald-400">Œ∏ = {angle}¬∞</text>
                  </svg>
               </div>

               <div className="w-full md:w-80 bg-slate-900/50 border-l border-slate-800 p-6 flex flex-col gap-6">
                  <div className="p-4 bg-gradient-to-br from-cyan-900/30 to-cyan-800/20 rounded-2xl border border-cyan-500/20">
                     <p className="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-2">Magnetic Flux</p>
                     <p className="text-3xl font-black text-white">{(flux * 1000).toFixed(2)} <span className="text-sm text-slate-400">mWb</span></p>
                  </div>

                  <div className="space-y-4">
                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Angle (Œ∏)</label>
                           <span className="text-xs font-mono text-cyan-400">{angle}¬∞</span>
                        </div>
                        <input type="range" min="0" max="360" value={angle} onChange={(e) => setAngle(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Field Strength (B)</label>
                           <span className="text-xs font-mono text-cyan-400">{fieldStrength.toFixed(2)} T</span>
                        </div>
                        <input type="range" min="0.1" max="1" step="0.05" value={fieldStrength}
                           onChange={(e) => setFieldStrength(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>

                     <div>
                        <div className="flex justify-between mb-2">
                           <label className="text-xs font-bold text-slate-400">Loop Area (A)</label>
                           <span className="text-xs font-mono text-cyan-400">{loopArea.toFixed(2)} m¬≤</span>
                        </div>
                        <input type="range" min="0.05" max="0.2" step="0.01" value={loopArea}
                           onChange={(e) => setLoopArea(Number(e.target.value))}
                           className="w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500" />
                     </div>
                  </div>

                  <button onClick={() => setIsAnimating(!isAnimating)}
                     className={`w-full py-3 rounded-xl font-black text-xs transition-all ${isAnimating
                        ? 'bg-red-500/20 text-red-400 border border-red-500/30'
                        : 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/30'}`}>
                     {isAnimating ? '‚è∏ STOP ROTATION' : '‚ñ∂ ROTATE LOOP'}
                  </button>

                  <div className="mt-auto p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                     <p className="text-xs text-slate-400 leading-relaxed">
                        <strong className="text-cyan-400">KEY INSIGHT:</strong> Flux is maximum when the loop is perpendicular to the field (Œ∏=0¬∞) and zero when parallel (Œ∏=90¬∞).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- LENZ'S LAW RENDERER ---
   const LenzsLawRenderer = () => {
      const [magnetPosition, setMagnetPosition] = useState(0);
      const [magnetDirection, setMagnetDirection] = useState<'approaching' | 'receding' | 'stationary'>('stationary');
      const [inducedCurrent, setInducedCurrent] = useState(0);
      const [coilPolarity, setCoilPolarity] = useState<'N' | 'S' | null>(null);

      useEffect(() => {
         if (magnetDirection === 'stationary') {
            setInducedCurrent(0);
            setCoilPolarity(null);
            return;
         }

         const interval = setInterval(() => {
            setMagnetPosition(prev => {
               const delta = magnetDirection === 'approaching' ? 3 : -3;
               const next = prev + delta;

               if (next > 150 || next < -150) {
                  setMagnetDirection('stationary');
                  return 0;
               }

               const currentMagnitude = Math.abs(delta) * 2;
               setInducedCurrent(magnetDirection === 'approaching' ? -currentMagnitude : currentMagnitude);
               setCoilPolarity(magnetDirection === 'approaching' ? 'N' : 'S');
               return next;
            });
         }, 30);

         return () => clearInterval(interval);
      }, [magnetDirection]);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-purple-400">LENZ'S LAW</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Induced Current Opposes Change</p>
               </div>
               <div className={`px-4 py-2 rounded-xl border ${inducedCurrent !== 0
                  ? 'bg-yellow-500/10 border-yellow-500/30'
                  : 'bg-slate-800 border-slate-700'}`}>
                  <p className="text-[8px] font-black text-slate-400 uppercase">Induced Current</p>
                  <p className={`text-lg font-black ${inducedCurrent > 0 ? 'text-green-400' : inducedCurrent < 0 ? 'text-red-400' : 'text-slate-500'}`}>
                     {inducedCurrent > 0 ? '‚Üª ' : inducedCurrent < 0 ? '‚Ü∫ ' : ''}{Math.abs(inducedCurrent).toFixed(1)} A
                  </p>
               </div>
            </div>

            <div className="flex-1 flex flex-col items-center justify-center p-8 relative">
               <svg width="500" height="280" viewBox="0 0 500 280">
                  {/* Coil */}
                  <g transform="translate(250, 140)">
                     {Array.from({ length: 8 }).map((_, i) => (
                        <ellipse key={i} cx={-35 + i * 10} cy="0" rx="25" ry="70"
                           fill="none" stroke={inducedCurrent !== 0 ? '#fbbf24' : '#64748b'}
                           strokeWidth="3" strokeOpacity={0.8} />
                     ))}
                     {coilPolarity && (
                        <text x="-70" y="10" className="text-2xl font-black"
                           fill={coilPolarity === 'N' ? '#ef4444' : '#3b82f6'}>{coilPolarity}</text>
                     )}
                  </g>

                  {/* Magnet */}
                  <g transform={`translate(${80 + magnetPosition}, 140)`}>
                     <rect x="-50" y="-25" width="50" height="50" fill="#ef4444" rx="4" />
                     <rect x="0" y="-25" width="50" height="50" fill="#3b82f6" rx="4" />
                     <text x="-25" y="8" textAnchor="middle" className="text-lg font-black fill-white">N</text>
                     <text x="25" y="8" textAnchor="middle" className="text-lg font-black fill-white">S</text>
                     {magnetDirection !== 'stationary' && (
                        <text x={magnetDirection === 'approaching' ? 70 : -70} y="8"
                           className="text-2xl" fill="#22c55e">{magnetDirection === 'approaching' ? '‚Üí' : '‚Üê'}</text>
                     )}
                  </g>

                  {/* Field lines from coil (when current flows) */}
                  {inducedCurrent !== 0 && (
                     <g transform="translate(250, 140)" opacity={0.4}>
                        {Array.from({ length: 5 }).map((_, i) => (
                           <path key={i} d={`M -80,${-30 + i * 15} Q -120,${-50 + i * 25} -80,${-30 + i * 15 + 30}`}
                              fill="none" stroke={coilPolarity === 'N' ? '#ef4444' : '#3b82f6'} strokeWidth="2" />
                        ))}
                     </g>
                  )}
               </svg>

               <div className="flex gap-4 mt-8">
                  <button onClick={() => { setMagnetPosition(-150); setMagnetDirection('approaching'); }}
                     disabled={magnetDirection !== 'stationary'}
                     className={`px-6 py-3 rounded-xl font-black text-xs transition-all ${magnetDirection !== 'stationary'
                        ? 'bg-slate-800 text-slate-600'
                        : 'bg-green-500 text-white shadow-lg shadow-green-500/30 hover:bg-green-400'}`}>
                     PUSH MAGNET IN ‚Üí
                  </button>
                  <button onClick={() => { setMagnetPosition(150); setMagnetDirection('receding'); }}
                     disabled={magnetDirection !== 'stationary'}
                     className={`px-6 py-3 rounded-xl font-black text-xs transition-all ${magnetDirection !== 'stationary'
                        ? 'bg-slate-800 text-slate-600'
                        : 'bg-red-500 text-white shadow-lg shadow-red-500/30 hover:bg-red-400'}`}>
                     ‚Üê PULL MAGNET OUT
                  </button>
               </div>

               <div className="mt-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700 max-w-lg text-center">
                  {magnetDirection === 'approaching' && (
                     <p className="text-sm text-slate-300">
                        <span className="text-purple-400 font-bold">APPROACHING:</span> Flux ‚Üë ‚Üí Coil creates <span className="text-red-400 font-bold">N pole</span> to REPEL incoming magnet
                     </p>
                  )}
                  {magnetDirection === 'receding' && (
                     <p className="text-sm text-slate-300">
                        <span className="text-purple-400 font-bold">RECEDING:</span> Flux ‚Üì ‚Üí Coil creates <span className="text-blue-400 font-bold">S pole</span> to ATTRACT departing magnet
                     </p>
                  )}
                  {magnetDirection === 'stationary' && (
                     <p className="text-sm text-slate-500">Move the magnet to see Lenz's Law in action!</p>
                  )}
               </div>
            </div>

            <div className="p-6 bg-slate-900/50 border-t border-slate-800">
               <p className="text-xs text-slate-400 text-center">
                  <strong className="text-purple-400">KEY INSIGHT:</strong> The induced current always creates a magnetic field that <strong>opposes</strong> the change in flux. This is nature's way of conserving energy!
               </p>
            </div>
         </div>
      );
   };


   // --- BATTERY CONNECTIONS RENDERER ---
   const BatteryConnectionsRenderer = () => {
      const [mode, setMode] = useState<'series' | 'parallel'>('series');
      const [numBatteries, setNumBatteries] = useState(2);
      const [singleVoltage] = useState(1.5);
      const [singleCapacity] = useState(2000);

      const totalVoltage = mode === 'series' ? singleVoltage * numBatteries : singleVoltage;
      const totalCapacity = mode === 'parallel' ? singleCapacity * numBatteries : singleCapacity;

      return (
         <div className="flex flex-col h-full bg-slate-100 text-slate-900 font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-200 bg-white flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-600">BATTERY CONNECTIONS</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Series vs Parallel</p>
               </div>
               <div className="flex gap-2">
                  <button onClick={() => setMode('series')}
                     className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${mode === 'series'
                        ? 'bg-amber-500 text-white shadow-lg'
                        : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                     SERIES
                  </button>
                  <button onClick={() => setMode('parallel')}
                     className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${mode === 'parallel'
                        ? 'bg-blue-500 text-white shadow-lg'
                        : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                     PARALLEL
                  </button>
               </div>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 flex items-center justify-center p-8 bg-slate-50">
                  <svg width="400" height="300" viewBox="0 0 400 300">
                     {mode === 'series' ? (
                        <g transform="translate(50, 150)">
                           {Array.from({ length: numBatteries }).map((_, i) => (
                              <g key={i} transform={`translate(${i * 80}, 0)`}>
                                 <rect x="0" y="-30" width="60" height="60" fill="#fef3c7" stroke="#f59e0b" strokeWidth="2" rx="4" />
                                 <line x1="10" y1="-15" x2="10" y2="15" stroke="#ef4444" strokeWidth="4" />
                                 <line x1="50" y1="-8" x2="50" y2="8" stroke="#1f2937" strokeWidth="4" />
                                 <text x="30" y="50" textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{singleVoltage}V</text>
                                 {i < numBatteries - 1 && <line x1="60" y1="0" x2="80" y2="0" stroke="#1f2937" strokeWidth="3" />}
                              </g>
                           ))}
                           <line x1="-20" y1="0" x2="0" y2="0" stroke="#ef4444" strokeWidth="3" />
                           <line x1={numBatteries * 80 - 20} y1="0" x2={numBatteries * 80} y2="0" stroke="#1f2937" strokeWidth="3" />
                           <text x={numBatteries * 40 - 10} y="-60" textAnchor="middle" className="text-lg font-black fill-amber-600">
                              Total: {totalVoltage.toFixed(1)}V
                           </text>
                        </g>
                     ) : (
                        <g transform="translate(100, 50)">
                           {Array.from({ length: numBatteries }).map((_, i) => (
                              <g key={i} transform={`translate(0, ${i * 70})`}>
                                 <rect x="50" y="0" width="60" height="50" fill="#dbeafe" stroke="#3b82f6" strokeWidth="2" rx="4" />
                                 <line x1="60" y1="10" x2="60" y2="40" stroke="#ef4444" strokeWidth="4" />
                                 <line x1="100" y1="15" x2="100" y2="35" stroke="#1f2937" strokeWidth="4" />
                                 <line x1="0" y1="25" x2="50" y2="25" stroke="#ef4444" strokeWidth="2" />
                                 <line x1="110" y1="25" x2="160" y2="25" stroke="#1f2937" strokeWidth="2" />
                              </g>
                           ))}
                           <line x1="0" y1="25" x2="0" y2={numBatteries * 70 - 45} stroke="#ef4444" strokeWidth="3" />
                           <line x1="160" y1="25" x2="160" y2={numBatteries * 70 - 45} stroke="#1f2937" strokeWidth="3" />
                           <text x="80" y={numBatteries * 70 + 20} textAnchor="middle" className="text-lg font-black fill-blue-600">
                              Total: {totalVoltage.toFixed(1)}V, {totalCapacity}mAh
                           </text>
                        </g>
                     )}
                  </svg>
               </div>

               <div className="w-full md:w-72 bg-white border-l border-slate-200 p-6 flex flex-col gap-4">
                  <div>
                     <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Number of Batteries</label>
                     <div className="flex gap-2">
                        {[2, 3, 4].map(n => (
                           <button key={n} onClick={() => setNumBatteries(n)}
                              className={`flex-1 py-2 rounded-lg font-bold text-sm ${numBatteries === n
                                 ? 'bg-slate-800 text-white'
                                 : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>

                  <div className="p-4 bg-amber-50 rounded-xl border border-amber-200">
                     <p className="text-[10px] font-black text-amber-700 uppercase mb-1">Series Connection</p>
                     <p className="text-sm text-amber-900">Voltages ADD: {numBatteries} √ó {singleVoltage}V = <strong>{(numBatteries * singleVoltage).toFixed(1)}V</strong></p>
                     <p className="text-xs text-amber-700 mt-1">Capacity stays the same</p>
                  </div>

                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-200">
                     <p className="text-[10px] font-black text-blue-700 uppercase mb-1">Parallel Connection</p>
                     <p className="text-sm text-blue-900">Voltage stays: <strong>{singleVoltage}V</strong></p>
                     <p className="text-sm text-blue-900">Capacity ADDS: {numBatteries} √ó {singleCapacity}mAh = <strong>{numBatteries * singleCapacity}mAh</strong></p>
                  </div>

                  <div className="mt-auto p-4 bg-slate-100 rounded-xl">
                     <p className="text-xs text-slate-600">
                        <strong className="text-slate-800">KEY INSIGHT:</strong> Series for more voltage (flashlights), parallel for longer life (power banks).
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- BULB POWER RENDERER ---
   const BulbPowerRenderer = () => {
      const [voltage, setVoltage] = useState(6);
      const [resistance] = useState(10);

      const current = voltage / resistance;
      const power = voltage * current;
      const brightness = Math.min(power / 10, 1);

      return (
         <div className="flex flex-col h-full bg-slate-900 text-white font-sans overflow-hidden">
            <div className="p-6 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">BULB POWER</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">P = V √ó I = V¬≤/R</p>
               </div>
               <div className="text-right">
                  <p className="text-[10px] font-bold text-slate-500">Power Output</p>
                  <p className="text-2xl font-black text-yellow-400">{power.toFixed(1)} W</p>
               </div>
            </div>

            <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
               <div className="flex-1 flex items-center justify-center p-8 relative">
                  <div className="relative">
                     {/* Bulb glow effect */}
                     <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-40 h-40 rounded-full blur-3xl transition-all duration-300"
                           style={{
                              backgroundColor: `rgba(253, 224, 71, ${brightness})`,
                              transform: `scale(${0.5 + brightness * 1.5})`
                           }} />
                     </div>

                     {/* Bulb SVG */}
                     <svg width="200" height="280" viewBox="0 0 200 280" className="relative z-10">
                        {/* Glass bulb */}
                        <ellipse cx="100" cy="100" rx="70" ry="80" fill={`rgba(253, 224, 71, ${brightness * 0.8})`}
                           stroke="#fbbf24" strokeWidth="3" />
                        {/* Filament */}
                        <path d="M 70,100 Q 80,80 90,100 Q 100,120 110,100 Q 120,80 130,100"
                           fill="none" stroke={brightness > 0.3 ? '#ffffff' : '#666666'}
                           strokeWidth="3" strokeLinecap="round"
                           style={{ filter: brightness > 0.5 ? 'drop-shadow(0 0 8px #fff)' : 'none' }} />
                        {/* Base */}
                        <rect x="70" y="170" width="60" height="30" fill="#64748b" rx="4" />
                        <rect x="75" y="200" width="50" height="10" fill="#475569" />
                        <rect x="80" y="210" width="40" height="10" fill="#334155" />
                        {/* Contact */}
                        <circle cx="100" cy="230" r="10" fill="#1e293b" stroke="#475569" strokeWidth="2" />
                     </svg>
                  </div>

                  {/* Circuit visualization */}
                  <div className="absolute bottom-8 left-8 right-8">
                     <svg width="100%" height="60" viewBox="0 0 400 60" preserveAspectRatio="xMidYMid meet">
                        <line x1="20" y1="30" x2="120" y2="30" stroke="#ef4444" strokeWidth="3" />
                        <rect x="120" y="15" width="60" height="30" fill="none" stroke="#fbbf24" strokeWidth="2" rx="4" />
                        <text x="150" y="35" textAnchor="middle" className="text-[10px] font-bold fill-yellow-400">BULB</text>
                        <line x1="180" y1="30" x2="280" y2="30" stroke="#3b82f6" strokeWidth="3" />
                        <rect x="280" y="20" width="40" height="20" fill="#1e293b" stroke="#64748b" strokeWidth="2" />
                        <text x="300" y="35" textAnchor="middle" className="text-[8px] font-bold fill-slate-400">{resistance}Œ©</text>
                        <line x1="320" y1="30" x2="380" y2="30" stroke="#3b82f6" strokeWidth="3" />
                     </svg>
                  </div>
               </div>

               <div className="w-full md:w-80 bg-slate-800/50 border-l border-slate-700 p-6 flex flex-col gap-6">
                  <div>
                     <div className="flex justify-between mb-2">
                        <label className="text-xs font-bold text-slate-400">Voltage (V)</label>
                        <span className="text-sm font-mono font-bold text-yellow-400">{voltage} V</span>
                     </div>
                     <input type="range" min="0" max="12" step="0.5" value={voltage}
                        onChange={(e) => setVoltage(Number(e.target.value))}
                        className="w-full h-3 bg-slate-700 rounded-full appearance-none cursor-pointer accent-yellow-500" />
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                     <div className="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Current (I)</p>
                        <p className="text-lg font-black text-blue-400">{current.toFixed(2)} A</p>
                     </div>
                     <div className="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Resistance (R)</p>
                        <p className="text-lg font-black text-slate-400">{resistance} Œ©</p>
                     </div>
                  </div>

                  <div className="p-4 bg-yellow-500/10 rounded-xl border border-yellow-500/20">
                     <p className="text-[10px] font-black text-yellow-500 uppercase mb-2">Power Calculation</p>
                     <div className="space-y-1 font-mono text-sm text-slate-300">
                        <p>P = V √ó I = {voltage} √ó {current.toFixed(2)}</p>
                        <p>P = V¬≤/R = {voltage}¬≤/{resistance}</p>
                        <p className="text-yellow-400 font-bold">P = {power.toFixed(2)} W</p>
                     </div>
                  </div>

                  <div className="mt-auto p-4 bg-slate-900 rounded-xl border border-slate-700">
                     <p className="text-xs text-slate-400">
                        <strong className="text-yellow-400">KEY INSIGHT:</strong> Power increases with the SQUARE of voltage. Doubling voltage quadruples brightness!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };


   // --- COUNTING TO 100 RENDERER ---
   const Counting100Renderer = () => {
      const [count, setCount] = useState(1);
      const [character, setCharacter] = useState('üêª'); // Bear, Rabbit, Fox
      const [isJumping, setIsJumping] = useState(false);

      const getStoneColor = (num: number) => {
         if (num <= 10) return 'bg-emerald-500';
         if (num <= 20) return 'bg-yellow-400';
         if (num <= 30) return 'bg-orange-500';
         if (num <= 40) return 'bg-red-500';
         if (num <= 50) return 'bg-purple-500';
         if (num <= 60) return 'bg-blue-600';
         if (num <= 70) return 'bg-slate-400';
         if (num <= 80) return 'bg-amber-400';
         if (num <= 90) return 'bg-pink-400';
         return 'bg-slate-100';
      };

      const handleNext = () => {
         if (count < 100) {
            setIsJumping(true);
            setCount(prev => prev + 1);
            setTimeout(() => setIsJumping(false), 300);
         }
      };

      return (
         <div className="flex flex-col h-full bg-sky-400 text-slate-900 font-sans overflow-hidden relative">
            {/* Sky Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-300 to-sky-500 pointer-events-none" />

            {/* Clouds */}
            <div className="absolute top-10 left-10 animate-pulse opacity-50">‚òÅÔ∏è</div>
            <div className="absolute top-20 right-20 animate-bounce opacity-50">‚òÅÔ∏è</div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center bg-white/20 backdrop-blur-sm border-b border-white/30">
               <div>
                  <h3 className="text-2xl font-black tracking-tight text-white drop-shadow-md">MOUNTAIN CLIMB</h3>
                  <p className="text-[10px] font-bold text-sky-900 uppercase tracking-widest">Counting to 100</p>
               </div>
               <div className="flex gap-2">
                  {['üêª', 'üê∞', 'ü¶ä'].map(c => (
                     <button
                        key={c}
                        onClick={() => setCharacter(c)}
                        className={`w-10 h-10 rounded-full flex items-center justify-center text-xl transition-all ${character === c ? 'bg-white shadow-lg scale-110' : 'bg-white/50 hover:bg-white/80'}`}
                     >
                        {c}
                     </button>
                  ))}
               </div>
            </div>

            {/* Mountain View */}
            <div className="flex-1 relative overflow-hidden flex items-center justify-center p-8">
               {/* The Mountain Path (Simplified) */}
               <div className="relative w-full max-w-md h-full flex flex-col-reverse items-center">
                  {/* Stepping Stones (Visible Window) */}
                  <div className="w-full h-full relative flex flex-col items-center justify-center">
                     {/* Current Stone */}
                     <div className="relative">
                        <div className={`w-32 h-16 rounded-[2rem] shadow-2xl flex items-center justify-center border-4 border-white/50 transition-colors duration-500 ${getStoneColor(count)}`}>
                           <span className="text-4xl font-black text-white drop-shadow-md">{count}</span>
                        </div>

                        {/* Character */}
                        <div
                           className={`absolute -top-16 left-1/2 -translate-x-1/2 text-6xl transition-all duration-300 ${isJumping ? '-translate-y-12 scale-110' : 'translate-y-0 scale-100'}`}
                        >
                           {character}
                        </div>
                     </div>

                     {/* Next Stone Preview */}
                     {count < 100 && (
                        <div className={`w-24 h-12 rounded-[1.5rem] opacity-40 mt-12 flex items-center justify-center border-2 border-white/30 ${getStoneColor(count + 1)}`}>
                           <span className="text-xl font-bold text-white">{count + 1}</span>
                        </div>
                     )}

                     {/* Previous Stone Preview */}
                     {count > 1 && (
                        <div className={`w-24 h-12 rounded-[1.5rem] opacity-40 mb-12 absolute bottom-0 flex items-center justify-center border-2 border-white/30 ${getStoneColor(count - 1)}`}>
                           <span className="text-xl font-bold text-white">{count - 1}</span>
                        </div>
                     )}
                  </div>
               </div>

               {/* Progress Bar (Vertical) */}
               <div className="absolute right-8 top-1/2 -translate-y-1/2 w-4 h-64 bg-white/20 rounded-full overflow-hidden border border-white/30 shadow-inner">
                  <div
                     className="absolute bottom-0 left-0 w-full bg-white transition-all duration-500 shadow-[0_0_10px_rgba(255,255,255,0.8)]"
                     style={{ height: `${count}%` }}
                  />
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/10 backdrop-blur-md border-t border-white/30 flex flex-col items-center gap-6">
               <div className="flex items-center gap-8 w-full max-w-xl">
                  <button
                     onClick={() => setCount(Math.max(1, count - 1))}
                     className="w-16 h-16 rounded-2xl bg-white/20 hover:bg-white/40 flex items-center justify-center text-2xl text-white transition-all active:scale-95 border border-white/30"
                  >
                     ‚¨ÖÔ∏è
                  </button>

                  <button
                     onClick={handleNext}
                     className="flex-1 h-20 rounded-3xl bg-white text-sky-600 font-black text-2xl shadow-xl shadow-sky-900/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-4"
                  >
                     TAP TO CLIMB! üèîÔ∏è
                  </button>

                  <button
                     onClick={() => setCount(Math.min(100, count + 1))}
                     className="w-16 h-16 rounded-2xl bg-white/20 hover:bg-white/40 flex items-center justify-center text-2xl text-white transition-all active:scale-95 border border-white/30"
                  >
                     ‚û°Ô∏è
                  </button>
               </div>

               {/* Slider */}
               <div className="w-full max-w-xl space-y-2">
                  <input
                     type="range"
                     min="1"
                     max="100"
                     value={count}
                     onChange={(e) => setCount(parseInt(e.target.value))}
                     className="w-full h-3 bg-white/20 rounded-full appearance-none cursor-pointer accent-white"
                  />
                  <div className="flex justify-between text-[10px] font-black text-white/70 uppercase tracking-widest">
                     <span>Base (1)</span>
                     <span>Summit (100)</span>
                  </div>
               </div>
            </div>

            {/* Celebration Overlay */}
            {count % 10 === 0 && !isJumping && (
               <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-50 animate-bounce">
                  <div className="bg-white/90 backdrop-blur-md p-8 rounded-[3rem] shadow-2xl border-4 border-yellow-400 text-center">
                     <p className="text-4xl font-black text-yellow-600">WAY TO GO!</p>
                     <p className="text-xl font-bold text-sky-600">You reached {count}!</p>
                     <div className="text-4xl mt-4">‚ú®üéâüéä</div>
                  </div>
               </div>
            )}
         </div>
      );
   };


   // --- ONE-TO-ONE CORRESPONDENCE RENDERER ---
   const OneToOneCorrespondenceRenderer = () => {
      const [guests, setGuests] = useState([
         { id: 1, name: 'Rabbit', icon: 'üê∞', items: { plate: false, cup: false } },
         { id: 2, name: 'Bear', icon: 'üêª', items: { plate: false, cup: false } },
         { id: 3, name: 'Fox', icon: 'ü¶ä', items: { plate: false, cup: false } },
      ]);
      const [draggedItem, setDraggedItem] = useState<string | null>(null);

      const handleDrop = (guestId: number, itemType: 'plate' | 'cup') => {
         setGuests(prev => prev.map(g =>
            g.id === guestId ? { ...g, items: { ...g.items, [itemType]: true } } : g
         ));
         setDraggedItem(null);
      };

      const allServed = guests.every(g => g.items.plate && g.items.cup);

      return (
         <div className="flex flex-col h-full bg-pink-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 border-b border-pink-100 bg-white flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-pink-500">BIRTHDAY PARTY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">One-to-One Correspondence</p>
               </div>
               {allServed && (
                  <div className="bg-green-500 text-white px-4 py-1 rounded-full text-xs font-black animate-bounce">
                     PARTY READY! üéâ
                  </div>
               )}
            </div>

            <div className="flex-1 p-8 flex flex-col items-center justify-center gap-12">
               {/* Party Table */}
               <div className="flex gap-8">
                  {guests.map(guest => (
                     <div key={guest.id} className="flex flex-col items-center gap-4">
                        <div className="text-6xl mb-2">{guest.icon}</div>
                        <div className="flex gap-4">
                           {/* Plate Slot */}
                           <div
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop(guest.id, 'plate')}
                              className={`w-16 h-16 rounded-full border-4 border-dashed flex items-center justify-center transition-all ${guest.items.plate ? 'border-pink-500 bg-white scale-110' : 'border-slate-200 bg-slate-50'}`}
                           >
                              {guest.items.plate ? <span className="text-3xl">üçΩÔ∏è</span> : <span className="text-xs text-slate-300 font-bold">PLATE</span>}
                           </div>
                           {/* Cup Slot */}
                           <div
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={() => handleDrop(guest.id, 'cup')}
                              className={`w-12 h-12 rounded-lg border-4 border-dashed flex items-center justify-center transition-all ${guest.items.cup ? 'border-blue-400 bg-white scale-110' : 'border-slate-200 bg-slate-50'}`}
                           >
                              {guest.items.cup ? <span className="text-2xl">ü•§</span> : <span className="text-[8px] text-slate-300 font-bold">CUP</span>}
                           </div>
                        </div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{guest.name}</p>
                     </div>
                  ))}
               </div>

               {/* Supply Area */}
               <div className="p-6 bg-white rounded-[2rem] shadow-xl border-2 border-pink-100 flex gap-8 items-center">
                  <div className="text-center">
                     <div
                        draggable
                        onDragStart={() => setDraggedItem('plate')}
                        className="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center text-4xl cursor-grab active:cursor-grabbing hover:scale-110 transition-transform shadow-md"
                     >
                        üçΩÔ∏è
                     </div>
                     <p className="text-[8px] font-black text-pink-400 mt-2 uppercase tracking-widest">Plates</p>
                  </div>
                  <div className="text-center">
                     <div
                        draggable
                        onDragStart={() => setDraggedItem('cup')}
                        className="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center text-3xl cursor-grab active:cursor-grabbing hover:scale-110 transition-transform shadow-md"
                     >
                        ü•§
                     </div>
                     <p className="text-[8px] font-black text-blue-400 mt-2 uppercase tracking-widest">Cups</p>
                  </div>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-white border-t border-pink-100">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-pink-500/10 flex items-center justify-center border border-pink-500/20 shrink-0">
                     <span className="text-2xl">üç∞</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>One-to-One Correspondence</strong> means matching one object from one group to exactly one object in another group. Each guest gets exactly one plate and one cup!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SUBITIZING RENDERER ---
   const SubitizingRenderer = () => {
      const [fireflies, setFireflies] = useState<{ x: number, y: number }[]>([]);
      const [isVisible, setIsVisible] = useState(false);
      const [score, setScore] = useState(0);
      const [gameState, setGameState] = useState<'idle' | 'flashing' | 'guessing' | 'result'>('idle');
      const [correctCount, setCorrectCount] = useState(0);
      const [lastGuess, setLastGuess] = useState<number | null>(null);

      const startFlash = () => {
         const count = Math.floor(Math.random() * 6) + 1; // 1-6 for subitizing
         const newFireflies = Array.from({ length: count }, () => ({
            x: 20 + Math.random() * 60,
            y: 20 + Math.random() * 60
         }));
         setFireflies(newFireflies);
         setCorrectCount(count);
         setGameState('flashing');
         setIsVisible(true);

         setTimeout(() => {
            setIsVisible(false);
            setGameState('guessing');
         }, 1000); // 1 second flash
      };

      const handleGuess = (num: number) => {
         setLastGuess(num);
         setGameState('result');
         if (num === correctCount) {
            setScore(prev => prev + 1);
         }
      };

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden relative">
            {/* Night Sky Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#1e1b4b_0%,#020617_100%)]" />

            {/* Stars */}
            <div className="absolute inset-0 opacity-30 pointer-events-none">
               {Array.from({ length: 50 }).map((_, i) => (
                  <div
                     key={i}
                     className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
                     style={{ top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 3}s` }}
                  />
               ))}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/10 bg-black/20 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">FIREFLY CATCH</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Subitizing Practice</p>
               </div>
               <div className="bg-yellow-400/20 px-4 py-1 rounded-full border border-yellow-400/30">
                  <span className="text-xs font-black text-yellow-400">SCORE: {score}</span>
               </div>
            </div>

            {/* Garden View */}
            <div className="flex-1 relative flex items-center justify-center">
               {gameState === 'idle' && (
                  <button
                     onClick={startFlash}
                     className="px-8 py-4 bg-yellow-400 text-slate-950 font-black rounded-2xl shadow-xl shadow-yellow-400/20 hover:scale-105 active:scale-95 transition-all"
                  >
                     READY? FLASH! ‚ú®
                  </button>
               )}

               {isVisible && (
                  <div className="absolute inset-0">
                     {fireflies.map((f, i) => (
                        <div
                           key={i}
                           className="absolute w-6 h-6 bg-yellow-300 rounded-full blur-[2px] shadow-[0_0_20px_#fde047]"
                           style={{ top: `${f.y}%`, left: `${f.x}%` }}
                        >
                           <div className="absolute inset-0 bg-yellow-100 rounded-full animate-ping opacity-50" />
                        </div>
                     ))}
                  </div>
               )}

               {gameState === 'guessing' && (
                  <div className="flex flex-col items-center gap-8">
                     <p className="text-2xl font-black text-white drop-shadow-lg">How many did you see?</p>
                     <div className="grid grid-cols-3 gap-4">
                        {[1, 2, 3, 4, 5, 6].map(num => (
                           <button
                              key={num}
                              onClick={() => handleGuess(num)}
                              className="w-20 h-20 bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl flex items-center justify-center text-3xl font-black transition-all hover:scale-110 active:scale-90"
                           >
                              {num}
                           </button>
                        ))}
                     </div>
                  </div>
               )}

               {gameState === 'result' && (
                  <div className="flex flex-col items-center gap-6 animate-in fade-in zoom-in duration-300">
                     <div className={`text-6xl font-black ${lastGuess === correctCount ? 'text-green-400' : 'text-red-400'}`}>
                        {lastGuess === correctCount ? 'CORRECT! ‚ú®' : 'OOPS! üåô'}
                     </div>
                     <p className="text-xl text-slate-300">There were <span className="text-white font-black">{correctCount}</span> fireflies.</p>
                     <button
                        onClick={startFlash}
                        className="mt-4 px-8 py-3 bg-white text-slate-950 font-black rounded-xl hover:bg-slate-200 transition-colors"
                     >
                        PLAY AGAIN
                     </button>
                  </div>
               )}
            </div>

            {/* Footer Insight */}
            <div className="relative z-10 p-6 bg-black/40 backdrop-blur-md border-t border-white/10">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-400/10 flex items-center justify-center border border-yellow-400/20 shrink-0">
                     <span className="text-2xl">üí°</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Subitizing</strong> is the ability to instantly recognize the number of objects in a small group without counting them one by one. It's like "seeing" the number!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- PLACE VALUE TENS AND ONES RENDERER ---
   const PlaceValueTensOnesRenderer = () => {
      const [ones, setOnes] = useState(0);
      const [tens, setTens] = useState(0);
      const [isBundling, setIsBundling] = useState(false);

      const addCandy = () => {
         if (ones < 9) {
            setOnes(prev => prev + 1);
         } else {
            // Auto-bundle or prompt to bundle
            setIsBundling(true);
            setTimeout(() => {
               setOnes(0);
               setTens(prev => prev + 1);
               setIsBundling(false);
            }, 800);
         }
      };

      const reset = () => {
         setOnes(0);
         setTens(0);
      };

      return (
         <div className="flex flex-col h-full bg-slate-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-600">CANDY FACTORY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Place Value: Tens & Ones</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <div className="text-2xl font-black text-indigo-600">{tens}</div>
                     <div className="text-[8px] font-bold text-slate-400 uppercase">Tens</div>
                  </div>
                  <div className="text-center">
                     <div className="text-2xl font-black text-orange-500">{ones}</div>
                     <div className="text-[8px] font-bold text-slate-400 uppercase">Ones</div>
                  </div>
               </div>
            </div>

            <div className="flex-1 p-8 flex gap-8 items-center justify-center">
               {/* Tens Station */}
               <div className="flex-1 h-full bg-indigo-50/50 rounded-[3rem] border-4 border-dashed border-indigo-100 p-8 flex flex-wrap content-start gap-4 relative overflow-hidden">
                  <div className="absolute top-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Tens Station (Boxes)</div>
                  {Array.from({ length: tens }).map((_, i) => (
                     <div key={i} className="w-16 h-24 bg-indigo-500 rounded-xl shadow-lg flex flex-col items-center justify-center gap-1 border-2 border-indigo-400 animate-in zoom-in duration-300">
                        <div className="grid grid-cols-2 gap-1">
                           {Array.from({ length: 10 }).map((_, j) => (
                              <div key={j} className="w-2 h-2 bg-indigo-200 rounded-full" />
                           ))}
                        </div>
                        <span className="text-[8px] font-black text-white">BOX OF 10</span>
                     </div>
                  ))}
                  {isBundling && (
                     <div className="w-16 h-24 bg-indigo-400 rounded-xl animate-bounce flex items-center justify-center border-2 border-indigo-300">
                        <span className="text-2xl">üì¶</span>
                     </div>
                  )}
               </div>

               {/* Ones Bin */}
               <div className="flex-1 h-full bg-orange-50/50 rounded-[3rem] border-4 border-dashed border-orange-100 p-8 flex flex-wrap content-start gap-4 relative">
                  <div className="absolute top-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-orange-300 uppercase tracking-widest">Ones Bin (Candies)</div>
                  {Array.from({ length: ones }).map((_, i) => (
                     <div key={i} className="w-10 h-10 bg-orange-500 rounded-full shadow-md flex items-center justify-center border-2 border-orange-400 animate-in slide-in-from-top duration-300">
                        <span className="text-lg">üç¨</span>
                     </div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="p-8 bg-white border-t border-slate-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={addCandy}
                     disabled={isBundling}
                     className="flex-1 h-16 bg-indigo-600 text-white font-black rounded-2xl shadow-lg shadow-indigo-200 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                  >
                     <span className="text-2xl">üç¨</span>
                     ADD CANDY
                  </button>
                  <button
                     onClick={reset}
                     className="w-16 h-16 bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <div className="text-center">
                  <p className="text-4xl font-black text-slate-800 tracking-tighter">
                     <span className="text-indigo-600">{tens}</span>
                     <span className="text-orange-500">{ones}</span>
                  </p>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                     {tens} Tens + {ones} Ones = {tens * 10 + ones}
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- ADDITION AS PUTTING TOGETHER RENDERER ---
   const AdditionPuttingTogetherRenderer = () => {
      const [group1, setGroup1] = useState(3);
      const [group2, setGroup2] = useState(2);
      const [isMerging, setIsMerging] = useState(false);
      const [showResult, setShowResult] = useState(false);

      const handleMerge = () => {
         setIsMerging(true);
         setTimeout(() => {
            setIsMerging(false);
            setShowResult(true);
         }, 1000);
      };

      const reset = () => {
         setShowResult(false);
         setIsMerging(false);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Water Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#ecfdf5_0%,#d1fae5_100%)]" />

            {/* Ripples */}
            <div className="absolute inset-0 opacity-20 pointer-events-none">
               <div className="absolute top-1/4 left-1/4 w-64 h-64 border-4 border-emerald-200 rounded-full animate-ping" />
               <div className="absolute bottom-1/4 right-1/4 w-48 h-48 border-4 border-emerald-200 rounded-full animate-ping [animation-delay:1s]" />
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-600">GARDEN POND</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Addition: Putting Together</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center px-4 py-1 bg-white rounded-full border border-emerald-100 shadow-sm">
                     <span className="text-lg font-black text-emerald-600">{group1} + {group2} = {showResult ? group1 + group2 : '?'}</span>
                  </div>
               </div>
            </div>

            {/* Pond View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               {!showResult ? (
                  <div className="w-full flex justify-between items-center gap-12">
                     {/* Group 1 */}
                     <div className="flex-1 flex flex-wrap justify-center gap-4 p-8 bg-white/30 rounded-[3rem] border-2 border-dashed border-emerald-200 relative">
                        <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Group A</div>
                        {Array.from({ length: group1 }).map((_, i) => (
                           <div key={i} className="w-16 h-16 bg-emerald-400 rounded-full shadow-lg flex items-center justify-center text-3xl animate-bounce" style={{ animationDelay: `${i * 0.1}s` }}>
                              üçÄ
                           </div>
                        ))}
                        <div className="absolute -bottom-12 flex gap-2">
                           <button onClick={() => setGroup1(Math.max(1, group1 - 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">-</button>
                           <button onClick={() => setGroup1(Math.min(10, group1 + 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">+</button>
                        </div>
                     </div>

                     {/* Merge Button */}
                     <button
                        onClick={handleMerge}
                        className={`w-24 h-24 rounded-full bg-emerald-600 text-white flex items-center justify-center text-4xl shadow-xl shadow-emerald-900/20 hover:scale-110 active:scale-90 transition-all z-20 ${isMerging ? 'animate-ping' : ''}`}
                     >
                        ‚ûï
                     </button>

                     {/* Group 2 */}
                     <div className="flex-1 flex flex-wrap justify-center gap-4 p-8 bg-white/30 rounded-[3rem] border-2 border-dashed border-emerald-200 relative">
                        <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Group B</div>
                        {Array.from({ length: group2 }).map((_, i) => (
                           <div key={i} className="w-16 h-16 bg-emerald-400 rounded-full shadow-lg flex items-center justify-center text-3xl animate-bounce" style={{ animationDelay: `${i * 0.1}s` }}>
                              üçÄ
                           </div>
                        ))}
                        <div className="absolute -bottom-12 flex gap-2">
                           <button onClick={() => setGroup2(Math.max(1, group2 - 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">-</button>
                           <button onClick={() => setGroup2(Math.min(10, group2 + 1))} className="w-8 h-8 bg-white rounded-full shadow-sm border border-emerald-100 flex items-center justify-center text-emerald-600 font-black">+</button>
                        </div>
                     </div>
                  </div>
               ) : (
                  <div className="w-full max-w-2xl p-12 bg-white/40 backdrop-blur-md rounded-[4rem] border-4 border-emerald-400 flex flex-wrap justify-center gap-6 animate-in zoom-in duration-500">
                     <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-8 py-2 rounded-full text-xl font-black uppercase shadow-lg">PUT TOGETHER!</div>
                     {Array.from({ length: group1 + group2 }).map((_, i) => (
                        <div key={i} className="w-20 h-20 bg-emerald-500 rounded-full shadow-xl flex items-center justify-center text-4xl animate-bounce" style={{ animationDelay: `${i * 0.05}s` }}>
                           üçÄ
                        </div>
                     ))}
                  </div>
               )}
            </div>

            {/* Footer Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-emerald-100 flex flex-col items-center gap-4">
               {showResult && (
                  <button
                     onClick={reset}
                     className="px-8 py-3 bg-emerald-600 text-white font-black rounded-xl shadow-lg hover:bg-emerald-700 transition-colors"
                  >
                     TRY ANOTHER PROBLEM
                  </button>
               )}
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üê∏</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>Addition</strong> is the process of putting two or more groups together to find the total. When we combine {group1} and {group2}, we get {group1 + group2}!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SUBTRACTION AS TAKING APART RENDERER ---
   const SubtractionTakingApartRenderer = () => {
      const [apples, setApples] = useState([
         { id: 1, picked: false }, { id: 2, picked: false }, { id: 3, picked: false },
         { id: 4, picked: false }, { id: 5, picked: false }, { id: 6, picked: false },
         { id: 7, picked: false }, { id: 8, picked: false }
      ]);
      const [isPicking, setIsPicking] = useState(false);

      const total = apples.length;
      const pickedCount = apples.filter(a => a.picked).length;
      const remainingCount = total - pickedCount;

      const handlePick = (id: number) => {
         setApples(prev => prev.map(a => a.id === id ? { ...a, picked: !a.picked } : a));
      };

      const reset = () => {
         setApples(apples.map(a => ({ ...a, picked: false })));
      };

      return (
         <div className="flex flex-col h-full bg-sky-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-200 to-emerald-50 pointer-events-none" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-sky-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-red-500">APPLE ORCHARD</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Subtraction: Taking Apart</p>
               </div>
               <div className="flex gap-4">
                  <div className="text-center px-4 py-1 bg-white rounded-full border border-red-100 shadow-sm">
                     <span className="text-lg font-black text-red-500">{total} - {pickedCount} = {remainingCount}</span>
                  </div>
               </div>
            </div>

            {/* Orchard View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               {/* The Tree */}
               <div className="relative w-96 h-96">
                  {/* Trunk */}
                  <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-48 bg-amber-900 rounded-t-xl" />
                  {/* Leaves */}
                  <div className="absolute top-0 left-1/2 -translate-x-1/2 w-80 h-80 bg-emerald-500 rounded-full shadow-2xl border-8 border-emerald-400" />

                  {/* Apples on Tree */}
                  <div className="absolute inset-0 flex items-center justify-center p-12">
                     <div className="grid grid-cols-3 gap-8">
                        {apples.map(apple => (
                           <button
                              key={apple.id}
                              onClick={() => handlePick(apple.id)}
                              className={`w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-3xl transition-all duration-500 hover:scale-110 active:scale-90 ${apple.picked ? 'opacity-0 pointer-events-none translate-y-32' : 'opacity-100'}`}
                           >
                              üçé
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               {/* Basket */}
               <div className="absolute bottom-12 right-12 w-48 h-32 bg-amber-700 rounded-b-[3rem] border-t-8 border-amber-800 shadow-xl flex flex-wrap justify-center content-start p-4 gap-2">
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-800 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase">Basket</div>
                  {apples.filter(a => a.picked).map(a => (
                     <div key={a.id} className="text-2xl animate-in slide-in-from-top-12 duration-500">üçé</div>
                  ))}
               </div>
            </div>

            {/* Footer Insight */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-sky-100 flex flex-col items-center gap-4">
               <div className="flex gap-4">
                  <button onClick={reset} className="px-6 py-2 bg-red-500 text-white font-black rounded-xl shadow-lg hover:bg-red-600 transition-colors">RESET TREE</button>
               </div>
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center border border-red-500/20 shrink-0">
                     <span className="text-2xl">üß∫</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     <strong>Subtraction</strong> can be thought of as "taking apart" a group. We started with {total} apples, took away {pickedCount}, and now {remainingCount} are left on the tree!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- FACT FAMILIES RENDERER ---
   const FactFamiliesRenderer = () => {
      const [family, setFamily] = useState({ a: 3, b: 5, c: 8 });
      const [equations, setEquations] = useState([
         { id: 1, type: 'add', parts: [null, '+', null, '=', null], correct: [3, 5, 8] },
         { id: 2, type: 'add', parts: [null, '+', null, '=', null], correct: [5, 3, 8] },
         { id: 3, type: 'sub', parts: [null, '-', null, '=', null], correct: [8, 3, 5] },
         { id: 4, type: 'sub', parts: [null, '-', null, '=', null], correct: [8, 5, 3] },
      ]);
      const [selectedSlot, setSelectedSlot] = useState<{ eqId: number, slotIdx: number } | null>(null);

      const handleNumberClick = (num: number) => {
         if (selectedSlot) {
            setEquations(prev => prev.map(eq => {
               if (eq.id === selectedSlot.eqId) {
                  const newParts = [...eq.parts];
                  newParts[selectedSlot.slotIdx] = num;
                  return { ...eq, parts: newParts };
               }
               return eq;
            }));
            setSelectedSlot(null);
         }
      };

      const isCorrect = (eq: any) => {
         const values = eq.parts.filter((p: any) => typeof p === 'number');
         if (values.length < 3) return false;
         if (eq.type === 'add') return values[0] + values[1] === values[2];
         return values[0] - values[1] === values[2];
      };

      return (
         <div className="flex flex-col h-full bg-amber-50 text-slate-900 font-sans overflow-hidden">
            {/* Header */}
            <div className="p-6 bg-white border-b border-amber-100 flex justify-between items-center shadow-sm">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-600">NUMBER HOUSE</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Fact Families (Addition & Subtraction)</p>
               </div>
               <div className="flex gap-2 bg-amber-100 px-4 py-2 rounded-2xl border border-amber-200">
                  {[family.a, family.b, family.c].map((n, i) => (
                     <div key={i} className="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-xl font-black text-amber-600 shadow-sm">{n}</div>
                  ))}
               </div>
            </div>

            <div className="flex-1 p-8 flex flex-col items-center justify-center gap-8">
               {/* House Visualization */}
               <div className="relative w-full max-w-2xl bg-white rounded-[3rem] shadow-2xl border-4 border-amber-100 p-12 flex flex-col gap-6">
                  <div className="absolute -top-12 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[150px] border-l-transparent border-r-[150px] border-r-transparent border-b-[100px] border-b-amber-500" />

                  {equations.map(eq => (
                     <div key={eq.id} className="flex items-center justify-center gap-4 p-4 bg-slate-50 rounded-2xl border-2 border-slate-100 transition-all">
                        {eq.parts.map((part, idx) => (
                           typeof part === 'string' ? (
                              <span key={idx} className="text-2xl font-black text-slate-400">{part}</span>
                           ) : (
                              <button
                                 key={idx}
                                 onClick={() => setSelectedSlot({ eqId: eq.id, slotIdx: idx })}
                                 className={`w-16 h-16 rounded-xl border-4 flex items-center justify-center text-2xl font-black transition-all ${selectedSlot?.eqId === eq.id && selectedSlot?.slotIdx === idx ? 'border-amber-500 bg-amber-50 scale-110' : part !== null ? (isCorrect(eq) ? 'border-green-400 bg-green-50 text-green-600' : 'border-slate-200 bg-white') : 'border-dashed border-slate-200 bg-slate-100'}`}
                              >
                                 {part}
                              </button>
                           )
                        ))}
                        {isCorrect(eq) && <span className="text-2xl animate-bounce">‚úÖ</span>}
                     </div>
                  ))}
               </div>

               {/* Number Palette */}
               <div className="flex gap-6 p-6 bg-white rounded-[2rem] shadow-xl border-2 border-amber-100">
                  {[family.a, family.b, family.c].map(num => (
                     <button
                        key={num}
                        onClick={() => handleNumberClick(num)}
                        className="w-20 h-20 bg-amber-500 text-white rounded-2xl flex items-center justify-center text-4xl font-black shadow-lg hover:scale-110 active:scale-90 transition-all"
                     >
                        {num}
                     </button>
                  ))}
                  <button
                     onClick={() => setEquations(equations.map(eq => ({ ...eq, parts: eq.parts.map(p => typeof p === 'string' ? p : null) })))}
                     className="w-20 h-20 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center text-2xl hover:bg-slate-200 transition-colors"
                  >
                     üîÑ
                  </button>
               </div>
            </div>

            {/* Footer Insight */}
            <div className="p-6 bg-white border-t border-amber-100">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-amber-500/10 flex items-center justify-center border border-amber-500/20 shrink-0">
                     <span className="text-2xl">üè†</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     A <strong>Fact Family</strong> is a group of math facts that use the same three numbers. They show how addition and subtraction are related!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- POSITIVE AND NEGATIVE NUMBERS INTRO RENDERER ---
   const PositiveNegativeIntroRenderer = () => {
      const [floor, setFloor] = useState(0);
      const [isMoving, setIsMoving] = useState(false);

      const handleGoTo = (target: number) => {
         setIsMoving(true);
         setFloor(target);
         setTimeout(() => setIsMoving(false), 800);
      };

      return (
         <div className="flex flex-col h-full bg-slate-900 text-white font-sans overflow-hidden relative">
            {/* Background Layers */}
            <div className="absolute inset-0 flex flex-col">
               <div className="flex-1 bg-sky-400" /> {/* Sky */}
               <div className="h-1 bg-emerald-600" /> {/* Ground Line */}
               <div className="flex-1 bg-slate-800" /> {/* Underground */}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/10">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-yellow-400">MAGIC ELEVATOR</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Intro to Positive & Negative Numbers</p>
               </div>
               <div className="bg-white/10 px-4 py-1 rounded-full border border-white/20">
                  <span className={`text-lg font-black ${floor > 0 ? 'text-sky-300' : floor < 0 ? 'text-orange-400' : 'text-white'}`}>
                     FLOOR: {floor > 0 ? `+${floor}` : floor}
                  </span>
               </div>
            </div>

            {/* Elevator Shaft View */}
            <div className="flex-1 relative flex items-center justify-center">
               {/* Shaft */}
               <div className="w-32 h-full bg-black/20 border-x-4 border-white/10 relative">
                  {/* Floor Markers */}
                  {[-3, -2, -1, 0, 1, 2, 3].map(f => (
                     <div
                        key={f}
                        className="absolute w-full h-px bg-white/10 flex items-center justify-end pr-2"
                        style={{ bottom: `${(f + 3) * 16.6}%` }}
                     >
                        <span className="text-[8px] font-bold text-white/30">{f > 0 ? `+${f}` : f}</span>
                     </div>
                  ))}

                  {/* Elevator Car */}
                  <div
                     className={`absolute left-2 right-2 h-20 bg-yellow-400 rounded-lg shadow-[0_0_30px_rgba(250,204,21,0.4)] flex flex-col items-center justify-center border-2 border-yellow-200 transition-all duration-700 ease-in-out z-20`}
                     style={{ bottom: `calc(${(floor + 3) * 16.6}% - 40px)` }}
                  >
                     <div className="text-2xl">üö†</div>
                     <span className="text-xs font-black text-slate-900">{floor > 0 ? `+${floor}` : floor}</span>
                     {isMoving && <div className="absolute -bottom-8 text-xl animate-bounce">‚ú®</div>}
                  </div>
               </div>

               {/* Environment Decorations */}
               <div className="absolute top-1/4 left-1/4 text-4xl opacity-50">‚òÅÔ∏è</div>
               <div className="absolute bottom-1/4 right-1/4 text-4xl opacity-20">ü™±</div>
               <div className="absolute bottom-1/3 left-1/3 text-4xl opacity-20">üíé</div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-black/60 backdrop-blur-xl border-t border-white/10 flex flex-col items-center gap-6">
               <div className="flex gap-4">
                  <div className="flex flex-col gap-2">
                     <p className="text-[8px] font-black text-sky-400 uppercase tracking-widest text-center">Above Ground (+)</p>
                     <div className="flex gap-2">
                        {[3, 2, 1].map(f => (
                           <button
                              key={f}
                              onClick={() => handleGoTo(f)}
                              className={`w-12 h-12 rounded-xl font-black transition-all ${floor === f ? 'bg-sky-400 text-white scale-110 shadow-lg shadow-sky-400/20' : 'bg-white/10 hover:bg-white/20 text-sky-200'}`}
                           >
                              +{f}
                           </button>
                        ))}
                     </div>
                  </div>

                  <button
                     onClick={() => handleGoTo(0)}
                     className={`w-12 h-12 mt-5 rounded-xl font-black transition-all ${floor === 0 ? 'bg-white text-slate-900 scale-110 shadow-lg' : 'bg-white/10 hover:bg-white/20 text-white'}`}
                  >
                     0
                  </button>

                  <div className="flex flex-col gap-2">
                     <p className="text-[8px] font-black text-orange-400 uppercase tracking-widest text-center">Below Ground (-)</p>
                     <div className="flex gap-2">
                        {[-1, -2, -3].map(f => (
                           <button
                              key={f}
                              onClick={() => handleGoTo(f)}
                              className={`w-12 h-12 rounded-xl font-black transition-all ${floor === f ? 'bg-orange-500 text-white scale-110 shadow-lg shadow-orange-500/20' : 'bg-white/10 hover:bg-white/20 text-orange-200'}`}
                           >
                              {f}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-yellow-400/10 flex items-center justify-center border border-yellow-400/20 shrink-0">
                     <span className="text-2xl">‚ÜïÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-400 leading-relaxed">
                     <strong>Positive numbers</strong> are above zero (like floors above ground). <strong>Negative numbers</strong> are below zero (like basement floors). Zero is the starting point!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- SKIP COUNTING RENDERER ---
   const SkipCountingRenderer = () => {
      const [interval, setInterval] = useState(2);
      const [current, setCurrent] = useState(0);
      const [history, setHistory] = useState<number[]>([0]);
      const [isJumping, setIsJumping] = useState(false);

      const handleJump = () => {
         if (current + interval <= 50) {
            setIsJumping(true);
            const next = current + interval;
            setCurrent(next);
            setHistory(prev => [...prev, next]);
            setTimeout(() => setIsJumping(false), 500);
         }
      };

      const reset = (newInterval?: number) => {
         if (newInterval) setInterval(newInterval);
         setCurrent(0);
         setHistory([0]);
         setIsJumping(false);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Pond Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#ecfdf5_0%,#d1fae5_100%)]" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-600">FROG JUMP</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Skip Counting (2s, 5s, 10s)</p>
               </div>
               <div className="flex gap-2">
                  {[2, 5, 10].map(i => (
                     <button
                        key={i}
                        onClick={() => reset(i)}
                        className={`px-4 py-1 rounded-full text-xs font-black transition-all ${interval === i ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-emerald-600 border border-emerald-100 hover:bg-emerald-50'}`}
                     >
                        SKIP {i}s
                     </button>
                  ))}
               </div>
            </div>

            {/* Number Line View */}
            <div className="flex-1 relative flex items-center justify-center p-12 overflow-x-auto">
               <div className="relative w-full max-w-4xl h-64 flex items-center">
                  {/* The Line */}
                  <div className="absolute w-full h-2 bg-emerald-200 rounded-full" />

                  {/* Ticks & Numbers */}
                  {Array.from({ length: 51 }).map((_, i) => (
                     (i % 5 === 0 || i === current) && (
                        <div
                           key={i}
                           className="absolute flex flex-col items-center gap-2 transition-all duration-500"
                           style={{ left: `${(i / 50) * 100}%` }}
                        >
                           <div className={`w-1 h-4 ${i % 10 === 0 ? 'bg-emerald-600 h-6' : 'bg-emerald-300'}`} />
                           <span className={`text-[10px] font-black ${history.includes(i) ? 'text-emerald-600 scale-125' : 'text-slate-300'}`}>{i}</span>
                        </div>
                     )
                  ))}

                  {/* Jump Arcs */}
                  <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible">
                     {history.slice(0, -1).map((val, idx) => {
                        const nextVal = history[idx + 1];
                        const x1 = (val / 50) * 100;
                        const x2 = (nextVal / 50) * 100;
                        const midX = (x1 + x2) / 2;
                        return (
                           <path
                              key={idx}
                              d={`M ${x1}% 50% Q ${midX}% 0% ${x2}% 50%`}
                              fill="none"
                              stroke="#10b981"
                              strokeWidth="3"
                              strokeDasharray="8 4"
                              className="animate-in fade-in duration-500"
                           />
                        );
                     })}
                  </svg>

                  {/* The Frog */}
                  <div
                     className={`absolute w-16 h-16 flex items-center justify-center text-4xl transition-all duration-500 ease-out z-20`}
                     style={{
                        left: `calc(${(current / 50) * 100}% - 32px)`,
                        bottom: isJumping ? '60%' : '40%',
                        transform: `scaleX(${isJumping ? 1.2 : 1})`
                     }}
                  >
                     üê∏
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-emerald-100 flex flex-col items-center gap-4">
               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={handleJump}
                     disabled={current + interval > 50 || isJumping}
                     className="flex-1 h-16 bg-emerald-600 text-white font-black rounded-2xl shadow-lg shadow-emerald-200 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                  >
                     JUMP {interval}! üöÄ
                  </button>
                  <button
                     onClick={() => reset()}
                     className="w-16 h-16 bg-slate-100 text-slate-400 rounded-2xl hover:bg-slate-200 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <div className="flex flex-wrap justify-center gap-2">
                  {history.map((h, i) => (
                     <span key={i} className="text-xs font-black text-emerald-600 bg-white px-2 py-1 rounded-lg border border-emerald-100 shadow-sm animate-in zoom-in">
                        {h}
                     </span>
                  ))}
               </div>
            </div>
         </div>
      );
   };


   // --- FRACTION INTRODUCTION RENDERER ---
   const FractionIntroRenderer = () => {
      const [denominator, setDenominator] = useState(4);
      const [numerator, setNumerator] = useState(1);

      const slices = Array.from({ length: denominator });

      const toggleSlice = (idx: number) => {
         // This is a simple model where we just count how many are selected
         // In a real app, we might track specific slices
         if (numerator === idx + 1) {
            setNumerator(idx);
         } else {
            setNumerator(idx + 1);
         }
      };

      return (
         <div className="flex flex-col h-full bg-orange-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-orange-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-orange-600">PIZZA PARTY</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Introduction to Fractions</p>
               </div>
               <div className="flex items-center gap-4 bg-white px-6 py-2 rounded-2xl border border-orange-100 shadow-sm">
                  <div className="flex flex-col items-center">
                     <span className="text-2xl font-black text-orange-600 leading-none">{numerator}</span>
                     <div className="w-8 h-1 bg-slate-300 my-1 rounded-full" />
                     <span className="text-2xl font-black text-slate-600 leading-none">{denominator}</span>
                  </div>
                  <div className="text-[10px] font-bold text-slate-400 uppercase leading-tight">
                     {numerator} of {denominator}<br />parts
                  </div>
               </div>
            </div>

            {/* Pizza View */}
            <div className="flex-1 relative flex items-center justify-center p-12">
               <div className="relative w-80 h-80 bg-amber-100 rounded-full shadow-2xl border-8 border-amber-200 overflow-hidden">
                  {/* Slices */}
                  <svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                     {slices.map((_, i) => {
                        const angle = (360 / denominator);
                        const startAngle = i * angle;
                        const endAngle = (i + 1) * angle;

                        // Path for a pie slice
                        const x1 = 50 + 50 * Math.cos((startAngle - 90) * Math.PI / 180);
                        const y1 = 50 + 50 * Math.sin((startAngle - 90) * Math.PI / 180);
                        const x2 = 50 + 50 * Math.cos((endAngle - 90) * Math.PI / 180);
                        const y2 = 50 + 50 * Math.sin((endAngle - 90) * Math.PI / 180);

                        const largeArcFlag = angle > 180 ? 1 : 0;
                        const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

                        return (
                           <path
                              key={i}
                              d={d}
                              onClick={() => setNumerator(i + 1)}
                              className={`cursor-pointer transition-all duration-300 ${i < numerator ? 'fill-orange-500 stroke-orange-600 stroke-2' : 'fill-amber-50/50 stroke-amber-200 stroke-1 hover:fill-amber-100'}`}
                           />
                        );
                     })}
                  </svg>

                  {/* Toppings (Visual only) */}
                  <div className="absolute inset-0 pointer-events-none opacity-40">
                     {Array.from({ length: 12 }).map((_, i) => (
                        <div
                           key={i}
                           className="absolute w-4 h-4 bg-red-600 rounded-full"
                           style={{
                              top: `${20 + Math.random() * 60}%`,
                              left: `${20 + Math.random() * 60}%`,
                              transform: `rotate(${Math.random() * 360}deg)`
                           }}
                        />
                     ))}
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-orange-100 flex flex-col items-center gap-6">
               <div className="flex flex-col items-center gap-2">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Divide into how many slices?</p>
                  <div className="flex gap-2">
                     {[2, 3, 4, 6, 8].map(d => (
                        <button
                           key={d}
                           onClick={() => { setDenominator(d); setNumerator(1); }}
                           className={`w-12 h-12 rounded-xl font-black transition-all ${denominator === d ? 'bg-orange-600 text-white scale-110 shadow-lg' : 'bg-white text-orange-600 border border-orange-100 hover:bg-orange-50'}`}
                        >
                           {d}
                        </button>
                     ))}
                  </div>
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center border border-orange-500/20 shrink-0">
                     <span className="text-2xl">üçï</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     A <strong>Fraction</strong> tells us how many parts of a whole we have. The <strong>bottom number (denominator)</strong> is the total number of slices. The <strong>top number (numerator)</strong> is how many slices we've picked!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTIPLICATION AS REPEATED ADDITION RENDERER ---
   const MultiplicationRepeatedAdditionRenderer = () => {
      const [groups, setGroups] = useState(3);
      const [perGroup, setPerGroup] = useState(4);
      const [showArray, setShowArray] = useState(true);

      const total = groups * perGroup;

      return (
         <div className="flex flex-col h-full bg-amber-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#fffbeb_0%,#fef3c7_100%)]" />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-amber-100 bg-white/50 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-700">EGG CARTON FARM</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multiplication: Repeated Addition</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-amber-600 uppercase tracking-tighter">Equation</div>
                  <div className="text-2xl font-black text-slate-800">
                     {groups} √ó {perGroup} = {total}
                  </div>
               </div>
            </div>

            {/* Farm View */}
            <div className="flex-1 relative flex items-center justify-center p-8">
               <div className="grid gap-4 transition-all duration-500" style={{ gridTemplateColumns: `repeat(${perGroup}, minmax(0, 1fr))` }}>
                  {Array.from({ length: total }).map((_, i) => (
                     <div
                        key={i}
                        className="w-12 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl border-2 border-amber-100 animate-in zoom-in duration-300"
                        style={{ animationDelay: `${i * 50}ms` }}
                     >
                        ü•ö
                     </div>
                  ))}
               </div>

               {/* Chickens (Visual Labels) */}
               <div className="absolute left-4 top-1/2 -translate-y-1/2 flex flex-col gap-4">
                  {Array.from({ length: groups }).map((_, i) => (
                     <div key={i} className="w-12 h-12 bg-white rounded-2xl shadow-md flex items-center justify-center text-2xl border border-amber-100">üêî</div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-amber-100 flex flex-col items-center gap-6">
               <div className="flex gap-12">
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">How many groups?</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5, 6].map(n => (
                           <button
                              key={n}
                              onClick={() => setGroups(n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${groups === n ? 'bg-amber-600 text-white scale-110 shadow-lg' : 'bg-white text-amber-600 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">How many per group?</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5, 6].map(n => (
                           <button
                              key={n}
                              onClick={() => setPerGroup(n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${perGroup === n ? 'bg-amber-600 text-white scale-110 shadow-lg' : 'bg-white text-amber-600 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="flex flex-col items-center gap-2">
                  <div className="text-lg font-black text-amber-700">
                     {Array.from({ length: groups }).map((_, i) => (
                        <span key={i}>
                           {perGroup}{i < groups - 1 ? ' + ' : ` = ${total}`}
                        </span>
                     ))}
                  </div>
                  <p className="text-xs text-slate-500 max-w-md text-center">
                     <strong>Multiplication</strong> is just adding the same number over and over! Here we have {groups} groups of {perGroup} eggs.
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- DIVISION AS FAIR SHARING RENDERER ---
   const DivisionFairSharingRenderer = () => {
      const [totalCoins, setTotalCoins] = useState(12);
      const [pirates, setPirates] = useState(3);
      const [piles, setPiles] = useState<number[]>([]);
      const [isDealing, setIsDealing] = useState(false);

      const handleDeal = () => {
         setIsDealing(true);
         const perPirate = Math.floor(totalCoins / pirates);
         const newPiles = Array(pirates).fill(0);

         let current = 0;
         const interval = setInterval(() => {
            if (current < totalCoins - (totalCoins % pirates)) {
               newPiles[current % pirates]++;
               setPiles([...newPiles]);
               current++;
            } else {
               clearInterval(interval);
               setIsDealing(false);
            }
         }, 100);
      };

      const reset = (newTotal?: number, newPirates?: number) => {
         if (newTotal !== undefined) setTotalCoins(newTotal);
         if (newPirates !== undefined) setPirates(newPirates);
         setPiles([]);
         setIsDealing(false);
      };

      const remainder = totalCoins % pirates;
      const perPirate = Math.floor(totalCoins / pirates);

      return (
         <div className="flex flex-col h-full bg-sky-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Ocean Background */}
            <div className="absolute inset-0 bg-gradient-to-b from-sky-300 to-blue-400" />
            <div className="absolute bottom-0 left-0 right-0 h-32 bg-amber-100" /> {/* Sand */}

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/20 bg-white/20 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-amber-900">TREASURE ISLAND</h3>
                  <p className="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Division: Fair Sharing</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-amber-800 uppercase tracking-tighter">Equation</div>
                  <div className="text-2xl font-black text-slate-900">
                     {totalCoins} √∑ {pirates} = {perPirate} {remainder > 0 ? `R${remainder}` : ''}
                  </div>
               </div>
            </div>

            {/* Pirate View */}
            <div className="flex-1 relative flex flex-col items-center justify-center p-8">
               {/* Main Chest */}
               <div className="mb-12 relative">
                  <div className="w-32 h-24 bg-amber-800 rounded-lg border-4 border-amber-900 shadow-2xl flex flex-wrap justify-center p-2 gap-1 overflow-hidden">
                     {Array.from({ length: totalCoins - (piles.reduce((a, b) => a + b, 0)) }).map((_, i) => (
                        <div key={i} className="w-4 h-4 bg-yellow-400 rounded-full border border-yellow-600 shadow-sm" />
                     ))}
                  </div>
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-900 text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase">Chest</div>
               </div>

               {/* Pirates and their piles */}
               <div className="flex gap-12 items-end">
                  {Array.from({ length: pirates }).map((_, i) => (
                     <div key={i} className="flex flex-col items-center gap-4">
                        <div className="relative flex flex-col-reverse items-center gap-1 min-h-[100px]">
                           {Array.from({ length: piles[i] || 0 }).map((_, j) => (
                              <div
                                 key={j}
                                 className="w-8 h-2 bg-yellow-400 rounded-full border border-yellow-600 shadow-sm animate-in slide-in-from-top-12 duration-300"
                              />
                           ))}
                        </div>
                        <div className="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-4xl border-4 border-amber-200">üè¥‚Äç‚ò†Ô∏è</div>
                        <div className="bg-amber-900 text-white px-2 py-1 rounded-lg text-xs font-black">{piles[i] || 0}</div>
                     </div>
                  ))}
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/60 backdrop-blur-md border-t border-white/20 flex flex-col items-center gap-6">
               <div className="flex gap-12">
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Coins</span>
                     <div className="flex gap-2">
                        {[10, 12, 15, 20].map(n => (
                           <button
                              key={n}
                              onClick={() => reset(n, pirates)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${totalCoins === n ? 'bg-amber-700 text-white scale-110 shadow-lg' : 'bg-white text-amber-700 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
                  <div className="flex flex-col items-center gap-2">
                     <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Pirate Crew</span>
                     <div className="flex gap-2">
                        {[2, 3, 4, 5].map(n => (
                           <button
                              key={n}
                              onClick={() => reset(totalCoins, n)}
                              className={`w-10 h-10 rounded-xl font-black transition-all ${pirates === n ? 'bg-amber-700 text-white scale-110 shadow-lg' : 'bg-white text-amber-700 border border-amber-100 hover:bg-amber-50'}`}
                           >
                              {n}
                           </button>
                        ))}
                     </div>
                  </div>
               </div>

               <div className="flex gap-4 w-full max-w-md">
                  <button
                     onClick={handleDeal}
                     disabled={isDealing || piles.length > 0}
                     className="flex-1 h-14 bg-amber-700 text-white font-black rounded-2xl shadow-lg hover:bg-amber-800 transition-all disabled:opacity-50"
                  >
                     SHARE FAIRLY! üí∞
                  </button>
                  <button
                     onClick={() => reset()}
                     className="w-14 h-14 bg-white text-slate-400 rounded-2xl border border-amber-100 hover:bg-amber-50 transition-colors flex items-center justify-center"
                  >
                     üîÑ
                  </button>
               </div>

               <p className="text-xs text-slate-500 max-w-md text-center">
                  <strong>Division</strong> is sharing a total amount into equal groups. Each pirate gets {perPirate} coins {remainder > 0 ? `and ${remainder} are left in the chest!` : 'fair and square!'}
               </p>
            </div>
         </div>
      );
   };


   // --- MULTI-DIGIT ADDITION WITH REGROUPING RENDERER ---
   const MultiDigitAdditionRegroupingRenderer = () => {
      const [num1, setNum1] = useState(47);
      const [num2, setNum2] = useState(28);
      const [step, setStep] = useState(0); // 0: initial, 1: combine ones, 2: regroup, 3: combine tens
      const [regrouped, setRegrouped] = useState(false);

      const ones1 = num1 % 10;
      const tens1 = Math.floor(num1 / 10);
      const ones2 = num2 % 10;
      const tens2 = Math.floor(num2 / 10);

      const totalOnes = ones1 + ones2;
      const needsRegroup = totalOnes >= 10;
      const resultOnes = totalOnes % 10;
      const carry = needsRegroup ? 1 : 0;
      const resultTens = tens1 + tens2 + carry;

      const reset = () => {
         setStep(0);
         setRegrouped(false);
      };

      return (
         <div className="flex flex-col h-full bg-slate-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Background */}
            <div className="absolute inset-0 bg-slate-100 opacity-50" style={{ backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' }} />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-slate-200 bg-white/80 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-blue-600">CONSTRUCTION CRANE</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multi-Digit Addition: Regrouping</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="text-right">
                     <div className="text-2xl font-black text-slate-800 tabular-nums">
                        {num1} + {num2} = {step === 3 ? num1 + num2 : '?'}
                     </div>
                  </div>
               </div>
            </div>

            {/* Construction Site */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-16">
               {/* Place Value Columns */}
               <div className="flex gap-8">
                  {/* Tens Column */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-blue-50/50 rounded-3xl border-2 border-dashed border-blue-200 min-w-[120px]">
                     <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Tens</span>
                     <div className="flex flex-col gap-2">
                        {Array.from({ length: tens1 }).map((_, i) => (
                           <div key={`t1-${i}`} className="w-6 h-20 bg-blue-500 rounded-sm border border-blue-600 shadow-sm" />
                        ))}
                        {Array.from({ length: tens2 }).map((_, i) => (
                           <div key={`t2-${i}`} className="w-6 h-20 bg-blue-400 rounded-sm border border-blue-500 shadow-sm" />
                        ))}
                        {step === 3 && carry === 1 && (
                           <div className="w-6 h-20 bg-orange-500 rounded-sm border border-orange-600 shadow-sm animate-in slide-in-from-right-12 duration-500" />
                        )}
                     </div>
                  </div>

                  {/* Ones Column */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-orange-50/50 rounded-3xl border-2 border-dashed border-orange-200 min-w-[120px]">
                     <span className="text-[10px] font-black text-orange-400 uppercase tracking-widest">Ones</span>
                     <div className="grid grid-cols-2 gap-2">
                        {step < 2 ? (
                           <>
                              {Array.from({ length: ones1 }).map((_, i) => (
                                 <div key={`o1-${i}`} className="w-6 h-6 bg-orange-500 rounded-sm border border-orange-600 shadow-sm" />
                              ))}
                              {Array.from({ length: ones2 }).map((_, i) => (
                                 <div key={`o2-${i}`} className="w-6 h-6 bg-orange-400 rounded-sm border border-orange-500 shadow-sm" />
                              ))}
                           </>
                        ) : (
                           Array.from({ length: resultOnes }).map((_, i) => (
                              <div key={`ro-${i}`} className="w-6 h-6 bg-orange-500 rounded-sm border border-orange-600 shadow-sm animate-in zoom-in duration-300" />
                           ))
                        )}
                     </div>
                  </div>
               </div>

               {/* Step Visualizer */}
               <div className="w-64 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 0 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">1. Look at the Ones</p>
                     <p className="text-[10px] text-slate-500">{ones1} + {ones2} = {totalOnes}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 1 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">2. Regroup?</p>
                     <p className="text-[10px] text-slate-500">{totalOnes >= 10 ? 'Yes! 10 ones = 1 ten' : 'No need!'}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 2 ? 'bg-white border-blue-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">3. Add the Tens</p>
                     <p className="text-[10px] text-slate-500">{tens1} + {tens2} {carry > 0 ? '+ 1' : ''} = {resultTens}</p>
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/80 backdrop-blur-md border-t border-slate-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  {step < 3 ? (
                     <button
                        onClick={() => setStep(s => s + 1)}
                        className="flex-1 h-14 bg-blue-600 text-white font-black rounded-2xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                     >
                        {step === 0 ? 'COMBINE ONES' : step === 1 ? 'REGROUP 10 ONES' : 'ADD TENS'} üèóÔ∏è
                     </button>
                  ) : (
                     <button
                        onClick={reset}
                        className="flex-1 h-14 bg-slate-800 text-white font-black rounded-2xl shadow-lg hover:bg-slate-900 transition-all"
                     >
                        START NEW BUILD
                     </button>
                  )}
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center border border-blue-500/20 shrink-0">
                     <span className="text-2xl">üèóÔ∏è</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     When we have <strong>10 or more ones</strong>, we "regroup" them into a single ten-rod and move it to the tens column. This is what we call "carrying"!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTI-DIGIT SUBTRACTION WITH BORROWING RENDERER ---
   const MultiDigitSubtractionBorrowingRenderer = () => {
      const [num1, setNum1] = useState(52);
      const [num2, setNum2] = useState(27);
      const [step, setStep] = useState(0); // 0: initial, 1: borrow, 2: subtract ones, 3: subtract tens

      const ones1 = num1 % 10;
      const tens1 = Math.floor(num1 / 10);
      const ones2 = num2 % 10;
      const tens2 = Math.floor(num2 / 10);

      const needsBorrow = ones1 < ones2;
      const borrowedOnes = ones1 + 10;
      const remainingTens = tens1 - 1;

      const reset = () => {
         setStep(0);
      };

      return (
         <div className="flex flex-col h-full bg-emerald-50 text-slate-900 font-sans overflow-hidden relative">
            {/* Vault Background */}
            <div className="absolute inset-0 bg-slate-200 opacity-30" style={{ backgroundImage: 'repeating-linear-gradient(45deg, #94a3b8 0, #94a3b8 1px, transparent 0, transparent 50%)', backgroundSize: '10px 10px' }} />

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-emerald-200 bg-white/80 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-emerald-700">BANK VAULT</h3>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Multi-Digit Subtraction: Borrowing</p>
               </div>
               <div className="flex gap-4 items-center">
                  <div className="text-right">
                     <div className="text-2xl font-black text-slate-800 tabular-nums">
                        {num1} - {num2} = {step === 3 ? num1 - num2 : '?'}
                     </div>
                  </div>
               </div>
            </div>

            {/* Vault Interior */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-16">
               {/* Place Value Safes */}
               <div className="flex gap-8">
                  {/* Tens Safe */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-slate-800 rounded-3xl border-4 border-slate-700 min-w-[140px] shadow-2xl">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tens (Bills)</span>
                     <div className="flex flex-col gap-2">
                        {Array.from({ length: step >= 1 ? remainingTens : tens1 }).map((_, i) => (
                           <div key={`t-${i}`} className="w-12 h-6 bg-emerald-500 rounded-sm border-2 border-emerald-600 shadow-sm flex items-center justify-center text-[10px] font-bold text-emerald-900">$10</div>
                        ))}
                        {step === 0 && needsBorrow && (
                           <div className="w-12 h-6 bg-emerald-400 rounded-sm border-2 border-emerald-500 opacity-50 border-dashed" />
                        )}
                     </div>
                  </div>

                  {/* Ones Safe */}
                  <div className="flex flex-col items-center gap-4 p-6 bg-slate-700 rounded-3xl border-4 border-slate-600 min-w-[140px] shadow-2xl">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ones (Coins)</span>
                     <div className="grid grid-cols-3 gap-2">
                        {Array.from({ length: step >= 1 ? borrowedOnes : ones1 }).map((_, i) => (
                           <div key={`o-${i}`} className={`w-6 h-6 bg-yellow-400 rounded-full border-2 border-yellow-600 shadow-sm flex items-center justify-center text-[8px] font-bold text-yellow-900 ${i >= ones1 ? 'animate-in zoom-in duration-500' : ''}`}>$1</div>
                        ))}
                     </div>
                  </div>
               </div>

               {/* Step Visualizer */}
               <div className="w-64 flex flex-col gap-4">
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 0 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">1. Check the Ones</p>
                     <p className="text-[10px] text-slate-500">Can we take {ones2} from {ones1}?</p>
                     {needsBorrow && <p className="text-[10px] text-red-500 font-bold">No! Need to borrow.</p>}
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 1 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">2. Borrow a Ten</p>
                     <p className="text-[10px] text-slate-500">Break $10 into ten $1 coins.</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 2 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">3. Subtract Ones</p>
                     <p className="text-[10px] text-slate-500">{step >= 1 ? borrowedOnes : ones1} - {ones2} = {step >= 2 ? (step >= 1 ? borrowedOnes : ones1) - ones2 : '?'}</p>
                  </div>
                  <div className={`p-4 rounded-2xl border-2 transition-all ${step === 3 ? 'bg-white border-emerald-500 shadow-lg' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                     <p className="text-xs font-bold">4. Subtract Tens</p>
                     <p className="text-[10px] text-slate-500">{step >= 1 ? remainingTens : tens1} - {tens2} = {step === 3 ? (step >= 1 ? remainingTens : tens1) - tens2 : '?'}</p>
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-white/80 backdrop-blur-md border-t border-emerald-200 flex flex-col items-center gap-6">
               <div className="flex gap-4 w-full max-w-md">
                  {step < 3 ? (
                     <button
                        onClick={() => setStep(s => s + 1)}
                        className="flex-1 h-14 bg-emerald-600 text-white font-black rounded-2xl shadow-lg hover:bg-emerald-700 transition-all flex items-center justify-center gap-2"
                     >
                        {step === 0 ? 'BORROW FROM TENS' : step === 1 ? 'SUBTRACT ONES' : 'SUBTRACT TENS'} üè¶
                     </button>
                  ) : (
                     <button
                        onClick={reset}
                        className="flex-1 h-14 bg-slate-800 text-white font-black rounded-2xl shadow-lg hover:bg-slate-900 transition-all"
                     >
                        NEW WITHDRAWAL
                     </button>
                  )}
               </div>

               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shrink-0">
                     <span className="text-2xl">üè¶</span>
                  </div>
                  <p className="text-xs text-slate-500 leading-relaxed">
                     When we don't have enough ones to subtract, we <strong>borrow</strong> one ten from the tens place and "break" it into 10 ones. Now we have plenty!
                  </p>
               </div>
            </div>
         </div>
      );
   };


   // --- MULTIPLICATION TABLES RENDERER ---
   const MultiplicationTablesRenderer = () => {
      const [selectedTable, setSelectedTable] = useState(2);
      const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);

      return (
         <div className="flex flex-col h-full bg-slate-950 text-white font-sans overflow-hidden relative">
            {/* Space Background */}
            <div className="absolute inset-0 overflow-hidden">
               {Array.from({ length: 50 }).map((_, i) => (
                  <div
                     key={i}
                     className="absolute bg-white rounded-full animate-pulse"
                     style={{
                        width: Math.random() * 3 + 'px',
                        height: Math.random() * 3 + 'px',
                        top: Math.random() * 100 + '%',
                        left: Math.random() * 100 + '%',
                        animationDelay: Math.random() * 5 + 's',
                        opacity: Math.random() * 0.7 + 0.3
                     }}
                  />
               ))}
            </div>

            {/* Header */}
            <div className="relative z-10 p-6 flex justify-between items-center border-b border-white/10 bg-black/40 backdrop-blur-md">
               <div>
                  <h3 className="text-xl font-black tracking-tight text-indigo-400">TIMES TABLE GALAXY</h3>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Multiplication Tables (1-12)</p>
               </div>
               <div className="flex flex-col items-end">
                  <div className="text-xs font-bold text-indigo-500 uppercase tracking-tighter">Selected Table</div>
                  <div className="text-2xl font-black text-white">
                     The {selectedTable}s
                  </div>
               </div>
            </div>

            {/* Galaxy View */}
            <div className="flex-1 relative flex items-center justify-center p-8 gap-12">
               {/* Table Grid */}
               <div className="grid grid-cols-4 gap-4 max-w-md">
                  {Array.from({ length: 12 }).map((_, i) => {
                     const factor = i + 1;
                     const product = selectedTable * factor;
                     return (
                        <div
                           key={factor}
                           onMouseEnter={() => setHoveredProduct(product)}
                           onMouseLeave={() => setHoveredProduct(null)}
                           className={`group relative p-4 rounded-2xl border-2 transition-all cursor-pointer ${hoveredProduct === product ? 'bg-indigo-600/40 border-indigo-400 scale-105 shadow-lg shadow-indigo-500/20' : 'bg-white/5 border-white/10 hover:border-white/30'}`}
                        >
                           <div className="text-[10px] font-bold text-slate-500 mb-1">{selectedTable} √ó {factor}</div>
                           <div className="text-2xl font-black text-white tabular-nums">{product}</div>

                           {/* Orbiting Particle */}
                           {hoveredProduct === product && (
                              <div className="absolute inset-0 border-2 border-indigo-400/50 rounded-2xl animate-ping" />
                           )}
                        </div>
                     );
                  })}
               </div>

               {/* Planet Selector */}
               <div className="flex flex-col gap-2">
                  <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Select Planet</span>
                  <div className="grid grid-cols-3 gap-2">
                     {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(n => (
                        <button
                           key={n}
                           onClick={() => setSelectedTable(n)}
                           className={`w-12 h-12 rounded-full font-black transition-all flex items-center justify-center border-2 ${selectedTable === n ? 'bg-indigo-600 border-indigo-400 text-white scale-110 shadow-lg shadow-indigo-500/40' : 'bg-black/40 border-white/10 text-slate-400 hover:border-white/30'}`}
                        >
                           {n}
                        </button>
                     ))}
                  </div>
               </div>
            </div>

            {/* Controls */}
            <div className="relative z-10 p-8 bg-black/60 backdrop-blur-md border-t border-white/10 flex flex-col items-center gap-6">
               <div className="max-w-2xl mx-auto flex items-center gap-6">
                  <div className="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center border border-indigo-500/30 shrink-0">
                     <span className="text-2xl">üöÄ</span>
                  </div>
                  <div className="flex flex-col gap-1">
                     <p className="text-sm font-bold text-indigo-300">
                        {hoveredProduct ? `Did you know? ${selectedTable} times something is always ${hoveredProduct % 2 === 0 ? 'even' : 'odd'} here!` : 'Explore the galaxy of numbers!'}
                     </p>
                     <p className="text-xs text-slate-500 leading-relaxed">
                        Multiplication tables help us find patterns. For example, the 5s always end in 0 or 5, and the 9s digits always add up to 9!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };





   // --- STRESS RESPONSE VISUALIZER ---
   const StressResponseRenderer = () => {
      const [stressLevel, setStressLevel] = useState(50); // 0-100
      const [technique, setTechnique] = useState<string | null>(null);
      const [metrics, setMetrics] = useState({ hr: 72, bp: '120/80', cortisol: 'Normal', tension: 'Low' });
      const [time, setTime] = useState(0);

      useEffect(() => {
         // Base metrics based on stress level
         const hr = 60 + (stressLevel * 0.6);
         const sys = 110 + (stressLevel * 0.4);
         const dia = 70 + (stressLevel * 0.3);
         const tension = stressLevel < 30 ? 'Low' : stressLevel < 70 ? 'Moderate' : 'High';
         const cortisol = stressLevel < 40 ? 'Normal' : stressLevel < 80 ? 'Elevated' : 'High';

         setMetrics({
            hr: Math.round(hr),
            bp: `${Math.round(sys)}/${Math.round(dia)}`,
            cortisol,
            tension
         });
      }, [stressLevel]);

      useEffect(() => {
         let interval: any;
         if (technique) {
            interval = setInterval(() => {
               setStressLevel(prev => Math.max(0, prev - 2));
               setTime(t => t + 1);
               if (time > 10) {
                  setTechnique(null);
                  setTime(0);
               }
            }, 500);
         }
         return () => clearInterval(interval);
      }, [technique, time]);

      const startTechnique = (name: string) => {
         setTechnique(name);
         setTime(0);
      };

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col overflow-hidden text-white font-sans">
            <div className="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Stress Response System</h2>
                  <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Physiological Feedback Loop</p>
               </div>
               <div className="flex items-center gap-4">
                  <span className="text-[10px] font-bold text-slate-500">STRESS LEVEL</span>
                  <input
                     type="range" min="0" max="100" value={stressLevel}
                     onChange={(e) => setStressLevel(parseInt(e.target.value))}
                     className="w-32 accent-red-500"
                  />
                  <span className={`text-sm font-black w-8 ${stressLevel > 70 ? 'text-red-500' : 'text-emerald-500'}`}>{stressLevel}%</span>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Biological Map */}
               <div className="flex-1 relative p-12 flex items-center justify-center">
                  <div className="relative w-full max-w-lg aspect-square border-2 border-slate-800 rounded-[40px] bg-slate-900/50 flex flex-col items-center p-8">
                     <div className="w-24 h-24 bg-slate-800 rounded-3xl flex items-center justify-center border-2 border-slate-700 mb-8 relative">
                        <span className="text-2xl">üß†</span>
                        <div className={`absolute -bottom-2 px-2 py-0.5 rounded text-[8px] font-black ${stressLevel > 50 ? 'bg-red-500 animate-pulse' : 'bg-slate-700'}`}>AMYGDALA</div>
                     </div>

                     <div className="flex-1 w-full grid grid-cols-2 gap-8">
                        <div className="flex flex-col items-center justify-center gap-4">
                           <div className={`w-1 h-16 bg-gradient-to-b from-slate-700 to-red-500/50 ${stressLevel > 50 ? 'opacity-100' : 'opacity-20'}`} />
                           <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 text-center w-full">
                              <p className="text-[8px] font-black text-slate-500 uppercase mb-1">Hormonal</p>
                              <p className="text-xs font-bold text-red-400">Cortisol Release</p>
                              <p className="text-[8px] text-slate-400 mt-2">Long-term effects</p>
                           </div>
                        </div>
                        <div className="flex flex-col items-center justify-center gap-4">
                           <div className={`w-1 h-16 bg-gradient-to-b from-slate-700 to-orange-500/50 ${stressLevel > 30 ? 'opacity-100' : 'opacity-20'}`} />
                           <div className="p-4 bg-slate-800 rounded-2xl border border-slate-700 text-center w-full">
                              <p className="text-[8px] font-black text-slate-500 uppercase mb-1">Sympathetic</p>
                              <p className="text-xs font-bold text-orange-400">Adrenaline Spike</p>
                              <p className="text-[8px] text-slate-400 mt-2">Immediate effects</p>
                           </div>
                        </div>
                     </div>

                     {technique && (
                        <div className="absolute inset-0 bg-emerald-500/10 backdrop-blur-sm rounded-[40px] flex items-center justify-center flex-col">
                           <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4" />
                           <p className="text-emerald-400 font-black uppercase tracking-widest">{technique}...</p>
                        </div>
                     )}
                  </div>
               </div>

               {/* Metrics Panel */}
               <div className="w-full lg:w-96 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-8">
                  <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Biometric Feedback</p>

                  <div className="grid grid-cols-1 gap-4">
                     {[
                        { label: 'Heart Rate', value: `${metrics.hr} bpm`, color: 'text-red-400', icon: '‚ù§Ô∏è' },
                        { label: 'Blood Pressure', value: metrics.bp, color: 'text-orange-400', icon: 'ü©∏' },
                        { label: 'Cortisol', value: metrics.cortisol, color: 'text-yellow-400', icon: 'üß™' },
                        { label: 'Muscle Tension', value: metrics.tension, color: 'text-blue-400', icon: 'üí™' }
                     ].map(m => (
                        <div key={m.label} className="bg-slate-950 p-5 rounded-3xl border border-slate-800 flex justify-between items-center">
                           <div>
                              <p className="text-[8px] font-bold text-slate-500 uppercase mb-1">{m.label}</p>
                              <p className={`text-xl font-black ${m.color}`}>{m.value}</p>
                           </div>
                           <span className="text-2xl opacity-50">{m.icon}</span>
                        </div>
                     ))}
                  </div>

                  <div className="mt-auto space-y-4">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Active Interventions</p>
                     <div className="grid grid-cols-1 gap-2">
                        <button
                           onClick={() => startTechnique('Deep Breathing')}
                           className="p-4 bg-emerald-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-emerald-400 transition-all uppercase"
                        >
                           Deep Breathing
                        </button>
                        <button
                           onClick={() => startTechnique('Grounding')}
                           className="p-4 bg-blue-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-blue-400 transition-all uppercase"
                        >
                           5-4-3-2-1 Grounding
                        </button>
                        <button
                           onClick={() => startTechnique('Muscle Relaxation')}
                           className="p-4 bg-purple-500 text-slate-950 rounded-2xl font-black text-xs hover:bg-purple-400 transition-all uppercase"
                        >
                           Progressive Relaxation
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FORCE CLASSIFICATION RENDERER (Balanced vs. Unbalanced) ---
   const ForceClassificationRenderer = () => {
      const [scenario, setScenario] = useState<'rest' | 'constant' | 'accel' | 'braking'>('rest');
      const [showNet, setShowNet] = useState(false);
      const [userGuess, setUserGuess] = useState<'balanced' | 'unbalanced' | null>(null);
      const [feedback, setFeedback] = useState<string | null>(null);

      const scenarios = {
         rest: { forces: { N: 50, S: 50, E: 0, W: 0 }, label: 'Object at Rest', correct: 'balanced', desc: 'Gravity and Normal force cancel out. No horizontal forces.' },
         constant: { forces: { N: 50, S: 50, E: 30, W: 30 }, label: 'Constant Velocity', correct: 'balanced', desc: 'Applied force equals Friction. Net force is zero!' },
         accel: { forces: { N: 50, S: 50, E: 60, W: 20 }, label: 'Accelerating Right', correct: 'unbalanced', desc: 'Applied force is greater than Friction. Object speeds up.' },
         braking: { forces: { N: 50, S: 50, E: 0, W: 40 }, label: 'Braking to a Stop', correct: 'unbalanced', desc: 'Only Friction is acting horizontally. Object slows down.' }
      };

      const current = scenarios[scenario];
      const netX = current.forces.E - current.forces.W;
      const netY = current.forces.N - current.forces.S;

      const handleGuess = (guess: 'balanced' | 'unbalanced') => {
         setUserGuess(guess);
         if (guess === current.correct) {
            setFeedback('CORRECT! ' + current.desc);
         } else {
            setFeedback('NOT QUITE. ' + current.desc);
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Force Classification</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Balanced vs. Unbalanced Forces</p>
               </div>
               <div className="flex gap-2">
                  {Object.keys(scenarios).map(s => (
                     <button
                        key={s} onClick={() => { setScenario(s as any); setUserGuess(null); setFeedback(null); setShowNet(false); }}
                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase ${scenario === s ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                           }`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Stage */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

                  <div className="relative w-48 h-32 bg-blue-600 rounded-2xl shadow-2xl border-4 border-blue-700 flex items-center justify-center z-10">
                     <span className="text-white font-black text-sm uppercase tracking-tighter">{current.label}</span>

                     {/* Force Arrows */}
                     {/* North (Normal) */}
                     <div className="absolute bottom-full mb-2 flex flex-col items-center" style={{ height: `${current.forces.N}px` }}>
                        <div className="w-0 h-0 border-l-6 border-l-transparent border-r-6 border-r-transparent border-b-[10px] border-b-emerald-500" />
                        <div className="w-1.5 bg-emerald-500 flex-1" />
                        <span className="absolute -top-6 text-[8px] font-bold text-emerald-600">NORMAL</span>
                     </div>
                     {/* South (Gravity) */}
                     <div className="absolute top-full mt-2 flex flex-col items-center" style={{ height: `${current.forces.S}px` }}>
                        <div className="w-1.5 bg-red-500 flex-1" />
                        <div className="w-0 h-0 border-l-6 border-l-transparent border-r-6 border-r-transparent border-t-[10px] border-t-red-500" />
                        <span className="absolute -bottom-6 text-[8px] font-bold text-red-600">GRAVITY</span>
                     </div>
                     {/* East (Applied) */}
                     {current.forces.E > 0 && (
                        <div className="absolute left-full ml-2 flex items-center" style={{ width: `${current.forces.E}px` }}>
                           <div className="h-1.5 bg-blue-500 flex-1" />
                           <div className="w-0 h-0 border-t-6 border-t-transparent border-b-6 border-b-transparent border-l-[10px] border-l-blue-500" />
                           <span className="absolute -top-4 left-0 text-[8px] font-bold text-blue-600">APPLIED</span>
                        </div>
                     )}
                     {/* West (Friction) */}
                     {current.forces.W > 0 && (
                        <div className="absolute right-full mr-2 flex items-center" style={{ width: `${current.forces.W}px` }}>
                           <div className="w-0 h-0 border-t-6 border-t-transparent border-b-6 border-b-transparent border-r-[10px] border-r-amber-500" />
                           <div className="h-1.5 bg-amber-500 flex-1" />
                           <span className="absolute -top-4 right-0 text-[8px] font-bold text-amber-600">FRICTION</span>
                        </div>
                     )}

                     {/* Net Force Vector */}
                     {showNet && (Math.abs(netX) > 0 || Math.abs(netY) > 0) && (
                        <div
                           className="absolute z-20 pointer-events-none"
                           style={{
                              transform: `translate(${netX / 2}px, ${-netY / 2}px)`,
                              width: `${Math.abs(netX)}px`,
                              height: `${Math.abs(netY)}px`
                           }}
                        >
                           <div className="absolute inset-0 border-2 border-dashed border-slate-900 rounded-xl opacity-30" />
                           <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 text-white text-[8px] font-black px-2 py-1 rounded whitespace-nowrap">
                              NET FORCE: {Math.sqrt(netX * netX + netY * netY).toFixed(0)}N
                           </div>
                        </div>
                     )}
                  </div>
               </div>

               {/* Analysis & Quiz */}
               <div className="w-full lg:w-96 bg-white border-l border-slate-200 p-8 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Analysis Challenge</p>
                     <h3 className="text-lg font-black text-slate-900 leading-tight">Are the forces on this object balanced?</h3>

                     <div className="grid grid-cols-2 gap-4">
                        <button
                           onClick={() => handleGuess('balanced')}
                           className={`py-4 rounded-2xl font-black text-sm border-2 transition-all ${userGuess === 'balanced' ? 'bg-emerald-500 border-emerald-600 text-white shadow-lg' : 'bg-white border-slate-100 hover:border-emerald-200 text-slate-600'
                              }`}
                        >
                           BALANCED
                        </button>
                        <button
                           onClick={() => handleGuess('unbalanced')}
                           className={`py-4 rounded-2xl font-black text-sm border-2 transition-all ${userGuess === 'unbalanced' ? 'bg-amber-500 border-amber-600 text-white shadow-lg' : 'bg-white border-slate-100 hover:border-amber-200 text-slate-600'
                              }`}
                        >
                           UNBALANCED
                        </button>
                     </div>

                     {feedback && (
                        <div className={`p-5 rounded-3xl border-2 animate-in fade-in slide-in-from-top-2 ${userGuess === current.correct ? 'bg-emerald-50 border-emerald-100 text-emerald-900' : 'bg-amber-50 border-amber-100 text-amber-900'
                           }`}>
                           <p className="text-xs font-bold leading-relaxed">{feedback}</p>
                           <button
                              onClick={() => setShowNet(true)}
                              className="mt-4 text-[10px] font-black underline uppercase tracking-widest opacity-60 hover:opacity-100"
                           >
                              Show Net Force Vector
                           </button>
                        </div>
                     )}
                  </div>

                  {/* Rules of Motion */}
                  <div className="mt-auto space-y-4">
                     <div className="p-6 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">The Golden Rules</p>
                        <ul className="space-y-4">
                           <li className="flex gap-3">
                              <span className="text-emerald-400 font-black">1.</span>
                              <p className="text-[10px] leading-relaxed"><strong>Balanced Forces</strong> mean NO change in motion (Rest or Constant Speed).</p>
                           </li>
                           <li className="flex gap-3">
                              <span className="text-amber-400 font-black">2.</span>
                              <p className="text-[10px] leading-relaxed"><strong>Unbalanced Forces</strong> mean the object IS accelerating (Speeding up or Slowing down).</p>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GRAVITY & FREE FALL RENDERER (Vacuum vs. Air) ---
   const GravityAccelerationRenderer = () => {
      const [isVacuum, setIsVacuum] = useState(false);
      const [height, setHeight] = useState(10); // meters
      const [isFalling, setIsFalling] = useState(false);
      const [time, setTime] = useState(0);
      const [obj1, setObj1] = useState({ y: 0, v: 0, a: 9.8, type: 'ball' });
      const [obj2, setObj2] = useState({ y: 0, v: 0, a: 9.8, type: 'feather' });
      const [history, setHistory] = useState<{ t: number, y1: number, y2: number }[]>([]);

      const g = 9.81;
      const dragFeather = isVacuum ? 0 : 0.8;
      const dragBall = isVacuum ? 0 : 0.05;

      useEffect(() => {
         let interval: any;
         if (isFalling) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;
               setTime(elapsed);

               // Physics update
               setObj1(prev => {
                  const airRes = dragBall * prev.v * prev.v;
                  const netA = g - (airRes / 1); // mass = 1
                  const newV = prev.v + netA * 0.03;
                  const newY = prev.y + newV * 0.03 * 20; // scale
                  return { ...prev, v: newV, y: newY > 300 ? 300 : newY };
               });

               setObj2(prev => {
                  const airRes = dragFeather * prev.v * prev.v;
                  const netA = g - (airRes / 0.1); // mass = 0.1
                  const newV = prev.v + netA * 0.03;
                  const newY = prev.y + newV * 0.03 * 20; // scale
                  return { ...prev, v: newV, y: newY > 300 ? 300 : newY };
               });

               setHistory(prev => [...prev.slice(-50), { t: elapsed, y1: obj1.y, y2: obj2.y }]);

               if (obj1.y >= 300 && obj2.y >= 300) {
                  setIsFalling(false);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isFalling, isVacuum, dragBall, dragFeather]);

      const reset = () => {
         setIsFalling(false);
         setTime(0);
         setObj1({ y: 0, v: 0, a: 9.8, type: 'ball' });
         setObj2({ y: 0, v: 0, a: 9.8, type: 'feather' });
         setHistory([]);
      };

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col overflow-hidden text-white font-sans">
            {/* Header */}
            <div className="p-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
               <div>
                  <h2 className="text-xl font-black tracking-tight">Gravity & Free Fall</h2>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Galileo's Experiment</p>
               </div>
               <div className="flex gap-4">
                  <div className="flex items-center gap-3 bg-slate-900 px-4 py-2 rounded-2xl border border-slate-700">
                     <span className="text-[10px] font-bold text-slate-500">VACUUM</span>
                     <button
                        onClick={() => { setIsVacuum(!isVacuum); reset(); }}
                        className={`w-12 h-6 rounded-full relative transition-colors ${isVacuum ? 'bg-emerald-500' : 'bg-slate-700'}`}
                     >
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${isVacuum ? 'left-7' : 'left-1'}`} />
                     </button>
                  </div>
                  <button onClick={reset} className="p-2 bg-slate-700 rounded-xl hover:bg-slate-600 transition-colors">‚Ü∫</button>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Drop Zone */}
               <div className="flex-1 relative bg-slate-950 flex justify-center p-12">
                  {/* Vacuum Chamber Effect */}
                  {isVacuum && (
                     <div className="absolute inset-4 border-2 border-emerald-500/20 rounded-3xl bg-emerald-500/5 backdrop-blur-[2px]" />
                  )}

                  {/* Height Scale */}
                  <div className="absolute left-12 top-12 bottom-12 w-1 bg-slate-800 flex flex-col justify-between py-2">
                     {[10, 8, 6, 4, 2, 0].map(m => (
                        <div key={m} className="relative flex items-center">
                           <div className="w-4 h-[1px] bg-slate-600" />
                           <span className="absolute left-6 text-[8px] font-bold text-slate-500">{m}m</span>
                        </div>
                     ))}
                  </div>

                  <div className="relative w-64 h-[350px] flex justify-around items-start pt-10">
                     {/* Object 1: Ball */}
                     <div className="flex flex-col items-center">
                        <div
                           className="w-12 h-12 bg-slate-300 rounded-full shadow-2xl border-4 border-slate-400 flex items-center justify-center transition-transform duration-30"
                           style={{ transform: `translateY(${obj1.y}px)` }}
                        >
                           <div className="w-2 h-2 bg-slate-500 rounded-full opacity-50" />
                        </div>
                        <span className="mt-4 text-[8px] font-black text-slate-500 uppercase">Bowling Ball</span>
                     </div>

                     {/* Object 2: Feather */}
                     <div className="flex flex-col items-center">
                        <div
                           className="w-12 h-12 flex items-center justify-center transition-transform duration-30"
                           style={{ transform: `translateY(${obj2.y}px) rotate(${isFalling && !isVacuum ? Math.sin(time * 10) * 20 : 0}deg)` }}
                        >
                           <svg className="w-10 h-10 text-emerald-400 opacity-80" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M21,3C21,3 18,3 15,6C12,9 12,13 12,13C12,13 11,12 9,12C7,12 3,15 3,15C3,15 7,16 9,18C11,20 12,24 12,24C12,24 15,20 15,18C15,16 14,15 14,15C14,15 18,15 21,12C24,9 21,3 21,3Z" />
                           </svg>
                        </div>
                        <span className="mt-4 text-[8px] font-black text-slate-500 uppercase">Feather</span>
                     </div>

                     {/* Ground */}
                     <div className="absolute bottom-0 left-0 right-0 h-2 bg-slate-800 rounded-full shadow-[0_0_20px_rgba(0,0,0,0.5)]" />
                  </div>

                  {/* Drop Button */}
                  <div className="absolute bottom-12 left-1/2 -translate-x-1/2">
                     <button
                        onClick={() => setIsFalling(true)}
                        disabled={isFalling}
                        className="px-12 py-4 bg-emerald-500 text-slate-900 rounded-2xl font-black text-xl shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:bg-emerald-400 disabled:opacity-30 transition-all transform active:scale-95"
                     >
                        {isFalling ? 'FALLING...' : 'RELEASE'}
                     </button>
                  </div>
               </div>

               {/* Metrics & Analysis */}
               <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-8 flex flex-col gap-10 overflow-y-auto">
                  <div className="space-y-8">
                     <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Live Telemetry</p>

                     <div className="space-y-4">
                        <div className="bg-slate-800 p-5 rounded-3xl border border-slate-700">
                           <div className="flex justify-between items-center mb-4">
                              <span className="text-[8px] font-bold text-slate-500 uppercase">Time Elapsed</span>
                              <span className="text-xl font-mono font-black text-emerald-400">{time.toFixed(2)}s</span>
                           </div>
                           <div className="space-y-4">
                              <div className="space-y-1">
                                 <div className="flex justify-between text-[10px] font-bold">
                                    <span className="text-slate-400">Ball Velocity</span>
                                    <span className="text-white">{obj1.v.toFixed(1)} m/s</span>
                                 </div>
                                 <div className="h-1 bg-slate-900 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500 transition-all" style={{ width: `${(obj1.v / 20) * 100}%` }} />
                                 </div>
                              </div>
                              <div className="space-y-1">
                                 <div className="flex justify-between text-[10px] font-bold">
                                    <span className="text-slate-400">Feather Velocity</span>
                                    <span className="text-white">{obj2.v.toFixed(1)} m/s</span>
                                 </div>
                                 <div className="h-1 bg-slate-900 rounded-full overflow-hidden">
                                    <div className="h-full bg-emerald-500 transition-all" style={{ width: `${(obj2.v / 20) * 100}%` }} />
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>

                     {/* Graph Area */}
                     <div className="bg-slate-950 p-6 rounded-3xl border border-slate-800 h-48 flex flex-col">
                        <p className="text-[8px] font-bold text-slate-500 uppercase mb-4">Velocity vs. Time</p>
                        <div className="flex-1 relative border-l border-b border-slate-800">
                           <svg className="w-full h-full overflow-visible">
                              <polyline
                                 points={history.map((h, i) => `${(i / 50) * 100}%, ${100 - (h.y1 / 3)}%`).join(' ')}
                                 fill="none" stroke="#3b82f6" strokeWidth="2"
                              />
                              <polyline
                                 points={history.map((h, i) => `${(i / 50) * 100}%, ${100 - (h.y2 / 3)}%`).join(' ')}
                                 fill="none" stroke="#10b981" strokeWidth="2"
                              />
                           </svg>
                        </div>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-5 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
                     <div className="flex gap-3 mb-2">
                        <span className="text-emerald-400">üí°</span>
                        <h4 className="text-[10px] font-black text-emerald-400 uppercase">The Gravity Secret</h4>
                     </div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        In a <strong>Vacuum</strong>, all objects fall at the exact same rate regardless of mass!
                        Air resistance is what makes the feather slow down. Gravity pulls on everything equally.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- NET FORCE RENDERER (Vector Addition) ---
   const NetForceRenderer = () => {
      const [forces, setForces] = useState({ N: 0, S: 0, E: 0, W: 0 });
      const [showResultant, setShowResultant] = useState(true);
      const [showComponents, setShowComponents] = useState(true);
      const [mode, setMode] = useState<'1d' | '2d' | 'challenge'>('1d');
      const [target, setTarget] = useState({ x: 50, y: 0 });
      const [isBalanced, setIsBalanced] = useState(true);

      const netX = forces.E - forces.W;
      const netY = forces.N - forces.S;
      const magnitude = Math.sqrt(netX * netX + netY * netY);
      const angle = Math.atan2(netY, netX) * (180 / Math.PI);

      useEffect(() => {
         setIsBalanced(netX === 0 && netY === 0);
      }, [netX, netY]);

      const reset = () => {
         setForces({ N: 0, S: 0, E: 0, W: 0 });
         if (mode === 'challenge') {
            setTarget({ x: (Math.random() - 0.5) * 100, y: (Math.random() - 0.5) * 100 });
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900">Net Force & Vectors</h2>
                  <div className="flex gap-2 mt-2">
                     <button onClick={() => { setMode('1d'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === '1d' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'}`}>1D TUG-OF-WAR</button>
                     <button onClick={() => { setMode('2d'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === '2d' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-500'}`}>2D EXPLORATION</button>
                     <button onClick={() => { setMode('challenge'); reset(); }} className={`text-[10px] font-bold px-3 py-1 rounded-full ${mode === 'challenge' ? 'bg-amber-600 text-white' : 'bg-slate-100 text-slate-500'}`}>TARGET CHALLENGE</button>
                  </div>
               </div>
               <div className="flex gap-4">
                  <div className="text-center">
                     <p className="text-[8px] font-bold text-slate-400 uppercase">Net Force</p>
                     <p className="text-xl font-black text-slate-900">{magnitude.toFixed(1)} N</p>
                  </div>
                  <div className={`px-4 py-2 rounded-xl flex items-center justify-center font-black text-xs ${isBalanced ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                     {isBalanced ? 'BALANCED' : 'UNBALANCED'}
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Vector Stage */}
               <div className="flex-1 relative bg-white flex items-center justify-center p-12 overflow-hidden">
                  {/* Grid */}
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  {/* The Crate */}
                  <div className="relative w-32 h-32 bg-amber-800 rounded-xl shadow-2xl border-4 border-amber-900 flex items-center justify-center z-10">
                     <div className="w-full h-full opacity-20" style={{ backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 11px)' }} />
                     <span className="absolute text-white font-black text-xl opacity-50">CRATE</span>

                     {/* Resultant Vector */}
                     {showResultant && magnitude > 0 && (
                        <div
                           className="absolute origin-center transition-all duration-300"
                           style={{ transform: `rotate(${-angle}deg)`, width: `${magnitude * 2}px` }}
                        >
                           <div className="h-2 bg-emerald-500 rounded-full shadow-lg relative">
                              <div className="absolute right-[-8px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-l-[12px] border-l-emerald-500" />
                           </div>
                           <span className="absolute -top-6 right-0 text-[10px] font-black text-emerald-600 whitespace-nowrap">NET FORCE</span>
                        </div>
                     )}

                     {/* Component Vectors */}
                     {showComponents && (
                        <>
                           {forces.E > 0 && (
                              <div className="absolute left-1/2 w-[1px] h-1" style={{ width: `${forces.E * 2}px` }}>
                                 <div className="h-1 bg-blue-400 relative">
                                    <div className="absolute right-[-4px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[6px] border-l-blue-400" />
                                 </div>
                              </div>
                           )}
                           {forces.W > 0 && (
                              <div className="absolute right-1/2 w-[1px] h-1" style={{ width: `${forces.W * 2}px`, transform: 'scaleX(-1)' }}>
                                 <div className="h-1 bg-blue-400 relative">
                                    <div className="absolute right-[-4px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[6px] border-l-blue-400" />
                                 </div>
                              </div>
                           )}
                           {forces.N > 0 && (
                              <div className="absolute bottom-1/2 w-1 h-[1px]" style={{ height: `${forces.N * 2}px`, transform: 'scaleY(-1)' }}>
                                 <div className="w-1 bg-purple-400 relative h-full">
                                    <div className="absolute top-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-[6px] border-b-purple-400" />
                                 </div>
                              </div>
                           )}
                           {forces.S > 0 && (
                              <div className="absolute top-1/2 w-1 h-[1px]" style={{ height: `${forces.S * 2}px` }}>
                                 <div className="w-1 bg-purple-400 relative h-full">
                                    <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-[6px] border-t-purple-400" />
                                 </div>
                              </div>
                           )}
                        </>
                     )}
                  </div>

                  {/* Challenge Target */}
                  {mode === 'challenge' && (
                     <div
                        className="absolute w-12 h-12 border-4 border-dashed border-amber-400 rounded-full flex items-center justify-center animate-pulse"
                        style={{ transform: `translate(${target.x * 2}px, ${-target.y * 2}px)` }}
                     >
                        <span className="text-[8px] font-black text-amber-600">TARGET</span>
                     </div>
                  )}
               </div>

               {/* Controls */}
               <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Force Applicators</p>

                     {/* East-West Controls */}
                     <div className="space-y-4">
                        <div className="space-y-2">
                           <div className="flex justify-between">
                              <label className="text-[10px] font-bold text-slate-500">EAST FORCE (E)</label>
                              <span className="text-[10px] font-black text-blue-600">{forces.E} N</span>
                           </div>
                           <input
                              type="range" min="0" max="100" step="5" value={forces.E}
                              onChange={(e) => setForces(f => ({ ...f, E: Number(e.target.value) }))}
                              className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                        <div className="space-y-2">
                           <div className="flex justify-between">
                              <label className="text-[10px] font-bold text-slate-500">WEST FORCE (W)</label>
                              <span className="text-[10px] font-black text-blue-600">{forces.W} N</span>
                           </div>
                           <input
                              type="range" min="0" max="100" step="5" value={forces.W}
                              onChange={(e) => setForces(f => ({ ...f, W: Number(e.target.value) }))}
                              className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                     </div>

                     {/* North-South Controls (2D only) */}
                     {mode !== '1d' && (
                        <div className="space-y-4 pt-4 border-t border-slate-100">
                           <div className="space-y-2">
                              <div className="flex justify-between">
                                 <label className="text-[10px] font-bold text-slate-500">NORTH FORCE (N)</label>
                                 <span className="text-[10px] font-black text-purple-600">{forces.N} N</span>
                              </div>
                              <input
                                 type="range" min="0" max="100" step="5" value={forces.N}
                                 onChange={(e) => setForces(f => ({ ...f, N: Number(e.target.value) }))}
                                 className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                              />
                           </div>
                           <div className="space-y-2">
                              <div className="flex justify-between">
                                 <label className="text-[10px] font-bold text-slate-500">SOUTH FORCE (S)</label>
                                 <span className="text-[10px] font-black text-purple-600">{forces.S} N</span>
                              </div>
                              <input
                                 type="range" min="0" max="100" step="5" value={forces.S}
                                 onChange={(e) => setForces(f => ({ ...f, S: Number(e.target.value) }))}
                                 className="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-purple-500"
                              />
                           </div>
                        </div>
                     )}

                     <div className="pt-4 border-t border-slate-100 space-y-4">
                        <button
                           onClick={() => setShowResultant(!showResultant)}
                           className={`w-full py-2 rounded-lg text-[10px] font-bold transition-all ${showResultant ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400'
                              }`}
                        >
                           {showResultant ? '‚úì SHOWING RESULTANT' : 'SHOW RESULTANT'}
                        </button>
                        <button
                           onClick={reset}
                           className="w-full py-2 bg-slate-900 text-white rounded-lg text-[10px] font-bold"
                        >
                           ‚Ü∫ RESET ALL FORCES
                        </button>
                     </div>
                  </div>

                  {/* Insight */}
                  <div className="mt-auto p-4 bg-blue-50 rounded-2xl border border-blue-100">
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>Vector Addition:</strong> Forces in the same direction add up.
                        Forces in opposite directions subtract. In 2D, they combine to create
                        a diagonal <strong>Resultant</strong> force!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- NEWTON'S THIRD LAW RENDERER (Action/Reaction) ---
   const NewtonThirdLawRenderer = () => {
      const [scenario, setScenario] = useState<'skaters' | 'boat' | 'balloon' | 'ball'>('skaters');
      const [massA, setMassA] = useState(60); // kg
      const [massB, setMassB] = useState(80); // kg
      const [isInteracting, setIsInteracting] = useState(false);
      const [posA, setPosA] = useState(0);
      const [posB, setPosB] = useState(0);
      const [velA, setVelA] = useState(0);
      const [velB, setVelB] = useState(0);
      const [showVectors, setShowVectors] = useState(true);

      const force = 100; // Newtons (constant for the push)

      useEffect(() => {
         let interval: any;
         if (isInteracting) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;

               if (elapsed < 0.2) { // Brief push phase
                  setVelA(-(force / massA) * elapsed * 10);
                  setVelB((force / massB) * elapsed * 10);
               } else {
                  // Coasting phase (simplified friction)
                  setVelA(v => v * 0.98);
                  setVelB(v => v * 0.98);
               }

               setPosA(p => p + velA);
               setPosB(p => p + velB);

               if (Math.abs(posA) > 200 || Math.abs(posB) > 200) {
                  setIsInteracting(false);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isInteracting, velA, velB, massA, massB]);

      const reset = () => {
         setIsInteracting(false);
         setPosA(0);
         setPosB(0);
         setVelA(0);
         setVelB(0);
      };

      return (
         <div className="w-full h-full bg-white flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="p-6 border-b border-slate-100 flex justify-between items-center">
               <div>
                  <h2 className="text-2xl font-black text-slate-900">Newton's Third Law</h2>
                  <p className="text-slate-500 text-sm font-medium">For every action, there is an equal and opposite reaction.</p>
               </div>
               <div className="flex gap-2">
                  {['skaters', 'boat', 'balloon', 'ball'].map(s => (
                     <button
                        key={s} onClick={() => { setScenario(s as any); reset(); }}
                        className={`px-4 py-2 rounded-xl text-xs font-bold transition-all uppercase tracking-wider ${scenario === s ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                           }`}
                     >
                        {s}
                     </button>
                  ))}
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Simulation Stage */}
               <div className="flex-1 bg-slate-50 relative flex items-center justify-center p-12">
                  <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'linear-gradient(#cbd5e1 1px, transparent 1px), linear-gradient(90deg, #cbd5e1 1px, transparent 1px)', backgroundSize: '40px 40px' }} />

                  <div className="relative w-full max-w-2xl h-64 flex items-center justify-center">
                     {/* Floor/Water Line */}
                     <div className="absolute bottom-10 left-0 right-0 h-1 bg-slate-300 rounded-full" />

                     {/* Object A */}
                     <div
                        className="absolute transition-transform duration-30 flex flex-col items-center"
                        style={{ transform: `translateX(${posA}px)`, left: 'calc(50% - 60px)' }}
                     >
                        {/* Force Vector A */}
                        {isInteracting && showVectors && (
                           <div className="absolute -left-16 top-1/2 -translate-y-1/2 flex items-center">
                              <div className="w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-r-[12px] border-r-red-500" />
                              <div className="h-2 bg-red-500 w-12" />
                              <span className="absolute -top-6 left-0 text-[10px] font-black text-red-600 whitespace-nowrap">REACTION</span>
                           </div>
                        )}

                        <div className={`w-20 h-32 rounded-2xl shadow-xl flex items-center justify-center border-4 ${scenario === 'skaters' ? 'bg-blue-500 border-blue-600' :
                           scenario === 'boat' ? 'bg-amber-500 border-amber-600' :
                              scenario === 'balloon' ? 'bg-red-500 border-red-600 rounded-full' : 'bg-slate-800 border-slate-900'
                           }`}>
                           <span className="text-white font-black text-xl">{massA}</span>
                        </div>
                        <span className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Object A</span>
                     </div>

                     {/* Object B */}
                     <div
                        className="absolute transition-transform duration-30 flex flex-col items-center"
                        style={{ transform: `translateX(${posB}px)`, right: 'calc(50% - 60px)' }}
                     >
                        {/* Force Vector B */}
                        {isInteracting && showVectors && (
                           <div className="absolute -right-16 top-1/2 -translate-y-1/2 flex items-center">
                              <div className="h-2 bg-blue-500 w-12" />
                              <div className="w-0 h-0 border-t-8 border-t-transparent border-b-8 border-b-transparent border-l-[12px] border-l-blue-500" />
                              <span className="absolute -top-6 right-0 text-[10px] font-black text-blue-600 whitespace-nowrap">ACTION</span>
                           </div>
                        )}

                        <div className={`w-20 h-32 rounded-2xl shadow-xl flex items-center justify-center border-4 ${scenario === 'skaters' ? 'bg-emerald-500 border-emerald-600' :
                           scenario === 'boat' ? 'bg-slate-700 border-slate-800' :
                              scenario === 'balloon' ? 'bg-slate-300 border-slate-400' : 'bg-white border-slate-200'
                           }`}>
                           <span className="text-white font-black text-xl">{massB}</span>
                        </div>
                        <span className="mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Object B</span>
                     </div>
                  </div>

                  {/* Interaction Button */}
                  <div className="absolute bottom-12 left-1/2 -translate-x-1/2 flex gap-4">
                     <button
                        onClick={() => setIsInteracting(true)}
                        disabled={isInteracting}
                        className="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-2xl hover:bg-slate-800 disabled:opacity-50 transition-all transform active:scale-95"
                     >
                        {scenario === 'skaters' ? 'PUSH OFF' : scenario === 'boat' ? 'JUMP' : scenario === 'balloon' ? 'RELEASE' : 'COLLIDE'}
                     </button>
                     <button onClick={reset} className="p-4 bg-white text-slate-400 rounded-2xl border border-slate-200 hover:text-slate-600 transition-colors">‚Ü∫</button>
                  </div>
               </div>

               {/* Controls & Analysis */}
               <div className="w-full lg:w-96 bg-white border-l border-slate-100 p-8 flex flex-col gap-10 overflow-y-auto">
                  <div className="space-y-8">
                     <div className="flex justify-between items-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>
                        <button
                           onClick={() => setShowVectors(!showVectors)}
                           className={`text-[10px] font-bold px-2 py-1 rounded ${showVectors ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-400'}`}
                        >
                           VECTORS: {showVectors ? 'ON' : 'OFF'}
                        </button>
                     </div>

                     {/* Mass Sliders */}
                     <div className="space-y-6">
                        <div className="space-y-3">
                           <div className="flex justify-between">
                              <label className="text-xs font-bold text-slate-500">Mass A (kg)</label>
                              <span className="text-xs font-black text-slate-900">{massA} kg</span>
                           </div>
                           <input
                              type="range" min="40" max="120" step="5" value={massA}
                              onChange={(e) => setMassA(Number(e.target.value))}
                              className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           />
                        </div>
                        <div className="space-y-3">
                           <div className="flex justify-between">
                              <label className="text-xs font-bold text-slate-500">Mass B (kg)</label>
                              <span className="text-xs font-black text-slate-900">{massB} kg</span>
                           </div>
                           <input
                              type="range" min="40" max="120" step="5" value={massB}
                              onChange={(e) => setMassB(Number(e.target.value))}
                              className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                           />
                        </div>
                     </div>

                     {/* Real-time Data */}
                     <div className="bg-slate-50 rounded-3xl p-6 space-y-4">
                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Live Metrics</h3>
                        <div className="grid grid-cols-2 gap-4">
                           <div className="bg-white p-4 rounded-2xl border border-slate-100">
                              <p className="text-[8px] font-bold text-slate-400 uppercase">Vel A</p>
                              <p className="text-lg font-black text-blue-600">{Math.abs(velA).toFixed(2)} <span className="text-[10px]">m/s</span></p>
                           </div>
                           <div className="bg-white p-4 rounded-2xl border border-slate-100">
                              <p className="text-[8px] font-bold text-slate-400 uppercase">Vel B</p>
                              <p className="text-lg font-black text-emerald-600">{Math.abs(velB).toFixed(2)} <span className="text-[10px]">m/s</span></p>
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Insight Panel */}
                  <div className="mt-auto space-y-4">
                     <div className="p-5 bg-indigo-50 rounded-3xl border border-indigo-100">
                        <div className="flex gap-3 mb-2">
                           <span className="text-indigo-600 text-lg">üß†</span>
                           <h4 className="text-xs font-black text-indigo-900 uppercase tracking-tight">The Core Insight</h4>
                        </div>
                        <p className="text-xs text-indigo-800 leading-relaxed">
                           Notice that the <strong>Forces</strong> are always identical in size but opposite in direction.
                           However, the <strong>Result</strong> (velocity) depends on mass. Lighter objects move faster!
                        </p>
                     </div>

                     <div className="p-5 bg-slate-900 rounded-3xl text-white">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-2">Did you know?</p>
                        <p className="text-[10px] leading-relaxed opacity-80">
                           When you walk, you push the Earth backward, and the Earth pushes you forward.
                           Because Earth is so massive, you don't notice it moving!
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ADVANCED FORCE LAB RENDERER (F=ma Experiments) ---
   const AdvancedForceLabRenderer = () => {
      const [force, setForce] = useState(3); // Newtons
      const [mass, setMass] = useState(2);   // kg
      const [mode, setMode] = useState<'exp1' | 'exp2' | 'free'>('free');
      const [isLaunching, setIsLaunching] = useState(false);
      const [position, setPosition] = useState(0);
      const [velocity, setVelocity] = useState(0);
      const [history, setHistory] = useState<{ t: number, v: number }[]>([]);
      const [experiments, setExperiments] = useState<{ f: number, m: number, a: number }[]>([]);
      const [prediction, setPrediction] = useState<number | null>(null);
      const [showPattern, setShowPattern] = useState(false);
      const [equation, setEquation] = useState<string[]>([]);

      const acceleration = force / mass;
      const targetAccel = 3.0; // For challenge/prediction

      useEffect(() => {
         let interval: any;
         if (isLaunching) {
            const startTime = Date.now();
            interval = setInterval(() => {
               const elapsed = (Date.now() - startTime) / 1000;
               const newVel = acceleration * elapsed;
               const newPos = 0.5 * acceleration * elapsed * elapsed * 50; // scaled for pixels

               setVelocity(newVel);
               setPosition(newPos);
               setHistory(prev => [...prev.slice(-40), { t: elapsed, v: newVel }]);

               if (newPos > 400) {
                  setIsLaunching(false);
                  setExperiments(prev => [...prev, { f: force, m: mass, a: acceleration }]);
               }
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isLaunching, acceleration, force, mass]);

      const resetLaunch = () => {
         setIsLaunching(false);
         setPosition(0);
         setVelocity(0);
         setHistory([]);
      };

      const checkPattern = () => {
         if (experiments.length >= 3) {
            setShowPattern(true);
            setTimeout(() => setShowPattern(false), 5000);
         }
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col overflow-hidden text-slate-800 font-sans">
            {/* Header */}
            <div className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
               <div>
                  <h2 className="text-xl font-black text-slate-900 tracking-tight">Newton's Second Law Lab</h2>
                  <div className="flex gap-4 mt-1">
                     <button onClick={() => { setMode('exp1'); setMass(2); setExperiments([]); }} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'exp1' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'}`}>EXP 1: VARY FORCE</button>
                     <button onClick={() => { setMode('exp2'); setForce(4); setExperiments([]); }} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'exp2' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-500'}`}>EXP 2: VARY MASS</button>
                     <button onClick={() => setMode('free')} className={`text-[10px] font-bold px-3 py-1 rounded-full transition-all ${mode === 'free' ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-500'}`}>FREE EXPLORATION</button>
                  </div>
               </div>
               <div className="flex gap-3">
                  <div className="bg-slate-900 text-white px-4 py-2 rounded-xl flex flex-col items-center min-w-[80px]">
                     <span className="text-[8px] font-bold opacity-50 uppercase">Acceleration</span>
                     <span className="text-lg font-black">{acceleration.toFixed(2)} <span className="text-[10px]">m/s¬≤</span></span>
                  </div>
               </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
               {/* Main Lab Area */}
               <div className="flex-1 p-6 flex flex-col gap-6 overflow-y-auto">
                  {/* The Track */}
                  <div className="relative h-48 bg-white rounded-3xl border-2 border-slate-200 shadow-inner overflow-hidden flex items-end p-4">
                     <div className="absolute inset-0 opacity-5 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '20px 20px' }} />

                     {/* Start Line */}
                     <div className="absolute left-10 bottom-0 top-0 w-1 bg-slate-100" />

                     {/* The Cart */}
                     <div
                        className="relative transition-transform duration-30"
                        style={{ transform: `translateX(${position}px)`, left: '40px' }}
                     >
                        {/* Force Arrow */}
                        {force > 0 && !isLaunching && (
                           <div className="absolute -left-12 top-4 flex items-center">
                              <div className="h-1 bg-amber-500" style={{ width: `${force * 10}px` }} />
                              <div className="w-0 h-0 border-t-4 border-t-transparent border-b-4 border-b-transparent border-l-[8px] border-l-amber-500" />
                           </div>
                        )}

                        {/* Cart Body */}
                        <div className="w-24 h-12 bg-slate-800 rounded-lg relative flex items-center justify-center">
                           <div className="text-white font-bold text-xs">{mass}kg</div>
                           {/* Wheels */}
                           <div className="absolute -bottom-2 left-2 w-4 h-4 bg-slate-900 rounded-full border-2 border-slate-700" />
                           <div className="absolute -bottom-2 right-2 w-4 h-4 bg-slate-900 rounded-full border-2 border-slate-700" />

                           {/* Mass Blocks */}
                           <div className="absolute -top-4 left-2 right-2 flex gap-1 justify-center">
                              {Array.from({ length: mass }).map((_, i) => (
                                 <div key={i} className="w-4 h-4 bg-slate-400 rounded-sm border border-slate-500" />
                              ))}
                           </div>
                        </div>
                     </div>

                     {/* Finish Line */}
                     <div className="absolute left-[440px] bottom-0 top-0 w-4 bg-checkered" style={{ backgroundImage: 'linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000)', backgroundSize: '10px 10px', backgroundPosition: '0 0, 5px 5px' }} />
                  </div>

                  {/* Controls & Graphs */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                     {/* Controls */}
                     <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-6">
                        <div className="flex justify-between items-center">
                           <h3 className="font-bold text-slate-900">Lab Settings</h3>
                           <button onClick={resetLaunch} className="text-[10px] font-bold text-slate-400 hover:text-slate-600">‚Ü∫ RESET</button>
                        </div>

                        {/* Force Slider */}
                        <div className="space-y-3">
                           <div className="flex justify-between items-end">
                              <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Applied Force (N)</label>
                              <span className="text-xl font-black text-amber-600">{force}N</span>
                           </div>
                           <div className="relative h-8 flex items-center">
                              <div className="absolute left-0 right-0 h-1 bg-slate-100 rounded-full" />
                              <input
                                 type="range" min="1" max="10" step="1" value={force}
                                 disabled={mode === 'exp2' || isLaunching}
                                 onChange={(e) => setForce(Number(e.target.value))}
                                 className="absolute w-full h-1 bg-transparent appearance-none cursor-pointer accent-amber-500 z-10"
                              />
                              {/* Spring Visual */}
                              <div className="absolute left-0 h-4 border-l-2 border-slate-300 flex items-center opacity-20 pointer-events-none" style={{ width: `${force * 10}%` }}>
                                 <svg className="w-full h-full" preserveAspectRatio="none">
                                    <path d="M 0 8 Q 5 0 10 8 Q 15 16 20 8" fill="none" stroke="currentColor" strokeWidth="1" />
                                 </svg>
                              </div>
                           </div>
                        </div>

                        {/* Mass Controls */}
                        <div className="space-y-3">
                           <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Object Mass (kg)</label>
                           <div className="flex items-center gap-4">
                              <button
                                 disabled={mode === 'exp1' || mass <= 1 || isLaunching}
                                 onClick={() => setMass(m => m - 1)}
                                 className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center font-bold text-slate-600 hover:bg-slate-200 disabled:opacity-30"
                              >‚Äì</button>
                              <div className="flex-1 h-12 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-center font-black text-xl text-slate-800">
                                 {mass} kg
                              </div>
                              <button
                                 disabled={mode === 'exp1' || mass >= 8 || isLaunching}
                                 onClick={() => setMass(m => m + 1)}
                                 className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center font-bold text-slate-600 hover:bg-slate-200 disabled:opacity-30"
                              >+</button>
                           </div>
                        </div>

                        <button
                           onClick={() => setIsLaunching(true)}
                           disabled={isLaunching}
                           className={`w-full py-4 rounded-2xl font-black text-lg shadow-lg transition-all transform active:scale-95 ${isLaunching ? 'bg-slate-100 text-slate-400' : 'bg-slate-900 text-white hover:bg-slate-800'
                              }`}
                        >
                           {isLaunching ? 'LAUNCHING...' : 'üöÄ LAUNCH CART'}
                        </button>
                     </div>

                     {/* Velocity Graph */}
                     <div className="bg-slate-900 p-6 rounded-3xl shadow-xl flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                           <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">Velocity vs. Time</h3>
                           <div className="text-emerald-400 font-mono text-xs">Slope = {acceleration.toFixed(2)}</div>
                        </div>
                        <div className="flex-1 relative border-l border-b border-slate-700">
                           <svg className="w-full h-full overflow-visible">
                              {/* Grid Lines */}
                              {[0, 25, 50, 75, 100].map(p => (
                                 <line key={p} x1="0" y1={`${p}%`} x2="100%" y2={`${p}%`} stroke="#1e293b" strokeWidth="1" />
                              ))}
                              {/* Data Path */}
                              <polyline
                                 points={history.map((h, i) => `${(i / 40) * 100}%, ${100 - (h.v * 5)}%`).join(' ')}
                                 fill="none" stroke="#10b981" strokeWidth="3" strokeLinecap="round"
                              />
                           </svg>
                           <div className="absolute bottom-[-20px] left-1/2 -translate-x-1/2 text-[8px] text-slate-500 font-bold">TIME (s)</div>
                           <div className="absolute left-[-30px] top-1/2 -rotate-90 -translate-y-1/2 text-[8px] text-slate-500 font-bold">VELOCITY (m/s)</div>
                        </div>
                     </div>
                  </div>

                  {/* Data Table */}
                  <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                     <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Experimental Data</h3>
                        <button onClick={() => setExperiments([])} className="text-[10px] font-bold text-slate-400">CLEAR ALL</button>
                     </div>
                     <div className="overflow-x-auto">
                        <table className="w-full text-left">
                           <thead>
                              <tr className="text-[10px] font-bold text-slate-400 uppercase border-b border-slate-100">
                                 <th className="px-6 py-3">Trial</th>
                                 <th className="px-6 py-3">Force (N)</th>
                                 <th className="px-6 py-3">Mass (kg)</th>
                                 <th className="px-6 py-3">Accel (m/s¬≤)</th>
                                 <th className="px-6 py-3">Status</th>
                              </tr>
                           </thead>
                           <tbody className="text-sm">
                              {experiments.map((exp, i) => (
                                 <tr key={i} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                    <td className="px-6 py-3 font-bold text-slate-400">#{i + 1}</td>
                                    <td className="px-6 py-3 font-black text-amber-600">{exp.f}N</td>
                                    <td className="px-6 py-3 font-black text-slate-700">{exp.m}kg</td>
                                    <td className="px-6 py-3 font-black text-blue-600">{exp.a.toFixed(2)}</td>
                                    <td className="px-6 py-3">
                                       <span className="px-2 py-1 bg-green-100 text-green-700 rounded-md text-[10px] font-bold">RECORDED</span>
                                    </td>
                                 </tr>
                              ))}
                              {experiments.length === 0 && (
                                 <tr>
                                    <td colSpan={5} className="px-6 py-8 text-center text-slate-400 italic text-xs">No data recorded yet. Launch the cart to capture data!</td>
                                 </tr>
                              )}
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>

               {/* Sidebar Analysis */}
               <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-8 overflow-y-auto">
                  <div className="space-y-6">
                     <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Analysis & Discovery</p>

                     {/* Discovery Sequence */}
                     <div className="space-y-4">
                        <div className="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                           <p className="text-xs font-bold text-blue-900 mb-2">Current Goal:</p>
                           <p className="text-xs text-blue-800 leading-relaxed">
                              {mode === 'exp1' ? "Keep Mass at 2kg. Change Force to 2N, 4N, and 6N. What happens to acceleration?" :
                                 mode === 'exp2' ? "Keep Force at 4N. Change Mass to 1kg, 2kg, and 4kg. What happens to acceleration?" :
                                    "Explore freely! Can you find a combination that gives exactly 5.0 m/s¬≤ acceleration?"}
                           </p>
                        </div>

                        {experiments.length >= 3 && (
                           <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 animate-in fade-in slide-in-from-bottom-2">
                              <div className="flex gap-2 mb-2">
                                 <span className="text-emerald-600">‚ú®</span>
                                 <p className="text-xs font-bold text-emerald-900">Pattern Detected!</p>
                              </div>
                              <p className="text-[10px] text-emerald-800 leading-relaxed">
                                 {mode === 'exp1' ? "Notice that as Force doubles, Acceleration also doubles! They are directly proportional." :
                                    mode === 'exp2' ? "Notice that as Mass doubles, Acceleration is cut in half! They are inversely proportional." :
                                       "You've collected enough data to build the equation. Try the Equation Builder below!"}
                              </p>
                           </div>
                        )}
                     </div>

                     {/* Equation Builder */}
                     <div className="space-y-4">
                        <p className="text-[10px] font-bold text-slate-500 uppercase">Equation Builder</p>
                        <div className="flex flex-wrap gap-2 p-4 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 min-h-[60px] items-center justify-center">
                           {equation.map((tile, i) => (
                              <button
                                 key={i} onClick={() => setEquation(prev => prev.filter((_, idx) => idx !== i))}
                                 className="px-3 py-2 bg-white border border-slate-300 rounded-lg font-black text-sm shadow-sm hover:bg-red-50 hover:border-red-200 transition-colors"
                              >{tile}</button>
                           ))}
                           {equation.length === 0 && <span className="text-[10px] text-slate-400">Drag or click tiles to build the rule</span>}
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center">
                           {['F', '=', 'm', '√ó', 'a', '√∑'].map(tile => (
                              <button
                                 key={tile} onClick={() => setEquation(prev => [...prev, tile])}
                                 className="px-3 py-2 bg-slate-100 rounded-lg font-black text-sm hover:bg-slate-200 transition-colors"
                              >{tile}</button>
                           ))}
                        </div>
                        {equation.join('') === 'F=m√óa' && (
                           <div className="p-3 bg-green-500 text-white rounded-xl text-center font-bold text-xs animate-bounce">
                              CORRECT! F = ma
                           </div>
                        )}
                     </div>
                  </div>

                  <div className="mt-auto p-4 bg-amber-50 rounded-2xl border border-amber-100">
                     <div className="flex gap-3">
                        <div className="text-amber-600 text-lg">üí°</div>
                        <p className="text-[10px] text-amber-800 leading-relaxed font-medium">
                           <strong>The Big Idea:</strong> Force is a "push" that causes acceleration.
                           Mass is "laziness" (inertia) that resists acceleration.
                           The more force you apply, the more it speeds up!
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- GAS LAW RENDERER (PV=nRT) ---
   // Stage 1: Core insight = Pressure, Volume, and Temperature are interconnected.
   // Stage 2: Primary = Piston (Volume), Secondary = Heat Source (Temperature).
   // Stage 3: Drag piston to change Volume; Slider for Temperature.
   // Stage 4: Real-time Pressure gauge and particle collision visualization.
   // Stage 5: State (volume, temp) -> Derived (pressure).
   // Stage 6: Challenge = "Reach 5.0 atm Pressure".
   const GasLawRenderer = () => {
      const [volume, setVolume] = useState(200); // px height
      const [temp, setTemp] = useState(300);     // Kelvin
      const [particles, setParticles] = useState<{ x: number, y: number, vx: number, vy: number }[]>([]);
      const [challengeMode, setChallengeMode] = useState(false);

      const pressure = (temp / volume) * 2; // Simplified Ideal Gas Law
      const isChallengeMet = challengeMode && pressure >= 4.9 && pressure <= 5.1;

      useEffect(() => {
         const newParticles = Array.from({ length: 20 }).map(() => ({
            x: Math.random() * 200,
            y: Math.random() * volume,
            vx: (Math.random() - 0.5) * (temp / 50),
            vy: (Math.random() - 0.5) * (temp / 50)
         }));
         setParticles(newParticles);
      }, []);

      useEffect(() => {
         const interval = setInterval(() => {
            setParticles(prev => prev.map(p => {
               let { x, y, vx, vy } = p;
               x += vx;
               y += vy;
               if (x < 0 || x > 200) vx *= -1;
               if (y < 0 || y > volume) vy *= -1;
               return { x, y, vx, vy };
            }));
         }, 30);
         return () => clearInterval(interval);
      }, [volume, temp]);

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Gas Law Lab</h2>
                     <p className="text-slate-500 text-sm">Ideal Gas Law: PV = nRT</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Reach 5.0 atm Pressure</p>
                           <p className="text-xs opacity-80">Adjust Volume and Temperature to hit exactly 5.0 atm.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden items-center justify-center">
                  {/* The Container */}
                  <div className="relative w-[210px] bg-white border-4 border-slate-300 border-t-0 rounded-b-xl overflow-hidden" style={{ height: '250px' }}>
                     {/* The Piston */}
                     <div
                        className="absolute w-full bg-slate-400 border-b-4 border-slate-500 flex items-center justify-center cursor-ns-resize shadow-lg z-10"
                        style={{ height: '20px', top: `${250 - volume - 20}px` }}
                        onMouseDown={(e) => {
                           const startY = e.clientY;
                           const startVol = volume;
                           const handleMove = (moveEvent: MouseEvent) => {
                              const delta = startY - moveEvent.clientY;
                              setVolume(Math.max(50, Math.min(230, startVol + delta)));
                           };
                           const handleUp = () => {
                              window.removeEventListener('mousemove', handleMove);
                              window.removeEventListener('mouseup', handleUp);
                           };
                           window.addEventListener('mousemove', handleMove);
                           window.addEventListener('mouseup', handleUp);
                        }}
                     >
                        <div className="w-12 h-1 bg-slate-300 rounded-full" />
                     </div>

                     {/* Particles */}
                     <svg className="w-full h-full">
                        {particles.map((p, i) => (
                           <circle
                              key={i} cx={p.x} cy={250 - p.y} r="3"
                              fill={temp > 400 ? '#ef4444' : temp < 200 ? '#3b82f6' : '#94a3b8'}
                              className="transition-colors duration-500"
                           />
                        ))}
                     </svg>
                  </div>

                  {/* Pressure Gauge */}
                  <div className="absolute top-4 right-4 bg-white p-4 rounded-2xl shadow-xl border border-slate-100 flex flex-col items-center">
                     <div className="text-3xl font-black text-slate-900">{pressure.toFixed(1)}</div>
                     <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pressure (atm)</div>
                     <div className="w-full h-1 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-red-500 transition-all duration-300" style={{ width: `${Math.min(100, pressure * 10)}%` }} />
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{volume}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Volume (V)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-amber-400">{temp}K</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Temp (T)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-emerald-400">{pressure.toFixed(2)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Pressure (P)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Temperature (K)</label>
                        <span className="text-[10px] font-bold text-amber-600">{temp} K</span>
                     </div>
                     <input
                        type="range" min="100" max="600" step="10" value={temp}
                        onChange={(e) => setTemp(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
                     />
                  </div>

                  <div className="p-4 bg-white rounded-xl border border-slate-200">
                     <p className="text-[10px] font-bold text-slate-500 uppercase mb-2">Instructions</p>
                     <p className="text-[10px] text-slate-600 leading-relaxed">
                        Drag the <strong>Piston</strong> up and down to change volume.
                        Use the slider to change <strong>Temperature</strong>.
                        Watch how the particles speed up and hit the walls harder!
                     </p>
                  </div>

                  <button
                     onClick={() => { setVolume(200); setTemp(300); }}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET LAB
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Pressure is caused by gas particles
                        colliding with the walls. If you decrease <strong>Volume</strong>,
                        they hit the walls more often. If you increase <strong>Temperature</strong>,
                        they hit the walls harder!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- EQUATION BALANCER RENDERER (Chemical Equations) ---
   // Stage 1: Core insight = Matter is conserved; atoms on the left must equal atoms on the right.
   // Stage 2: Primary = Coefficients, Secondary = Visual Atom Count.
   // Stage 3: Click arrows to change coefficients.
   // Stage 4: Real-time atom count comparison (Left vs Right).
   // Stage 5: State (coefficients) -> Derived (atom counts, balance status).
   // Stage 6: Challenge = "Balance the Combustion of Methane".
   const EquationBalancerRenderer = () => {
      const [coeffs, setCoeffs] = useState([1, 1, 1, 1]); // CH4 + O2 -> CO2 + H2O
      const [challengeMode, setChallengeMode] = useState(false);

      const reactants = [
         { name: 'CH‚ÇÑ', atoms: { C: 1, H: 4 } },
         { name: 'O‚ÇÇ', atoms: { O: 2 } }
      ];
      const products = [
         { name: 'CO‚ÇÇ', atoms: { C: 1, O: 2 } },
         { name: 'H‚ÇÇO', atoms: { H: 2, O: 1 } }
      ];

      const leftAtoms = {
         C: coeffs[0] * reactants[0].atoms.C,
         H: coeffs[0] * reactants[0].atoms.H,
         O: coeffs[1] * reactants[1].atoms.O
      };

      const rightAtoms = {
         C: coeffs[2] * products[0].atoms.C,
         H: coeffs[3] * products[1].atoms.H,
         O: coeffs[2] * products[0].atoms.O + coeffs[3] * products[1].atoms.O
      };

      const isBalanced = leftAtoms.C === rightAtoms.C &&
         leftAtoms.H === rightAtoms.H &&
         leftAtoms.O === rightAtoms.O;

      const isChallengeMet = challengeMode && isBalanced && coeffs.some(c => c > 1);

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Equation Balancer</h2>
                     <p className="text-slate-500 text-sm">Law of Conservation of Mass</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Balance Methane Combustion</p>
                           <p className="text-xs opacity-80">Adjust coefficients until C, H, and O atoms match on both sides.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden justify-center">
                  {/* The Equation */}
                  <div className="flex items-center justify-center gap-4 text-2xl font-bold flex-wrap">
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0] + 1, coeffs[1], coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-blue-600 w-8 text-center">{coeffs[0]}</span>
                           <button onClick={() => setCoeffs([Math.max(1, coeffs[0] - 1), coeffs[1], coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>CH‚ÇÑ</span>
                     </div>
                     <span className="text-slate-300">+</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1] + 1, coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-blue-600 w-8 text-center">{coeffs[1]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], Math.max(1, coeffs[1] - 1), coeffs[2], coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>O‚ÇÇ</span>
                     </div>
                     <span className="text-slate-400 mx-4">‚Üí</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2] + 1, coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-emerald-600 w-8 text-center">{coeffs[2]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], Math.max(1, coeffs[2] - 1), coeffs[3]])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>CO‚ÇÇ</span>
                     </div>
                     <span className="text-slate-300">+</span>
                     <div className="flex items-center gap-2">
                        <div className="flex flex-col items-center">
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2], coeffs[3] + 1])} className="text-xs text-slate-400 hover:text-slate-600">‚ñ≤</button>
                           <span className="text-emerald-600 w-8 text-center">{coeffs[3]}</span>
                           <button onClick={() => setCoeffs([coeffs[0], coeffs[1], coeffs[2], Math.max(1, coeffs[3] - 1)])} className="text-xs text-slate-400 hover:text-slate-600">‚ñº</button>
                        </div>
                        <span>H‚ÇÇO</span>
                     </div>
                  </div>

                  {/* Atom Count Comparison */}
                  <div className="mt-12 grid grid-cols-3 gap-8 max-w-md mx-auto w-full">
                     {['C', 'H', 'O'].map(atom => (
                        <div key={atom} className="flex flex-col items-center gap-2">
                           <div className="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold">{atom}</div>
                           <div className="flex items-center gap-3 text-lg font-black">
                              <span className={leftAtoms[atom as keyof typeof leftAtoms] === rightAtoms[atom as keyof typeof rightAtoms] ? 'text-emerald-500' : 'text-red-500'}>
                                 {leftAtoms[atom as keyof typeof leftAtoms]}
                              </span>
                              <span className="text-slate-300">|</span>
                              <span className={leftAtoms[atom as keyof typeof leftAtoms] === rightAtoms[atom as keyof typeof rightAtoms] ? 'text-emerald-500' : 'text-red-500'}>
                                 {rightAtoms[atom as keyof typeof rightAtoms]}
                              </span>
                           </div>
                        </div>
                     ))}
                  </div>

                  {isBalanced && (
                     <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                        <div className="text-8xl font-black text-emerald-500/10 rotate-12">BALANCED</div>
                     </div>
                  )}
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-8 shadow-xl">
                  <div className={`text-xl font-black transition-all ${isBalanced ? 'text-emerald-400' : 'text-slate-500'}`}>
                     {isBalanced ? '‚úì EQUATION BALANCED' : '‚ö† EQUATION UNBALANCED'}
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Balancer Controls</p>

                  <div className="p-4 bg-white rounded-xl border border-slate-200 space-y-3">
                     <p className="text-[10px] font-bold text-slate-500 uppercase">Reactants (Left)</p>
                     <div className="text-xs text-slate-600">
                        Carbon: {leftAtoms.C}<br />
                        Hydrogen: {leftAtoms.H}<br />
                        Oxygen: {leftAtoms.O}
                     </div>
                  </div>

                  <div className="p-4 bg-white rounded-xl border border-slate-200 space-y-3">
                     <p className="text-[10px] font-bold text-slate-500 uppercase">Products (Right)</p>
                     <div className="text-xs text-slate-600">
                        Carbon: {rightAtoms.C}<br />
                        Hydrogen: {rightAtoms.H}<br />
                        Oxygen: {rightAtoms.O}
                     </div>
                  </div>

                  <button
                     onClick={() => setCoeffs([1, 1, 1, 1])}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET COEFFICIENTS
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                  <div className="flex gap-3">
                     <div className="text-emerald-600 text-lg">üí°</div>
                     <p className="text-[10px] text-emerald-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Atoms are never created or destroyed in a
                        chemical reaction‚Äîthey just get rearranged! Balancing ensures that
                        every atom that goes in comes out in a new molecule.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ATOMIC BUILDER RENDERER (Atomic Structure) ---
   // Stage 1: Core insight = Protons define the element; Electrons define charge; Neutrons define stability.
   // Stage 2: Primary = Nucleus (P+N), Secondary = Electron Shells.
   // Stage 3: Add/Remove particles to build atoms.
   // Stage 4: Real-time Element Name, Atomic Number, Mass Number, and Charge.
   // Stage 5: State (protons, neutrons, electrons) -> Derived (element, charge, stability).
   // Stage 6: Challenge = "Build Carbon-12".
   const AtomicBuilderRenderer = () => {
      const [protons, setProtons] = useState(1);
      const [neutrons, setNeutrons] = useState(0);
      const [electrons, setElectrons] = useState(1);
      const [challengeMode, setChallengeMode] = useState(false);

      const elements = [
         { symbol: 'H', name: 'Hydrogen', p: 1 },
         { symbol: 'He', name: 'Helium', p: 2 },
         { symbol: 'Li', name: 'Lithium', p: 3 },
         { symbol: 'Be', name: 'Beryllium', p: 4 },
         { symbol: 'B', name: 'Boron', p: 5 },
         { symbol: 'C', name: 'Carbon', p: 6 },
         { symbol: 'N', name: 'Nitrogen', p: 7 },
         { symbol: 'O', name: 'Oxygen', p: 8 },
         { symbol: 'F', name: 'Fluorine', p: 9 },
         { symbol: 'Ne', name: 'Neon', p: 10 }
      ];

      const currentElement = elements.find(e => e.p === protons) || { symbol: '?', name: 'Unknown', p: protons };
      const massNumber = protons + neutrons;
      const charge = protons - electrons;
      const isStable = Math.abs(protons - neutrons) <= 1 || (protons === 1 && neutrons === 0);

      const isChallengeMet = challengeMode && protons === 6 && neutrons === 6 && electrons === 6;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Atomic Builder</h2>
                     <p className="text-slate-500 text-sm">Build atoms and explore the periodic table</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Build Carbon-12</p>
                           <p className="text-xs opacity-80">Add exactly 6 protons, 6 neutrons, and 6 electrons.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden items-center justify-center">
                  {/* Electron Shells */}
                  <div className="relative w-64 h-64 flex items-center justify-center">
                     <div className="absolute w-full h-full border-2 border-slate-200 rounded-full" />
                     <div className="absolute w-40 h-40 border-2 border-slate-200 rounded-full" />

                     {/* Nucleus */}
                     <div className="relative w-16 h-16 flex flex-wrap items-center justify-center gap-0.5 p-2 bg-slate-200 rounded-full shadow-inner overflow-hidden">
                        {[...Array(protons)].map((_, i) => (
                           <div key={`p-${i}`} className="w-3 h-3 bg-red-500 rounded-full shadow-sm animate-pulse" />
                        ))}
                        {[...Array(neutrons)].map((_, i) => (
                           <div key={`n-${i}`} className="w-3 h-3 bg-slate-400 rounded-full shadow-sm" />
                        ))}
                     </div>

                     {/* Electrons */}
                     {[...Array(electrons)].map((_, i) => {
                        const angle = (i * 360) / electrons;
                        const radius = i < 2 ? 80 : 128; // Shell 1 or 2
                        return (
                           <div
                              key={`e-${i}`}
                              className="absolute w-3 h-3 bg-blue-400 rounded-full shadow-lg transition-all duration-500"
                              style={{
                                 transform: `rotate(${angle}deg) translateY(-${radius / 2}px)`
                              }}
                           />
                        );
                     })}
                  </div>

                  {/* Info Overlay */}
                  <div className="absolute top-4 right-4 bg-white p-4 rounded-2xl shadow-xl border border-slate-100 flex flex-col items-center min-w-[100px]">
                     <div className="text-4xl font-black text-slate-900">{currentElement.symbol}</div>
                     <div className="text-[10px] font-bold text-slate-400 uppercase">{currentElement.name}</div>
                     <div className="mt-2 flex gap-4 border-t border-slate-100 pt-2 w-full justify-center">
                        <div className="text-center">
                           <div className="text-xs font-bold text-slate-800">{protons}</div>
                           <div className="text-[8px] text-slate-400 uppercase">Atomic #</div>
                        </div>
                        <div className="text-center">
                           <div className="text-xs font-bold text-slate-800">{massNumber}</div>
                           <div className="text-[8px] text-slate-400 uppercase">Mass #</div>
                        </div>
                     </div>
                  </div>

                  {/* Stability & Charge Indicators */}
                  <div className="absolute bottom-4 left-4 flex gap-2">
                     <div className={`px-3 py-1 rounded-full text-[10px] font-bold ${isStable ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                        }`}>
                        {isStable ? 'STABLE' : 'UNSTABLE'}
                     </div>
                     <div className={`px-3 py-1 rounded-full text-[10px] font-bold ${charge === 0 ? 'bg-slate-100 text-slate-700' : charge > 0 ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'
                        }`}>
                        {charge === 0 ? 'NEUTRAL' : charge > 0 ? `ION (+${charge})` : `ION (${charge})`}
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-red-400">{protons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Protons (+)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-slate-400">{neutrons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Neutrons (0)</div>
                  </div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{electrons}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Electrons (-)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Particle Controls</p>

                  <div className="space-y-4">
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Protons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setProtons(Math.max(1, protons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setProtons(Math.min(10, protons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Neutrons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setNeutrons(Math.max(0, neutrons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setNeutrons(Math.min(12, neutrons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                     <div className="flex items-center justify-between">
                        <span className="text-xs font-bold text-slate-600">Electrons</span>
                        <div className="flex gap-2">
                           <button onClick={() => setElectrons(Math.max(0, electrons - 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">-</button>
                           <button onClick={() => setElectrons(Math.min(10, electrons + 1))} className="w-8 h-8 bg-white border border-slate-200 rounded-lg shadow-sm font-bold">+</button>
                        </div>
                     </div>
                  </div>

                  <button
                     onClick={() => { setProtons(1); setNeutrons(0); setElectrons(1); }}
                     className="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                  >
                     ‚Ü∫ RESET ATOM
                  </button>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-red-50 rounded-xl border border-red-100">
                  <div className="flex gap-3">
                     <div className="text-red-600 text-lg">üí°</div>
                     <p className="text-[10px] text-red-800 leading-relaxed">
                        <strong>The Big Idea:</strong> The number of <strong>Protons</strong> determines
                        which element you have. <strong>Neutrons</strong> act like "glue" to keep
                        the nucleus stable. <strong>Electrons</strong> orbit the nucleus and
                        determine the atom's charge!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENERGY COASTER RENDERER (PE/KE Conservation) ---
   // Stage 1: Core insight = Energy transforms between PE and KE but total is conserved.
   // Stage 2: Primary = Track Shape (Hill Heights), Secondary = Friction.
   // Stage 3: Drag points on the track to change hill heights.
   // Stage 4: Real-time energy bars (PE, KE, Heat).
   // Stage 5: State (track points, friction) -> Derived (velocity, energy).
   // Stage 6: Challenge = "Make it to the end".
   const EnergyCoasterRenderer = () => {
      const [points, setPoints] = useState([
         { x: 0, y: 50 },
         { x: 100, y: 200 },
         { x: 200, y: 100 },
         { x: 300, y: 200 }
      ]);
      const [friction, setFriction] = useState(0.02);
      const [isPlaying, setIsPlaying] = useState(false);
      const [progress, setProgress] = useState(0); // 0 to 1
      const [velocity, setVelocity] = useState(0);
      const [ke, setKe] = useState(0);
      const [pe, setPe] = useState(0);
      const [heat, setHeat] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);

      const getTrackY = (x: number) => {
         // Simple linear interpolation for the track
         for (let i = 0; i < points.length - 1; i++) {
            if (x >= points[i].x && x <= points[i + 1].x) {
               const t = (x - points[i].x) / (points[i + 1].x - points[i].x);
               return points[i].y + t * (points[i + 1].y - points[i].y);
            }
         }
         return points[points.length - 1].y;
      };

      useEffect(() => {
         let interval: any;
         if (isPlaying) {
            interval = setInterval(() => {
               setProgress(p => {
                  const nextP = p + 0.005;
                  if (nextP >= 1) {
                     setIsPlaying(false);
                     return 1;
                  }

                  const currentX = p * 300;
                  const nextX = nextP * 300;
                  const currentY = getTrackY(currentX);
                  const nextY = getTrackY(nextX);

                  // Physics: PE = mgh, KE = 1/2 mv^2
                  // For simplicity, m=1, g=10
                  const currentPE = (250 - currentY) * 0.1;
                  const nextPE = (250 - nextY) * 0.1;

                  // Energy conservation: PE_start = PE_now + KE_now + Heat
                  const startPE = (250 - points[0].y) * 0.1;
                  const currentHeat = heat + (friction * 0.5);
                  const currentKE = Math.max(0, startPE - currentPE - currentHeat);

                  setPe(currentPE);
                  setKe(currentKE);
                  setHeat(currentHeat);
                  setVelocity(Math.sqrt(2 * currentKE));

                  if (currentKE <= 0 && p > 0.05) {
                     setIsPlaying(false);
                     return p;
                  }

                  return nextP;
               });
            }, 30);
         }
         return () => clearInterval(interval);
      }, [isPlaying, points, friction, heat]);

      const reset = () => {
         setProgress(0);
         setVelocity(0);
         setKe(0);
         setPe((250 - points[0].y) * 0.1);
         setHeat(0);
         setIsPlaying(false);
      };

      const isChallengeMet = challengeMode && progress > 0.98;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Energy Coaster</h2>
                     <p className="text-slate-500 text-sm">Conservation of Energy: PE + KE = Total</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Reach the End</p>
                           <p className="text-xs opacity-80">Design the hills so the cart has enough energy to reach the finish line.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  <svg className="w-full h-full" viewBox="0 0 300 250">
                     {/* Track Path */}
                     <path
                        d={`M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`}
                        fill="none" stroke="#cbd5e1" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round"
                     />
                     <path
                        d={`M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`}
                        fill="none" stroke="#94a3b8" strokeWidth="2" strokeDasharray="4 4"
                     />

                     {/* The Cart */}
                     <g transform={`translate(${progress * 300}, ${getTrackY(progress * 300)})`}>
                        <rect x="-10" y="-15" width="20" height="12" rx="2" fill="#ef4444" className="shadow-lg" />
                        <circle cx="-6" cy="-2" r="3" fill="#1e293b" />
                        <circle cx="6" cy="-2" r="3" fill="#1e293b" />
                     </g>

                     {/* Draggable Points */}
                     {points.map((p, i) => (
                        <circle
                           key={i} cx={p.x} cy={p.y} r="6"
                           fill="white" stroke="#3b82f6" strokeWidth="2"
                           className="cursor-ns-resize shadow-sm"
                           onMouseDown={(e) => {
                              const handleMove = (moveEvent: MouseEvent) => {
                                 const svg = (e.target as any).ownerSVGElement;
                                 const pt = svg.createSVGPoint();
                                 pt.x = moveEvent.clientX;
                                 pt.y = moveEvent.clientY;
                                 const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                                 const newPoints = [...points];
                                 newPoints[i] = { ...newPoints[i], y: Math.max(20, Math.min(230, svgP.y)) };
                                 setPoints(newPoints);
                              };
                              const handleUp = () => {
                                 window.removeEventListener('mousemove', handleMove);
                                 window.removeEventListener('mouseup', handleUp);
                              };
                              window.addEventListener('mousemove', handleMove);
                              window.addEventListener('mouseup', handleUp);
                           }}
                        />
                     ))}
                  </svg>

                  {/* Energy Bars */}
                  <div className="absolute bottom-4 left-4 right-4 flex flex-col gap-2">
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">PE</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-blue-500 transition-all duration-50" style={{ width: `${Math.min(100, pe * 4)}%` }} />
                        </div>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">KE</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-emerald-500 transition-all duration-50" style={{ width: `${Math.min(100, ke * 4)}%` }} />
                        </div>
                     </div>
                     <div className="flex items-center gap-2">
                        <div className="w-12 text-[8px] font-bold text-slate-400 uppercase">HEAT</div>
                        <div className="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                           <div className="h-full bg-orange-500 transition-all duration-50" style={{ width: `${Math.min(100, heat * 4)}%` }} />
                        </div>
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-around shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{pe.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Potential</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-emerald-400">{ke.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Kinetic</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-orange-400">{heat.toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Heat</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-white">{(pe + ke + heat).toFixed(1)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Coaster Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Friction</label>
                        <span className="text-[10px] font-bold text-orange-600">{(friction * 100).toFixed(0)}%</span>
                     </div>
                     <input
                        type="range" min="0" max="0.1" step="0.01" value={friction}
                        onChange={(e) => setFriction(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                     />
                  </div>

                  <div className="flex gap-2">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${isPlaying ? 'bg-red-500 text-white shadow-lg' : 'bg-emerald-500 text-white shadow-lg'
                           }`}
                     >
                        {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ LAUNCH'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-4 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                     >
                        ‚Ü∫
                     </button>
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-blue-50 rounded-xl border border-blue-100">
                  <div className="flex gap-3">
                     <div className="text-blue-600 text-lg">üí°</div>
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Energy can't be created or destroyed.
                        As the cart goes down, <strong>Potential Energy</strong> turns into
                        <strong>Kinetic Energy</strong> (speed). Friction turns some of that
                        energy into <strong>Heat</strong>!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- FORCE LAB RENDERER (Newton's Laws / F=ma) ---
   // Stage 1: Core insight = Force causes acceleration; Mass resists it.
   // Stage 2: Primary = Applied Force (Arrow), Secondary = Mass (Blocks).
   // Stage 3: Drag arrow to apply force; Slider for mass.
   // Stage 4: a = F/m; Real-time velocity-time graph.
   // Stage 5: State (force, mass) -> Derived (acceleration, velocity, position).
   // Stage 6: Challenge = "Match the Acceleration".
   const ForceLabRenderer = () => {
      const [force, setForce] = useState(150); // Newtons
      const [mass, setMass] = useState(30);   // kg
      const [friction, setFriction] = useState(0.1);
      const [velocity, setVelocity] = useState(0);
      const [position, setPosition] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [history, setHistory] = useState<{ t: number, v: number }[]>([]);
      const [challengeMode, setChallengeMode] = useState(false);
      const [targetAcc, setTargetAcc] = useState(5);

      const netForce = Math.max(0, force - (friction * mass * 9.8));
      const acceleration = netForce / mass;

      useEffect(() => {
         let interval: any;
         if (isPlaying) {
            interval = setInterval(() => {
               setVelocity(v => v + acceleration * 0.05);
               setPosition(p => (p + velocity * 0.05) % 300);
               setHistory(h => [...h.slice(-40), { t: Date.now(), v: velocity }]);
            }, 50);
         }
         return () => clearInterval(interval);
      }, [isPlaying, acceleration, velocity]);

      const reset = () => {
         setVelocity(0);
         setPosition(0);
         setHistory([]);
         setIsPlaying(false);
      };

      const isChallengeMet = challengeMode && Math.abs(acceleration - targetAcc) < 0.2;

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Force & Motion Lab</h2>
                     <p className="text-slate-500 text-sm">Newton's Second Law: F = ma</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Match Acceleration = {targetAcc} m/s¬≤</p>
                           <p className="text-xs opacity-80">Adjust Force and Mass until the acceleration is exactly {targetAcc}.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  {/* Track Area */}
                  <div className="flex-1 relative border-b-4 border-slate-300">
                     {/* The Cart */}
                     <div
                        className="absolute bottom-0 transition-all duration-50 ease-linear"
                        style={{ left: `${position}px` }}
                     >
                        <div className="relative">
                           {/* Force Arrow */}
                           <div
                              className="absolute -right-4 top-1/2 -translate-y-1/2 h-2 bg-amber-500 origin-left flex items-center"
                              style={{ width: `${force / 2}px` }}
                           >
                              <div className="absolute right-0 w-0 h-0 border-t-4 border-b-4 border-l-8 border-t-transparent border-b-transparent border-l-amber-500" />
                              <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-amber-600 whitespace-nowrap">
                                 {force} N
                              </div>
                           </div>

                           {/* Cart Body */}
                           <div
                              className="bg-slate-800 rounded-lg shadow-xl flex items-center justify-center text-white font-bold text-xs"
                              style={{
                                 width: `${40 + mass}px`,
                                 height: '40px'
                              }}
                           >
                              {mass}kg
                           </div>
                           {/* Wheels */}
                           <div className="flex justify-around px-2 mt-1">
                              <div className="w-3 h-3 bg-slate-900 rounded-full" />
                              <div className="w-3 h-3 bg-slate-900 rounded-full" />
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* Velocity Graph */}
                  <div className="h-32 mt-8 bg-white rounded-xl border border-slate-200 p-4 relative">
                     <div className="absolute top-2 left-2 text-[8px] font-bold text-slate-400 uppercase">Velocity vs Time</div>
                     <svg className="w-full h-full" viewBox="0 0 200 100" preserveAspectRatio="none">
                        <path
                           d={`M ${history.map((p, i) => `${(i / 40) * 200} ${100 - (p.v * 2)}`).join(' L ')}`}
                           fill="none" stroke="#3b82f6" strokeWidth="2"
                        />
                     </svg>
                     <div className="absolute bottom-2 right-2 text-[10px] font-bold text-blue-600">
                        v = {velocity.toFixed(1)} m/s
                     </div>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-amber-400">{force}N</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Force (F)</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">√∑</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{mass}kg</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Mass (m)</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">{acceleration.toFixed(2)}</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Acc (m/s¬≤)</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lab Controls</p>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Applied Force (N)</label>
                        <span className="text-[10px] font-bold text-amber-600">{force} N</span>
                     </div>
                     <input
                        type="range" min="0" max="500" step="10" value={force}
                        onChange={(e) => setForce(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
                     />
                  </div>

                  <div className="space-y-2">
                     <div className="flex justify-between">
                        <label className="text-[10px] font-bold text-slate-500">Mass (kg)</label>
                        <span className="text-[10px] font-bold text-blue-600">{mass} kg</span>
                     </div>
                     <input
                        type="range" min="5" max="100" step="5" value={mass}
                        onChange={(e) => setMass(Number(e.target.value))}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  <div className="flex gap-2">
                     <button
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${isPlaying ? 'bg-red-500 text-white shadow-lg' : 'bg-emerald-500 text-white shadow-lg'
                           }`}
                     >
                        {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ START MOTION'}
                     </button>
                     <button
                        onClick={reset}
                        className="px-4 py-3 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm"
                     >
                        ‚Ü∫
                     </button>
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-amber-50 rounded-xl border border-amber-100">
                  <div className="flex gap-3">
                     <div className="text-amber-600 text-lg">üí°</div>
                     <p className="text-[10px] text-amber-800 leading-relaxed">
                        <strong>The Big Idea:</strong> Acceleration is directly proportional
                        to <strong>Force</strong> but inversely proportional to <strong>Mass</strong>.
                        Double the mass, and you'll need double the force to keep the same acceleration!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- TRIANGLE RENDERER (Angle Sum & Side Properties) ---
   // Stage 1: Core insight = Interior angles always sum to 180¬∞.
   // Stage 2: Primary = Vertices A, B, C.
   // Stage 3: Draggable Vertices + Real-time Measurements.
   // Stage 4: ‚à†A + ‚à†B + ‚à†C = 180¬∞.
   // Stage 5: State (A, B, C) ‚Üí Derived (angles, lengths, type).
   // Stage 6: Challenge = "Create a Right Triangle".
   const TriangleRenderer = () => {
      const [pA, setPA] = useState({ x: 100, y: 50 });
      const [pB, setPB] = useState({ x: 50, y: 200 });
      const [pC, setPC] = useState({ x: 250, y: 200 });
      const [challengeMode, setChallengeMode] = useState(false);

      // Calculate side lengths
      const dist = (p1: any, p2: any) => Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
      const a = dist(pB, pC);
      const b = dist(pA, pC);
      const c = dist(pA, pB);

      // Calculate angles using Law of Cosines
      const getAngle = (s1: number, s2: number, opp: number) => {
         return Math.acos((s1 * s1 + s2 * s2 - opp * opp) / (2 * s1 * s2)) * (180 / Math.PI);
      };
      const angleA = getAngle(b, c, a);
      const angleB = getAngle(a, c, b);
      const angleC = getAngle(a, b, c);

      const isRight = Math.abs(angleA - 90) < 2 || Math.abs(angleB - 90) < 2 || Math.abs(angleC - 90) < 2;
      const isChallengeMet = challengeMode && isRight;

      const getType = () => {
         if (Math.abs(angleA - 60) < 2 && Math.abs(angleB - 60) < 2) return "Equilateral";
         if (Math.abs(angleA - angleB) < 2 || Math.abs(angleB - angleC) < 2 || Math.abs(angleA - angleC) < 2) return "Isosceles";
         if (isRight) return "Right";
         return "Scalene";
      };

      return (
         <div className="w-full h-full bg-white flex flex-col lg:flex-row overflow-hidden text-slate-800">
            <div className="flex-1 p-6 flex flex-col gap-6">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-900">Triangle Properties</h2>
                     <p className="text-slate-500 text-sm">Angles, sides, and types</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-500'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isChallengeMet ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Create a Right Triangle</p>
                           <p className="text-xs opacity-80">Drag the corners until one angle is exactly 90¬∞.</p>
                        </div>
                     </div>
                  </div>
               )}

               <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 p-8 relative overflow-hidden">
                  <svg className="w-full h-full max-w-[400px] max-h-[300px]" viewBox="0 0 300 250">
                     {/* Triangle Path */}
                     <path
                        d={`M ${pA.x} ${pA.y} L ${pB.x} ${pB.y} L ${pC.x} ${pC.y} Z`}
                        fill="#3b82f620" stroke="#3b82f6" strokeWidth="3" strokeLinejoin="round"
                     />

                     {/* Angle Labels */}
                     <text x={pA.x} y={pA.y - 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleA.toFixed(0)}¬∞</text>
                     <text x={pB.x - 20} y={pB.y + 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleB.toFixed(0)}¬∞</text>
                     <text x={pC.x + 20} y={pC.y + 15} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{angleC.toFixed(0)}¬∞</text>

                     {/* Draggable Handles */}
                     <circle cx={pA.x} cy={pA.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                     <circle cx={pB.x} cy={pB.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                     <circle cx={pC.x} cy={pC.y} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" className="cursor-move shadow-sm" />
                  </svg>

                  <div className="absolute bottom-4 left-4 bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold text-slate-500">
                     TYPE: <span className="text-blue-600">{getType().toUpperCase()}</span>
                  </div>
               </div>

               <div className="bg-slate-900 rounded-2xl p-6 flex items-center justify-center gap-4 shadow-xl">
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleA.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle A</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleB.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle B</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">+</div>
                  <div className="flex flex-col items-center">
                     <div className="text-2xl font-black text-blue-400">{angleC.toFixed(0)}¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Angle C</div>
                  </div>
                  <div className="text-xl font-black text-slate-600">=</div>
                  <div className="flex flex-col items-center">
                     <div className="text-4xl font-black text-emerald-400">180¬∞</div>
                     <div className="text-[8px] font-bold text-slate-500 uppercase">Total Sum</div>
                  </div>
               </div>
            </div>

            <div className="w-full lg:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-8">
               <div className="space-y-6">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Adjust Vertices</p>

                  {/* Vertex A Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex A (Top)</label>
                     <input
                        type="range" min="50" max="250" step="1" value={pA.x}
                        onChange={(e) => setPA({ ...pA, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  {/* Vertex B Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex B (Left)</label>
                     <input
                        type="range" min="20" max="140" step="1" value={pB.x}
                        onChange={(e) => setPB({ ...pB, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>

                  {/* Vertex C Control */}
                  <div className="space-y-2">
                     <label className="text-[10px] font-bold text-slate-500">Vertex C (Right)</label>
                     <input
                        type="range" min="160" max="280" step="1" value={pC.x}
                        onChange={(e) => setPC({ ...pC, x: Number(e.target.value) })}
                        className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                     />
                  </div>
               </div>

               <div className="h-px bg-slate-200" />

               <div className="mt-auto p-4 bg-blue-50 rounded-xl border border-blue-100">
                  <div className="flex gap-3">
                     <div className="text-blue-600 text-lg">üí°</div>
                     <p className="text-[10px] text-blue-800 leading-relaxed">
                        <strong>The Big Idea:</strong> No matter how you stretch or move
                        the corners of a triangle, the <strong>three interior angles</strong>
                        will always add up to exactly <strong>180¬∞</strong>. Try it!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- SORTING ALGORITHM RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Efficiency and Strategy (Iterative vs Divide & Conquer)
   // Stage 2: Primary = Step Scrubber, Secondary = Algorithm Type, Array Size
   // Stage 3: Bar chart with color-coded states (Comparing, Swapping, Sorted)
   // Stage 4: Pre-calculated steps stored as immutable states
   // Stage 5: State (currentStep, algorithm) ‚Üí Derived (array, highlights)
   // Stage 6: Challenge = "Sort in minimum steps"
   const SortingRenderer = () => {
      const [algorithm, setAlgorithm] = useState<'bubble' | 'selection'>('bubble');
      const [arraySize, setArraySize] = useState(10);
      const [currentStep, setCurrentStep] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [speed, setSpeed] = useState(500);
      const [steps, setSteps] = useState<any[]>([]);

      // Generate initial random array and pre-calculate steps
      useEffect(() => {
         const initialArray = Array.from({ length: arraySize }, () => Math.floor(Math.random() * 90) + 10);
         const newSteps: any[] = [{ array: [...initialArray], comparing: [], swapping: [], sorted: [], desc: "Initial random array" }];

         if (algorithm === 'bubble') {
            const arr = [...initialArray];
            const n = arr.length;
            for (let i = 0; i < n; i++) {
               for (let j = 0; j < n - i - 1; j++) {
                  newSteps.push({ array: [...arr], comparing: [j, j + 1], swapping: [], sorted: Array.from({ length: i }, (_, k) => n - 1 - k), desc: `Comparing ${arr[j]} and ${arr[j + 1]}` });
                  if (arr[j] > arr[j + 1]) {
                     [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
                     newSteps.push({ array: [...arr], comparing: [], swapping: [j, j + 1], sorted: Array.from({ length: i }, (_, k) => n - 1 - k), desc: `Swapping ${arr[j + 1]} and ${arr[j]}` });
                  }
               }
            }
            newSteps.push({ array: [...arr], comparing: [], swapping: [], sorted: Array.from({ length: n }, (_, k) => k), desc: "Array sorted!" });
         } else if (algorithm === 'selection') {
            const arr = [...initialArray];
            const n = arr.length;
            for (let i = 0; i < n - 1; i++) {
               let minIdx = i;
               newSteps.push({ array: [...arr], comparing: [i], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `New pass: assume index ${i} is minimum` });
               for (let j = i + 1; j < n; j++) {
                  newSteps.push({ array: [...arr], comparing: [minIdx, j], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `Comparing current min ${arr[minIdx]} with ${arr[j]}` });
                  if (arr[j] < arr[minIdx]) {
                     minIdx = j;
                     newSteps.push({ array: [...arr], comparing: [minIdx], swapping: [], sorted: Array.from({ length: i }, (_, k) => k), desc: `New minimum found: ${arr[minIdx]}` });
                  }
               }
               if (minIdx !== i) {
                  [arr[i], arr[minIdx]] = [arr[minIdx], arr[i]];
                  newSteps.push({ array: [...arr], comparing: [], swapping: [i, minIdx], sorted: Array.from({ length: i }, (_, k) => k), desc: `Swapping ${arr[minIdx]} into position ${i}` });
               }
            }
            newSteps.push({ array: [...arr], comparing: [], swapping: [], sorted: Array.from({ length: n }, (_, k) => k), desc: "Array sorted!" });
         }

         setSteps(newSteps);
         setCurrentStep(0);
         setIsPlaying(false);
      }, [algorithm, arraySize]);

      // Playback logic
      useEffect(() => {
         if (!isPlaying) return;
         if (currentStep >= steps.length - 1) {
            setIsPlaying(false);
            return;
         }

         const timer = setTimeout(() => {
            setCurrentStep(prev => prev + 1);
         }, speed);

         return () => clearTimeout(timer);
      }, [isPlaying, currentStep, steps, speed]);

      const state = steps[currentStep] || { array: [], comparing: [], swapping: [], sorted: [], desc: "" };

      return (
         <div className="w-full h-full bg-slate-900 flex flex-col lg:flex-row overflow-hidden text-slate-200">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-500">
                        Sorting Algorithms
                     </h2>
                     <p className="text-slate-400 text-sm">Visualize Time Complexity & Logic</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setAlgorithm('bubble')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${algorithm === 'bubble' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-400'
                           }`}
                     >
                        BUBBLE SORT
                     </button>
                     <button
                        onClick={() => setAlgorithm('selection')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${algorithm === 'selection' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-400'
                           }`}
                     >
                        SELECTION SORT
                     </button>
                  </div>
               </div>

               {/* Step Description */}
               <div className="p-4 bg-slate-800/50 rounded-xl border border-slate-700 min-h-[80px] flex items-center gap-4">
                  <div className="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-mono font-bold shrink-0">
                     {currentStep}
                  </div>
                  <p className="text-lg font-medium text-slate-200">{state.desc}</p>
               </div>

               {/* Bar Chart */}
               <div className="flex-1 bg-slate-950 rounded-2xl border border-slate-800 p-8 flex items-end justify-center gap-1 shadow-inner">
                  {state.array.map((val: number, idx: number) => {
                     let color = "bg-slate-700";
                     if (state.comparing.includes(idx)) color = "bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.5)]";
                     if (state.swapping.includes(idx)) color = "bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]";
                     if (state.sorted.includes(idx)) color = "bg-emerald-500";

                     return (
                        <div key={idx} className="flex flex-col items-center gap-2 flex-1 max-w-[40px]">
                           <span className={`text-[10px] font-mono font-bold ${state.comparing.includes(idx) || state.swapping.includes(idx) ? 'text-white' : 'text-slate-500'}`}>
                              {val}
                           </span>
                           <div
                              className={`w-full rounded-t-sm transition-all duration-200 ${color}`}
                              style={{ height: `${val * 3}px` }}
                           />
                        </div>
                     );
                  })}
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 overflow-y-auto">
               <div className="flex gap-2">
                  <button
                     onClick={() => setIsPlaying(!isPlaying)}
                     className={`flex-1 py-4 rounded-xl font-bold text-lg transition-all ${isPlaying ? 'bg-slate-800 text-slate-300' : 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20'
                        }`}
                  >
                     {isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ PLAY'}
                  </button>
                  <button
                     onClick={() => { setCurrentStep(0); setIsPlaying(false); }}
                     className="px-4 bg-slate-800 rounded-xl text-slate-400 hover:text-white transition-colors"
                  >
                     <i className="fa-solid fa-rotate-right"></i>
                  </button>
               </div>

               {/* Step Scrubber - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">‚≠ê Step Scrubber</label>
                     <span className="text-sm font-mono font-bold text-emerald-400">{currentStep} / {steps.length - 1}</span>
                  </div>
                  <input
                     type="range" min="0" max={steps.length - 1} step="1" value={currentStep}
                     onChange={(e) => { setCurrentStep(Number(e.target.value)); setIsPlaying(false); }}
                     className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                  />
               </div>

               <div className="h-px bg-slate-800" />

               {/* Array Size */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Array Size</label>
                     <span className="text-sm font-mono font-bold text-slate-300">{arraySize}</span>
                  </div>
                  <input
                     type="range" min="5" max="25" step="1" value={arraySize}
                     onChange={(e) => setArraySize(Number(e.target.value))}
                     className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-slate-500"
                  />
               </div>

               {/* Speed */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Playback Speed</label>
                     <span className="text-sm font-mono font-bold text-slate-300">{speed}ms</span>
                  </div>
                  <input
                     type="range" min="50" max="1000" step="50" value={speed}
                     onChange={(e) => setSpeed(Number(e.target.value))}
                     className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-slate-500"
                  />
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                  <div className="flex gap-3">
                     <div className="text-emerald-400 text-lg">üí°</div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        <strong>Complexity:</strong> Bubble sort is O(n¬≤), meaning steps grow exponentially with array size.
                        Notice how it "bubbles" the largest element to the end in each pass.
                        Selection sort finds the minimum and places it at the start.
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ELECTRIC CIRCUIT RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Ohm's Law (V = I * R). Flow depends on pressure (V) and friction (R).
   // Stage 2: Primary = Voltage, Secondary = Resistance, Circuit Type (Series/Parallel)
   // Stage 3: Schematic with animated electrons. Speed = Current.
   // Stage 4: I = V / R. Series: R = R1 + R2. Parallel: 1/R = 1/R1 + 1/R2.
   // Stage 5: State (V, R1, R2, type) ‚Üí Calculations ‚Üí Animation Speed
   // Stage 6: Challenge = "Match Current to 2.5A"
   const CircuitRenderer = () => {
      const [voltage, setVoltage] = useState(12);
      const [r1, setR1] = useState(4);
      const [r2, setR2] = useState(4);
      const [circuitType, setCircuitType] = useState<'series' | 'parallel'>('series');
      const [challengeMode, setChallengeMode] = useState(false);
      const [time, setTime] = useState(0);

      // Calculations
      const totalResistance = circuitType === 'series'
         ? r1 + r2
         : (r1 * r2) / (r1 + r2);

      const current = voltage / totalResistance; // I = V/R
      const power = voltage * current; // P = VI

      // Animation loop for electrons
      useEffect(() => {
         let animationId: number;
         const animate = () => {
            // Speed of electrons is proportional to current
            setTime(prev => prev + current * 0.05);
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [current]);

      // Challenge logic
      const targetCurrent = 2.5;
      const isChallengeMet = challengeMode && Math.abs(current - targetCurrent) < 0.1;

      // SVG path for electrons
      const renderElectrons = () => {
         const electrons = [];
         const count = 15;
         const pathLength = 800; // Approximate total length of circuit path

         for (let i = 0; i < count; i++) {
            const offset = (time * 50 + (i * pathLength / count)) % pathLength;

            // Map offset to circuit coordinates
            let x = 0, y = 0;
            if (offset < 250) { // Top wire
               x = 100 + offset; y = 50;
            } else if (offset < 400) { // Right wire
               x = 350; y = 50 + (offset - 250);
            } else if (offset < 650) { // Bottom wire
               x = 350 - (offset - 400); y = 200;
            } else { // Left wire
               x = 100; y = 200 - (offset - 650);
            }

            electrons.push(<circle key={i} cx={x} cy={y} r="3" fill="#fbbf24" className="shadow-sm" />);
         }
         return electrons;
      };

      return (
         <div className="w-full h-full bg-slate-50 flex flex-col lg:flex-row overflow-hidden">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold text-slate-800">Electric Circuits</h2>
                     <p className="text-slate-500 text-sm">Explore Ohm's Law & Circuit Topology</p>
                  </div>
                  <div className="flex gap-2">
                     <button
                        onClick={() => setCircuitType('series')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${circuitType === 'series' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'
                           }`}
                     >
                        SERIES
                     </button>
                     <button
                        onClick={() => setCircuitType('parallel')}
                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${circuitType === 'parallel' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'
                           }`}
                     >
                        PARALLEL
                     </button>
                  </div>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isChallengeMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'
                     }`}>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                           <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isChallengeMet ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                              }`}>
                              {isChallengeMet ? '‚úì' : 'üéØ'}
                           </div>
                           <div>
                              <p className="font-bold text-slate-800">Goal: Match Current to {targetCurrent}A</p>
                              <p className="text-xs text-slate-600">Adjust Voltage and Resistance to find the balance.</p>
                           </div>
                        </div>
                        {isChallengeMet && <div className="text-green-600 font-black animate-bounce">CHALLENGE COMPLETE!</div>}
                     </div>
                  </div>
               )}

               <div className="flex-1 bg-white rounded-2xl border border-slate-200 shadow-inner relative overflow-hidden flex items-center justify-center">
                  <svg viewBox="0 0 450 300" className="w-full h-full max-w-[500px]">
                     {/* Circuit Wires */}
                     <rect x="100" y="50" width="250" height="150" fill="none" stroke="#334155" strokeWidth="4" rx="8" />

                     {/* Battery */}
                     <g transform="translate(100, 100)">
                        <rect x="-10" y="0" width="20" height="50" fill="#1e293b" rx="2" />
                        <rect x="-5" y="-5" width="10" height="5" fill="#ef4444" rx="1" />
                        <text x="-25" y="30" textAnchor="end" fill="#ef4444" fontSize="12" fontWeight="bold">{voltage}V</text>
                        <text x="0" y="65" textAnchor="middle" fill="#64748b" fontSize="10">BATTERY</text>
                     </g>

                     {/* Resistor 1 */}
                     <g transform="translate(225, 50)">
                        <rect x="-30" y="-15" width="60" height="30" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                        <line x1="-20" y1="-10" x2="-20" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <line x1="0" y1="-10" x2="0" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <line x1="20" y1="-10" x2="20" y2="10" stroke="#94a3b8" strokeWidth="2" />
                        <text x="0" y="-25" textAnchor="middle" fill="#334155" fontSize="12" fontWeight="bold">R1: {r1}Œ©</text>
                     </g>

                     {/* Resistor 2 (Series) */}
                     {circuitType === 'series' && (
                        <g transform="translate(350, 125)">
                           <rect x="-15" y="-30" width="30" height="60" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                           <text x="25" y="5" textAnchor="start" fill="#334155" fontSize="12" fontWeight="bold">R2: {r2}Œ©</text>
                        </g>
                     )}

                     {/* Resistor 2 (Parallel) */}
                     {circuitType === 'parallel' && (
                        <g>
                           <line x1="225" y1="50" x2="225" y2="120" stroke="#334155" strokeWidth="4" />
                           <line x1="350" y1="120" x2="225" y2="120" stroke="#334155" strokeWidth="4" />
                           <g transform="translate(287, 120)">
                              <rect x="-30" y="-15" width="60" height="30" fill="#f1f5f9" stroke="#334155" strokeWidth="2" rx="4" />
                              <text x="0" y="30" textAnchor="middle" fill="#334155" fontSize="12" fontWeight="bold">R2: {r2}Œ©</text>
                           </g>
                        </g>
                     )}

                     {/* Ammeter Display */}
                     <g transform="translate(225, 200)">
                        <circle r="35" fill="#1e293b" />
                        <text x="0" y="-5" textAnchor="middle" fill="#94a3b8" fontSize="8" fontWeight="bold">CURRENT</text>
                        <text x="0" y="15" textAnchor="middle" fill="#22d3ee" fontSize="18" fontWeight="bold" className="font-mono">
                           {current.toFixed(2)}A
                        </text>
                     </g>

                     {/* Electrons */}
                     {renderElectrons()}
                  </svg>

                  {/* Flow Intensity Overlay */}
                  <div className="absolute bottom-4 right-4 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold text-slate-500 flex items-center gap-2">
                     <div className="w-2 h-2 rounded-full bg-fbbf24 animate-ping" />
                     ELECTRON FLOW INTENSITY: {(current * 10).toFixed(0)}%
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-white border-l border-slate-200 p-6 flex flex-col gap-6 overflow-y-auto">
               <button
                  onClick={() => setChallengeMode(!challengeMode)}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                     }`}
               >
                  {challengeMode ? 'üéØ CHALLENGE ON' : 'üéØ START CHALLENGE'}
               </button>

               {/* Voltage - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">‚≠ê Voltage (V)</label>
                     <span className="text-xl font-mono font-bold text-indigo-600">{voltage}V</span>
                  </div>
                  <input
                     type="range" min="1" max="48" step="1" value={voltage}
                     onChange={(e) => setVoltage(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                  />
                  <div className="flex justify-between text-[8px] text-slate-400 font-bold">
                     <span>1V (LOW)</span>
                     <span>48V (HIGH)</span>
                  </div>
               </div>

               <div className="h-px bg-slate-100" />

               {/* Resistance 1 */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resistance 1 (Œ©)</label>
                     <span className="text-lg font-mono font-bold text-slate-700">{r1}Œ©</span>
                  </div>
                  <input
                     type="range" min="1" max="20" step="1" value={r1}
                     onChange={(e) => setR1(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-slate-600"
                  />
               </div>

               {/* Resistance 2 */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resistance 2 (Œ©)</label>
                     <span className="text-lg font-mono font-bold text-slate-700">{r2}Œ©</span>
                  </div>
                  <input
                     type="range" min="1" max="20" step="1" value={r2}
                     onChange={(e) => setR2(Number(e.target.value))}
                     className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-slate-600"
                  />
               </div>

               {/* Metrics Summary */}
               <div className="grid grid-cols-2 gap-2">
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                     <div className="text-[8px] font-black text-slate-400 uppercase">Total R</div>
                     <div className="text-sm font-bold text-slate-800">{totalResistance.toFixed(1)}Œ©</div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                     <div className="text-[8px] font-black text-slate-400 uppercase">Power (P)</div>
                     <div className="text-sm font-bold text-slate-800">{power.toFixed(0)}W</div>
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                  <div className="flex gap-3">
                     <div className="text-indigo-600 text-lg">üí°</div>
                     <p className="text-[10px] text-indigo-800 leading-relaxed">
                        <strong>Ohm's Law:</strong> Current (I) is like the speed of water.
                        Voltage (V) is the pressure pushing it, and Resistance (R) is the pipe size.
                        In <strong>Series</strong>, resistors add up. In <strong>Parallel</strong>,
                        they provide more paths, actually <em>lowering</em> total resistance!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- WAVE INTERFERENCE RENDERER (7-Stage Masterpiece) ---
   // Stage 1: Core insight = Superposition principle (Constructive vs Destructive)
   // Stage 2: Primary = Phase Shift, Secondary = Frequencies, Amplitudes
   // Stage 3: Three-panel view (Wave 1, Wave 2, Resultant)
   // Stage 4: y = A*sin(kx - œât + œÜ), Resultant = y1 + y2
   // Stage 5: State (amp, freq, phase) ‚Üí Animation Frame ‚Üí SVG Path
   // Stage 6: Challenge = "Create a Standing Wave" or "Perfect Silence (Destructive)"
   const WaveInterferenceRenderer = () => {
      const [amp1, setAmp1] = useState(40);
      const [freq1, setFreq1] = useState(1.0);
      const [amp2, setAmp2] = useState(40);
      const [freq2, setFreq2] = useState(1.0);
      const [phase, setPhase] = useState(0); // degrees
      const [isAnimating, setIsAnimating] = useState(true);
      const [time, setTime] = useState(0);
      const [challengeMode, setChallengeMode] = useState(false);

      // Animation loop
      useEffect(() => {
         if (!isAnimating) return;
         let animationId: number;
         const startTime = performance.now();
         const animate = (now: number) => {
            setTime((now - startTime) / 1000);
            animationId = requestAnimationFrame(animate);
         };
         animationId = requestAnimationFrame(animate);
         return () => cancelAnimationFrame(animationId);
      }, [isAnimating]);

      const width = 600;
      const height = 120;
      const points = 100;
      const step = width / points;

      const generatePath = (a: number, f: number, p: number, t: number) => {
         const pathPoints = [];
         const phaseRad = (p * Math.PI) / 180;
         for (let i = 0; i <= points; i++) {
            const x = i * step;
            // y = A * sin(k*x - œâ*t + œÜ)
            // k = 2œÄ/Œª, œâ = 2œÄf
            const y = a * Math.sin((i / 10) * f - 5 * t + phaseRad);
            pathPoints.push(`${x},${height / 2 + y}`);
         }
         return `M ${pathPoints.join(" L ")}`;
      };

      const generateResultantPath = (t: number) => {
         const pathPoints = [];
         const phaseRad = (phase * Math.PI) / 180;
         for (let i = 0; i <= points; i++) {
            const x = i * step;
            const y1 = amp1 * Math.sin((i / 10) * freq1 - 5 * t);
            const y2 = amp2 * Math.sin((i / 10) * freq2 - 5 * t + phaseRad);
            pathPoints.push(`${x},${height / 2 + (y1 + y2)}`);
         }
         return `M ${pathPoints.join(" L ")}`;
      };

      // Challenge logic: Destructive interference
      // Occurs when freq1 == freq2, amp1 == amp2, and phase == 180
      const isDestructive = Math.abs(freq1 - freq2) < 0.01 &&
         Math.abs(amp1 - amp2) < 2 &&
         Math.abs(Math.abs(phase) - 180) < 5;

      const isConstructive = Math.abs(freq1 - freq2) < 0.01 &&
         Math.abs(phase % 360) < 5;

      return (
         <div className="w-full h-full bg-slate-950 flex flex-col lg:flex-row overflow-hidden text-slate-200">
            {/* VISUALIZATION AREA */}
            <div className="flex-1 p-6 flex flex-col gap-4">
               <div className="flex justify-between items-center">
                  <div>
                     <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                        Wave Interference
                     </h2>
                     <p className="text-slate-400 text-sm">The Principle of Superposition</p>
                  </div>
                  <button
                     onClick={() => setChallengeMode(!challengeMode)}
                     className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${challengeMode ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                        }`}
                  >
                     {challengeMode ? 'üéØ CHALLENGE ACTIVE' : 'üéØ START CHALLENGE'}
                  </button>
               </div>

               {challengeMode && (
                  <div className={`p-4 rounded-xl border-2 transition-all ${isDestructive ? 'bg-emerald-500/10 border-emerald-500/50' : 'bg-amber-500/10 border-amber-500/50'
                     }`}>
                     <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isDestructive ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'
                           }`}>
                           {isDestructive ? '‚úì' : 'üéØ'}
                        </div>
                        <div>
                           <p className="font-bold text-sm">Goal: Create "Perfect Silence"</p>
                           <p className="text-xs opacity-80">Adjust Phase Shift to cancel Wave 1 with Wave 2 (Destructive Interference).</p>
                        </div>
                        {isDestructive && (
                           <div className="ml-auto animate-bounce text-emerald-400 font-black">SUCCESS!</div>
                        )}
                     </div>
                  </div>
               )}

               <div className="flex-1 flex flex-col gap-2 min-h-0">
                  {/* Wave 1 */}
                  <div className="flex-1 bg-slate-900/50 rounded-xl border border-slate-800 p-2 relative overflow-hidden">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-cyan-400 uppercase tracking-widest">Wave A</div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full preserve-3d">
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                        <path d={generatePath(amp1, freq1, 0, time)} fill="none" stroke="#22d3ee" strokeWidth="3" strokeLinecap="round" />
                     </svg>
                  </div>

                  {/* Wave 2 */}
                  <div className="flex-1 bg-slate-900/50 rounded-xl border border-slate-800 p-2 relative overflow-hidden">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-purple-400 uppercase tracking-widest">Wave B</div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                        <path d={generatePath(amp2, freq2, phase, time)} fill="none" stroke="#a855f7" strokeWidth="3" strokeLinecap="round" />
                     </svg>
                  </div>

                  {/* Resultant */}
                  <div className="flex-[1.5] bg-slate-900 rounded-xl border-2 border-slate-800 p-2 relative overflow-hidden shadow-inner">
                     <div className="absolute top-2 left-2 text-[10px] font-bold text-white uppercase tracking-widest flex items-center gap-2">
                        Resultant Wave (A + B)
                        {isDestructive && <span className="text-emerald-400 text-[8px] animate-pulse">DESTRUCTIVE</span>}
                        {isConstructive && <span className="text-cyan-400 text-[8px] animate-pulse">CONSTRUCTIVE</span>}
                     </div>
                     <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                        <defs>
                           <linearGradient id="waveGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stopColor="#22d3ee" />
                              <stop offset="100%" stopColor="#a855f7" />
                           </linearGradient>
                        </defs>
                        <line x1="0" y1={height / 2} x2={width} y2={height / 2} stroke="#1e293b" strokeWidth="2" />
                        <path d={generateResultantPath(time)} fill="none" stroke="url(#waveGradient)" strokeWidth="4" strokeLinecap="round" />
                     </svg>
                  </div>
               </div>
            </div>

            {/* CONTROL PANEL */}
            <div className="w-full lg:w-80 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 overflow-y-auto">
               <button
                  onClick={() => setIsAnimating(!isAnimating)}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${isAnimating ? 'bg-slate-800 text-slate-300' : 'bg-cyan-500 text-white shadow-lg shadow-cyan-500/20'
                     }`}
               >
                  {isAnimating ? '‚è∏ PAUSE WAVE' : '‚ñ∂ RESUME WAVE'}
               </button>

               {/* Phase Shift - PRIMARY */}
               <div className="space-y-3">
                  <div className="flex justify-between items-end">
                     <label className="text-[10px] font-black text-slate-500 uppercase tracking-tighter">‚≠ê Phase Shift (œÜ)</label>
                     <span className="text-xl font-mono font-bold text-white">{phase}¬∞</span>
                  </div>
                  <input
                     type="range" min="-180" max="180" step="1" value={phase}
                     onChange={(e) => setPhase(Number(e.target.value))}
                     className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                  />
                  <div className="flex justify-between text-[8px] text-slate-600 font-bold">
                     <span>-180¬∞</span>
                     <span>0¬∞ (SYNC)</span>
                     <span>180¬∞ (OPPOSITE)</span>
                  </div>
               </div>

               <div className="h-px bg-slate-800" />

               {/* Wave A Controls */}
               <div className="space-y-4">
                  <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-widest">Wave A Settings</div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Amplitude</span>
                        <span className="text-cyan-400">{amp1}</span>
                     </div>
                     <input
                        type="range" min="0" max="50" value={amp1}
                        onChange={(e) => setAmp1(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                     />
                  </div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Frequency</span>
                        <span className="text-cyan-400">{freq1.toFixed(1)}Hz</span>
                     </div>
                     <input
                        type="range" min="0.5" max="3" step="0.1" value={freq1}
                        onChange={(e) => setFreq1(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                     />
                  </div>
               </div>

               {/* Wave B Controls */}
               <div className="space-y-4">
                  <div className="text-[10px] font-bold text-purple-500 uppercase tracking-widest">Wave B Settings</div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Amplitude</span>
                        <span className="text-purple-400">{amp2}</span>
                     </div>
                     <input
                        type="range" min="0" max="50" value={amp2}
                        onChange={(e) => setAmp2(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                     />
                  </div>
                  <div className="space-y-2">
                     <div className="flex justify-between text-[10px] text-slate-400">
                        <span>Frequency</span>
                        <span className="text-purple-400">{freq2.toFixed(1)}Hz</span>
                     </div>
                     <input
                        type="range" min="0.5" max="3" step="0.1" value={freq2}
                        onChange={(e) => setFreq2(Number(e.target.value))}
                        className="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500"
                     />
                  </div>
               </div>

               {/* Educational Insight */}
               <div className="mt-auto p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                  <div className="flex gap-3">
                     <div className="text-blue-400 text-lg">üí°</div>
                     <p className="text-[10px] text-slate-300 leading-relaxed">
                        <strong>Superposition:</strong> When two waves meet, their amplitudes add up.
                        If they are "in phase" (peaks align), they create a larger wave.
                        If they are "out of phase" (peak meets trough), they can cancel each other out entirely!
                     </p>
                  </div>
               </div>
            </div>
         </div>
      );
   };

   // --- ENHANCED PROJECTILE MOTION RENDERER ---
   const ProjectileRenderer = () => {
      const [angle, setAngle] = useState(45);
      const [velocity, setVelocity] = useState(25);
      const [isAnimating, setIsAnimating] = useState(false);
      const [animationProgress, setAnimationProgress] = useState(0);
      const [shots, setShots] = useState<{ hit: boolean, range: number }[]>([]);
      const [showResult, setShowResult] = useState<'hit' | 'miss' | null>(null);

      const g = 9.8;
      const scale = 4;
      const targetX = 550; // Target position
      const targetWidth = 40;

      // Physics calculations
      const radian = angle * (Math.PI / 180);
      const vx = velocity * Math.cos(radian);
      const vy = velocity * Math.sin(radian);
      const totalTime = (2 * vy) / g;
      const range = (velocity * velocity * Math.sin(2 * radian)) / g;
      const maxHeight = (vy * vy) / (2 * g);
      const flightTime = totalTime;

      // Generate trajectory points
      const trajectoryPoints: string[] = [];
      for (let t = 0; t <= totalTime; t += 0.05) {
         const x = vx * t * scale;
         const y = (vy * t - 0.5 * g * t * t) * scale;
         trajectoryPoints.push(`${50 + x},${450 - y}`);
      }

      // Animation position
      const animT = animationProgress * totalTime;
      const animX = 50 + vx * animT * scale;
      const animY = 450 - (vy * animT - 0.5 * g * animT * animT) * scale;

      // Check if hit target
      const landingX = 50 + range * scale;
      const isHit = landingX >= targetX && landingX <= targetX + targetWidth;

      // Launch animation
      const handleLaunch = () => {
         if (isAnimating) return;
         setShowResult(null);
         setIsAnimating(true);
         setAnimationProgress(0);

         const startTime = Date.now();
         const duration = Math.max(1000, totalTime * 400); // Animation duration

         const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(1, elapsed / duration);
            setAnimationProgress(progress);

            if (progress < 1) {
               requestAnimationFrame(animate);
            } else {
               setIsAnimating(false);
               setShots(prev => [...prev, { hit: isHit, range: Math.round(range) }]);
               setShowResult(isHit ? 'hit' : 'miss');
            }
         };
         requestAnimationFrame(animate);
      };

      return (
         <div className="w-full h-full bg-gradient-to-b from-sky-100 to-sky-50 flex flex-col">
            {/* Main Visualization */}
            <div className="flex-1 relative overflow-hidden">
               <svg viewBox="0 0 800 500" className="w-full h-full">
                  {/* Sky gradient */}
                  <defs>
                     <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#e0f2fe" />
                        <stop offset="100%" stopColor="#f0f9ff" />
                     </linearGradient>
                     <linearGradient id="groundGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#4ade80" />
                        <stop offset="100%" stopColor="#16a34a" />
                     </linearGradient>
                     <linearGradient id="targetGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#fbbf24" />
                        <stop offset="100%" stopColor="#f59e0b" />
                     </linearGradient>
                  </defs>

                  <rect width="800" height="450" fill="url(#skyGradient)" />

                  {/* Ground */}
                  <rect x="0" y="450" width="800" height="50" fill="url(#groundGradient)" />

                  {/* Distance markers */}
                  {[0, 100, 200, 300, 400, 500, 600].map(d => (
                     <g key={d}>
                        <line x1={50 + d * scale / 10} y1="445" x2={50 + d * scale / 10} y2="455" stroke="#166534" strokeWidth="2" />
                        <text x={50 + d * scale / 10} y="475" textAnchor="middle" fill="#166534" fontSize="10" fontWeight="bold">{d / 10}m</text>
                     </g>
                  ))}

                  {/* Target */}
                  <g>
                     <rect x={targetX} y="380" width={targetWidth} height="70" fill="url(#targetGradient)" rx="4" />
                     <rect x={targetX + 5} y="390" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <rect x={targetX + 5} y="400" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <rect x={targetX + 5} y="410" width={targetWidth - 10} height="3" fill="#fff" opacity="0.5" />
                     <text x={targetX + targetWidth / 2} y="365" textAnchor="middle" fill="#b45309" fontSize="12" fontWeight="bold">üéØ TARGET</text>
                  </g>

                  {/* Trajectory prediction line */}
                  {!isAnimating && (
                     <polyline
                        points={trajectoryPoints.join(" ")}
                        fill="none"
                        stroke="#6366f1"
                        strokeWidth="2"
                        strokeDasharray="8 4"
                        opacity="0.4"
                     />
                  )}

                  {/* Animated trajectory (during flight) */}
                  {isAnimating && (
                     <polyline
                        points={trajectoryPoints.slice(0, Math.floor(animationProgress * trajectoryPoints.length)).join(" ")}
                        fill="none"
                        stroke="#6366f1"
                        strokeWidth="3"
                     />
                  )}

                  {/* Cannon base */}
                  <circle cx="50" cy="450" r="25" fill="#1e293b" />
                  <circle cx="50" cy="450" r="18" fill="#334155" />

                  {/* Cannon barrel */}
                  <g transform={`translate(50, 450) rotate(${-angle})`}>
                     <rect x="0" y="-12" width="70" height="24" fill="#475569" rx="6" />
                     <rect x="60" y="-8" width="15" height="16" fill="#334155" rx="3" />
                  </g>

                  {/* Angle arc indicator */}
                  <path
                     d={`M 85 450 A 35 35 0 0 0 ${50 + 35 * Math.cos(radian)} ${450 - 35 * Math.sin(radian)}`}
                     fill="none" stroke="#6366f1" strokeWidth="2"
                  />
                  <text x="90" y={430} fill="#6366f1" fontSize="14" fontWeight="bold">{angle}¬∞</text>

                  {/* Projectile (animated or at start) */}
                  {isAnimating ? (
                     <g>
                        <circle cx={animX} cy={animY} r="10" fill="#ef4444">
                           <animate attributeName="r" values="10;12;10" dur="0.2s" repeatCount="indefinite" />
                        </circle>
                        <circle cx={animX} cy={animY} r="6" fill="#fbbf24" />
                     </g>
                  ) : (
                     <g transform={`translate(${50 + 80 * Math.cos(radian)}, ${450 - 80 * Math.sin(radian)})`}>
                        <circle r="10" fill="#ef4444" />
                        <circle r="6" fill="#fbbf24" />
                     </g>
                  )}

                  {/* Result indicator */}
                  {showResult && (
                     <g>
                        <rect x="300" y="180" width="200" height="60" fill={showResult === 'hit' ? '#22c55e' : '#ef4444'} rx="12" />
                        <text x="400" y="218" textAnchor="middle" fill="white" fontSize="24" fontWeight="bold">
                           {showResult === 'hit' ? 'üéØ HIT!' : '‚ùå MISS'}
                        </text>
                     </g>
                  )}
               </svg>
            </div>

            {/* Control Panel */}
            <div className="bg-white border-t border-slate-200 p-4 shadow-lg">
               <div className="max-w-4xl mx-auto">
                  <div className="grid grid-cols-12 gap-4 items-end">
                     {/* Angle Control */}
                     <div className="col-span-3">
                        <label className="text-xs font-black uppercase text-slate-400 block mb-2">
                           <i className="fa-solid fa-angle mr-1"></i> Launch Angle
                        </label>
                        <div className="flex items-center gap-2">
                           <input
                              type="range" min="5" max="85" value={angle}
                              onChange={(e) => !isAnimating && setAngle(Number(e.target.value))}
                              className="flex-1 h-2 bg-indigo-100 rounded-full accent-indigo-500"
                              disabled={isAnimating}
                           />
                           <span className="w-12 text-lg font-mono font-bold text-indigo-600">{angle}¬∞</span>
                        </div>
                     </div>

                     {/* Velocity Control */}
                     <div className="col-span-3">
                        <label className="text-xs font-black uppercase text-slate-400 block mb-2">
                           <i className="fa-solid fa-gauge-high mr-1"></i> Initial Velocity
                        </label>
                        <div className="flex items-center gap-2">
                           <input
                              type="range" min="10" max="50" value={velocity}
                              onChange={(e) => !isAnimating && setVelocity(Number(e.target.value))}
                              className="flex-1 h-2 bg-amber-100 rounded-full accent-amber-500"
                              disabled={isAnimating}
                           />
                           <span className="w-16 text-lg font-mono font-bold text-amber-600">{velocity} m/s</span>
                        </div>
                     </div>

                     {/* Physics Metrics */}
                     <div className="col-span-4 grid grid-cols-3 gap-2">
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Range</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{range.toFixed(1)}m</div>
                        </div>
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Max Height</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{maxHeight.toFixed(1)}m</div>
                        </div>
                        <div className="bg-slate-50 p-2 rounded-lg text-center">
                           <div className="text-[9px] font-black uppercase text-slate-400">Flight Time</div>
                           <div className="text-sm font-mono font-bold text-slate-700">{flightTime.toFixed(2)}s</div>
                        </div>
                     </div>

                     {/* Launch Button */}
                     <div className="col-span-2">
                        <button
                           onClick={handleLaunch}
                           disabled={isAnimating}
                           className={`w-full py-3 rounded-xl font-black uppercase tracking-wider shadow-lg transition-all ${isAnimating
                              ? 'bg-slate-300 cursor-not-allowed'
                              : 'bg-gradient-to-r from-orange-500 to-red-500 text-white hover:from-orange-600 hover:to-red-600 active:scale-95'
                              }`}
                        >
                           {isAnimating ? 'üöÄ Flying...' : 'üéØ LAUNCH!'}
                        </button>
                     </div>
                  </div>

                  {/* Shot History */}
                  {shots.length > 0 && (
                     <div className="mt-3 pt-3 border-t border-slate-100 flex items-center gap-2 flex-wrap">
                        <span className="text-xs font-bold text-slate-400 uppercase">Shots:</span>
                        {shots.slice(-5).map((shot, i) => (
                           <span key={i} className={`px-2 py-1 rounded text-xs font-bold ${shot.hit ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                              {shot.range}m {shot.hit ? '‚úì' : '‚úó'}
                           </span>
                        ))}
                        <span className="ml-auto text-xs font-bold text-slate-400">
                           {shots.filter(s => s.hit).length}/{shots.length} hits
                        </span>
                     </div>
                  )}
               </div>
            </div>
         </div>
      );
   };

   // --- GENERIC RENDERER ---
   const GenericRenderer = () => {
      if (type === 'poster' || type === 'infographic') {
         return (
            <div className="w-full h-full flex flex-col items-center justify-center p-8 bg-slate-900/5">
               <div className="relative rounded-2xl overflow-hidden shadow-2xl border-[12px] border-white bg-slate-900 max-w-4xl max-h-full group">
                  <img src={parsedData?.data || parsedData} className="max-w-full max-h-[70vh] object-contain transition-transform duration-700 group-hover:scale-105" alt="Artifact" />
               </div>
            </div>
         );
      }

      // Debug fallback for unrecognized types
      console.warn("GeneratedDiagram: Unrecognized type", type, "with data:", data);
      return (
         <div className="p-8 text-center">
            <p className="text-slate-400 font-serif italic mb-4">Rendering visual artifact...</p>
            <p className="text-xs text-slate-300">Type: <code className="bg-slate-100 px-1 rounded">{type}</code></p>
            {parsedData === null && <p className="text-xs text-red-400 mt-2">Error: Failed to parse diagram data.</p>}
         </div>
      );
   };



   const renderVisual = () => {
      switch (type) {
         case 'dynamic_blueprint': return <DynamicBlueprintRenderer />;
         case 'rocket': return <RocketEngineRenderer />;
         case 'projectile': return <ProjectileRenderer />;
         case 'compound_interest': return <CompoundInterestRenderer />;
         case 'supply_demand': return <SupplyDemandRenderer />;
         case 'pendulum': return <PendulumRenderer />;
         case 'waves': return <WaveInterferenceRenderer />;
         case 'circuits': return <CircuitRenderer />;
         case 'sorting':
            return <SortingRenderer />;
         case 'addition':
            return <AdditionRenderer />;
         case 'subtraction':
            return <SubtractionRenderer />;
         case 'multiplication':
            return <MultiplicationRenderer />;
         case 'division':
            return <DivisionRenderer />;
         case 'fractions':
            return <FractionRenderer />;
         case 'area':
            return <AreaRenderer />;
         case 'triangle':
            return <TriangleRenderer />;
         case 'force_lab':
            return <ForceLabRenderer />;
         case 'energy_coaster':
            return <EnergyCoasterRenderer />;
         case 'atomic_builder':
            return <AtomicBuilderRenderer />;
         case 'equation_balancer':
            return <EquationBalancerRenderer />;
         case 'gas_law':
            return <GasLawRenderer />;
         case 'advanced_force_lab':
            return <AdvancedForceLabRenderer />;
         case 'newton_third_law':
            return <NewtonThirdLawRenderer />;
         case 'net_force':
            return <NetForceRenderer />;
         case 'gravity_acceleration':
            return <GravityAccelerationRenderer />;
         case 'force_classification':
            return <ForceClassificationRenderer />;
         case 'stress_response':
            return <StressResponseRenderer />;
         case 'posture_analyzer':
            return <PostureAnalyzerRenderer />;
         case 'heart_rate_zones':
            return <HeartRateZoneRenderer />;
         case 'plate_method':
            return <PlateMethodRenderer />;
         case 'breathing_guide':
            return <BreathingGuideRenderer />;
         case 'gravitational_pe':
            return <GravitationalPERenderer />;
         case 'chemical_pe':
            return <ChemicalPERenderer />;
         case 'energy_conservation':
            return <EnergyConservationRenderer />;
         case 'machine_efficiency':
            return <MachineEfficiencyRenderer />;
         case 'convection':
            return <ConvectionRenderer />;
         case 'specific_heat':
            return <SpecificHeatRenderer />;
         case 'latent_heat':
            return <LatentHeatRenderer />;
         case 'entropy':
            return <EntropyRenderer />;
         case 'heat_engine':
            return <HeatEngineRenderer />;
         case 'light_transmission':
            return <LightTransmissionRenderer />;
         case 'light_absorption':
            return <LightAbsorptionRenderer />;
         case 'digital_signal':
            return <DigitalSignalRenderer />;
         case 'wave_equation':
            return <WaveEquationRenderer />;
         case 'superposition':
            return <SuperpositionRenderer />;
         case 'wave_interference':
            return <WaveInterference2DRenderer />;
         case 'standing_wave':
            return <StandingWaveRenderer />;
         case 'resonance':
            return <ResonanceRenderer />;
         case 'doppler_effect':
            return <DopplerEffectRenderer />;
         case 'snells_law':
            return <SnellsLawRenderer />;
         case 'tir':
            return <TIRRenderer />;
         case 'lens':
            return <LensRenderer />;
         case 'mirror':
            return <MirrorRenderer />;
         case 'ray_tracing':
            return <RayTracingLabRenderer />;
         case 'polarization':
            return <PolarizationRenderer />;
         case 'diffraction':
            return <DiffractionRenderer />;
         case 'dispersion':
            return <DispersionRenderer />;
         case 'thin_film':
            return <ThinFilmRenderer />;
         case 'wave_particle_duality':
            return <WaveParticleDualityRenderer />;
         case 'photoelectric_effect':
            return <PhotoelectricEffectRenderer />;
         case 'laser':
            return <LaserRenderer />;
         case 'acoustic_levitation':
            return <AcousticLevitationRenderer />;
         case 'fiber_optics':
            return <FiberOpticsRenderer />;
         case 'static_balloon':
            return <StaticBalloonRenderer />;
         case 'circuit_builder_basic':
            return <CircuitBuilderBasicRenderer />;
         case 'magnet_maze':
            return <MagnetMazeRenderer />;
         case 'electromagnet_basic':
            return <ElectromagnetBasicRenderer />;
         case 'conductivity_tester':
            return <ConductivityTesterRenderer />;
         case 'simple_switch':
            return <SimpleSwitchRenderer />;
         case 'magnetic_pole':
            return <MagneticPoleRenderer />;
         case 'attract_repel':
            return <AttractRepelRenderer />;
         case 'compass':
            return <CompassRenderer />;
         case 'magnetic_material':
            return <MagneticMaterialRenderer />;
         case 'series_circuit':
            return <SeriesCircuitRenderer />;
         case 'parallel_circuit':
            return <ParallelCircuitRenderer />;
         case 'voltage_potential':
            return <VoltagePotentialRenderer />;
         case 'current_flow':
            return <CurrentFlowRenderer />;
         case 'ohms_law':
            return <OhmsLawRenderer />;
         case 'electromagnet':
            return <ElectromagnetRenderer />;
         case 'basic_motor':
            return <BasicMotorRenderer />;
         case 'basic_generator':
            return <BasicGeneratorRenderer />;
         case 'earth_field':
            return <EarthFieldRenderer />;
         case 'household_safety':
            return <HouseholdSafetyRenderer />;
         case 'coulombs_law':
            return <CoulombsLawRenderer />;
         case 'electric_field':
            return <ElectricFieldRenderer />;
         case 'capacitor_lab':
            return <CapacitorLabRenderer />;
         case 'rlc_circuit':
            return <RLCCircuitRenderer />;
         case 'faradays_law':
            return <FaradaysLawRenderer />;
         case 'magnetic_flux':
            return <MagneticFluxRenderer />;
         case 'lenzs_law':
            return <LenzsLawRenderer />;
         case 'battery_connections':
            return <BatteryConnectionsRenderer />;
         case 'bulb_power':
            return <BulbPowerRenderer />;
         case 'multi_step_equations':
            return <MultiStepEquationsRenderer />;
         case 'variables_both_sides':
            return <VariablesBothSidesRenderer />;
         case 'linear_inequalities':
            return <LinearInequalitiesRenderer />;
         case 'inequalities_number_line':
            return <InequalitiesNumberLineRenderer />;
         case 'independent_dependent_variables':
            return <IndependentDependentVariablesRenderer />;
         case 'counting_100':
            return <Counting100Renderer />;
         case 'one_to_one_correspondence':
            return <OneToOneCorrespondenceRenderer />;
         case 'subitizing':
            return <SubitizingRenderer />;
         case 'place_value_tens_ones':
            return <PlaceValueTensOnesRenderer />;
         case 'addition_putting_together':
            return <AdditionPuttingTogetherRenderer />;
         case 'subtraction_taking_apart':
            return <SubtractionTakingApartRenderer />;
         case 'fact_families':
            return <FactFamiliesRenderer />;
         case 'positive_negative_intro':
            return <PositiveNegativeIntroRenderer />;
         case 'skip_counting':
            return <SkipCountingRenderer />;
         case 'fraction_intro':
            return <FractionIntroRenderer />;
         case 'multiplication_repeated_addition':
            return <MultiplicationRepeatedAdditionRenderer />;
         case 'division_fair_sharing':
            return <DivisionFairSharingRenderer />;
         case 'multi_digit_addition_regrouping':
            return <MultiDigitAdditionRegroupingRenderer />;
         case 'multi_digit_subtraction_borrowing':
            return <MultiDigitSubtractionBorrowingRenderer />;
         case 'multiplication_tables':
            return <MultiplicationTablesRenderer />;
         case 'z_score':
            return <ZScoreRenderer />;
         case 'correlation_coefficient':
            return <CorrelationCoefficientRenderer />;
         case 'combinations_permutations':
            return <CombinationsPermutationsRenderer />;
         case 'conditional_probability':
            return <ConditionalProbabilityRenderer />;
         case 'margin_of_error':
            return <MarginOfErrorRenderer />;
         default:
            return <GenericRenderer />;
      }
   };

   return (
      <div className="h-full flex flex-col bg-[#F8FAFC]">
         <div className="flex-1 overflow-auto custom-scrollbar relative">
            {renderVisual()}
         </div>
         <div className="px-6 py-3 bg-white border-t border-slate-200 text-[10px] text-slate-500 font-medium flex gap-2 items-center justify-center shrink-0">
            <i className="fa-solid fa-brain text-indigo-500"></i>
            <span className="font-serif italic opacity-80">{parsedData?.insight || "Interactive model generated by Atlas Core."}</span>
         </div>
      </div>
   );
};

export default GeneratedDiagram;
